!function(t){t.ketchup={defaults:{attribute:"data-validate",validateIndicator:"validate",eventIndicator:"on",validateEvents:"blur",validateElements:["input","textarea","select"],createErrorContainer:null,showErrorContainer:null,hideErrorContainer:null,addErrorMessages:null},dataNames:{validationString:"ketchup-validation-string",validations:"ketchup-validations",events:"ketchup-events",elements:"ketchup-validation-elements",container:"ketchup-container"},validations:{},helpers:{},validation:function(){var t,i,a=arguments[1];return"function"==typeof a?i=a:(t=a,i=arguments[2]),this.validations[arguments[0]]={message:t,func:i,init:arguments[3]||function(t,i){}},this},message:function(t,i){return this.addMessage(t,i),this},messages:function(t){for(name in t)this.addMessage(name,t[name]);return this},addMessage:function(t,i){this.validations[t]&&(this.validations[t].message=i)},helper:function(t,i){return this.helpers[t]=i,this},init:function(i,a,e){this.options=a;var n=this,r=this.initFunctions().initFields(i,e);r.each(function(){var a=t(this);n.bindValidationEvent(i,a).callInitFunctions(i,a)}),i.data(this.dataNames.elements,r),this.bindFormSubmit(i)},initFunctions:function(){var t=this.options,i=["createErrorContainer","showErrorContainer","hideErrorContainer","addErrorMessages"];for(f=0;f<i.length;f++){var a=i[f];t[a]||(t[a]=this[a])}return this},initFields:function(i,a){var e=this,n=this.dataNames,r=t(a?this.fieldsFromObject(i,a):this.fieldsFromForm(i));return r.each(function(){var i=t(this),a=e.extractValidations(i.data(n.validationString),e.options.validateIndicator);i.data(n.validations,a)}),r},callInitFunctions:function(t,a){var e=a.data(this.dataNames.validations);for(i=0;i<e.length;i++)e[i].init.apply(this.helpers,[t,a])},fieldsFromForm:function(a){var e=this,n=this.options,r=this.dataNames,s=n.validateElements,o=[];for(s="string"==typeof s?[s]:s,i=0;i<s.length;i++){var l=a.find(s[i]+"["+n.attribute+"*="+n.validateIndicator+"]");l.each(function(){var i=t(this),a=i.attr(n.attribute),s=e.extractEvents(a,n.eventIndicator);i.data(r.validationString,a).data(r.events,s||n.validateEvents)}),o.push(l.get())}return this.normalizeArray(o)},fieldsFromObject:function(t,i){var a=this.options,e=this.dataNames,n=[];for(s in i){var r,o;"string"==typeof i[s]?(r=i[s],o=a.validateEvents):(r=i[s][0],o=i[s][1]);var l=t.find(s);r=this.mergeValidationString(l,r),o=this.mergeEventsString(l,o),l.data(e.validationString,a.validateIndicator+"("+r+")").data(e.events,o),n.push(l.get())}return this.normalizeArray(n)},mergeEventsString:function(a,e){var n=a.data(this.dataNames.events),r="";if(n){var s=n.split(" ");for(i=0;i<s.length;i++)-1==e.indexOf(s[i])&&(r+=" "+s[i])}return t.trim(e+r)},mergeValidationString:function(t,a){var e=this.options,r=t.data(this.dataNames.validationString),s=function(t){var i=t.name;return t.arguments.length&&(i=i+"("+t.arguments.join(",")+")"),i},l=function(t,a){for(i=0;i<t.length;i++)if(t[i].name==a.name)return!0};if(r){var d=this.extractValidations(e.validateIndicator+"("+a+")",e.validateIndicator),h=this.extractValidations(r,e.validateIndicator);for(a="",o=0;o<h.length;o++)a+=s(h[o])+",";for(n=0;n<d.length;n++)l(h,d[n])||(a+=s(d[n])+",")}return a},bindFormSubmit:function(t){var i=this;this.options;t.submit(function(){return i.allFieldsValid(t,!0)})},allFieldsValid:function(i,a){var e=this,n=!0;return i.data(this.dataNames.elements).each(function(){var r=t(this);1!=e.validateElement(r,i)&&(1==a&&e.triggerValidationEvents(r),n=!1)}),i.trigger("formIs"+(n?"Valid":"Invalid"),[i]),n},bindValidationEvent:function(t,a){var e=this,n=this.options,r=this.dataNames,s=a.data(r.events).split(" ");for(i=0;i<s.length;i++)a.bind("ketchup."+s[i],function(){var i=e.validateElement(a,t),s=a.data(r.container);1!=i?(s||(s=n.createErrorContainer(t,a),a.data(r.container,s)),n.addErrorMessages(t,a,s,i),n.showErrorContainer(t,a,s)):s&&n.hideErrorContainer(t,a,s)}),this.bindValidationEventBridge(a,s[i]);return this},bindValidationEventBridge:function(t,i){t.bind(i,function(){t.trigger("ketchup."+i)})},validateElement:function(t,a){var e=[],n=t.data(this.dataNames.validations),r=[a,t,t.val()];for(i=0;i<n.length;i++)n[i].func.apply(this.helpers,r.concat(n[i].arguments))||e.push(n[i].message);return a.trigger("fieldIs"+(e.length?"Invalid":"Valid"),[a,t]),!e.length||e},elementIsValid:function(t){var i=this.dataNames;if(t.data(i.validations)){var a=t.parentsUntil("form").last().parent();return 1==this.validateElement(t,a)}return t.data(i.elements)?this.allFieldsValid(t):null},triggerValidationEvents:function(t){for(var i=t.data(this.dataNames.events).split(" "),a=0;a<i.length;a++)t.trigger("ketchup."+i[a])},extractValidations:function(i,e){for(var n=i.substr(i.indexOf(e)+e.length+1),r="",s=[],o=0,l=[],d=0;d<n.length;d++)switch(n.charAt(d)){case"(":r+="(",o++;break;case")":o?(r+=")",o--):s.push(t.trim(r));break;case",":o?r+=",":(s.push(t.trim(r)),r="");break;default:r+=n.charAt(d)}for(v=0;v<s.length;v++){var h=s[v].indexOf("("),u=s[v],c=[];-1!=h&&(u=t.trim(s[v].substr(0,h)),c=t.map(s[v].substr(u.length).split(","),function(i){return t.trim(i.replace("(","").replace(")",""))}));var f=this.validations[u];if(f&&f.message){var g=f.message;for(a=1;a<=c.length;a++)g=g.replace("{arg"+a+"}",c[a-1]);l.push({name:u,arguments:c,func:f.func,message:g,init:f.init})}}return l},extractEvents:function(t,i){var a=!1,e=t.indexOf(i+"(");return-1!=e&&(a=t.substr(e+i.length+1).split(")")[0]),a},normalizeArray:function(t){var a=[];for(i=0;i<t.length;i++)for(e=0;e<t[i].length;e++)t[i][e]&&a.push(t[i][e]);return a},createErrorContainer:function(i,a){if("function"==typeof i)return this.defaults.createErrorContainer=i,this;var e=a.offset();return t("<div/>",{html:"<ul></ul><span></span>",class:"ketchup-error",css:{top:e.top,left:e.left+a.outerWidth()-20}}).appendTo("body")},showErrorContainer:function(t,i,a){if("function"==typeof t)return this.defaults.showErrorContainer=t,this;a.show().animate({top:i.offset().top-a.height(),opacity:1},"fast")},hideErrorContainer:function(t,i,a){if("function"==typeof t)return this.defaults.hideErrorContainer=t,this;a.animate({top:i.offset().top,opacity:0},"fast",function(){a.hide()})},addErrorMessages:function(a,e,n,r){if("function"==typeof a)return this.defaults.addErrorMessages=a,this;var s=n.children("ul");for(s.html(""),i=0;i<r.length;i++)t("<li/>",{text:r[i]}).appendTo(s)}},t.fn.ketchup=function(i,a){var e=t(this);if("string"==typeof i)switch(i){case"validate":t.ketchup.triggerValidationEvents(e);break;case"isValid":return t.ketchup.elementIsValid(e)}else this.each(function(){t.ketchup.init(e,t.extend({},t.ketchup.defaults,i),a)});return this}}(jQuery);