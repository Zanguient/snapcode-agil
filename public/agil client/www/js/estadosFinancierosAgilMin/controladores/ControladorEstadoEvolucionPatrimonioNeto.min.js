angular.module("agil.controladores").controller("controladoEvolucionPatrimonioNeto",function(d,e,a,p,t,o,i,r,n,s,l,u,c,m){d.usuario=JSON.parse(a.usuario),d.imagenEmpresa,d.$on("$viewContentLoaded",function(){}),d.$on("$routeChangeStart",function(e,a){}),convertUrlToBase64Image(d.usuario.empresa.imagen,function(e){0<e.length&&"error"!==e?d.imagenEmpresa=e:convertUrlToBase64Image("img/agilsoftware.png",function(e){0<e.length&&"error"!==e?(d.mostrarMensaje("No se encuentra la imagen de la empresa."),d.imagenEmpresa=e):d.mostrarMensaje("No se encuentra imagenen de la empresa.")})}),d.usuario=JSON.parse(a.usuario),d.inicio=function(){d.obtenerTiposPeriodos(),d.obtenerGestiones(),d.obtenerTiposCuenta(),d.obtenerConfiguracionImpresion(),d.obtenerGestionesImpresion()},d.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),d.buscarAplicacion(d.usuario.aplicacionesUsuario,t.path().substring(1)),o.stop()}),d.obtenerTiposPeriodos=function(){o.start(),s("EEFF_TP").then(function(e){d.TiposPeriodos=e,o.stop()})},d.obtenerGestiones=function(){o.start(),s("GTN").then(function(e){d.gestiones=e.clases,o.stop()})},d.obtenerConfiguracionImpresion=function(){l(d.usuario.id_empresa).then(function(e){d.configuracionImpresion=e,d.configuracionImpresion.bimonetario=!1,d.configuracionImpresion.tioPeriodo="",d.configuracionImpresion.gestion="",d.configuracionImpresion.gestion_fin="",d.configuracionImpresion.mes="",d.configuracionImpresion.fecha_inicio=null,d.configuracionImpresion.fecha_fin=null,o.stop()})},d.cargarFechasFiltro=function(e){"FECHAS"==e&&setTimeout(function(){aplicarDatePickers()},300)},d.obtenerTiposCuenta=function(){o.start(),s("TCC").then(function(e){d.cuentaTipos=[{id:0,nombre:"PREESTABLECIDO"}],d.cuentaTipos=d.cuentaTipos.concat(e.clases),o.stop()})},d.obtenerGestionesImpresion=function(){o.start(),d.gestionesEF=[],c(d.usuario.id_empresa).then(function(e){o.stop(),e.forEach(function(e){e.habilitado&&(d.fechasImpresion=e)})})},d.extraerFechaExcel=function(e){var a=e.split(" ")[e.split(" ").length-1],t=e.split(" ")[0].split("/").reverse();0<a.indexOf("AM")?a=a.split("A")[0].split(":"):0<a.indexOf("PM")&&((a=a.split("P")[0].split(":"))[0]=parseInt(a[0])+12+"");var o=t[0]+"-"+(2==t[2].length?t[2]:"0"+t[2])+"-"+(2==t[1].length?t[1]:"0"+t[1])+"T"+(2==a[0].length?a[0]:"0"+a[0])+":"+(2==a[1].length?a[1]:"0"+a[1])+":"+(2==a[2].length?a[2]:"0"+a[2])+".000Z";new Date(t[0],t[2]-1,t[1],2==a[0].length?a[0]:"0"+a[0],2==a[1].length?a[1]:"0"+a[1],2==a[2].length?a[2]:"0"+a[2]);return o},d.generarReportePDF=function(){if(d.configuracionImpresion.gestion){var e=d.cuentaTipos.find(function(e){return e.nombre.toLowerCase()==="Apropiacion".toLowerCase()});d.reportePDFEstadoEvolucionPatrimonioNeto(e)}else d.mostrarMensaje("Seleccione una gestion.")},d.reportePDFEstadoEvolucionPatrimonioNeto=function(e){m(d.usuario.id_empresa,e).then(function(e){for(var a=[],t=p("filter")(e.cuentas,"Capital"),o=p("filter")(e.cuentas,"Ajuste de Capital"),i=p("filter")(e.cuentas,"Reserva Legal"),r=p("filter")(e.cuentas,"Ajuste Reserva Legal"),n=p("filter")(e.cuentas,"Ajuste Reservas Patrimoniales"),s=p("filter")(e.cuentas,"Resultados Acumulados"),l=p("filter")(e.cuentas,"Resultado de la Gestión"),u=0;u<t.length;u++){0===u?(c={nombre:"Saldos al 1ro de enero "+d.configuracionImpresion.gestion.nombre,capital:t[u].saldo,AjusteCapital:"-",reservaLegal:"-",ajusteReservasPatrimoniales:"-",resultadoAcumulados:"-"},a.push(c)):0<(c={nombre:t[u].nombre,capital:t[u].saldo,AjusteCapital:"-",reservaLegal:"-",ajusteReservasPatrimoniales:"-",resultadoAcumulados:"-"}).capital&&"Ajuste de Capital"!==c.nombre&&a.push(c)}for(u=0;u<o.length;u++){0===u?a[0].AjusteCapital=o[u].saldo:(c={nombre:o[u].nombre,capital:"-",AjusteCapital:o[u].saldo,reservaLegal:"-",ajusteReservasPatrimoniales:"-",resultadoAcumulados:"-"},a.push(c))}for(u=0;u<i.length;u++){0===u?a[0].reservaLegal=i[u].saldo:(c={nombre:i[u].nombre,capital:"-",AjusteCapital:"-",reservaLegal:i[u].saldo,ajusteReservasPatrimoniales:"-",resultadoAcumulados:"-"},a.push(c))}for(u=0;u<n.length;u++){0===u?a[0].ajusteReservasPatrimoniales=n[u].saldo:(c={nombre:n[u].nombre,capital:"-",AjusteCapital:"-",reservaLegal:"-",ajusteReservasPatrimoniales:n[u].saldo,resultadoAcumulados:"-"},a.push(c))}for(u=0;u<s.length;u++){0===u?a[0].resultadoAcumulados=s[u].saldo:(c={nombre:s[u].nombre,capital:"-",AjusteCapital:"-",reservaLegal:"-",ajusteReservasPatrimoniales:"-",resultadoAcumulados:s[u].saldo},a.push(c))}for(u=0;u<r.length;u++){c={nombre:r[u].nombre,capital:"-",AjusteCapital:"-",reservaLegal:r[u].saldo,ajusteReservasPatrimoniales:"-",resultadoAcumulados:"-"},a.push(c)}for(u=0;u<l.length;u++){var c;c={nombre:l[u].nombre,capital:"-",AjusteCapital:"-",reservaLegal:"-",ajusteReservasPatrimoniales:"-",resultadoAcumulados:l[u].saldo},a.push(c)}var m=[d.usuario.empresa,d.configuracionImpresion];d.imprimirReporteComensal(a,m)})},d.formatoFechaPDF=function(e){var a=new Date(e);return a.setDate(a.getDate()),("0"+a.getDate()).slice(-2)+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+a.getFullYear()},d.imprimirReporteComensal=function(e,a){var t=new PDFDocument({size:[792,612],margin:10,compress:!1}),o=t.pipe(blobStream()),i=280,r=Math.ceil(e.length/10);d.cabeceraReporteComensal(t,1,r,a);for(var n=0,s=0,l=0,u=0,c=0,m=0,p=0;p<e.length;p++)n+="-"!==e[p].capital?e[p].capital:0,s+="-"!==e[p].AjusteCapital?e[p].AjusteCapital:0,l+="-"!==e[p].reservaLegal?e[p].reservaLegal:0,u+="-"!==e[p].ajusteReservasPatrimoniales?e[p].ajusteReservasPatrimoniales:0,c+="-"!==e[p].resultadoAcumulados?e[p].resultadoAcumulados:0,totalrow=("-"!==e[p].capital?e[p].capital:0)+("-"!==e[p].AjusteCapital?e[p].AjusteCapital:0)+("-"!==e[p].reservaLegal?e[p].reservaLegal:0)+("-"!==e[p].ajusteReservasPatrimoniales?e[p].ajusteReservasPatrimoniales:0)+("-"!==e[p].resultadoAcumulados?e[p].resultadoAcumulados:0),m+=totalrow,t.text(e[p].nombre,60,i,{width:200}),t.text("-"!==e[p].capital?d.number_format(e[p].capital,2):"",250,i,{width:120}),t.text("-"!==e[p].AjusteCapital?d.number_format(e[p].AjusteCapital,2):"",330,i,{width:120}),t.text("-"!==e[p].reservaLegal?d.number_format(e[p].reservaLegal,2):"",410,i,{width:120}),t.text("-"!==e[p].ajusteReservasPatrimoniales?d.number_format(e[p].ajusteReservasPatrimoniales,2):"",490,i,{width:120}),t.text("-"!==e[p].resultadoAcumulados?d.number_format(e[p].resultadoAcumulados,2):"",570,i,{width:120}),t.text(d.number_format(totalrow,2),710,i,{width:120}),i+=20;t.text("Saldos al 31 de Diciembre de "+d.configuracionImpresion.gestion.nombre,60,i,{width:200}),t.text(d.number_format(n,2),250,i,{width:120}),t.text(d.number_format(s,2),330,i,{width:120}),t.text(d.number_format(l,2),410,i,{width:120}),t.text(d.number_format(u,2),490,i,{width:120}),t.text(d.number_format(c,2),570,i,{width:120}),t.text(d.number_format(m,2),710,i,{width:120}),i+=20,t.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},d.cabeceraReporteComensal=function(e,a,t,o){e.font("Helvetica-Bold",8).fill("black"),e.text(o[0].razon_social,60,75),e.text(o[0].de?o[0].de:"De: ",60,90),e.text(o[0].telefono1?o[0].telefono1:"0000000",60,105),e.text(o[0].direccion,60,120),e.text("Cochabamba - Bolivia",60,135),e.font("Helvetica-Bold",12).fill("black"),e.text("ESTADO DE EVOLUCIÓN DEL PATRIMONIO NETO",0,180,{align:"center"}),e.font("Helvetica-Bold",8).fill("black"),e.text("Por el ejercicio terminado el 31 de Diciembre de"+d.configuracionImpresion.gestion.nombre,0,200,{align:"center"}),d.configuracionImpresion.bimonetario?(e.text("Expresado en Bolivianos y Dólares",0,95,{align:"center"}),"COMPARATIVO"!=d.configuracionImpresion.tipoPeriodo.nombre?(e.text("Bolivianos",400,115),e.text("Dolares",520,115)):(e.text(d.configuracionImpresion.gestion.nombre,340,115),e.text("Bolivianos",290,125),e.text("Dolares",370,125),e.text(d.configuracionImpresion.gestion_fin.nombre,525,115),e.text("Bolivianos",473,125),e.text("Dolares",553,125))):e.text("(Expresado en Bolivianos)",0,220,{align:"center"}),e.text("Capital",250,260,{width:120}),e.text("Ajuste de Capital",330,260,{width:120}),e.text("Reserva Legal",410,260,{width:120}),e.text("Ajuste de Reservas Patrimoniales",490,260,{width:120}),e.text("Resultados Acumulados",570,260,{width:120}),e.text("Total",710,260,{width:120}),e.font("Helvetica",8),d.imagenEmpresa&&e.image(d.imagenEmpresa,40,30,{fit:[100,100]})},d.abrirdialogHistorialDocumentos=function(){d.activeModal=0,d.obtenerHistorialDocumentos(),d.abrirPopup(d.dialogHistorialDocumentos)},d.cerrardialogHistorialDocumentos=function(){d.activeModal=0,d.historialesDocumentos=[],d.cerrarPopup(d.dialogHistorialDocumentos)},d.inicio()});