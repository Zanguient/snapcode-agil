angular.module("agil.controladores").controller("ControladorGtmDestino",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Paginator","FieldViewer","GtmDestino","GtmDestinos","GtmDestinoItem","GtmDestinosEmpresa","ClasesTipoEmpresa","Diccionario","Tipos","ClasesTipo","VerificarUsuarioEmpresa",function(o,i,e,r,a,t,n,s,c,d,l,u,p,m,v,f,C){t.start(),o.usuario=JSON.parse(i.usuario),o.idModalWizardDestinoEdicion="modal-wizard-destino-edicion",o.idModalContenedorWizard="modal-wizard-container-destino-edicion",o.idModalConceptoEdicionCorrelativos="dialog-conceptos-correlativos",o.IdModalVerificarCuenta="modal-verificar-cuenta",o.$on("$viewContentLoaded",function(){resaltarPestaÃ±a(e.path().substring(1)),ejecutarScriptDestino(o.idModalWizardDestinoEdicion,o.idModalContenedorWizard,o.idModalConceptoEdicionCorrelativos,o.IdModalVerificarCuenta),o.buscarAplicacion(o.usuario.aplicacionesUsuario,e.path().substring(1))}),o.inicio=function(){o.diccionario=m,o.obtenerDestinos()},o.obtenerDestinos=function(){d(o.usuario.id_empresa).then(function(i){o.destinos=i})},o.crearNuevoDestino=function(){o.obtenerCorrelativoDestino(),o.steps=[{cabeza:"cabeza-datos-destino",cuerpo:"cuerpo-datos-destino"}],o.destino=new c({id_empresa:o.usuario.id_empresa}),o.abrirPopup(o.idModalWizardDestinoEdicion)},o.cerrarPopPupEdicion=function(){o.cerrarPopup(o.idModalWizardDestinoEdicion)},o.modificarDestino=function(i){o.destino=i,o.abrirPopup(o.idModalWizardDestinoEdicion)},o.removerDestino=function(i){i.eliminado=!0,l.update({id_destino:i.id},i,function(i){o.obtenerDestinos(),t.stop(),o.mostrarMensaje(i.mensaje)})},o.guardarDestino=function(i){"Siguiente"!=$("#siguiente").text().trim()&&(t.start(),i.id?l.update({id_destino:i.id},i,function(i){o.obtenerDestinos(),t.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje(i.mensaje),o.recargarItemsTabla()}):i.$save(function(i){o.obtenerDestinos(),t.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje("Destino creado satisfactoriamente!"),o.recargarItemsTabla()},function(i){t.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje("Ocurrio un problema al momento de guardar!")}))},o.$on("$routeChangeStart",function(i,e){o.eliminarPopup(o.idModalWizardDestinoEdicion),o.eliminarPopup(o.idModalConceptoEdicionCorrelativos),o.eliminarPopup(o.IdModalVerificarCuenta)}),o.subirExcelDestinos=function(i){var e,r,a=i.target.files;for(r=a[e=0];e!=a.length;++e){var n=new FileReader;r.name;n.onload=function(i){t.start();var e=i.target.result,r=XLSX.read(e,{type:"binary"}),a=r.SheetNames[0],n=2,s=r.Sheets[a],c=[];do{var d={};d.codigo=void 0!=s["A"+n]&&""!=s["A"+n]?s["A"+n].v.toString():null,d.cliente_codigo=void 0!=s["B"+n]&&""!=s["B"+n]?s["B"+n].v.toString():null,d.destino=void 0!=s["C"+n]&&""!=s["C"+n]?s["C"+n].v.toString():null,d.direccion=void 0!=s["D"+n]&&""!=s["D"+n]?s["D"+n].v.toString():null,c.push(d),n++,0}while(void 0!=s["A"+n]);o.guardarDestinos(c),t.stop()},n.readAsBinaryString(r)}},o.guardarDestinos=function(i){u(o.usuario.id_empresa,i).then(function(i){t.stop(),o.mostrarMensaje(i.mensaje),o.recargarItemsTabla()})},o.obtenerCorrelativoDestino=function(){t.start(),p("correlativo_destinos",o.usuario.id_empresa).then(function(i){i.clases.length>1?i.clases.sort(function(o,i){return o.correlativo=o.nombre_corto.split("-")[0],o.correlativo_maximo=o.nombre_corto.split("-")[1],i.correlativo=i.nombre_corto.split("-")[0],i.correlativo_maximo=i.nombre_corto.split("-")[1],o.correlativo-i.correlativo}):1==i.clases.length&&(i.clases[0].correlativo=i.clases[0].nombre_corto.split("-")[0],i.clases[0].correlativo_maximo=i.clases[0].nombre_corto.split("-")[1]),o.correlativosDestino=i,t.stop()})},o.cargarCodigo=function(o){o.codigo=o.correlativo.correlativo},o.abrirModalConceptoEdicionCorrelativos=function(i){t.start(),p("correlativo_destinos",o.usuario.id_empresa).then(function(i){i.clases.length>1?(i.clases.sort(function(o,i){return o.correlativo=o.nombre_corto.split("-")[0],o.correlativo_maximo=o.nombre_corto.split("-")[1],i.correlativo=i.nombre_corto.split("-")[0],i.correlativo_maximo=i.nombre_corto.split("-")[1],o.correlativo-i.correlativo}),o.minimo=parseInt(i.clases[i.clases.length-1].correlativo_maximo)+1):1==i.clases.length&&(i.clases[0].correlativo=i.clases[0].nombre_corto.split("-")[0],i.clases[0].correlativo_maximo=i.clases[0].nombre_corto.split("-")[1],o.minimo=parseInt(i.clases[0].correlativo_maximo)+1),o.tipo_edicion=i,o.clase={},o.abrirPopup(o.idModalConceptoEdicionCorrelativos),t.stop()})},o.cerrarModalConceptoEdicionCorrelativos=function(){o.cerrarPopup(o.idModalConceptoEdicionCorrelativos)},o.agregarConceptoEdicion=function(i){i.nombre_corto=i.correlativo+"-"+i.correlativo_maximo,-1==o.tipo_edicion.clases.indexOf(i)&&(o.tipo_edicion.clases.length,o.tipo_edicion.clases.push(i),o.minimo=i.correlativo_maximo+1),o.clase={}},o.modificarConceptoEdicion=function(i){i.correlativo=parseInt(i.correlativo),i.correlativo_maximo=parseInt(i.correlativo_maximo),o.clase=i},o.removerConceptoEdicion=function(o){o.eliminado=!0},o.guardarConceptoEdicion=function(i){t.start(),v.update({id_tipo:i.id},i,function(e){f(i.nombre_corto).then(function(e){i=e,t.stop(),o.cerrarModalConceptoEdicionCorrelativos(),o.mostrarMensaje("Guardado Exitosamente!")})})},o.abrirModalVerificarCuenta=function(i,e){o.dato=i,o.tipoDatosPermiso=e,o.abrirPopup(o.IdModalVerificarCuenta)},o.cerrarModalVerificarCuenta=function(){o.cerrarPopup(o.IdModalVerificarCuenta)},o.verificarCuentaAdmin=function(i){C.save({id_empresa:o.usuario.id_empresa},i,function(i){i.type?(o.mostrarMensaje(i.message),"correlativo"==o.tipoDatosPermiso&&o.modificarConceptoEdicion(o.dato),o.cerrarModalVerificarCuenta()):o.mostrarMensaje(i.message)})},o.inicio()}]);