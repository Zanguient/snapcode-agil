angular.module("agil.controladores").controller("ControladorGtmGeoLocalizacion",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Paginator","FieldViewer","ClasesTipo","ClasesTipoEmpresa","GtmDespachosUbicacion","uiGmapGoogleMapApi","$timeout","BuscarDespachosVendedor","FiltrarVendedorEmpresa",function(a,o,e,t,i,r,n,d,l,c,s,p,u,g,h){r.start(),a.usuario=JSON.parse(o.usuario),a.ModalVendedorMapa="dialog-vendedor-mapa",a.ModalFiltroMapa="dialog-mapa-despachos",a.$on("$viewContentLoaded",function(){resaltarPesta√±a(e.path().substring(1)),ejecutarScriptGeoLocalizacion(a.ModalVendedorMapa,a.ModalFiltroMapa),a.buscarAplicacion(a.usuario.aplicacionesUsuario,e.path().substring(1))}),a.inicio=function(){a.obtenerDespachados(),a.map={center:{latitude:-17.40380000777538,longitude:-66.1134901218414},zoom:10,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},a.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE}},a.abrirDialogVendedorMapa=function(){u(function(){a.$apply(function(){google.maps.event.trigger(a.map,"resize")})},2e3),a.abrirPopup(a.ModalVendedorMapa)},a.cerrarDialogVendedorMapa=function(){a.cerrarPopup(a.ModalVendedorMapa)},a.abrirDialogFiltroMapa=function(){a.abrirPopup(a.ModalFiltroMapa)},a.cerrarDialogFiltroMapa=function(){a.cerrarPopup(a.ModalFiltroMapa)},a.obtenerDespachados=function(){r.start(),a.paginator=n(),a.paginator.column="id",a.paginator.direccion="asc";var o={id_empresa:a.usuario.id_empresa,inicio:0,fin:0,cliente:0,vendedor:0};a.paginator.callBack=a.buscarDespachados,a.paginator.getSearch("",o,null),r.stop()},a.buscarDespachados=function(){r.start(),s(a.paginator).then(function(o){a.paginator.setPages(o.paginas),a.despachos=o.detallesDespacho,a.totalesDespachos={producto:0,servicio_transporte:0,total:0},a.despachos.forEach(function(a,o,e){r1=dec2gms(a.latitud,"LATITUD"),r2=dec2gms(a.latitud,"LONGITUD"),a.cordenada_latitud=r1.valor,a.cordenada_longitud=r2.valor}),r.stop()})},a.interceptarTecla=function(o,e,t){13===o.which&&(t?a.enfocar(e):u(function(){$("#"+e).trigger("click")},0))},a.buscarVendedor=function(o){if(""!=o&&void 0!=o)return h(a.usuario.id_empresa,o)},a.verUbicacionDespacho=function(o){a.markers=[];var e={id:1,coords:{latitude:o.latitud,longitude:o.longitud},window:{title:o.despacho.cliente.razon_social}};a.markers.push(e),a.map={center:{latitude:o.latitud,longitude:o.longitud},zoom:13,bounds:{northeast:{latitude:o.latitud,longitude:o.longitud}}},a.abrirDialogVendedorMapa()},a.GenerarMapaDespachosVendedor=function(o){a.markers=[],o.fechaBusqueda=new Date(a.convertirFecha(o.fecha)),g(o).then(function(o){var e={};o.detallesDespacho.forEach(function(t,i,r){e={id:i,coords:{latitude:t.latitud,longitude:t.longitud},window:{title:t.despacho.cliente.razon_social}},a.markers.push(e),i===r.length-1&&(a.map={center:{latitude:o.detallesDespacho[0].latitud,longitude:o.detallesDespacho[0].longitud},zoom:13,bounds:{northeast:{latitude:o.detallesDespacho[0].latitud,longitude:o.detallesDespacho[0].longitud}}},a.abrirDialogVendedorMapa(),a.cerrarDialogFiltroMapa())})})},a.$on("$routeChangeStart",function(o,e){a.eliminarPopup(a.ModalVendedorMapa),a.eliminarPopup(a.ModalFiltroMapa)}),a.inicio()}]);