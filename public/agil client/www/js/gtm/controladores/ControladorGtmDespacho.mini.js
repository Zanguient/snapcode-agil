angular.module("agil.controladores").controller("ControladorGtmDespacho",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Paginator","FieldViewer","GtmDespachos","GtmDetalleDespacho","GetGtmDetalleDespachoHijos","ImprimirPdfDespachos","ExportarExelDespachos","ListaDetalleKardexFactura","GtmDetalleDespachoKardex","VerificarUsuarioEmpresa","CrearDespachoResivo","ClasesTipo","ListaBancos","ClasesTipoEmpresa","ActualizarDatosDespachoDetalle",function(e,t,o,a,r,i,c,n,s,l,d,p,x,u,f,g,h,m,D,v,_){i.start(),e.usuario=JSON.parse(t.usuario),e.idModalAsignacionFactura="modal-asignacion-factura",e.idModalVentaKardexFactura="modal-venta-kardex-factura",e.idModalAsignacionFacturaKardex="modal-asignacion-factura-kardex",e.idModalDetalleKardex="modal-detalle-kardex",e.IdModalVerificarCuenta="modal-verificar-cuenta",e.IdModalCobros="modal-cobros",e.IdModalHistorialCobros="modal-historial-cobros",e.idModalConceptoEdicion="dialog-conceptos",e.idModalAsignacionDespacho="gtm-asignacion-despachos",e.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptDespacho(e.idModalAsignacionFactura,e.idModalVentaKardexFactura,e.idModalAsignacionFacturaKardex,e.idModalDetalleKardex,e.IdModalVerificarCuenta,e.IdModalCobros,e.IdModalHistorialCobros,e.idModalConceptoEdicion,e.idModalAsignacionDespacho),e.buscarAplicacion(e.usuario.aplicacionesUsuario,o.path().substring(1))}),e.inicio=function(){e.obtenerDespachados(),e.obtenerTiposPagoResivo(),e.obtenerCuentasBancos(),e.obtenerOtrosBancos(),e.verDatosCobroDespachos=!1},e.obtenerTiposPagoResivo=function(){i.start(),m("GTM_TP").then(function(t){e.tiposPagosResivo=t.clases,i.stop()})},e.obtenerDespachados=function(){i.start(),e.paginator=c(),e.paginator.column="id",e.paginator.direccion="asc",e.filtro={id_empresa:e.usuario.id_empresa,inicio:"",fin:"",transportista:"",tipo:"",grupo:"",estado:"",vendedor:"",admin:"ADMINISTRADOR"==e.usuario.rolesUsuario[0].rol.nombre?"":e.usuario.id},e.paginator.callBack=e.buscarDespachados,e.paginator.getSearch("",e.filtro,null),i.stop()},e.buscarDespachados=function(){if(0!=e.paginator.filter.inicio)e.filtro.inicio&&e.filtro.fin?(e.paginator.filter.inicio=new Date(e.convertirFecha(e.filtro.inicio)),e.paginator.filter.fin=new Date(e.convertirFecha(e.filtro.fin))):(e.paginator.filter.inicio=0,e.paginator.filter.fin=0);else{var t=new Date,o=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,0);e.paginator.filter.inicio=o,e.paginator.filter.fin=a,e.filtro.inicio=e.fechaATexto(o),e.filtro.fin=e.fechaATexto(a)}i.start(),s(e.paginator).then(function(t){e.paginator.setPages(t.paginas),e.despachos=t.detallesDespacho,e.totalesDespachos={producto:0,servicio_transporte:0,total:0},e.despachos.forEach(function(t,o,a){e.totalesDespachos.producto+=t.precio_unitario*t.cantidad_despacho,e.totalesDespachos.servicio_transporte+=t.servicio_transporte,o===a.length-1&&(e.totalesDespachos.total=e.totalesDespachos.producto+e.totalesDespachos.servicio_transporte)}),i.stop()})},e.imprimirPdfDespachos=function(){p(e.despachos,e.paginator.filter,e.usuario)},e.imprimirExelDespachos=function(){x(e.despachos,e.paginator.filter,e.usuario)},e.imprimir=function(t){i.start();var o=0;d(t).then(function(a){if(a.detallesDespacho.length>0)a.detallesDespacho.forEach(function(a,r,c){if(o+=a.cantidad_despacho,r==c.length-1){var n=new PDFDocument({compress:!1,size:[612,792],margin:10}),s=n.pipe(blobStream()),l=(new Date,80);n.font("Helvetica",8);var d=195,p=0;e.dibujarCabeceraPDFImpresion(n,t,0),n.font("Helvetica",8),n.text(1,55,d),n.text(t.producto.codigo,100,d),n.text(t.producto.nombre.toUpperCase(),180,d),n.text(t.cantidad,380,d),n.text(t.precio_unitario,450,d),n.text(t.importe,520,d),n.rect(40,d+10,540,0).stroke(),n.rect(40,d-10,0,40).stroke(),n.rect(580,d-10,0,60).stroke(),n.rect(80,d-35,0,65).stroke(),n.rect(160,d-35,0,85).stroke(),n.rect(425,d-35,0,65).stroke(),n.rect(370,d-35,0,125).stroke(),n.rect(425,d+50,0,40).stroke(),n.rect(495,d+50,0,20).stroke(),n.rect(580,d+50,0,20).stroke(),n.rect(495,d-35,0,85).stroke(),n.rect(160,d+50,420,0).stroke(),n.rect(370,d+70,55,0).stroke(),n.rect(495,d+70,85,0).stroke(),n.rect(370,d+90,55,0).stroke(),d+=20,n.text(t.producto.codigo,100,d),(u=t.producto.nombre.toUpperCase()+" (DESPACHADO)").length>37&&(p=-6),n.text(u,180,d+p,{width:180}),n.text(t.cantidad_despacho,380,d),n.text("SERVICIO DE TRANSPORTE",180,d+20),n.text(t.servicio_transporte,520,d+20),n.text(t.importe+t.servicio_transporte,520,d+40),n.rect(40,d+10,540,0).stroke(),n.font("Helvetica-Bold",8),n.text("Total",l+250,d+40),n.text("Saldo",l+250,d+60),n.rect(60,d+105,90,0,{align:"left"}).stroke(),n.text("DESPACHO",60,d+110,{align:"left"}),n.text(e.usuario.persona.nombre_completo,60,d+120,{align:"left"});var x=(new Date).getHours();f=(f=(new Date).getMinutes())<10?f="0"+f:f,x=x<10?x="0"+x:x,n.text("HORA DESP.: "+x+":"+f,60,d+130,{align:"left"}),n.rect(255,d+105,90,0,{align:"center"}).stroke(),n.text("FIRMA CONDUCTOR",-10,d+110,{align:"center"}),n.text("NOMBRE: ",-50,d+120,{align:"center"}),n.rect(440,d+105,90,0,{align:"right"}).stroke(),n.text("FIRMA CLIENTE",350,d+110,{align:"center"}),n.text("NOMBRE: ",330,d+120,{align:"center"}),n.text("HORA RECEP.: ",350,d+130,{align:"center"}),n.font("Helvetica",8),n.text(o+t.cantidad_despacho,l+300,d+40),n.text(t.cantidad-(o+t.cantidad_despacho),l+300,d+60);l=80;n.font("Helvetica",8);d=600;e.dibujarCabeceraPDFImpresion(n,t,405),n.font("Helvetica",8),n.text(1,55,d),n.text(t.producto.codigo,100,d),n.text(t.producto.nombre.toUpperCase(),180,d),n.text(t.cantidad,380,d),n.text(t.precio_unitario,450,d),n.text(t.importe,520,d),n.rect(40,d+10,540,0).stroke(),n.rect(40,d-10,0,40).stroke(),n.rect(580,d-10,0,60).stroke(),n.rect(80,d-35,0,65).stroke(),n.rect(160,d-35,0,85).stroke(),n.rect(425,d-35,0,65).stroke(),n.rect(370,d-35,0,65).stroke(),n.rect(425,d+50,0,40).stroke(),n.rect(370,d+50,0,40).stroke(),n.rect(495,d+50,0,20).stroke(),n.rect(580,d+50,0,20).stroke(),n.rect(495,d+70,85,0).stroke(),n.rect(495,d-35,0,85).stroke(),n.rect(160,d+50,420,0).stroke(),n.rect(370,d+70,55,0).stroke(),n.rect(370,d+90,55,0).stroke(),d+=20;var u;p=0;n.text(t.producto.codigo,100,d),(u=t.producto.nombre.toUpperCase()+" (DESPACHADO)").length>37&&(p=-6),n.text(u,180,d+p,{width:180}),n.text(t.cantidad_despacho,380,d),n.text("SERVICIO DE TRANSPORTE",180,d+20),n.text(t.servicio_transporte,520,d+20),n.text(t.importe+t.servicio_transporte,520,d+40),n.rect(40,d+10,540,0).stroke(),n.font("Helvetica-Bold",8),n.text("Total",l+250,d+40),n.text("Saldo",l+250,d+60),n.rect(60,d+105,90,0,{align:"left"}).stroke(),n.text("DESPACHO",60,d+110,{align:"left"}),n.text(e.usuario.persona.nombre_completo,60,d+120,{align:"left"});var f;x=(new Date).getHours();f=(f=(new Date).getMinutes())<10?f="0"+f:f,x=x<10?x="0"+x:x,n.text("HORA DESP.: "+x+":"+f,60,d+130,{align:"left"}),n.rect(255,d+105,90,0,{align:"center"}).stroke(),n.text("FIRMA CONDUCTOR",-10,d+110,{align:"center"}),n.text("NOMBRE: ",-50,d+120,{align:"center"}),n.rect(440,d+105,90,0,{align:"right"}).stroke(),n.text("FIRMA CLIENTE",350,d+110,{align:"center"}),n.text("NOMBRE: ",330,d+120,{align:"center"}),n.text("HORA RECEP.: ",350,d+130,{align:"center"}),n.font("Helvetica",8),n.text(o+t.cantidad_despacho,l+300,d+40),n.text(t.cantidad-(o+t.cantidad_despacho),l+300,d+60),n.end(),s.on("finish",function(){var e=s.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),i.stop()}});else{o=t.cantidad_despacho;var r=new PDFDocument({compress:!1,size:[612,792],margin:10}),c=r.pipe(blobStream()),n=(new Date,80);r.font("Helvetica",8);var s=195;e.dibujarCabeceraPDFImpresion(r,t,0),r.font("Helvetica",8),r.text(1,55,s),r.text(t.producto.codigo,100,s),r.text(t.producto.nombre.toUpperCase(),180,s,{width:180}),r.text(t.cantidad,380,s),r.text(t.precio_unitario,450,s),r.text(t.importe,520,s),r.rect(40,s+10,540,0).stroke(),r.rect(40,s-10,0,40).stroke(),r.rect(580,s-10,0,60).stroke(),r.rect(80,s-35,0,65).stroke(),r.rect(160,s-35,0,85).stroke(),r.rect(425,s-35,0,65).stroke(),r.rect(370,s-35,0,65).stroke(),r.rect(425,s+50,0,40).stroke(),r.rect(370,s+50,0,40).stroke(),r.rect(495,s+50,0,20).stroke(),r.rect(580,s+50,0,20).stroke(),r.rect(495,s+70,85,0).stroke(),r.rect(495,s-35,0,85).stroke(),r.rect(160,s+50,420,0).stroke(),r.rect(370,s+70,55,0).stroke(),r.rect(370,s+90,55,0).stroke(),s+=20;var l=0;r.text(t.producto.codigo,100,s),(p=t.producto.nombre.toUpperCase()+" (DESPACHADO)").length>37&&(l=-6),r.text(p,180,s+l,{width:180}),r.text(t.cantidad_despacho,380,s),r.text("SERVICIO DE TRANSPORTE",180,s+20),r.text(t.servicio_transporte,520,s+20),r.text(t.importe+t.servicio_transporte,520,s+40),r.rect(40,s+10,540,0).stroke(),r.font("Helvetica-Bold",8),r.text("Total",n+250,s+40),r.text("Saldo",n+250,s+60),r.rect(60,s+105,90,0,{align:"left"}).stroke(),r.text("DESPACHO",60,s+110,{align:"left"}),r.text(e.usuario.persona.nombre_completo,60,s+120,{align:"left"});var d=new Date(t.fecha).getHours();x=(x=new Date(t.fecha).getMinutes())<10?x="0"+x:x,d=d<10?d="0"+d:d,r.text("HORA DESP.: "+d+":"+x,60,s+130,{align:"left"}),r.rect(255,s+105,90,0,{align:"center"}).stroke(),r.text("FIRMA CONDUCTOR",-10,s+110,{align:"center"}),r.text("NOMBRE: ",-50,s+120,{align:"center"}),r.rect(440,s+105,90,0,{align:"right"}).stroke(),r.text("FIRMA CLIENTE",350,s+110,{align:"center"}),r.text("NOMBRE: ",330,s+120,{align:"center"}),r.text("HORA RECEP.: ",350,s+130,{align:"center"}),r.font("Helvetica",8),r.text(o,n+300,s+40),r.text(t.cantidad-o,n+300,s+60);n=80;r.font("Helvetica",8);var p;s=600;e.dibujarCabeceraPDFImpresion(r,t,405),r.font("Helvetica",8),r.text(1,55,s),r.text(t.producto.codigo,100,s),r.text(t.producto.nombre.toUpperCase(),180,s),r.text(t.cantidad,380,s),r.text(t.precio_unitario,450,s),r.text(t.importe,520,s),r.rect(40,s+10,540,0).stroke(),r.rect(40,s-10,0,40).stroke(),r.rect(580,s-10,0,60).stroke(),r.rect(80,s-35,0,65).stroke(),r.rect(160,s-35,0,85).stroke(),r.rect(425,s-35,0,65).stroke(),r.rect(370,s-35,0,65).stroke(),r.rect(425,s+50,0,40).stroke(),r.rect(370,s+50,0,40).stroke(),r.rect(495,s+50,0,20).stroke(),r.rect(580,s+50,0,20).stroke(),r.rect(495,s-35,0,85).stroke(),r.rect(160,s+50,420,0).stroke(),r.rect(370,s+70,55,0).stroke(),r.rect(370,s+90,55,0).stroke(),r.rect(495,s+70,85,0).stroke(),s+=20,r.text(t.producto.codigo,100,s),(p=t.producto.nombre.toUpperCase()+" (DESPACHADO)").length>37&&(l=-6),r.text(p,180,s+l,{width:180}),r.text(t.cantidad_despacho,380,s),r.text("SERVICIO DE TRANSPORTE",180,s+20),r.text(t.servicio_transporte,520,s+20),r.text(t.importe+t.servicio_transporte,520,s+40),r.rect(40,s+10,540,0).stroke(),r.font("Helvetica-Bold",8),r.text("Total",n+250,s+40),r.text("Saldo",n+250,s+60),r.rect(60,s+105,90,0,{align:"left"}).stroke(),r.text("DESPACHO",60,s+110,{align:"left"}),r.text(e.usuario.persona.nombre_completo,60,s+120,{align:"left"});var x;d=new Date(t.fecha).getHours();x=(x=new Date(t.fecha).getMinutes())<10?x="0"+x:x,d=d<10?d="0"+d:d,r.text("HORA DESP.: "+d+":"+x,60,s+130,{align:"left"}),r.rect(255,s+105,90,0,{align:"center"}).stroke(),r.text("FIRMA CONDUCTOR",-10,s+110,{align:"center"}),r.text("NOMBRE: ",-50,s+120,{align:"center"}),r.rect(440,s+105,90,0,{align:"right"}).stroke(),r.text("FIRMA CLIENTE",350,s+110,{align:"center"}),r.text("NOMBRE: ",330,s+120,{align:"center"}),r.text("HORA RECEP.: ",350,s+130,{align:"center"}),r.font("Helvetica",8),r.text(o,n+300,s+40),r.text(t.cantidad-o,n+300,s+60),r.end(),c.on("finish",function(){var e=c.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),i.stop()}})},e.dibujarCabeceraPDFImpresion=function(t,o,a){var r=a+80,i=new Date;i=e.fechaATexto(i);t.rect(40,a+80+80,540,25).fillAndStroke("silver","#000"),t.font("Helvetica-Bold",12).fill("black"),t.text("DESPACHO DE PRODUCTOS",0,a+25,{align:"center"}),t.font("Helvetica-Bold",8),t.font("Helvetica",8),t.font("Helvetica-Bold",8),t.text("FECHA: ",505,a+60,{width:40}),t.text("Cliente: ",465,a+80),t.text("Cod. SAP: ",465,a+90),t.font("Helvetica",8),t.text(e.fechaATexto(o.fecha),540,a+60,{width:45}),t.text(o.despacho.cliente.codigo,510,a+80);var c="";t.text(o.despacho.cliente.razon_social,80,a+90);var n=a+90;t.font("Helvetica-Bold",8),t.text("Cod. Vend: ",465,n+10),t.font("Helvetica",8),t.text(o.despacho.cliente.texto2,510,n+10),t.font("Helvetica-Bold",14),t.text("N°",380,a+25,{align:"center"}),t.text(o.numero_correlativo,510,a+25),t.rect(40,a+80+80,540,25).stroke().fill("silver"),t.rect(0,0,0,0).stroke().fill("black"),t.font("Helvetica-Bold",8),t.text("Nº",55,90+r),t.text("Código",100,90+r),t.text("Detalle",180,90+r),t.text("Cantidad",380,90+r),t.text("Precio",450,90+r),t.text("Importe",520,90+r),t.text("Clientes:",40,a+90),t.text("Destino Mercaderia:",40,a+100);var s=o.despacho.destino.destino,l=0;s.length>61&&(l=10),t.text("Nombre Fact:",40,a+110+l),t.font("Helvetica",8),null!==o.despacho.cliente_razon&&void 0!==o.despacho.cliente_razon&&(c=o.despacho.cliente_razon.codigo_sap,t.text(o.despacho.cliente_razon.razon_social,100,a+110+l)),t.text(c,510,a+90,{width:80}),t.font("Helvetica-Bold",8),t.text("CI/NIT:",40,a+120+l),t.text("Teléfono:",200,a+120+l),t.text("Dirección:",40,a+130+l),t.text("observaciones:",40,a+140+l),t.font("Helvetica",8),t.text(o.despacho.cliente_razon.nit,80,a+120+l),o.despacho.cliente.telefono1&&t.text(o.despacho.cliente.telefono1,240,a+120+l),t.text(o.despacho.destino.direccion,80,a+130+l),o.despacho.observacion&&t.text(o.despacho.observacion,100,a+140+l),null!==o.despacho.destino&&void 0!==o.despacho.destino?t.text(s,120,a+100,{width:320}):t.text(" ",120,a+100)},e.abrirModalAsignacionFactura=function(t){e.abrirPopup(e.idModalAsignacionFactura),e.detalle_despacho=t,e.detalle_despacho.fecha_factura&&(e.detalle_despacho.fecha_factura=e.fechaATexto(e.detalle_despacho.fecha_factura))},e.imprimirFactura=function(t){i.start();var o=0;d(t).then(function(a){if(a.detallesDespacho.length>0)a.detallesDespacho.forEach(function(a,r,c){if(o+=a.cantidad_despacho,r==c.length-1){var n=new PDFDocument({compress:!1,size:[612,792],margin:10}),s=n.pipe(blobStream()),l=(new Date,80);n.font("Helvetica",8);var d=195,p=0;e.dibujarCabeceraPDFImpresion2(n,t,0),n.font("Helvetica",8),n.text(1,55,d),n.text(t.producto.codigo,100,d),n.text(t.producto.nombre.toUpperCase(),180,d),n.text(t.cantidad,500,d),n.rect(40,d+10,540,0).stroke(),n.rect(40,d-10,0,40).stroke(),n.rect(580,d-10,0,60).stroke(),n.rect(80,d-35,0,65).stroke(),n.rect(160,d-35,0,85).stroke(),n.rect(425,d-35,0,65).stroke(),n.rect(580,d-35,0,125).stroke(),n.rect(425,d+50,0,40).stroke(),n.rect(160,d+50,420,0).stroke(),n.rect(425,d+70,153,0).stroke(),n.rect(425,d+90,153,0).stroke(),d+=20,n.text(t.producto.codigo,100,d),(u=t.producto.nombre.toUpperCase()+" (DESPACHADO)").length>37&&(p=-6),n.text(u,180,d+p,{width:180}),n.text(t.cantidad_despacho,500,d),n.rect(40,d+10,540,0).stroke(),n.font("Helvetica-Bold",8),n.text("Total",l+250,d+40),n.text("Saldo",l+250,d+60),n.rect(60,d+105,90,0,{align:"left"}).stroke(),n.text("DESPACHO",60,d+110,{align:"left"}),n.text(e.usuario.persona.nombre_completo,60,d+120,{align:"left"});var x=(new Date).getHours();f=(f=(new Date).getMinutes())<10?f="0"+f:f,x=x<10?x="0"+x:x,n.text("HORA DESP.: "+x+":"+f,60,d+130,{align:"left"}),n.rect(255,d+105,90,0,{align:"center"}).stroke(),n.text("FIRMA CONDUCTOR",-10,d+110,{align:"center"}),n.text("NOMBRE: ",-50,d+120,{align:"center"}),n.rect(440,d+105,90,0,{align:"right"}).stroke(),n.text("FIRMA CLIENTE",350,d+110,{align:"center"}),n.text("NOMBRE: ",330,d+120,{align:"center"}),n.text("HORA RECEP.: ",350,d+130,{align:"center"}),n.font("Helvetica",8),n.text(o+t.cantidad_despacho,l+420,d+40),n.text(t.cantidad-(o+t.cantidad_despacho),l+420,d+60);l=80;n.font("Helvetica",8);d=600;e.dibujarCabeceraPDFImpresion2(n,t,405),n.font("Helvetica",8),n.text(1,55,d),n.text(t.producto.codigo,100,d),n.text(t.producto.nombre.toUpperCase(),180,d),n.text(t.cantidad,500,d),n.rect(40,d+10,540,0).stroke(),n.rect(40,d-10,0,40).stroke(),n.rect(580,d-10,0,60).stroke(),n.rect(80,d-35,0,65).stroke(),n.rect(160,d-35,0,85).stroke(),n.rect(425,d-35,0,65).stroke(),n.rect(425,d+50,0,40).stroke(),n.rect(580,d+50,0,40).stroke(),n.rect(160,d+50,420,0).stroke(),n.rect(425,d+70,153,0).stroke(),n.rect(425,d+90,153,0).stroke(),d+=20;var u;p=0;n.text(t.producto.codigo,100,d),(u=t.producto.nombre.toUpperCase()+" (DESPACHADO)").length>37&&(p=-6),n.text(u,180,d+p,{width:180}),n.text(t.cantidad_despacho,500,d),n.rect(40,d+10,540,0).stroke(),n.font("Helvetica-Bold",8),n.text("Total",l+250,d+40),n.text("Saldo",l+250,d+60),n.rect(60,d+105,90,0,{align:"left"}).stroke(),n.text("DESPACHO",60,d+110,{align:"left"}),n.text(e.usuario.persona.nombre_completo,60,d+120,{align:"left"});var f;x=(new Date).getHours();f=(f=(new Date).getMinutes())<10?f="0"+f:f,x=x<10?x="0"+x:x,n.text("HORA DESP.: "+x+":"+f,60,d+130,{align:"left"}),n.rect(255,d+105,90,0,{align:"center"}).stroke(),n.text("FIRMA CONDUCTOR",-10,d+110,{align:"center"}),n.text("NOMBRE: ",-50,d+120,{align:"center"}),n.rect(440,d+105,90,0,{align:"right"}).stroke(),n.text("FIRMA CLIENTE",350,d+110,{align:"center"}),n.text("NOMBRE: ",330,d+120,{align:"center"}),n.text("HORA RECEP.: ",350,d+130,{align:"center"}),n.font("Helvetica",8),n.text(o+t.cantidad_despacho,l+420,d+40),n.text(t.cantidad-(o+t.cantidad_despacho),l+420,d+60),n.end(),s.on("finish",function(){var e=s.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),i.stop()}});else{o=t.cantidad_despacho;var r=new PDFDocument({compress:!1,size:[612,792],margin:10}),c=r.pipe(blobStream()),n=(new Date,80);r.font("Helvetica",8);var s=195;e.dibujarCabeceraPDFImpresion2(r,t,0),r.font("Helvetica",8),r.text(1,55,s),r.text(t.producto.codigo,100,s),r.text(t.producto.nombre.toUpperCase(),180,s,{width:180}),r.text(t.cantidad,500,s),r.rect(40,s+10,540,0).stroke(),r.rect(40,s-10,0,40).stroke(),r.rect(580,s-10,0,60).stroke(),r.rect(80,s-35,0,65).stroke(),r.rect(160,s-35,0,85).stroke(),r.rect(425,s-35,0,65).stroke(),r.rect(425,s+50,0,40).stroke(),r.rect(580,s+50,0,40).stroke(),r.rect(160,s+50,420,0).stroke(),r.rect(425,s+70,153,0).stroke(),r.rect(425,s+90,153,0).stroke(),s+=20;var l=0;r.text(t.producto.codigo,100,s),(p=t.producto.nombre.toUpperCase()+" (DESPACHADO)").length>37&&(l=-6),r.text(p,180,s+l,{width:180}),r.text(t.cantidad_despacho,500,s),r.rect(40,s+10,540,0).stroke(),r.font("Helvetica-Bold",8),r.text("Total",n+250,s+40),r.text("Saldo",n+250,s+60),r.rect(60,s+105,90,0,{align:"left"}).stroke(),r.text("DESPACHO",60,s+110,{align:"left"}),r.text(e.usuario.persona.nombre_completo,60,s+120,{align:"left"});var d=new Date(t.fecha).getHours();x=(x=new Date(t.fecha).getMinutes())<10?x="0"+x:x,d=d<10?d="0"+d:d,r.text("HORA DESP.: "+d+":"+x,60,s+130,{align:"left"}),r.rect(255,s+105,90,0,{align:"center"}).stroke(),r.text("FIRMA CONDUCTOR",-10,s+110,{align:"center"}),r.text("NOMBRE: ",-50,s+120,{align:"center"}),r.rect(440,s+105,90,0,{align:"right"}).stroke(),r.text("FIRMA CLIENTE",350,s+110,{align:"center"}),r.text("NOMBRE: ",330,s+120,{align:"center"}),r.text("HORA RECEP.: ",350,s+130,{align:"center"}),r.font("Helvetica",8),r.text(o,n+420,s+40),r.text(t.cantidad-o,n+420,s+60);n=80;r.font("Helvetica",8);var p;s=600;e.dibujarCabeceraPDFImpresion2(r,t,405),r.font("Helvetica",8),r.text(1,55,s),r.text(t.producto.codigo,100,s),r.text(t.producto.nombre.toUpperCase(),180,s),r.text(t.cantidad,500,s),r.rect(40,s+10,540,0).stroke(),r.rect(40,s-10,0,40).stroke(),r.rect(580,s-10,0,60).stroke(),r.rect(80,s-35,0,65).stroke(),r.rect(160,s-35,0,85).stroke(),r.rect(425,s-35,0,65).stroke(),r.rect(425,s+50,0,40).stroke(),r.rect(580,s+50,0,40).stroke(),r.rect(160,s+50,420,0).stroke(),r.rect(425,s+70,153,0).stroke(),r.rect(425,s+90,153,0).stroke(),s+=20,r.text(t.producto.codigo,100,s),(p=t.producto.nombre.toUpperCase()+" (DESPACHADO)").length>37&&(l=-6),r.text(p,180,s+l,{width:180}),r.text(t.cantidad_despacho,500,s),r.rect(40,s+10,540,0).stroke(),r.font("Helvetica-Bold",8),r.text("Total",n+250,s+40),r.text("Saldo",n+250,s+60),r.rect(60,s+105,90,0,{align:"left"}).stroke(),r.text("DESPACHO",60,s+110,{align:"left"}),r.text(e.usuario.persona.nombre_completo,60,s+120,{align:"left"});var x;d=new Date(t.fecha).getHours();x=(x=new Date(t.fecha).getMinutes())<10?x="0"+x:x,d=d<10?d="0"+d:d,r.text("HORA DESP.: "+d+":"+x,60,s+130,{align:"left"}),r.rect(255,s+105,90,0,{align:"center"}).stroke(),r.text("FIRMA CONDUCTOR",-10,s+110,{align:"center"}),r.text("NOMBRE: ",-50,s+120,{align:"center"}),r.rect(440,s+105,90,0,{align:"right"}).stroke(),r.text("FIRMA CLIENTE",350,s+110,{align:"center"}),r.text("NOMBRE: ",330,s+120,{align:"center"}),r.text("HORA RECEP.: ",350,s+130,{align:"center"}),r.font("Helvetica",8),r.text(o,n+420,s+40),r.text(t.cantidad-o,n+420,s+60),r.end(),c.on("finish",function(){var e=c.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),i.stop()}})},e.dibujarCabeceraPDFImpresion2=function(t,o,a){var r=a+80,i=new Date;i=e.fechaATexto(i);t.rect(40,a+80+80,540,25).fillAndStroke("silver","#000"),t.font("Helvetica-Bold",12).fill("black"),t.text("DESPACHO DE PRODUCTOS",0,a+25,{align:"center"}),t.font("Helvetica-Bold",8),t.font("Helvetica",8),t.font("Helvetica-Bold",8),t.text("FECHA: ",505,a+60,{width:40}),t.text("Cliente: ",465,a+80),t.text("Cod. SAP: ",465,a+90),t.font("Helvetica",8),t.text(e.fechaATexto(o.fecha),540,a+60,{width:45}),t.text(o.despacho.cliente.codigo,510,a+80);var c="";t.text(o.despacho.cliente.razon_social,80,a+90);var n=a+90;t.font("Helvetica-Bold",8),t.text("Cod. Vend: ",465,n+10),t.font("Helvetica",8),t.text(o.despacho.cliente.texto2,510,n+10),t.font("Helvetica-Bold",14),t.text("N°",380,a+25,{align:"center"}),t.text(o.numero_correlativo,510,a+25),t.rect(40,a+80+80,540,25).stroke().fill("silver"),t.rect(0,0,0,0).stroke().fill("black"),t.font("Helvetica-Bold",8),t.text("Nº",55,90+r),t.text("Código",100,90+r),t.text("Detalle",180,90+r),t.text("Cantidad",480,90+r),t.text("Clientes:",40,a+90),t.text("Destino Mercaderia:",40,a+100);var s=o.despacho.destino.destino,l=0;s.length>61&&(l=10),t.text("Nombre Fact:",40,a+110+l),t.font("Helvetica",8),null!==o.despacho.cliente_razon&&void 0!==o.despacho.cliente_razon&&(c=o.despacho.cliente_razon.codigo_sap,t.text(o.despacho.cliente_razon.razon_social,100,a+110+l)),t.text(c,510,a+90,{width:80}),t.font("Helvetica-Bold",8),t.text("CI/NIT:",40,a+120+l),t.text("Teléfono:",200,a+120+l),t.text("Dirección:",40,a+130+l),t.text("observaciones:",40,a+140+l),t.font("Helvetica",8),t.text(o.despacho.cliente_razon.nit,80,a+120+l),o.despacho.cliente.telefono1&&t.text(o.despacho.cliente.telefono1,240,a+120+l),t.text(o.despacho.destino.direccion,80,a+130+l),o.despacho.observacion&&t.text(o.despacho.observacion,100,a+140+l),null!==o.despacho.destino&&void 0!==o.despacho.destino?t.text(s,120,a+100,{width:320}):t.text(" ",120,a+100)},e.cerrarAsignacionFactura=function(){e.cerrarPopup(e.idModalAsignacionFactura)},e.abrirModalVentaKardexFactura=function(){e.filtroVentaKardex={pendiente:!0},e.obtenerVentaKardexFactura({pendiente:!0}),e.abrirPopup(e.idModalVentaKardexFactura)},e.cerrarVentaKardexFactura=function(){e.cerrarPopup(e.idModalVentaKardexFactura)},e.abrirModalAsignacionFacturaKardex=function(t){e.detalle_kardex=t,e.abrirPopup(e.idModalAsignacionFacturaKardex)},e.cerrarAsignacionFacturaKardex=function(){e.cerrarPopup(e.idModalAsignacionFacturaKardex)},e.abrirModalDetalleKardex=function(t){e.kardex=t,e.abrirPopup(e.idModalDetalleKardex)},e.cerrarDetalleKardex=function(){e.cerrarPopup(e.idModalDetalleKardex)},e.establecerFactura=function(t){t.fecha_factura=t.fecha_factura?new Date(e.convertirFecha(t.fecha_factura)):null,l.update({id_detalle_despacho:t.id},t,function(t){e.cerrarAsignacionFactura(),e.mostrarMensaje(t.mensaje)})},e.establecerFacturaKardex=function(t){f.update({id_detalle_kardex:t.id},t,function(t){e.obtenerVentaKardexFactura(e.filtroVentaKardex),e.cerrarAsignacionFacturaKardex(),e.mostrarMensaje(t.mensaje)})},e.removerDetalleDespacho=function(t){(t=new l(t)).$delete(function(t){e.obtenerDespachados(),e.mostrarMensaje(t.mensaje)})},e.obtenerVentaKardexFactura=function(t){t.inicio?(t.inicio=new Date(e.convertirFecha(t.inicio)),t.fin=new Date(e.convertirFecha(t.fin))):(t.inicio=0,t.fin=0),u(e.usuario.id_empresa,t).then(function(t){e.filtroVentaKardex.inicio instanceof Date&&(e.filtroVentaKardex.inicio=e.fechaATexto(e.filtroVentaKardex.inicio),e.filtroVentaKardex.fin=e.fechaATexto(e.filtroVentaKardex.fin)),e.detalleKardexFactura=t})},e.CalcularMontoEnDolar=function(e){e.resivo.tipo_moneda?e.resivo.monto=e.resivo.monto_dolar:(e.resivo.maxmonto_dolar=e.saldo_pago_ac/e.resivo.cambio_moneda,e.resivo.monto=e.resivo.monto_dolar*e.resivo.cambio_moneda)},e.montoDolar=function(e){e.resivo.monto_dolar=e.resivo.monto},e.abrirModalCobros=function(t){e.detalle_despacho=t;var o=e.detalle_despacho.factura?e.detalle_despacho.factura:"";e.detalle_despacho.resivo={sucursal:e.sucursales[0],tipo_moneda:!0,monto_dolar:0,cambio_moneda:6.9,fecha:e.fechaATexto(new Date),tipoPago:e.tiposPagosResivo[0],eliminado:!1,concepto:"Pago total de "+e.detalle_despacho.cantidad_despacho+" "+e.detalle_despacho.producto.unidad_medida+" de "+e.detalle_despacho.producto.nombre+" y servicio de distribución s/g factura nro. "+o},e.abrirPopup(e.IdModalCobros)},e.cerrarModalCobros=function(){e.detalle_despacho.resivo.edit&&e.obtenerDespachados(),e.cerrarPopup(e.IdModalCobros)},e.abrirModalHistorialCobros=function(){e.detalle_despacho.recivos=e.detalle_despacho.recivos.sort(function(e,t){return e.id-t.id}),e.abrirPopup(e.IdModalHistorialCobros)},e.cerrarModalHistorialCobros=function(){e.cerrarPopup(e.IdModalHistorialCobros)},e.abrirModalVerificarCuenta=function(t,o){e.dato=t,e.tipoDatosPermiso=o,e.cuenta={},e.abrirPopup(e.IdModalVerificarCuenta)},e.cerrarModalVerificarCuenta=function(){e.cerrarPopup(e.IdModalVerificarCuenta)},e.verificarCuentaAdmin=function(t){g.save({id_empresa:e.usuario.id_empresa},t,function(t){t.type?(e.mostrarMensaje(t.message),"despacho"==e.tipoDatosPermiso&&e.abrirModalAsignacionFactura(e.dato),"despachoKardex"==e.tipoDatosPermiso&&e.abrirModalAsignacionFacturaKardex(e.dato),"EditarDespachoResivo"==e.tipoDatosPermiso&&(e.detalle_despacho.resivo=e.dato,e.detalle_despacho.resivo.edit=!0,e.detalle_despacho.saldo_pago_ac=e.detalle_despacho.saldo_pago_ac+e.detalle_despacho.resivo.monto,e.detalle_despacho.pago_ac=e.detalle_despacho.pago_ac-e.detalle_despacho.resivo.monto,e.tiposPagosResivo.forEach(function(t,o,a){e.dato.tipoPago.id==t.id&&(e.detalle_despacho.resivo.tipoPago=t)}),e.detalle_despacho.resivo.fecha=e.fechaATexto(e.detalle_despacho.resivo.fecha),e.cerrarModalHistorialCobros()),"EliminarDespachoResivo"==e.tipoDatosPermiso&&(e.dato.eliminado=!0,e.dato.pago_ac=e.detalle_despacho.pago_ac-e.dato.monto,e.dato.saldo_pago_ac=e.detalle_despacho.total-e.dato.pago_ac,e.crearDespachoResivo(e.dato),e.cerrarModalHistorialCobros()),e.cerrarModalVerificarCuenta(t)):e.mostrarMensaje(t.message)})},e.crearDespachoResivo=function(t){t.fecha=new Date(e.convertirFecha(t.fecha)),0==t.eliminado&&(t.pago_ac=e.detalle_despacho.pago_ac+t.monto,t.saldo_pago_ac=e.detalle_despacho.total-t.pago_ac),e.estadosDespacho.forEach(function(o,a,r){(e.detalle_despacho.saldo_pago_ac==t.monto?"PAGADO"==o.nombre&&(t.estado=o):"PARCIAL"==o.nombre&&(t.estado=o),a===r.length-1)&&h(e.detalle_despacho.id,t).then(function(t){e.mostrarMensaje(t.mensaje),0==t.recivo.eliminado&&e.imprimirResivo(t.recivo),e.cerrarModalCobros(),e.paginator.search?e.paginator.getSearch(e.paginator.search,e.paginator.filter,null):e.paginator.getSearch("",e.paginator.filter,null)})})},e.obtenerCuentasBancos=function(){i.start(),D(e.usuario.id_empresa).then(function(t){e.cuentasBancos=t,i.stop()})},e.obtenerOtrosBancos=function(){i.start(),v("RRHH_BAN",e.usuario.id_empresa).then(function(t){e.otrosBancos=t,i.stop()})},e.abrirDialogConceptoEdicion=function(t){e.tipo_edicion=t,e.clase={},e.abrirPopup(e.idModalConceptoEdicion)},e.cerrarDialogConceptoEdicion=function(){e.cerrarPopup(e.idModalConceptoEdicion)},e.verDatosCobros=function(){e.verDatosCobroDespachos=!e.verDatosCobroDespachos},e.imprimirResivo=function(t){convertUrlToBase64Image(e.usuario.empresa.imagen,function(o){var a=new PDFDocument({compress:!1,size:"letter",margin:10}),r=a.pipe(blobStream()),i=new Date(t.fecha);e.dibujarCabeceraPDFImpresionRecivo(a,t,o,30),t.tipo_moneda?(a.text(t.monto+" .-",485,20),a.text("----",485,45),a.text("----",485,70)):(a.text("----",485,20),a.text(t.monto+" .-",485,45),a.text(t.cambio_moneda+" .-",485,70)),a.text(e.detalle_despacho.despacho.cliente.razon_social,100,110),t.tipo_moneda?a.text("                          "+ConvertirALiteral(t.monto.toFixed(2)),40,130,{width:550,lineGap:6}):a.text("                          "+ConvertirALiteral(t.monto.toFixed(2),"DÓLARES"),40,130,{width:550,lineGap:6}),a.text("                               "+t.concepto,40,170,{width:550,lineGap:6}),a.text(e.detalle_despacho.despacho.cliente_razon.razon_social+"-"+e.detalle_despacho.despacho.cliente_razon.nit,165,210),a.text(e.detalle_despacho.factura?e.detalle_despacho.factura:"",465,210),"CHEQUE"==t.tipoPago.nombre?(a.text(t.numero_cuenta,270,230),a.text(t.otroBanco.nombre,470,230)):"DEPOSITO"==t.tipoPago.nombre?a.text(t.banco.nombre,470,230):(a.moveTo(103,240).lineTo(105,245).dash(0,{space:0}).lineTo(115,230).stroke(),a.text("----",270,230),a.text("----",475,230));var c=t.sucursal.departamento.nombre_corto.split("-")[0];a.text(i.getDate()>=10?c+"  "+i.getDate():c+"  0"+i.getDate(),160,260),a.text(i.getMonth()+1>=10?i.getMonth()+1:"0"+(i.getMonth()+1),310,260),s=(s=i.getFullYear()).toString().substr(-2),a.text(s,440,260);var n=new Date;a.font("Helvetica",5),a.text("EMISIÓN: "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),200,375),a.text("IMPRESIÓN: "+n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear(),260,375),a.text("USUARIO: "+e.usuario.persona.nombre_completo,40,375),a.font("Helvetica",8),a.rect(3,400,600,0).dash(1,{space:5}).stroke(),e.dibujarCabeceraPDFImpresionRecivo(a,t,o,430),t.tipo_moneda?(a.text(t.monto+" .-",485,420),a.text("----",485,445),a.text("----",485,470)):(a.text("----",485,420),a.text(t.monto+" .-",485,445),a.text(t.cambio_moneda+" .-",485,470)),a.text(e.detalle_despacho.despacho.cliente.razon_social,100,510),t.tipo_moneda?a.text("                          "+ConvertirALiteral(t.monto.toFixed(2)),40,530,{width:550,lineGap:6}):a.text("                          "+ConvertirALiteral(t.monto.toFixed(2),"DÓLARES"),40,530,{width:550,lineGap:6}),a.text("-                               "+t.concepto,40,570,{width:550,lineGap:6}),a.text(e.detalle_despacho.despacho.cliente_razon.razon_social+"-"+e.detalle_despacho.despacho.cliente_razon.nit,165,610),a.text(e.detalle_despacho.factura?e.detalle_despacho.factura:"",465,610),"CHEQUE"==t.tipoPago.nombre?(a.text(t.numero_cuenta,270,630),a.text(t.otroBanco.nombre,470,630)):"DEPOSITO"==t.tipoPago.nombre?a.text(t.banco.nombre,470,630):(a.moveTo(103,640).lineTo(105,645).dash(0,{space:0}).lineTo(115,630).stroke(),a.text("----",270,630),a.text("----",475,630));var s;c=t.sucursal.departamento.nombre_corto.split("-")[0];a.text(i.getDate()>=10?c+"  "+i.getDate():c+"  0"+i.getDate(),160,660),a.text(i.getMonth()+1>=10?i.getMonth()+1:"0"+(i.getMonth()+1),310,660),s=(s=i.getFullYear()).toString().substr(-2),a.text(s,440,660),a.font("Helvetica",5),a.text("EMISIÓN: "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),200,775),a.text("IMPRESIÓN: "+n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear(),260,775),a.text("USUARIO: "+e.usuario.persona.nombre_completo,40,775),a.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},e.dibujarCabeceraPDFImpresionRecivo=function(e,t,o,a){e.font("Helvetica-Bold",16),e.text("RECIBO DE INGRESO",0,a,{align:"center"}),e.text(t.sucursal.nombre,0,a+20,{align:"center"}),e.text("N° "+t.numero_correlativo,0,a+35,{align:"center"}),e.image(o,40,a-20,{fit:[80,80]}),e.rect(450,a-15,140,20).dash(0,{space:0}).stroke(),e.rect(450,a+10,140,20).dash(0,{space:0}).stroke(),e.rect(450,a+35,140,20).dash(0,{space:0}).stroke(),e.font("Helvetica-Bold",12),e.text("Bs.",455,a-10),e.text("$us.",455,a+15),e.text("T./C.",455,a+40),e.font("Helvetica",12),e.text("Recibí de:",40,a+80),e.rect(100,a+90,490,0).dash(1,{space:5}).stroke(),e.text("El importe de:",40,a+100),e.rect(130,a+110,460,0).stroke(),e.rect(40,a+130,550,0).stroke(),e.text("Por concepto de:",40,a+140),e.rect(140,a+150,450,0).stroke(),e.rect(40,a+170,550,0).stroke(),e.text("Factura a Nombre de:",40,a+180),e.rect(165,a+190,280,0).stroke(),e.text("N°",450,a+180),e.rect(465,a+190,120,0).stroke(),e.text("Efectivo",40,a+200),e.rect(90,a+195,30,25).dash(0,{space:0}).stroke(),"DEPOSITO"==t.tipoPago.nombre?e.text("Deposito N°",200,a+200):e.text("Cheque N°",200,a+200),e.rect(260,a+210,130,0).dash(1,{space:5}).stroke(),e.text("Banco",430,a+200),e.rect(465,a+210,120,0).stroke(),e.rect(140,a+240,100,0).stroke(),e.text("de",240,a+230),e.rect(260,a+240,135,0).stroke(),e.text("de 20",400,a+230),e.rect(440,a+240,40,0).stroke(),e.text("Recibí conforme",80,a+300),e.rect(40,a+290,180,0).stroke(),e.text("Nombre:",40,a+315),e.rect(85,a+325,120,0).stroke(),e.text("C.I:",40,a+330),e.rect(60,a+340,145,0).stroke(),e.text("Entregué conforme",440,a+300),e.rect(405,a+290,180,0).stroke(),e.text("Nombre:",405,a+315),e.rect(455,a+325,130,0).stroke(),e.text("C.I:",405,a+330),e.rect(422,a+340,162,0).stroke()},e.abrirModificarDespacho=function(t){e.gtm_detalle_despacho=t,e.abrirPopup(e.idModalAsignacionDespacho)},e.cerrarModificarDespacho=function(){e.cerrarPopup(e.idModalAsignacionDespacho)},e.actualizarDespacho=function(){_(e.gtm_detalle_despacho).then(function(t){e.obtenerDespachados(),e.mostrarMensaje(t.mensaje)})},e.$on("$routeChangeStart",function(t,o){e.eliminarPopup(e.idModalAsignacionFactura),e.eliminarPopup(e.idModalVentaKardexFactura),e.eliminarPopup(e.idModalAsignacionFacturaKardex),e.eliminarPopup(e.idModalDetalleKardex),e.eliminarPopup(e.IdModalVerificarCuenta),e.eliminarPopup(e.IdModalCobros),e.eliminarPopup(e.IdModalHistorialCobros),e.eliminarPopup(e.idModalConceptoEdicion),e.eliminarPopup(e.idModalAsignacionDespacho)}),e.inicio()}]);