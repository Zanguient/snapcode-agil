angular.module("agil.controladores").controller("ControladorGtmDespacho",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Paginator","FieldViewer","GtmDespachos","GtmDetalleDespacho","GetGtmDetalleDespachoHijos","ImprimirPdfDespachos","ExportarExelDespachos","ListaDetalleKardexFactura","GtmDetalleDespachoKardex","VerificarUsuarioEmpresa","CrearDespachoResivo","ClasesTipo","ListaBancos","ClasesTipoEmpresa","ActualizarDatosDespachoDetalle",function(u,e,t,o,a,f,r,i,c,n,s,l,d,p,x,g,h,m,D,v,_){f.start(),u.usuario=JSON.parse(e.usuario),u.idModalAsignacionFactura="modal-asignacion-factura",u.idModalVentaKardexFactura="modal-venta-kardex-factura",u.idModalAsignacionFacturaKardex="modal-asignacion-factura-kardex",u.idModalDetalleKardex="modal-detalle-kardex",u.IdModalVerificarCuenta="modal-verificar-cuenta",u.IdModalCobros="modal-cobros",u.IdModalHistorialCobros="modal-historial-cobros",u.idModalConceptoEdicion="dialog-conceptos",u.idModalAsignacionDespacho="gtm-asignacion-despachos",u.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptDespacho(u.idModalAsignacionFactura,u.idModalVentaKardexFactura,u.idModalAsignacionFacturaKardex,u.idModalDetalleKardex,u.IdModalVerificarCuenta,u.IdModalCobros,u.IdModalHistorialCobros,u.idModalConceptoEdicion,u.idModalAsignacionDespacho),u.buscarAplicacion(u.usuario.aplicacionesUsuario,t.path().substring(1))}),u.inicio=function(){u.obtenerDespachados(),u.obtenerTiposPagoResivo(),u.obtenerCuentasBancos(),u.obtenerOtrosBancos(),u.verDatosCobroDespachos=!1},u.obtenerTiposPagoResivo=function(){f.start(),m("GTM_TP").then(function(e){u.tiposPagosResivo=e.clases,f.stop()})},u.obtenerDespachados=function(){f.start(),u.paginator=r(),u.paginator.column="id",u.paginator.direccion="asc",u.filtro={id_empresa:u.usuario.id_empresa,inicio:"",fin:"",transportista:"",tipo:"",grupo:"",estado:"",vendedor:"",admin:"ADMINISTRADOR"==u.usuario.rolesUsuario[0].rol.nombre?"":u.usuario.id},u.paginator.callBack=u.buscarDespachados,u.paginator.getSearch("",u.filtro,null),f.stop()},u.buscarDespachados=function(){if(0!=u.paginator.filter.inicio)u.filtro.inicio&&u.filtro.fin?(u.paginator.filter.inicio=new Date(u.convertirFecha(u.filtro.inicio)),u.paginator.filter.fin=new Date(u.convertirFecha(u.filtro.fin))):(u.paginator.filter.inicio=0,u.paginator.filter.fin=0);else{var e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),o=new Date(e.getFullYear(),e.getMonth()+1,0);u.paginator.filter.inicio=t,u.paginator.filter.fin=o,u.filtro.inicio=u.fechaATexto(t),u.filtro.fin=u.fechaATexto(o)}f.start(),c(u.paginator).then(function(e){u.paginator.setPages(e.paginas),u.despachos=e.detallesDespacho,u.totalesDespachos={producto:0,servicio_transporte:0,total:0},u.despachos.forEach(function(e,t,o){u.totalesDespachos.producto+=e.precio_unitario*e.cantidad_despacho,u.totalesDespachos.servicio_transporte+=e.servicio_transporte,t===o.length-1&&(u.totalesDespachos.total=u.totalesDespachos.producto+u.totalesDespachos.servicio_transporte)}),f.stop()})},u.imprimirPdfDespachos=function(){l(u.despachos,u.paginator.filter,u.usuario)},u.imprimirExelDespachos=function(){d(u.despachos,u.paginator.filter,u.usuario)},u.imprimir=function(p){f.start();var x=0;s(p).then(function(e){if(0<e.detallesDespacho.length)e.detallesDespacho.forEach(function(e,t,o){if(x+=e.cantidad_despacho,t==o.length-1){var a=new PDFDocument({compress:!1,size:[612,792],margin:10}),r=a.pipe(blobStream()),i=(new Date,80);a.font("Helvetica",8);var c=195,n=0;u.dibujarCabeceraPDFImpresion(a,p,0),a.font("Helvetica",8),a.text(1,55,c),a.text(p.producto.codigo,100,c),a.text(p.producto.nombre.toUpperCase(),180,c),a.text(p.cantidad,380,c),a.text(p.precio_unitario,450,c),a.text(p.importe,520,c),a.rect(40,c+10,540,0).stroke(),a.rect(40,c-10,0,40).stroke(),a.rect(580,c-10,0,60).stroke(),a.rect(80,c-35,0,65).stroke(),a.rect(160,c-35,0,85).stroke(),a.rect(425,c-35,0,65).stroke(),a.rect(370,c-35,0,125).stroke(),a.rect(425,c+50,0,40).stroke(),a.rect(495,c+50,0,20).stroke(),a.rect(580,c+50,0,20).stroke(),a.rect(495,c-35,0,85).stroke(),a.rect(160,c+50,420,0).stroke(),a.rect(370,c+70,55,0).stroke(),a.rect(495,c+70,85,0).stroke(),a.rect(370,c+90,55,0).stroke(),c+=20,a.text(p.producto.codigo,100,c),37<(l=p.producto.nombre.toUpperCase()+" (DESPACHADO)").length&&(n=-6),a.text(l,180,c+n,{width:180}),a.text(p.cantidad_despacho,380,c),a.text("SERVICIO DE TRANSPORTE",180,c+20),a.text(p.servicio_transporte,520,c+20),a.text(p.importe+p.servicio_transporte,520,c+40),a.rect(40,c+10,540,0).stroke(),a.font("Helvetica-Bold",8),a.text("Total",i+250,c+40),a.text("Saldo",i+250,c+60),a.rect(60,c+105,90,0,{align:"left"}).stroke(),a.text("DESPACHO",60,c+110,{align:"left"}),a.text(u.usuario.persona.nombre_completo,60,c+120,{align:"left"});var s=(new Date).getHours();d=(d=(new Date).getMinutes())<10?d="0"+d:d,s=s<10?s="0"+s:s,a.text("HORA DESP.: "+s+":"+d,60,c+130,{align:"left"}),a.rect(255,c+105,90,0,{align:"center"}).stroke(),a.text("FIRMA CONDUCTOR",-10,c+110,{align:"center"}),a.text("NOMBRE: ",-50,c+120,{align:"center"}),a.rect(440,c+105,90,0,{align:"right"}).stroke(),a.text("FIRMA CLIENTE",350,c+110,{align:"center"}),a.text("NOMBRE: ",330,c+120,{align:"center"}),a.text("HORA RECEP.: ",350,c+130,{align:"center"}),a.font("Helvetica",8),a.text(x+p.cantidad_despacho,i+300,c+40),a.text(p.cantidad-(x+p.cantidad_despacho),i+300,c+60);i=80;a.font("Helvetica",8);c=600;u.dibujarCabeceraPDFImpresion(a,p,405),a.font("Helvetica",8),a.text(1,55,c),a.text(p.producto.codigo,100,c),a.text(p.producto.nombre.toUpperCase(),180,c),a.text(p.cantidad,380,c),a.text(p.precio_unitario,450,c),a.text(p.importe,520,c),a.rect(40,c+10,540,0).stroke(),a.rect(40,c-10,0,40).stroke(),a.rect(580,c-10,0,60).stroke(),a.rect(80,c-35,0,65).stroke(),a.rect(160,c-35,0,85).stroke(),a.rect(425,c-35,0,65).stroke(),a.rect(370,c-35,0,65).stroke(),a.rect(425,c+50,0,40).stroke(),a.rect(370,c+50,0,40).stroke(),a.rect(495,c+50,0,20).stroke(),a.rect(580,c+50,0,20).stroke(),a.rect(495,c+70,85,0).stroke(),a.rect(495,c-35,0,85).stroke(),a.rect(160,c+50,420,0).stroke(),a.rect(370,c+70,55,0).stroke(),a.rect(370,c+90,55,0).stroke(),c+=20;var l;n=0;a.text(p.producto.codigo,100,c),37<(l=p.producto.nombre.toUpperCase()+" (DESPACHADO)").length&&(n=-6),a.text(l,180,c+n,{width:180}),a.text(p.cantidad_despacho,380,c),a.text("SERVICIO DE TRANSPORTE",180,c+20),a.text(p.servicio_transporte,520,c+20),a.text(p.importe+p.servicio_transporte,520,c+40),a.rect(40,c+10,540,0).stroke(),a.font("Helvetica-Bold",8),a.text("Total",i+250,c+40),a.text("Saldo",i+250,c+60),a.rect(60,c+105,90,0,{align:"left"}).stroke(),a.text("DESPACHO",60,c+110,{align:"left"}),a.text(u.usuario.persona.nombre_completo,60,c+120,{align:"left"});var d;s=(new Date).getHours();d=(d=(new Date).getMinutes())<10?d="0"+d:d,s=s<10?s="0"+s:s,a.text("HORA DESP.: "+s+":"+d,60,c+130,{align:"left"}),a.rect(255,c+105,90,0,{align:"center"}).stroke(),a.text("FIRMA CONDUCTOR",-10,c+110,{align:"center"}),a.text("NOMBRE: ",-50,c+120,{align:"center"}),a.rect(440,c+105,90,0,{align:"right"}).stroke(),a.text("FIRMA CLIENTE",350,c+110,{align:"center"}),a.text("NOMBRE: ",330,c+120,{align:"center"}),a.text("HORA RECEP.: ",350,c+130,{align:"center"}),a.font("Helvetica",8),a.text(x+p.cantidad_despacho,i+300,c+40),a.text(p.cantidad-(x+p.cantidad_despacho),i+300,c+60),a.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()}});else{x=p.cantidad_despacho;var t=new PDFDocument({compress:!1,size:[612,792],margin:10}),o=t.pipe(blobStream()),a=(new Date,80);t.font("Helvetica",8);var r=195;u.dibujarCabeceraPDFImpresion(t,p,0),t.font("Helvetica",8),t.text(1,55,r),t.text(p.producto.codigo,100,r),t.text(p.producto.nombre.toUpperCase(),180,r,{width:180}),t.text(p.cantidad,380,r),t.text(p.precio_unitario,450,r),t.text(p.importe,520,r),t.rect(40,r+10,540,0).stroke(),t.rect(40,r-10,0,40).stroke(),t.rect(580,r-10,0,60).stroke(),t.rect(80,r-35,0,65).stroke(),t.rect(160,r-35,0,85).stroke(),t.rect(425,r-35,0,65).stroke(),t.rect(370,r-35,0,65).stroke(),t.rect(425,r+50,0,40).stroke(),t.rect(370,r+50,0,40).stroke(),t.rect(495,r+50,0,20).stroke(),t.rect(580,r+50,0,20).stroke(),t.rect(495,r+70,85,0).stroke(),t.rect(495,r-35,0,85).stroke(),t.rect(160,r+50,420,0).stroke(),t.rect(370,r+70,55,0).stroke(),t.rect(370,r+90,55,0).stroke(),r+=20;var i=0;t.text(p.producto.codigo,100,r),37<(n=p.producto.nombre.toUpperCase()+" (DESPACHADO)").length&&(i=-6),t.text(n,180,r+i,{width:180}),t.text(p.cantidad_despacho,380,r),t.text("SERVICIO DE TRANSPORTE",180,r+20),t.text(p.servicio_transporte,520,r+20),t.text(p.importe+p.servicio_transporte,520,r+40),t.rect(40,r+10,540,0).stroke(),t.font("Helvetica-Bold",8),t.text("Total",a+250,r+40),t.text("Saldo",a+250,r+60),t.rect(60,r+105,90,0,{align:"left"}).stroke(),t.text("DESPACHO",60,r+110,{align:"left"}),t.text(u.usuario.persona.nombre_completo,60,r+120,{align:"left"});var c=new Date(p.fecha).getHours();s=(s=new Date(p.fecha).getMinutes())<10?s="0"+s:s,c=c<10?c="0"+c:c,t.text("HORA DESP.: "+c+":"+s,60,r+130,{align:"left"}),t.rect(255,r+105,90,0,{align:"center"}).stroke(),t.text("FIRMA CONDUCTOR",-10,r+110,{align:"center"}),t.text("NOMBRE: ",-50,r+120,{align:"center"}),t.rect(440,r+105,90,0,{align:"right"}).stroke(),t.text("FIRMA CLIENTE",350,r+110,{align:"center"}),t.text("NOMBRE: ",330,r+120,{align:"center"}),t.text("HORA RECEP.: ",350,r+130,{align:"center"}),t.font("Helvetica",8),t.text(x,a+300,r+40),t.text(p.cantidad-x,a+300,r+60);a=80;t.font("Helvetica",8);var n;r=600;u.dibujarCabeceraPDFImpresion(t,p,405),t.font("Helvetica",8),t.text(1,55,r),t.text(p.producto.codigo,100,r),t.text(p.producto.nombre.toUpperCase(),180,r),t.text(p.cantidad,380,r),t.text(p.precio_unitario,450,r),t.text(p.importe,520,r),t.rect(40,r+10,540,0).stroke(),t.rect(40,r-10,0,40).stroke(),t.rect(580,r-10,0,60).stroke(),t.rect(80,r-35,0,65).stroke(),t.rect(160,r-35,0,85).stroke(),t.rect(425,r-35,0,65).stroke(),t.rect(370,r-35,0,65).stroke(),t.rect(425,r+50,0,40).stroke(),t.rect(370,r+50,0,40).stroke(),t.rect(495,r+50,0,20).stroke(),t.rect(580,r+50,0,20).stroke(),t.rect(495,r-35,0,85).stroke(),t.rect(160,r+50,420,0).stroke(),t.rect(370,r+70,55,0).stroke(),t.rect(370,r+90,55,0).stroke(),t.rect(495,r+70,85,0).stroke(),r+=20,t.text(p.producto.codigo,100,r),37<(n=p.producto.nombre.toUpperCase()+" (DESPACHADO)").length&&(i=-6),t.text(n,180,r+i,{width:180}),t.text(p.cantidad_despacho,380,r),t.text("SERVICIO DE TRANSPORTE",180,r+20),t.text(p.servicio_transporte,520,r+20),t.text(p.importe+p.servicio_transporte,520,r+40),t.rect(40,r+10,540,0).stroke(),t.font("Helvetica-Bold",8),t.text("Total",a+250,r+40),t.text("Saldo",a+250,r+60),t.rect(60,r+105,90,0,{align:"left"}).stroke(),t.text("DESPACHO",60,r+110,{align:"left"}),t.text(u.usuario.persona.nombre_completo,60,r+120,{align:"left"});var s;c=new Date(p.fecha).getHours();s=(s=new Date(p.fecha).getMinutes())<10?s="0"+s:s,c=c<10?c="0"+c:c,t.text("HORA DESP.: "+c+":"+s,60,r+130,{align:"left"}),t.rect(255,r+105,90,0,{align:"center"}).stroke(),t.text("FIRMA CONDUCTOR",-10,r+110,{align:"center"}),t.text("NOMBRE: ",-50,r+120,{align:"center"}),t.rect(440,r+105,90,0,{align:"right"}).stroke(),t.text("FIRMA CLIENTE",350,r+110,{align:"center"}),t.text("NOMBRE: ",330,r+120,{align:"center"}),t.text("HORA RECEP.: ",350,r+130,{align:"center"}),t.font("Helvetica",8),t.text(x,a+300,r+40),t.text(p.cantidad-x,a+300,r+60),t.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()}})},u.dibujarCabeceraPDFImpresion=function(e,t,o){var a=o+80,r=new Date;r=u.fechaATexto(r);e.rect(40,o+80+80,540,25).fillAndStroke("silver","#000"),e.font("Helvetica-Bold",12).fill("black"),e.text("DESPACHO DE PRODUCTOS",0,o+25,{align:"center"}),e.font("Helvetica-Bold",8),e.font("Helvetica",8),e.font("Helvetica-Bold",8),e.text("FECHA: ",505,o+60,{width:40}),e.text("Cliente: ",465,o+80),e.text("Cod. SAP: ",465,o+90),e.font("Helvetica",8),e.text(u.fechaATexto(t.fecha),540,o+60,{width:45}),e.text(t.despacho.cliente.codigo,510,o+80);var i="";e.text(t.despacho.cliente.razon_social,80,o+90);var c=o+90;e.font("Helvetica-Bold",8),e.text("Cod. Vend: ",465,c+10),e.font("Helvetica",8),e.text(t.despacho.cliente.texto2,510,c+10),e.font("Helvetica-Bold",14),e.text("N°",380,o+25,{align:"center"}),e.text(t.numero_correlativo,510,o+25),e.rect(40,o+80+80,540,25).stroke().fill("silver"),e.rect(0,0,0,0).stroke().fill("black"),e.font("Helvetica-Bold",8),e.text("Nº",55,90+a),e.text("Código",100,90+a),e.text("Detalle",180,90+a),e.text("Cantidad",380,90+a),e.text("Precio",450,90+a),e.text("Importe",520,90+a),e.text("Clientes:",40,o+90),e.text("Destino Mercaderia:",40,o+100);var n=t.despacho.destino.destino,s=0;61<n.length&&(s=10),e.text("Nombre Fact:",40,o+110+s),e.font("Helvetica",8),null!==t.despacho.cliente_razon&&void 0!==t.despacho.cliente_razon&&(i=t.despacho.cliente_razon.codigo_sap,e.text(t.despacho.cliente_razon.razon_social,100,o+110+s)),e.text(i,510,o+90,{width:80}),e.font("Helvetica-Bold",8),e.text("CI/NIT:",40,o+120+s),e.text("Teléfono:",200,o+120+s),e.text("Dirección:",40,o+130+s),e.text("observaciones:",40,o+140+s),e.font("Helvetica",8),e.text(t.despacho.cliente_razon.nit,80,o+120+s),t.despacho.cliente.telefono1&&e.text(t.despacho.cliente.telefono1,240,o+120+s),e.text(t.despacho.destino.direccion,80,o+130+s),t.despacho.observacion&&e.text(t.despacho.observacion,100,o+140+s),null!==t.despacho.destino&&void 0!==t.despacho.destino?e.text(n,120,o+100,{width:320}):e.text(" ",120,o+100)},u.abrirModalAsignacionFactura=function(e){u.abrirPopup(u.idModalAsignacionFactura),u.detalle_despacho=e,u.detalle_despacho.fecha_factura&&(u.detalle_despacho.fecha_factura=u.fechaATexto(u.detalle_despacho.fecha_factura))},u.imprimirFactura=function(p){f.start();var x=0;s(p).then(function(e){if(0<e.detallesDespacho.length)e.detallesDespacho.forEach(function(e,t,o){if(x+=e.cantidad_despacho,t==o.length-1){var a=new PDFDocument({compress:!1,size:[612,792],margin:10}),r=a.pipe(blobStream()),i=(new Date,80);a.font("Helvetica",8);var c=195,n=0;u.dibujarCabeceraPDFImpresion2(a,p,0),a.font("Helvetica",8),a.text(1,55,c),a.text(p.producto.codigo,100,c),a.text(p.producto.nombre.toUpperCase(),180,c),a.text(p.cantidad,500,c),a.rect(40,c+10,540,0).stroke(),a.rect(40,c-10,0,40).stroke(),a.rect(580,c-10,0,60).stroke(),a.rect(80,c-35,0,65).stroke(),a.rect(160,c-35,0,85).stroke(),a.rect(425,c-35,0,65).stroke(),a.rect(580,c-35,0,125).stroke(),a.rect(425,c+50,0,40).stroke(),a.rect(160,c+50,420,0).stroke(),a.rect(425,c+70,153,0).stroke(),a.rect(425,c+90,153,0).stroke(),c+=20,a.text(p.producto.codigo,100,c),37<(l=p.producto.nombre.toUpperCase()+" (DESPACHADO)").length&&(n=-6),a.text(l,180,c+n,{width:180}),a.text(p.cantidad_despacho,500,c),a.rect(40,c+10,540,0).stroke(),a.font("Helvetica-Bold",8),a.text("Total",i+250,c+40),a.text("Saldo",i+250,c+60),a.rect(60,c+105,90,0,{align:"left"}).stroke(),a.text("DESPACHO",60,c+110,{align:"left"}),a.text(u.usuario.persona.nombre_completo,60,c+120,{align:"left"});var s=(new Date).getHours();d=(d=(new Date).getMinutes())<10?d="0"+d:d,s=s<10?s="0"+s:s,a.text("HORA DESP.: "+s+":"+d,60,c+130,{align:"left"}),a.rect(255,c+105,90,0,{align:"center"}).stroke(),a.text("FIRMA CONDUCTOR",-10,c+110,{align:"center"}),a.text("NOMBRE: ",-50,c+120,{align:"center"}),a.rect(440,c+105,90,0,{align:"right"}).stroke(),a.text("FIRMA CLIENTE",350,c+110,{align:"center"}),a.text("NOMBRE: ",330,c+120,{align:"center"}),a.text("HORA RECEP.: ",350,c+130,{align:"center"}),a.font("Helvetica",8),a.text(x+p.cantidad_despacho,i+420,c+40),a.text(p.cantidad-(x+p.cantidad_despacho),i+420,c+60);i=80;a.font("Helvetica",8);c=600;u.dibujarCabeceraPDFImpresion2(a,p,405),a.font("Helvetica",8),a.text(1,55,c),a.text(p.producto.codigo,100,c),a.text(p.producto.nombre.toUpperCase(),180,c),a.text(p.cantidad,500,c),a.rect(40,c+10,540,0).stroke(),a.rect(40,c-10,0,40).stroke(),a.rect(580,c-10,0,60).stroke(),a.rect(80,c-35,0,65).stroke(),a.rect(160,c-35,0,85).stroke(),a.rect(425,c-35,0,65).stroke(),a.rect(425,c+50,0,40).stroke(),a.rect(580,c+50,0,40).stroke(),a.rect(160,c+50,420,0).stroke(),a.rect(425,c+70,153,0).stroke(),a.rect(425,c+90,153,0).stroke(),c+=20;var l;n=0;a.text(p.producto.codigo,100,c),37<(l=p.producto.nombre.toUpperCase()+" (DESPACHADO)").length&&(n=-6),a.text(l,180,c+n,{width:180}),a.text(p.cantidad_despacho,500,c),a.rect(40,c+10,540,0).stroke(),a.font("Helvetica-Bold",8),a.text("Total",i+250,c+40),a.text("Saldo",i+250,c+60),a.rect(60,c+105,90,0,{align:"left"}).stroke(),a.text("DESPACHO",60,c+110,{align:"left"}),a.text(u.usuario.persona.nombre_completo,60,c+120,{align:"left"});var d;s=(new Date).getHours();d=(d=(new Date).getMinutes())<10?d="0"+d:d,s=s<10?s="0"+s:s,a.text("HORA DESP.: "+s+":"+d,60,c+130,{align:"left"}),a.rect(255,c+105,90,0,{align:"center"}).stroke(),a.text("FIRMA CONDUCTOR",-10,c+110,{align:"center"}),a.text("NOMBRE: ",-50,c+120,{align:"center"}),a.rect(440,c+105,90,0,{align:"right"}).stroke(),a.text("FIRMA CLIENTE",350,c+110,{align:"center"}),a.text("NOMBRE: ",330,c+120,{align:"center"}),a.text("HORA RECEP.: ",350,c+130,{align:"center"}),a.font("Helvetica",8),a.text(x+p.cantidad_despacho,i+420,c+40),a.text(p.cantidad-(x+p.cantidad_despacho),i+420,c+60),a.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()}});else{x=p.cantidad_despacho;var t=new PDFDocument({compress:!1,size:[612,792],margin:10}),o=t.pipe(blobStream()),a=(new Date,80);t.font("Helvetica",8);var r=195;u.dibujarCabeceraPDFImpresion2(t,p,0),t.font("Helvetica",8),t.text(1,55,r),t.text(p.producto.codigo,100,r),t.text(p.producto.nombre.toUpperCase(),180,r,{width:180}),t.text(p.cantidad,500,r),t.rect(40,r+10,540,0).stroke(),t.rect(40,r-10,0,40).stroke(),t.rect(580,r-10,0,60).stroke(),t.rect(80,r-35,0,65).stroke(),t.rect(160,r-35,0,85).stroke(),t.rect(425,r-35,0,65).stroke(),t.rect(425,r+50,0,40).stroke(),t.rect(580,r+50,0,40).stroke(),t.rect(160,r+50,420,0).stroke(),t.rect(425,r+70,153,0).stroke(),t.rect(425,r+90,153,0).stroke(),r+=20;var i=0;t.text(p.producto.codigo,100,r),37<(n=p.producto.nombre.toUpperCase()+" (DESPACHADO)").length&&(i=-6),t.text(n,180,r+i,{width:180}),t.text(p.cantidad_despacho,500,r),t.rect(40,r+10,540,0).stroke(),t.font("Helvetica-Bold",8),t.text("Total",a+250,r+40),t.text("Saldo",a+250,r+60),t.rect(60,r+105,90,0,{align:"left"}).stroke(),t.text("DESPACHO",60,r+110,{align:"left"}),t.text(u.usuario.persona.nombre_completo,60,r+120,{align:"left"});var c=new Date(p.fecha).getHours();s=(s=new Date(p.fecha).getMinutes())<10?s="0"+s:s,c=c<10?c="0"+c:c,t.text("HORA DESP.: "+c+":"+s,60,r+130,{align:"left"}),t.rect(255,r+105,90,0,{align:"center"}).stroke(),t.text("FIRMA CONDUCTOR",-10,r+110,{align:"center"}),t.text("NOMBRE: ",-50,r+120,{align:"center"}),t.rect(440,r+105,90,0,{align:"right"}).stroke(),t.text("FIRMA CLIENTE",350,r+110,{align:"center"}),t.text("NOMBRE: ",330,r+120,{align:"center"}),t.text("HORA RECEP.: ",350,r+130,{align:"center"}),t.font("Helvetica",8),t.text(x,a+420,r+40),t.text(p.cantidad-x,a+420,r+60);a=80;t.font("Helvetica",8);var n;r=600;u.dibujarCabeceraPDFImpresion2(t,p,405),t.font("Helvetica",8),t.text(1,55,r),t.text(p.producto.codigo,100,r),t.text(p.producto.nombre.toUpperCase(),180,r),t.text(p.cantidad,500,r),t.rect(40,r+10,540,0).stroke(),t.rect(40,r-10,0,40).stroke(),t.rect(580,r-10,0,60).stroke(),t.rect(80,r-35,0,65).stroke(),t.rect(160,r-35,0,85).stroke(),t.rect(425,r-35,0,65).stroke(),t.rect(425,r+50,0,40).stroke(),t.rect(580,r+50,0,40).stroke(),t.rect(160,r+50,420,0).stroke(),t.rect(425,r+70,153,0).stroke(),t.rect(425,r+90,153,0).stroke(),r+=20,t.text(p.producto.codigo,100,r),37<(n=p.producto.nombre.toUpperCase()+" (DESPACHADO)").length&&(i=-6),t.text(n,180,r+i,{width:180}),t.text(p.cantidad_despacho,500,r),t.rect(40,r+10,540,0).stroke(),t.font("Helvetica-Bold",8),t.text("Total",a+250,r+40),t.text("Saldo",a+250,r+60),t.rect(60,r+105,90,0,{align:"left"}).stroke(),t.text("DESPACHO",60,r+110,{align:"left"}),t.text(u.usuario.persona.nombre_completo,60,r+120,{align:"left"});var s;c=new Date(p.fecha).getHours();s=(s=new Date(p.fecha).getMinutes())<10?s="0"+s:s,c=c<10?c="0"+c:c,t.text("HORA DESP.: "+c+":"+s,60,r+130,{align:"left"}),t.rect(255,r+105,90,0,{align:"center"}).stroke(),t.text("FIRMA CONDUCTOR",-10,r+110,{align:"center"}),t.text("NOMBRE: ",-50,r+120,{align:"center"}),t.rect(440,r+105,90,0,{align:"right"}).stroke(),t.text("FIRMA CLIENTE",350,r+110,{align:"center"}),t.text("NOMBRE: ",330,r+120,{align:"center"}),t.text("HORA RECEP.: ",350,r+130,{align:"center"}),t.font("Helvetica",8),t.text(x,a+420,r+40),t.text(p.cantidad-x,a+420,r+60),t.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()}})},u.dibujarCabeceraPDFImpresion2=function(e,t,o){var a=o+80,r=new Date;r=u.fechaATexto(r);e.rect(40,o+80+80,540,25).fillAndStroke("silver","#000"),e.font("Helvetica-Bold",12).fill("black"),e.text("DESPACHO DE PRODUCTOS",0,o+25,{align:"center"}),e.font("Helvetica-Bold",8),e.font("Helvetica",8),e.font("Helvetica-Bold",8),e.text("FECHA: ",505,o+60,{width:40}),e.text("Cliente: ",465,o+80),e.text("Cod. SAP: ",465,o+90),e.font("Helvetica",8),e.text(u.fechaATexto(t.fecha),540,o+60,{width:45}),e.text(t.despacho.cliente.codigo,510,o+80);var i="";e.text(t.despacho.cliente.razon_social,80,o+90);var c=o+90;e.font("Helvetica-Bold",8),e.text("Cod. Vend: ",465,c+10),e.font("Helvetica",8),e.text(t.despacho.cliente.texto2,510,c+10),e.font("Helvetica-Bold",14),e.text("N°",380,o+25,{align:"center"}),e.text(t.numero_correlativo,510,o+25),e.rect(40,o+80+80,540,25).stroke().fill("silver"),e.rect(0,0,0,0).stroke().fill("black"),e.font("Helvetica-Bold",8),e.text("Nº",55,90+a),e.text("Código",100,90+a),e.text("Detalle",180,90+a),e.text("Cantidad",480,90+a),e.text("Clientes:",40,o+90),e.text("Destino Mercaderia:",40,o+100);var n=t.despacho.destino.destino,s=0;61<n.length&&(s=10),e.text("Nombre Fact:",40,o+110+s),e.font("Helvetica",8),null!==t.despacho.cliente_razon&&void 0!==t.despacho.cliente_razon&&(i=t.despacho.cliente_razon.codigo_sap,e.text(t.despacho.cliente_razon.razon_social,100,o+110+s)),e.text(i,510,o+90,{width:80}),e.font("Helvetica-Bold",8),e.text("CI/NIT:",40,o+120+s),e.text("Teléfono:",200,o+120+s),e.text("Dirección:",40,o+130+s),e.text("observaciones:",40,o+140+s),e.font("Helvetica",8),e.text(t.despacho.cliente_razon.nit,80,o+120+s),t.despacho.cliente.telefono1&&e.text(t.despacho.cliente.telefono1,240,o+120+s),e.text(t.despacho.destino.direccion,80,o+130+s),t.despacho.observacion&&e.text(t.despacho.observacion,100,o+140+s),null!==t.despacho.destino&&void 0!==t.despacho.destino?e.text(n,120,o+100,{width:320}):e.text(" ",120,o+100)},u.cerrarAsignacionFactura=function(){u.cerrarPopup(u.idModalAsignacionFactura)},u.abrirModalVentaKardexFactura=function(){u.filtroVentaKardex={pendiente:!0},u.obtenerVentaKardexFactura({pendiente:!0}),u.abrirPopup(u.idModalVentaKardexFactura)},u.cerrarVentaKardexFactura=function(){u.cerrarPopup(u.idModalVentaKardexFactura)},u.abrirModalAsignacionFacturaKardex=function(e){u.detalle_kardex=e,u.abrirPopup(u.idModalAsignacionFacturaKardex)},u.cerrarAsignacionFacturaKardex=function(){u.cerrarPopup(u.idModalAsignacionFacturaKardex)},u.abrirModalDetalleKardex=function(e){u.kardex=e,u.abrirPopup(u.idModalDetalleKardex)},u.cerrarDetalleKardex=function(){u.cerrarPopup(u.idModalDetalleKardex)},u.establecerFactura=function(e){e.fecha_factura=e.fecha_factura?new Date(u.convertirFecha(e.fecha_factura)):null,n.update({id_detalle_despacho:e.id},e,function(e){u.cerrarAsignacionFactura(),u.mostrarMensaje(e.mensaje)})},u.establecerFacturaKardex=function(e){x.update({id_detalle_kardex:e.id},e,function(e){u.obtenerVentaKardexFactura(u.filtroVentaKardex),u.cerrarAsignacionFacturaKardex(),u.mostrarMensaje(e.mensaje)})},u.removerDetalleDespacho=function(e){(e=new n(e)).$delete(function(e){u.obtenerDespachados(),u.mostrarMensaje(e.mensaje)})},u.obtenerVentaKardexFactura=function(e){e.inicio?(e.inicio=new Date(u.convertirFecha(e.inicio)),e.fin=new Date(u.convertirFecha(e.fin))):(e.inicio=0,e.fin=0),p(u.usuario.id_empresa,e).then(function(e){u.filtroVentaKardex.inicio instanceof Date&&(u.filtroVentaKardex.inicio=u.fechaATexto(u.filtroVentaKardex.inicio),u.filtroVentaKardex.fin=u.fechaATexto(u.filtroVentaKardex.fin)),u.detalleKardexFactura=e})},u.CalcularMontoEnDolar=function(e){e.resivo.tipo_moneda?e.resivo.monto=e.resivo.monto_dolar:(e.resivo.maxmonto_dolar=e.saldo_pago_ac/e.resivo.cambio_moneda,e.resivo.monto=e.resivo.monto_dolar*e.resivo.cambio_moneda)},u.montoDolar=function(e){e.resivo.monto_dolar=e.resivo.monto},u.abrirModalCobros=function(e){u.detalle_despacho=e;var t=u.detalle_despacho.factura?u.detalle_despacho.factura:"";u.detalle_despacho.resivo={sucursal:u.sucursales[0],tipo_moneda:!0,monto_dolar:0,cambio_moneda:6.9,fecha:u.fechaATexto(new Date),tipoPago:u.tiposPagosResivo[0],eliminado:!1,concepto:"Pago total de "+u.detalle_despacho.cantidad_despacho+" "+u.detalle_despacho.producto.unidad_medida+" de "+u.detalle_despacho.producto.nombre+" y servicio de distribución s/g factura nro. "+t},u.abrirPopup(u.IdModalCobros)},u.cerrarModalCobros=function(){u.detalle_despacho.resivo.edit&&u.obtenerDespachados(),u.cerrarPopup(u.IdModalCobros)},u.abrirModalHistorialCobros=function(){u.detalle_despacho.recivos=u.detalle_despacho.recivos.sort(function(e,t){return e.id-t.id}),u.abrirPopup(u.IdModalHistorialCobros)},u.cerrarModalHistorialCobros=function(){u.cerrarPopup(u.IdModalHistorialCobros)},u.abrirModalVerificarCuenta=function(e,t){u.dato=e,u.tipoDatosPermiso=t,u.cuenta={},u.abrirPopup(u.IdModalVerificarCuenta)},u.cerrarModalVerificarCuenta=function(){u.cerrarPopup(u.IdModalVerificarCuenta)},u.verificarCuentaAdmin=function(e){g.save({id_empresa:u.usuario.id_empresa},e,function(e){e.type?(u.mostrarMensaje(e.message),"despacho"==u.tipoDatosPermiso&&u.abrirModalAsignacionFactura(u.dato),"despachoKardex"==u.tipoDatosPermiso&&u.abrirModalAsignacionFacturaKardex(u.dato),"EditarDespachoResivo"==u.tipoDatosPermiso&&(u.detalle_despacho.resivo=u.dato,u.detalle_despacho.resivo.edit=!0,u.detalle_despacho.saldo_pago_ac=u.detalle_despacho.saldo_pago_ac+u.detalle_despacho.resivo.monto,u.detalle_despacho.pago_ac=u.detalle_despacho.pago_ac-u.detalle_despacho.resivo.monto,u.tiposPagosResivo.forEach(function(e,t,o){u.dato.tipoPago.id==e.id&&(u.detalle_despacho.resivo.tipoPago=e)}),u.detalle_despacho.resivo.fecha=u.fechaATexto(u.detalle_despacho.resivo.fecha),u.cerrarModalHistorialCobros()),"EliminarDespachoResivo"==u.tipoDatosPermiso&&(u.dato.eliminado=!0,u.dato.pago_ac=u.detalle_despacho.pago_ac-u.dato.monto,u.dato.saldo_pago_ac=u.detalle_despacho.total-u.dato.pago_ac,u.crearDespachoResivo(u.dato),u.cerrarModalHistorialCobros()),u.cerrarModalVerificarCuenta(e)):u.mostrarMensaje(e.message)})},u.crearDespachoResivo=function(a){a.fecha=new Date(u.convertirFecha(a.fecha)),0==a.eliminado&&(a.pago_ac=u.detalle_despacho.pago_ac+a.monto,a.saldo_pago_ac=u.detalle_despacho.total-a.pago_ac),u.estadosDespacho.forEach(function(e,t,o){(u.detalle_despacho.saldo_pago_ac==a.monto?"PAGADO"==e.nombre&&(a.estado=e):"PARCIAL"==e.nombre&&(a.estado=e),t===o.length-1)&&h(u.detalle_despacho.id,a).then(function(e){u.mostrarMensaje(e.mensaje),0==e.recivo.eliminado&&u.imprimirResivo(e.recivo),u.cerrarModalCobros(),u.paginator.search?u.paginator.getSearch(u.paginator.search,u.paginator.filter,null):u.paginator.getSearch("",u.paginator.filter,null)})})},u.obtenerCuentasBancos=function(){f.start(),D(u.usuario.id_empresa).then(function(e){u.cuentasBancos=e,f.stop()})},u.obtenerOtrosBancos=function(){f.start(),v("RRHH_BAN",u.usuario.id_empresa).then(function(e){u.otrosBancos=e,f.stop()})},u.abrirDialogConceptoEdicion=function(e){u.tipo_edicion=e,u.clase={},u.abrirPopup(u.idModalConceptoEdicion)},u.cerrarDialogConceptoEdicion=function(){u.cerrarPopup(u.idModalConceptoEdicion)},u.verDatosCobros=function(){u.verDatosCobroDespachos=!u.verDatosCobroDespachos},u.imprimirResivo=function(n){convertUrlToBase64Image(u.usuario.empresa.imagen,function(e){var t=new PDFDocument({compress:!1,size:"letter",margin:10}),o=t.pipe(blobStream()),a=new Date(n.fecha);u.dibujarCabeceraPDFImpresionRecivo(t,n,e,30),n.tipo_moneda?(t.text(n.monto+" .-",485,20),t.text("----",485,45),t.text("----",485,70)):(t.text("----",485,20),t.text(n.monto+" .-",485,45),t.text(n.cambio_moneda+" .-",485,70)),t.text(u.detalle_despacho.despacho.cliente.razon_social,100,110),n.tipo_moneda?t.text("                          "+ConvertirALiteral(n.monto.toFixed(2)),40,130,{width:550,lineGap:6}):t.text("                          "+ConvertirALiteral(n.monto.toFixed(2),"DÓLARES"),40,130,{width:550,lineGap:6}),t.text("                               "+n.concepto,40,170,{width:550,lineGap:6}),t.text(u.detalle_despacho.despacho.cliente_razon.razon_social+"-"+u.detalle_despacho.despacho.cliente_razon.nit,165,210),t.text(u.detalle_despacho.factura?u.detalle_despacho.factura:"",465,210),"CHEQUE"==n.tipoPago.nombre?(t.text(n.numero_cuenta,270,230),t.text(n.otroBanco.nombre,470,230)):"DEPOSITO"==n.tipoPago.nombre?t.text(n.banco.nombre,470,230):(t.moveTo(103,240).lineTo(105,245).dash(0,{space:0}).lineTo(115,230).stroke(),t.text("----",270,230),t.text("----",475,230));var r=n.sucursal.departamento.nombre_corto.split("-")[0];t.text(10<=a.getDate()?r+"  "+a.getDate():r+"  0"+a.getDate(),160,260),t.text(10<=a.getMonth()+1?a.getMonth()+1:"0"+(a.getMonth()+1),310,260),c=(c=a.getFullYear()).toString().substr(-2),t.text(c,440,260);var i=new Date;t.font("Helvetica",5),t.text("EMISIÓN: "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),200,375),t.text("IMPRESIÓN: "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),260,375),t.text("USUARIO: "+u.usuario.persona.nombre_completo,40,375),t.font("Helvetica",8),t.rect(3,400,600,0).dash(1,{space:5}).stroke(),u.dibujarCabeceraPDFImpresionRecivo(t,n,e,430),n.tipo_moneda?(t.text(n.monto+" .-",485,420),t.text("----",485,445),t.text("----",485,470)):(t.text("----",485,420),t.text(n.monto+" .-",485,445),t.text(n.cambio_moneda+" .-",485,470)),t.text(u.detalle_despacho.despacho.cliente.razon_social,100,510),n.tipo_moneda?t.text("                          "+ConvertirALiteral(n.monto.toFixed(2)),40,530,{width:550,lineGap:6}):t.text("                          "+ConvertirALiteral(n.monto.toFixed(2),"DÓLARES"),40,530,{width:550,lineGap:6}),t.text("-                               "+n.concepto,40,570,{width:550,lineGap:6}),t.text(u.detalle_despacho.despacho.cliente_razon.razon_social+"-"+u.detalle_despacho.despacho.cliente_razon.nit,165,610),t.text(u.detalle_despacho.factura?u.detalle_despacho.factura:"",465,610),"CHEQUE"==n.tipoPago.nombre?(t.text(n.numero_cuenta,270,630),t.text(n.otroBanco.nombre,470,630)):"DEPOSITO"==n.tipoPago.nombre?t.text(n.banco.nombre,470,630):(t.moveTo(103,640).lineTo(105,645).dash(0,{space:0}).lineTo(115,630).stroke(),t.text("----",270,630),t.text("----",475,630));var c;r=n.sucursal.departamento.nombre_corto.split("-")[0];t.text(10<=a.getDate()?r+"  "+a.getDate():r+"  0"+a.getDate(),160,660),t.text(10<=a.getMonth()+1?a.getMonth()+1:"0"+(a.getMonth()+1),310,660),c=(c=a.getFullYear()).toString().substr(-2),t.text(c,440,660),t.font("Helvetica",5),t.text("EMISIÓN: "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),200,775),t.text("IMPRESIÓN: "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),260,775),t.text("USUARIO: "+u.usuario.persona.nombre_completo,40,775),t.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},u.dibujarCabeceraPDFImpresionRecivo=function(e,t,o,a){e.font("Helvetica-Bold",16),e.text("RECIBO DE INGRESO",0,a,{align:"center"}),e.text(t.sucursal.nombre,0,a+20,{align:"center"}),e.text("N° "+t.numero_correlativo,0,a+35,{align:"center"}),e.image(o,40,a-20,{fit:[80,80]}),e.rect(450,a-15,140,20).dash(0,{space:0}).stroke(),e.rect(450,a+10,140,20).dash(0,{space:0}).stroke(),e.rect(450,a+35,140,20).dash(0,{space:0}).stroke(),e.font("Helvetica-Bold",12),e.text("Bs.",455,a-10),e.text("$us.",455,a+15),e.text("T./C.",455,a+40),e.font("Helvetica",12),e.text("Recibí de:",40,a+80),e.rect(100,a+90,490,0).dash(1,{space:5}).stroke(),e.text("El importe de:",40,a+100),e.rect(130,a+110,460,0).stroke(),e.rect(40,a+130,550,0).stroke(),e.text("Por concepto de:",40,a+140),e.rect(140,a+150,450,0).stroke(),e.rect(40,a+170,550,0).stroke(),e.text("Factura a Nombre de:",40,a+180),e.rect(165,a+190,280,0).stroke(),e.text("N°",450,a+180),e.rect(465,a+190,120,0).stroke(),e.text("Efectivo",40,a+200),e.rect(90,a+195,30,25).dash(0,{space:0}).stroke(),"DEPOSITO"==t.tipoPago.nombre?e.text("Deposito N°",200,a+200):e.text("Cheque N°",200,a+200),e.rect(260,a+210,130,0).dash(1,{space:5}).stroke(),e.text("Banco",430,a+200),e.rect(465,a+210,120,0).stroke(),e.rect(140,a+240,100,0).stroke(),e.text("de",240,a+230),e.rect(260,a+240,135,0).stroke(),e.text("de 20",400,a+230),e.rect(440,a+240,40,0).stroke(),e.text("Recibí conforme",80,a+300),e.rect(40,a+290,180,0).stroke(),e.text("Nombre:",40,a+315),e.rect(85,a+325,120,0).stroke(),e.text("C.I:",40,a+330),e.rect(60,a+340,145,0).stroke(),e.text("Entregué conforme",440,a+300),e.rect(405,a+290,180,0).stroke(),e.text("Nombre:",405,a+315),e.rect(455,a+325,130,0).stroke(),e.text("C.I:",405,a+330),e.rect(422,a+340,162,0).stroke()},u.abrirModificarDespacho=function(e){u.gtm_detalle_despacho=e,u.abrirPopup(u.idModalAsignacionDespacho)},u.cerrarModificarDespacho=function(){u.cerrarPopup(u.idModalAsignacionDespacho)},u.actualizarDespacho=function(){_(u.gtm_detalle_despacho).then(function(e){u.obtenerDespachados(),u.mostrarMensaje(e.mensaje)})},u.$on("$routeChangeStart",function(e,t){u.eliminarPopup(u.idModalAsignacionFactura),u.eliminarPopup(u.idModalVentaKardexFactura),u.eliminarPopup(u.idModalAsignacionFacturaKardex),u.eliminarPopup(u.idModalDetalleKardex),u.eliminarPopup(u.IdModalVerificarCuenta),u.eliminarPopup(u.IdModalCobros),u.eliminarPopup(u.IdModalHistorialCobros),u.eliminarPopup(u.idModalConceptoEdicion),u.eliminarPopup(u.idModalAsignacionDespacho)}),u.inicio()}]);