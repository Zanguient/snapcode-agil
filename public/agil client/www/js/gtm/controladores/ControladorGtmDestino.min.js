angular.module("agil.controladores").controller("ControladorGtmDestino",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Paginator","FieldViewer","GtmDestino","GtmDestinos","GtmDestinoItem","GtmDestinosEmpresa","ClasesTipoEmpresa","Diccionario","Tipos","ClasesTipo","VerificarUsuarioEmpresa",function(c,o,i,e,r,l,a,t,n,s,d,u,p,m,v,f,C){l.start(),c.usuario=JSON.parse(o.usuario),c.idModalWizardDestinoEdicion="modal-wizard-destino-edicion",c.idModalContenedorWizard="modal-wizard-container-destino-edicion",c.idModalConceptoEdicionCorrelativos="dialog-conceptos-correlativos",c.IdModalVerificarCuenta="modal-verificar-cuenta",c.$on("$viewContentLoaded",function(){resaltarPesta√±a(i.path().substring(1)),ejecutarScriptDestino(c.idModalWizardDestinoEdicion,c.idModalContenedorWizard,c.idModalConceptoEdicionCorrelativos,c.IdModalVerificarCuenta),c.buscarAplicacion(c.usuario.aplicacionesUsuario,i.path().substring(1))}),c.inicio=function(){c.diccionario=m,c.obtenerDestinos()},c.obtenerDestinos=function(){s(c.usuario.id_empresa).then(function(o){c.destinos=o})},c.crearNuevoDestino=function(){c.obtenerCorrelativoDestino(),c.steps=[{cabeza:"cabeza-datos-destino",cuerpo:"cuerpo-datos-destino"}],c.destino=new n({id_empresa:c.usuario.id_empresa}),c.abrirPopup(c.idModalWizardDestinoEdicion)},c.cerrarPopPupEdicion=function(){c.cerrarPopup(c.idModalWizardDestinoEdicion)},c.modificarDestino=function(o){c.destino=o,c.abrirPopup(c.idModalWizardDestinoEdicion)},c.removerDestino=function(o){o.eliminado=!0,d.update({id_destino:o.id},o,function(o){c.obtenerDestinos(),l.stop(),c.mostrarMensaje(o.mensaje)})},c.guardarDestino=function(o){"Siguiente"!=$("#siguiente").text().trim()&&(l.start(),o.id?d.update({id_destino:o.id},o,function(o){c.obtenerDestinos(),l.stop(),c.cerrarPopPupEdicion(),c.mostrarMensaje(o.mensaje),c.recargarItemsTabla()}):o.$save(function(o){c.obtenerDestinos(),l.stop(),c.cerrarPopPupEdicion(),c.mostrarMensaje("Destino creado satisfactoriamente!"),c.recargarItemsTabla()},function(o){l.stop(),c.cerrarPopPupEdicion(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!")}))},c.$on("$routeChangeStart",function(o,i){c.eliminarPopup(c.idModalWizardDestinoEdicion),c.eliminarPopup(c.idModalConceptoEdicionCorrelativos),c.eliminarPopup(c.IdModalVerificarCuenta)}),c.subirExcelDestinos=function(o){var i,e,r=o.target.files;for(e=r[i=0];i!=r.length;++i){var a=new FileReader;e.name;a.onload=function(o){l.start();var i=o.target.result,e=XLSX.read(i,{type:"binary"}),r=e.SheetNames[0],a=2,t=e.Sheets[r],n=[];do{var s={};s.codigo=null!=t["A"+a]&&""!=t["A"+a]?t["A"+a].v.toString():null,s.cliente_codigo=null!=t["B"+a]&&""!=t["B"+a]?t["B"+a].v.toString():null,s.destino=null!=t["C"+a]&&""!=t["C"+a]?t["C"+a].v.toString():null,s.direccion=null!=t["D"+a]&&""!=t["D"+a]?t["D"+a].v.toString():null,n.push(s),a++,0}while(null!=t["A"+a]);c.guardarDestinos(n),l.stop()},a.readAsBinaryString(e)}},c.guardarDestinos=function(o){u(c.usuario.id_empresa,o).then(function(o){l.stop(),c.mostrarMensaje(o.mensaje),c.recargarItemsTabla()})},c.obtenerCorrelativoDestino=function(){l.start(),p("correlativo_destinos",c.usuario.id_empresa).then(function(o){1<o.clases.length?o.clases.sort(function(o,i){return o.correlativo=o.nombre_corto.split("-")[0],o.correlativo_maximo=o.nombre_corto.split("-")[1],i.correlativo=i.nombre_corto.split("-")[0],i.correlativo_maximo=i.nombre_corto.split("-")[1],o.correlativo-i.correlativo}):1==o.clases.length&&(o.clases[0].correlativo=o.clases[0].nombre_corto.split("-")[0],o.clases[0].correlativo_maximo=o.clases[0].nombre_corto.split("-")[1]),c.correlativosDestino=o,l.stop()})},c.cargarCodigo=function(o){o.codigo=o.correlativo.correlativo},c.abrirModalConceptoEdicionCorrelativos=function(o){l.start(),p("correlativo_destinos",c.usuario.id_empresa).then(function(o){1<o.clases.length?(o.clases.sort(function(o,i){return o.correlativo=o.nombre_corto.split("-")[0],o.correlativo_maximo=o.nombre_corto.split("-")[1],i.correlativo=i.nombre_corto.split("-")[0],i.correlativo_maximo=i.nombre_corto.split("-")[1],o.correlativo-i.correlativo}),c.minimo=parseInt(o.clases[o.clases.length-1].correlativo_maximo)+1):1==o.clases.length&&(o.clases[0].correlativo=o.clases[0].nombre_corto.split("-")[0],o.clases[0].correlativo_maximo=o.clases[0].nombre_corto.split("-")[1],c.minimo=parseInt(o.clases[0].correlativo_maximo)+1),c.tipo_edicion=o,c.clase={},c.abrirPopup(c.idModalConceptoEdicionCorrelativos),l.stop()})},c.cerrarModalConceptoEdicionCorrelativos=function(){c.cerrarPopup(c.idModalConceptoEdicionCorrelativos)},c.agregarConceptoEdicion=function(o){o.nombre_corto=o.correlativo+"-"+o.correlativo_maximo,-1==c.tipo_edicion.clases.indexOf(o)&&(c.tipo_edicion.clases.length,c.tipo_edicion.clases.push(o),c.minimo=o.correlativo_maximo+1),c.clase={}},c.modificarConceptoEdicion=function(o){o.correlativo=parseInt(o.correlativo),o.correlativo_maximo=parseInt(o.correlativo_maximo),c.clase=o},c.removerConceptoEdicion=function(o){o.eliminado=!0},c.guardarConceptoEdicion=function(i){l.start(),v.update({id_tipo:i.id},i,function(o){f(i.nombre_corto).then(function(o){i=o,l.stop(),c.cerrarModalConceptoEdicionCorrelativos(),c.mostrarMensaje("Guardado Exitosamente!")})})},c.abrirModalVerificarCuenta=function(o,i){c.dato=o,c.tipoDatosPermiso=i,c.abrirPopup(c.IdModalVerificarCuenta)},c.cerrarModalVerificarCuenta=function(){c.cerrarPopup(c.IdModalVerificarCuenta)},c.verificarCuentaAdmin=function(o){C.save({id_empresa:c.usuario.id_empresa},o,function(o){o.type?(c.mostrarMensaje(o.message),"correlativo"==c.tipoDatosPermiso&&c.modificarConceptoEdicion(c.dato),c.cerrarModalVerificarCuenta()):c.mostrarMensaje(o.message)})},c.inicio()}]);