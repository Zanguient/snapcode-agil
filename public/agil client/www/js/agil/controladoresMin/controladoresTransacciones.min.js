angular.module("agil.controladores").controller("controladorTransacciones",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ObtenerTodoPersonal","TransaccionBancoPaginador","$timeout","Paginator","ListaBancos","ClasesTipo","TransaccionIngresoBanco","FieldViewer","TransaccionEgresoBanco","TransaccionSeguimientoBanco","TransaccionSeguimientoEstado","TransaccionRevisionEstado","SaldoCuenta","SaldoDisponibleCuenta","SaldoProformas",function(c,e,o,a,n,l,i,t,r,s,u,d,m,g,f,v,p,h,b,D,_){c.modalNuevoIngreso="modal-wizard-nuevo-ingreso",c.modalNuevoEgreso="modal-wizard-nuevo-egreso",c.modalSeguimiento="modal-wizard-seguimiento",c.modalRevision="modal-wizard-revision",c.modalVencimientoCreditos="tabla-vencimiento-creditos-transaciones",c.modalVerIngreso="modal-wizard-ver-ingreso",c.modalVerEgreso="modal-wizard-ver-egreso",c.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptsTransacciones(c.modalNuevoIngreso,c.modalNuevoEgreso,c.modalSeguimiento,c.modalRevision,c.modalVencimientoCreditos,c.modalVerIngreso,c.modalVerEgreso),c.buscarAplicacion(c.usuario.aplicacionesUsuario,o.path().substring(1)),c.obtenerColumnasAplicacion()}),c.$on("$routeChangeStart",function(e,o){c.eliminarPopup(c.modalNuevoIngreso),c.eliminarPopup(c.modalNuevoEgreso),c.eliminarPopup(c.modalSeguimiento),c.eliminarPopup(c.modalRevision),c.eliminarPopup(c.modalVencimientoCreditos)}),c.inicio=function(){var e=new Date;c.filtro={empresa:c.usuario.empresa.id,desde:e.setDate(e.getDate()-7),hasta:(new Date).toLocaleDateString(),cuenta:0,nombre:0,concepto:0,ref_doc:0,tipo_doc:0,estado:0},c.filtro.desde=new Date(c.filtro.desde).toLocaleDateString(),c.obtenerCuentas(),c.obtenerConceptosTransaccion(),c.obtenerTiposDocumentos(),c.obtenerEstadosTransaccion(),r(function(){c.obtenerVencimientos()},5e3),c.fondosDisponibles=0,c.ingresosEnTransito=0,c.egresosEnTransito=0,c.saldoInicial=0,c.saldoFinal=0,c.saldoPignorado=0,c.fecha_hoy=(new Date).toLocaleDateString(),i(c.usuario.id_empresa).then(function(e){c.empleados=e.personal,c.obtenerTransacciones()}).catch(function(e){var o=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";c.mostrarMensaje(o)})},c.obtenerConceptosTransaccion=function(){l.start(),d("CONTRAN").then(function(e){c.conceptosTransaccion=e.clases,c.conceptosTransaccion.forEach(function(e){"CTRANS"===e.nombre_corto&&(c.TRAN_COBRO=e),"PTRANS"===e.nombre_corto&&(c.TRAN_PAGO=e),"SAL_INICIAL"==e.nombre_corto&&(c.SALDO_INICIAL=e)}),l.stop()})},c.obtenerVencimientos=function(){c.vencimientosCobros=[],c.verificarVencimientosCreditos(c.usuario.id_empresa),_(c.usuario.id_empresa).then(function(e){var a=[];e.hasErr?c.mostrarMensaje(e.mensaje):(e.proformas.forEach(function(e){var o={id:e.id,factura:e.factura,total:e.monto,cliente:{razon_social:e.razon_social},a_cuenta:e.a_cuenta,saldo:e.saldo,es_proforma:!0};a.push(o)}),Array.prototype.push.apply(c.vencimientosCobros,a)),Array.prototype.push.apply(c.vencimientosCobros,c.vencimientosCreditos)}).catch(function(e){}),console.log(c.vencimientosCobros)},c.obtenerTiposDocumentos=function(){l.start(),d("TDC").then(function(e){c.tiposDocumentos=e.clases,l.stop()})},c.obtenerSaldoInicial=function(){c.saldoInicial=0,b(c.usuario.id_empresa,c.cuentaSeleccionada.id,c.filtro.desde,c.filtro.hasta).then(function(e){void 0!==e.cuenta?c.saldoInicial=e.cuenta[0].saldo:c.mostrarMensaje("La cuenta Nro. "+c.cuentaSeleccionada.numero+" de "+c.cuentaSeleccionada.nombre+" no cuenta con un ingreso de apertura")}).catch(function(e){var o=void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";c.mostrarMensaje(o)})},c.showSelecccionCliente=function(e){return null==e||(void 0===e.concepto||null===e.concepto||(void 0!==e.concepto.id?e.concepto.id!==c.SALDO_INICIAL.id:e.concepto!==c.SALDO_INICIAL.id))},c.obtenerEstadosTransaccion=function(){l.start(),d("ESTRANS").then(function(e){c.estadosTransaccion=e.clases,e.clases.map(function(e){"CONFIRMADO"==e.nombre_corto&&(c.CONFIRMADO=e),"EN_TRANSITO"==e.nombre_corto&&(c.EN_TRANSITO=e)}),l.stop()})},c.seleccionarCuenta=function(o){c.cuentaSeleccionada=void 0,c.bancos.forEach(function(e){e.id===o.id&&(c.cuentaSeleccionada=e,c.filtro.cuenta=c.cuentaSeleccionada)})},c.obtenerCuentas=function(){u(c.usuario.id_empresa).then(function(e){c.bancos=e,c.cuentaSeleccionada=c.bancos[0],c.filtro.cuenta=c.cuentaSeleccionada})},c.calcularIngresosTransito=function(){c.ingresosEnTransito=0,c.transacciones.forEach(function(e){null!==e.haber&&e.id_estado===c.EN_TRANSITO.id&&(c.ingresosEnTransito+=e.haber)})},c.calcularEgresosTransito=function(){c.egresosEnTransito=0,c.transacciones.forEach(function(e){null!==e.debe&&e.id_estado===c.EN_TRANSITO.id&&(c.egresosEnTransito+=e.debe)})},c.calcularFondosDisponibles=function(){c.fondosDisponibles=0,D(c.usuario.id_empresa,c.cuentaSeleccionada.id,0,0).then(function(e){e.hasErr&&c.mostrarMensaje(e.mensaje),c.fondosDisponibles=e.saldo,c.calcularIngresosTransito(),c.calcularEgresosTransito(),c.calcularSaldoPignorado(),c.calcularSaldoFinal(),b(c.usuario.id_empresa,c.cuentaSeleccionada.id,c.filtro.desde,c.filtro.hasta).then(function(e){c.saldoInicial=e.cuenta[0].saldo})}).catch(function(e){var o=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(o),l.stop()})},c.calcularSaldoFinal=function(){c.saldoFinal=c.fondosDisponibles+c.ingresosEnTransito-c.egresosEnTransito},c.calcularSaldoPignorado=function(){c.saldoPignorado=0,c.transacciones.forEach(function(e){null!==e.debe&&e.id_estado===c.EN_TRANSITO.id&&(c.saldoPignorado-=e.debe),null!==e.haber&&e.id_estado===c.EN_TRANSITO.id&&(c.saldoPignorado+=e.haber)})},c.obtenerColumnasAplicacion=function(){l.start(),c.fieldViewer=g({crear:!0,id_empresa:c.usuario.id_empresa,configuracion:{numero:{value:"N°",show:!0},fecha:{value:"Fecha",show:!0},banco:{value:"Banco",show:!0},detalle:{value:"Detalle",show:!0},nombre:{value:"Nombre completo",show:!0},concepto:{value:"Concepto",show:!0},observaciones:{value:"Observaciones",show:!0},ref_doc:{value:"Ref./Doc.",show:!0},tipo_doc:{value:"tipo Documento",show:!0},debe:{value:"Debe",show:!0},haber:{value:"Haber",show:!0},saldo:{value:"Saldo",show:!0},estado:{value:"estado",show:!0}}},c.aplicacion.aplicacion.id),c.fieldViewer.updateObject(),l.stop()},c.obtenerSaldoCuenta=function(){var e=b(c.usuario.id_empresa,c.filtro.cuenta,new Date),o=!1;e.then(function(e){o=!0,c.saldoInicial=e.transaccion.saldo}),r(function(){o?l.stop():(l.stop(),c.mostrarMensaje("La respuesta esta tardando mas de lo normal"))},5e3)},c.filtrarTransacciones=function(e,o,a){if(void 0!==a)for(var n in e)0==e[n]&&(e[n]="");else for(var n in e)""!==e[n]&&null!==e[n]&&void 0!==e[n]||(e[n]=0);if(void 0!==o&&o)return e;c.buscarTransacciones()},c.obtenerTransacciones=function(){c.paginator=s(),c.paginator.column="fecha",c.paginator.direccion="asc",c.paginator.callBack=c.buscarTransacciones,c.paginator.getSearch("")},c.buscarTransacciones=function(){l.start(),0===c.filtro.cuenta&&(c.filtro.cuenta=c.cuentaSeleccionada),c.filtro=c.filtrarTransacciones(c.filtro,!0),c.paginator.filter=c.filtro,t(c.usuario.id_empresa,c.paginator).then(function(e){e.hasErr?c.mostrarMensaje(e.mensaje):(c.transacciones=e.transacciones,c.transacciones.forEach(function(e){c.verificarSeguimiento(e)}),c.paginator.setPages(e.paginas),c.calcularFondosDisponibles(),c.obtenerSaldoInicial(),c.obtenerVencimientos()),l.stop()}),c.filtro=c.filtrarTransacciones(c.filtro,!0,!0)},c.usuario=JSON.parse(e.usuario),c.crearNuevoIngreso=function(){c.abrirModalNuevoIngreso()},c.crearNuevoEgreso=function(){c.abrirModalNuevoEgreso()},c.seguimiento=function(e){c.transaccion=e,c.abrirModalSeguimiento()},c.guardarSeguimiento=function(o){if(l.start(),null!==o.seguimientos[0].id_entregado){if(o.seguimientos[0].id_entregado!==o.seguimientos[0].entregado_por.id)return c.mostrarMensaje("No se permiten cambios!"),void l.stop();if(null===o.seguimientos[0].id_devuelto||o.seguimientos[0].proveedor)null!==o.seguimientos[0].fecha_devolucion||o.seguimientos[0].proveedor||0===o.seguimientos[0].devuelto_a||void 0===o.seguimientos[0].devuelto_a||null===o.seguimientos[0].devuelto_a||(o.seguimientos[0].fecha_devolucion=new Date,o.seguimientos[0].id_devuelto=o.seguimientos[0].devuelto_a.id);else if(o.seguimientos[0].id_devuelto!==o.seguimientos[0].devuelto_a.id)return c.mostrarMensaje("No se permiten cambios!"),void l.stop()}else null===o.seguimientos[0].fecha_entrega&&(o.seguimientos[0].fecha_entrega=new Date,o.seguimientos[0].id_entregado=o.seguimientos[0].entregado_por.id);v(c.usuario.id_empresa,o.seguimientos[0],c.usuario.id).then(function(e){e.hasErr?c.mostrarMensaje(e.mensaje):(c.mostrarMensaje(e.mensaje),c.cerrarModalSeguimiento(),c.verificarSeguimiento(o)),l.stop()}).catch(function(e){var o=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(o),l.stop()})},c.verificarSeguimiento=function(e){0<e.seguimientos.length&&(null!==e.seguimientos[0].entregado_por||null!==e.seguimientos[0].devuelto_a||e.seguimientos[0].proveedor||(e.seguimientos[0].black=!0,e.seguimientos[0].yellow=void 0,e.seguimientos[0].green=void 0),null===e.seguimientos[0].entregado_por||null!==e.seguimientos[0].devuelto_a||e.seguimientos[0].proveedor||(e.seguimientos[0].black=void 0,e.seguimientos[0].yellow=!0,e.seguimientos[0].green=void 0),null===e.seguimientos[0].entregado_por||null===e.seguimientos[0].devuelto_a||e.seguimientos[0].proveedor||(e.seguimientos[0].black=void 0,e.seguimientos[0].yellow=void 0,e.seguimientos[0].green=!0),null===e.seguimientos[0].entregado_por&&null===e.seguimientos[0].devuelto_a&&e.seguimientos[0].proveedor&&(e.seguimientos[0].black=!0,e.seguimientos[0].yellow=void 0,e.seguimientos[0].green=void 0),null!==e.seguimientos[0].entregado_por&&null===e.seguimientos[0].devuelto_a&&e.seguimientos[0].proveedor&&(e.seguimientos[0].black=void 0,e.seguimientos[0].yellow=void 0,e.seguimientos[0].green=!0))},c.calcularSaldo=function(){},c.verificarConcepto=function(e){c.SALDO_INICIAL.id===e.concepto&&(e.venta=void 0,e.detalle="Ingreso apertura.")},c.guardarRevision=function(){l.start(),c.transaccion.cerrado=!0,h(c.usuario.id_empresa,c.usuario.id,c.transaccion.id).then(function(e){l.stop(),c.mostrarMensaje(e.mensaje),c.cerrarModalRevision()}).catch(function(e){var o=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(o),l.stop()})},c.guardarIngreso=function(a){l.start(),a.fecha=new Date(c.convertirFecha(a.fecha)),m(c.usuario.id_empresa,a,c.usuario.id).then(function(e){if(e.hasErr)a.fecha=new Date(a.fecha).toLocaleDateString(),c.mostrarMensaje(e.mensaje);else{if(c.mostrarMensaje(e.mensaje),a.venta.saldo-=a.haber,a.venta.es_proforma){if(a.concepto!==c.SALDO_INICIAL.id){var o={pago:ConvertirALiteral(a.haber.toFixed(2))};c.imprimirReciboVencimientoCreditoProforma(o,e.venta,a.haber)}}else if(a.concepto!==c.SALDO_INICIAL.id){o={pago:ConvertirALiteral(a.haber.toFixed(2))};c.imprimirReciboVencimientoCredito(o,e.venta,a.haber,!0)}c.verificarVencimientosCreditos(c.usuario.id_empresa),c.filtrarTransacciones(c.filtro),c.cerrarModalNuevoIngreso(),c.obtenerVencimientos()}l.stop()}).catch(function(e){var o=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(o),a.fecha=new Date(a.fecha).toLocaleDateString(),l.stop()})},c.guardarEgreso=function(a){l.start(),a.fecha=new Date(c.convertirFecha(a.fecha)),f(c.usuario.id_empresa,a,c.usuario.id).then(function(e){e.hasErr?(c.mostrarMensaje(e.mensaje),a.fecha=a.fecha.toLocaleDateString()):(c.mostrarMensaje(e.mensaje),c.verificarVencimientosDeudas(c.usuario.id_empresa),c.filtrarTransacciones(c.filtro),c.cerrarModalNuevoEgreso()),l.stop()}).catch(function(e){var o=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(o),a.fecha=a.fecha.toLocaleDateString(),l.stop()})},c.imprimirReciboVencimientoCreditoProforma=function(e,o,a){l.start();var n=new PDFDocument({size:[227,353],margin:10}),i=n.pipe(blobStream());n.moveDown(2),n.font("Helvetica-Bold",8),n.text(c.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),n.moveDown(.4),n.font("Helvetica",7),n.text(o.sucursal.nombre.toUpperCase(),{align:"center"}),n.moveDown(.4),n.text(o.sucursal.direccion.toUpperCase(),{align:"center"}),n.moveDown(.4);var t=(null!=o.sucursal.telefono1?o.sucursal.telefono1:"")+(null!=o.sucursal.telefono2?"-"+o.sucursal.telefono2:"")+(null!=o.sucursal.telefono3?"-"+o.sucursal.telefono3:"");n.text("TELF.: "+t,{align:"center"}),n.moveDown(.4),n.text("COCHABAMBA - BOLIVIA",{align:"center"}),n.moveDown(.5),n.font("Helvetica-Bold",8),n.text("RECIBO",{align:"center"}),n.font("Helvetica",7),n.moveDown(.4),n.text("------------------------------------",{align:"center"}),n.moveDown(.4),n.text(o.sucursal.nota_recibo_correlativo,{align:"center"}),n.moveDown(.4),n.moveDown(.4),n.text("------------------------------------",{align:"center"}),n.moveDown(.4),n.moveDown(.6);var r=new Date;n.text("FECHA : "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),{align:"left"}),n.moveDown(.4),n.text("He recibido de : "+o.cliente.razon_social,{align:"left"}),n.moveDown(.4),n.text("---------------------------------------------------------------------------------",{align:"center"}),n.moveDown(.2),n.text("                                        CONCEPTO                                   ",{align:"left"}),n.moveDown(.2),n.text("---------------------------------------------------------------------------------",{align:"center"}),n.moveDown(.4),o.fecha=new Date(o.fecha),n.text("Fecha: "+o.fecha.getDate()+"/"+(o.fecha.getMonth()+1)+"/"+o.fecha.getFullYear(),15,210);var s=o.factura;n.text(s,105,210,{width:100}),n.text("Saldo Bs "+(o.saldo-a)+".-",105,220,{width:100}),n.text("Bs "+a+".-",170,210,{width:100}),n.text("--------------",10,230,{align:"right"}),n.moveDown(.3),n.text("TOTAL Bs.              "+a.toFixed(2),{align:"right"}),n.moveDown(.4),n.moveDown(.4),n.text("SON: "+e.pago,{align:"left"}),n.moveDown(.6),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.text("-------------------------                       -------------------------",{align:"center"}),n.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),n.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),l.stop()},c.estadoConfirmado=function(a){l.start();var n=!0;if(null!==a.seguimientos[0].id_entregado&&(null!==a.seguimientos[0].id_devuelto&&!a.seguimientos[0].proveedor||null===a.seguimientos[0].id_devuelto&&a.seguimientos[0].proveedor)){if(c.estadosTransaccion.map(function(e,o){"CONFIRMADO"==e.nombre&&(a.estado=e,n=!1)}),n)return l.stop(),void c.mostrarMensaje("Hubo un error al confirmar el estado");p(c.usuario.id_empresa,a.estado.id,c.usuario.id,a.id).then(function(e){e.hasErr||(a.estado.confirmado=!0,c.filtrarTransacciones(c.filtro)),c.mostrarMensaje(e.mensaje),l.stop()}).catch(function(e){l.stop();var o=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";c.mostrarMensaje(o)})}else l.stop(),c.mostrarMensaje("No se puede confirmar el estado de la transacción, no existe información de seguimiento o esta inclompleta.")},c.abrirModalNuevoIngreso=function(){c.verificarVencimientosCreditos(c.usuario.id_empresa),c.ingreso={},c.ingreso.fecha=(new Date).toLocaleDateString(),c.abrirPopup(c.modalNuevoIngreso)},c.abrirModalVerIngreso=function(e){c.ingreso=e,c.ingreso.fecha=new Date(c.ingreso.fecha).toLocaleDateString(),c.abrirPopup(c.modalVerIngreso)},c.cerrarModalNuevoIngreso=function(){c.ingreso=void 0,c.cerrarPopup(c.modalNuevoIngreso)},c.cerrarModalVerIngreso=function(){c.ingreso=void 0,c.cerrarPopup(c.modalVerIngreso)},c.abrirModalNuevoEgreso=function(){c.egreso={},c.egreso.fecha=(new Date).toLocaleDateString(),c.abrirPopup(c.modalNuevoEgreso)},c.cerrarModalNuevoEgreso=function(){c.egreso=void 0,c.cerrarPopup(c.modalNuevoEgreso)},c.abrirModalVerEgreso=function(e){c.egreso=e,c.egreso.fecha=(new Date).toLocaleDateString(),c.abrirPopup(c.modalVerEgreso)},c.cerrarModalVerEgreso=function(){c.egreso=void 0,c.cerrarPopup(c.modalVerEgreso)},c.abrirModalSeguimiento=function(){c.abrirPopup(c.modalSeguimiento)},c.cerrarModalSeguimiento=function(){c.transaccion=void 0,c.cerrarPopup(c.modalSeguimiento)},c.obtenerSaldoDiaAnterior=function(){new Date;obtenerSaldoCuenta(c.usuario.id_empresa).then(function(e){e.hasErr&&c.mostrarMensaje(e.mensaje)})},c.abrirModalRevision=function(n){var e=d("ESTRANS"),i=!0;e.then(function(a){a.clases.map(function(e,o){n.id_estado==e.id&&"CONFIRMADO"===e.nombre&&(i=!1),o===a.clases.length-1&&(i?c.mostrarMensaje("La transaccion no se puede cerrar, aún no ha sido confirmada."):(c.transaccion=n,c.abrirPopup(c.modalRevision)))})}).catch(function(e){var o=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";c.mostrarMensaje(o)})},c.cerrarModalRevision=function(){c.transaccion=void 0,c.cerrarPopup(c.modalRevision)},c.abrirModalVencimientoCreditos=function(){c.abrirPopup(c.modalVencimientoCreditos)},c.establecerConceptoIngreso=function(e){e.detalle="Cobro Factura N° "+e.venta.factura,e.factura=e.venta.factura,e.haber=e.venta.saldo},c.establecerConceptoEgreso=function(e){e.detalle="Pago Factura N° "+e.compra.factura,e.factura=e.compra.factura,e.debe=e.compra.saldo},c.cerrarModalVencimientoCreditos=function(){c.transaccion=void 0,c.cerrarPopup(c.modalVencimientoCreditos)},c.inicio()}]);