angular.module("agil.controladores").controller("ControladorVentas",["$scope","$filter","$localStorage","$location","$templateCache","$route","blockUI","$timeout","$window","InventarioPaginador","Venta","Ventas","VentasProductos","detalle","detalleEmpresa","Clientes","ClientesNit","ProductosNombre","ClasesTipo","VentasContado","VentasCredito","PagosVenta","DatosVenta","VentaEmpresaDatos","ProductosPanel","ListaProductosEmpresaUsuario","ListaInventariosProducto","Paginator","socket","ConfiguracionVentaVistaDatos","ConfiguracionVentaVista","ListaGruposProductoEmpresa","ReporteVentasMensualesDatos","ConfiguracionImpresionEmpresaDato","VerificarUsuarioEmpresa","GuardarVentasImportados","ImprimirSalida","ModificarVenta","ListaVendedorVenta","VendedorVenta","VendedorVentaActualizacion","GuardarUsuarLectorDeBarra","VerificarLimiteCredito","ListaSucursalesUsuario","ListaGruposProductoUsuario","ListaServiciosVentas","GuardarListaServiciosVentas","EliminarVentaServicio","ventasDetalleEmpresa","EliminarDetalleVentaEdicion","filtroCotizacionesPendientes","CotizacionRechazo","ListaInventariosProductoVentaEdicion",function(x,a,c,e,t,o,g,i,r,s,l,p,u,n,d,m,v,f,h,P,b,_,D,C,V,E,S,M,I,T,w,O,A,R,F,z,H,N,B,L,y,U,j,k,G,Y,J,W,q,X,Z,K,Q){g.start(),x.usuario=JSON.parse(c.usuario),convertUrlToBase64Image(x.usuario.empresa.imagen,function(e){x.usuario.empresa.imagen=e});var ee=new Image;ee.onload=function(){x.usuario.altura_imagen=this.height/96},ee.src=x.usuario.empresa.imagen,x.idModalPago="dialog-pago",x.idModalCierre="dialog-cierre-caja",x.idModalWizardCompraEdicion="modal-wizard-venta-edicion",x.idModalWizardVentaVista="modal-wizard-venta-vista",x.idModalEliminarCompra="dialog-eliminar-venta",x.idModalContenedorCompraEdicion="modal-wizard-container-venta-edicion",x.idModalContenedorVentaVista="modal-wizard-container-venta-vista",x.idInputCompletar="nit",x.idModalPanelVentas="dialog-panel-ventas",x.idModalConfirmacionEliminacionVenta="dialog-eliminar-venta",x.idModalInventario="dialog-productos-venta",x.idModalPanelVentasCobro="dialog-panel-cobro",x.idModalEdicionVendedor="dialog-edicion-vendedor",x.idModalImpresionVencimiento="dialog-imprimir-con-fecha-vencimiento",x.IdModalVerificarCuenta="modal-verificar-cuenta",x.modalReportesProductos="dialog-reportes-productos",x.modelGraficaProductos="reporte-grafico-productos",x.modalServicioVenta="dialog-servicios-venta",x.modalReportesEmpresas="dialog-reporte-por-empresas",x.modelGraficaEmpresas="reporte-grafico-empresas",x.modelImportacionVentaServicio="dialog-importacion-ventas-servicios",x.idModalCotizaciones="dialog-cotizaciones-venta",x.idModalDetalleCotizaciones="dialog-detalle-cotizaciones",x.idModalDetalleCotizacionEditar="dialog-cotizacione-editar",x.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsVenta(x.idModalWizardCompraEdicion,x.idModalWizardVentaVista,x.idModalEliminarCompra,x.idModalContenedorCompraEdicion,x.idModalContenedorVentaVista,x.idInputCompletar,x.url,x.idModalPago,x.idModalCierre,x.idModalPanelVentas,x.idModalConfirmacionEliminacionVenta,x.idModalInventario,x.idModalPanelVentasCobro,x.idModalEdicionVendedor,x.idModalImpresionVencimiento,x.IdModalVerificarCuenta,x.modalReportesProductos,x.modalServicioVenta,x.modelGraficaProductos,x.modalReportesEmpresas,x.modelGraficaEmpresas,x.modelImportacionVentaServicio,x.idModalCotizaciones,x.idModalDetalleCotizaciones,x.idModalDetalleCotizacionEditar),x.buscarAplicacion(x.usuario.aplicacionesUsuario,e.path().substring(1)),g.stop()}),x.inicio=function(){x.ordenProductos=!0,x.esContado=!0,x.obtenerTiposDePago(),x.obtenerConfiguracionVentaVista(),x.sucursales=[],x.obtenerSucursales(),x.sucursalesUsuario="",x.obtenerFormatoFactura(),x.obtenerMovimientosEgreso(),x.obtenerVendedores(),x.detalleVenta={eliminado:!1,producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},x.estadoProducto=!1,x.estadoEmpresa=!1,x.dynamicPopoverPrecios={templateUrl:"preciosTemplate.html"}},x.obtenerConfiguracionVentaVista=function(){g.start(),T(x.usuario.id_empresa).then(function(e){x.configuracionVentaVista=e,g.stop()})},x.guardarConfiguracionVentaVista=function(){w.update({id_empresa:x.usuario.id_empresa},x.configuracionVentaVista,function(e){})},x.generarListaGruposSeleccionados=function(e,a){for(var t=0;t<e.length;t++)for(var o=0;o<a.length;o++)e[t].id==a[o].id&&(e[t].selected=a[o].selected);return e},x.verificarLimiteCredito=function(s){s.cliente&&s.tipoPago.nombre==x.diccionario.TIPO_PAGO_CREDITO?j(s).then(function(e){var i=e.ventas.slice(0),n=new Date,r=0,c={uno:"",dos:""};e.ventas.forEach(function(e,a,t){if((r+=e.saldo)>=s.cliente.linea_credito&&(c.uno="exedio el limite de la linea de credito"),a==t.length-1){var o=new Date(i.fecha);x.diferenciaEntreDiasEnDias(o,n)>s.cliente.plazo_credito&&(c.dos="exedio el limide de dias de credito"),1==s.cliente.bloquear_limite_credito?(x.mostrarMensaje(c.uno+" "+c.dos+" no puede realizar mas compras"),x.blockerVenta=!1):(x.mostrarMensaje(c.uno+" "+c.dos+", pero puede seguir consumiendo"),x.blockerVenta=!0)}})}):x.blockerVenta=!0},x.diferenciaEntreDiasEnDias=function(e,a){var t=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),o=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate());return Math.floor((o-t)/864e5)},x.obtenerGruposProductoEmpresa=function(){G(x.usuario.id_empresa,x.usuario.id).then(function(e){if(x.grupos_productos=e,angular.isDefined(c.grupos_productos))x.grupos_productos=x.generarListaGruposSeleccionados(x.grupos_productos,c.grupos_productos);else for(var a=0;a<e.length;a++)x.grupos_productos[a].selected=!0;x.listChecked=[],x.saveCheckList=function(){x.listChecked.splice(0,x.listChecked.length);for(var e=0;e<x.grupos_productos.length;e++)1==x.grupos_productos[e].selected&&x.listChecked.push(x.grupos_productos[e]);c.grupos_productos=x.grupos_productos},x.saveCheckList(),x.allChecked=!1,x.checkedUnchecked=function(){for(var e=0;e<x.grupos_productos.length;e++)x.grupos_productos[e].selected=x.allChecked;x.saveCheckList()}})},x.obtenerTiposDePago=function(){g.start(),h("TIPA").then(function(e){x.tiposPago=e.clases,g.stop()})},x.abrirPopuEdicionVendedor=function(){x.vendedor=new L({id_empresa:x.usuario.id_empresa}),x.abrirPopup(x.idModalEdicionVendedor)},x.cerrarPopupEdicionVendedor=function(){x.cerrarPopup(x.idModalEdicionVendedor)},x.guardarVendedor=function(e){x.cerrarPopup(x.idModalEdicionVendedor),e.id?y.update({id_vendedor:e.id},e,function(e){x.mostrarMensaje(e.mensaje),x.obtenerVendedores()}):e.$save(function(e){x.mostrarMensaje("Vendedor registrado satisfactoriamente!"),x.obtenerVendedores()})},x.obtenerVendedores=function(){g.start(),B(x.usuario.id_empresa).then(function(e){x.vendedores=e,g.stop()})},x.obtenerMovimientosEgreso=function(){g.start(),h("MOVEGR").then(function(e){x.movimientosEgreso=e.clases,g.stop()})},x.obtenerTipoEgreso=function(e){var a=e.nombre_corto;x.tipoEgreso=a,x.venta.sucursal&&x.obtenerActividades(x.venta.sucursal.id)},x.buscarCliente=function(e){if(""!=e&&null!=e)return v(x.usuario.id_empresa,e)},x.obtenerClientes=function(){m(x.usuario.id_empresa).then(function(e){for(var a=0;a<e.length;a++)e[a].nit=e[a].nit.toString();x.clientes=e})},x.buscarProductoLectorBarra=function(e){if(g.start(),""!=e&&null!=e){var a=E(x.usuario.id_empresa,e,x.usuario.id,x.venta.almacen.id);return a.then(function(e){1==e.length&&x.establecerProducto(e[0]),g.stop()},function(e){x.mostrarMensaje(e.message),g.stop()}),g.stop(),a}},x.buscarProducto=function(e){if(g.start(),""!=e&&null!=e){var a=E(x.usuario.id_empresa,e,x.usuario.id,x.venta.almacen.id);return g.stop(),a}},x.establecerProductoEdicionVenta=function(i){i.tipoProducto=null==i.tipoProducto?{id:i["tipoProducto.id"],nombre:i["tipoProducto.nombre"],nombre_corto:i["tipoProducto.nombre_corto"]}:i.tipoProducto,x.editar_precio=!1;var e=new Date(x.convertirFecha(x.venta.fechaTexto));Q(i.id,x.venta.almacen.id,e).then(function(e){i.inventarios=e;for(var a=0;a<i.inventarios.length;a++)i.inventarios[a].fecha_vencimiento=i.inventarios[a].fecha_vencimiento?new Date(i.inventarios[a].fecha_vencimiento):null,i.inventarios[a].fechaVencimientoTexto=i.inventarios[a].fecha_vencimiento?i.inventarios[a].fecha_vencimiento.getDate()+"/"+(i.inventarios[a].fecha_vencimiento.getMonth()+1)+"/"+i.inventarios[a].fecha_vencimiento.getFullYear():"",i.inventarios[a].detallesMovimiento[0].movimiento.fecha=new Date(i.inventarios[a].detallesMovimiento[0].movimiento.fecha),i.inventarios[a].detallesMovimiento[0].movimiento.fechaTexto=i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getFullYear();x.inventariosDisponibleProducto=[],x.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),x.inventariosDisponibleProducto=x.inventariosDisponibleProducto.concat(i.inventarios);var t=x.obtenerInventarioTotal(i);if(x.detalleVenta={eliminado:!1,producto:i,precio_unitario:i.precio_unitario,inventarioProducto:x.inventariosDisponibleProducto[0],inventario_disponible:t,costos:i.activar_inventario?i.inventarios:[],cantidad:1,descuento:i.descuento,recargo:0,ice:0,excento:0,tipo_descuento:0<i.descuento,tipo_recargo:!1},x.precio_inventario,0<i.inventarios.length){var o=i.inventarios.find(function(e){var a=e;return a.id<=e.id&&(a=e),e});x.precio_inventario=o.costo_unitario+" Bs"}else x.precio_inventario="Sin histórico";x.inventarioProducto=i.activar_inventario?i.inventarios:[],x.colorearInventarioDisponible(t,i),document.getElementById("cantidad").focus(),x.calcularImporte(),x.cerrarPopup(x.idModalInventario)})},x.establecerProducto=function(n){n.tipoProducto=null==n.tipoProducto?{id:n["tipoProducto.id"],nombre:n["tipoProducto.nombre"],nombre_corto:n["tipoProducto.nombre_corto"]}:n.tipoProducto,x.editar_precio=!1,S(n.id,x.venta.almacen.id).then(function(e){n.inventarios=e;for(var a=0;a<n.inventarios.length;a++)n.inventarios[a].fecha_vencimiento=n.inventarios[a].fecha_vencimiento?new Date(n.inventarios[a].fecha_vencimiento):null,n.inventarios[a].fechaVencimientoTexto=n.inventarios[a].fecha_vencimiento?n.inventarios[a].fecha_vencimiento.getDate()+"/"+(n.inventarios[a].fecha_vencimiento.getMonth()+1)+"/"+n.inventarios[a].fecha_vencimiento.getFullYear():"",n.inventarios[a].detallesMovimiento[0].movimiento.fecha=new Date(n.inventarios[a].detallesMovimiento[0].movimiento.fecha),n.inventarios[a].detallesMovimiento[0].movimiento.fechaTexto=n.inventarios[a].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(n.inventarios[a].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+n.inventarios[a].detallesMovimiento[0].movimiento.fecha.getFullYear();x.inventariosDisponibleProducto=[];var t=0;x.TipoPrecioProducto={},x.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),x.inventariosDisponibleProducto=x.inventariosDisponibleProducto.concat(n.inventarios);var o=x.obtenerInventarioTotal(n);if(x.venta.cliente.id&&x.venta.cliente.tipoPrecioVenta&&x.usuario.empresa.usar_tipo_precio&&0<n.tiposPrecio.length?n.tiposPrecio.forEach(function(e){e.id_tipo_precio==x.venta.cliente.tipoPrecioVenta.id?(t=e.precio_unitario,x.tipoPrecioProducto=e):t=n.precio_unitario}):t=n.precio_unitario,x.detalleVenta={eliminado:!1,producto:n,precio_unitario:t,inventarioProducto:x.inventariosDisponibleProducto[0],inventario_disponible:o,costos:n.activar_inventario?n.inventarios:[],cantidad:1,descuento:n.descuento,recargo:0,ice:0,excento:0,tipo_descuento:0<n.descuento,tipo_recargo:!1},x.precio_inventario,0<n.inventarios.length){var i=n.inventarios.find(function(e){var a=e;return a.id<=e.id&&(a=e),e});x.precio_inventario=i.costo_unitario+" Bs"}else x.precio_inventario="Sin histórico";x.inventarioProducto=n.activar_inventario?n.inventarios:[],x.colorearInventarioDisponible(o,n),document.getElementById("cantidad").focus(),x.calcularImporte(),x.cerrarPopup(x.idModalInventario)})},x.colorearInventarioDisponible=function(e,a){0==e?(x.porcentaje="100",x.color="red"):e>3*a.inventario_minimo+1?(x.porcentaje="100",x.color="green"):e>2*a.inventario_minimo+1?(x.porcentaje="75",x.color="green"):e>1.5*a.inventario_minimo+1?(x.porcentaje="50",x.color="green"):e==a.inventario_minimo+1?(x.porcentaje="38",x.color="yellow"):e==a.inventario_minimo?(x.porcentaje="25",x.color="red"):e<a.inventario_minimo&&0<e&&(x.porcentaje="12",x.color="red")},x.actualizarInventarioDisponibleFechaVencimiento=function(e){0!=e.inventarioProducto.id?(e.costos=[],e.costos.push(e.inventarioProducto),e.inventario_disponible=x.obtenerInventarioTotalPorFechaVencimiento(e),e.lote=e.inventarioProducto.lote):(e.inventario_disponible=x.obtenerInventarioTotal(e.producto),e.costos=e.producto.inventarios,e.lote=""),x.colorearInventarioDisponible(e.inventario_disponible,e.producto),x.calcularImporte()},x.establecerCliente=function(e){x.venta.cliente=e,x.enfocar("razon_social"),x.capturarInteraccion()},x.eliminarVendedor=function(e){x.cerrarConfirmacionEliminacion(),new y(e).$delete(function(e){x.mostrarMensaje(e.mensaje),x.obtenerVendedores()},function(e){x.mostrarMensaje("Ocurrio un problema al eliminar!")})},x.modificarVendedor=function(e){x.vendedor=e,x.abrirPopup(x.idModalEdicionVendedor)},x.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario){for(var t=0;t<e.inventarios.length;t++)a+=e.inventarios[t].cantidad;for(var o=0;o<x.venta.detallesVenta.length;o++)if(x.venta.detallesVenta[o].producto.tipoProducto.nombre_corto==x.diccionario.TIPO_PRODUCTO_FINAL||x.venta.detallesVenta[o].producto.tipoProducto.nombre_corto==x.diccionario.TIPO_PRODUCTO_INTER)for(var i=0;i<x.venta.detallesVenta[o].producto.productosBase.length;i++){var n=x.venta.detallesVenta[o].producto.productosBase[i];if(n.productoBase.tipoProducto.nombre_corto==x.diccionario.TIPO_PRODUCTO_INTER)for(var r=0;r<n.productoBase.productosBase.length;r++){var c=n.productoBase.productosBase[r];c.productoBase.id!=e.id||x.venta.detallesVenta[o].id||(a-=parseInt(c.formulacion))}else n.productoBase.id!=e.id||x.venta.detallesVenta[o].id||(a-=parseInt(n.formulacion))}else x.venta.detallesVenta[o].producto.id!=e.id||x.venta.detallesVenta[o].id||(a-=x.venta.detallesVenta[o].cantidad)}else a=5e5;return a},x.obtenerInventarioTotalPorFechaVencimiento=function(e){if(x.usuario.empresa.usar_peps){for(var a=e.inventarioProducto.cantidad,t=0;t<x.venta.detallesVenta.length;t++)x.venta.detallesVenta[t].producto.id!=e.producto.id||x.venta.detallesVenta[t].costos[0].id!=e.inventarioProducto.id||x.venta.detallesVenta[t].id||(a-=x.venta.detallesVenta[t].cantidad);return a}for(a=e.inventario_disponible,t=0;t<x.venta.detallesVenta.length;t++)x.venta.detallesVenta[t].producto.id==e.producto.id&&x.venta.detallesVenta[t].costos[0].id==e.inventarioProducto.id&&(a-=x.venta.detallesVenta[t].cantidad);return a},x.agregarDetalleVentaServicio=function(e){e.servicio.id&&e.importe&&(x.calcularImporteServicio(),x.venta.detallesVenta.push(e),x.inventariosDisponibleProducto=[],x.sumarTotal(),x.sumarTotalImporte(),x.calcularSaldo(),x.calcularCambio(),x.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},x.enfocar("id_servicio"))},x.calcularImporteServicio=function(){x.detalleVenta.total=Math.round(1e3*(x.detalleVenta.importe-x.detalleVenta.descuento+x.detalleVenta.recargo-x.detalleVenta.ice-x.detalleVenta.excento))/1e3},x.agregarDetalleVenta=function(e){if(e.producto.id){if(e.producto.activar_inventario)if(x.usuario.empresa.usar_peps)if(1<e.costos.length)for(var a=e.cantidad,t=0,o=JSON.parse(JSON.stringify(e));t<e.costos.length&&0<a;){if(e.inventarioProducto=e.costos[t],0<(n=x.obtenerInventarioTotalPorFechaVencimiento(e))){var i=JSON.parse(JSON.stringify(o));n<a?a-=r=n:(r=a,a=0),(x.detalleVenta=i).cantidad=r,x.usuario.empresa.usar_vencimientos&&(i.fecha_vencimiento=e.costos[t].fecha_vencimiento,i.lote=e.costos[t].lote),i.costos=[],i.costos.push(e.costos[t]),i.inventario=e.costos[t],x.calcularImporte(),x.venta.detallesVenta.push(i)}t++}else 0<e.costos.length&&x.usuario.empresa.usar_vencimientos&&(e.fecha_vencimiento=e.costos[0].fecha_vencimiento,e.lote=e.costos[0].lote,e.inventario=e.costos[0]),x.venta.detallesVenta.push(e);else{var n;a=e.cantidad,t=0,o=JSON.parse(JSON.stringify(e));if(e.inventarioProducto=e.costos[t],0<(n=x.obtenerInventarioTotalPorFechaVencimiento(e))){var r;i=JSON.parse(JSON.stringify(o));n<a?a-=r=n:(r=a,a=0),(x.detalleVenta=i).cantidad=r,x.usuario.empresa.usar_vencimientos&&(i.fecha_vencimiento=e.costos[t].fecha_vencimiento,i.lote=e.costos[t].lote),i.costos=[],i.costos.push(e.costos[t]),i.inventario=e.costos[t],x.calcularImporte(),x.venta.detallesVenta.push(i)}}else x.venta.detallesVenta.push(e);x.inventariosDisponibleProducto=[],x.sumarTotal(),x.sumarTotalImporte(),x.calcularSaldo(),x.calcularCambio(),x.precio_inventario="Sin histórico",x.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},x.enfocar("id_producto")}},x.enfocar=function(e){i(function(){$("#"+e).focus()},0)},x.interceptarTecla=function(e,a,t){13===e.which&&(t?x.enfocar(a):i(function(){$("#"+a).trigger("click")},0))},x.eliminarDetalleVenta=function(e){e.id?e.eliminado=!0:x.venta.detallesVenta.splice(x.venta.detallesVenta.indexOf(e),1),x.sumarTotal(),x.sumarTotalImporte(),x.calcularSaldo(),x.calcularCambio(),x.capturarInteraccion()},x.eliminarDetalleVentaEdicion=function(a){a.id?(x.CancelacionVentaEdicion=!0,X(a,x.venta.movimientoActual.id,x.venta).then(function(e){1==e.hasError||(x.venta.detallesVenta.splice(x.venta.detallesVenta.indexOf(a),1),x.sumarTotal(),x.sumarTotalImporte(),x.calcularSaldo(),x.calcularCambio(),x.capturarInteraccion()),x.mostrarMensaje(e.mensaje)})):(x.venta.detallesVenta.splice(x.venta.detallesVenta.indexOf(a),1),x.sumarTotal(),x.sumarTotalImporte(),x.calcularSaldo(),x.calcularCambio(),x.capturarInteraccion())},x.eliminarDetalleVentaPanel=function(e){var a=x.productosProcesados.indexOf(e.producto);x.productosProcesados[a].inventario_disponible=x.productosProcesados[a].inventario_disponible+e.cantidad,x.venta.detallesVenta.splice(x.venta.detallesVenta.indexOf(e),1),x.sumarTotal(),x.sumarTotalImporte(),x.calcularSaldo(),x.calcularCambio(),x.capturarInteraccion()},x.cambiarTipoPago=function(e){if(e.tipoPago){var a=e.tipoPago,t=$.grep(x.tiposPago,function(e){return e.id==a.id})[0];x.esContado="CONT"==t.nombre_corto,x.calcularCambio(),1==e.cliente.usar_limite_credito&&x.verificarLimiteCredito(e)}},x.recalcular=function(){x.calcularImporte()},x.calcularImporte=function(){var e,a;x.detalleVenta.importe=Math.round(x.detalleVenta.cantidad*x.detalleVenta.precio_unitario*1e3)/1e3,e=x.detalleVenta.tipo_descuento?x.detalleVenta.importe*(x.detalleVenta.descuento/100):x.detalleVenta.descuento,a=x.detalleVenta.tipo_recargo?x.detalleVenta.importe*(x.detalleVenta.recargo/100):x.detalleVenta.recargo,x.detalleVenta.total=Math.round(1e3*(x.detalleVenta.importe-e+a-x.detalleVenta.ice-x.detalleVenta.excento))/1e3},x.sumarTotalImporte=function(){for(var e=0,a=0;a<x.venta.detallesVenta.length;a++)x.venta.detallesVenta[a].eliminado||(e+=x.venta.detallesVenta[a].importe);x.venta.importe=Math.round(1e3*e)/1e3},x.sumarTotal=function(){for(var e=0,a=0;a<x.venta.detallesVenta.length;a++)x.venta.detallesVenta[a].eliminado||(e+=x.venta.detallesVenta[a].total);x.venta.total=Math.round(1e3*e)/1e3,x.venta.pagado=x.venta.total},x.calcularSaldo=function(){x.venta.saldo=x.venta.total-x.venta.a_cuenta},x.obtenerSucursales=function(){k(x.usuario.id).then(function(e){e.sucursales.map(function(e){x.sucursales.push(e.sucursal)}),x.usuario.sucursalesUsuario=e.sucursales;for(var a=0;a<x.usuario.sucursalesUsuario.length;a++)x.sucursalesUsuario=x.sucursalesUsuario+x.usuario.sucursalesUsuario[a].sucursal.id,a+1!=x.usuario.sucursalesUsuario.length&&(x.sucursalesUsuario=x.sucursalesUsuario+",")})},x.obtenerAlmacenesSucursalesDiferente=function(e){x.obtenerAlmacenes(e),x.obtenerSucursalesDiferente(e)},x.obtenerAlmacenesDiferente=function(a){x.almacenesDiferente=[];var e=$.grep(x.sucursales,function(e){return e.id==a})[0];x.almacenesDiferente=e.almacenes,x.venta.almacenDestino=1==x.almacenesDiferente.length?x.almacenesDiferente[0]:null},x.obtenerSucursalesDiferente=function(a){x.sucursalesDiferente=$.grep(x.sucursales,function(e){return e.id!=a}),x.almacenesDiferente=x.sucursalesDiferente.almacenes},x.obtenerAlmacenesActividades=function(e){x.obtenerAlmacenes(e),x.obtenerActividades(e)},x.obtenerAlmacenes=function(a){x.almacenes=[];var e=$.grep(x.sucursales,function(e){return e.id==a})[0];x.almacenes=e.almacenes,x.venta.editar||(x.venta.almacen=1==x.almacenes.length?x.almacenes[0]:null,x.venta.almacen&&x.cargarProductos())},x.obtenerActividades=function(a){x.actividades=[];var e=$.grep(x.sucursales,function(e){return e.id==a})[0];x.actividadesDosificaciones=e.actividadesDosificaciones,x.actividades=[];for(var t=0;t<x.actividadesDosificaciones.length;t++)x.actividadesDosificaciones[t].dosificacion&&(x.venta.movimiento&&"SERV"==x.venta.movimiento.nombre_corto?x.actividadesDosificaciones[t].expirado||x.actividadesDosificaciones[t].dosificacion.expirado||1!=x.actividadesDosificaciones[t].dosificacion.tipo_dosificacion?x.dosificacionesExpiradas=!0:x.actividades.push(x.actividadesDosificaciones[t].actividad):x.actividadesDosificaciones[t].expirado||x.actividadesDosificaciones[t].dosificacion.expirado||0!=x.actividadesDosificaciones[t].dosificacion.tipo_dosificacion?x.dosificacionesExpiradas=!0:x.actividades.push(x.actividadesDosificaciones[t].actividad));x.venta.id||(x.venta.actividad=1==x.actividades.length?x.actividades[0]:null)},x.obtenerVentas=function(){var e=new Date,a=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear();x.filtrarVentas(x.sucursalesUsuario,a,a)},x.filtrarVentas=function(e,a,t,o,i,n,r,c,s,l,u,d){o=""==o||null==o?0:o,u=""==u||null==u?0:u,i=null==i||null==i?0:i,n=null==n||null==n?0:n,r=null==r?0:r,c=null==c||null==c?0:c,s=null==s||null==s?0:s,l=0<$.grep(x.usuario.rolesUsuario,function(e){return e.rol.nombre==x.diccionario.ROL_ADMINISTRADOR}).length?""==l||null==l?0:l:x.usuario.nombre_usuario,d=!d&&d,g.start(),x.razon_sociald=o,x.nitd=i,x.montod=n,x.usuariod=l,0!=s&&(x.transacciond=0<$.grep(x.movimientosEgreso,function(e){return e.id==s}).length?$.grep(x.movimientosEgreso,function(e){return e.id==s})[0].nombre:"todos"),0!=c&&(x.sucursald=0<$.grep(x.sucursales,function(e){return e.id==c}).length?$.grep(x.sucursales,function(e){return e.id==c})[0].nombre:"todos"),0!=r&&(x.tipoPagod=0<$.grep(x.tiposPago,function(e){return e.id==r}).length?$.grep(x.tiposPago,function(e){return e.id==r})[0].nombre:"todos"),a=new Date(x.convertirFecha(a)),t=new Date(x.convertirFecha(t)),p(e,a,t,o,i,n,r,c,s,l,u).then(function(e){x.ventas=e,g.stop()})},x.abrirPopupPago=function(e){x.venta=e,x.pago=null,x.abrirPopup(x.idModalPago)},x.cerrarPopupPago=function(){x.cerrarPopup(x.idModalPago)},x.efectuarPago=function(a){g.start(),C.update({id:x.venta.id,id_empresa:x.usuario.id_empresa},{pago:a,id_usuario_cajero:x.usuario.id},function(e){x.mostrarMensaje(e.mensaje),x.cerrarPopup(x.idModalPago),x.obtenerVentas(),x.imprimirRecibo(e,e.venta,a),g.stop()},function(e){x.mostrarMensaje(e),x.cerrarPopup(x.idModalPago),x.obtenerVentas(),g.stop()})},x.imprimirRecibo=function(e,a,t){g.start();var o=new PDFDocument({compress:!1,size:[227,353],margin:10}),i=o.pipe(blobStream());o.moveDown(2),o.font("Helvetica-Bold",8),o.text(x.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),o.moveDown(.4),o.font("Helvetica",7),o.text(a.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),o.moveDown(.4),o.text(a.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),o.moveDown(.4);var n=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");o.text("TELF.: "+n,{align:"center"}),o.moveDown(.4),o.text("COCHABAMBA - BOLIVIA",{align:"center"}),o.moveDown(.5),o.font("Helvetica-Bold",8),o.text("RECIBO",{align:"center"}),o.font("Helvetica",7),o.moveDown(.4),o.text("------------------------------------",{align:"center"}),o.moveDown(.4),o.text(a.almacen.sucursal.nota_recibo_correlativo,{align:"center"}),o.moveDown(.4),o.moveDown(.4),o.text("------------------------------------",{align:"center"}),o.moveDown(.4),o.moveDown(.6);var r=new Date;o.text("FECHA : "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),{align:"left"}),o.moveDown(.4),o.text("He recibido de : "+x.venta.cliente.razon_social,{align:"left"}),o.moveDown(.4),o.text("---------------------------------------------------------------------------------",{align:"center"}),o.moveDown(.2),o.text("       CONCEPTO                                   ",{align:"left"}),o.moveDown(.2),o.text("---------------------------------------------------------------------------------",{align:"center"}),o.moveDown(.4),a.fecha=new Date(a.fecha),o.text("Fecha: "+a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear(),15,210);var c=x.venta.movimiento.clase.nombre_corto==x.diccionario.EGRE_FACTURACION?"Factura nro. "+x.venta.factura:"Proforma nro. "+x.venta.factura;o.text(c,105,210,{width:100}),o.text("Saldo Bs "+(a.saldo-t)+".-",105,220,{width:100}),o.text("Bs "+t+".-",170,210,{width:100}),o.text("--------------",10,230,{align:"right"}),o.moveDown(.3),o.text("TOTAL Bs.              "+t.toFixed(2),{align:"right"}),o.moveDown(.4),o.moveDown(.4),o.text("SON: "+e.pago,{align:"left"}),o.moveDown(.6),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.text("-------------------------                       -------------------------",{align:"center"}),o.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),g.stop()},x.abrirPopupCierre=function(){x.cierre={},x.abrirPopup(x.idModalCierre)},x.cerrarPopupCierre=function(){x.cerrarPopup(x.idModalCierre)},x.cerrarCaja=function(o){g.start(),inicio=new Date,fin=new Date;var e=P(x.sucursalesUsuario,inicio,fin,x.usuario.id);e.then(function(t){(e=b(x.sucursalesUsuario,inicio,fin,x.usuario.id)).then(function(a){(e=_(x.sucursalesUsuario,inicio,fin,x.usuario.id)).then(function(e){x.generarReporteCierreCaja(o,t,a,e),x.cerrarPopupCierre()})})})},x.generarReporteCierreCaja=function(o,i,n,r){R(x.usuario.id_empresa,0).then(function(e){var a=[612,792];if(e.usar){if(e.tamanoPapelCierreCaja.nombre_corto==x.diccionario.FACT_PAPEL_OFICIO)a=[612,936],x.imprimirReporteCierreCajaCartaOficio(a,o,i,n,r);else if(e.tamanoPapelCierreCaja.nombre_corto==x.diccionario.FACT_PAPEL_CARTA)a=[612,792],x.imprimirReporteCierreCajaCartaOficio(a,o,i,n,r);else if(e.tamanoPapelCierreCaja.nombre_corto==x.diccionario.FACT_PAPEL_MEDIOOFICIO)a=[612,468],x.imprimirReporteCierreCajaCartaOficio(a,o,i,n,r);else if(e.tamanoPapelCierreCaja.nombre_corto==x.diccionario.FACT_PAPEL_ROLLO){var t;a=[227,(t=i.length+n.length+r.length)<=2?310:310+20*(t-2)],x.imprimirReporteCierreCajaRollo(a,o,i,n,r)}}else a=[227,(t=i.length+n.length+r.length)<=2?310:310+20*(t-2)],x.imprimirReporteCierreCajaRollo(a,o,i,n,r)})},x.trueDetalle=!0,x.verDetalle=function(){x.trueDetalle?x.trueDetalle=!1:x.trueDetalle=!0},x.imprimirFiltroCajaCartaOficio=function(e,a,t){var o=new PDFDocument({compress:!1,size:[612,792],margin:0}),i=o.pipe(blobStream()),n=20;if(x.trueDetalle){for(var r=2*e.length,c=0;c<e.length;c++)r+=e[c].detallesVenta.length;var s=Math.ceil(r/n)}else n=20,s=Math.ceil(e.length/n);var l=100,u=0,d=1;x.imprimirCabeceraFiltroCajaCartaOficio(o,1,s,e,a,t),o.font("Helvetica",7);for(c=0;c<e.length;c++)if(o.font("Helvetica",7),o.rect(50,l+9,520,0).stroke(),o.text(c+1,55,l+20),o.font("Helvetica",6),o.text(e[c].movimiento?e[c].movimiento.clase.nombre:e[c].movimientoServicio.nombre,65,l+20),o.text(e[c].almacen?e[c].almacen.sucursal.nombre:e[c].sucursal.nombre,120,l+20,{width:60}),e[c].cliente?(o.font("Helvetica",6),o.text(e[c].cliente.razon_social,170,l+15,{width:75}),o.font("Helvetica",7),o.text(e[c].cliente.nit,245,l+20)):(o.text("",205,l+16,{width:75}),o.text("",265,l+20)),o.text(e[c].factura,305,l+20),e[c].fecha=new Date(e[c].fecha),o.text(e[c].fecha.getDate()+"/"+(e[c].fecha.getMonth()+1)+"/"+e[c].fecha.getFullYear(),345,l+20),o.text(e[c].fecha.getHours()+":"+e[c].fecha.getMinutes()+" - ",385,l+13,{width:28}),o.text(e[c].fecha.getDate()+"/"+(e[c].fecha.getMonth()+1)+"/"+e[c].fecha.getFullYear(),385,l+21,{width:32}),o.text(e[c].total,425,l+20),e[c].tipoPago?(o.text(e[c].tipoPago.nombre,455,l+20),e[c].tipoPago.nombre==x.diccionario.TIPO_PAGO_CREDITO&&(o.font("Helvetica",6),o.text("Plazo: "+e[c].dias_credito+" A cuenta: Bs "+e[c].a_cuenta+" Saldo: Bs "+e[c].saldo,510,l+16,{width:55}))):(o.text("",455,l+20),o.text("",520,l+16,{width:65})),x.trueDetalle){o.rect(50,l+34,520,0).stroke(),o.font("Helvetica",7),l+=50,o.text("N°",105,l),o.text("Nombre",115,l),o.text("Codigo Item",170,l),o.text("Unidad de Med",230,l),o.text("Cantidad",295,l),o.text("Importe",355,l),u++;for(var p=0;p<e[c].detallesVenta.length;p++)if(o.font("Helvetica",7),o.text(p+1,105,l+20),o.text(e[c].detallesVenta[p].producto?e[c].detallesVenta[p].producto.nombre:e[c].detallesVenta[p].servicio.nombre,115,l+20,{width:55}),o.text(e[c].detallesVenta[p].producto?e[c].detallesVenta[p].producto.id:"0",170,l+20),o.text(e[c].detallesVenta[p].producto?e[c].detallesVenta[p].producto.unidad_medida:"0",230,l+20),o.text(e[c].detallesVenta[p].producto?e[c].detallesVenta[p].cantidad:"0",295,l+20),o.text(e[c].detallesVenta[p].importe,355,l+20),l+=24,n-1<++u+1){l+=10,o.text(d+" de "+s,520,705);var m=new Date;o.text("FECHA : "+m.getDate()+"/"+(m.getMonth()+1)+"/"+m.getFullYear()+"   Hr:"+m.getHours()+":"+m.getMinutes(),55,705),o.text("USUARIO: "+x.usuario.nombre_usuario,150,705),o.addPage({size:[612,792],margin:10}),l=100,u=0,d+=1,x.imprimirCabeceraFiltroCajaCartaOficio(o,1,s,e,a,t)}if(o.font("Helvetica",7),l+=4,n<++u){l+=10,o.text(d+" de "+s,520,705);m=new Date;o.text("FECHA : "+m.getDate()+"/"+(m.getMonth()+1)+"/"+m.getFullYear()+"   Hr:"+m.getHours()+":"+m.getMinutes(),55,705),o.text("USUARIO: "+x.usuario.nombre_usuario,150,705),o.addPage({size:[612,792],margin:10}),l=100,u=0,d+=1,x.imprimirCabeceraFiltroCajaCartaOficio(o,1,s,e,a,t)}}else if(o.font("Helvetica",7),l+=30,++u==n){o.text(d+" de "+s,520,705);m=new Date;o.text("FECHA : "+m.getDate()+"/"+(m.getMonth()+1)+"/"+m.getFullYear()+"   Hr:"+m.getHours()+":"+m.getMinutes(),55,705),o.text("USUARIO: "+x.usuario.nombre_usuario,150,705),o.addPage({size:[612,792],margin:10}),l=100,u=0,d+=1,x.imprimirCabeceraFiltroCajaCartaOficio(o,1,s,e,a,t)}o.font("Helvetica",7),o.text(d+" de "+s,520,705);m=new Date;o.text("FECHA : "+m.getDate()+"/"+(m.getMonth()+1)+"/"+m.getFullYear()+"   Hr:"+m.getHours()+":"+m.getMinutes(),55,705),o.text("USUARIO: "+x.usuario.nombre_usuario,150,705),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),g.stop()},x.imprimirCabeceraFiltroCajaCartaOficio=function(e,a,t,o,i,n){e.font("Helvetica-Bold",16),e.text("REPORTE",0,40,{align:"center"}),e.font("Helvetica-Bold",8),e.rect(50,80,520,620).stroke(),e.text("Desde: "+i+" Hasta: "+n,0,55,{align:"center"});var r=[x.razon_sociald,x.nitd,x.montod,x.usuariod,x.transacciond,x.sucursald,x.tipoPagod],c=0,s="";e.text("Filtro: ",55,65);for(var l=0;l<r.length;l++)0!=r[l]&&null!=r[l]?(s=s+r[l]+", ",65):7==(c+=1)&&e.text("GENERAL",85,65);e.text(s,85,65),e.font("Helvetica-Bold",7),e.font("Helvetica-Bold",8),e.text("N°",55,90),e.text("Transaccion",65,90),e.text("Sucursal",120,90,{width:43}),e.text("Razon Social",170,90),e.text("Nit Cliente",245,90,{width:43}),e.text("Fac.",305,90),e.text("Fecha-Fact.",345,86,{width:43}),e.text("Hora-Fecha",385,86,{width:43}),e.text("Monto",420,90),e.text("Tipo de Pago",455,90),e.text("Pago",520,90)},x.imprimirFiltroExcelCajaCartaOficio=function(e){g.start();for(var a=[["N°","Tipo de Transaccion","Sucursal","Razon Social","N° DE LA FACTURA","Nit Cliente","Fac.","Fecha-Fact.","Hora-Fecha","Monto","Tipo de Pago","Pago","Sucursal dest"]],t=0;t<e.length;t++)e[t].fecha=new Date(e[t].fecha);e.sort(function(e,a){return e.fecha>a.fecha?1:e.fecha<a.fecha?-1:0});for(t=0;t<e.length;t++){var o=[];if(o.push(t+1),o.push(e[t].movimiento?e[t].movimiento.clase.nombre:e[t].movimientoServicio.nombre),o.push(e[t].almacen?e[t].almacen.sucursal.nombre:e[t].sucursal.nombre),e[t].cliente?(o.push(e[t].cliente.razon_social),o.push(e[t].factura),o.push(e[t].cliente.nit)):(o.push(""),o.push(e[t].factura),o.push("")),o.push(e[t].factura),o.push(e[t].fecha),o.push(e[t].fecha),o.push(e[t].total),e[t].tipoPago?(o.push(e[t].tipoPago.nombre),e[t].tipoPago.nombre==x.diccionario.TIPO_PAGO_CREDITO&&o.push("Plazo: "+e[t].dias_credito+" A cuenta: Bs "+e[t].a_cuenta+" Saldo: Bs "+e[t].saldo)):o.push(""),e[t].movimiento&&"TRASPASO"==e[t].movimiento.clase.nombre&&(o.push(""),o.push(e[t].almacenTraspaso.sucursal.nombre)),a.push(o),x.trueDetalle){a.push(["","","","","N°","Nombre","Codigo Item","Unidad de Med","Cantidad","Importe","lote"]);for(var i=0;i<e[t].detallesVenta.length;i++)(o=[]).push(""),o.push(""),o.push(""),o.push(""),o.push(i+1),o.push(e[t].detallesVenta[i].producto?e[t].detallesVenta[i].producto.nombre:e[t].detallesVenta[i].servicio?e[t].detallesVenta[i].servicio.nombre:"ERROR SIN NOMBRE"),o.push(e[t].detallesVenta[i].producto?e[t].detallesVenta[i].producto.codigo:e[t].detallesVenta[i].servicio?"0":"ERROR SIN NOMBRE"),o.push(e[t].detallesVenta[i].producto?e[t].detallesVenta[i].producto.unidad_medida:e[t].detallesVenta[i].servicio?"0":"ERROR SIN NOMBRE"),o.push(e[t].detallesVenta[i].producto?e[t].detallesVenta[i].cantidad:e[t].detallesVenta[i].servicio?"0":"ERROR SIN NOMBRE"),o.push(e[t].detallesVenta[i].producto?e[t].detallesVenta[i].importe:"ERROR SIN NOMBRE"),o.push(e[t].detallesVenta[i].producto?e[t].detallesVenta[i].lote:e[t].detallesVenta[i].servicio?"0":"ERROR SIN NOMBRE"),a.push(o)}t+1==e.length&&((o=[]).push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push("TOTALES"),a.push(o))}var n="SheetJS",r=new Workbook,c=sheet_from_array_of_arrays(a);r.SheetNames.push(n),r.Sheets[n]=c;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"Reporte-ventas.xlsx"),g.stop()},x.imprimirReporteCierreCajaCartaOficio=function(e,a,t,o,i){var n=new PDFDocument({compress:!1,size:e,margin:0}),r=n.pipe(blobStream());n.font("Helvetica-Bold",15),n.text("CIERRE DE CAJA",55,50),n.font("Helvetica-Bold",8),n.text("SALDO INICIAL: ",55,80),n.text(a.saldo_inicial,350,80),n.font("Helvetica-Bold",8),n.text("VENTAS AL CONTADO: ",55,100),n.font("Helvetica",8);for(var c=100,s=0,l=0,u=0;u<t.length;u++)n.text("No. "+t[u].factura,55,c+20),n.text(t[u].cliente.razon_social,100,c+20),n.text(t[u].total,300,c+20),s+=t[u].total,c+=20;n.font("Helvetica-Bold",8),n.text(s,350,100),n.font("Helvetica-Bold",8),n.text("VENTAS AL CREDITO: ",55,c+20),n.font("Helvetica",8);var d=c+20;c+=20;var p=0;for(u=0;u<o.length;u++)0<o[u].pagosVenta.length?0<o[u].pagosVenta[0].a_cuenta_anterior&&(n.text("No. "+o[u].factura,55,c+20),n.text(o[u].cliente.razon_social,100,c+20),n.text(o[u].pagosVenta[0].a_cuenta_anterior,300,c+20),p+=o[u].pagosVenta[0].a_cuenta_anterior,c+=20):o[u].a_cuenta&&(n.text("No. "+o[u].factura,55,c+20),n.text(o[u].cliente.razon_social,100,c+20),n.text(o[u].a_cuenta,300,c+20),p+=o[u].a_cuenta,c+=20);n.font("Helvetica-Bold",8),n.text(p,350,d);var m=c+20;n.text("COBROS REALIZADOS: ",55,c+20),n.font("Helvetica",8),c+=20;for(u=0;u<i.length;u++)n.text("No. "+i[u].venta.factura,55,c+20),n.text(i[u].venta.cliente.razon_social,100,c+20),n.text(i[u].monto_pagado,300,c+20),l+=i[u].monto_pagado,c+=20;n.text(l,350,m),n.font("Helvetica-Bold",8),n.text("GASTOS: ",55,c+40),n.text(a.gastos,350,c+40),n.text("SALDO FINAL CAJA: ",55,c+60),n.text(Math.round(100*(a.saldo_inicial+s+p+l-a.gastos))/100,350,c+60),n.text("---------------------------------------------                       ---------------------------------------------",0,c+100,{align:"center"}),n.text("ENTREGUE CONFORME                                     RECIBI CONFORME",0,c+130,{align:"center"}),n.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),g.stop()},x.imprimirReporteCierreCajaRollo=function(e,a,t,o,i){var n=new PDFDocument({compress:!1,size:e,margins:{top:10,bottom:10,left:10,right:20}}),r=n.pipe(blobStream());n.moveDown(2),n.font("Helvetica-Bold",8),n.text("CIERRE DE CAJA",{align:"center"}),n.moveDown(.4),n.font("Helvetica-Bold",8);var c=n.y;n.text("SALDO INICIAL: ",{align:"left",width:100}),n.text(a.saldo_inicial,0,c,{align:"right"}),n.x=10,n.moveDown(.8),n.font("Helvetica-Bold",8);var s=n.y;n.text("VENTAS AL CONTADO: ",{align:"left"}),n.font("Helvetica",8),n.moveDown(.4);for(var l=n.y,u=0,d=0,p=0;p<t.length;p++)n.text("No. "+t[p].factura,20,l),n.text(t[p].cliente.razon_social,60,l,{width:90}),n.text(t[p].total,150,l),u+=t[p].total,l+=20;n.font("Helvetica-Bold",8),n.text(u,0,s,{align:"right"}),n.y=l,n.moveDown(.4),n.x=10,n.font("Helvetica-Bold",8);var m=n.y;n.text("VENTAS AL CREDITO: ",{align:"left"}),n.font("Helvetica",8),n.moveDown(.4),l=n.y;var v=0;for(p=0;p<o.length;p++)0<o[p].pagosVenta.length?0<o[p].pagosVenta[0].a_cuenta_anterior&&(n.text("No. "+o[p].factura,20,l),n.text(o[p].cliente.razon_social,60,l,{width:90}),n.text(o[p].pagosVenta[0].a_cuenta_anterior,150,l),v+=o[p].pagosVenta[0].a_cuenta_anterior,l+=20):o[p].a_cuenta&&(n.text("No. "+o[p].factura,20,l),n.text(o[p].cliente.razon_social,60,l,{width:90}),n.text(o[p].a_cuenta,150,l),v+=o[p].a_cuenta,l+=20);n.font("Helvetica-Bold",8),n.text(v,0,m,{align:"right"}),n.y=l,n.moveDown(.4),n.x=10;var f=n.y;n.text("COBROS REALIZADOS: ",{align:"left"}),n.font("Helvetica",8),n.moveDown(.4),l=n.y;for(p=0;p<i.length;p++)n.text("No. "+i[p].venta.factura,20,l),n.text(i[p].venta.cliente.razon_social,60,l,{width:90}),n.text(i[p].monto_pagado,150,l),d+=i[p].monto_pagado,l+=20;n.font("Helvetica-Bold",8),n.text(d,0,f,{align:"right"}),n.y=l,n.moveDown(.4),n.x=10,n.font("Helvetica-Bold",8),c=n.y,n.text("GASTOS: ",{align:"left"}),n.text(a.gastos,0,c,{align:"right"}),n.x=10,n.moveDown(.4),c=n.y,n.text("SALDO FINAL CAJA: ",{align:"left"}),n.text(Math.round(100*(a.saldo_inicial+u+v+d-a.gastos))/100,0,c,{align:"right"}),n.x=10,n.text("-----------------------------      -----------------------------",0,l+100,{align:"center"}),n.text("ENTREGUE CONFORME   RECIBI CONFORME",{align:"center"}),n.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),g.stop()},x.sumarMonto=function(){for(var e=0,a=0;a<x.ventas.length;a++)x.ventas[a].movimiento?x.ventas[a].movimiento.clase.nombre_corto!=x.diccionario.EGRE_FACTURACION&&x.ventas[a].movimiento.clase.nombre_corto!=x.diccionario.EGRE_PROFORMA||!x.ventas[a].activa||(e+=x.ventas[a].total):x.ventas[a].movimientoServicio.nombre_corto==x.diccionario.EGRE_SERVICIO&&x.ventas[a].activa&&(e+=x.ventas[a].total);return Math.round(100*e)/100},x.crearNuevaVenta=function(e){x.obtenerListaServiciosVentas(),x.blockerVenta=!0,x.venta=new l({id_empresa:x.usuario.id_empresa,id_usuario:x.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],pagado:0,cambio:0,despachado:!1,vendedor:null});var a=0;null==e?x.venta.sucursal=1==x.sucursales.length?x.sucursales[0]:null:(x.venta.sucursal=e.sucursal,a=e.almacen),x.venta.sucursal&&(x.obtenerAlmacenesActividades(x.venta.sucursal.id),null!=a&&a.id&&(x.venta.almacen=a)),x.venta.movimiento=x.movimientosEgreso[0],x.obtenerTipoEgreso(x.venta.movimiento);var t=new Date;x.venta.fechaTexto=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear(),x.venta.tipoPago=x.tiposPago[0],x.cambiarTipoPago(x.venta),x.editar_precio=!1,x.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},x.abrirPopup(x.idModalWizardCompraEdicion),angular.element(r).unbind("keydown"),angular.element(r).bind("keydown",function(e){115==e.keyCode&&x.venderProformaDirectoNormal(x.venta)}),x.enfocar("nit")},x.venderProformaDirectoNormal=function(t){0<t.detallesVenta.length?v(x.usuario.id_empresa,0).then(function(e){1==e.length||1<e.length?x.establecerCliente(e[0]):x.venta.cliente.razon_social=null,t.movimiento=$.grep(x.movimientosEgreso,function(e){return e.nombre_corto==x.diccionario.EGRE_PROFORMA})[0],t.tipoPago=$.grep(x.tiposPago,function(e){return e.nombre==x.diccionario.TIPO_PAGO_CONTADO})[0],x.obtenerTipoEgreso(t.movimiento),x.cambiarTipoPago(t);var a=new Date;t.fechaTexto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),fecha=a,t.pagado=t.total,t.cambio=0,x.usuario.empresa.usar_vencimientos=!1,x.guardarVenta(!0,t),x.venta.sucursal=t.sucursal}):x.$apply(function(){x.message="¡Debe agregar al menos un producto para realizar la transacción!",x.mostrarMensaje(x.message)})},x.verVenta=function(e){x.venta=e,x.abrirPopup(x.idModalWizardVentaVista)},x.cerrarPopupVista=function(){x.cerrarPopup(x.idModalWizardVentaVista)},x.cerrarPopupEdicion=function(){x.ocultarMensajesValidacion(),x.cerrarPopup(x.idModalWizardCompraEdicion)},x.calcularCambio=function(){x.esContado?(x.venta.cambio=Math.round(100*(x.venta.pagado-x.venta.total))/100,x.pagoMinimo=x.venta.total):(x.venta.cambio=0,x.pagoMinimo=0)},x.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},x.imprimirVenta=function(e){D(e.id,x.usuario.id_empresa).then(function(e){var a=e.venta;a.configuracion=e.configuracion,a.sucursal=e.sucursal,a.numero_literal=e.numero_literal,a.pieFactura=e.pieFactura,a.sucursalDestino=e.sucursalDestino;var t=new Date(a.fecha);a.fechaTexto=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear(),a.movimiento?H(a.movimiento.clase.nombre_corto,a,!1,x.usuario,!1):H(a.movimientoServicio.nombre_corto,a,!1,x.usuario,!1)})},x.modificarPrecio=function(){x.editar_precio=!0},x.establecerPrecio=function(){x.editar_precio=!1},x.obtenerFormatoFactura=function(){g.start(),h("FORM_IMP_FAC").then(function(e){x.formatosFactura=e.clases,g.stop()})},x.guardarVenta=function(e,a){if(e){x.ocultarMensajesValidacion();var t=new Date;if(a.fecha=new Date(x.convertirFecha(a.fechaTexto)),a.fecha.setHours(t.getHours()),a.fecha.setMinutes(t.getMinutes()),a.fecha.setSeconds(t.getSeconds()),g.start(),a.id){N(a).then(function(e){g.stop(),x.cerrarPopPupEdicion(),x.mostrarMensaje(e.mensaje),x.recargarItemsTabla()})}else{var o=a.movimiento.nombre_corto;a.usar_peps=x.usuario.empresa.usar_peps,a.$save(function(e){e.hasError?(g.stop(),x.crearNuevaVenta(e),x.mostrarMensaje(e.message)):(g.stop(),x.cerrarPopPupEdicion(),o==x.diccionario.EGRE_SERVICIO?H(o,e,!0,x.usuario,!1):(a.actualizarCotizacion&&K.update({id_cotizacion:a.cotizacion_id},{estado:"ACEPTADO"},function(e){},function(e){x.mostrarMensaje("Hubo un problema al guardar.")}),x.usuario.empresa.usar_vencimientos?(x.impresion={movimiento:o,res:e,al_guardar:!0,usuario:x.usuario},x.abrirPopup(x.idModalImpresionVencimiento)):H(o,e,!0,x.usuario,!1)),x.crearNuevaVenta(e),x.mostrarMensaje("Venta registrada exitosamente!"))},function(e){g.stop(),x.cerrarPopPupEdicion(),x.mostrarMensaje("Ocurrio un problema al momento de guardar!"),x.recargarItemsTabla()})}}},x.imprimirConVencimiento=function(){x.impresion.res.con_vencimiento=!0,H(x.impresion.movimiento,x.impresion.res,x.impresion.al_guardar,x.impresion.usuario,!1),x.cerrarPopup(x.idModalImpresionVencimiento)},x.imprimirSinVencimiento=function(){x.impresion.res.con_vencimiento=!1,H(x.impresion.movimiento,x.impresion.res,x.impresion.al_guardar,x.impresion.usuario,!1),x.cerrarPopup(x.idModalImpresionVencimiento)},x.imprimirVentaConVencimiento=function(e){D(e.id,x.usuario.id_empresa).then(function(e){var a=e.venta;a.con_vencimiento=!0,a.configuracion=e.configuracion,a.sucursal=e.sucursal,a.numero_literal=e.numero_literal,a.pieFactura=e.pieFactura,a.sucursalDestino=e.sucursalDestino;var t=new Date(a.fecha);a.fechaTexto=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear(),H(a.movimiento.clase.nombre_corto,a,!1,x.usuario,!1)})},x.cerrarPopPupEdicion=function(){x.cerrarPopup(x.idModalWizardCompraEdicion)},x.fechaATexto=function(e){return fech=new Date(e),e=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},x.obtenerAlmacenesEditar=function(a){x.almacenes=[];var e=$.grep(x.sucursales,function(e){return e.id==a})[0];x.almacenes=e.almacenes},x.buscarNit=function(a,e){13===a.which&&v(x.usuario.id_empresa,e).then(function(e){1==e.length||1<e.length?x.establecerCliente(e[0]):x.venta.cliente.razon_social=null,x.interceptarTecla(a,"razon_socialP",!0),x.interceptarTecla(a,"razon_socialP1",!0)});x.capturarInteraccion()},x.capturarInteraccion=function(){x.usuario.empresa.usar_pantalla_cliente&&I.emit("comenzarVenta",x.venta)},x.abrirPopupPanel=function(e,a,t,o,i){x.venta=new l({id_empresa:x.usuario.id_empresa,id_usuario:x.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],despachado:!1,sucursal:e,almacen:a,actividad:t,tipoPago:o,movimiento:i,vendedor:null}),x.obtenerGruposProductoEmpresa(),e||(x.venta.sucursal=x.sucursales[0]),x.venta.sucursal&&null==x.venta.almacen&&x.obtenerAlmacenesActividades(x.venta.sucursal.id),i||(x.venta.movimiento=x.movimientosEgreso[0]),x.obtenerTipoEgreso(x.venta.movimiento),o||(x.venta.tipoPago=x.tiposPago[0]),x.cambiarTipoPago(x.venta);var n=new Date;x.venta.fechaTexto=n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear(),x.abrirPopup(x.idModalPanelVentas),x.enfocar("nitP"),setTimeout(function(){aplicarDatePickers(),$("#venta-proforma").draggable({cursor:"crosshair",start:x.startDragging})},2e3),angular.element(r).unbind("keydown"),angular.element(r).bind("keydown",function(e){if(115==e.keyCode&&x.venderProformaDirecto(x.venta,!1),113==e.keyCode&&x.venderProformaDirecto(x.venta,!0),121==e.keyCode)if(e.preventDefault(),0<x.venta.detallesVenta.length){var a=new Date;x.horaActual=a.getHours()+":"+a.getMinutes()+":"+a.getSeconds(),x.abrirPopup(x.idModalPanelVentasCobro),x.enfocar("nitP1");var t=$("#movimiento").val("24");angular.element(t).triggerHandler("change"),angular.element($("#pagadoP").val(x.venta.total)).triggerHandler("change"),$("form").bind("keydown",function(e){if(13===e.keyCode)return!1})}else x.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")})},x.capturarPago=function(e,a,t){13==e.keyCode&&(x.guardarVentaPanel(a,t,!1),x.cerrarPopPupVentasCobro())},x.abrirPopPupVentasCobro=function(){if(0<x.venta.detallesVenta.length){var e=new Date;x.horaActual=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds(),x.abrirPopup(x.idModalPanelVentasCobro),x.enfocar("nitP1"),angular.element(select).triggerHandler("change"),angular.element($("#pagadoP").val(x.venta.total)).triggerHandler("change"),$("form").bind("keydown",function(e){if(13===e.keyCode)return!1})}else x.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")},x.cerrarPopPupVentasCobro=function(){x.cerrarPopup(x.idModalPanelVentasCobro)},x.cerrarPopupPanel=function(){x.cerrarPopup(x.idModalPanelVentas),x.recargarItemsTabla(),x.usuario.empresa.usar_pantalla_cliente&&I.emit("terminarVenta",x.venta.sucursal),angular.element(r).unbind("keydown")},x.clasificarGrupo=function(e){x.productosProcesados=a("filter")(x.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},x.cargarProductos=function(){V(x.usuario.id_empresa,x.venta.almacen.id,x.usuario.id).then(function(e){for(var a=0;a<e.length;a++)e[a].activar_inventario&&(e[a].inventario_disponible=x.obtenerInventarioTotal(e[a]));if(x.productos=e,angular.isDefined(c.productosProcesados)){x.productosProcesados=e;for(a=0;a<c.productosProcesados.length;a++)for(var t=0;t<x.productosProcesados.length;t++)c.productosProcesados[a].id==x.productosProcesados[t].id&&(x.productosProcesados[t].rankin=c.productosProcesados[a].rankin)}else x.productosProcesados=e;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},x.textorder="A<- ->Z",x.ordenarProductos=function(e){x.productosProcesados=a("orderBy")(x.productos,["nombre"],e),x.ordenProductos=!e,x.textorder=e?"A<- ->Z":"Z<- ->A",setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},x.filtrarProductos=function(e){x.productosProcesados=a("filter")(x.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},angular.isDefined(c.color)?x.color=c.color:(c.color={style:"red-style",stylebutton:"red-style-button"},x.color={style:"red-style",stylebutton:"red-style-button"}),x.cambiarColor=function(e,a){c.color={style:e,stylebutton:a},$("#dialog-panel-ventas .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-ventas .widget-main").addClass(e),$("#dialog-panel-ventas .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-ventas .widget-main .button-style").addClass(a)},x.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},x.dragged=!1,x.proformaClick=function(e){x.dragged||x.venderProformaDirecto(e,!1),x.dragged=!1},x.startDragging=function(){x.dragged=!0},x.venderProformaDirecto=function(t,o){0<t.detallesVenta.length?v(x.usuario.id_empresa,0).then(function(e){1==e.length||1<e.length?x.establecerCliente(e[0]):x.venta.cliente.razon_social=null,t.movimiento=$.grep(x.movimientosEgreso,function(e){return e.nombre_corto==x.diccionario.EGRE_PROFORMA})[0],t.tipoPago=$.grep(x.tiposPago,function(e){return e.nombre==x.diccionario.TIPO_PAGO_CONTADO})[0],x.obtenerTipoEgreso(t.movimiento),x.cambiarTipoPago(t);var a=new Date;t.fechaTexto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),fecha=a,t.pagado=t.total,t.cambio=0,x.guardarVentaPanel(!0,t,o)}):x.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")},x.calcularImporteDetalleVenta=function(e){var a,t;e.importe=Math.round(e.cantidad*e.precio_unitario*1e3)/1e3,a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,t=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+t-e.ice-e.excento},x.agregarDetalleVentaPanel=function(a){var e;if(x.cantidadInventario=0,a.activar_inventario)for(var t=0;t<a.inventarios.length;t++)x.cantidadInventario=x.cantidadInventario+a.inventarios[t].cantidad;for(var o=0,i=!1;o<x.venta.detallesVenta.length&&!i;)x.venta.detallesVenta[o].producto.id==a.id&&(a.activar_inventario?x.venta.detallesVenta[o].cantidad+1<=x.cantidadInventario?x.venta.detallesVenta[o].cantidad=x.venta.detallesVenta[o].cantidad+1:x.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+x.cantidadInventario+"!"):x.venta.detallesVenta[o].cantidad=x.venta.detallesVenta[o].cantidad+1,i=!0,e=x.venta.detallesVenta[o]),o++;if(i)x.calcularImporteDetalleVenta(e);else if(a.activar_inventario)if(1<=x.cantidadInventario){var n=0;x.venta.cliente.id&&x.venta.cliente.tipoPrecioVenta&&x.usuario.empresa.usar_tipo_precio&&0<a.tiposPrecio.length?a.tiposPrecio.forEach(function(e){n=e.id_tipo_precio==x.venta.cliente.tipoPrecioVenta.id?e.precio_unitario:a.precio_unitario}):n=a.precio_unitario,e={producto:a,precio_unitario:n,inventario_disponible:x.cantidadInventario,costos:a.inventarios,cantidad:1,descuento:a.descuento,tipo_descuento:0<a.descuento,recargo:0,ice:0,excento:0,tipo_recargo:!1},x.venta.detallesVenta.push(e),x.calcularImporteDetalleVenta(e)}else x.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+x.cantidadInventario+"!");else{n=0;x.venta.cliente.id&&x.venta.cliente.tipoPrecioVenta&&x.usuario.empresa.usar_tipo_precio&&0<a.tiposPrecio.length?a.tiposPrecio.forEach(function(e){n=e.id_tipo_precio==x.venta.cliente.tipoPrecioVenta.id?e.precio_unitario:a.precio_unitario}):n=a.precio_unitario,e={producto:a,precio_unitario:n,inventario_disponible:x.cantidadInventario,costos:a.inventarios,cantidad:1,descuento:a.descuento,tipo_descuento:0<a.descuento,recargo:0,ice:0,excento:0,tipo_recargo:!1},x.venta.detallesVenta.push(e),x.calcularImporteDetalleVenta(e)}x.sumarTotal(),x.sumarTotalImporte(),x.calcularSaldo(),x.capturarInteraccion(),a.rankin+=1;var r=x.productosProcesados.indexOf(a);x.productosProcesados[r]=a,c.productosProcesados=x.productosProcesados,a.activar_inventario&&(a.inventario_disponible=x.cantidadInventario-e.cantidad)},x.disminuirDetalleVenta=function(e){var a=x.productosProcesados.indexOf(e.producto);1==e.cantidad?x.eliminarDetalleVentaPanel(e):(e.cantidad=e.cantidad-1,x.productosProcesados[a].inventario_disponible=x.productosProcesados[a].inventario_disponible+1,x.calcularImporteDetalleVenta(e),x.sumarTotal(),x.sumarTotalImporte(),x.calcularSaldo(),x.capturarInteraccion())},x.guardarVentaPanel=function(e,a,t){if(e){x.usuario.empresa.usar_pantalla_cliente&&I.emit("terminarVenta",a.sucursal),x.ocultarMensajesValidacion();var o=new Date;if(a.fecha=new Date(x.convertirFecha(a.fechaTexto)),a.fecha.setHours(o.getHours()),a.fecha.setMinutes(o.getMinutes()),g.start(),a.id)l.update({idCompra:compra.id},compra,function(e){g.stop(),x.cerrarPopPupEdicion(),x.mostrarMensaje("Actualizado Exitosamente!"),x.recargarItemsTabla()});else{var i=a.movimiento.nombre_corto;a.$save(function(e){g.stop(),e.hasError?(g.stop(),x.mostrarMensaje(e.message),x.venta.almacen.id=a.almacen.id,x.abrirPopupPanel(a.sucursal,a.almacen,a.actividad,a.tipoPago,a.movimiento)):(H(i,e,!0,x.usuario,t),x.mostrarMensaje("Venta registrada exitosamente!"),x.cargarProductos(),x.abrirPopupPanel(a.sucursal,a.almacen,a.actividad,a.tipoPago,a.movimiento),x.enfocar("nitP"))},function(e){g.stop(),x.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}}},x.mostrarConfirmacionEliminacionVenta=function(e){x.venta=new l(e),x.abrirPopup(x.idModalConfirmacionEliminacionVenta)},x.cerrarConfirmacionEliminacionVenta=function(){x.cerrarPopup(x.idModalConfirmacionEliminacionVenta)},x.eliminarVenta=function(e){(g.start(),x.cerrarConfirmacionEliminacionVenta(),e.movimientoServicio)?W(e).then(function(e){x.mostrarMensaje(e.mensaje)}):e.$delete();x.mostrarMensaje("Anulado exitosamente!"),x.recargarItemsTabla(),g.stop()},x.abrirPopupInventario=function(){x.abs=r.Math.abs,x.itemsPorPagina=10,x.paginaActual=1,x.columna="nombre",x.direccion="asc",x.cantidadInv="0",x.textoBusqueda="",x.venta.almacen&&(x.almacenBusqueda=x.venta.almacen,x.buscarInventarios(x.almacenBusqueda.id,x.paginaActual,x.itemsPorPagina,x.textoBusqueda,x.columna,x.direccion,x.cantidadInv)),x.abrirPopup(x.idModalInventario)},x.barcodeScanned=function(e){x.search=e,x.filtrarProductos(e)},x.limpiarBusqueda=function(){x.search="",x.filtrarProductos()},x.buscarInventarios=function(e,a,t,o,i,n,r){g.start(),x.itemsPorPagina=t,""==o||null==o?o=0:x.textoBusqueda=o,x.paginaActual=a,s(x.usuario.id_empresa,e,a,t,o,i,n,r,void 0,x.usuario.id).then(function(e){for(var a=e.productos,t=0;t<a.length;t++){a[t].fecha_vencimiento=new Date(a[t].fecha_vencimiento),a[t].cantidad_total=a[t].cantidad}x.paginas=[];for(t=1;t<=e.paginas;t++)x.paginas.push(t);x.productos=a,g.stop()})},x.clasificarColumna=function(e){x.columna==e?"asc"==x.direccion?(x.direccion="desc",$("#"+e+"p").removeClass("fa-caret-up"),$("#"+e+"p").addClass("fa-caret-down")):(x.direccion="asc",$("#"+e+"p").removeClass("fa-caret-down"),$("#"+e+"p").addClass("fa-caret-up")):(x.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+e+"p").addClass("fa-caret-up"),$("#"+e+"p").removeClass("fa-sort")),x.columna=e,x.buscarInventarios(x.almacenBusqueda.id,x.paginaActual,x.itemsPorPagina,x.textoBusqueda,x.columna,x.direccion,x.cantidadInv)},x.verificarPulso=function(e,a){13===e.keyCode&&(x.textoBusqueda=a,x.almacenBusqueda&&x.buscarInventarios(x.almacenBusqueda.id,1,x.itemsPorPagina,x.textoBusqueda,x.columna,x.direccion,x.cantidadInv))},x.abrirModalVerificarCuenta=function(e,a){x.dato=e,x.tipoDatosPermiso=a,x.abrirPopup(x.IdModalVerificarCuenta)},x.cerrarModalVerificarCuenta=function(){x.cerrarPopup(x.IdModalVerificarCuenta)},x.verificarCuentaAdmin=function(e){F.save({id_empresa:x.usuario.id_empresa},e,function(e){e.type?(x.mostrarMensaje(e.message),"venta"==x.tipoDatosPermiso&&x.modificarVenta(x.dato),x.cerrarModalVerificarCuenta()):x.mostrarMensaje(e.message)})},x.abrirReporteProductos=function(){null!=x.filtro?(x.filtro.razon_social?x.razon_social=x.filtro.razon_social:x.razon_social=0,x.filtro.usuario?x.usuario_elegido=x.filtro.usuario:x.usuario_elegido=0,x.filtro.sucursal?x.sucursal=x.filtro.sucursal:x.sucursal=0,x.filtro.nit?x.nit=x.filtro.nit:x.nit=0,x.filtro.monto?x.monto=x.filtro.monto:x.monto=0,x.filtro.tipo_pago?x.tipo_pago=x.filtro.tipo_pago:x.tipo_pago=0,x.filtro.transaccion?x.transaccion=x.filtro.transaccion:x.transaccion=0,x.filtro.estado?x.estado=x.filtro.estado:x.estado=0):(x.razon_social=0,x.usuario_elegido=0,x.sucursal=0,x.nit=0,x.monto=0,x.tipo_pago=0,x.transaccion=0,x.estado=0);for(var e=0;e<x.sucursales.length;e++)x.sucursal?x.sucursal==x.sucursales[e].id?x.sucursal=x.sucursales[e].nombre:0==x.sucursal&&(x.sucursal="Todos"):x.sucursal="Todos";if(x.razonSocial?x.razonSocial:x.razonSocial="Todos",void 0===x.fechaInicioTexto&&void 0===x.fechaFinTexto)x.mostrarMensaje("Ingrese primero las fechas !");else{x.fechaInicioTexto,x.fechaFinTexto;x.obtenerDetalles(),x.abrirPopup(x.modalReportesProductos)}},x.obtenerDetalles=function(){x.paginator=M(),x.paginator.column="nombre",x.paginator.direccion="asc",x.filtroDetallesProducto={sucursalUsuario:x.sucursalesUsuario,inicio:x.fechaInicioTexto,fin:x.fechaFinTexto,sucursal:x.sucursal},x.paginator.callBack=x.filtrarDetalles,x.paginator.getSearch("",x.filtroDetallesProducto,null)},x.filtrarDetalles=function(){g.start(),u(x.paginator).then(function(e){x.ventasPopUp=e.ventas,x.paginator.setPages(e.paginas),g.stop()})},x.generarExcelVentasMensuales=function(){if(!0===x.verDetalle){g.start(),inicio=new Date(x.convertirFecha(x.fechaInicioTexto)),fin=new Date(x.convertirFecha(x.fechaFinTexto)),null!=x.filtro&&x.filtro.sucursal?x.sucursal=x.filtro.sucursal:x.sucursal=0,A(x.usuario.id_empresa,x.sucursal,inicio,fin).then(function(e){var a=JSON.parse(e.detallesVenta),t=[["FECHA DE LA FACTURA","N° DE LA FACTURA","N° DE AUTORIZACION","NIT/CI CLIENTE","NOMBRE O RAZON SOCIAL","UBICACION CLIENTE","CODIGO","DETALLE","UNIDAD","GRUPO","CANTIDAD","PU","TOTAL","IMPORTE ICE/IEHD/TASAS","EXPORTACIONES Y OPERACIONES EXENTAS","VENTAS GRAVADAS A TASA CERO","SUBTOTAL","DESCUENTOS, BONIFICACIONES Y REBAJAS OBTENIDAS","IMPORTE BASE PARA DEBITO FISCAL","DEBITO FISCAL","SUCURSAL","USUARIO"]];x.usuario.empresa.usar_vencimientos&&(t[0].push("FECHA VENCIMIENTO"),t[0].push("LOTE")),t[0].push("VENDEDOR");for(var o=0;o<a.length;o++){var i=[];a[o].venta.fecha=new Date(a[o].venta.fecha),i.push(a[o].venta.fecha),i.push(a[o].venta.factura),i.push(a[o].venta.autorizacion),i.push(a[o].venta.cliente.nit),i.push(a[o].venta.cliente.razon_social),i.push(a[o].venta.cliente.ubicacion_geografica),i.push(a[o].producto.codigo),i.push(a[o].producto.nombre),i.push(a[o].producto.unidad_medida),a[o].producto.grupo?i.push(a[o].producto.grupo.nombre):i.push(""),i.push(a[o].cantidad),i.push(a[o].precio_unitario),i.push(a[o].importe),i.push(a[o].ice),i.push(0),i.push(0),i.push(a[o].importe-a[o].ice);var n=a[o].importe-a[o].ice-a[o].excento+a[o].recargo;i.push(n),i.push(a[o].total),i.push(Math.round(.13*a[o].total*100)/100),i.push(a[o].venta.almacen.sucursal.nombre),i.push(a[o].venta.usuario.nombre_usuario),x.usuario.empresa.usar_vencimientos&&(a[o].inventario?(a[o].inventario.fecha_vencimiento=new Date(a[o].inventario.fecha_vencimiento),i.push(a[o].inventario.fecha_vencimiento),i.push(a[o].inventario.lote)):null!=a[o].lote?(a[o].fecha_vencimiento=new Date(a[o].fecha_vencimiento),i.push(a[o].fecha_vencimiento),i.push(a[o].lote)):(i.push(""),i.push(""))),i.push(a[o].venta.vendedor?a[o].venta.vendedor.persona.nombre_completo:""),t.push(i)}var r="SheetJS",c=new Workbook,s=sheet_from_array_of_arrays(t);c.SheetNames.push(r),c.Sheets[r]=s;var l=XLSX.write(c,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"VENTAS-MENSUALES.xlsx"),g.stop()})}else{g.start(),inicio=new Date(x.convertirFecha(x.fechaInicioTexto)),fin=new Date(x.convertirFecha(x.fechaFinTexto)),x.paginator.itemsPerPage=0;inicio,fin;u(x.paginator).then(function(e){x.ventasExcelDetalle=e.ventas;var a=[];a.push(["Producto","Unidad Medida","Cantidad","Monto"]);for(var t=0;t<x.ventasExcelDetalle.length;t++)columns=[],columns.push(x.ventasExcelDetalle[t].nombre),columns.push(x.ventasExcelDetalle[t].unidad_medida),columns.push(x.ventasExcelDetalle[t].cantidad),columns.push(x.ventasExcelDetalle[t].total),a.push(columns);var o="SheetJS",i=new Workbook,n=sheet_from_array_of_arrays(a);i.SheetNames.push(o),i.Sheets[o]=n;var r=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"VENTAS-DETALLE-PRODUCTO.xlsx"),g.stop()})}},x.generarPdfVentasMensuales=function(){if(!0===x.verDetalle){g.start(),inicio=new Date(x.convertirFecha(x.fechaInicioTexto)),fin=new Date(x.convertirFecha(x.fechaFinTexto)),null!=x.filtro&&x.filtro.sucursal?x.sucursal=x.filtro.sucursal:x.sucursal=0;var d=[inicio,fin,x.sucursal];A(x.usuario.id_empresa,x.sucursal,inicio,fin).then(function(e){var a=JSON.parse(e.detallesVenta),t=new PDFDocument({compress:!1,margin:10}),o=t.pipe(blobStream());t.font("Helvetica",8);var i=150,n=0,r=1;x.dibujarCabeceraPDFVentasMensuales(t,e,d,r);for(var c=0;c<a.length&&n<=15;c++)t.rect(40,i-10,540,40).stroke(),t.font("Helvetica",8),a[c].venta.fecha=new Date(a[c].venta.fecha),t.text(a[c].venta.fecha.getDate()+"/"+(a[c].venta.fecha.getMonth()+1)+"/"+a[c].venta.fecha.getFullYear().toString().substr(-2),45,i),t.text(a[c].venta.factura?a[c].venta.factura:"",80,i),t.font("Helvetica",7),t.text(a[c].venta.cliente.razon_social,115,i-2,{width:80}),t.text(a[c].producto.nombre,205,i-2,{width:80}),t.font("Helvetica",8),t.text(a[c].cantidad,300,i,{width:50}),t.text(a[c].producto.unidad_medida,330,i,{width:50}),x.usuario.empresa.usar_vencimientos&&a[c].inventario&&(a[c].inventario.fecha_vencimiento=new Date(a[c].inventario.fecha_vencimiento),t.text(a[c].inventario.fecha_vencimiento.getDate()+"/"+(a[c].inventario.fecha_vencimiento.getMonth()+1)+"/"+a[c].inventario.fecha_vencimiento.getFullYear().toString().substr(-2),385,i),t.text(a[c].inventario.lote,435,i)),t.text(a[c].descuento,475,i),t.text(a[c].recargo,505,i),t.text(a[c].total,535,i),i+=40,15!=++n&&c+1!=a.length||c+1==a.length||(t.addPage({margin:0,bufferPages:!0}),i=150,n=0,r+=1,x.dibujarCabeceraPDFVentasMensuales(t,e,d,r),t.font("Helvetica",8));var s=new Date,l=s.getMinutes();l<10&&(l="0"+l),t.text("USUARIO: "+x.usuario.nombre_usuario,45,i),t.text("IMPRESION : "+s.getDate()+"/"+(s.getMonth()+1)+"/"+s.getFullYear()+" Hr. "+s.getHours()+":"+l,175,i),t.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),g.stop()})}else{g.start(),inicio=new Date(x.convertirFecha(x.fechaInicioTexto)),fin=new Date(x.convertirFecha(x.fechaFinTexto));d=[inicio,fin];u(x.paginator).then(function(e){x.ventaSinDetalle=e.ventas;var a=new PDFDocument({compress:!1,margin:10}),t=a.pipe(blobStream());a.font("Helvetica",8);var o=150,i=0,n=1,r=Math.ceil(x.ventaSinDetalle.length/20);x.dibujarCabeceraPDFVentasMensualesSinDetalle(a,x.ventaSinDetalle,d,n,r);for(var c=0,s=0;s<x.ventaSinDetalle.length&&i<=20;s++)c=s+1,a.font("Helvetica",8),a.text(c,45,o),a.font("Helvetica",8),a.text(x.ventaSinDetalle[s].nombre,65,o),a.font("Helvetica",8,{align:"center"}),a.text(x.ventaSinDetalle[s].unidad_medida,390,o),a.font("Helvetica",8),a.text(x.ventaSinDetalle[s].cantidad,470,o),a.font("Helvetica",8),a.text(x.ventaSinDetalle[s].total,500,o),o+=25,20!=++i&&s+1!=x.ventaSinDetalle.length||s+1==x.ventaSinDetalle.length||(a.addPage({margin:0,bufferPages:!0}),o=150,i=0,n+=1,x.dibujarCabeceraPDFVentasMensualesSinDetalle(a,x.ventaSinDetalle,d,n,r),a.font("Helvetica",8));var l=new Date,u=l.getMinutes();u<10&&(u="0"+u),a.text("USUARIO: "+x.usuario.nombre_usuario,45,750),a.text("IMPRESION : "+l.getDate()+"/"+(l.getMonth()+1)+"/"+l.getFullYear()+" Hr. "+l.getHours()+":"+u,175,750),a.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),g.stop()})}},x.dibujarCabeceraPDFVentasMensuales=function(e,a,t,o){e.font("Helvetica-Bold",12),e.text("REPORTE DE VENTAS",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+t.inicio,-70,40,{align:"center"}),e.text("Hasta "+t.fin,70,40,{align:"center"}),e.text("FOLIO "+o,550,25),e.rect(40,60,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("NOMBRE O RAZÓN SOCIAL : ",65,75),e.text("NIT : ",440,75),e.font("Helvetica",8),e.text(a.empresa.razon_social,195,75),e.text(a.empresa.nit,460,75),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,110,{width:40}),e.text("Nº De Nota",80,110,{width:30}),e.text("Cliente",115,110),e.text("Producto",205,110),e.text("Cant.",290,110),e.text("Unidad",330,110),e.text("Fecha Venc",385,110,{width:30}),e.text("Lote",435,110,{width:35}),e.text("Desc.",470,110),e.text("Rec.",500,110),e.text("Total",535,110)},x.dibujarCabeceraPDFVentasMensualesSinDetalle=function(e,a,t,o,i){e.font("Helvetica-Bold",12),e.text("REPORTE DE VENTAS POR PRODUCTOS SIN DETALLE",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+t.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+t.fechaFinTexto,70,40,{align:"center"}),e.text("FOLIO "+o,550,25),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("N°",45,110),e.text("Producto",65,110),e.text("Unidad Medida.",370,110),e.text("Cantidad",450,110),e.text("Monto",500,110),e.font("Helvetica",8),e.text("Pagina "+o+" de "+i,500,750)},x.PopoverReportesRapido={templateUrl:"PopoverReportesRapido.html",title:"Reportes Rapidos",isOpen:!1},x.ImprimirSimpleReporte=function(e){g.start();var a;a=x.usuario.id_empresa,inicio=new Date(x.convertirFecha(x.fechaInicioTexto)),fin=new Date(x.convertirFecha(x.fechaFinTexto)),n(inicio,fin,a,e).then(function(e){x.detallePorProducto=e;var a=new PDFDocument({compress:!1,margin:10}),t=a.pipe(blobStream());a.font("Helvetica",8);var o=150,i=0,n=1,r=Math.ceil(x.detallePorProducto.length/20);x.dibujarCabeceraPDFDetalleProductos(a,e,n,r);for(var c=0,s=0;s<x.detallePorProducto.length&&i<=20;s++)c=s+1,a.font("Helvetica",8),a.text(c,45,o),a.font("Helvetica",8),a.text(x.detallePorProducto[s].venta.factura,65,o,{width:150}),a.font("Helvetica",8),x.detallePorProducto[s].venta.cliente&&(a.font("Helvetica",8),a.text(x.detallePorProducto[s].venta.cliente.razon_social,120,o)),a.font("Helvetica",8),a.text(x.detallePorProducto[s].cantidad,470,o),a.font("Helvetica",8),a.text(x.detallePorProducto[s].total,520,o),o+=30,20!=++i&&s+1!=x.detallePorProducto.length||s+1==x.detallePorProducto.length||(a.addPage({margin:0,bufferPages:!0}),o=150,i=0,n+=1,x.dibujarCabeceraPDFDetalleProductos(a,e,n,r),a.font("Helvetica",8));var l=new Date,u=l.getMinutes();u<10&&(u="0"+u),a.text("USUARIO: "+x.usuario.nombre_usuario,45,750),a.text("IMPRESION : "+l.getDate()+"/"+(l.getMonth()+1)+"/"+l.getFullYear()+" Hr. "+l.getHours()+":"+u,175,750),a.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),g.stop()})},x.dibujarCabeceraPDFDetalleProductos=function(e,a,t,o){e.font("Helvetica-Bold",12),e.text("DETALLE DEL PRODUCTO",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+x.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+x.fechaFinTexto,70,40,{align:"center"}),e.font("Helvetica-Bold",8),e.text(a[0].producto.nombre,0,55,{align:"center"}),e.font("Helvetica-Bold",8),e.text("Codigo: "+a[0].producto.codigo,45,65),e.font("Helvetica-Bold",8),e.text("Unidad Medida: "+a[0].producto.unidad_medida,45,75),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",45,110),e.text("N° Factura",65,110),e.text("Razon Social",120,110),e.text("Cantidad",450,110),e.text("Monto",520,110),e.font("Helvetica",8),e.text("Pagina "+t+" de "+o,500,750)},x.abrirReporteGraficoProductos=function(){x.abrirPopup(x.modelGraficaProductos)},x.cerrarReporteGraficoProductos=function(){x.cerrarPopup(x.modelGraficaProductos)},x.graficarProductos=function(e){var i=e;g.start();var n=[];inicio=new Date(x.convertirFecha(x.fechaInicioTexto)),fin=new Date(x.convertirFecha(x.fechaFinTexto)),x.paginator.itemsPerPage=0,u(x.paginator).then(function(e){x.datosProductosGrafico=e.ventas.sort(function(e,a){return a.total-e.total});for(var a=0;a<x.datosProductosGrafico.length;a++){var t=[];t.push(x.datosProductosGrafico[a].nombre),t.push(x.datosProductosGrafico[a].unidad_medida),t.push(x.datosProductosGrafico[a].cantidad),t.push(x.datosProductosGrafico[a].total),n.push(t)}var o=[];contenido=n.map(function(e,a){10<=o.length||o.push(e)}),x.reporteGrafico(o,i),g.stop()})},x.reporteGrafico=function(e,a){x.abrirReporteGraficoProductos();var t=[];if(0!=e.length&&(t=e.map(function(e,a){return{label:e[0],y:e[3]}})),0==a)new CanvasJS.Chart("tablaReportes",{animationEnabled:!0,exportEnabled:!0,theme:"light1",title:{text:""},data:[{type:"column",indexLabelFontSize:10,dataPoints:t}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"white",labelMaxWidth:50,labelWrap:!0,interval:1}}).render();else if(1==a){new CanvasJS.Chart("tablaReportes",{animationEnabled:!0,exportEnabled:!0,theme:"light2",title:{text:""},data:[{type:"pie",startAngle:25,toolTipContent:"<b>{label}</b>: {y} Bs.",showInLegend:"true",legendText:"{label}",indexLabelFontSize:10,indexLabel:"{label} - {y} Bs.",dataPoints:t}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"black",labelMaxWidth:50,labelWrap:!0,interval:1}}).render()}},x.abrirReporteGraficoEmpresa=function(){x.abrirPopup(x.modelGraficaEmpresas)},x.cerrarReporteGraficoEmpresa=function(){x.cerrarPopup(x.modelGraficaEmpresas)},x.graficarEmpresa=function(e){var i=e;g.start();var n=[];inicio=new Date(x.convertirFecha(x.fechaInicioTexto)),fin=new Date(x.convertirFecha(x.fechaFinTexto)),x.paginator.itemsPerPage=0,q(x.paginator).then(function(e){x.datosReporteGraficoEmpresa=e.detalle.sort(function(e,a){return a.total-e.total});for(var a=0;a<x.datosReporteGraficoEmpresa.length;a++){var t=[];t.push(x.datosReporteGraficoEmpresa[a].razon_social),t.push(x.datosReporteGraficoEmpresa[a].total),n.push(t)}var o=[];n.map(function(e,a){10<=o.length||o.push(e)}),x.reporteGraficoEmpresas(o,i),g.stop()})},x.reporteGraficoEmpresas=function(e,a){x.abrirReporteGraficoEmpresa();var t=[];if(0!=e.length&&(t=e.map(function(e,a){return{label:e[0],y:e[1]}})),0==a)new CanvasJS.Chart("tablaReportesEmpresas",{animationEnabled:!0,exportEnabled:!0,theme:"light1",title:{text:""},data:[{type:"column",indexLabelFontSize:10,dataPoints:t}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"white",labelMaxWidth:50,labelWrap:!0,interval:1}}).render();else if(1==a){new CanvasJS.Chart("tablaReportesEmpresas",{animationEnabled:!0,exportEnabled:!0,theme:"light2",title:{text:""},data:[{type:"pie",startAngle:25,toolTipContent:"<b>{label}</b>: {y} Bs.",showInLegend:"true",legendText:"{label}",indexLabelFontSize:10,indexLabel:"{label} - {y} Bs.",dataPoints:t}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"black",labelMaxWidth:50,labelWrap:!0,interval:1}}).render()}},x.cerrarReporteProductos=function(){x.cerrarPopup(x.modalReportesProductos)},x.verDetalle=!0,x.conDetalle=function(){!0===x.verDetalle?x.verDetalle=!1:!1===x.verDetalle&&(x.verDetalle=!0)},x.abrirReporteEmpresas=function(){x.fechaInicioTexto,x.fechaFinTexto,x.idEmpresa=x.usuario.id_empresa,null!=x.filtro&&x.filtro.sucursal?x.sucursalSelec=x.filtro.sucursal:x.sucursalSelec=0;for(var e=0;e<x.sucursales.length;e++)x.sucursal?x.sucursal==x.sucursales[e].id?x.sucursal=x.sucursales[e].nombre:0==x.sucursal&&(x.sucursal="Todos"):x.sucursal="Todos";x.razonSocial?x.razonSocial:x.razonSocial="Todos",void 0===x.fechaInicioTexto&&void 0===x.fechaFinTexto?x.mostrarMensaje("Ingrese primero las fechas !"):(x.obtenerDetallesEmpresa(),x.abrirReportePorEmpresa())},x.obtenerDetallesEmpresa=function(){x.paginator=M(),x.paginator.column="razon_social",x.paginator.direccion="asc",x.filtroDetallesProducto={idsSucursales:x.sucursalesUsuario,inicio:x.fechaInicioTexto,fin:x.fechaFinTexto,sucursal:x.sucursalSelec,idEmpresa:x.idEmpresa},x.paginator.callBack=x.filtroDetalleEmpresa,x.paginator.getSearch("",x.filtroDetallesProducto,null)},x.filtroDetalleEmpresa=function(){g.start(),q(x.paginator).then(function(e){x.detalleEmpresa=e.detalle,x.paginator.setPages(e.paginas),g.stop()})},x.imprimirSimpleReporteEmpresa=function(e){g.start();var a;a=x.usuario.id_empresa,inicio=new Date(x.convertirFecha(x.fechaInicioTexto)),fin=new Date(x.convertirFecha(x.fechaFinTexto)),d(inicio,fin,a,e).then(function(e){x.detallePorEmpresa=e;var a=new PDFDocument({compress:!1,margin:10}),t=a.pipe(blobStream());a.font("Helvetica",8);var o=150,i=0,n=1,r=Math.ceil(x.detallePorEmpresa.length/20);x.dibujarCabeceraPDFDetalleEmpresas(a,e,n,r);for(var c=0,s=0;s<x.detallePorEmpresa.length&&i<=20;s++){columns=[],x.producto=x.detallePorEmpresa[s];for(var l=0;l<x.producto.detallesVenta.length;l++)x.DetalleVenta=x.producto.detallesVenta[l],a.font("Helvetica"),c=s+1,a.text(c,45,o),a.text(x.DetalleVenta.venta.factura,65,o),a.text(x.producto.nombre,120,o),a.text(x.DetalleVenta.cantidad,465,o),a.text(x.DetalleVenta.total,520,o),o+=30,20!=++i&&l+1!=x.detallePorEmpresa.length||l+1==x.detallePorEmpresa.length||(a.addPage({margin:0,bufferPages:!0}),o=150,i=0,n+=1,x.dibujarCabeceraPDFDetalleProductos(a,e,n,r),a.font("Helvetica",8))}var u=new Date,d=u.getMinutes();d<10&&(d="0"+d),a.text("USUARIO: "+x.usuario.nombre_usuario,45,750),a.text("IMPRESION : "+u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear()+" Hr. "+u.getHours()+":"+d,175,750),a.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),g.stop()})},x.dibujarCabeceraPDFDetalleEmpresas=function(e,a,t,o){e.font("Helvetica-Bold",12),e.text("VENTAS",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+x.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+x.fechaFinTexto,70,40,{align:"center"}),e.font("Helvetica-Bold",8),e.text(a[0].detallesVenta[0].venta.cliente.razon_social,0,55,{align:"center"}),e.font("Helvetica-Bold",8),e.text("Codigo: "+a[0].codigo,45,65),e.font("Helvetica-Bold",8),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",45,110),e.text("N° Factura",65,110),e.text("Producto",120,110),e.text("Cantidad",450,110),e.text("Monto",520,110),e.font("Helvetica",8),e.text("Pagina "+t+" de "+o,500,750)},x.abrirReportePorEmpresa=function(){x.abrirPopup(x.modalReportesEmpresas)},x.cerrarReportePorEmpresa=function(){x.cerrarPopup(x.modalReportesEmpresas)},x.modificarVenta=function(e){$("#modal-wizard-venta-edicion").dialog({closeOnEscape:!1}),x.blockerVenta=!0,x.venta=new l(e),x.venta.editable=!0,x.venta.movimientoActual=Object.assign({},e.movimiento);var a;x.venta.sucursal=e.almacen.sucursal,a=e.almacen,x.venta.sucursal&&(x.obtenerAlmacenesActividades(x.venta.sucursal.id),a.id&&(x.venta.almacen=a)),x.venta.detallesVenta.forEach(function(e){e.eliminado=!1}),x.venta.movimiento=x.venta.movimiento.clase,x.obtenerTipoEgreso(x.venta.movimiento);var t=new Date(x.venta.fecha);x.venta.fechaTexto=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear(),x.cambiarTipoPago(x.venta),x.editar_precio=!1,x.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},x.abrirPopup(x.idModalWizardCompraEdicion),angular.element(r).unbind("keydown"),angular.element(r).bind("keydown",function(e){115==e.keyCode&&x.venderProformaDirectoNormal(x.venta)}),x.venta.id_empresa=x.usuario.id_empresa,x.enfocar("nit")},x.abrirmodalServicioVenta=function(){x.servicio={habilitado:!0,eliminado:!1},x.abrirPopup(x.modalServicioVenta)},x.cerrarmodalServicioVenta=function(){x.cerrarPopup(x.modalServicioVenta)},x.abrirModalImportacionVentaServicio=function(){x.venta={sucursal:"",actividad:"",fecha:"",movimiento:{nombre_corto:"SERV"}},x.obtenerListaServiciosVentas(),x.abrirPopup(x.modelImportacionVentaServicio)},x.cerrarModalImportacionVentaServicio=function(){x.cerrarPopup(x.modelImportacionVentaServicio)},x.obtenerListaServiciosVentas=function(){Y(x.usuario.id_empresa).then(function(e){x.serviciosVentas=e.servicios})},x.establecerServicioSeleccionado=function(e){x.establecerServicio(e),x.cerrarmodalServicioVenta()},x.establecerServicio=function(e){x.detalleVenta={centroCosto:null,servicio:e,importe:e.precio,descuento:e.descuento,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},x.enfocar("cantidad")},x.agregarServicioVenta=function(e){e.id||e.edit||x.serviciosVentas.push(e),x.servicio={habilitado:!0,eliminado:!1}},x.modificarServicioVenta=function(e){x.servicio=e,x.servicio.edit=!0},x.cancelarEdicionVentaServicio=function(e){x.servicio={habilitado:!0,eliminado:!1}},x.guardarServiciosVenta=function(e){J(x.usuario.id_empresa,e).then(function(e){x.obtenerListaServiciosVentas(),x.mostrarMensaje(e.mensaje),x.cerrarmodalServicioVenta()})},x.verificarCamposForimImpServ=function(e){e.activ.$touched=!!e.activ.$invalid,e.fechaSerImp.$touched=!!e.fechaSerImp.$invalid,e.sucServImp.$touched=!!e.sucServImp.$invalid},x.subirExcelVentasServicios=function(e){var a,t,o=e.target.files;for(t=o[a=0];a!=o.length;++a){var i=new FileReader;t.name;i.onload=function(e){var a=e.target.result,t=XLSX.read(a,{type:"binary"}),o=t.SheetNames[0],i=2,n=0,r=2,c=t.Sheets[o],s=[],l=[],u=[];do{r=2;var d={tipoPago:{},detallesVenta:[],cliente:{},fechaTexto:x.venta.fecha,sucursal:x.venta.sucursal,actividad:x.venta.actividad},p=null!=c["A"+i]&&""!=c["A"+i]?c["A"+i].v.toString():null;if(2==i)var m=null!=c["A"+i]&&""!=c["A"+i]?c["A"+i].v.toString():null;else m=null!=c["A"+(i-1)]&&""!=c["A"+(i-1)]?c["A"+(i-1)].v.toString():null;d.cliente.nit=null!=c["B"+i]&&""!=c["B"+i]?c["B"+i].v.toString():null,d.cliente.razon_social=null!=c["C"+i]&&""!=c["C"+i]?c["C"+i].v.toString():null;var v=!1;if(0<u.length){for(n=0;n<u.length;n++){var f=u[n].nit;null!=d.cliente.nit&&f==d.cliente.nit&&(v=!0)}v||u.push(d.cliente)}else u.push(d.cliente);d.vendedor=null!=c["D"+i]&&""!=c["D"+i]?c["D"+i].v.toString():null,d.observacion=null!=c["E"+i]&&""!=c["E"+i]?c["E"+i].v.toString():null,d.tipoPago.nombre=null!=c["F"+i]&&""!=c["F"+i]?c["F"+i].v.toString():null,d.dias_credito=null!=c["G"+i]&&""!=c["G"+i]?parseInt(c["G"+i].v.toString()):null,d.a_cuenta=null!=c["H"+i]&&""!=c["H"+i]?parseFloat(c["H"+i].v.toString()):null;do{var g={servicio:{}};g.servicio.nombre=null!=c["I"+r]&&""!=c["I"+r]?c["I"+r].v.toString():null,g.servicio.precio=null!=c["K"+r]&&""!=c["K"+r]?parseFloat(c["K"+r].v.toString()):null,g.servicio.id_empresa=x.usuario.id_empresa;v=!1;if(0<l.length){for(n=0;n<l.length;n++){f=l[n].nombre;null!=g.servicio.nombre&&f==g.servicio.nombre&&(v=!0)}v||l.push(g.servicio)}else l.push(g.servicio);if(g.observaciones=null!=c["J"+r]&&""!=c["J"+r]?c["J"+r].v.toString():null,g.importe=null!=c["K"+r]&&""!=c["K"+r]?parseFloat(c["K"+r].v.toString()):null,g.descuento=null!=c["L"+r]&&""!=c["L"+r]?parseFloat(c["L"+r].v.toString()):null,g.tipo_recargo=null!=c["M"+r]&&""!=c["M"+r]?parseFloat(c["M"+r].v.toString()):null,g.recargo=null!=c["N"+r]&&""!=c["N"+r]?parseFloat(c["N"+r].v.toString()):null,g.ice=null!=c["O"+r]&&""!=c["O"+r]?parseFloat(c["O"+r].v.toString()):null,g.excento=null!=c["P"+r]&&""!=c["P"+r]?parseFloat(c["P"+r].v.toString()):null,p==(null!=c["A"+r]&&""!=c["A"+r]?c["A"+r].v.toString():null)){var h=g.recargo;"%"==g.tipo_recargo&&(h=x.detalleVenta.importe*(g.recargo/100));var P=x.serviciosVentas.filter(function(e){return e.nombre==g.servicio.nombre});0<P.length&&(g.servicio=P[0]),g.total=Math.round(1e3*(g.importe-g.descuento+h-g.ice-g.excento))/1e3,d.detallesVenta.push(g)}r++}while(null!=c["A"+r]);if(p!=m||2==i){var b=0;for(n=0;n<d.detallesVenta.length;n++)d.detallesVenta[n].eliminado||(b+=d.detallesVenta[n].importe);d.importe=Math.round(1e3*b)/1e3;var _=0;for(n=0;n<d.detallesVenta.length;n++)d.detallesVenta[n].eliminado||(_+=d.detallesVenta[n].total);d.total=Math.round(1e3*_)/1e3,d.pagado=d.total;var D=x.tiposPago.filter(function(e){return e.nombre==d.tipoPago.nombre});d.tipoPago=D[0],"CREDITO"==d.tipoPago.nombre?d.saldo=d.total-d.a_cuenta:d.saldo=null,d.cambio=0,d.id_usuario=x.usuario.id;var C=x.movimientosEgreso.filter(function(e){return e.nombre_corto==x.diccionario.EGRE_SERVICIO}),V=x.vendedores.filter(function(e){return e.persona.nombre_completo==d.vendedor});0<V.length&&(d.vendedor=V[0]),d.movimiento=C[0],d.id_empresa=x.usuario.id_empresa,d.fecha=new Date(x.convertirFecha(d.fechaTexto)),s.push(d)}i++,n++}while(null!=c["A"+i]);x.guardarImportacionVentasServicios(s,l,u)},i.readAsBinaryString(t)}},x.guardarImportacionVentasServicios=function(e,a,t){g.start(),z(e,a,t).then(function(e){g.stop(),x.mostrarMensaje(e.mensaje)})},x.obtenerCotizaciones=function(){x.paginator=M(),x.paginator.column="nombre",x.paginator.direction="desc",x.paginator.callBack=x.obtenerLista,x.filtro={empresa:x.usuario.id_empresa,inicio:"",fin:"",fecha_inicio:new Date(x.convertirFecha("14/08/2018")),fecha_fin:new Date(x.convertirFecha("27/08/2018")),busqueda:"",importe:0},x.paginator.getSearch("",x.filtro,null)},x.obtenerLista=function(){g.start(),Z(x.paginator).then(function(e){console.log("llegooo  cotissssssss",e),x.paginator.setPages(e.paginas),x.cotizaciones=e.cotizaciones,g.stop()})},x.abrirPopupCotizaciones=function(){x.obtenerCotizaciones(),x.abrirPopup(x.idModalCotizaciones)},x.cerrarPopupCotizaciones=function(){x.cerrarPopup(x.idModalCotizaciones)},x.obtenerDetalleCotizacion=function(e,a){x.editCoticacion=a,console.log("datos usuarioooooooo ",x.usuario);for(var t=0;t<e.detallesCotizacion.length;t++){var o=e.detallesCotizacion[t].producto,i=x.obtenerInventarioTotal(o);e.detallesCotizacion[t].disponible=i,e.detallesCotizacion[t].aceptar=!1,i<e.detallesCotizacion[t].cantidad?(e.detallesCotizacion[t].faltante=e.detallesCotizacion[t].cantidad-i,e.detallesCotizacion[t].entregar=i):(e.detallesCotizacion[t].faltante=0,e.detallesCotizacion[t].entregar=e.detallesCotizacion[t].cantidad),0<e.detallesCotizacion[t].entregar&&(e.detallesCotizacion[t].aceptar=!0),0<e.detallesCotizacion[t].faltante&&(e.detallesCotizacion[t].aceptar=!1),e.detallesCotizacion[t].total=e.detallesCotizacion[t].entregar*e.detallesCotizacion[t].precio_unitario,console.log("disponibleeeeee ",i)}console.log("la cotizacvion recibidooo ",e.detallesCotizacion),x.cotizacion=e,x.abrirPopup(x.idModalDetalleCotizaciones)},x.isCheckedCotizacion=function(e){if(e)for(var a in e.detallesCotizacion){if(e.detallesCotizacion[a].aceptar)return!1}return!0},x.cerrarPopupDetalleCotizaciones=function(){x.cerrarPopup(x.idModalDetalleCotizaciones)},x.aceptarDetalleCotizacion=function(e){e.aceptar=!0},x.cancelarDetalleCotizacion=function(e){e.aceptar=!1},x.agregarVentaCotizacion=function(e){console.log("la cotizacion para venta",e),x.obtenerAlmacenesActividades(e.sucursal.id);var a=new Date;e.fecha=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),x.detalleVenta=[];for(var t=0,o=0;o<e.detallesCotizacion.length;o++)if(e.detallesCotizacion[o].aceptar){var i={eliminado:!1,producto:e.detallesCotizacion[o].producto,precio_unitario:e.detallesCotizacion[o].precio_unitario,costos:e.detallesCotizacion[o].producto.activar_inventario?e.detallesCotizacion[o].producto.inventarios:[],cantidad:e.detallesCotizacion[o].cantidad,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,importe:e.detallesCotizacion[o].importe,total:e.detallesCotizacion[o].total};t+=e.detallesCotizacion[o].total,x.detalleVenta.push(i)}x.venta=new l({id_empresa:x.usuario.id_empresa,id_usuario:x.usuario.id,cliente:e.cliente,sucursal:e.sucursal,almacen:e.almacen,fechaTexto:e.fecha,tipoPago:x.tiposPago[0],cotizacion_id:e.id,actualizarCotizacion:!0,detallesVenta:x.detalleVenta,detallesVentaNoConsolidadas:[],pagado:t,cambio:0,despachado:!1,vendedor:null,total:t}),x.cerrarPopupDetalleCotizaciones(),x.cerrarPopupCotizaciones()},x.editarDetalleCotizacion=function(e){x.Cprecio_unitario=e.precio_unitario,x.c=e,x.abrirPopup(x.idModalDetalleCotizacionEditar)},x.guardarEditarCotizacion=function(e){x.c=e,x.cerrarPopupCotizacionEditar()},x.cancelarPopupCotizacionEditar=function(e){x.c.precio_unitario=x.Cprecio_unitario,x.cerrarPopup(x.idModalDetalleCotizacionEditar)},x.cerrarPopupCotizacionEditar=function(){x.cerrarPopup(x.idModalDetalleCotizacionEditar)},x.$on("$routeChangeStart",function(e,a){x.eliminarPopup(x.idModalWizardCompraEdicion),x.eliminarPopup(x.idModalWizardVentaVista),x.eliminarPopup(x.idModalEliminarCompra),x.eliminarPopup(x.idModalPago),x.eliminarPopup(x.idModalCierre),x.eliminarPopup(x.idModalPanelVentas),x.eliminarPopup(x.idModalInventario),x.eliminarPopup(x.idModalPanelVentasCobro),x.eliminarPopup(x.idModalEdicionVendedor),x.eliminarPopup(x.idModalImpresionVencimiento),x.eliminarPopup(x.IdModalVerificarCuenta),x.eliminarPopup(x.modalReportesProductos),x.eliminarPopup(x.modelGraficaProductos),x.eliminarPopup(x.modalServicioVenta),x.eliminarPopup(x.modelImportacionVentaServicio),x.eliminarPopup(x.idModalCotizaciones),x.eliminarPopup(x.idModalDetalleCotizaciones),x.eliminarPopup(x.idModalDetalleCotizacionEditar)}),x.UsarLectorDeBarra=function(){if(1==x.usuario.usar_lector_de_barra){x.usuario.usar_lector_de_barra=!0,c.usuario=JSON.stringify(x.usuario);U(x.usuario)}else{x.usuario.usar_lector_de_barra=!1,localStorage.usuario=JSON.stringify(x.usuario);U(x.usuario)}},x.inicio()}]);