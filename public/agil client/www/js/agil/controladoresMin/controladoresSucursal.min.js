angular.module("agil.controladores").controller("ControladorSucursales",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Sucursal","Sucursales","SucursalesEmpresa","ClasesTipo","Clases","DosificacionesDisponibles","Sucursalupdate",function(n,a,i,o,r,c,e,s,u,d,t,l,p){c.start(),n.idModalWizardSucursalCorrelativoEdicion="modal-wizard-sucursal-correlativo-edicion",n.idModalWizardSucursalEdicion="modal-wizard-sucursal-edicion",n.idModalWizardSucursalVista="modal-wizard-sucursal-vista",n.idModalEliminarSucursal="dialog-eliminar-sucursal",n.idModalContenedorSucursalEdicion="modal-wizard-container-sucursal-edicion",n.idModalContenedorSucursalVista="modal-wizard-container-sucursal-vista",n.usuario=JSON.parse(a.usuario),n.inicio=function(){n.obtenerSucursales(),n.obtenerDepartamentos(),n.obtenerActividades(),n.obtenerDosificaciones(),n.obtenerTamanosPapelFactura(),setTimeout(function(){ejecutarScriptsTabla("tabla-sucursales",8)},2e3)},n.$on("$viewContentLoaded",function(){resaltarPesta√±a(i.path().substring(1)),ejecutarScriptsSucursal(n.idModalWizardSucursalEdicion,n.idModalWizardSucursalVista,n.idModalEliminarSucursal,n.idModalContenedorSucursalEdicion,n.idModalContenedorSucursalVista,n.idModalWizardSucursalCorrelativoEdicion),n.buscarAplicacion(n.usuario.aplicacionesUsuario,i.path().substring(1)),c.stop()}),n.obtenerTamanosPapelFactura=function(){c.start(),d("TAMPAPFACT").then(function(i){n.tamanosPapelFactura=i.clases,c.stop()})},n.obtenerSucursales=function(){c.start(),s(n.usuario.id_empresa).then(function(i){n.sucursales=i,console.log(i),c.stop()})},n.obtenerDepartamentos=function(){d("DEP").then(function(i){n.departamentos=i.clases})},n.obtenerActividades=function(){d("ACTCOM").then(function(i){n.actividades=i.clases})},n.obtenerDosificaciones=function(){l(n.usuario.id_empresa).then(function(i){n.dosificaciones=i})},n.buscarMunicipios=function(i){var a=i.split("-")[1];t(a+"M").then(function(i){n.municipios=i})},n.crearNuevaSucursal=function(){var i=JSON.parse(a.usuario);n.sucursal=new e({id_empresa:i.id_empresa,almacenes:[],actividadesDosificaciones:[]}),n.abrirPopup(n.idModalWizardSucursalEdicion)},n.verSucursal=function(i){(n.sucursal=i).departamento&&n.buscarMunicipios(i.id_departamento+"-"+i.departamento.nombre_corto),n.abrirPopup(n.idModalWizardSucursalVista)},n.cerrarPopPupVista=function(){n.cerrarPopup(n.idModalWizardSucursalVista)},n.cerrarPopPupEdicion=function(){n.cerrarPopup(n.idModalWizardSucursalEdicion)},n.cerrarPopPupEdicionCorrelativo=function(){n.cerrarPopup(n.idModalWizardSucursalCorrelativoEdicion)},n.modificarSucursal=function(i){n.sucursal=i,console.log(i),i.departamento&&n.buscarMunicipios(i.id_departamento+"-"+i.departamento.nombre_corto),n.abrirPopup(n.idModalWizardSucursalEdicion)},n.mostrarConfirmacionEliminacion=function(i){n.sucursal=new e(i),n.abrirPopup(n.idModalEliminarSucursal)},n.cerrarConfirmacionEliminacion=function(){n.cerrarPopup(n.idModalEliminarSucursal)},n.eliminarSucursal=function(i){c.start(),n.cerrarConfirmacionEliminacion(),i.$delete(),n.mostrarMensaje("Eliminado exitosamente!"),n.recargarItemsTabla(),c.stop()},n.modificarCorrelativos=function(i){n.sucursal=i,n.abrirPopup(n.idModalWizardSucursalCorrelativoEdicion)},n.guardarCorrelativos=function(i){console.log(i),p.update({idSucursal:i.id},i,function(i){c.stop(),n.cerrarPopPupEdicionCorrelativo(),n.mostrarMensaje("Actualizado Exitosamente!"),n.recargarItemsTabla()})},n.saveForm=function(i){"Siguiente"!=$("#siguiente").text().trim()&&(c.start(),"string"==typeof i.id_departamento&&(i.id_departamento=i.id_departamento.split("-")[0]),i.id?(i.municipio&&(i.id_municipio=i.municipio.id),e.update({idSucursal:i.id},i,function(i){c.stop(),n.recargarItemsTabla(),n.cerrarPopPupEdicion(),n.mostrarMensaje("Actualizado Exitosamente!")})):(i.fecha_reinicio_correlativo=new Date,i.fecha_reinicio_correlativo.setDate(1),i.municipio&&(i.id_municipio=i.municipio.id),i.$save(function(i){c.stop(),n.sucursal=new e({}),n.cerrarPopPupEdicion(),n.recargarItemsTabla(),n.mostrarMensaje("Guardado Exitosamente!")},function(i){c.stop(),n.cerrarPopPupEdicion(),n.recargarItemsTabla(),n.mostrarMensaje("Ocurrio un problema al momento de guardar!")})))},n.agregarAlmacen=function(i){i.edit=!1,i.nombre&&i.numero&&i.direccion&&(-1==n.sucursal.almacenes.indexOf(i)&&n.sucursal.almacenes.push(i),n.almacen={})},n.modificarAlmacen=function(i){i.edit=!0,n.almacen=i},n.removerAlmacen=function(i){i.eliminado=!0},n.agregarActividadDosificacion=function(r){var c=!1;0<n.sucursal.actividadesDosificaciones.length?n.sucursal.actividadesDosificaciones.forEach(function(i,a,o){r.dosificacion.expirado;0==r.dosificacion.expirado&&(c=!1,i.id_dosificacion!=r.dosificacion.id&&i.id_actividad!=r.actividad.id||(c=!0)),a===o.length-1&&0==c&&r.actividad&&r.dosificacion&&(r.id||(r.id_actividad=r.actividad.id,r.id_dosificacion=r.dosificacion.id,r.expirado=!1,n.sucursal.actividadesDosificaciones.push(r)),n.actividadDosificacion={})}):r.actividad&&r.dosificacion&&(r.id||(r.id_actividad=r.actividad.id,r.id_dosificacion=r.dosificacion.id,n.sucursal.actividadesDosificaciones.push(r)),n.actividadDosificacion={})},n.removerActividadDosificacion=function(i){i.eliminado=!0},n.$on("$routeChangeStart",function(i,a){n.eliminarPopup(n.idModalWizardSucursalEdicion),n.eliminarPopup(n.idModalWizardSucursalCorrelativoEdicion),n.eliminarPopup(n.idModalWizardSucursalVista),n.eliminarPopup(n.idModalEliminarSucursal)}),n.inicio()}]);