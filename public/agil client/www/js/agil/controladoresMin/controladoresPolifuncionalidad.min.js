angular.module("agil.controladores").controller("controladorPolifuncionalidad",["$scope","$location","$localStorage","$templateCache","$route","blockUI","Paginator","FieldViewer","$timeout","$filter","ClasesTipo","ObtenerTodoPersonal","ObtenerEvaluaciones","GuardarEvaluacionPersonal","ObtenerReportePorMeses","ObtenerReportePorAnio","ObtenerReporteGeneralPorAnio","GuardarConfiguracionCalificacion","ObtenerConfiguracionCalificacion","GuardarConfiguracionDesempenio","ObtenerConfiguracionDesempenio","ActualizarEvaluacionPersonal",function(P,e,o,a,n,_,i,r,t,s,l,c,d,p,C,u,m,f,h,g,v,b){P.usuarioSesion=JSON.parse(o.usuario),P.idModalWizardPolifuncionalEdicion="modal-wizard-polifuncional-edicion",P.idModalContenedorPolifuncionalEdicion="modal-wizard-container-polifuncional-edicion",P.idModalWizardConceptoEdicion2="modal-wizard-polifuncional-ac-edicion",P.idModalContenedorConceptoEdicion2="modal-wizard-container-polifuncional-ac-edicion",P.modalBusquedaPersonal="dialog-Busqueda-personal-polifuncional",P.modalBusquedaCentroCosto="dialog-Busqueda-centro-costo-polifuncional",P.idModalReportes="dialog-reportes-polifuncional",P.reporteGraficoPolifuncional="reporte-grafico-polifuncional",P.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsPolifuncionalidad(P.idModalWizardPolifuncionalEdicion,P.idModalContenedorPolifuncionalEdicion,P.modalBusquedaPersonal,P.idModalWizardConceptoEdicion2,P.idModalContenedorConceptoEdicion2,P.idModalReportes,P.reporteGraficoPolifuncional,P.modalBusquedaCentroCosto),P.buscarAplicacion(P.usuarioSesion.aplicacionesUsuario,e.path().substring(1)),P.obtenerColumnasAplicacion(),_.stop()}),P.$on("$routeChangeStart",function(e,o){P.eliminarPopup(P.idModalWizardPolifuncionalEdicion),P.eliminarPopup(P.idModalWizardConceptoEdicion2),P.eliminarPopup(P.idModalReportes),P.eliminarPopup(P.modalBusquedaPersonal),P.eliminarPopup(P.reporteGraficoPolifuncional),P.eliminarPopup(P.modalBusquedaCentroCosto)}),P.inicio=function(){P.obtenerCargos(),P.obtenerCentroCosto(),P.actualizarListaDesempenio(),P.obtenerConfiguracionnotas(),P.filtrarPersonal("");P.usuarioSesion.empresa.id;P.obtenerPaginador()},P.eliminar=function(e){e.eliminado=!0,e.eliminar=!0,p(P.usuarioSesion.empresa.id,e).then(function(e){e.hasErr?P.mostrarMensaje("Hubo un error no se pudo eliminar: "+e.mensaje):(P.mostrarMensaje(e.mensaje),P.recargarItemsTabla())},function(e){P.mostrarMensaje("No hay respuesta del servidor, se perdió la conexión: "+res.mensaje)})},P.obtenerConfiguracionnotas=function(){h(P.usuarioSesion.empresa.id).then(function(e){for(var o in e.configuracion)e.configuracion[o].encargados?P.encargados=e.configuracion[o]:P.empleados=e.configuracion[o];v(P.usuarioSesion.empresa.id).then(function(e){for(P.parametros=e.parametros;0<e.parametros.length;){var o=e.parametros.pop();P.listaDesempenio.map(function(e){e.nombre==o.nombre&&(e.desde=o.desde,e.hasta=o.hasta)})}})}).catch(function(e){P.mostrarMensaje(e.stack?e.stack:e.message)})},P.editar=function(e,o,a,n){if(P.abrirNuevoEvaluacionPolifuncional(),n&&(P.evaluacion={encargado:e.encargado,anio:{id:e.anio},mes:{id:e.mes},asistencia_capacitacion:e.asistencia_capacitacion,asistencia_reunion:e.asistencia_reunion,documentos_actualizados:e.documentos_actualizados,funciones_puntualidad:e.funciones_puntualidad,higiene_personal:e.higiene_personal,ingreso_campo:e.ingreso_campo,llenado_formularios:e.llenado_formularios,trabajo_equipo:e.trabajo_equipo,nota_total:e.nota_total,id:e.id,id_desempenio:e.id_desempenio,id_empleado:e.id_empleado,personal:{id:e.empleado.id,persona:{nombre_completo:e.empleado.persona.nombre_completo}}},P.evaluacion.ver=!0),o&&(P.evaluacion={encargado:e.encargado,anio:{id:e.anio},mes:{id:e.mes},asistencia_capacitacion:e.asistencia_capacitacion,asistencia_reunion:e.asistencia_reunion,documentos_actualizados:e.documentos_actualizados,funciones_puntualidad:e.funciones_puntualidad,higiene_personal:e.higiene_personal,ingreso_campo:e.ingreso_campo,llenado_formularios:e.llenado_formularios,trabajo_equipo:e.trabajo_equipo,nota_total:e.nota_total,id:e.id,id_desempenio:e.id_desempenio,id_empleado:e.id_empleado,personal:{id:e.empleado.id,persona:{nombre_completo:e.empleado.persona.nombre_completo}}},P.evaluacion.editar=!0),a){P.evaluacion.encargado=e.encargado,P.evaluacion.id_desempenio=e.id_desempenio,P.evaluacion.id_empleado=e.id_empleado,P.evaluacion.personal={id:e.empleado.id,persona:{nombre_completo:e.empleado.persona.nombre_completo}},P.evaluacion.nuevo=!0;$("#siguiente").trigger("click")}},P.obtenerPaginador=function(){_.start(),P.paginator=i(),P.paginator.column="anio",P.paginator.direccion="asc",P.filtro={id_empresa:P.usuarioSesion.empresa.id,mes:0,anio:0,desempenio:0,mas_campo:0,campo:0,cargo:0,estado:0,codigo:0,nombre:0,apellido:0,pagina:1,items_pagina:10},P.paginator.filter=P.filtro,P.paginator.callBack=P.obtenerEvaluaciones,P.paginator.getSearch("",P.filtro,null),P.resetFiltro(),_.stop()};var w="ERROR",S="bg-red";P.listaDesempenio=[{nombre:"Deficiente",desde:0,hasta:25,color:"bg-red"},{nombre:"Insatisfactorio",desde:26,hasta:50,color:"bg-yellow"},{nombre:"Satisfactorio",desde:51,hasta:75,color:"bg-orange-green"},{nombre:"Competente",desde:76,hasta:100,color:"bg-blue"}],P.actualizarListaDesempenio=function(e){if(null==e||null==e)v(P.usuarioSesion.empresa.id).then(function(e){for(;0<e.parametros.length;){var o=e.parametros.pop();P.listaDesempenio.map(function(e){e.nombre==o.nombre&&(e.desde=o.desde,e.hasta=o.hasta,e.id=o.id,e.activo=o.activo)})}}).catch(function(e){P.mostrarMensaje(e.stack?e.stack:e.message)});else for(var o=e.map(function(e){return e});0<o.length;){var a=o.pop();P.listaDesempenio.map(function(e){e.nombre==a.nombre&&(e.desde=a.desde,e.hasta=a.hasta)})}},P.listaEstados=[{id:1,nombre:"Activo"},{id:2,nombre:"Inactivo"}],P.determinarEstado=function(e){return 1==e?P.listaEstados[1].nombre:P.listaEstados[0].nombre},P.determinarDesempenio=function(a){var n=NaN;if(null==a||null==a)return"bg-red";P.listaDesempenio.map(function(e,o){e.id==a&&(n=o)});return NaN!==n?P.listaDesempenio[n].nombre:w},P.determinarColor=function(a){var n=NaN;if(null==a||null==a)return"bg-red";P.listaDesempenio.map(function(e,o){e.id==a&&(n=o)});return NaN!==n?P.listaDesempenio[n].color:S};var E=["asistencia_capacitacion","documentos_actualizados","trabajo_equipo","funciones_puntualidad","higiene_personal","asistencia_reunion","ingreso_campo","llenado_formularios"];P.calcularTotalEvaluacion=function(o){var a=0;E.map(function(e){null!==o[e]&&void 0!==o[e]&&0<=o[e]?(P.opcion[e]?a+=o[e]:o.encargado?(a+=P.encargados[e],o[e]=P.encargados[e]):(a+=P.empleados[e],o[e]=P.empleados[e]),o.nota_total=a):P.opcion[e]?a+=o[e]:o.encargado?(a+=encargados[e],o[e]=P.encargados[e]):(a+=empleados[e],o[e]=P.empleados[e])})},P.filtrarPolifuncionalidad=function(e,o){for(var a in e)""!==e[a]&&null!==e[a]||(e[a]=0);if(void 0!==o)return e;P.obtenerProformas()};var x=!(P.calcularNotaTotalConfiguracion=function(e,o){var a=0,n=0;for(var i in e&&(e.nota_total=0),o&&(o.nota_total=0),e)"createdAt"!==i&&"updatedAt"!==i&&"id_empresa"!==i&&"id"!==i&&"activo"!==i&&"encargados"!==i&&(a+=e[i]);for(var i in o)"createdAt"!==i&&"updatedAt"!==i&&"id_empresa"!==i&&"id"!==i&&"activo"!==i&&"encargados"!==i&&(n+=o[i]);e.nota_total=a,o.nota_total=n}),M=0,D=!1;P.validarDatosEvaluacion=function(e){if(D){var o=0;for(var a in e)e.hasOwnProperty(a)&&(o+=1);return o==E.length||4==o||7==o&&e.nuevo?x?!(M<1)||(M+=1,!1):!(x=!0):o<E.length+4}return null==e||(void 0===e.personal||null==e.personal||(M+=1,!(D=!0)))},P.guardarEvaluacion=function(a){if("Siguiente"!=$("#siguiente").text().trim())if(_.start(),P.listaDesempenio.map(function(e){a.nota_total>=e.desde&&a.nota_total<=e.hasta&&(a.id_desempenio=e.id)}),a.ver)P.cerrarPopPupNuevoPolifuncional(),_.stop();else{if(a.fecha=new Date(a.anio.id,a.mes.id,15,12,0,0),a.editar)var e=b(P.usuarioSesion.empresa.id,a);else e=p(P.usuarioSesion.empresa.id,a);e.then(function(e){P.mostrarMensaje(e.mensaje),P.cerrarPopPupNuevoPolifuncional(),P.recargarItemsTabla(),_.stop()},function(e){var o=void 0!==e.stack?e.stack:e.message;a.editar=void 0,P.mostrarMensaje("Se perdió la conexión."+o),_.stop()})}},P.reportePorMesGrafico=function(e,r){P.abriridModalReportesGrafico();var a=[];e.forEach(function(n,e){if(0!=e){var i=[];n.forEach(function(e,o){if(5<o&&o<=n.length-2){var a={y:"-"!==e?e:0,label:n.length-2!=o?r[o-6]:"TOTAL"};i.push(a),10}});var o={type:"column",interval:0,showInLegend:!0,legendText:(n[1]+" "+n[2]+" "+n[3]+" "+n[4]+" "+n[5]).toUpperCase(),dataPoints:i};a.push(o)}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte polifuncional desde "+r[0]+" hasta "+r[r.length-1]).toUpperCase(),fontSize:32},legend:{horizontalAlign:"center",verticalAlign:"top",fontSize:15},animationEnabled:!0,exportEnabled:!0,width:1100,height:600,axisX:{labelFontSize:18},data:a}).render(),_.stop()},P.reportePorMeses=function(c,d,p,u,m,f){if(_.start(),void 0===c||void 0===d||void 0===p||void 0===u||null===c||null===d||null===p||null===u)return P.mostrarMensaje("Ingrese desde que Mes/Año hasta que Mes/Año desea el reporte."),void _.stop();var h=["N°","Campo","Empleado","C.I.","Estado","Cargo"],g=[];if(void 0===m)var v=[{wch:4},{wch:12},{wch:20},{wch:9},{wch:8},{wch:9}];var b=[];C(c,d,p,u,P.usuarioSesion.empresa.id).then(function(o){if(0==o.reporte.length)return P.mostrarMensaje("No existen datos"),void _.stop();if(o.hasErr)P.mostrarMensaje(o.mensaje);else{o.mesesReporte.map(function(e){h.push(e)}),mesesReporte=o.mesesReporte;for(var a=0;a<o.reporte.length;a++){var n=[];n.push(a+1),n.push(o.reporte[a].campo.nombre),n.push(o.reporte[a].persona.nombre_completo),n.push(o.reporte[a].persona.ci),n.push(P.determinarEstado(o.reporte[a].eliminado)),n.push(0<o.reporte[a].empleadosFichas[o.reporte[a].empleadosFichas.length-1].cargos.length?o.reporte[a].empleadosFichas[o.reporte[a].empleadosFichas.length-1].cargos[0].cargo.nombre:"Sin cargo");var i=0,r=0;mesesReporte.map(function(e){e==(i<=o.reporte[a].evaluaciones.length-1?P.meses[o.reporte[a].evaluaciones[i].mes].nombre.substring(0,3)+"-"+o.reporte[a].evaluaciones[i].anio.toString().substring(4,2):"0")?(n.push(o.reporte[a].evaluaciones[i].nota_total),r+=o.reporte[a].evaluaciones[i].nota_total,i+=1):n.push("-"),0==a&&void 0===m&&v.push({wch:6})}),r/=o.reporte[a].evaluaciones.length,n.push(Math.round(r)),P.listaDesempenio.map(function(e){Math.round(r)>=e.desde&&Math.round(r)<=e.hasta&&n.push(P.determinarDesempenio(e.id))}),0==a&&void 0===m&&v.push({wch:10}),a==o.reporte.length-1&&(h.push("Promedio"),h.push("Desempeño"),void 0===m&&v.push({wch:12})),b.push(n)}if(g.push(h),b.map(function(e){g.push(e)}),m)f?P.reportePorMesGrafico(g,mesesReporte):(_.stop(),P.reportePorMesesPdf(g,c,d,p,u));else{var e="SheetJS",t=new Workbook,s=sheet_from_array_of_arrays(g);s["!cols"]=v,t.SheetNames.push(e),t.Sheets[e]=s;var l=XLSX.write(t,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});P.meses[c.id].nombre.substring(0,3),d.id.toString().substring(4,2),P.meses[p.id].nombre.substring(0,3),u.id.toString().substring(4,2);saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"REPORTE POLIFUNCIONAL POR MESES "+mesesReporte[0]+" : "+mesesReporte[mesesReporte.length-1]+".xlsx"),_.stop()}}}).catch(function(e){var o=void 0!==e.data&&null!==e.data?e.data:e.message;P.mostrarMensaje("Se produjo un error! "+o),_.stop()})},P.reportePorMesesPdf=function(l,c,d,p,u){var m=40,f=120;convertUrlToBase64Image(P.usuario.empresa.imagen,function(e){var o=e,a=l[0].length-8;12==a&&(m=30);var n=new PDFDocument({size:[612,792],margin:10,compress:!1}),i=n.pipe(blobStream());n.image(o,40,30,{fit:[85,85]});for(var r=0;r<=l.length-1;r++){if(l[r].length<=14){0==r&&(n.font("Helvetica-Bold",12),n.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),n.text("DESDE "+c.nombre.toUpperCase()+"-"+d.id+" HASTA "+p.nombre.toUpperCase()+"-"+u.id,50,45,{align:"center"}),n.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"}));for(var t=0;t<l[r].length;t++)0<r?n.font("Helvetica",8):n.font("Helvetica-Bold",8),0==t&&(n.text(l[r][t],m,f,{width:50}),m-=30),0<t&&t<5&&((2==t||1==t||5==t)&&1<=r&&n.font("Helvetica",5),n.text(l[r][t],m,f,{width:50,align:"center"})),4<t&&t<l[r].length-3&&(5==t?n.text(l[r][t].toLowerCase(),m,f,{width:50,align:"center"}):n.text(l[r][t],m,f,{width:50,align:"center"}),m-=10),t>=l[r].length-3&&n.text(l[r][t],m,f,{width:50,align:"center"}),m+=45}if(15<=l[r].length&&l[r].length<=23){0==r&&(n.font("Helvetica-Bold",12),n.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),n.text("DESDE "+c.nombre+"-"+d.id+" HASTA "+p.nombre+"-"+u.id,50,45,{align:"center"}),n.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"}));for(t=0;t<l[r].length;t++)0<r?n.font("Helvetica",6):n.font("Helvetica-Bold",6),0==t&&(n.text(l[r][t],m,f,{width:50}),m-=40),0<t&&t<5&&((2==t||1==t)&&1<=r&&n.font("Helvetica",5),n.text(l[r][t],m,f,{width:45,align:"center"}),m-=5),4<t&&t<l[r].length-3&&(n.text(l[r][t],m,f,{width:45,align:"center"}),m-=15),t>=l[r].length-3&&n.text(l[r][t],m,f,{width:45,align:"center"}),m+=40}if(12<a&&(m=20),12==a&&(m=30),a<12&&10<a&&(m=35),a<=10&&(m=40),700<(f+=25)){n.addPage({size:"letter",margin:10}),n.font("Helvetica-Bold",12),n.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),n.text("DESDE "+c.nombre+"-"+d.id+" HASTA "+p.nombre+"-"+u.id,50,45,{align:"center"}),n.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"});for(var s=0;s<l[0].length;s++)n.font("Helvetica-Bold",8),n.text(l[0][s],m,f-625,{width:50}),0==s&&(m-=20),2==s&&(m+=10),4<s&&s<l[r].length-3&&(m-=10),m+=45;12<a&&(m=20),12==a&&(m=30),a<12&&10<a&&(m=35),a<=10&&(m=40),f=120}}12<a&&setTimeout(function(){P.$apply(function(){P.mostrarMensaje("ADVERTENCIA: El rango de fechas excede el tamaño máximo de impresion.")})},1e3),n.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},P.reportePromediosGeneralGrafico=function(e,o,a,n){P.abriridModalReportesGrafico();P.graficoType="column",n&&(P.graficoType=n);var i=[];e.map(function(e,o){if(0!=o){var a={y:e[9],label:e[0]};i.push(a),10}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte promedio general campo "+a+" gestión "+o.id).toUpperCase(),fontSize:32},animationEnabled:!0,exportEnabled:!0,width:1100,axisX:{title:"Promedio total mensual"},data:[{type:"column",dataPoints:i}]}).render(),_.stop()},P.reportePromediosGeneralExcel=function(s,l,c,d){if(_.start(),null==s||null==l)return P.mostrarMensaje("Ingrese el Campo y el Año del cual desea el reporte."),void _.stop();var p=[];p.push(["","Asistencia Capacitación","Documentos Actualizados","Trabajo en equipo","Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo","Higiene personal","Puntualidad a la asistencia de reunión de 5 minutos en campo","Cumplimiento de ingreso a campo","Aplicación y llenado correcto de los formularios del SIG","TOTAL","DESEMPEÑO"]),m(s.id,l,P.usuarioSesion.empresa.id).then(function(o){if(0==o.reporte.length)return P.mostrarMensaje("No existen datos"),void _.stop();for(var a=0;a<o.reporte.length;a++){var n=[];n.push(P.meses[o.reporte[a].mes].nombre),n.push(o.reporte[a].asistencia_capacitacion),n.push(o.reporte[a].documentos_actualizados),n.push(o.reporte[a].trabajo_equipo),n.push(o.reporte[a].funciones_puntualidad),n.push(o.reporte[a].higiene_personal),n.push(o.reporte[a].asistencia_reunion),n.push(o.reporte[a].ingreso_campo),n.push(o.reporte[a].llenado_formularios),n.push(o.reporte[a].total),P.listaDesempenio.map(function(e){o.reporte[a].total>=e.desde&&o.reporte[a].total<=e.hasta&&n.push(P.determinarDesempenio(e.id))}),p.push(n)}if(c)d?(_.stop(),P.reportePromediosGeneralGrafico(p,s,l.nombre)):(_.stop(),P.reportePromediosGeneralPdf(p,s,l.nombre));else{var e="SheetJS",i=new Workbook,r=sheet_from_array_of_arrays(p);r["!cols"]=[{wch:12},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],r["!rows"]=[{hpx:28,level:3}],i.SheetNames.push(e),i.Sheets[e]=r;var t=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(t)],{type:"application/octet-stream"}),"REPORTE POLIFUNCIONAL CAMPO "+l.nombre+" : "+anio.id+".xlsx"),_.stop()}}).catch(function(e){var o=void 0!==e.data&&null!==e.data?e.data:null!==e.message&&void 0!==e.message?e.message:void 0!==e.stack&&null!==e.stack?e.stack:"Se perdió la conexión al servidor.";P.mostrarMensaje("Se produjo un error! "+o),_.stop()})},P.reportePromediosGeneralPdf=function(t,s,l){var c=15,d=180,p=20;convertUrlToBase64Image(P.usuario.empresa.imagen,function(e){var o=e,a=(t[0].length,new PDFDocument({size:[792,612],margin:10,compress:!1})),n=a.pipe(blobStream());a.image(o,40,40,{fit:[85,85]});for(var i=0;i<=t.length-1;i++){0==i&&(a.font("Helvetica-Bold",12),a.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),a.text("GESTIÓN "+s.id,50,55,{align:"center"}),a.text(" "+l.toUpperCase()+" ",50,70,{align:"center"}));for(var r=0;r<t[i].length;r++)0<r?0==i?(a.font("Helvetica-Bold",7),r>=t[i].length-2?(a.text(t[i][r],c-p,d-40,{width:70,align:"center"}),p+=20):a.text(t[i][r],c,d-40,{width:70,align:"center"})):(a.font("Helvetica",8),r>=t[i].length-2?(r==t[i].length-1?a.text(t[i][r],c-p,d,{width:70,align:"center"}):a.text(t[i][r].toFixed(2),c-p,d,{width:70,align:"center"}),p+=20):(a.text(t[i][r].toFixed(2),c,d,{width:70,align:"center"}),p=20)):(a.font("Helvetica-Bold",8),a.text(t[i][r],c,d,{width:70,align:"center"})),c+=70;700<(d+=c=25)&&(a.addPage({size:"letter",margin:10}),d=120)}a.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},P.reportePromediosCampoGrafico=function(r,e){P.abriridModalReportesGrafico();var t=[];r.map(function(e,o){if(0!=o){var n=10,i=[];e.map(function(e,o){if(0!=o&&o<=9){var a={x:n,y:e,label:r[0][o]};i.push(a),n+=10}});var a={type:"column",showInLegend:!0,legendText:e[0].toUpperCase(),dataPoints:i};t.push(a)}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte anual por campos gestión "+e.id).toUpperCase(),fontSize:32},legend:{horizontalAlign:"center",verticalAlign:"top",fontSize:15},animationEnabled:!0,exportEnabled:!0,width:1100,height:600,axisX:{labelFontSize:18},data:t}).render(),_.stop()},P.reportePromediosCampoExcel=function(s,l,c){if(_.start(),null==s)return _.stop(),void P.mostrarMensaje("Ingrese el Año del cual desea el reporte.");var d=[];d.push([" ","Asistencia Capacitación","Documentos Actualizados","Trabajo en equipo","Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo","Higiene personal","Puntualidad a la asistencia de reunión de 5 minutos en campo","Cumplimiento de ingreso a campo","Aplicación y llenado correcto de los formularios del SIG","TOTAL","DESEMPEÑO"]),u(s.id,P.usuarioSesion.empresa.id).then(function(o){for(var a=[],n=0;n<o.reporte.length;n++)(a=[]).push(null!==o.reporte[n].campo&&null!=o.reporte[n].campo?o.reporte[n].campo.nombre:""),a.push(o.reporte[n].asistencia_capacitacion),a.push(o.reporte[n].documentos_actualizados),a.push(o.reporte[n].trabajo_equipo),a.push(o.reporte[n].funciones_puntualidad),a.push(o.reporte[n].higiene_personal),a.push(o.reporte[n].asistencia_reunion),a.push(o.reporte[n].ingreso_campo),a.push(o.reporte[n].llenado_formularios),a.push(o.reporte[n].total),P.listaDesempenio.map(function(e){o.reporte[n].total>=e.desde&&o.reporte[n].total<=e.hasta&&a.push(P.determinarDesempenio(e.id))}),d.push(a);if(l)c?(_.stop(),P.reportePromediosCampoGrafico(d,s)):(_.stop(),P.reportePromediosCampoPdf(d,s));else{var e="SheetJS",i=new Workbook,r=sheet_from_array_of_arrays(d);r["!cols"]=[{wch:12},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],r["!rows"]=[{hpx:28,level:3}],i.SheetNames.push(e),i.Sheets[e]=r;var t=XLSX.write(i,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(t)],{type:"application/octet-stream"}),"REPORTE ANUAL POLIFUNCIONAL POR CAMPOS "+s.id+".xlsx"),_.stop()}})},P.reportePromediosCampoPdf=function(l,c){var d=20,p=180,u=20;convertUrlToBase64Image(P.usuario.empresa.imagen,function(e){var o=e,a=(l[0].length,1),n=new PDFDocument({size:[792,612],margin:10,compress:!1}),i=n.pipe(blobStream());n.image(o,40,40,{fit:[85,85]});for(var r=0;r<=l.length-1;r++){0==r&&(n.font("Helvetica-Bold",12),n.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),n.text("GESTIÓN "+c.id,50,55,{align:"center"}),n.font("Helvetica",12),n.text(a,730,585,{width:70,align:"center"}));for(var t=0;t<l[r].length;t++)0<t?0==r?(n.font("Helvetica-Bold",7),t>=l[r].length-2?(n.text(l[r][t],d-u,p-40,{width:70,align:"center"}),u+=20):n.text(l[r][t],d,p-40,{width:70,align:"center"})):(n.font("Helvetica",8),t>=l[r].length-2?(t==l[r].length-2?n.text(l[r][t].toFixed(2),d-u,p,{width:70,align:"center"}):t==l[r].length-1?n.text(l[r][t],d-u,p,{width:70,align:"center"}):n.text(l[r][t].toFixed(2),d-u,p,{width:70,align:"center"}),u+=20):(n.text(l[r][t].toFixed(2),d,p,{width:70,align:"center"}),u=20)):(n.font("Helvetica-Bold",8),n.text(l[r][t],d,p,{width:70,align:"center"})),d+=70;if(d=25,1,580<(p+=15)){n.addPage({size:[792,612],margin:10}),a+=1,n.font("Helvetica",12),n.text(a,730,p,{width:70,align:"center"}),n.font("Helvetica-Bold",12),n.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),n.text("GESTIÓN "+c.id,50,55,{align:"center"}),u=20,p=120,n.font("Helvetica-Bold",7);for(var s=0;s<l[0].length;s++)s>=l[0].length-2?(n.text(l[0][s],d-u,p-40,{width:70,align:"center"}),u+=20):n.text(l[0][s],d,p-40,{width:70,align:"center"}),d+=70;d=25}}n.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},P.obtenerEvaluaciones=function(){_.start(),P.filtro=P.filtrarFiltroPolifuncionalidad(P.filtro,!0),P.paginator.filter=P.filtro,d(P.paginator).then(function(e){P.evaluaciones=e.evaluaciones.rows,P.paginator.setPages(e.paginas),void 0!==e.mensaje&&P.mostrarMensaje(e.mensaje),_.stop()}).catch(function(e){t(function(){P.$apply(function(){P.mostrarMensaje(e.data)})},500),_.stop()})},P.resetFiltro=function(){P.filtro={id_empresa:P.usuarioSesion.empresa.id,mes:"",anio:"",desempenio:"",mas_campo:"",campo:"",cargo:"",estado:"",codigo:"",nombre:"",apellido:"",pagina:1,items_pagina:10}},P.filtrarFiltroPolifuncionalidad=function(e,o){if(void 0!==o){for(var a in e)null===e[a]||void 0===e[a]?e[a]=0:0!=e[a]&&"0"!=e[a]||"codigo"!=a&&"nombre"!=a&&"apellido"!=a||(e[a]="");return e}P.obtenerEvaluaciones()},P.obtenerColumnasAplicacion=function(){_.start(),P.fieldViewer=r({crear:!0,id_empresa:P.usuarioSesion.empresa.id,configuracion:{anio:{value:"Año",show:!0},mes:{value:"Mes",show:!0},estado:{value:"Estado",show:!0},codigo:{value:"Código",show:!0},nombre:{value:"Nombre completo",show:!0},campo:{value:"Campo",show:!0},cargo:{value:"Cargo",show:!0},asis_capacitacion:{value:"Asistencia Capacitación",show:!0},doc_actualizados:{value:"Documentos Actualizados",show:!0},trab_equipo:{value:"Trabajo en equipo",show:!0},funciones_puntualidad:{value:"Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo",show:!0},higiene:{value:"Higiene personal",show:!0},puntualidad_asistencia_campo:{value:"Puntualidad a la asistencia de reunión de 5 minutos en campo",show:!0},ingreso_campo:{value:"Cumplimiento de ingreso a campo",show:!0},llenado_correcto_sig:{value:"Aplicación y llenado correcto de los formularios del SIG",show:!0},nota_total:{value:"Nota total",show:!0}}},P.aplicacion.aplicacion.id),P.fieldViewer.updateObject(),_.stop()},P.obtenerCargos=function(){_.start(),l("RRHH_CARGO").then(function(e){P.cargos=e.clases,_.stop()},function(e){P.mostrarMensaje("Se perdió la conexión."),_.stop()})},P.obtenerCentroCosto=function(){_.start(),l("CENCOS").then(function(e){P.centrosCostos=e.clases,_.stop()},function(e){P.mostrarMensaje("Se perdió la conexión."),_.stop()})},P.buscarPersonal=function(e){if(""!=e&&null!=e)return s("filter")(P.todoPersonal,e)},P.filtrarPersonal=function(e){void 0!==P.todoPersonal?P.personalProcesado=s("filter")(P.todoPersonal,e):c(P.usuarioSesion.empresa.id).then(function(e){P.todoPersonal=e.personal,P.personalProcesado=e.personal,void 0!==e.mensaje&&P.mostrarMensaje(e.mensaje)},function(e){P.mostrarMensaje("Se perdió la conexión.")})},P.filtrarCentroCosto=function(e){void 0!==P.centrosDeCostosProcesado?P.centrosDeCostosProcesado=s("filter")(P.centrosDeCostos,e):P.centrosDeCostosProcesado=P.centrosDeCostos},P.establecerPersonal=function(e,o){void 0===P.evaluacion&&(P.evaluacion={});var a={id:e.id,persona:{nombre_completo:e.persona.nombre_completo}};P.evaluacion.personal=a,void 0!==o&&P.cerrarmodalBusquedaPersonal()},P.establecercentroCosto=function(e,o){void 0===P.reporte&&(P.reporte={}),P.reporte.campoXanio=e,void 0!==o&&P.cerrarmodalBusquedaCentroCosto()},P.abriridModalReportes=function(){P.abrirPopup(P.idModalReportes)},P.cerraridModalReportes=function(){P.cerrarPopup(P.idModalReportes)},P.abriridModalReportesGrafico=function(){P.abrirPopup(P.reporteGraficoPolifuncional)},P.cerraridModalReportesGrafico=function(){P.cerrarPopup(P.reporteGraficoPolifuncional)},P.abrirNuevoEvaluacionPolifuncional=function(){null==P.evaluacion&&(P.evaluacion={},P.evaluacion.mes={id:(new Date).getMonth()},P.evaluacion.anio={id:(new Date).getFullYear()},P.evaluacion.encargado=!1,null==P.opcion&&(P.opcion={},E.forEach(function(e){P.opcion[e]=!0})),E.forEach(function(e){P.evaluacion[e]=0}),P.evaluacion.nota_total=0),P.abrirPopup(P.idModalWizardPolifuncionalEdicion)},P.cerrarPopPupNuevoPolifuncional=function(){P.evaluacion={},P.evaluacion=void 0,P.recargarItemsTabla(),P.cerrarPopup(P.idModalWizardPolifuncionalEdicion)},P.abrirmodalParametrosPolifuncionalidad=function(){P.abrirPopup(P.idModalWizardConceptoEdicion2)},P.cerrarmodalParametrosPolifuncionalidad=function(){P.cerrarPopup(P.idModalWizardConceptoEdicion2)},P.abrirmodalBusquedaPersonal=function(){P.filtrarPersonal(""),P.abrirPopup(P.modalBusquedaPersonal)},P.cerrarmodalBusquedaPersonal=function(){P.cerrarPopup(P.modalBusquedaPersonal)},P.abrirmodalBusquedaCentroCosto=function(){P.filtrarCentroCosto(""),P.abrirPopup(P.modalBusquedaCentroCosto)},P.cerrarmodalBusquedaCentroCosto=function(){P.cerrarPopup(P.modalBusquedaCentroCosto)},P.comprobarConfiguracion=function(){if(P.empleados){var e=0;for(var o in P.empleados)P.empleados.hasOwnProperty(o)&&(e+=1)}if(P.encargados){var a=0;for(var o in P.encargados)P.encargados.hasOwnProperty(o)&&(a+=1)}return!(7<e&&7<a)},P.guardarConfiguracionEvaluacion=function(e,o,a){if("Siguiente"!=$("#siguiente-conf").text().trim()){_.start(),a.encargados=!1;o.encargados=!0;var n=[a,o];f(P.usuarioSesion.empresa.id,n).then(function(e){if(e.hasErr){e.mensaje;P.mostrarMensaje("Hubo un error. "+e.mensaje)}},function(e){P.mostrarMensaje("No hubo respuesta del servidor, se perdió la conexión.")}),g(P.usuarioSesion.empresa.id,P.listaDesempenio).then(function(e){e.hasErr?P.mostrarMensaje("Hubo uno o mas errores. "+rrores+" "+e.mensaje):P.mostrarMensaje(e.mensaje),_.stop(),P.recargarItemsTabla()}),P.cerrarmodalParametrosPolifuncionalidad()}},P.inicio()}]);