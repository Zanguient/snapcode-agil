angular.module("agil.controladores").controller("ControladorProductos",["$scope","$timeout","$filter","$window","$localStorage","$location","$templateCache","$route","blockUI","Producto","Productos","ProductosPaginador","ProductosEmpresa","ClasesTipo","Clases","ProductoKardex","ProductosEmpresaCreacion","DatoCodigoSiguienteProductoEmpresa","ListaProductosEmpresa","Paginator","ListaCuentasComprobanteContabilidad","DatosProducto","CatalogoProductos","ListaGruposProductoEmpresa","Tipos","ClasesTipoEmpresa","FieldViewer","ListaSubGruposProductoEmpresa","ListaGruposProductoUsuario","ReporteProductosKardex","GuardarProductosFormulacion",function(m,o,e,t,i,a,n,l,p,s,r,d,c,u,v,M,g,h,f,P,b,_,x,w,S,E,F,C,V,B,I){p.start(),m.idModalWizardProductoKardex="modal-wizard-producto-kardex",m.idModalWizardProductoEdicion="modal-wizard-producto-edicion",m.idModalWizardProductoVista="modal-wizard-producto-vista",m.idModalEliminarProducto="dialog-eliminar-producto",m.idModalContenedorProductoEdicion="modal-wizard-container-producto-edicion",m.idModalContenedorProductoVista="modal-wizard-container-producto-vista",m.idModalContenedorProductoKardex="modal-wizard-container-producto-kardex",m.idImagenProducto="imagen-producto",m.idModalReporteProductosKardex="dialog-reporte-productos-kardex",m.idModalConceptoEdicion="dialog-conceptos",m.usuario=JSON.parse(i.usuario),m.inicio=function(){m.obtenerTipoProducto(),m.obtenerProductos(),m.obtenerSucursales(),m.obtenerGruposProductosEmpresaUsuario(),m.obtenerSubGruposProductosEmpresa(),m.obtenerTiposPrecio(),m.usarValuado=!0},m.obtenerColumnasAplicacion=function(){m.fieldViewer=F({crear:!0,id_empresa:m.usuario.id_empresa,configuracion:{publicado_panel:{value:"¿Publicado Panel?",show:!0},inventario_activado:{value:"¿Inventario Activado?",show:!0},codigo:{value:"Código",show:!0},nombre:{value:"Nombre",show:!0},imagen:{value:"Imagen",show:!0},unidad_medida:{value:"Unidad de Medida",show:!0},precio_unitario:{value:"Precio Unitario",show:!0},inventario_minimo:{value:"Inventario Mínimo",show:!0},descripcion_uno:{value:"Descripcion",show:!0},carac_esp_uno:{value:"Carac. Esp. 1",show:!0},carac_esp_dos:{value:"Carac. Esp. 2",show:!0},grupo:{value:"Grupo",show:!0},subgrupo:{value:"Subgrupo",show:!0},tipo_producto:{value:"Tipo Producto",show:!0}}},m.aplicacion.aplicacion.id),m.fieldViewer.updateObject()},m.obtenerGruposProductosEmpresaUsuario=function(){p.start(),V(m.usuario.id_empresa,m.usuario.id).then(function(o){p.stop(),0<o.length?m.gruposProducto=o:(m.gruposProducto=[],m.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(o){m.gruposProducto=[]})},m.reporteProductosKardex=function(o){p.start(),null==o.grupo&&(o.grupo=0),B(m.usuario.id_empresa,o).then(function(o){if(0==o.length)m.mostrarMensaje("No existen datos"),p.stop();else for(var e=0;e<o.length;e++)if(o[e]=m.generarKardexProductoReporte(o[e]),e===o.length-1){var t=[];t.push(["Código","Nombre","Unidad Medida","Saldo Fisico","Saldo Valuado"]);for(e=0;e<o.length;e++){var i=[];i.push(o[e].codigo),i.push(o[e].nombre),i.push(o[e].unidad_medida),i.push(o[e].detallesMovimiento[o[e].detallesMovimiento.length-1].saldoFisico),i.push(o[e].detallesMovimiento[o[e].detallesMovimiento.length-1].saldoV),t.push(i)}var a="SheetJS",n=new Workbook,l=sheet_from_array_of_arrays(t);l["!cols"]=[{wch:15},{wch:20},{wch:15},{wch:15}],n.SheetNames.push(a),n.Sheets[a]=l;var r=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"Catálogo productos.xlsx"),p.stop()}})},m.generarKardexProductoReporte=function(o){var e=o;m.Math=Math,e.detallesMovimiento.sort(function(o,e){return o.id-e.id});for(var t=0;t<e.detallesMovimiento.length;t++)e.detallesMovimiento[t].costo_unitario=Math.round(.87*e.detallesMovimiento[t].costo_unitario*100)/100,0==t&&"SALDO ANTERIOR"==e.detallesMovimiento[t].tipo?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].saldoFisico,e.detallesMovimiento[t].saldoValuado=e.detallesMovimiento[t].saldoValuado,e.detallesMovimiento[t].costo_unitario=Math.round(100*e.detallesMovimiento[t].costo_unitario/87*100)/100):0==t&&e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING&&e.detallesMovimiento[t].movimiento.clase.nombre_corto==m.diccionario.ING_INV_INICIAL?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].saldoFisico*e.detallesMovimiento[t].costo_unitario*100)/100,e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre):0==t&&e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].saldoFisico*e.detallesMovimiento[t].costo_unitario*100)/100,e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre):0==t&&e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_EGR?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].saldoFisico*e.detallesMovimiento[t].costo_unitario*100)/100,e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre):e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico+e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado+e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100,e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre):e.detallesMovimiento[t].movimiento.venta?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico-e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado-e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100,e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre+" Nro. "+e.detallesMovimiento[t].movimiento.venta.factura):(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico-e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado-e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100,e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre),e.detallesMovimiento[t].saldoV=e.detallesMovimiento[t].saldoValuado.toFixed(2);return e},m.obtenerSubGruposProductosEmpresa=function(){C(m.usuario.id_empresa).then(function(o){m.subgruposProducto=o})},m.activoFijoAplicarDatePicker=function(){m.producto.activo_fijo&&o(function(){aplicarDatePickers()},400)},m.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsProducto(m.idModalWizardProductoEdicion,m.idModalWizardProductoVista,m.idModalWizardProductoKardex,m.idModalEliminarProducto,m.idModalContenedorProductoEdicion,m.idModalContenedorProductoVista,m.idModalContenedorProductoKardex,m.idImagenProducto,m.idModalReporteProductosKardex,m.idModalConceptoEdicion),m.buscarAplicacion(m.usuario.aplicacionesUsuario,a.path().substring(1)),m.obtenerColumnasAplicacion(),p.stop()}),m.crearNuevoProducto=function(){m.tipoDePrecio={eliminado:!1},m.steps=[{cabeza:"cabeza-datos-producto",cuerpo:"cuerpo-datos-producto"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"},{cabeza:"cabeza-tipo-producto",cuerpo:"cuerpo-tipo-producto"}],h(m.usuario.id_empresa).then(function(o){m.ultimo_codigo="FC"+o.ultimo_codigo,m.producto=new s({tiposPrecio:[],productosBase:[],id_empresa:m.usuario.id_empresa,imagen:"./img/icon-producto-default.png"}),m.usuario.empresa.usar_consumos||(m.producto.tipoProducto=$.grep(m.tipoProductos,function(o){return o.nombre_corto==m.diccionario.TIPO_PRODUCTO_BASE})[0]),m.producto.codigo="FC"+(o.ultimo_codigo+1),m.productoBaseSeleccion={},m.abrirPopup(m.idModalWizardProductoEdicion)})},m.verProducto=function(o){_(o.id).then(function(o){m.producto=o,m.producto.publicar_panel=1==m.producto.publicar_panel,m.producto.activar_inventario=1==m.producto.activar_inventario;for(var e=m.producto.totalBase=0;e<m.producto.productosBase.length;e++)m.producto.totalBase=m.producto.totalBase+m.producto.productosBase[e].productoBase.precio_unitario*m.producto.productosBase[e].formulacion;m.productoBaseSeleccion={},m.producto.almacenErp&&(m.producto.sucursal_erp=m.producto.almacenErp.sucursal,m.obtenerAlmacenes(m.producto.sucursal_erp.id)),m.abrirPopup(m.idModalWizardProductoVista)})},m.cerrarPopPupVista=function(){m.cerrarPopup(m.idModalWizardProductoVista)},m.cerrarPopPupEdicion=function(){m.cerrarPopup(m.idModalWizardProductoEdicion)},m.cerrarPopPupKardex=function(){m.obtenerProductos(),m.cerrarPopup(m.idModalWizardProductoKardex),m.search.inventario.lote=""},m.abrirModalReporteProductosKardex=function(){m.imp={},m.abrirPopup(m.idModalReporteProductosKardex)},m.cerrarModalReporteProductosKardex=function(){m.imp={},m.cerrarPopup(m.idModalReporteProductosKardex)},m.kardexProducto=function(o){m.producto=o,m.kardexproduto=null,m.filtro={},m.imp={},m.imp.sucursal=1==m.sucursales.length?m.sucursales[0]:null,m.imp.sucursal&&(m.obtenerAlmacenes(m.imp.sucursal.id),m.imp.almacen=1==m.almacenes.length?m.almacenes[0]:null),$("#modal-wizard-producto-kardex").dialog({closeOnEscape:!1}),m.abrirPopup(m.idModalWizardProductoKardex)},m.obtenerDetallesEmpresa=function(o,e,t,i,a){m.paginator=P(),m.paginator.column="razon_social",m.paginator.direccion="asc",m.filtroDetallesProducto={id_producto:o,id_almacen:e,fecha_inicio:t,fecha_fin:i,lote:a},m.paginator.callBack=m.filtroProductoKardex,m.paginator.getSearch("",m.filtroDetallesProducto,null)},m.buscarKardexProducto=function(o,e,t){p.start();var i=""==t.fechaInicioTexto||null==t.fechaInicioTexto?0:new Date(m.convertirFecha(t.fechaInicioTexto)),a=""==t.fechaFinTexto||null==t.fechaFinTexto?0:new Date(m.convertirFecha(t.fechaFinTexto)),n=""==t.lote||null==t.lote?0:t.lote;if(m.idProducto=o,m.idAlmacen=e.id,m.kardexproduto=null,0!=i){var l=M(o,e.id,0,i,n);l.then(function(o){var e=m.obtenerSaldo(o);(l=M(m.idProducto,m.idAlmacen,i,a,n)).then(function(o){0!=e&&o.unshift(e),m.generarKardexProducto(o),p.stop()})})}else m.obtenerDetallesEmpresa(m.idProducto,m.idAlmacen,i,a,n)},m.filtroProductoKardex=function(){M(m.paginator).then(function(o){m.generarKardexProducto(o.kardex),m.paginator.setPages(o.paginas),p.stop()})},m.generarKardexProducto=function(o){var e=m.producto;e.detallesMovimiento=o,m.Math=Math;for(var t=0;t<e.detallesMovimiento.length;t++)e.detallesMovimiento[t].movimiento?(e.detallesMovimiento[t].costo_unitario=Math.round(.87*e.detallesMovimiento[t].costo_unitario*100)/100,0==t&&"SALDO ANTERIOR"==e.detallesMovimiento[t].tipo?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].saldoFisico,e.detallesMovimiento[t].saldoValuado=e.detallesMovimiento[t].saldoValuado,e.detallesMovimiento[t].costo_unitario=Math.round(100*e.detallesMovimiento[t].costo_unitario/87*100)/100):0==t&&e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING&&e.detallesMovimiento[t].movimiento.clase.nombre_corto==m.diccionario.ING_INV_INICIAL?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].saldoFisico*e.detallesMovimiento[t].costo_unitario*100)/100,null!=e.detallesMovimiento[t].movimiento.compra?e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre+" Nro. "+e.detallesMovimiento[t].movimiento.compra.factura:e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre,null!=e.detallesMovimiento[t].inventario?e.detallesMovimiento[t].lote=e.detallesMovimiento[t].inventario.lote:e.detallesMovimiento[t].lote=""):0==t&&e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].saldoFisico*e.detallesMovimiento[t].costo_unitario*100)/100,null!=e.detallesMovimiento[t].movimiento.compra?e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre+" Nro. "+e.detallesMovimiento[t].movimiento.compra.factura:e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre,null!=e.detallesMovimiento[t].inventario?e.detallesMovimiento[t].lote=e.detallesMovimiento[t].inventario.lote:e.detallesMovimiento[t].lote=""):e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING?(0<t?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico+e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado+e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100):(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario*100)/100),e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre,null!=e.detallesMovimiento[t].inventario?e.detallesMovimiento[t].lote=e.detallesMovimiento[t].inventario.lote:e.detallesMovimiento[t].lote=""):e.detallesMovimiento[t].movimiento.venta?(0<t?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico-e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado-e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100):(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario*100)/100),e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre+" Nro. "+e.detallesMovimiento[t].movimiento.venta.factura):(0<t?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico-e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado-e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100):(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario*100)/100),e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre),e.detallesMovimiento[t].saldoV=e.detallesMovimiento[t].saldoValuado.toFixed(2)):console.log(e.detallesMovimiento[t]);m.kardexproduto=e},m.verificarLote=function(o,e){""==o.lote&&m.buscarKardexProducto(m.producto.id,e,o)},m.obtenerSaldo=function(o){var e={};e.detallesMovimiento=o;for(var t=0;t<e.detallesMovimiento.length;t++)e.detallesMovimiento[t].costo_unitario=Math.round(.87*e.detallesMovimiento[t].costo_unitario*100)/100,0==t&&e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING&&e.detallesMovimiento[t].movimiento.clase.nombre_corto==m.diccionario.ING_INV_INICIAL?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].saldoFisico*e.detallesMovimiento[t].costo_unitario*100)/100,e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre):0==t&&e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].saldoFisico*e.detallesMovimiento[t].costo_unitario*100)/100,e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre):e.detallesMovimiento[t].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING?(0<t?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico+e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado+e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100):(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario*100)/100),e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre):e.detallesMovimiento[t].movimiento.venta?(0<t?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico-e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado-e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100):(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario*100)/100),e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre+" Nro. "+e.detallesMovimiento[t].movimiento.venta.factura):(0<t?(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t-1].saldoFisico-e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(100*(e.detallesMovimiento[t-1].saldoValuado-e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario))/100):(e.detallesMovimiento[t].saldoFisico=e.detallesMovimiento[t].cantidad,e.detallesMovimiento[t].saldoValuado=Math.round(e.detallesMovimiento[t].cantidad*e.detallesMovimiento[t].costo_unitario*100)/100),e.detallesMovimiento[t].tipo=e.detallesMovimiento[t].movimiento.clase.nombre),e.detallesMovimiento[t].saldoV=e.detallesMovimiento[t].saldoValuado.toFixed(2);return 0<e.detallesMovimiento.length?(e.detallesMovimiento[e.detallesMovimiento.length-1].tipo="SALDO ANTERIOR",e.detallesMovimiento[e.detallesMovimiento.length-1].movimiento.compra=null,e.detallesMovimiento[e.detallesMovimiento.length-1].movimiento.venta=null,e.detallesMovimiento[e.detallesMovimiento.length-1]):0},m.generarPdfKardexProducto=function(o,e){p.start();var t=o.detallesMovimiento,i=new PDFDocument({size:"letter",margin:10}),a=i.pipe(blobStream()),n=0,l=0,r=200,d=0,s=1,c=Math.ceil(t.length/17);m.dibujarCabeceraPDFKardexProducto(i,1,c,o,e);for(var u=0;u<t.length&&d<=17;u++)i.rect(30,r-10,555,30).stroke(),t[u].movimiento.fecha=new Date(t[u].movimiento.fecha),i.text(t[u].movimiento.fecha.getDate()+"/"+(t[u].movimiento.fecha.getMonth()+1)+"/"+t[u].movimiento.fecha.getFullYear(),40,r-2),0==u?(i.text(t[u].tipo,90,r-2),i.text(t[u].costo_unitario,210,r-2,{width:50,align:"right"}),i.text(t[u].cantidad,265,r-2,{width:50,align:"right"}),n+=t[u].cantidad,i.text(t[u].saldoFisico,360,r-2,{width:50,align:"right"}),e&&(i.text(Math.round(t[u].cantidad*t[u].costo_unitario*100)/100,420,r-2,{width:50,align:"right"}),dsaldoValuado=l+n*t[u].costo_unitario,i.text(t[u].saldoV,510,r-2,{width:50,align:"right"}))):(i.text(t[u].tipo,90,r-6),t[u].movimiento.tipo.nombre_corto==m.diccionario.MOV_ING?(t[u].movimiento.compra&&i.text(t[u].movimiento.compra.proveedor.razon_social,90,r+2,{width:150}),i.text(t[u].costo_unitario,210,r-2,{width:50,align:"right"}),i.text(t[u].cantidad,265,r-2,{width:50,align:"right"}),n+=t[u].cantidad,i.text(t[u].saldoFisico,360,r-2,{width:50,align:"right"}),e&&(i.text(Math.round(t[u].cantidad*t[u].costo_unitario*100)/100,420,r-2,{width:50,align:"right"}),l+=n*t[u].costo_unitario,i.text(t[u].saldoV,510,r-2,{width:50,align:"right"}))):(t[u].movimiento.venta.cliente&&i.text(t[u].movimiento.venta.cliente.razon_social,90,r+2,{width:150}),i.text(t[u].costo_unitario,210,r-2,{width:50,align:"right"}),i.text(t[u].cantidad,310,r-2,{width:50,align:"right"}),n-=t[u].cantidad,i.text(t[u].saldoFisico,360,r-2,{width:50,align:"right"}),e&&(i.text(t[u].total,460,r-2,{width:50,align:"right"}),l=Math.round(100*(l+n*t[u].costo_unitario))/100,i.text(t[u].saldoV,510,r-2,{width:50,align:"right"})))),r+=30,17==++d&&(i.addPage({margin:0,bufferPages:!0}),r=200,d=0,s+=1,m.dibujarCabeceraPDFKardexProducto(i,s,c,o,e),i.font("Helvetica",8));i.end(),a.on("finish",function(){var o=a.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),p.stop()},m.usarValuadoKardex=function(){m.usarValuado=!m.usarValuado},m.dibujarCabeceraPDFKardexProducto=function(o,e,t,i,a){o.font("Helvetica-Bold",8),o.text(m.usuario.empresa.razon_social,30,15);var n=new Date,l=n.getMinutes();l<10&&(l="0"+l),1==a?(o.font("Helvetica-Bold",10),o.text(i.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,30,25,{align:"left"}),o.text("KARDEX PRODUCTO",0,65,{align:"center"}),o.font("Helvetica",10),o.text(i.detallesMovimiento[0].movimiento.almacen.sucursal.direccion,30,35,{align:"left"}),o.text("TELF.: "+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono1+"-"+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono2+"-"+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono3,30,45,{align:"left"}),o.font("Helvetica-Bold",8),o.text("PÁGINA "+e+" DE "+t,0,740,{align:"center"}),o.rect(30,90,555,70).stroke(),o.font("Helvetica-Bold",8),o.text("Producto : ",45,100),o.text("Descripcion : ",45,120),o.text("Unidad de Medida : ",45,140),o.font("Helvetica",7),o.text("Sucursal : "+i.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,475,100),o.text("Almacen : "+i.detallesMovimiento[0].movimiento.almacen.nombre,475,110),o.font("Helvetica-Bold",11).fillColor("red"),o.text("Codigo : "+i.codigo,475,120),o.font("Helvetica",8).fillColor("black"),o.text(i.nombre,120,100),o.text(i.descripcion,120,120),o.text(i.unidad_medida,120,140),o.rect(30,160,555,30).stroke(),o.font("Helvetica-Bold",8),o.text("Fecha",45,170),o.text("Detalle",100,170,{width:50}),o.text("c/u",250,170,{width:60}),o.rect(275,160,150,30).stroke(),o.text("Fisico",340,165,{width:50}),o.text("Valuado",485,165,{width:50}),o.rect(275,160,150,15).stroke(),o.text("Ingreso",290,180,{width:50}),o.text("Salida",340,180,{width:50}),o.text("Saldo",390,180,{width:50}),o.rect(425,160,160,15).stroke(),o.text("Ingreso",440,180,{width:50}),o.text("salida",490,180,{width:50}),o.text("Saldo",540,180,{width:50})):(o.font("Helvetica-Bold",10),o.text(i.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,30,25,{align:"left"}),o.text("KARDEX PRODUCTO",0,65,{align:"center"}),o.font("Helvetica",10),o.text(i.detallesMovimiento[0].movimiento.almacen.sucursal.direccion,30,35,{align:"left"}),o.text("TELF.: "+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono1+"-"+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono2+"-"+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono3,30,45,{align:"left"}),o.font("Helvetica-Bold",8),o.text("PÁGINA "+e+" DE "+t,0,740,{align:"center"}),o.rect(30,90,555,70).stroke(),o.font("Helvetica-Bold",8),o.text("Producto : ",45,100),o.text("Descripcion : ",45,120),o.text("Unidad de Medida : ",45,140),o.font("Helvetica",7),o.text("Sucursal : "+i.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,475,100),o.text("Almacen : "+i.detallesMovimiento[0].movimiento.almacen.nombre,475,110),o.font("Helvetica-Bold",11).fillColor("red"),o.text("Codigo : "+i.codigo,475,120),o.font("Helvetica",8).fillColor("black"),o.text(i.nombre,120,100),o.text(i.descripcion,120,120),o.text(i.unidad_medida,120,140),o.rect(30,160,555,30).stroke(),o.font("Helvetica-Bold",8),o.text("Fecha",45,170),o.text("Detalle",100,170,{width:50}),o.text("c/u",250,170,{width:60}),o.rect(275,160,150,30).stroke(),o.text("Fisico",340,165,{width:50}),o.rect(275,160,150,15).stroke(),o.text("Ingreso",290,180,{width:50}),o.text("Salida",340,180,{width:50}),o.text("Saldo",390,180,{width:50})),o.font("Helvetica",7),o.text("usuario : "+m.usuario.nombre_usuario,475,740),o.text("fecha : "+n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear()+"  "+n.getHours()+":"+l,475,750)},m.generarExcelKardexProducto=function(o,e){o.detallesMovimiento;p.start();var t=[];t.push(["Codigo","Producto","Fecha","Detalle","Ingreso","Salida","Lote","Fecha Vencimiento"]);for(var i=0;i<o.detallesMovimiento.length;i++){var a=[];if(a.push(o.codigo),a.push(o.nombre),o.detallesMovimiento[i].movimiento.fecha){var n=new Date(o.detallesMovimiento[i].movimiento.fecha);a.push(n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear())}else a.push(" ");o.detallesMovimiento[i].movimiento.venta?o.detallesMovimiento[i].movimiento.venta.cliente?a.push(o.detallesMovimiento[i].tipo+" "+o.detallesMovimiento[i].movimiento.venta.cliente.razon_social):a.push(o.detallesMovimiento[i].tipo):o.detallesMovimiento[i].movimiento.venta?a.push(" "):a.push(o.detallesMovimiento[i].tipo),7!=o.detallesMovimiento[i].movimiento.id_tipo&&o.detallesMovimiento[i].cantidad?a.push(o.detallesMovimiento[i].cantidad):a.push(" "),6!=o.detallesMovimiento[i].movimiento.id_tipo&&o.detallesMovimiento[i].cantidad?a.push(o.detallesMovimiento[i].cantidad):a.push(" "),null!=o.detallesMovimiento[i].inventario?(a.push(o.detallesMovimiento[i].inventario.lote),a.push(o.detallesMovimiento[i].inventario.fecha_vencimiento)):(a.push(o.detallesMovimiento[i].lote),a.push(" ")),t.push(a)}var l="SheetJS",r=new Workbook,d=sheet_from_array_of_arrays(t);r.SheetNames.push(l),r.Sheets[l]=d;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"REPORTE-USUARIOS.xlsx"),p.stop()},m.modificarProducto=function(o){m.tipoDePrecio={eliminado:!1},m.steps=[{cabeza:"cabeza-datos-producto",cuerpo:"cuerpo-datos-producto"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"},{cabeza:"cabeza-tipo-producto",cuerpo:"cuerpo-tipo-producto"}],_(o.id).then(function(o){m.producto=o,m.producto.publicar_panel=1==m.producto.publicar_panel,m.producto.activar_inventario=1==m.producto.activar_inventario;for(var e=m.producto.totalBase=0;e<m.producto.productosBase.length;e++)m.producto.totalBase=m.producto.totalBase+m.producto.productosBase[e].productoBase.precio_unitario*m.producto.productosBase[e].formulacion;m.productoBaseSeleccion={},m.producto.almacenErp&&(m.producto.sucursal_erp=m.producto.almacenErp.sucursal,m.obtenerAlmacenes(m.producto.sucursal_erp.id)),m.abrirPopup(m.idModalWizardProductoEdicion)})},m.mostrarConfirmacionEliminacion=function(o){m.producto=new s(o),m.abrirPopup(m.idModalEliminarProducto),console.log(o)},m.cerrarConfirmacionEliminacion=function(){m.cerrarPopup(m.idModalEliminarProducto)},m.eliminarProducto=function(o){p.start(),m.cerrarConfirmacionEliminacion(),o.$delete().then(function(o){console.log(o),m.mostrarMensaje(o.message)}),m.recargarItemsTabla(),p.stop()},m.obtenerSucursales=function(){for(var o=[],e=0;e<m.usuario.sucursalesUsuario.length;e++)o.push(m.usuario.sucursalesUsuario[e].sucursal);m.sucursales=o},m.obtenerAlmacenes=function(e){m.almacenes=[];var o=$.grep(m.sucursales,function(o){return o.id==e})[0];m.almacenes=o.almacenes},m.establecerAlmacen=function(o){m.id_almacen=o},m.saveForm=function(o,e){o&&("Siguiente"!=$("#siguiente").text().trim()&&m.guardarProducto(e,!0))},m.establecerProductoBase=function(o){m.productoBase={id:o.id,nombre:o.nombre,formulacion:0,unidad_medida:o.unidad_medida}},m.actualizarProducto=function(e){_(e.id).then(function(o){o.publicar_panel=e.publicar_panel,o.activar_inventario=e.activar_inventario,m.guardarProducto(o,!1)})},m.guardarProducto=function(o,r){p.start();var d=o.imagen;o.usuario=m.usuario.id,o.id?s.update({idProducto:o.id},o,function(o){if(null==o.signedRequest)p.stop(),m.cerrarPopPupEdicion(),m.mostrarMensaje("Actualizado Exitosamente!"),r&&m.recargarItemsTabla();else{var e=new XMLHttpRequest;e.open("PUT",o.signedRequest),e.onreadystatechange=function(){4===e.readyState&&(200===e.status?(p.stop(),m.cerrarPopPupEdicion(),m.mostrarMensaje("Actualizado Exitosamente!"),r&&m.recargarItemsTabla()):alert("Could not upload file."))};for(var t=atob(d.split(",")[1]),i=[],a=0;a<t.length;a++)i.push(t.charCodeAt(a));var n=new Blob([new Uint8Array(i)],{type:"image/jpeg"}),l=new File([n],o.image_name,{type:"image/jpeg"});console.log(l),e.send(l)}}):o.$save(function(o){if(null==o.signedRequest)p.stop(),m.producto=new s({}),m.cerrarPopPupEdicion(),m.mostrarMensaje("Guardado Exitosamente!"),r&&m.recargarItemsTabla();else{var e=new XMLHttpRequest;e.open("PUT",o.signedRequest),e.onreadystatechange=function(){4===e.readyState&&(200===e.status?(p.stop(),m.producto=new s({}),m.cerrarPopPupEdicion(),m.mostrarMensaje("Guardado Exitosamente!"),r&&m.recargarItemsTabla()):alert("Could not upload file."))};for(var t=atob(d.split(",")[1]),i=[],a=0;a<t.length;a++)i.push(t.charCodeAt(a));var n=new Blob([new Uint8Array(i)],{type:"image/jpeg"}),l=new File([n],o.image_name,{type:"image/jpeg"});e.send(l)}},function(o){p.stop(),m.cerrarPopPupEdicion(),m.mostrarMensaje("Ocurrio un problema al momento de guardar!"),r&&m.recargarItemsTabla()})},m.obtenerTipoProducto=function(){p.start(),u("TPS").then(function(o){m.tipoProductos=o.clases,p.stop()})},m.eliminarDetalleProductosBase=function(o){o.eliminado=!0,m.producto.totalBase=m.producto.totalBase-o.productoBase.precio_unitario*o.formulacion},m.agregarDetalleProductosBase=function(o,e){e.formulacion=o.formulacion,console.log(e),m.producto.productosBase.push({productoBase:e,formulacion:o.formulacion}),m.productoBase={},m.productoBaseSeleccion={};for(var t=m.producto.totalBase=0;t<m.producto.productosBase.length;t++)m.producto.totalBase=m.producto.totalBase+m.producto.productosBase[t].productoBase.precio_unitario*m.producto.productosBase[t].formulacion,console.log(m.producto.totalBase);console.log(m.producto.productosBase)},m.obtenerProductos=function(){m.paginator=P(),m.paginator.column="nombre",m.paginator.filter=m.grupo,m.paginator.callBack=m.buscarProductos,m.paginator.getSearch("",null,null)},m.buscarProducto=function(o){if(""!=o&&null!=o)return f(m.usuario.id_empresa,o)},m.buscarProductos=function(){p.start(),m.paginator.filter=void 0!==m.grupo?m.grupo:{id:0},d(m.usuario.id_empresa,m.paginator,m.usuario.id).then(function(o){if(o.hasErr)m.mostrarMensaje(o.mensaje);else{m.paginator.setPages(o.paginas),m.productos=o.productos;for(var e=0;e<m.productos.length;e++)m.productos[e].publicar_panel=1==m.productos[e].publicar_panel,m.productos[e].activar_inventario=1==m.productos[e].activar_inventario}p.stop()}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(e),p.stop()})},m.descargarCatalogo=function(r){if(p.start(),r)var d=["N°","Campo","Empleado","C.I.","Estado","Cargo"],s=[];else{d=["Código","Nombre","Unidad Medida","Precio Unitario","Descripcion","Inventario Mínimo","Grupo","Sub-grupo","Caracteristica Especial-1","Caracteristica Especial-2","Código de Fabrica","Comisión (%)","Alerta","Descuento","Descuento Elección"];var c=[{wch:10},{wch:20},{wch:15},{wch:15},{wch:25},{wch:15},{wch:7},{wch:9},{wch:20},{wch:20},{wch:15},{wch:10},{wch:8},{wch:10},{wch:15}];s=[]}var u=[];x(m.usuario.id_empresa,void 0!==m.grupo?m.grupo:{id:0},m.usuario.id).then(function(o){if(0==o.catalogo.length)return m.mostrarMensaje("No existen datos"),void p.stop();if(o.hasErr)m.mostrarMensaje(o.mensaje);else{for(var e=0;e<o.catalogo.length;e++){if(r)var t=[];else t=[];t.push(o.catalogo[e].codigo),t.push(o.catalogo[e].nombre),t.push(o.catalogo[e].unidad_medida),t.push(o.catalogo[e].precio_unitario),t.push(o.catalogo[e].descripcion),t.push(o.catalogo[e].inventario_minimo),t.push(null!==o.catalogo[e].grupo&&void 0!==o.catalogo[e].grupo?o.catalogo[e].grupo.nombre:"Sin grupo"),t.push(null!==o.catalogo[e].subgrupo&&void 0!==o.catalogo[e].subgrupo?o.catalogo[e].subgrupo.nombre:"Sin subgrupo"),t.push(o.catalogo[e].caracteristica_especial1),t.push(o.catalogo[e].caracteristica_especial2),t.push(o.catalogo[e].codigo_fabrica),t.push(o.catalogo[e].comision),t.push(o.catalogo[e].alerta),t.push(o.catalogo[e].descuento),t.push(o.catalogo[e].descuento_fijo),u.push(t)}if(s.push(d),u.map(function(o){s.push(o)}),r)grafico?m.reportePorMesGrafico(s,mesesReporte):(p.stop(),m.reportePorMesesPdf(s,fromMonth,fromYear,untilMonth,untilYear));else{var i="SheetJS",a=new Workbook,n=sheet_from_array_of_arrays(s);n["!cols"]=c,a.SheetNames.push(i),a.Sheets[i]=n;var l=XLSX.write(a,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"Catálogo productos.xlsx"),p.stop()}}}).catch(function(o){var e=void 0!==o.data&&null!==o.data?o.data+(void 0!==o.stack&&null!==o.stack?" "+o.stack:""):void 0!==o.message&&null!==o.message?o.message:"ERROR";m.mostrarMensaje("Se produjo un error! "+e),p.stop()})},m.subirExcelProductos=function(o){var e,t,i=o.target.files;for(t=i[e=0];e!=i.length;++e){var a=new FileReader;t.name;a.onload=function(o){p.start();var e=o.target.result,t=XLSX.read(e,{type:"binary"}),i=t.SheetNames[0],a=2,n=t.Sheets[i],l=[];do{var r={};r.codigo=null!=n["A"+a]&&""!=n["A"+a]?n["A"+a].v.toString():null,r.nombre=null!=n["B"+a]&&""!=n["B"+a]?n["B"+a].v.toString():null,r.unidad_medida=null!=n["C"+a]&&""!=n["C"+a]?n["C"+a].v.toString():null,r.precio_unitario=null!=n["D"+a]&&""!=n["D"+a]?parseFloat(n["D"+a].v.toString()):null,r.descripcion=null!=n["E"+a]&&""!=n["E"+a]?n["E"+a].v.toString():null,r.inventario_minimo=null!=n["F"+a]&&""!=n["F"+a]?parseInt(n["F"+a].v.toString()):null,r.grupo=null!=n["G"+a]&&""!=n["G"+a]?n["G"+a].v.toString():null,r.subgrupo=null!=n["H"+a]&&""!=n["H"+a]?n["H"+a].v.toString():null,r.caracteristica_especial1=null!=n["I"+a]&&""!=n["I"+a]?n["I"+a].v.toString():null,r.caracteristica_especial2=null!=n["J"+a]&&""!=n["J"+a]?n["J"+a].v.toString():null,r.codigo_fabrica=null!=n["K"+a]&&""!=n["K"+a]?n["K"+a].v.toString():null,r.comision=null!=n["L"+a]&&""!=n["L"+a]?parseFloat(n["L"+a].v.toString()):null,r.alerta=null!=n["M"+a]&&""!=n["M"+a]?parseFloat(n["M"+a].v.toString()):null,r.descuento=null!=n["N"+a]&&""!=n["N"+a]?parseFloat(n["N"+a].v.toString()):null,r.descuento_fijo=null!=n["O"+a]&&""!=n["N"+a]?1==parseInt(n["O"+a].v.toString()):null,r.marca=null!=n["P"+a]&&""!=n["P"+a]?n["P"+a].v.toString():null,r.tipo_producto=null!=n["Q"+a]&&""!=n["Q"+a]?n["Q"+a].v.toString():null,l.push(r),a++,0}while(null!=n["A"+a]);m.guardarProductos(l),p.stop()},a.readAsBinaryString(t)}},m.guardarProductos=function(o){new g({productos:o,id_empresa:m.usuario.id_empresa}).$save(function(o){p.stop(),m.mostrarMensaje("Guardado Exitosamente!"),m.recargarItemsTabla()},function(o){p.stop(),m.mostrarMensaje("Ocurrio un problema al momento de guardar!"),m.recargarItemsTabla()})},m.subirExcelFormulacionProductos=function(o){var e,t,i=o.target.files;for(t=i[e=0];e!=i.length;++e){var a=new FileReader;t.name;a.onload=function(o){p.start();var e=o.target.result,t=XLSX.read(e,{type:"binary"}),i=t.SheetNames[0],a=2,n=t.Sheets[i],l=[];do{var r={};r.codigo_final=null!=n["A"+a]&&""!=n["A"+a]?n["A"+a].v.toString():null,r.nombre_final=null!=n["B"+a]&&""!=n["B"+a]?n["B"+a].v.toString():null,r.nombre_base=null!=n["C"+a]&&""!=n["C"+a]?n["C"+a].v.toString():null,r.codigo_base=null!=n["D"+a]&&""!=n["D"+a]?parseFloat(n["D"+a].v.toString()):null,r.formulacion=null!=n["E"+a]&&""!=n["E"+a]?n["E"+a].v.toString():null,l.push(r),a++,0}while(null!=n["A"+a]);m.guardarFormulacionProductos(l),p.stop()},a.readAsBinaryString(t)}},m.guardarFormulacionProductos=function(o){I(m.usuario.id_empresa,o).then(function(o){o.hasErr?m.mostrarMensaje(o.mensajes):o.mensajes?m.mostrarMensaje(o.mensaje+o.mensajes):m.mostrarMensaje(o.mensaje),p.stop()}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";m.mostrarMensaje(e),p.stop()})},m.buscarCuenta=function(o){if(""!=o&&null!=o)return b(m.usuario.id_empresa,o)},m.abrirDialogConceptoEdicion=function(o){m.tipo_edicion=o,m.clase={},m.abrirPopup(m.idModalConceptoEdicion)},m.cerrarDialogConceptoEdicion=function(){m.cerrarPopup(m.idModalConceptoEdicion)},m.agregarConceptoEdicion=function(o){o.nombre&&o.nombre_corto&&(-1==m.tipo_edicion.clases.indexOf(o)&&m.tipo_edicion.clases.push(o),m.clase={})},m.modificarConceptoEdicion=function(o){m.clase=o},m.removerConceptoEdicion=function(o){o.eliminado=!0},m.guardarConceptoEdicion=function(e){p.start(),S.update({id_tipo:e.id},e,function(o){u(e.nombre_corto).then(function(o){e=o,p.stop(),m.cerrarDialogConceptoEdicion(),m.mostrarMensaje("Guardado Exitosamente!")})})},m.obtenerTiposPrecio=function(){p.start(),E("T_PAGO_PRODUCTO",m.usuario.id_empresa).then(function(o){m.tiposPrecios=o,p.stop()})},m.agregarTipoPrecio=function(o,e){o.tipoPrecio&&o.precio_unitario?(e.tipoprecio.$invalid=!1,e.PrecioProductoTipo.$invalid=!1,o.edit||m.producto.tiposPrecio.push(o),m.tipoDePrecio={eliminado:!1}):(e.tipoprecio.$invalid=!0,e.PrecioProductoTipo.$invalid=!0)},m.editarTipoPrecioProducto=function(o){m.tipoDePrecio=o,m.tipoDePrecio.edit=!0},m.eliminarTipoPrecioProducto=function(o,e){o.id?o.eliminado=!0:m.producto.tiposPrecio.splice(e,1)},m.$on("$routeChangeStart",function(o,e){m.eliminarPopup(m.idModalWizardProductoEdicion),m.eliminarPopup(m.idModalWizardProductoVista),m.eliminarPopup(m.idModalEliminarProducto),m.eliminarPopup(m.idModalWizardProductoKardex),m.eliminarPopup(m.idModalReporteProductosKardex),m.eliminarPopup(m.idModalConceptoEdicion)}),m.inicio()}]);