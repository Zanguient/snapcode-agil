angular.module("agil.controladores").controller("ControladorCajaChica",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipoEmpresa","ClasesTipo","GuardarSolicitudCajaChica","GuardarConceptoMovimientoCajaChica","ObtenerConceptoMovimientoCajaChica","SolicitudesCajaPaginador","SolicitudesCajaChicaPaginador","ObtenerTodoPersonal","$filter","Paginator","VerificarUsuarioEmpresa","NuevoComprobante","ConfiguracionCompraVista","ConfiguracionesCuentasEmpresa","ConfiguracionCompraVistaDatos","ProveedoresNit","GuardarCajaChica","ListaProductosEmpresaUsuario","VerificarUsuarioEmpresaCaja","IngresosCajaPaginador","ObtenerDatosCierreCaja","CierreCajaCPaginador","FieldViewer",function(u,a,o,i,e,d,c,t,r,n,s,l,p,C,m,h,j,f,g,_,v,b,M,P,S,E,I,O,A){u.usuario=JSON.parse(a.usuario),u.idModalSolicitudCajaChica="dialog-solicitud",u.idModalConceptosMovimiento="dialog-conceptos-movimiento",u.idModalEliminarSolicitud="dialog-eliminar-solicitud",u.idModalVerificarAutorizacion="modal-verificar-autorizacion",u.idModalRegistroCajaChica="dialog-registro-caja-chica",u.idModalKardexCajaChica="dialog-kardex-caja-chica",u.idModalIngresosCajaChica="dialog-kardex-ingresos",u.idModalRegistroIngresoCajaChica="dialog-registro-ingreso-caja-chica",u.idModalHistorialCierreCajaChica="dialog-kardex-cierre-caja-chica",u.idModalRegistroDesembolsoCajaChica="dialog-registro-desembolso-caja-chica",u.idModalServicios="dialog-servicios",u.idModalRegistroAnticipoCajaChica="dialog-registro-anticipo-caja-chica",u.inicio=function(){u.sucursales=u.obtenerSucursales(),u.sucursalPrincipal=u.usuario.sucursalesUsuario[0].sucursal,u.obtenerTiposMovimiento(),u.obtenerConceptosMovimiento(),u.obtenerTiposEstados(),u.obtenerListaSolicitudes(),u.obtenerMovimientosIngreso(),u.obtenerTiposDePago(),u.obtenerCentrosDeCosto(),u.obtenerConfiguracionCompraVista(),u.obtenerconfiuracionCuentas(),u.obtenerServicios(),u.ConceptosMovimiento=[],u.tipoFiltro="TODOS",u.verificacionDatos=!0},u.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptsCajaChicas(u.idModalSolicitudCajaChica,u.idModalConceptosMovimiento,u.idModalEliminarSolicitud,u.idModalVerificarAutorizacion,u.idModalRegistroCajaChica,u.idModalKardexCajaChica,u.idModalIngresosCajaChica,u.idModalRegistroIngresoCajaChica,u.idModalHistorialCierreCajaChica,u.idModalRegistroDesembolsoCajaChica,u.idModalServicios,u.idModalRegistroAnticipoCajaChica),u.buscarAplicacion(u.usuario.aplicacionesUsuario,o.path().substring(1)),u.obtenerColumnasAplicacion(),d.stop()}),u.obtenerColumnasAplicacion=function(){u.fieldViewer=A({crear:!0,id_empresa:u.usuario.id_empresa,configuracion:{usuario_solicitante:{value:"usuario_solicitante",show:!0},fecha:{value:"fecha",show:!0},beneficiario:{value:"Beneficiario",show:!0},autorizador:{value:"Autorizador",show:!0},verificador:{value:"Verificador",show:!0},movimiento:{value:"Movimiento",show:!0},concepto:{value:"Concepto",show:!0},detalle:{value:"Detalle",show:!0},estado:{value:"Estado",show:!0},monto:{value:"Monto",show:!0}}},u.aplicacion.aplicacion.id),u.fieldViewer.updateObject()},u.abrirModalConceptosMovimiento=function(){u.clase={edit:!1},u.abrirPopup(u.idModalConceptosMovimiento)},u.cerrarModalConceptosMovimiento=function(){u.cerrarPopup(u.idModalConceptosMovimiento)},u.abrirModalKardexCajaChica=function(a){u.solicitud=a,u.abrirPopup(u.idModalKardexCajaChica)},u.cerrarModalKardexCajaChica=function(){u.cerrarPopup(u.idModalKardexCajaChica)},u.abrirModalIngresosCajaChica=function(){u.obtenerListaIngresos(),u.abrirPopup(u.idModalIngresosCajaChica)},u.cerrarModalIngresosCajaChica=function(){u.cerrarPopup(u.idModalIngresosCajaChica)},u.abrirModalHistorialCierreCajaChica=function(){u.obtenerListaCierresCajaChica(),u.abrirPopup(u.idModalHistorialCierreCajaChica)},u.cerrarModalHistorialCierreCajaChica=function(){u.cerrarPopup(u.idModalHistorialCierreCajaChica)},u.abrirModalEliminarSolicitud=function(a){u.solicitud=a,u.abrirPopup(u.idModalEliminarSolicitud)},u.cerrarModalEliminarSolicitud=function(){u.cerrarPopup(u.idModalEliminarSolicitud)},u.abrirModalRegistroCajaChica=function(a,o,i,e){if(a){if(u.solicitud=a,o)e?(u.cajaChica=Object.assign({},e),u.cajaChica.compra=Object.assign({},e.compra),u.cajaChica.solicitud=Object.assign({},a),u.cajaChica.solicitud.cajasChicas[0].saldo+=u.cajaChica.compra.total,u.cajaChica.verDatosCompra=!0,u.cajaChica.descuentoGasolina=!1,10<u.cajaChica.fecha.length&&(u.cajaChica.fecha=u.fechaATexto(u.cajaChica.fecha)),u.cajaChica.compra.fechaTexto=u.fechaATexto(e.compra.fecha)):(u.cajaChica=Object.assign({},a.cajasChicas[0]),u.cajaChica.compra=Object.assign({},a.cajasChicas[0].compra),u.cajaChica.solicitud=Object.assign({},a),u.cajaChica.solicitud.cajasChicas[0].saldo+=u.cajaChica.compra.total,u.cajaChica.verDatosCompra=!0,u.cajaChica.descuentoGasolina=!1,10<u.cajaChica.fecha.length&&(u.cajaChica.fecha=u.fechaATexto(u.cajaChica.fecha)),u.cajaChica.compra.fechaTexto=u.fechaATexto(a.cajasChicas[0].compra.fecha)),null==u.cajaChica.compra.movimiento&&(u.cajaChica.compra.movimiento={clase:{}},u.cajaChica.compra.movimiento.clase=u.cajaChica.compra.tipoMovimiento),u.cajaChica.compra.movimiento.clase.nombre==u.diccionario.MOVING_POR_RETENCION_BIENES||u.cajaChica.compra.movimiento.clase.nombre==u.diccionario.MOVING_POR_RETENCION_SERVICIOS?(u.configuracionCompraVista.mostrar_it_retencion=!0,u.configuracionCompraVista.mostrar_iue=!0,u.configuracionCompraVista.mostrar_pagado=!0):(u.configuracionCompraVista.mostrar_it_retencion=!1,u.configuracionCompraVista.mostrar_iue=!1,u.configuracionCompraVista.mostrar_pagado=!1);else{if(0<a.cajasChicas.length)var c=0;else c=0;u.cajaChica={fecha:u.fechaATexto(new Date),concepto:a.concepto,detalle:a.detalle,compra:{sucursal:u.sucursalPrincipal,fecha:u.fechaATexto(new Date),generado_por_pedido:!1,usar_producto:!0,movimiento:{clase:{}},tipo_retencion:!0,total:c,id_empresa:u.usuario.id_empresa,id_usuario:u.usuario.id,proveedor:{},id_tipo_pago:u.tiposPago[0].id,tipoPago:u.tiposPago[0],detallesCompra:[],descuento_general:!1,tipo_descuento:!1,codigo_control:0,autorizacion:0,tipo_recargo:!1,descuento:0,recargo:0,ice:0,excento:0},solicitud:a,verDatosCompra:!1,descuentoGasolina:!1}}i?(u.cajaChica.ver=!0,u.cajaChica.verDatosCompra=!0):u.cajaChica.ver=!1}else e?(u.cajaChica=Object.assign({},e),u.cajaChica.compra=Object.assign({},e.compra),u.cajaChica.solicitud=null,u.cajaChica.verDatosCompra=!0,u.cajaChica.descuentoGasolina=!1,10<u.cajaChica.fecha.length&&(u.cajaChica.fecha=u.fechaATexto(u.cajaChica.fecha)),u.cajaChica.compra.fechaTexto=u.fechaATexto(e.compra.fecha)):u.cajaChica={fecha:u.fechaATexto(new Date),compra:{fecha:u.fechaATexto(new Date),generado_por_pedido:!1,usar_producto:!0,movimiento:{clase:{}},tipo_retencion:!0,total:"",id_empresa:u.usuario.id_empresa,id_usuario:u.usuario.id,proveedor:{},id_tipo_pago:u.tiposPago[0].id,tipoPago:u.tiposPago[0],detallesCompra:[],descuento_general:!1,tipo_descuento:!1,codigo_control:0,autorizacion:0,tipo_recargo:!1,descuento:0,recargo:0,ice:0,excento:0},solicitud:null,verDatosCompra:!1,descuentoGasolina:!1},i?(u.cajaChica.ver=!0,u.cajaChica.verDatosCompra=!0):u.cajaChica.ver=!1;u.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},u.cargarCentroCosto(u.detalleCompra),u.abrirPopup(u.idModalRegistroCajaChica)},u.cargarCentroCosto=function(e){u.centrosCosto.forEach(function(a,o,i){a.nombre==u.cajaChica.concepto.nombre?e.centroCosto=a:e.centroCosto.nombre=u.cajaChica.concepto.nombre})},u.abrirModalRegistroIngresoCajaChica=function(a,o){a?(u.cajaChica=a,u.cajaChica.fecha=u.fechaATexto(new Date(a.fecha)),u.cajaChica.total=a.monto,u.cajaChica.sucursal=u.sucursalPrincipal):u.cajaChica={fecha:u.fechaATexto(new Date),solicitud:null,verDatosCompra:!1,descuentoGasolina:!1,sucursal:u.sucursalPrincipal},o&&(u.cajaChica.ver=!0),u.abrirPopup(u.idModalRegistroIngresoCajaChica)},u.abrirModalRegistroAnticipoCajaChica=function(a,o){a?(u.cajaChica={},u.cajaChica.solicitud=a,u.cajaChica.concepto=a.concepto,u.cajaChica.detalle=a.detalle,u.cajaChica.fecha=u.fechaATexto(new Date(a.fecha)),u.cajaChica.total=a.monto,u.cajaChica.sucursal=u.sucursalPrincipal):u.cajaChica={fecha:u.fechaATexto(new Date),solicitud:null,verDatosCompra:!1,descuentoGasolina:!1,sucursal:u.sucursalPrincipal},o&&(u.cajaChica.ver=!0),u.cajaChica.Desembolso=!0,u.cajaChica.Anticipo=!0,u.abrirPopup(u.idModalRegistroAnticipoCajaChica)},u.cerrarModalRegistroAnticipoCajaChica=function(){u.cerrarPopup(u.idModalRegistroAnticipoCajaChica)},u.cerrarModalRegistroIngresoCajaChica=function(){u.cerrarPopup(u.idModalRegistroIngresoCajaChica)},u.abrirModalRegistroDesembolsoCajaChica=function(a,o,i){i?(u.cajaChica=Object.assign({},a.cajasChicas[0]),u.cajaChica.solicitud=Object.assign({},a),u.cajaChica.fecha=u.fechaATexto(new Date(u.cajaChica.fecha)),u.cajaChica.total=a.cajasChicas[0].monto,u.cajaChica.Desembolso=!0,u.cajaChica.sucursal=u.sucursalPrincipal):(u.cajaChica={solicitud:a,sucursal:u.sucursalPrincipal},u.cajaChica.fecha=u.fechaATexto(new Date(a.fecha)),u.cajaChica.total=a.monto,u.cajaChica.detalle=a.detalle,u.cajaChica.concepto=a.concepto,u.cajaChica.Desembolso=!0),o&&(u.cajaChica.ver=!0),u.abrirPopup(u.idModalRegistroDesembolsoCajaChica)},u.cerrarModalRegistroDesembolsoCajaChica=function(){u.cerrarPopup(u.idModalRegistroDesembolsoCajaChica)},u.obtenerTiposDePago=function(){d.start(),t("TIPA").then(function(a){u.tiposPago=a.clases,d.stop()})},u.cerrarModalRegistroCajaChica=function(){u.cerrarPopup(u.idModalRegistroCajaChica)},u.abrirModalVerificarAutorizacion=function(a){u.solicitud=a,u.tipoDatosPermiso="autorizacion",u.abrirPopup(u.idModalVerificarAutorizacion)},u.cerrarModalVerificarAutorizacion=function(){u.cerrarPopup(u.idModalVerificarAutorizacion)},u.obtenerTiposMovimiento=function(){t("CM_CCH").then(function(a){u.tiposMovimientos=a})},u.obtenerTiposEstados=function(){t("ES_CCH").then(function(a){u.tiposEstados=a.clases})},u.obtenerConceptosMovimiento=function(){s(u.usuario.id_empresa).then(function(a){u.ConceptosMovimiento=a,u.cerrarModalConceptosMovimiento()})},u.AgregarConceptosMovimientoCajaChica=function(a){a.habilitado=!0,a.edit?u.clase={edit:!1}:u.ConceptosMovimiento.push(a)},u.editarConceptoMovimientoCajaChica=function(a){a.edit=!0,u.clase=a},u.cancelarEdicionConcepotMovimientoCajaChica=function(a){u.clase={edit:!1}},u.guardarConceptoMovimientoCajaChica=function(){n(u.usuario.id_empresa,u.ConceptosMovimiento).then(function(a){u.obtenerConceptosMovimiento(),u.mostrarMensaje(a.mensaje)})},u.obtenerListaSolicitudes=function(a){u.paginator=h(),u.paginator.column="id",u.paginator.direccion="asc",u.paginator.itemsPerPage=10,a?(u.filtro=a,u.filtro.id_sucursal=u.sucursalPrincipal.id):u.filtro={empresa:u.usuario.id_empresa,inicio:"",fin:"",solicitante:"",usuario:"",estado:"",concepto:"",movimiento:"",id_usuario_no_autorizado:u.usuario.encargado_caja_chica?"":u.usuario.encargado_rendicion_caja_chica?"":u.usuario.id,id_sucursal:u.sucursalPrincipal.id,rendiciones:u.usuario.encargado_rendicion_caja_chica?1:""},u.paginator.callBack=u.listaSolicitudesCajaChica,u.paginator.getSearch("",u.filtro,null)},u.listaSolicitudesCajaChica=function(){d.start(),p(u.paginator).then(function(a){d.stop(),u.totalRlCaja=a.totalRlCaja,u.totalCaja=a.total,u.paginator.setPages(a.paginas),u.solicitudesCajaChica=a.solicitudes})},u.obtenerListaIngresos=function(){u.paginator=h(),u.paginator.column="id",u.paginator.direccion="asc",u.paginator.itemsPerPage=10,u.filtro2={empresa:u.usuario.id_empresa,inicio:"",fin:"",id_sucursal:u.sucursalPrincipal.id},u.paginator.callBack=u.listaIngresosCajaChica,u.paginator.getSearch("",u.filtro2,null)},u.listaIngresosCajaChica=function(){d.start(),E(u.paginator).then(function(a){d.stop(),u.paginator.setPages(a.paginas),u.IngresosCajaChica=a.ingresos})},u.obtenerListaCierresCajaChica=function(){u.paginator=h(),u.paginator.column="id",u.paginator.direccion="asc",u.paginator.itemsPerPage=10,u.filtro2={empresa:u.usuario.id_empresa,inicio:"",fin:"",id_sucursal:u.sucursalPrincipal.id},u.paginator.callBack=u.listaCierresCajaChica,u.paginator.getSearch("",u.filtro2,null)},u.listaCierresCajaChica=function(){d.start(),O(u.paginator).then(function(e){d.stop(),u.paginator.setPages(e.paginas),e.cierreCaja.forEach(function(o,a,i){o.saldo_final=o.saldo_inicial,o.detalleCierreCaja.forEach(function(a){"INGRESO"==a.concepto.concepto.nombre?o.saldo_final+=a.monto:o.saldo_final-=a.monto}),a==i.length-1&&(u.cierresCajaChica=e.cierreCaja)})})},u.eliminarSolicitud=function(){u.tiposEstados.forEach(function(a,o,i){(a.nombre===u.diccionario.CC_ESTADO_ANULADO&&(u.solicitud.estado=a),o===i.length-1)&&(u.solicitud.eliminado=!0,u.solicitud.autorizador=u.usuario.id,r(u.solicitud).then(function(a){u.obtenerListaSolicitudes(),u.cerrarModalEliminarSolicitud(),u.mostrarMensaje(a.mensaje)}))})},u.verificarPerimisoAutorizacion=function(a){a.nombre_usuario=u.usuario.nombre_usuario,S(u.usuario.id_empresa,a).then(function(a){a.type?(u.mostrarMensaje(a.message),"autorizacion"==u.tipoDatosPermiso&&u.tiposEstados.forEach(function(a,o,i){(a.nombre===u.diccionario.CC_ESTADO_AUTORIZADO&&(u.solicitud.estado=a),o===i.length-1)&&(u.solicitud.autorizador=u.usuario.id,r(u.solicitud).then(function(a){u.obtenerListaSolicitudes(),u.cerrarModalVerificarAutorizacion(),u.mostrarMensaje(a.mensaje)}))})):(u.cerrarModalVerificarAutorizacion(),u.mostrarMensaje(a.message))})},u.verDatosCompra=function(){u.cajaChica.compra.fechaTexto=u.fechaATexto(new Date),u.cajaChica.verDatosCompra=!u.cajaChica.verDatosCompra},u.obtenerMovimientosIngreso=function(a){d.start(),t("MOVING").then(function(a){u.movimientosIngreso=a.clases;var e=[];u.movimientosIngreso.forEach(function(a,o,i){a.nombre!==u.diccionario.MOVING_INVENTARIO_INICIAL&&a.nombre!==u.diccionario.MOVING_POR_TRASPASO&&a.nombre!==u.diccionario.MOVING_POR_DEVOLUCION&&a.nombre!==u.diccionario.MOVING_POR_AJUSTE||e.push(o)}),e.reverse().forEach(function(a){u.movimientosIngreso.splice(a,1)}),d.stop()})},u.buscarCuentasCajaChica=function(a){return f(u.mostrarMensaje,null,null,u.usuario,null,null,null,null,null,null,a)},u.buscarProveedor=function(a){if(""!=a&&null!=a)return b(u.usuario.id_empresa,a)},u.establecerProveedor=function(a){u.cajaChica.compra.proveedor=a},u.interceptarTecla=function(a,o,i){13===a.which&&(i?u.enfocar(o):$timeout(function(){$("#"+o).trigger("click")},0))},u.obtenerSucursales=function(){for(var a=[],o=0;o<u.usuario.sucursalesUsuario.length;o++)a.push(u.usuario.sucursalesUsuario[o].sucursal);return a},u.obtenerAlmacenes=function(o){u.almacenes=[];var a=$.grep(u.sucursales,function(a){return a.id==o})[0];u.almacenes=a.almacenes,null==u.cajaChica.compra.id&&(u.cajaChica.compra.almacen=1==u.almacenes.length?u.almacenes[0]:null)},u.verificarMomivmiento=function(a){a.movimiento.clase.nombre==u.diccionario.MOVING_POR_RETENCION_SERVICIOS?a.usar_producto=!1:a.movimiento.clase.nombre==u.diccionario.MOVING_POR_RETENCION_BIENES?a.usar_producto=!0:a.movimiento.clase.nombre==u.diccionario.MOVING_POR_IMPORTACION&&(a.factura=0,a.autorizacion=3,a.codigo_control=0,a.descuento_general=!1,a.usar_producto=!0)},u.generarDescuentoGasolina=function(){u.cajaChica.descuentoGasolina=!u.cajaChica.descuentoGasolina,u.cajaChica.descuentoGasolina?(u.cajaChica.compra.descuento_general=!0,u.cajaChica.compra.descuento=0,u.cajaChica.compra.recargo=0,u.cajaChica.compra.ice=0,u.cajaChica.compra.excento=30*u.cajaChica.solicitud.monto/100):(u.cajaChica.compra.descuento_general=!1,u.cajaChica.compra.descuento=0,u.cajaChica.compra.recargo=0,u.cajaChica.compra.ice=0,u.cajaChica.compra.excento=0)},u.guardarCajaChica=function(){if(d.start(),u.cajaChica.solicitud)if(u.cajaChica.Desembolso){u.cajaChica.fecha=new Date(u.convertirFecha(u.cajaChica.fecha));var a=new Date;u.cajaChica.fecha.setHours(a.getHours()),u.cajaChica.fecha.setMinutes(a.getMinutes()),u.cajaChica.fecha.setSeconds(a.getSeconds()),u.tiposEstados.forEach(function(a,o,i){(u.cajaChica.Anticipo?a.nombre===u.diccionario.CC_ESTADO_PROCESADO&&(u.cajaChica.solicitud.estado=a):a.nombre===u.diccionario.CC_ESTADO_DESEMBOLSADO&&(u.cajaChica.solicitud.estado=a),o===i.length-1)&&M(u.cajaChica,u.usuario.id_empresa).then(function(a){d.stop(),u.generarPdfBoletaCajaChica(u.cajaChica.solicitud,a.cajaChica),u.obtenerListaSolicitudes(),u.mostrarMensaje(a.mensaje),u.cajaChica.Anticipo?u.cerrarModalRegistroAnticipoCajaChica():u.cerrarModalRegistroDesembolsoCajaChica()})})}else{u.cajaChica.fecha=new Date(u.convertirFecha(u.cajaChica.fecha)),u.cajaChica.compra.fecha=new Date(u.convertirFecha(u.cajaChica.compra.fechaTexto));a=new Date;if(u.cajaChica.compra.fecha.setHours(a.getHours()),u.cajaChica.compra.fecha.setMinutes(a.getMinutes()),u.cajaChica.compra.fecha.setSeconds(a.getSeconds()),u.cajaChica.fecha.setHours(a.getHours()),u.cajaChica.fecha.setMinutes(a.getMinutes()),u.cajaChica.fecha.setSeconds(a.getSeconds()),null!=u.cajaChica.solicitud)if("KARDEX"==u.cajaChica.solicitud.concepto.concepto.nombre){if(0<u.cajaChica.solicitud.cajasChicas.length)var o=u.cajaChica.solicitud.cajasChicas[0].saldo;else o=-1;if(u.cajaChica.compra.total==o)u.tiposEstados.forEach(function(a,o,i){(a.nombre===u.diccionario.CC_ESTADO_PROCESADO&&(u.cajaChica.solicitud.estado=a),o===i.length-1)&&M(u.cajaChica,u.usuario.id_empresa).then(function(a){d.stop(),u.obtenerListaSolicitudes(),u.generarPdfBoletaCajaChica(u.cajaChica.solicitud,a.cajaChica,!0),u.mostrarMensaje(a.mensaje),u.cerrarModalRegistroCajaChica()})});else M(u.cajaChica,u.usuario.id_empresa).then(function(a){d.stop(),u.obtenerListaSolicitudes(),u.mostrarMensaje(a.mensaje),u.generarPdfBoletaCajaChica(u.cajaChica.solicitud,a.cajaChica,!0),u.cerrarModalRegistroCajaChica()})}else u.tiposEstados.forEach(function(a,o,i){(a.nombre===u.diccionario.CC_ESTADO_PROCESADO&&(u.cajaChica.solicitud.estado=a),o===i.length-1)&&M(u.cajaChica,u.usuario.id_empresa).then(function(a){d.stop(),u.generarPdfBoletaCajaChica(u.cajaChica.solicitud,a.cajaChica),u.obtenerListaSolicitudes(),u.mostrarMensaje(a.mensaje),u.cerrarModalRegistroCajaChica()})});else M(u.cajaChica,u.usuario.id_empresa).then(function(a){d.stop(),u.obtenerListaSolicitudes(),u.generarPdfBoletaCajaChica(u.cajaChica.solicitud,a.cajaChica),u.mostrarMensaje(a.mensaje),u.cerrarModalRegistroCajaChica()})}else{u.cajaChica.fecha=new Date(u.convertirFecha(u.cajaChica.fecha));a=new Date;u.cajaChica.fecha.setHours(a.getHours()),u.cajaChica.fecha.setMinutes(a.getMinutes()),u.cajaChica.fecha.setSeconds(a.getSeconds()),M(u.cajaChica,u.usuario.id_empresa).then(function(a){d.stop(),u.generarPdfBoletaCajaChica(u.cajaChica.solicitud,a.cajaChica),u.obtenerListaIngresos(),u.obtenerListaSolicitudes(),u.mostrarMensaje(a.mensaje),u.cerrarModalRegistroIngresoCajaChica()})}},u.filterPorTipo=function(e,c){"TODOS"==(u.tipoFiltro=e)?(c.movimiento=0,u.paginator.getSearch(u.paginator.search,c,null)):u.tiposMovimientos.clases.forEach(function(a,o,i){a.nombre==e&&(c.movimiento=a.id),o===i.length-1&&u.paginator.getSearch(u.paginator.search,c,null)})},u.obtenerDatosCierreCaja=function(){d.start();var a=new Date;I(u.usuario.id_empresa,a,u.totalRlCaja,u.sucursalPrincipal.id).then(function(a){d.stop();var o=a.cierreCaja;u.generarPdfCajaChica(o)})},u.generarPdfCajaChica=function(a){d.start();var o=new PDFDocument({size:"letter",margin:10}),i=o.pipe(blobStream()),e=120,c=0,t=1,r=Math.ceil(a.detalleCierreCaja.length/19);u.dibujarCabeceraPDFCajaChica(o,1,r,a),o.font("Helvetica",8);for(var n=a.saldo_inicial,s=0;s<a.detalleCierreCaja.length&&c<=19;s++){var l=a.detalleCierreCaja[s];o.rect(30,e-10,555,30).stroke(),o.text(l.id,45,e),o.text(u.fechaATexto(new Date(l.fecha)),85,e),l.solicitud&&o.text(l.solicitud.solicitante.persona.nombre_completo,150,e,{width:120}),o.text(l.concepto.nombre,270,e,{width:150}),l.compra&&o.text(l.compra.factura,430,e),"INGRESO"==l.concepto.concepto.nombre?(o.text(number_format(l.monto,2)+".-",490,e),n+=l.monto):(o.text("("+number_format(l.monto,2)+".-)",490,e),n-=l.monto),o.text(n.toFixed(2)+".-",540,e),e+=30,19==++c&&(o.addPage({margin:0,bufferPages:!0}),e=120,c=0,t+=1,u.dibujarCabeceraPDFCajaChica(o,t,r,a),o.font("Helvetica",8))}o.rect(350,e+25,200,0).dash(1,{space:5}).stroke(),o.text("Encargado Caja Chica",350,e+30,{width:200,align:"center"}),o.text(u.usuario.persona.nombre_completo,350,e+40,{width:200,align:"center"}),o.end(),i.on("finish",function(){var a=i.toBlobURL("application/pdf");window.open(a,"_blank","location=no")}),d.stop()},u.dibujarCabeceraPDFCajaChica=function(a,o,i,e){a.font("Helvetica-Bold",12),a.text("CIERRE CAJA CHICA",0,25,{align:"center"}),a.font("Helvetica",8),a.text("DEL "+u.fechaATexto(e.inicio)+" AL "+u.fechaATexto(e.fin),0,35,{align:"center"}),a.font("Helvetica-Bold",8),a.text("PÁGINA "+o+" DE "+i,0,740,{align:"center"}),a.font("Helvetica-Bold",8),a.text("Saldo Inicial : bs. "+number_format(e.saldo_inicial,2)+".-",45,60),a.font("Helvetica",8),a.rect(30,80,555,30).stroke(),a.font("Helvetica-Bold",8),a.text("N°",45,90),a.text("Fecha",85,90,{width:50}),a.text("Nombre",150,90,{width:60}),a.text("Gasto",270,90,{width:50}),a.text("N° factura",430,90,{width:50}),a.text("Monto",490,90,{width:50}),a.text("Saldo",540,90,{width:50}),a.font("Helvetica",8)},u.generarPdfBoletaCajaChica=function(t,r,n){convertUrlToBase64Image(u.usuario.empresa.imagen,function(a){var o=a,i=new PDFDocument({size:"letter",margin:10}),e=i.pipe(blobStream()),c=45;u.dibujarPDFBoletaCajaChica(i,t,r,c,o,n),c+=370,i.rect(0,c-35,650,0).dash(2,{space:5}).stroke(),u.dibujarPDFBoletaCajaChica(i,t,r,c,o,n),i.end(),e.on("finish",function(){var a=e.toBlobURL("application/pdf");window.open(a,"_blank","location=no")})})},u.dibujarPDFBoletaCajaChica=function(a,o,i,e,c,t){if(a.font("Helvetica-Bold",12),a.image(c,30,e-20,{fit:[80,80]}),"INGRESO"!=i.concepto.concepto.nombre?t?a.text("RENDICIÓN FONDOS CAJA CHICA",0,e+20,{align:"center"}):a.text("SALIDA CAJA CHICA",0,e+20,{align:"center"}):a.text("INGRESO CAJA CHICA",0,e+20,{align:"center"}),a.font("Helvetica-Bold",8),a.text(i.sucursal.nombre,0,e+30,{align:"center"}),a.text("Nro. "+i.numero_correlativo,0,e+40,{align:"center"}),a.rect(465,e,90,20).dash(0,{space:0}).stroke(),a.rect(435,e,30,20).dash(0,{space:0}).stroke(),a.rect(465,e+20,90,20).dash(0,{space:0}).stroke(),a.rect(435,e+20,30,20).dash(0,{space:0}).stroke(),a.text("Bs.",445,e+10),i.id_padre?a.text(i.pagado.toFixed(2),485,e+10):a.text(i.monto.toFixed(2),485,e+10),a.text("$us.",445,e+30),a.font("Helvetica",8),a.text("Fecha en texto",45,e+65),o)var r=o.solicitante.persona.nombre_completo;else r=u.usuario.empresa.razon_social;a.text("Recibí de .: "+r,45,e+80),i.id_padre?a.text("La suma de .: "+ConvertirALiteral(i.pagado.toFixed(2)),45,e+95):a.text("La suma de .: "+ConvertirALiteral(i.monto.toFixed(2)),45,e+95),"INGRESO"!=i.concepto.concepto.nombre&&(a.text("Bajo el concepto de: "+i.concepto.nombre,45,e+110),e+=15),a.text("Por concepto de:",45,e+110),a.font("Helvetica-Bold",8),a.text("DETALLE",200,e+125),a.text(i.detalle,55,e+155,{width:410}),a.text("IMPORTE",485,e+125),a.font("Helvetica",8),i.id_padre?a.text(i.pagado.toFixed(2),485,e+155):a.text(i.monto.toFixed(2),485,e+155),a.font("Helvetica",8),a.rect(45,e+120,420,20).dash(0,{space:0}).stroke().stroke(),a.rect(45,e+140,420,60).dash(0,{space:0}).stroke().stroke(),a.rect(465,e+120,90,20).dash(0,{space:0}).stroke().stroke(),a.rect(465,e+140,90,60).dash(0,{space:0}).stroke().stroke(),a.font("Helvetica",6),a.rect(70,e+275,100,0).dash(2,{space:5}).stroke(),"INGRESO"==i.concepto.concepto.nombre?(a.text("Autorizado",45,e+295,{width:150,align:"center"}),a.rect(250,e+275,100,0).dash(2,{space:5}).stroke(),a.text("Entregue Conforme",225,e+295,{width:150,align:"center"}),a.rect(450,e+275,100,0).dash(2,{space:5}).stroke(),a.text(u.usuario.persona.nombre_completo,425,e+285,{width:150,align:"center"}),a.text("Recibí Conforme",425,e+295,{width:150,align:"center"})):(a.text(o.usuario.persona.nombre_completo,45,e+285,{width:150,align:"center"}),a.text("Autorizado",45,e+295,{width:150,align:"center"}),a.rect(250,e+275,100,0).dash(2,{space:5}).stroke(),a.text(o.solicitante.persona.nombre_completo,225,e+285,{width:150,align:"center"}),a.text("Recibí Conforme",225,e+295,{width:150,align:"center"}),a.rect(450,e+275,100,0).dash(2,{space:5}).stroke(),a.text(u.usuario.persona.nombre_completo,425,e+285,{width:150,align:"center"}),a.text("Entregue Conforme",425,e+295,{width:150,align:"center"}));var n=new Date;a.text("Usuario.: "+u.usuario.nombre_usuario+" Hora.: "+n.getHours()+":"+n.getMinutes()+" imp.: "+u.fechaATexto(n),425,e+310,{width:150,align:"center"})},u.dibujarCuerpoPDFBoletaCajaChica=function(a,o,i,e){},u.verificarProducto=function(a){null!=u.cajaChica.compra.movimiento.clase&&u.cajaChica.compra.movimiento.clase.nombre==u.diccionario.MOVING_POR_RETENCION_BIENES&&(a.descuento=0,a.ice=0,a.recargo=0,a.excento=0,u.configuracionCompraVista.mostrar_it_retencion=!0,u.configuracionCompraVista.mostrar_iue=!0,u.configuracionCompraVista.mostrar_pagado=!0),u.agregarDetalleCompra(a)},u.verificarServicio=function(a){a.servicio.id?(null!=u.cajaChica.compra.movimiento.clase&&u.cajaChica.compra.movimiento.clase.nombre==u.diccionario.MOVING_POR_RETENCION_SERVICIOS&&(a.descuento=0,a.ice=0,a.recargo=0,a.excento=0,u.configuracionCompraVista.mostrar_it_retencion=!0,u.configuracionCompraVista.mostrar_iue=!0,u.configuracionCompraVista.mostrar_pagado=!0),u.agregarDetalleCompraServicio(a),u.verificarCamposDetalleCompra(a,!0)):u.mostrarMensaje("El producto no se encuentra en el catalogo")},u.agregarDetalleCompra=function(a){if(a.producto.nombre.id&&(a.producto=a.producto.nombre),a.centroCosto.nombre.id)a.centroCosto=a.centroCosto.nombre;else if(a.centroCosto.nombre==u.diccionario.CENTRO_COSTO_ALMACEN){var o=$.grep(u.centrosCosto,function(a){return a.nombre==u.diccionario.CENTRO_COSTO_ALMACEN})[0];a.centroCosto=o}a.fechaVencimientoTexto&&(a.fecha_vencimiento=new Date(u.convertirFecha(a.fechaVencimientoTexto))),u.cajaChica.compra.descuento_general&&(a.descuento=u.cajaChica.compra.descuento,a.ice=u.cajaChica.compra.ice,a.recargo=u.cajaChica.compra.recargo,a.excento=u.cajaChica.compra.excento),u.cajaChica.compra.detallesCompra.push(a),u.sumarTotal(),u.sumarTotalImporte(),u.cajaChica.compra.descuento_general&&u.calcularImporteGeneral(),u.cajaChica.compra.tipoPago.nombre==u.diccionario.TIPO_PAGO_CREDITO&&u.calcularSaldo(),u.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},u.cargarCentroCosto(u.detalleCompra)},u.agregarDetalleCompraServicio=function(a){u.cajaChica.compra.detallesCompra.push(a),u.sumarTotal(),u.sumarTotalImporte(),u.cajaChica.compra.descuento_general&&u.calcularImporteGeneral(),u.cajaChica.compra.tipoPago.nombre==u.diccionario.TIPO_PAGO_CREDITO&&u.calcularSaldo(),u.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},u.cargarCentroCosto(u.detalleCompra)},u.obtenerConfiguracionCompraVista=function(){d.start(),v(u.usuario.id_empresa).then(function(a){u.configuracionCompraVista=a,d.stop()})},u.guardarConfiguracionCompraVista=function(){g.update({id_empresa:u.usuario.id_empresa},u.configuracionCompraVista,function(a){})},u.eliminarDetalleCompra=function(a){u.cajaChica.compra.id?a.eliminado=!0:u.cajaChica.compra.detallesCompra.splice(u.cajaChica.compra.detallesCompra.indexOf(a),1),u.sumarTotal(),u.sumarTotalImporte(),u.cajaChica.compra.descuento_general&&u.calcularImporteGeneral(),u.cajaChica.compra.tipoPago.nombre==u.diccionario.TIPO_PAGO_CREDITO&&u.calcularSaldo()},u.sumarTotalImporte=function(){for(var a=0,o=0;o<u.cajaChica.compra.detallesCompra.length;o++)u.cajaChica.compra.detallesCompra[o].eliminado||(a+=u.cajaChica.compra.detallesCompra[o].importe);u.cajaChica.compra.importe=Math.round(1e3*a)/1e3},u.sumarTotal=function(){for(var a=0,o=0;o<u.cajaChica.compra.detallesCompra.length;o++)u.cajaChica.compra.detallesCompra[o].eliminado||(a+=u.cajaChica.compra.detallesCompra[o].total);u.cajaChica.compra.total=Math.round(1e3*a)/1e3},u.calcularSaldo=function(){u.cajaChica.compra.saldo=u.cajaChica.compra.total-u.cajaChica.compra.a_cuenta},u.calcularImporteGeneral=function(){var a,o;a=u.cajaChica.compra.tipo_descuento?u.cajaChica.compra.importe*(u.cajaChica.compra.descuento/100):u.cajaChica.compra.descuento,o=u.cajaChica.compra.tipo_recargo?u.cajaChica.compra.importe*(u.cajaChica.compra.recargo/100):u.cajaChica.compra.recargo,u.cajaChica.compra.total=Math.round(1e3*(u.cajaChica.compra.importe-a+o-u.cajaChica.compra.ice-u.cajaChica.compra.excento))/1e3},u.eliminarDetalleCompra=function(a){u.cajaChica.compra.id?a.eliminado=!0:u.cajaChica.compra.detallesCompra.splice(u.cajaChica.compra.detallesCompra.indexOf(a),1),u.sumarTotal(),u.sumarTotalImporte(),u.cajaChica.compra.descuento_general&&u.calcularImporteGeneral(),u.cajaChica.compra.tipoPago.nombre==u.diccionario.TIPO_PAGO_CREDITO&&u.calcularSaldo()},u.cambiarTipoPago=function(o){o=$.grep(u.tiposPago,function(a){return a.id==o.id})[0];u.esContado="CONT"==o.nombre_corto,u.cajaChica.compra.id_tipo_pago=o.id,u.esContado||u.calcularSaldo()},u.buscarProducto=function(a){if(""!=a&&null!=a&&u.busquedaProductoHabilidato)return P(u.usuario.id_empresa,a,u.usuario.id,u.compra.almacen.id)},u.establecerProducto=function(a){a.tipoProducto=null==a.tipoProducto?{id:a["tipoProducto.id"],nombre:a["tipoProducto.nombre"],nombre_corto:a["tipoProducto.nombre_corto"]}:a.tipoProducto;var o=u.detalleCompra.centroCosto;u.precio_inventario,0<a.inventarios.length?u.precio_inventario=a.inventarios.pop().costo_unitario+" Bs":u.precio_inventario="Sin histórico",u.detalleCompra={centroCosto:o,producto:a,precio_unitario:a.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:0<a.descuento,tipo_recargo:!1},u.cerrarPopup(u.idModalInventario),u.enfocar("cantidad")},u.calcularImporte=function(){var a,o;u.detalleCompra.importe=Math.round(u.detalleCompra.cantidad*u.detalleCompra.costo_unitario*1e3)/1e3,u.cajaChica.compra.movimiento.clase.nombre==u.diccionario.MOVING_POR_RETENCION_BIENES?u.cajaChica.compra.tipo_retencion?(u.detalleCompra.total=u.detalleCompra.importe,u.detalleCompra.importe=u.detalleCompra.total*(u.plantilla.retencionBienesGasto.it.porsentaje+u.plantilla.retencionBienesGasto.iue.porsentaje)/(100-(u.plantilla.retencionBienesGasto.it.porsentaje+u.plantilla.retencionBienesGasto.iue.porsentaje))+u.detalleCompra.total,u.detalleCompra.it=u.detalleCompra.importe*u.plantilla.retencionBienesGasto.it.porsentaje/100,u.detalleCompra.iue=u.detalleCompra.importe*u.plantilla.retencionBienesGasto.iue.porsentaje/100):(u.detalleCompra.it=u.detalleCompra.importe*u.plantilla.retencionBienesGasto.it.porsentaje/100,u.detalleCompra.iue=u.detalleCompra.importe*u.plantilla.retencionBienesGasto.iue.porsentaje/100,u.detalleCompra.total=u.detalleCompra.importe*u.plantilla.retencionBienesGasto.gasto.porsentaje/100):u.cajaChica.compra.movimiento.clase.nombre==u.diccionario.MOVING_POR_IMPORTACION?u.detalleCompra.total=u.detalleCompra.importe:u.cajaChica.compra.movimiento.clase.nombre==u.diccionario.MOVING_POR_RETENCION_SERVICIOS?u.cajaChica.compra.tipo_retencion?(u.detalleCompra.total=u.detalleCompra.importe,u.detalleCompra.importe=u.detalleCompra.total*(u.plantilla.retencionServicios.it.porsentaje+u.plantilla.retencionServicios.iue.porsentaje)/(100-(u.plantilla.retencionServicios.it.porsentaje+u.plantilla.retencionServicios.iue.porsentaje))+u.detalleCompra.total,u.detalleCompra.it=u.detalleCompra.importe*u.plantilla.retencionServicios.it.porsentaje/100,u.detalleCompra.iue=u.detalleCompra.importe*u.plantilla.retencionServicios.iue.porsentaje/100):(u.detalleCompra.it=u.detalleCompra.importe*u.plantilla.retencionServicios.it.porsentaje/100,u.detalleCompra.iue=u.detalleCompra.importe*u.plantilla.retencionServicios.iue.porsentaje/100,u.detalleCompra.total=u.detalleCompra.importe*u.plantilla.retencionServicios.servicio.porsentaje/100):u.cajaChica.compra.descuento_general?(a=u.cajaChica.compra.tipo_descuento?u.detalleCompra.importe*(u.cajaChica.compra.descuento/100):u.cajaChica.compra.descuento,o=u.cajaChica.compra.tipo_recargo?u.detalleCompra.importe*(u.cajaChica.compra.recargo/100):u.cajaChica.compra.recargo,u.detalleCompra.total=u.detalleCompra.importe-a+o-u.cajaChica.compra.ice-u.cajaChica.compra.excento):(a=u.detalleCompra.tipo_descuento?u.detalleCompra.importe*(u.detalleCompra.descuento/100):u.detalleCompra.descuento,o=u.detalleCompra.tipo_recargo?u.detalleCompra.importe*(u.detalleCompra.recargo/100):u.detalleCompra.recargo,u.detalleCompra.total=u.detalleCompra.importe-a+o-u.detalleCompra.ice-u.detalleCompra.excento),importe=u.cajaChica.compra.importe?u.cajaChica.compra.importe:0,u.totalRestante=u.cajaChica.solicitud.monto-importe,u.cajaChica.solicitud&&(u.detalleCompra.importe>u.totalRestante?(u.detalleCompra.importe=NaN,u.ErrorImporte=!0):u.ErrorImporte=!1)},u.calcularImporteDetalleEdicion=function(a){var o,i;a.importe=Math.round(a.cantidad*a.costo_unitario*1e3)/1e3,o=a.tipo_descuento?a.importe*(a.descuento/100):a.descuento,i=a.tipo_recargo?a.importe*(a.recargo/100):a.recargo,a.total=a.importe-o+i-a.ice-a.excento,u.sumarTotal(),u.sumarTotalImporte(),u.cajaChica.compra.descuento_general&&u.calcularImporteGeneral(),u.cajaChica.compra.tipoPago.nombre==u.diccionario.TIPO_PAGO_CREDITO&&u.calcularSaldo()},u.sumarMonto=function(a){for(var o=0,i=0;i<a.length;i++)o+=a[i].total;return Math.round(100*o)/100},u.obtenerCentrosDeCosto=function(){d.start(),t("CCO").then(function(a){if(u.centrosCosto=a.clases,u.usuario.empresa.usar_funciones_erp){var e=[];u.centrosCosto.forEach(function(a,o,i){"ALM"==a.nombre_corto||"VR"==a.nombre_corto||e.push(o)}),e.reverse().forEach(function(a,o,i){u.centrosCosto.splice(a,1)})}d.stop()})},u.obtenerconfiuracionCuentas=function(){var a=_(u.usuario.id_empresa);u.plantilla={retencionServicios:{it:{},iue:{},servicio:{}},retencionBienesGasto:{it:{},iue:{},gasto:{}},retencionBienes:{it:{},iue:{},almacen:{}},egreso:{ivacf:{},cajaBanco:{}},ingreso:{ivadf:{},it:{},itPorPagar:{},cajaBanco:{}}},a.then(function(a){a.lista.forEach(function(a){u.diccionario.IVA_DF==a.nombre&&(u.plantilla.ingreso.ivadf={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IT==a.nombre&&(u.plantilla.ingreso.it={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IT_POR_PAGAR==a.nombre&&(u.plantilla.ingreso.itPorPagar={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.CAJA_BANCOS==a.nombre&&(u.plantilla.ingreso.cajaBanco={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IVA_CF==a.nombre&&(u.plantilla.egreso.ivacf={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.CAJA_BANCOS==a.nombre&&(u.plantilla.egreso.cajaBanco={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IT_RETENCION_BIEN==a.nombre&&(u.plantilla.retencionBienes.it={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IUE_RETENCION_BIEN==a.nombre&&(u.plantilla.retencionBienes.iue={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.CUENTA_ALMACEN_RETENCION_BIEN==a.nombre&&(u.plantilla.retencionBienes.almacen={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IT_RETENCION_BIEN_GASTO==a.nombre&&(u.plantilla.retencionBienesGasto.it={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IUE_RETENCION_BIEN_GASTO==a.nombre&&(u.plantilla.retencionBienesGasto.iue={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.CUENTA_GASTO_RETENCION_BIEN==a.nombre&&(u.plantilla.retencionBienesGasto.gasto={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IT_RETENCION_SERVICIO==a.nombre&&(u.plantilla.retencionServicios.it={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.IUE_RETENCION_SERVICIO==a.nombre&&(u.plantilla.retencionServicios.iue={porsentaje:parseFloat(a.valor),cuenta:a.cuenta}),u.diccionario.CUENTA_RETENCION_SERVICIO==a.nombre&&(u.plantilla.retencionServicios.servicio={porsentaje:parseFloat(a.valor),cuenta:a.cuenta})},this)})},u.obtenerServicios=function(){d.start(),c("SERVICIOS_COMPRA",u.usuario.id_empresa).then(function(a){u.datosServicios=a,d.stop()})},u.abrirDialogServicios=function(a){u.tipo_edicion=a,u.clase={},u.abrirPopup(u.idModalServicios)},u.cerrarDialogServicios=function(){u.cerrarPopup(u.idModalServicios)},u.agregarConceptoEdicion=function(a){a.nombre&&a.nombre_corto&&(-1==u.tipo_edicion.clases.indexOf(a)&&u.tipo_edicion.clases.push(a),u.clase={})},u.modificarConceptoEdicion=function(a){u.clase=a},u.removerConceptoEdicion=function(a){a.eliminado=!0},u.guardarConceptoEdicion=function(o){d.start(),Tipos.update({id_tipo:o.id},o,function(a){t(o.nombre_corto).then(function(a){o=a,d.stop(),u.cerrarDialogServicios(),u.mostrarMensaje("Guardado Exitosamente!")})})},u.establecerServicioSeleccionado=function(a){u.establecerServicio(a),u.cerrarDialogServicios()},u.establecerServicio=function(a){a.tipoProducto=null==a.tipoProducto?{id:a["tipoProducto.id"],nombre:a["tipoProducto.nombre"],nombre_corto:a["tipoProducto.nombre_corto"]}:a.tipoProducto;u.detalleCompra.centroCosto;u.detalleCompra={centroCosto:null,servicio:a,precio_unitario:a.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},u.cerrarPopup(u.idModalInventario),u.enfocar("cantidad")},u.verificarCamposDetalleCompra=function(a,o){o?(u.verificacionDatos=!1,u.verificacionDatos=!a.servicio.nombre):(u.verificacionDatos=!1,u.verificacionDatos=!a.producto.nombre),0==u.verificacionDatos&&(u.verificacionDatos=!(1<=a.cantidad),0==u.verificacionDatos&&(u.verificacionDatos=!(1e-4<=a.costo_unitario)))},u.$on("$routeChangeStart",function(a,o){u.eliminarPopup(u.idModalSolicitudCajaChica),u.eliminarPopup(u.idModalConceptosMovimiento),u.eliminarPopup(u.idModalEliminarSolicitud),u.eliminarPopup(u.idModalVerificarAutorizacion),u.eliminarPopup(u.idModalRegistroCajaChica),u.eliminarPopup(u.idModalKardexCajaChica),u.eliminarPopup(u.idModalIngresosCajaChica),u.eliminarPopup(u.idModalHistorialCierreCajaChica),u.eliminarPopup(u.idModalRegistroIngresoCajaChica),u.eliminarPopup(u.idModalRegistroDesembolsoCajaChica),u.eliminarPopup(u.idModalServicios),u.eliminarPopup(u.idModalRegistroAnticipoCajaChica)}),u.inicio()}]).controller("ControladorSolicitudCajaChica",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipoEmpresa","ClasesTipo","GuardarSolicitudCajaChica","GuardarConceptoMovimientoCajaChica","ObtenerConceptoMovimientoCajaChica","VerificarUsuarioEmpresaCaja","SolicitudesCajaPaginador","ObtenerTodoPersonal","$filter","Paginator","VerificarUsuarioEmpresa",function(e,a,o,i,c,t,r,n,s,l,u,d,p,C,m,h,j){e.usuario=JSON.parse(a.usuario),e.idModalSolicitudCajaChica="dialog-solicitud",e.idModalConceptosMovimiento="dialog-conceptos-movimiento",e.idModalEliminarSolicitud="dialog-eliminar-solicitud",e.idModalVerificarAutorizacion="modal-verificar-autorizacion",e.inicio=function(){e.obtenerTiposMovimiento(),e.obtenerConceptosMovimiento(),e.obtenerTiposEstados(),e.obtenerListaSolicitudes(),e.ConceptosMovimiento=[]},e.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptsSolicitudCajaChicas(e.idModalSolicitudCajaChica,e.idModalConceptosMovimiento,e.idModalEliminarSolicitud,e.idModalVerificarAutorizacion),e.buscarAplicacion(e.usuario.aplicacionesUsuario,o.path().substring(1)),t.stop()}),e.abrirModalSolicitudCajaChica=function(a){null==a&&(e.solicitud={fecha:new Date}),e.filtrarPersonal(),e.abrirPopup(e.idModalSolicitudCajaChica)},e.cerrarModalSolicitudCajaChica=function(){e.cerrarPopup(e.idModalSolicitudCajaChica)},e.abrirModalConceptosMovimiento=function(){e.clase={edit:!1},e.abrirPopup(e.idModalConceptosMovimiento)},e.cerrarModalConceptosMovimiento=function(){e.cerrarPopup(e.idModalConceptosMovimiento)},e.abrirModalEliminarSolicitud=function(a){e.solicitud=a,e.abrirPopup(e.idModalEliminarSolicitud)},e.cerrarModalEliminarSolicitud=function(){e.cerrarPopup(e.idModalEliminarSolicitud)},e.abrirModalVerificarAutorizacion=function(a){e.solicitud=a,e.tipoDatosPermiso="autorizacion",e.abrirPopup(e.idModalVerificarAutorizacion)},e.cerrarModalVerificarAutorizacion=function(){e.cerrarPopup(e.idModalVerificarAutorizacion)},e.obtenerTiposMovimiento=function(){n("CM_CCH").then(function(a){e.tiposMovimientos=a})},e.obtenerTiposEstados=function(){n("ES_CCH").then(function(a){e.tiposEstados=a.clases})},e.obtenerConceptosMovimiento=function(){u(e.usuario.id_empresa).then(function(a){e.ConceptosMovimiento=a,e.cerrarModalConceptosMovimiento()})},e.AgregarConceptosMovimientoCajaChica=function(a){a.habilitado=!0,a.edit?e.clase={edit:!1}:e.ConceptosMovimiento.push(a)},e.editarConceptoMovimientoCajaChica=function(a){a.edit=!0,e.clase=a},e.cancelarEdicionConcepotMovimientoCajaChica=function(a){e.clase={edit:!1}},e.guardarConceptoMovimientoCajaChica=function(){l(e.usuario.id_empresa,e.ConceptosMovimiento).then(function(a){e.obtenerConceptosMovimiento(),e.mostrarMensaje(a.mensaje)})},e.guardarSolicitudCajaChica=function(){e.solicitud.usuario=e.usuario,e.tiposEstados.forEach(function(a,o,i){(e.usuario.autorizacion_caja_chica?(e.solicitud.autorizador=e.usuario.id,a.nombre===e.diccionario.CC_ESTADO_AUTORIZADO&&(e.solicitud.estado=a)):a.nombre===e.diccionario.CC_ESTADO_PENDIENTE&&(e.solicitud.estado=a),o===i.length-1)&&s(e.solicitud).then(function(a){e.obtenerListaSolicitudes(),e.cerrarModalSolicitudCajaChica(),e.mostrarMensaje(a.mensaje)})})},e.buscarPersonal=function(a){if(""!=a&&null!=a)return m("filter")(e.todoPersonal,a)},e.filtrarPersonal=function(a){void 0!==e.todoPersonal?e.personalProcesado=m("filter")(e.todoPersonal,a):C(e.usuario.empresa.id).then(function(a){e.todoPersonal=a.personal,e.personalProcesado=a.personal,void 0!==a.mensaje&&e.mostrarMensaje(a.mensaje)},function(a){e.mostrarMensaje("Se perdió la conexión.")})},e.establecerPersonal=function(a){a.id,a.persona.nombre_completo},e.obtenerListaSolicitudes=function(){e.paginator=h(),e.paginator.column="id",e.paginator.direccion="asc",e.paginator.itemsPerPage=10,e.filtro={empresa:e.usuario.id_empresa,inicio:"",fin:"",solicitante:"",usuario:"",estado:"",concepto:"",movimiento:"",id_usuario_no_autorizado:e.usuario.autorizacion_caja_chica?"":e.usuario.id},e.paginator.callBack=e.listaSolicitudesCajaChica,e.paginator.getSearch("",e.filtro,null)},e.listaSolicitudesCajaChica=function(){t.start(),p(e.paginator).then(function(a){t.stop(),e.paginator.setPages(a.paginas),e.solicitudesCajaChica=a.solicitudes})},e.verSolicitudCajaChica=function(a){e.solicitud=a,e.solicitud.ver=!0,e.abrirModalSolicitudCajaChica(!0)},e.editarSolicitudCajaChica=function(a){e.usuario.persona.id==a.usuario.persona.id&&(e.solicitud=a,e.abrirModalSolicitudCajaChica(!0))},e.eliminarSolicitud=function(){e.tiposEstados.forEach(function(a,o,i){(a.nombre===e.diccionario.CC_ESTADO_ANULADO&&(e.solicitud.estado=a),o===i.length-1)&&(e.solicitud.eliminado=!0,s(e.solicitud).then(function(a){e.obtenerListaSolicitudes(),e.cerrarModalEliminarSolicitud(),e.mostrarMensaje(a.mensaje)}))})},e.verificarPerimisoAutorizacion=function(a){a.nombre_usuario=e.usuario.nombre_usuario,d(e.usuario.id_empresa,a).then(function(a){a.type?(e.mostrarMensaje(a.message),"autorizacion"==e.tipoDatosPermiso&&e.tiposEstados.forEach(function(a,o,i){(a.nombre===e.diccionario.CC_ESTADO_AUTORIZADO&&(e.solicitud.estado=a),o===i.length-1)&&(e.solicitud.autorizador=e.usuario.id,s(e.solicitud).then(function(a){e.cerrarModalVerificarAutorizacion(),e.mostrarMensaje(a.mensaje)}))})):(e.cerrarModalVerificarAutorizacion(),e.mostrarMensaje(a.message))})},e.$on("$routeChangeStart",function(a,o){e.eliminarPopup(e.idModalSolicitudCajaChica),e.eliminarPopup(e.idModalConceptosMovimiento),e.eliminarPopup(e.idModalEliminarSolicitud),e.eliminarPopup(e.idModalVerificarAutorizacion)}),e.inicio()}]);