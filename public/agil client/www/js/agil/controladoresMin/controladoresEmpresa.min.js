angular.module("agil.controladores").controller("ControladorEmpresas",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","Clases","Empresa","Empresas","ListaAplicacionesSistema",function(p,a,e,i,r,c,o,n,m,s,t){c.start(),p.idModalWizardEmpresaEdicion="modal-wizard-empresa",p.idModalWizardEmpresaVista="modal-wizard-empresa-vista",p.idModalEliminarEmpresa="dialog-eliminar-empresa",p.idModalContenedorEmpresaEdicion="modal-wizard-container-empresa-edicion",p.idModalContenedorEmpresaVista="modal-wizard-container-empresa-vista",p.idImagenEmpresa="imagen-empresa",p.usuario=JSON.parse(a.usuario),p.inicio=function(){p.obtenerEmpresas(p.usuario.id_empresa),p.obtenerAplicaciones(),setTimeout(function(){ejecutarScriptsTabla("tabla-empresas",11)},2e3)},p.$on("$viewContentLoaded",function(){resaltarPesta√±a(e.path().substring(1)),ejecutarScriptsEmpresa(p.idModalWizardEmpresaEdicion,p.idImagenEmpresa,p.idModalContenedorEmpresaEdicion,p.idModalWizardEmpresaVista,p.idModalContenedorEmpresaVista,p.idModalEliminarEmpresa),p.buscarAplicacion(p.usuario.aplicacionesUsuario,e.path().substring(1)),c.stop(),o("DEP").then(function(a){p.departamentos=a.clases})}),p.crearNuevaEmpresa=function(){p.esNuevo=!0,p.empresa=new m({sucursal:{},imagen:"img/icon-user-default.png",aplicaciones:[]}),p.abrirPopup(p.idModalWizardEmpresaEdicion)},p.cerrarPopPupNuevaEmpresa=function(){p.cerrarPopup(p.idModalWizardEmpresaEdicion)},p.verEmpresa=function(a){p.empresa=a,p.abrirPopup(p.idModalWizardEmpresaVista)},p.cerrarPopPupVista=function(){p.cerrarPopup(p.idModalWizardEmpresaVista)},p.cerrarPopPupEdicion=function(){p.cerrarPopup(p.idModalWizardEmpresaEdicion)},p.modificarEmpresa=function(a){a.aplicaciones=[],p.esNuevo=!1,(p.empresa=a).departamento&&p.buscarMunicipios(a.id_departamento+"-"+a.departamento.nombre_corto),p.seleccionarAplicaciones(a.aplicacionesEmpresa),p.abrirPopup(p.idModalWizardEmpresaEdicion)},p.mostrarConfirmacionEliminacion=function(a){p.empresa=new m(a),p.abrirPopup(p.idModalEliminarEmpresa)},p.cerrarConfirmacionEliminacion=function(){p.cerrarPopup(p.idModalEliminarEmpresa)},p.eliminarEmpresa=function(a){c.start(),p.cerrarConfirmacionEliminacion(),a.$delete(),p.mostrarMensaje("Eliminado exitosamente!"),p.recargarItemsTabla(),c.stop()},p.buscarMunicipios=function(a){var e=a.split("-")[1];n(e+"M").then(function(a){p.municipios=a})},p.saveForm=function(a){var e=$("#siguiente").text().trim();if(console.log(e),"Siguiente"!=e){c.start();var t=a.imagen;"string"==typeof a.id_departamento&&(a.id_departamento=a.id_departamento.split("-")[0]),p.esNuevo&&"string"==typeof a.sucursal.id_departamento&&(a.sucursal.id_departamento=a.sucursal.id_departamento.split("-")[0]),a.id?m.update({idEmpresa:a.id},a,function(a){if(null==a.signedRequest)c.stop(),p.cerrarPopPupNuevaEmpresa(),p.mostrarMensaje("Actualizado Exitosamente!"),p.recargarItemsTabla();else{var e=new XMLHttpRequest;e.open("PUT",a.signedRequest),e.onreadystatechange=function(){4===e.readyState&&(200===e.status?(c.stop(),p.cerrarPopPupNuevaEmpresa(),p.mostrarMensaje("Actualizado Exitosamente!"),p.recargarItemsTabla()):alert("Could not upload file."))};for(var i=atob(t.split(",")[1]),r=[],o=0;o<i.length;o++)r.push(i.charCodeAt(o));var n=new Blob([new Uint8Array(r)],{type:"image/jpeg"}),s=new File([n],a.image_name,{type:"image/jpeg"});console.log(s),e.send(s)}}):a.$save(function(a){if(null==a.signedRequest)c.stop(),p.empresa=new m({sucursal:{},imagen:"img/icon-user-default.png"}),p.cerrarPopPupNuevaEmpresa(),p.mostrarMensaje("Guardado Exitosamente!"),p.recargarItemsTabla();else{var e=new XMLHttpRequest;e.open("PUT",a.signedRequest),e.onreadystatechange=function(){4===e.readyState&&(200===e.status?(c.stop(),p.empresa=new m({sucursal:{},imagen:"img/icon-user-default.png"}),p.cerrarPopPupNuevaEmpresa(),p.mostrarMensaje("Guardado Exitosamente!"),p.recargarItemsTabla()):alert("Could not upload file."))};for(var i=atob(t.split(",")[1]),r=[],o=0;o<i.length;o++)r.push(i.charCodeAt(o));var n=new Blob([new Uint8Array(r)],{type:"image/jpeg"}),s=new File([n],a.image_name,{type:"image/jpeg"});e.send(s)}},function(a){c.stop(),p.cerrarPopPupNuevaEmpresa(),p.mostrarMensaje("Ocurrio un problema al momento de guardar!"),p.recargarItemsTabla()})}},p.obtenerEmpresas=function(a){c.start(),null==a&&(a=0),s(a).then(function(a){p.empresas=a,c.stop()})},p.obtenerAplicaciones=function(){var a="";if(p.usuario.empresa)a=p.usuario.empresa.aplicacionesEmpresa.map(function(a){return a.id_aplicacion}).join(",");t(a).then(function(a){p.llenarAplicaciones(a)})},p.llenarAplicaciones=function(a){p.aplicacionesSistema=[];for(var e=0;e<a.length;e++){var i={name:a[e].titulo,maker:"",ticked:!1,id:a[e].id};p.aplicacionesSistema.push(i)}},p.seleccionarAplicaciones=function(a){for(var e=0;e<p.aplicacionesSistema.length;e++)for(var i=0;i<a.length;i++)p.aplicacionesSistema[e].id==a[i].id_aplicacion&&(p.aplicacionesSistema[e].ticked=!0)},p.$on("$routeChangeStart",function(a,e){p.eliminarPopup(p.idModalWizardEmpresaEdicion),p.eliminarPopup(p.idModalWizardEmpresaVista),p.eliminarPopup(p.idModalEliminarEmpresa)}),p.inicio()}]);