angular.module("agil.controladores").controller("ControladorInventarios",["$scope","$timeout","$filter","$window","$localStorage","$location","$templateCache","$route","blockUI","ListaInventariosProducto","Inventario","InventarioPaginador","Productos","ActualizacionInventario","ListaProductosEmpresa","IngresosPorInventario","ActualizarDetalleMovimiento","ListaGruposProductoUsuario","ProductosUsuario","IngPorInventario","InventarioInicial",function(l,a,i,e,o,n,t,r,d,s,c,u,v,p,m,g,f,I,h,P,b){function _(e,a){return"asc"==l.direccion?e.cantidad_total-a.cantidad_total:a.cantidad_total-e.cantidad_total}d.start(),l.usuario=JSON.parse(o.usuario),l.idModalActualizacionInventario="dialog-actualizacion-inventario",l.idModalIngresosPorInventario="dialog-ingreso-por-inventario",l.idModalCreacionInventario="dialog-creacion-inventario-inicial",l.inicio=function(){l.seleccionGrupo={},l.obtenerSucursales(),l.obtenerInventarios(),l.compraIngresosPorInventario(),l.obtenerGruposProductosEmpresaUsuario()},l.establecerCantidad=function(e){l.cantidadInventario=e},l.obtenerSucursales=function(){for(var e=[],a=0;a<l.usuario.sucursalesUsuario.length;a++)e.push(l.usuario.sucursalesUsuario[a].sucursal);l.sucursales=e},l.obtenerAlmacenes=function(a){l.almacenes=[];var e=$.grep(l.sucursales,function(e){return e.id==a})[0];l.almacenes=e.almacenes},l.establecerAlmacen=function(e){l.id_almacen=e},l.establecerAlmacenBusqueda=function(e){console.log(e.id),l.almacenBusqueda=e},l.obtenerInventarios=function(){l.abs=e.Math.abs,l.itemsPorPagina=10,l.paginaActual=1,l.columna="nombre",l.direccion="asc",l.textoBusqueda="",l.cantidadInventario="0",1==l.sucursales.length&&(l.sucursalBusqueda=l.sucursales[0],l.almacenes=l.sucursalBusqueda.almacenes,1==l.almacenes.length&&(l.almacenBusqueda=l.sucursalBusqueda.almacenes[0],l.buscarInventarios(l.almacenBusqueda.id,l.paginaActual,l.itemsPorPagina,l.textoBusqueda,l.columna,l.direccion,0)))},l.obtenerGruposProductosEmpresaUsuario=function(){d.start(),I(l.usuario.id_empresa,l.usuario.id).then(function(e){d.stop(),0<e.length?l.gruposProducto=e:(l.gruposProducto=[],l.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){d.stop(),l.gruposProducto=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";l.mostrarMensaje(a)})},l.verificarPulso=function(e,a){13===e.keyCode&&(l.textoBusqueda=a,l.almacenBusqueda&&l.buscarInventarios(l.almacenBusqueda.id,1,l.itemsPorPagina,l.textoBusqueda,l.columna,l.direccion,l.cantidadInventario))},l.verDetalleInventario=function(a){s(a.id,l.almacenBusqueda.id).then(function(e){a.inventarios=e}),"none"==$("#"+a.id).css("display")?$("#"+a.id).css("display",""):$("#"+a.id).css("display","none")},l.clasificarColumna=function(e){"cantidad"==e?("asc"==l.direccion?l.direccion="desc":l.direccion="asc",l.productos.sort(_)):(l.columna==e?"asc"==l.direccion?(l.direccion="desc",$("#"+e).removeClass("fa-caret-up"),$("#"+e).addClass("fa-caret-down")):(l.direccion="asc",$("#"+e).removeClass("fa-caret-down"),$("#"+e).addClass("fa-caret-up")):(l.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+e).addClass("fa-caret-up"),$("#"+e).removeClass("fa-sort")),l.columna=e,l.buscarInventarios(l.almacenBusqueda.id,l.paginaActual,l.itemsPorPagina,l.textoBusqueda,l.columna,l.direccion,l.cantidadInventario,l.seleccionGrupo.id))},l.buscarInventarios=function(e,a,o,n,t,i,r,s){d.start(),l.itemsPorPagina=o,""==n||null==n?n=0:l.textoBusqueda=n,l.paginaActual=a,u(l.usuario.id_empresa,e,a,o,n,t,i,r,s,l.usuario.id).then(function(e){for(var a=e.productos,o=[],n=0;n<a.length;n++){l.colorearInventarioDisponible(a[n].cantidad,a[n]),o.push({id:a[n].id,nombre:a[n].nombre,descripcion:a[n].descripcion,codigo:a[n].codigo,grupo:a[n].grupo,subgrupo:a[n].subgrupo,inventarios:[],cantidad_total:a[n].cantidad,fecha_vencimiento:new Date(a[n].fecha_vencimiento),precio_unitario:a[n].precio_unitario,porcentaje:l.porcentaje,color:l.color,unidad_medida:a[n].unidad_medida})}l.paginas=[];for(n=1;n<=e.paginas;n++)l.paginas.push(n);l.productos=o,d.stop()}).catch(function(e){d.stop(),l.Productos=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";l.mostrarMensaje(a)})},l.colorearInventarioDisponible=function(e,a){0==e?(l.porcentaje="100",l.color="red"):e>3*a.inventario_minimo+1?(l.porcentaje="100",l.color="green"):e>2*a.inventario_minimo+1?(l.porcentaje="75",l.color="green"):e>1.5*a.inventario_minimo+1?(l.porcentaje="50",l.color="green"):e==a.inventario_minimo+1?(l.porcentaje="38",l.color="yellow"):e==a.inventario_minimo?(l.porcentaje="25",l.color="red"):e<a.inventario_minimo&&0<e&&(l.porcentaje="12",l.color="red")},l.abrirPopupActualizacionInventario=function(e){l.inventario=e,l.abrirPopup(l.idModalActualizacionInventario)},l.modificarCantidadInventario=function(e){p.update({id:e.id},e,function(e){l.cerrarPopupActualizacionInventario(),l.mostrarMensaje(e.message),l.obtenerInventarios()},function(e){l.cerrarPopupActualizacionInventario(),l.mostrarMensaje(e)})},l.editing=!1,l.editDesalleMovimiento=function(e){(console.log(l.editing),console.log(l.editing),l.display)?l.editing?l.editing=!1:l.editing=!0:(l.editing?l.editing=!1:l.editing=!0,"none"==$("#"+e.id).css("display")?$("#"+e.id).css("display",""):(l.display=!1,$("#"+e.id).css("display","none")))},l.verDetalleMovimiento=function(e){console.log(e),l.editing=!1,"none"==$("#"+e.id).css("display")?($("#"+e.id).css("display",""),l.display=!0):(l.display=!1,l.editing=!1,$("#"+e.id).css("display","none"))},l.generarPdfIngresosPorInventario=function(e){d.start();var a=new PDFDocument({size:"letter",margin:10}),o=a.pipe(blobStream()),n=205,t=0,i=1,r=Math.ceil(e.detallesMovimiento.length/17);l.dibujarCabeceraPDFIngresosPorInventario(a,e,1,r),a.font("Helvetica",8);for(var s=0;s<e.detallesMovimiento.length&&t<=17;s++){if(a.rect(50,n,540,30).stroke(),l.usuario.empresa.usar_vencimientos){a.text(e.detallesMovimiento[s].producto.codigo,60,n+10,{width:50}),a.text(e.detallesMovimiento[s].cantidad,120,n+10),a.text(e.detallesMovimiento[s].producto.unidad_medida,150,n+10,{width:50}),a.text(e.detallesMovimiento[s].producto.nombre,190,n+10,{width:180}),a.text(e.detallesMovimiento[s].inventario.lote,380,n+10);var c=new Date(e.detallesMovimiento[s].inventario.fecha_vencimiento);a.text(c.getDate()+"/"+(c.getMonth()+1)+"/"+c.getFullYear(),420,n+10)}else a.text(e.detallesMovimiento[s].producto.codigo,70,n+10),a.text(e.detallesMovimiento[s].cantidad,145,n+10),a.text(e.detallesMovimiento[s].producto.unidad_medida,200,n+10,{width:50}),a.text(e.detallesMovimiento[s].producto.nombre,270,n+10,{width:200});a.text(e.detallesMovimiento[s].producto.precio_unitario,470,n+10),a.text(e.detallesMovimiento[s].total,530,n+10),n+=30,17==++t&&(a.addPage({margin:0,bufferPages:!0}),n=205,t=0,i+=1,l.dibujarCabeceraPDFIngresosPorInventario(a,e,i,r),a.font("Helvetica",8))}a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),d.stop()},l.dibujarCabeceraPDFIngresosPorInventario=function(e,a,o,n){100<l.usuario.empresa.imagen.length&&e.image(l.usuario.empresa.imagen,60,50,{width:50,height:50}),e.font("Helvetica-Bold",8),e.text(l.usuario.empresa.razon_social.toUpperCase(),60,105),e.font("Helvetica",7),e.text(a.almacen.sucursal.nombre.toUpperCase(),60,113),e.text(a.almacen.sucursal.direccion.toUpperCase(),60,121);var t=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");e.text("TELF.: "+t,60,129),e.text("COCHABAMBA - BOLIVIA",60,137),e.font("Helvetica-Bold",16),e.text("NOTA DE INGRESO",150,50),e.font("Helvetica-Bold",8),e.rect(380,50,190,50).stroke(),e.text("NIT : ",390,60),e.text(l.usuario.empresa.nit,500,60),e.rect(50,150,540,30).stroke(),e.text("FECHA : ",60,165),e.font("Helvetica-Bold",14),e.text("Inventario Inicial",360,165),e.font("Helvetica-Bold",8),e.rect(50,180,540,25).stroke(),e.rect(50,205,540,510).stroke(),l.usuario.empresa.usar_vencimientos?(e.text("CODIGO",60,195),e.text("CANT.",115,195),e.text("UNID.",150,195),e.text("DETALLE",185,195),e.text("Lote",380,195),e.text("Venc.",420,195)):(e.text("CODIGO",70,195),e.text("CANT.",140,195),e.text("UNID.",200,195),e.text("DETALLE",270,195)),e.text("P. UNIT.",470,195),e.text("TOTAL",530,195);var i=new Date,r=i.getMinutes();r<10&&(r="0"+r),e.font("Helvetica",7),e.text("USUARIO: "+l.usuario.nombre_usuario,55,740),e.text("EMISIÓN : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+r,490,740),e.font("Helvetica-Bold",8),e.text("PÁGINA "+o+" DE "+n,0,740,{align:"center"})},l.compraIngresosPorInventario=function(){P(l.usuario.id_empresa).then(function(e){e.hasErr?(l.mostrarMensaje(e.mensaje),l.ingPorInventario=[]):l.ingPorInventario=e})},l.excelIngPorInventario=function(){for(var e=[["Compra","Fecha","Sucursal","Código","Cantidad","Unidad","Detalle","Lote","Vencimiento","Costo Unitario","Total"]],a=0;a<l.ingPorInventario.length;a++)for(var o=0;o<l.ingPorInventario[a].detallesMovimiento.length;o++){var n=[];n.push(l.ingPorInventario[a].id),n.push(l.ingPorInventario[a].fecha.split("T")[0].split("-").reverse().join("/")),n.push(l.ingPorInventario[a].almacen.sucursal.nombre),n.push(l.ingPorInventario[a].detallesMovimiento[o].producto.codigo),n.push(l.ingPorInventario[a].detallesMovimiento[o].cantidad),n.push(l.ingPorInventario[a].detallesMovimiento[o].producto.unidad_medida),n.push(l.ingPorInventario[a].detallesMovimiento[o].producto.nombre),n.push(l.ingPorInventario[a].detallesMovimiento[o].inventario.lote),n.push(l.ingPorInventario[a].detallesMovimiento[o].inventario.fecha_vencimientoTexto?l.ingPorInventario[a].detallesMovimiento[o].inventario.fecha_vencimientoTexto:""),n.push(l.ingPorInventario[a].detallesMovimiento[o].costo_unitario),n.push(l.ingPorInventario[a].detallesMovimiento[o].total),e.push(n)}var t="SheetJS",i=new Workbook,r=sheet_from_array_of_arrays(e);i.SheetNames.push(t),i.Sheets[t]=r;var s=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"INGRESOS POR INVENTARIO.xlsx")},l.cerrarPopupActualizacionInventario=function(){l.cerrarPopup(l.idModalActualizacionInventario)},l.abrirPopupIngresosPorInventario=function(e){l.inventario=e,l.abrirPopup(l.idModalIngresosPorInventario)},l.cerrarPopupIngresosPorInventario=function(){l.cerrarPopup(l.idModalIngresosPorInventario)},l.crearNuevoInventario=function(){l.abrirPopup(l.idModalCreacionInventario)},l.buscarProducto=function(e){if(""!=e&&null!=e)return m(l.usuario.id_empresa,e)},l.cerrarPopupInvInicial=function(){l.cerrarPopup(l.idModalCreacionInventario)},l.sumarCantidadAlmacen=function(e,a,o){e=i("filter")(e,a),e=i("filter")(e,o);for(var n=0,t=0;t<e.length;t++)n+=e[t].cantidad;return n},l.sumarCostoTotalAlmacen=function(e,a,o){e=i("filter")(e,a),e=i("filter")(e,o);for(var n=0,t=0;t<e.length;t++)n+=e[t].costo_total;return n},l.sumarCantidadSucursal=function(e,a){e=i("filter")(e,a);for(var o=0,n=0;n<e.length;n++)o+=e[n].cantidad;return o},l.sumarCostoTotalSucursal=function(e,a){e=i("filter")(e,a);for(var o=0,n=0;n<e.length;n++)o+=e[n].costo_total;return o},l.bajarExcelInventarios=function(){h(l.usuario.id_empresa,l.usuario.id).then(function(e){for(var a=[["Codigo","Nombre o Descripción","Unidad de medida","Costo Unitario","Cantidad a ingresar","Fecha de vencimiento (dia/mes/año)","Lote"]],o=0;o<e.length;o++){var n=[];n.push(e[o].codigo),n.push(e[o].nombre),n.push(e[o].unidad_medida),a.push(n)}var t="INVENTARIO",i=new Workbook,r=sheet_from_array_of_arrays(a);i.SheetNames.push(t),i.Sheets[t]=r;var s=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"EJEMPLO-DATOS-INVENTARIOS.xlsx"),d.stop()})},l.guardarInventarioInicial=function(e,a){e.fechaVencimientoTexto&&(e.fecha_vencimiento=new Date(l.convertirFecha(e.fechaVencimientoTexto)));var o=[];o.push(e);new c({productos:o,id_empresa:l.usuario.id_empresa,id_almacen:l.id_almacen});var n={productos:o,id_empresa:l.usuario.id_empresa,id_almacen:l.id_almacen};b(n).then(function(e){e.hasErr?l.mostrarMensaje(e.message):(l.mostrarMensaje(e.message),l.cerrarPopupInvInicial(),l.recargarItemsTabla())}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";l.mostrarMensaje(a),d.stop()})},l.subirExcelInventarios=function(e,u){var a,o,n=e.target.files;for(o=n[a=0];a!=n.length;++a){var t=new FileReader;o.name;t.onload=function(e){d.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),n=o.SheetNames[0],t=2,i=o.Sheets[n],r=[];do{var s={};s.codigo=null!=i["A"+t]&&""!=i["A"+t]?i["A"+t].v.toString():null,s.nombre=null!=i["B"+t]&&""!=i["B"+t]?i["B"+t].v.toString():null,s.unidad_medida=null!=i["C"+t]&&""!=i["C"+t]?i["C"+t].v.toString():null,s.costo_unitario=null!=i["D"+t]&&""!=i["D"+t]?parseFloat(i["D"+t].v.toString()):null,s.cantidad=null!=i["E"+t]&&""!=i["E"+t]?parseFloat(i["E"+t].v.toString()):null;var c=null;null!=i["F"+t]&&""!=i["F"+t]&&("number"==typeof i["F"+t].v?i["F"+t].v%1==0&&(c=new Date(86400*(i["F"+t].v-25568)*1e3)):c=new Date(l.convertirFecha(i["F"+t].v))),s.fecha_vencimiento=c,s.lote=null!=i["G"+t]&&""!=i["G"+t]?i["G"+t].v.toString():null,r.push(s),t++,0}while(null!=i["A"+t]);l.guardarInventario(r,u),d.stop()},t.readAsBinaryString(o)}},l.guardarInventario=function(e,a){new c({productos:e,id_empresa:l.usuario.id_empresa,id_almacen:l.id_almacen}).$save(function(e){d.stop(),l.mostrarMensaje(e.message),l.recargarItemsTabla()},function(e){d.stop(),l.mostrarMensaje("Ocurrio un problema al momento de guardar!"),l.recargarItemsTabla()})},l.animate=!1,l.editMovientoDetalle=function(e){e.inventario.fecha_vencimiento=new Date(l.convertirFecha(e.inventario.fecha_vencimientoTexto)),e.total=e.cantidad*e.costo_unitario-e.descuento+e.recargo-e.ice-e.excento,console.log(e),f.update({id:e.id},e,function(e){a(function(){l.animate=!0,a(function(){l.animate=!1},1e3)},1e3)},function(e){l.mostrarMensaje(e)})},l.editItem=function(e){e.editing=!0},l.doneEditing=function(e){e.editing=!1},l.$on("$viewContentLoaded",function(){resaltarPestaña(n.path().substring(1)),l.buscarAplicacion(l.usuario.aplicacionesUsuario,n.path().substring(1)),ejecutarScriptsInventario(l.idModalActualizacionInventario,l.idModalCreacionInventario,l.idModalIngresosPorInventario),d.stop()}),l.$on("$routeChangeStart",function(e,a){l.eliminarPopup(l.idModalActualizacionInventario),l.eliminarPopup(l.idModalCreacionInventario),l.eliminarPopup(l.idModalIngresosPorInventario)}),l.inicio()}]);