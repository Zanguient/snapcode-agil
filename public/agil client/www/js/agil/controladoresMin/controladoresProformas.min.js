angular.module("agil.controladores").controller("controladorProformas",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","Paginator","$timeout","blockUI","ClasesTipo","socket","ObtenerCambioMoneda","ClientesNit","FiltroProformas","ActividadServicio","ActividadesEmpresa","ServiciosEmpresa","ProformaInfo","Clientes","fechasProforma","ListaSucursalesActividadesDosificacionEmpresa","DosificacionesDisponibles","ListaSucursalesUsuario","ListaHistorialActividad","ImprimirSalida","ConfiguracionesFacturasProformas","ProformasFacturadas","ActualizarProforma","GuardarProformas","ProformaEliminar","GuardarActividadesEmpresa","obtenerAsignacionCentroCosto","GuardarAsignacionCentroCosto",function(m,o,a,e,r,i,t,n,c,s,f,d,l,u,p,v,g,P,h,b,C,D,_,S,E,A,k,x,j,M,F,w,I,B,L){m.usuario=JSON.parse(n.usuario),m.modalConfiguracionActividadesServicios="modalConfiguracionActividadesServicios",m.wizardConfiguracionActividadesServicios="modal-wizard-panel-container",m.modalConfiguracionActividades="modalConfiguracionActividades",m.wizardConfiguracionActividades="modal-wizard-panel-container-actividad",m.dialogProformaEdicion="proforma-edicion",m.dialogClientesProforma="dialog-cliente-proforma",m.dialogmodalFechas="modalFechas",m.dialogBusquedaServicio="dialog-Busqueda-servicio-proforma",m.dialogDosificacionesDisponibles="dialog-dosificaciones-disponibles",m.confirmarDosificacion="dialog-dosificar-actividad",m.asignacionCentroCostoCliente="modalEmpresaCentroCosto",m.dialogClienteEmpresa="dialog-cliente-empresa",m.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),ejecutarScriptsProformas(m.modalConfiguracionActividadesServicios,m.wizardConfiguracionActividadesServicios,m.dialogProformaEdicion,m.dialogClientesProforma,m.modalConfiguracionActividades,m.wizardConfiguracionActividades,m.dialogmodalFechas,m.dialogBusquedaServicio,m.dialogDosificacionesDisponibles,m.confirmarDosificacion,m.asignacionCentroCostoCliente,m.dialogClienteEmpresa),m.buscarAplicacion(m.usuario.aplicacionesUsuario,i.path().substring(1))}),m.$on("$routeChangeStart",function(a,o){m.eliminarPopup(m.modalConfiguracionActividadesServicios),m.eliminarPopup(m.dialogProformaEdicion),m.eliminarPopup(m.modalConfiguracionActividades),m.eliminarPopup(m.dialogClientesProforma),m.eliminarPopup(m.dialogmodalFechas),m.eliminarPopup(m.dialogBusquedaServicio),m.eliminarPopup(m.dialogDosificacionesDisponibles),m.eliminarPopup(m.confirmarDosificacion),m.eliminarPopup(m.asignacionCentroCostoCliente),m.eliminarPopup(m.dialogClienteEmpresa)}),m.abrirdialogClienteEmpresa=function(){m.abrirPopup(m.dialogClienteEmpresa)},m.cerrardialogClienteEmpresa=function(){m.cerrarPopup(m.dialogClienteEmpresa)},m.calcularTotalProformas=function(){m.totalProformas=0;var o=new Date;m.totalProformasDolar=0,u(new Date).then(function(a){for(var o=m.totalProformas=0;o<m.proformas.length;o++)m.proformas[o].eliminado||(m.totalProformas+=m.proformas[o].totalImporteBs,m.totalProformasDolar=m.totalProformas/a.monedaCambio.dolar)},function(a){m.mostrarMensaje("Hubo un problema al recuperar el cambio de dolar para "+o.toLocaleDateString)})},m.obtenerHistorialActividad=function(a){void 0!==a.id&&A(a.actividad.id,a.id_sucursal).then(function(a){m.historialActividad=a.historial})},m.verificarDetallesProformas=function(){if(0<m.detallesProformas.length){var o=0;return m.detallesProformas.forEach(function(a){a.eliminado&&(o+=1)}),o!==m.detallesProformas.length}return!m.proforma.ver&&!!m.proforma.cliente},m.verificarBloqueoServicios=function(){return void 0!==m.proformaFechas?void 0!==m.proformaFechas.ver:m.proforma.editar?m.verificarDetallesProformas():!m.proforma.nueva},m.eliminar=function(o){f.start(),w(o).then(function(a){a.hasErr||(o.eliminado=!0,m.calcularTotalProformas()),m.mostrarMensaje(a.mensaje),f.stop()}).catch(function(a){var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o),f.stop()})},m.editar=function(o,r){if(o.fecha_factura){var a=new Date(o.fecha_factura);if(null!==o.fecha_factura&&void 0!==o.fecha_factura&&"[object Date]"===Object.prototype.toString.call(a)){if(isNaN(a.getTime()))return void m.mostrarMensaje("Hay un problema con la fecha de la factura. Se bloqueará la edición de esta proforma.");if(!r)return void m.mostrarMensaje("Esta proforma no se puede editar, ya fué facturada.")}}f.start();var e=new Date(o.fecha_proforma);u(e).then(function(a){a.monedaCambio?(m.moneda=a.monedaCambio,void 0!==m.detalleProforma&&m.calcularImporte()):(m.moneda={ufv:"--",dolar:"--"},m.mostrarMensaje("La fecha "+m.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema.")),b(o.id,o.actividadEconomica.id).then(function(a){if(m.proforma=a.proforma,m.proforma.editar=!0,m.proforma.sucursal=a.proforma.sucursal,m.obtenerActividadesSucursal(m.proforma.sucursal.id),m.proforma.actividadEconomica=a.proforma.actividadEconomica,m.obtenerServiciosActividadEmpresaPrincipal(m.proforma.actividadEconomica),void 0!==r&&(m.proforma.ver=!0),void 0!==a.mensaje)m.mostrarMensaje(a.mensaje);else{m.proforma.fecha_proforma=m.fechaATexto(new Date(m.proforma.fecha_proforma));var o=new Date(m.convertirFecha(m.proforma.fecha_proforma));m.obtenerCambioMonedaProforma(o);var e=m.moneda.dolar;m.proforma.periodo_mes={id:m.proforma.periodo_mes},m.proforma.periodo_anio={id:m.proforma.periodo_anio},m.obtenercentroCostosClienteEmpresa(m.proforma.cliente),m.detallesProformas=m.proforma.detallesProformas,m.detallesProformas.map(function(a,o){m.detalleProforma=a,m.calcularImporte(),m.detalleProforma=void 0}),m.proforma.totalImporteSus=m.proforma.totalImporteBs/e,m.proforma.importeLiteral=ConvertirALiteral(m.proforma.totalImporteBs.toFixed(2))}f.stop()}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})}),m.detalleProforma=void 0,m.abrirdialogProformaEdicion(m.proforma)},m.ver=function(a){m.proforma=a,m.proforma.ver=!0,m.editar(m.proforma,!0)},m.mostarMensajeConfirmacionEliminacionActividad=function(a){m.abrirPopupConfirmacionEliminacion(m.eliminarDetalleActividadEmpresa,a)},m.imprimirFactura=function(a){if(null!=a.fecha_factura){f.start();var r=[];j(m.usuario.id_empresa,a.factura).then(function(a){r=a.datosProformas;var e={};x(m.usuario.id_empresa).then(function(o){d("MOVEGR").then(function(a){a.clases.forEach(function(a){"FACTURACIÓN"==a.nombre&&"FACT"==a.nombre_corto&&(e=a)}),d("TIPA").then(function(a){m.tiposPago=a.clases,m.facturaProformas={},m.facturaProformas.configuracion=o.configuracion,m.facturaProformas.movimiento=e,m.facturaProformas.cliente=r[0].cliente,m.facturaProformas.autorizacion=r[0].autorizacion,m.facturaProformas.factura=r[0].factura,m.facturaProformas.codigo_control=r[0].codigo_control,m.facturaProformas.fecha=new Date(r[0].fecha_factura),m.facturaProformas.fecha_limite_emision=new Date(r[0].fecha_limite_emision),m.facturaProformas.actividad=r[0].actividadEconomica,m.facturaProformas.sucursal=r[0].sucursal,m.facturaProformas.detallesVenta=[],m.facturaProformas.detalle="",m.facturaProformas.totalImporteBs=r[0].totalImporteBs,m.facturaProformas.importe=r[0].importe,m.facturaProformas.fecha_factura=new Date(r[0].fecha_factura).toLocaleDateString(),m.facturaProformas.fechaTexto=new Date(m.facturaProformas.fecha).toLocaleDateString(),m.facturaProformas.periodo_mes=r[0].mes,m.facturaProformas.periodo_anio=r[0].anio,m.facturaProformas.datosProformas=r,m.facturaProformas.descripcion="",m.facturaProformas.movimiento=e,m.facturaProformas.id_movimiento=m.facturaProformas.movimiento.id,m.facturaProformas.id_tipo_pago=m.tiposPago[0].id,m.facturaProformas.tipoPago=m.tiposPago[1],m.obtenerTipoEgreso(m.facturaProformas.movimiento),m.esContado=!1,m.facturaProformas.usar_servicios=!0,m.facturaProformas.id_usuario=m.usuario.id,m.facturaProformas.fecha=r[0].fecha,m.facturaProformas.id_empresa=m.usuario.id_empresa,m.facturaProformas.datosProformas.forEach(function(e,r){m.facturaProformas.descripcion+=e.detalle+". ",m.facturaProformas.importe=0,m.facturaProformas.total=0;var a=u(e.fecha_proforma),o={ufv:"--",dolar:"--"};a.then(function(a){a.monedaCambio&&(o={ufv:a.monedaCambio.ufv,dolar:a.monedaCambio.dolar}),e.tc=o,e.detallesProformas.map(function(a,o){m.facturaProformas.importe+=a.precio_unitario*a.cantidad,m.facturaProformas.detallesVenta.push(a),m.facturaProformas.total=m.facturaProformas.importe,m.facturaProformas.importeLiteral=ConvertirALiteral(m.facturaProformas.importe.toFixed(2)),m.facturaProformas.numero_literal=m.facturaProformas.importeLiteral,a.tc=e.tc,a.total=a.importe*a.cantidad,o===e.detallesProformas.length-1&&(r==m.facturaProformas.datosProformas.length-1&&(m.checkResourceImg(m.usuario.empresa.imagen,m.usuario.empresa.imageLoaded)?convertUrlToBase64Image(m.usuario.empresa.imagen,function(a){0<a.length&&"error"!==a?(m.usuario.empresa.imagen=a,m.usuario.empresa.imageLoaded=!0,k("FACT",m.facturaProformas,!1,m.usuario)):convertUrlToBase64Image("img/agilsoftware.png",function(a){m.mostrarMensaje("No se encuentra la imagen de la empresa. Se usara la imagen del software."),m.usuario.empresa.imagen=a,m.usuario.empresa.imageLoaded=!0,k("FACT",m.facturaProformas,!1,m.usuario)})}):(m.mostrarMensaje("Existe un problema con la imagen, no se incluira en la impresión."),s(function(){k("FACT",m.facturaProformas,!1,m.usuario)},1500))),m.dolarActual=m.obtenerCambioDolarActual())})}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})}),f.stop()}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})}).catch(function(a){var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o),f.stop()})}else m.mostrarMensaje("La proforma aún no ha sido facturada.")},m.eliminarDetalleActividadEmpresa=function(a){void 0!==a.id?a.eliminado=!0:m.actividadesSucursal.splice(m.actividadesSucursal.indexOf(a),1),m.cerrarConfirmacionEliminacion()},m.getFecha=function(){return void 0!==m.proforma?new Date(m.proforma.fecha):new Date},m.editarServicio=function(a){a.editado=!0,m.nActividad.actividadEconomica.actividad=a.actividad,m.nActividad.servicio=a},m.modificarProformaPrecioUnitarioServicio=function(a){void 0===a.editarPrecio?a.editarPrecio=!0:a.editarPrecio=void 0},m.actualizarPeriodo=function(a){var o=new Date(m.convertirFecha(a));m.obtenerCambioMonedaProforma(o),m.proforma.periodo_mes.id=o.getMonth(),m.proforma.periodo_anio.id=o.getFullYear()},m.buscarCliente=function(a){if(""!=a&&null!=a)return p(m.usuario.id_empresa,a)},m.establecerCliente=function(a){!m.proforma.ver&&m.verificarDetallesProformas()?(m.proforma.cliente=a,m.obtenercentroCostosClienteEmpresa(a),m.enfocar("proformaDetalle")):m.mostrarMensaje("No se permite.")},m.enfocar=function(a){s(function(){$("#"+a).focus()},0)},m.inicio=function(){m.listaCentroCostosClienteEmpresa=[],m.actividadesSucursal=[],m.nActividad={},m.proforma={},m.configuracionActividadServicio=[],m.servicios=[],m.detalleProforma={},m.detallesProformas=[],m.obtenerClientes(),m.obtenerActividadesEmpresa(m.usuario.empresa.id),m.filtro={empresa:m.usuario.empresa.id,mes:0,anio:0,sucursal:0,actividadEconomica:0,servicio:0,monto:0,razon:0,usuario:"",pagina:1,items_pagina:10,busqueda:0,numero:0},m.meses=[{id:0,nombre:"Enero"},{id:1,nombre:"Febrero"},{id:2,nombre:"Marzo"},{id:3,nombre:"Abril"},{id:4,nombre:"Mayo"},{id:5,nombre:"Junio"},{id:6,nombre:"Julio"},{id:7,nombre:"Agosto"},{id:8,nombre:"Septiembre"},{id:9,nombre:"Octubre"},{id:10,nombre:"Noviembre"},{id:11,nombre:"Diciembre"}],m.proformas=[],m.sucursalesUsuario="";for(var a=0;a<m.usuario.sucursalesUsuario.length;a++)m.sucursalesUsuario=m.sucursalesUsuario+m.usuario.sucursalesUsuario[a].sucursal.id,a+1!=m.usuario.sucursalesUsuario.length&&(m.sucursalesUsuario=m.sucursalesUsuario+",");m.obtenerPaginador(),m.obtenerCentroCosto()},m.verificarFechaRecepcion=function(a){return null==a},m.verificarFechaProformaOk=function(a){return null==a},m.verificarFechaFactura=function(a){return null==a},m.actualizarFechas=function(a){f.start(),void 0!==a&&(a.fecha_recepcion=a.fecha_recepcion instanceof Date?a.fecha_recepcion:null===a.fecha_recepcion?null:new Date(m.convertirFecha(a.fecha_recepcion)),a.fecha_proforma_ok=a.fecha_proforma_ok instanceof Date?a.fecha_proforma_ok:null===a.fecha_proforma_ok?null:new Date(m.convertirFecha(a.fecha_proforma_ok)),a.fecha_factura=a.fecha_factura instanceof Date?a.fecha_factura:null===a.fecha_factura?null:new Date(m.convertirFecha(a.fecha_factura)),a.fecha_cobro=a.fecha_cobro instanceof Date?a.fecha_cobro:null===a.fecha_cobro?null:new Date(m.convertirFecha(a.fecha_cobro)),D.save({id:a.id},a,function(a){m.proforma=void 0,m.mostrarMensaje(a.mensaje),m.cerrardialogmodalFechas(),m.recargarItemsTabla(),f.stop()},function(a){m.mostrarMensaje(void 0===a.message?a.stack:a.message),f.stop()}))},m.sinFuncionalidad=function(){m.mostrarMensaje("Sin funcionalidad")},m.agregardetalleProforma=function(a){void 0!==a.id_servicio&&(m.proforma.totalImporteBs=0,m.proforma.totalImporteSus=0,a.editar?(m.detallesProformas[m.detallesProformas.indexOf(a)]=a,m.detalleProforma.editar=void 0):m.detallesProformas.push(a),m.detalleProforma={},m.detallesProformas.forEach(function(a){a.eliminado||(m.proforma.totalImporteBs+=a.importe,m.proforma.totalImporteSus+=a.importeSus)}),m.proforma.importeLiteral=ConvertirALiteral(m.proforma.totalImporteBs.toFixed(2)),m.modificarProformaPrecioUnitarioServicio(a)),m.enfocar("id_servicioProforma")},m.obtenerCambioMonedaProforma=function(a){u(a).then(function(a){a.monedaCambio?(m.moneda=a.monedaCambio,void 0!==m.detalleProforma&&m.calcularImporte()):(m.moneda={ufv:"--",dolar:"--"},m.mostrarMensaje("La fecha "+m.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema."))})},m.obtenerCentroCosto=function(){d("CENCOS").then(function(a){m.centroCostos=a.clases.sort(function(a,o){return a.nombre>o.nombre?1:a.nombre<o.nombre?-1:0})})},m.obtenerActividadesSucursal=function(o){var a=$.grep(m.sucursales,function(a){return a.id==o})[0];m.actividadesDosificaciones=a.actividadesDosificaciones,m.actividadesSucursal=[],m.actividadesDosificaciones.map(function(a){a.dosificacion&&(a.expirado||a.dosificacion.expirado?m.dosificacionesExpiradas=!0:m.actividadesSucursal.push(a.actividad))})},m.obtenerActividadesGral=function(){m.actividades=[],d("ACTCOM").then(function(a){m.actividades=a.clases.sort()})},m.obtenerPaginador=function(){f.start(),m.paginator=c(),m.paginator.column="fecha",m.paginator.direccion="asc",m.filtro={empresa:m.usuario.empresa.id,mes:0,anio:0,sucursal:0,actividadEconomica:0,servicio:0,monto:0,razon:0,usuario:0,numero:0},m.paginator.filter=m.filtro,m.paginator.callBack=m.obtenerProformas,m.paginator.getSearch("",m.filtro,null),m.filtro={empresa:m.usuario.empresa.id,mes:"",anio:"",sucursal:"",actividadEconomica:"",servicio:"",monto:"",razon:"",usuario:"",numero:""},f.stop()},m.guardarConfiguracionActividadServicios=function(a){if("Siguiente"!=$("#siguiente").text().trim()){f.start(),m.nActividad={};var e=[],o=a.map(function(a,o){if(void 0===a.id||a.eliminado||void 0!==a.editado)return a;e.push(o)});if(e.reverse().forEach(function(a){o.splice(a,1)}),0<o.length)GuardarActividadServicio(m.usuario.empresa.id,0,o).then(function(a){m.mostrarMensaje(a.mensaje),m.obtenerSucursales(),f.stop(),m.cerrarConfiguracionActividadesServicios()}).catch(function(a){m.mostrarMensaje(void 0===a.message?a.stack:a.message),f.stop(),m.cerrarConfiguracionActividadesServicios()});else f.stop(),m.cerrarConfiguracionActividadesServicios()}},m.buscarservicio=function(a){if(""!=a&&null!=a){if(0<m.configuracionActividadServicio.length)return o("filter")(m.configuracionActividadServicio,a);void 0!==m.proforma&&void 0!==m.proforma.actividadEconomica&&m.mostrarMensaje('No hay servicios en la actividad seleccionada: "'+m.proforma.actividadEconomica.nombre+'"')}},m.establecerservicio=function(a,o){var e=Object.assign({},a);m.detalleProforma&&m.detalleProforma.servicio?(m.detalleProforma.id_servicio=e.id,m.detalleProforma.servicio=e,m.detalleProforma.precio_unitario=e.precio,m.detalleProforma.actividad_id=e.actividad.id,m.detalleProforma.actividad=e.actividad):m.detalleProforma={id_servicio:e.id,cantidad:1,servicio:e,precio_unitario:e.precio,actividad_id:e.actividad.id,actividad:e.actividad},m.detalleProforma.importe=m.detalleProforma.precio_unitario*m.detalleProforma.cantidad,void 0!==m.moneda&&null!==m.moneda.dolar&&"--"!==m.moneda.dolar&&(m.detalleProforma.precioSus=m.detalleProforma.precio_unitario/m.moneda.dolar,m.detalleProforma.importeSus=m.detalleProforma.precio_unitario/m.moneda.dolar*m.detalleProforma.cantidad),m.enfocar("cantidad"),void 0!==o&&m.cerrarBusquedaServiciosProforma()},m.calcularImporte=function(a){void 0===a?(m.detalleProforma.importe=m.detalleProforma.precio_unitario*m.detalleProforma.cantidad,void 0!==m.moneda&&null!==m.moneda.dolar&&"--"!==m.moneda.dolar&&(m.detalleProforma.precioSus=m.detalleProforma.precio_unitario/m.moneda.dolar,m.detalleProforma.importeSus=m.detalleProforma.precio_unitario/m.moneda.dolar*m.detalleProforma.cantidad)):(m.detalleProforma.importeSus=m.detalleProforma.precioSus*m.detalleProforma.cantidad,void 0!==m.moneda&&null!==m.moneda.dolar&&"--"!==m.moneda.dolar&&(m.detalleProforma.precio_unitario=m.detalleProforma.precioSus*m.moneda.dolar,m.detalleProforma.importe=m.detalleProforma.precioSus*m.moneda.dolar*m.detalleProforma.cantidad))},m.agregarDetalleActividadServicio=function(o){if(null!=o){var a=!1;if(void 0!==o.actividadEconomica&&null!==o.actividadEconomica||(a=!0),void 0===o.servicio&&null===o.servicio?a=!0:void 0===o.servicio.codigo||void 0===o.servicio.nombre||void 0===o.servicio.precio?a=!0:""!==o.servicio.codigo&&""!==o.servicio.nombre&&""!==o.servicio.precio||(a=!0),void 0!==o.actividadEconomica.dosificacion&&null!==o.actividadEconomica.dosificacion||(a=!0,errDos=!0),a)errDos?m.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar."):m.mostrarMensaje("Revise los datos e intente nuevamente.");else{var e=m.buscarservicio(o.servicio.nombre);if(void 0!==e)if(e.length<1)if(o.actividadEconomica.dosificacion,void 0!==o.actividadEconomica.dosificacion.id&&null!==o.actividadEconomica.dosificacion.id){var r={id:o.id,actividad:o.actividadEconomica.actividad,codigo:o.servicio.codigo,nombre:o.servicio.nombre,precio:o.servicio.precio};m.configuracionActividadServicio.push(r),m.nActividad.servicio=void 0}else m.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.");else if(void 0===o.servicio.id){var i=!1;if(e.map(function(a){a.nombre===o.servicio.nombre&&(i=!0,m.mostrarMensaje("El servicio ya fue asignado a esta actividad")),a.codigo===o.servicio.codigo&&(i=!0,m.mostrarMensaje("El codigo del servicio ya esta en uso o listo para ser asignado."))}),!i)if(void 0!==o.actividadEconomica.dosificacion.id&&null!==o.actividadEconomica.dosificacion.id){r={id:o.id,actividad:o.actividadEconomica.actividad,codigo:o.servicio.codigo,nombre:o.servicio.nombre,precio:o.servicio.precio};m.configuracionActividadServicio.push(r),m.nActividad.servicio=void 0}else m.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.")}else m.nActividad.servicio=void 0;else if(void 0!==o.actividadEconomica.dosificacion.id&&null!==o.actividadEconomica.dosificacion.id){r={id:o.id,actividad:o.actividadEconomica.actividad,codigo:o.servicio.codigo,nombre:o.servicio.nombre,precio:o.servicio.precio};m.configuracionActividadServicio.push(r),m.nActividad.servicio=void 0}else m.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.")}}},m.interceptarTecla=function(a,o,e){13===a.which&&(e?m.proforma.cliente?m.detalleProforma.servicio?m.enfocar(o):m.abrirBusquedaServiciosProforma(m.proforma.actividadEconomica):m.abrirdialogClientesProforma():s(function(){$("#"+o).trigger("click")},0))},m.filtrarClientes=function(a){m.clientesProcesados=o("filter")(m.clientes,a)},m.filtrarServicios=function(a){m.filser?m.serviciosProcesados=o("filter")(m.filser,a):m.serviciosProcesados=o("filter")(m.configuracionActividadServicio,a)},m.guardarConfiguracionActividadEconomicas=function(){if(f.start(),0<m.actividadesDosificaciones.length){var e=[],o=m.actividadesDosificaciones.map(function(a,o){if((void 0===a.id||a.eliminado||null==a.id_dosificacion&&(null==a.dosificacion||null==a.dosificacion)||a.editar)&&0==a.expirado)return a;e.push(o)});if(e.reverse().forEach(function(a){o.splice(a,1)}),0<o.length)I(m.usuario.empresa.id,o).then(function(a){void 0===a.hasErr?(m.obtenerSucursales(),m.mostrarMensaje(a.mensaje),m.actividadesDosificaciones=[],P(m.usuario.empresa.id).then(function(a){m.actividadesEmpresa=a.actividades,void 0!==a.mensaje&&m.mostrarMensaje(a.mensaje),f.stop(),m.cerrarConfiguracionActividades()}).catch(function(a){m.mostrarMensaje(void 0===a.message?a.stack:a.message),f.stop(),m.cerrarConfiguracionActividades()})):(m.mostrarMensaje(a.mensaje),f.stop())}).catch(function(a){var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o),f.stop()});else f.stop(),m.cerrarConfiguracionActividades()}else f.stop(),m.mostrarMensaje("Ingrese al menos 1 actividad para guardar.")},m.editarDetalleProforma=function(a){a.editar=!0,m.detalleProforma=a},m.obtenerServiciosActividadEmpresaPrincipal=function(a,o){(m.detalleProforma={},null!=a)?void 0!==a.id&&h(m.usuario.empresa.id,a.id).then(function(a){void 0!==o?m.filser=a.servicios:m.configuracionActividadServicio=a.servicios,m.serviciosProcesados=a.servicios,void 0!==a.mensaje&&m.mostrarMensaje(a.mensaje)}).catch(function(a){proforma.fecha_proforma=m.fechaATexto(proforma.fecha_proforma),f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)}):m.serviciosProcesados=[]},m.showInActivities=function(a){return!(a.expirado||a.eliminado||a.dosificacion.expirado)},m.obtenerSucursales=function(){f.start(),E(m.usuario.id).then(function(a){m.sucursales=a.sucursales.map(function(a){return a.sucursal}),f.stop()}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})},m.dosificarSucursalActividad=function(){if(m.cerrarconfirmarDosificacion(),0<m.actividadesDosificaciones.length){for(var a=!1,o=!1,e=0;0==o;)void 0!==m.actividadesDosificaciones[e].dosificacion&&null!==m.actividadesDosificaciones[e].dosificacion&&m.actividadesDosificaciones[e].dosificacion.id==m.paraDosificar.id&&(o=a=!0),e<m.actividadesDosificaciones.length-1?e+=1:o=!0;a?m.mostrarMensaje("Hubo un problema, la dosificacion esta en lista para ser asignada!"):(m.actividadADosificar.dosificacionAnterior=void 0!==m.actividadADosificar.dosificacion||null!==m.actividadADosificar.dosificacion?m.actividadADosificar.dosificacion:null,m.actividadesDosificaciones[m.actividadesDosificaciones.indexOf(m.actividadADosificar)].dosificacion=m.paraDosificar,m.actividadADosificar.editar=!0,m.actividadADosificar=void 0,m.cerrardialogDosificacionesDisponibles())}},m.agregarDetalleActividadEmpresa=function(a,o){if(void 0!==o.id)if(0<m.actividadesDosificaciones.length){for(var e=!1,r=!1,i=0;0==r;)m.actividadesDosificaciones[i].actividad.nombre!==o.nombre||m.actividadesDosificaciones[i].expirado?i>=m.actividadesDosificaciones.length-1?r=!0:i+=1:r=e=!0;if(e)m.mostrarMensaje('La actividad "'+o.nombre+'" ya esta en la lista de esta sucursal "'+a.nombre+'".');else{var t={actividad:o,sucursal:a,expirado:!1};m.actividadesDosificaciones.push(t)}}else{t={actividad:o,sucursal:a,expirado:!1};m.actividadesDosificaciones.push(t)}},m.obtenerDosificaciones=function(){S(m.usuario.id_empresa).then(function(a){m.dosificaciones=a}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})},m.abrirBusquedaServiciosProforma=function(){m.abrirPopup(m.dialogBusquedaServicio)},m.cerrarBusquedaServiciosProforma=function(){m.cerrarPopup(m.dialogBusquedaServicio)},m.abrirconfirmarDosificacion=function(a){m.paraDosificar=a,m.abrirPopup(m.confirmarDosificacion)},m.cerrarconfirmarDosificacion=function(){m.cerrarPopup(m.confirmarDosificacion)},m.abrirdialogDosificacionesDisponibles=function(a){m.obtenerDosificaciones(),m.actividadADosificar=a,m.abrirPopup(m.dialogDosificacionesDisponibles)},m.cerrardialogDosificacionesDisponibles=function(){m.dosificaciones=void 0,m.actividadADosificar=void 0,m.cerrarPopup(m.dialogDosificacionesDisponibles)},m.eliminarDetalleProforma=function(a){void 0!==a.id?a.eliminado=!0:m.detallesProformas.splice(m.detallesProformas.indexOf(a),1),m.recalcularImportesProforma()},m.recalcularImportesProforma=function(){var o=0;m.detallesProformas.map(function(a){a.eliminado||(o+=a.precio_unitario*a.cantidad,a.importe=a.precio_unitario*a.cantidad)}),m.proforma.totalImporteBs=o,m.proforma.totalImporteSus=6.96*o,m.proforma.importeLiteral=ConvertirALiteral(m.proforma.totalImporteBs.toFixed(2))},m.eliminarDetalleConfiguracion=function(a){void 0!==a.id?a.eliminado=!0:m.configuracionActividadServicio.splice(m.configuracionActividadServicio.indexOf(a),1),m.cerrarConfirmacionEliminacion()},m.buscarCliente=function(a){if(""!=a&&null!=a)return p(m.usuario.id_empresa,a)},m.seleccionarcliente=function(a){if(m.proforma.ver||m.verificarDetallesProformas())m.mostrarMensaje("No se permite.");else{var o=Object.assign({},a);m.proforma.cliente=o,m.obtenercentroCostosClienteEmpresa(a),m.cerrardialogClientesProforma()}},m.obtenerClientes=function(){C(m.usuario.id_empresa).then(function(a){m.clientes=a,m.clientesProcesados=a}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})},m.filtrarProformasOperaciones=function(a,o,e,r){if(void 0!==e)for(var i in a)0==a[i]&&(a[i]="");else for(var i in a)""!==a[i]&&null!==a[i]||(a[i]=0);if(void 0!==o&&o)return a;m.obtenerProformas(!0)},m.obtenerProformas=function(a,o){f.start(),m.filtro=m.filtrarProformasOperaciones(m.filtro,!0),m.paginator.filter=m.filtro,a&&(m.paginator.currentPage=1),v(m.paginator).then(function(a){m.proformas=a.proformas.map(function(a){return a.eliminado?a.color="red":a.color="",a}),m.paginator.setPages(a.count),void 0!==a.mensaje&&m.mostrarMensaje(a.mensaje),m.filtro=m.filtrarProformasOperaciones(m.filtro,!0,!0),s(function(){m.$apply(function(){m.totalProformas=0,m.totalProformasDolar=0,m.calcularTotalProformas()})},1e3),f.stop()}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})},m.guardarProforma=function(a,e){if(f.start(),a&&0<m.detallesProformas.length){if(m.detallesProformas.some(function(a){return a.editar}))return m.mostrarMensaje("No ha finalizado la edición de un detalle. No se puede guardar."),void f.stop();if(void 0!==e.id){var o=0;if(m.detallesProformas.forEach(function(a){a.eliminado&&(o+=1)}),o===m.detallesProformas.length)return m.mostrarMensaje("Se requiere al menos un dellate."),void f.stop();e.detallesProformas=m.detallesProformas,e.usuarioProforma=m.usuario,e.id_empresa=m.usuario.empresa.id,e.fecha_proforma=new Date(m.convertirFecha(e.fecha_proforma)),e.movimiento="PFR",M(e.id,e).then(function(a){m.mostrarMensaje(a.mensaje),void 0===a.hasErr?(m.cerrardialogProformaEdicion(),m.recargarItemsTabla()):m.proforma=a.proforma,f.stop()}).catch(function(a){f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})}else{e.id_empresa=m.usuario.empresa.id,e.detallesProformas=m.detallesProformas,e.usuarioProforma=m.usuario,e.fecha_proforma=new Date(m.convertirFecha(e.fecha_proforma)),F(m.usuario.empresa.id,m.usuario.id,e).then(function(a){m.mostrarMensaje(a.mensaje),void 0===a.hasErr?(m.cerrardialogProformaEdicion(),m.recargarItemsTabla()):e.fecha_proforma=m.fechaATexto(e.fecha_proforma),f.stop()}).catch(function(a){e.fecha_proforma=m.fechaATexto(e.fecha_proforma),f.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})}}else m.mostrarMensaje("Falta algún dato requerido. Por favor revise el formulario."),f.stop()},m.fechaATexto=function(a){return fech=new Date(a),a=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},m.abrirdialogProformaEdicion=function(a){void 0!==a?m.detalleProforma=void 0:(m.proforma.nueva=!0,m.proforma.sucursal=m.sucursales[0],m.proforma.fecha_proforma=(new Date).toLocaleDateString(),m.proforma.periodo_mes={id:(new Date).getMonth()},m.proforma.periodo_anio={id:(new Date).getFullYear()},m.obtenerCambioMonedaProforma(new Date),m.detalleProforma=void 0,m.obtenerActividadesSucursal(m.proforma.sucursal.id)),m.detalleProforma={},m.abrirPopup(m.dialogProformaEdicion)},m.cerrardialogProformaEdicion=function(){m.proforma.ver=void 0,m.detallesProformas=[],m.proforma={},m.configuracionActividadServicio=[],m.actividadesSucursal=[],m.listaCentroCostosClienteEmpresaPro=[],m.cerrarPopup(m.dialogProformaEdicion)},m.abrirConfiguracionActividadesServicios=function(){m.obtenerSucursales(),m.obtenerActividadesEmpresa(m.usuario.empresa.id),m.abrirPopup(m.modalConfiguracionActividadesServicios)},m.abrirdialogClientesProforma=function(){m.abrirPopup(m.dialogClientesProforma)},m.cerrardialogClientesProforma=function(){m.cerrarPopup(m.dialogClientesProforma)},m.obtenerActividadesEmpresa=function(a){_(a).then(function(a){m.actividadesEmpresaSinRepeticion=[],m.actividadesEmpresa=a.actividades,m.actividadesEmpresa.map(function(e){0==m.actividadesEmpresaSinRepeticion.length&&m.actividadesEmpresaSinRepeticion.push(e),m.actividadesEmpresaSinRepeticion.some(function(a,o){return a.actividad.id===e.actividad.id})||m.actividadesEmpresaSinRepeticion.push(e)})},function(a){m.mostrarMensaje(void 0!==a.stack?a.stack:a.message)})},m.obtenerActividadesDosificadasEmpresa=function(a){_(a).then(function(a){m.actividadesDosificadosEmpresa=a.actividades},function(a){m.mostrarMensaje(void 0!==a.stack?a.stack:a.message)})},m.abrirConfiguracionActividades=function(){m.obtenerSucursales(),m.obtenerActividadesGral(),m.obtenerActividadesEmpresa(m.usuario.empresa.id),m.abrirPopup(m.modalConfiguracionActividades)},m.cerrarConfiguracionActividades=function(){m.sucursalActividades=void 0,m.actividadEconomicaEmpresa=void 0,m.actividadesSucursal=[],m.obtenerActividadesEmpresa(m.usuario.empresa.id),m.recargarItemsTabla(),m.cerrarPopup(m.modalConfiguracionActividades)},m.abrirdialogmodalFechas=function(a,o){if(m.proformaFechas=a,m.abrirPopup(m.dialogmodalFechas),null!==m.proformaFechas.fecha_recepcion){var e=new Date(m.proformaFechas.fecha_recepcion).toLocaleDateString();m.proformaFechas.fecha_recepcion="Invalid Date"===e?new Date(m.convertirFecha(m.proformaFechas.fecha_recepcion)).toLocaleDateString():e}if(null!==m.proformaFechas.fecha_factura){e=new Date(m.proformaFechas.fecha_factura).toLocaleDateString();m.proformaFechas.fecha_factura="Invalid Date"===e?new Date(m.convertirFecha(m.proformaFechas.fecha_factura)).toLocaleDateString():e}if(null!==m.proformaFechas.fecha_proforma_ok){e=new Date(m.proformaFechas.fecha_proforma_ok).toLocaleDateString();m.proformaFechas.fecha_proforma_ok="Invalid Date"===e?new Date(m.convertirFecha(m.proformaFechas.fecha_proforma_ok)).toLocaleDateString():e}null!==m.proformaFechas.fecha_cobro&&(m.proformaFechas.fecha_cobro="Invalid Date"===e?new Date(m.convertirFecha(m.proformaFechas.fecha_cobro)).toLocaleDateString():e)},m.cerrardialogmodalFechas=function(){m.proformaFechas=void 0,m.recargarItemsTabla(),m.cerrarPopup(m.dialogmodalFechas)},m.cerrarConfiguracionActividadesServicios=function(){m.nActividad={},m.configuracionActividadServicio=[],m.recargarItemsTabla(),m.cerrarPopup(m.modalConfiguracionActividadesServicios)},m.abrirConfiguracionCentrosCostos=function(a){null!=a&&(m.centroCostosClienteEmpresa||(m.centroCostosClienteEmpresa={}),m.centroCostosClienteEmpresa.empresa=a,m.centroCostosClienteEmpresa.desdeProforma=!0,m.obtenercentroCostosClienteEmpresa(a)),m.abrirPopup(m.asignacionCentroCostoCliente)},m.cerrarConfiguracionCentrosCostos=function(){m.listaCentroCostosClienteEmpresa=[],m.centroCostosClienteEmpresa={},m.cerrarPopup(m.asignacionCentroCostoCliente)},m.agregarDetalleCentroCostosCliente=function(o){if(m.listaCentroCostosClienteEmpresa.some(function(a){return a.id==o.centroCosto.id}))m.mostrarMensaje("El centro ya fué asigando. No se puede duplicar.");else{var a=Object.assign({},o.centroCosto);a.nuevo=!0,m.listaCentroCostosClienteEmpresa.push(a)}},m.eliminarAsignacionCentroCosto=function(a){m.listaCentroCostosClienteEmpresa[m.listaCentroCostosClienteEmpresa.indexOf(a)].eliminado=!0},m.guardarAsignacionCentroCostos=function(a,o){if("Siguiente"!=$("#siguiente").text().trim()){var e=[];m.listaCentroCostosClienteEmpresa.forEach(function(a){(a.nuevo||a.eliminado)&&e.push(a)}),L(a.id,e).then(function(a){m.mostrarMensaje(a.mensaje),a.hasErr||(m.centroCostosClienteEmpresa.desdeProforma&&e.forEach(function(a){if(a.nuevo&&!a.eliminado&&m.listaCentroCostosClienteEmpresaPro.push(a),a.eliminado){var o=m.listaCentroCostosClienteEmpresaPro.indexOf(a);-1<o&&m.listaCentroCostosClienteEmpresaPro.splice(o,1)}}),m.cerrarConfiguracionCentrosCostos())}).catch(function(a){var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})}},m.obtenercentroCostosClienteEmpresa=function(a){m.listaCentroCostosClienteEmpresa=[],m.listaCentroCostosClienteEmpresaPro=[],B(a.id).then(function(a){a.hasErr?m.mostrarMensaje(a.mensaje):(m.listaCentroCostosClienteEmpresa=a.centros.map(function(a){return a.centroCosto}),m.listaCentroCostosClienteEmpresaPro=Object.assign([],m.listaCentroCostosClienteEmpresa))}).catch(function(a){var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o)})},m.showInHist=function(a,o){return!(a.id_actividad!=o.id_actividad||!a.expirado)},m.PopoverConfiguracionActividad={templateUrl:"PopoverConfiguracionActividad.html",title:"Menu",isOpen:!1},m.PopoverConfiguracionLlenarTabla={templateUrl:"PopoverConfiguracionLlenarTabla.html",title:"Empresas",isOpen:!1},m.PopoverConfiguracionActividadhistorial={templateUrl:"PopoverConfiguracionActividadhistorial.html",title:"Historial dosificacion actividad",isOpen:!1},m.impresiones={templateUrl:"impresiones.html",title:"Opcion de impresion",isOpen:!1},m.imprimir=function(a,e){f.start(),b(a.id,a.actividadEconomica.id).then(function(a){if(m.proforma=a.proforma,void 0!==a.mensaje||null==a.proforma||null==a.proforma)null!=a.proforma&&null!=a.proforma||null!=a.mensaje?m.mostrarMensaje(a.mensaje):m.mostrarMensaje("No se encuentra la información requerida");else{m.proforma.fecha_proforma=m.fechaATexto(new Date(m.proforma.fecha_proforma));var o=new Date(m.convertirFecha(m.proforma.fecha_proforma));u(o).then(function(a){a.monedaCambio?(m.moneda=a.monedaCambio,void 0!==m.detalleProforma&&m.calcularImporte()):(m.moneda={ufv:"--",dolar:"--"},m.mostrarMensaje("La fecha "+m.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema.")),convertUrlToBase64Image(m.usuario.empresa.imagen,function(a){if(0<a.length&&"error"!==a){var o=a;0==e&&m.imprimirSinDetalle(m.proforma,o),1==e&&m.imprimirConDetalle(m.proforma,o),2==e&&m.imprimirMixto(m.proforma,o)}else convertUrlToBase64Image("img/agilsoftware.png",function(a){if(0<a.length&&"error"!==a){m.mostrarMensaje("No se encuentra la imagen de la empresa. Se usara la imagen del software.");var o=a;0==e&&m.imprimirSinDetalle(m.proforma,o),1==e&&m.imprimirConDetalle(m.proforma,o),2==e&&m.imprimirMixto(m.proforma,o)}else convertUrlToBase64Image("img/agilsoftware.png",function(a){m.mostrarMensaje("No se encuentra la imagen de la empresa ni la imagen alternativa. No se imprimira la la imagen.");var o=a;0==e&&m.imprimirSinDetalle(m.proforma,o),1==e&&m.imprimirConDetalle(m.proforma,o),2==e&&m.imprimirMixto(m.proforma,o)})})}),f.stop()}).catch(function(a){var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o),f.stop()})}}).catch(function(a){var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";m.mostrarMensaje(o),f.stop()})},m.imprimirMixto=function(a,o){m.proforma=a;var e=new PDFDocument({size:"letter",margin:10,compress:!1}),r=e.pipe(blobStream());new Date;e.font("Helvetica",8);var i=245,t=0,n=1,c=Math.ceil(1/29);m.dibujarCabeceraPDFImpresion(e,n,c,m.proforma,o);for(var s=0,d=0;d<=m.proforma.detallesProformas.length&&t<=29;d++){if(e.font("Helvetica",8),0==d){e.text(m.proforma.detalle,150,i-2,{width:260});var l=null!==m.proforma.detalle?m.proforma.detalle.length:0;s=20*Math.ceil(l/260)}else e.text(m.proforma.detallesProformas[d-1].cantidad,70,i-2),e.text(m.proforma.detallesProformas[d-1].servicio.nombre,150,i-2,{width:260}),e.text(m.number_format(m.proforma.detallesProformas[d-1].precio_unitario,2),440,i-2),e.text(m.number_format(m.proforma.detallesProformas[d-1].importe,2),510,i-2);i=i+20+s,1===d?m.proforma.importe:0,1===d?m.proforma.cantidad:0,s=0,(29<++t||700<i)&&(e.addPage({size:[612,792],margin:10}),i=245,t=0,n+=1,m.dibujarCabeceraPDFImpresion(e,n,c,m.proforma,o))}e.rect(40,705,540,15).stroke(),e.rect(40,725,540,15).stroke(),m.proforma.importeLiteral=ConvertirALiteral(m.proforma.totalImporteBs.toFixed(2)),e.text("Son : "+m.proforma.importeLiteral,58,710),e.text(m.number_format(m.proforma.totalImporteBs,2),510,710),e.rect(41,725,538,14).fill("silver","#000").fill("black"),e.text("Son : "+m.number_format(m.proforma.totalImporteBs/m.moneda.dolar,2)+"  Dólares x "+m.moneda.dolar,58,730),e.end(),r.on("finish",function(){var a=r.toBlobURL("application/pdf");window.open(a,"_blank","location=no")}),f.stop()},m.imprimirConDetalle=function(a,o){m.proforma=a;var e=new PDFDocument({size:"letter",margin:10,compress:!1}),r=e.pipe(blobStream());new Date;e.font("Helvetica",8);var i=245,t=0,n=1,c=Math.ceil(1/29);m.dibujarCabeceraPDFImpresion(e,n,c,m.proforma,o);for(var s=0,d=0;d<m.proforma.detallesProformas.length&&t<=29;d++)e.font("Helvetica",8),e.text(m.proforma.detallesProformas[d].cantidad,70,i-2),e.text(m.proforma.detallesProformas[d].servicio.nombre,150,i-2,{width:260}),e.text(m.number_format(m.proforma.detallesProformas[d].precio_unitario,2),440,i-2),e.text(m.number_format(m.proforma.detallesProformas[d].importe,2),510,i-2),260<m.proforma.detallesProformas[d].servicio.nombre.length&&(s=10*Math.ceil(m.proforma.detallesProformas[d].servicio.nombre.length/260)),i=i+20+s,1===d?m.proforma.importe:0,1===d?m.proforma.cantidad:0,s=0,(29<++t||700<i)&&(e.addPage({size:[612,792],margin:10}),i=245,t=0,n+=1,m.dibujarCabeceraPDFImpresion(e,n,c,m.proforma,o));e.rect(40,705,540,15).stroke(),e.rect(40,725,540,15).stroke(),m.proforma.importeLiteral=ConvertirALiteral(m.proforma.totalImporteBs.toFixed(2)),e.text("Son : "+m.proforma.importeLiteral,58,710),e.text(m.number_format(m.proforma.totalImporteBs,2),510,710),e.rect(41,725,538,14).fill("silver","#000").fill("black"),e.text("Son : "+m.number_format(m.proforma.totalImporteBs/m.moneda.dolar,2)+"  Dólares x "+m.moneda.dolar,58,730),e.end(),r.on("finish",function(){var a=r.toBlobURL("application/pdf");window.open(a,"_blank","location=no")}),f.stop()},m.imprimirSinDetalle=function(a,o){m.proforma=a;var e=new PDFDocument({size:"letter",margin:10,compress:!1}),r=e.pipe(blobStream());new Date;e.font("Helvetica",8);var i=245,t=Math.ceil(1/29);m.dibujarCabeceraPDFImpresion(e,1,t,m.proforma,o),e.font("Helvetica",8);m.proforma.detallesProformas.map(function(a){a.cantidad}),e.text(1,70,i-2),e.text(m.proforma.detalle,150,i-2,{width:260}),extraDetalle=20*Math.ceil(m.proforma.detalle.length/260),e.text(m.number_format(m.proforma.totalImporteBs,2),440,i-2),e.text(m.number_format(m.proforma.totalImporteBs,2),510,i-2),i=i+20+extraDetalle,m.proforma.importeLiteral=ConvertirALiteral(m.proforma.totalImporteBs.toFixed(2)),e.rect(40,705,540,15).stroke(),e.rect(40,725,540,15).stroke(),e.text("Son : "+m.proforma.importeLiteral,58,710),e.text(m.number_format(m.proforma.totalImporteBs,2),510,710),e.rect(41,725,538,14).fill("silver","#000").fill("black"),e.text("Son : "+m.number_format(m.proforma.totalImporteBs/m.moneda.dolar,2)+"  Dólares x "+m.moneda.dolar,58,730),e.end(),r.on("finish",function(){var a=r.toBlobURL("application/pdf");window.open(a,"_blank","location=no")}),f.stop()},m.dibujarCabeceraPDFImpresion=function(a,o,e,r,i){var t=(new Date).getDate()+"/"+((new Date).getMonth()+1)+"/"+(new Date).getFullYear();a.rect(40,210,540,25).fillAndStroke("silver","#000"),a.font("Helvetica-Bold",12).fill("black"),a.text("PROFORMA",0,130,{align:"center"}),a.font("Helvetica-Bold",8),a.font("Helvetica",8),a.font("Helvetica-Bold",8),a.font("Helvetica",8),i&&a.image(i,40,30,{fit:[100,100]}),a.text(m.usuario.empresa.telefono1,80,110),a.text(m.usuario.empresa.direccion+" Santa Cruz",40,120,{width:90}),a.text("Santa Cruz,     ",65,165,{lineBreak:!1}).font("Helvetica-Bold",10).text(t.split("/")[0],{lineBreak:!1}).font("Helvetica",10).text("   de   ",{lineBreak:!1}).font("Helvetica-Bold",10).text(m.meses[new Date(m.convertirFecha(t)).getMonth()].nombre,{lineBreak:!1}).font("Helvetica",10).text("   de   ",{lineBreak:!1}).font("Helvetica-Bold",10).text(t.split("/")[2]),a.font("Helvetica-Bold",8),a.font("Helvetica",8),a.font("Helvetica-Bold",14),a.text("N°",380,60,{align:"center"}),a.text(r.correlativo,510,60),a.rect(40,210,540,25).stroke().fill("silver"),a.rect(0,0,0,0).stroke().fill("black"),a.font("Helvetica-Bold",8),a.text("CANTIDAD",55,220),a.text("DETALLE",200,220),a.text("P.UNIT",440,220),a.text("IMPORTE BS",510,220),a.text("Señor (es):",50,193),a.text("CI/NIT:",440,195),a.text("Teléfono:",40,110),a.font("Helvetica",8),a.text(r.cliente.razon_social,100,193),a.text(r.cliente.nit,500,195),a.rect(40,160,540,20).stroke(),a.rect(40,185,540,20).stroke(),a.rect(40,210,540,490).stroke(),a.rect(120,210,0,490).stroke(),a.rect(430,210,0,490).stroke(),a.rect(490,210,0,490).stroke(),a.text("Nota: La aprobación de la proforma deberá realizarse dentro de los próximos 7 días a partir de la fecha de recepción",0,750,{align:"center"})},m.inicio()}]);