angular.module("agil.controladores").controller("ControladorPlanillaSueldos",["$scope","$localStorage","$location","$templateCache","$route,blockUI","Parametro","Parametros","RecursosHumanosEmpleados","ClasesTipo","RecursosHumanosEmpleadosHorasExtras","RecursosHumanosPlanillaSueldos","RRHHlistaPlanillaSueldos",function($scope,$localStorage,$location,$templateCache,$route,blockUI,Parametro,Parametros,RecursosHumanosEmpleados,ClasesTipo,RecursosHumanosEmpleadosHorasExtras,RecursosHumanosPlanillaSueldos,RRHHlistaPlanillaSueldos){function HMToDecimal(hora,minuto){var d1=hora,m1=minuto,d=eval(d1),m=eval(m1),dH=Math.abs(d)+m/60;return console.log("en decimal es ",round(dH,2)),round(dH,2)}function calcAge(o){var a=+new Date(o);return~~((Date.now()-a)/315576e5)}function round(o,a){return Number(Math.round(o+"e"+a)+"e-"+a)}$scope.$on("$viewContentLoaded",function(){$scope.idModalNuevaPlanillaSueldos="dialog-nueva-planilla-sueldos",$scope.idModalEditarPlanillaSueldo="dialog-editar-planilla-sueldo",$scope.idModalParametros="dialog-parametros",$scope.idModalTR3="dialog-tr3",$scope.idModalHistorialTR3="dialog-historial-tr3",$scope.idEliminarSueldoEmpleado="dialog-eliminar-salario-empleado",ejecutarScriptsPlanillaSueldos($scope.idModalNuevaPlanillaSueldos,$scope.idModalEditarPlanillaSueldo,$scope.idModalParametros,$scope.idModalTR3,$scope.idModalHistorialTR3,$scope.idEliminarSueldoEmpleado)}),$scope.$on("$routeChangeStart",function(o,a){$scope.eliminarPopup($scope.idModalNuevaPlanillaSueldos,$scope.idModalEditarPlanillaSueldo,$scope.idModalParametros,$scope.idModalTR3,$scope.idModalHistorialTR3,$scope.idEliminarSueldoEmpleado)}),$scope.usuario=JSON.parse($localStorage.usuario),$scope.fechaATexto=function(o){return fech=new Date(o),o=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},$scope.obtenerGestiones=function(){blockUI.start(),ClasesTipo("GTN").then(function(o){$scope.gestiones=o.clases,blockUI.stop()})},$scope.obtenerGestiones(),$scope.nuevaPlanillaSueldos=function(){$scope.planilla=new RecursosHumanosPlanillaSueldos({id_empresa:$scope.usuario.id_empresa}),$scope.sumarTotales($scope.planilla)},$scope.abrirDialogNuevaPlanillaSueldos=function(){$scope.nuevaPlanillaSueldos(),$scope.abrirPopup($scope.idModalNuevaPlanillaSueldos)},$scope.filtrarSueldos=function(s){console.log("cabezera",s);var e=RecursosHumanosEmpleados($scope.usuario.id_empresa);e.then(function(o){console.log("empleadossssstt ",o),s.RecursosHumanosEmpleados=o.empleados,s.RecursosHumanosEmpleados.forEach(function(a){console.log("los ides de empleados ==== ",a),(e=RecursosHumanosEmpleadosHorasExtras(a.id_ficha,s.gestion,s.mes.split("-")[0],a.id)).then(function(o){console.log("los datos de  los empleados ",o),a.sueldoBasico=a.haber_basico,$scope.horasExtras=8,console.log("ficha fecha inicio ==== ",a.fecha_inicio),$scope.antiguedad=calcAge(a.fecha_inicio),console.log("$scope.antiguedad",$scope.antiguedad),$scope.bonoFrontera=0,$scope.otrosBonos=0,a.horasExtras=o.totalHoras,a.totalHorasExtras=round(a.sueldoBasico/30/8*a.horasExtras*2,2),a.recargoNocturno=round(a.sueldoBasico/30/8*a.horasExtras*1.5,2),a.bonoAntiguedad=$scope.calcularBonoAntiguedad($scope.antiguedad),a.bonoFrontera=$scope.bonoFrontera,a.otrosBonos=$scope.otrosBonos,a.totalGanado=round(a.sueldoBasico+a.totalHorasExtras+a.recargoNocturno+a.bonoAntiguedad+a.bonoFrontera+a.otrosBonos,2),a.afp=round(12.71*a.totalGanado/100,2),null==a.rc_iva_mes&&(a.rc_iva_mes=0),a.rc_iva=a.rc_iva_mes,a.anticipos=round(o.totalAnticipo,2),a.prestamos=round(o.totalCuotas,2),a.totalDescuento=round(a.afp+a.rc_iva+a.anticipos+a.prestamos,2),a.liquidoPagable=round(a.totalGanado-a.totalDescuento,2),$scope.sumarTotales(s)})}),blockUI.stop()})},$scope.generar=function(o){o.$save(function(o){$scope.nuevaPlanillaSueldos(),blockUI.stop(),$scope.mostrarMensaje("Planilla registrada exitosamente!")},function(o){blockUI.stop(),console.log("fallo ",o)}),console.log("los datos  de planilla ",o)},$scope.sumarTotales=function(o){$scope.totalSueldoBasico=0,$scope.sumaHorasExtras=0,$scope.sumaTotalHorasExtras=0,$scope.sumaRecargoNocturno=0,$scope.sumaBonoAntiguedad=0,$scope.sumaBonoFrontera=0,$scope.sumaOtrosBonos=0,$scope.sumaTotalGanado=0,$scope.sumaAFP=0,$scope.sumaRCIVA=0,$scope.sumaAniticipos=0,$scope.sumaPrestamos=0,$scope.sumaTotalDescuento=0;var a=$scope.sumaLiquidoPagable=0;if(null!=o.RecursosHumanosEmpleados)for(var s=0;s<o.RecursosHumanosEmpleados.length;s++)a+=1,$scope.totalSueldoBasico=round($scope.totalSueldoBasico+o.RecursosHumanosEmpleados[s].sueldoBasico,2),$scope.sumaHorasExtras=$scope.sumaHorasExtras+o.RecursosHumanosEmpleados[s].horasExtras,$scope.sumaTotalHorasExtras=$scope.sumaTotalHorasExtras+o.RecursosHumanosEmpleados[s].totalHorasExtras,$scope.sumaRecargoNocturno=$scope.sumaRecargoNocturno+o.RecursosHumanosEmpleados[s].recargoNocturno,$scope.sumaBonoAntiguedad=$scope.sumaBonoAntiguedad+o.RecursosHumanosEmpleados[s].bonoAntiguedad,$scope.sumaBonoFrontera=$scope.sumaBonoFrontera+o.RecursosHumanosEmpleados[s].bonoFrontera,$scope.sumaOtrosBonos=$scope.sumaOtrosBonos+o.RecursosHumanosEmpleados[s].otrosBonos,$scope.sumaTotalGanado=round($scope.sumaTotalGanado+o.RecursosHumanosEmpleados[s].totalGanado,2),$scope.sumaAFP=round($scope.sumaAFP+o.RecursosHumanosEmpleados[s].afp,2),$scope.sumaRCIVA=round($scope.sumaRCIVA+o.RecursosHumanosEmpleados[s].rc_iva,2),$scope.sumaAniticipos=round($scope.sumaAniticipos+o.RecursosHumanosEmpleados[s].anticipos,2),$scope.sumaPrestamos=round($scope.sumaPrestamos+o.RecursosHumanosEmpleados[s].prestamos,2),$scope.sumaTotalDescuento=round($scope.sumaTotalDescuento+o.RecursosHumanosEmpleados[s].totalDescuento,2),$scope.sumaLiquidoPagable=round($scope.sumaLiquidoPagable+o.RecursosHumanosEmpleados[s].liquidoPagable,2);o.totalEmpleados=a,o.importeSueldoBasico=$scope.totalSueldoBasico,o.totalHorasExtras=$scope.sumaHorasExtras,o.importeHorasExtras=$scope.sumaTotalHorasExtras,o.importeRecargoNocturno=$scope.sumaRecargoNocturno,o.importeBonoAntiguedad=$scope.sumaBonoAntiguedad,o.importeBonoFrontera=$scope.sumaBonoFrontera,o.importeOtrosBonos=$scope.sumaOtrosBonos,o.importeAFP=$scope.sumaAFP,o.importeRCIVA=$scope.sumaRCIVA,o.importeAniticipos=$scope.sumaAniticipos,o.importePrestamos=$scope.sumaPrestamos,o.importeTotalDescuento=$scope.sumaTotalDescuento,o.importeTotalGanado=$scope.sumaTotalGanado,o.importeLiquidoPagable=$scope.sumaLiquidoPagable},$scope.calcularBonoAntiguedad=function(o){return 0<=o&&o<=2?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_cero_dos/100:2<o&&o<=5?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_dos_cinco/100:5<o&&o<=8?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_cinco_ocho/100:8<o&&o<=11?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_ocho_once/100:11<o&&o<=15?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_once_quince/100:15<o&&o<=20?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_quice_veinte/100:20<o&&o<=25?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_veinte_veinticinco/100:25<o?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_mas_veinticinco/100:void 0},$scope.cerrarDialogNuevaPlanillaSueldos=function(){$scope.cerrarPopup($scope.idModalNuevaPlanillaSueldos)},$scope.obtenerParametros=function(o){blockUI.start(),null==o&&(o=0),Parametros(o).then(function(o){$scope.parametros=o,blockUI.stop()})},$scope.abrirDialogEditarPlanillaSueldo=function(o){$scope.empleado=o,$scope.sueldo=angular.copy(o),$scope.abrirPopup($scope.idModalEditarPlanillaSueldo)},$scope.modificarSueldo=function(o){$scope.empleado=angular.extend($scope.empleado,o),$scope.sumarTotales($scope.planilla),$scope.cerrarDialogEditarPlanillaSueldo()},$scope.cerrarDialogEditarPlanillaSueldo=function(){$scope.cerrarPopup($scope.idModalEditarPlanillaSueldo)},$scope.cerrarDialogEliminarSueldoEmpleado=function(){$scope.cerrarPopup($scope.idEliminarSueldoEmpleado)},$scope.abrirDialogEliminarSueldoEmpleado=function(o,a){$scope.empleado=a,$scope.index=o,$scope.abrirPopup($scope.idEliminarSueldoEmpleado)},$scope.eliminarSueldoEmpleado=function(o,a){$scope.planilla.RecursosHumanosEmpleados.splice(o,1),$scope.sumarTotales($scope.planilla),$scope.empleado=null,$scope.cerrarDialogEliminarSueldoEmpleado(),$scope.mostrarMensaje("el sueldo se elimino")},$scope.calcularTotalEditados=function(){$scope.sueldo.totalHorasExtras=round($scope.sueldo.sueldoBasico/30/8*$scope.horasExtras*2,2),$scope.sueldo.recargoNocturno=Math.round($scope.sueldo.sueldoBasico/30/8*$scope.sueldo.horasExtras*1.5),$scope.sueldo.totalGanado=$scope.sueldo.sueldoBasico+$scope.sueldo.totalHorasExtras+$scope.sueldo.recargoNocturno+$scope.sueldo.bonoAntiguedad+$scope.sueldo.bonoFrontera+$scope.sueldo.otrosBonos,$scope.sueldo.afp=round(12.71*$scope.sueldo.totalGanado/100,2),$scope.sueldo.totalDescuento=$scope.sueldo.afp+$scope.sueldo.rc_iva+$scope.sueldo.anticipos+$scope.sueldo.prestamos,$scope.sueldo.liquidoPagable=round($scope.sueldo.totalGanado-$scope.sueldo.totalDescuento,2)},$scope.filtrarListaPlanillaSueldos=function(a){console.log("cabezera generalllllll ",a),RRHHlistaPlanillaSueldos($scope.usuario.id_empresa,a.gestion,a.mes).then(function(o){console.log("empleadossssstt ",o),a.planillas=o.planillas,blockUI.stop()})},$scope.abrirDialogParametros=function(){$scope.abrirPopup($scope.idModalParametros)},$scope.cerrarDialogParametros=function(){$scope.cerrarPopup($scope.idModalParametros)},$scope.editarParametros=function(o){blockUI.start(),$scope.parametros=o,Parametro.update({idEmpresa:$scope.usuario.id_empresa},o,function(o){console.log("el mensaje es----",o.mensaje),$scope.mostrarMensaje(o.mensaje)},function(o){$scope.mostrarMensaje("Ocurrio un problema al momento de guardar!")}),blockUI.stop(),$scope.cerrarDialogParametros()},$scope.abrirDialogTR3=function(){$scope.abrirPopup($scope.idModalTR3)},$scope.cerrarDialogTR3=function(){$scope.cerrarPopup($scope.idModalTR3)},$scope.abrirDialogHistorialTR3=function(){$scope.abrirPopup($scope.idModalHistorialTR3)},$scope.cerrarDialogHistorialTR3=function(){$scope.cerrarPopup($scope.idModalHistorialTR3)},$scope.obtenerParametros($scope.usuario.id_empresa)}]);