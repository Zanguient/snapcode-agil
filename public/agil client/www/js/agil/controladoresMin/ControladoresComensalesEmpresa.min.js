angular.module("agil.controladores").controller("controladorComensalesEmpresa",["$scope","$timeout","$localStorage","$filter","$location","blockUI","Clientes","ClientesNit","GuardarAlias","ObtenerAlias","GuardarGerencias","ObtenerGerencias","GuardarComensales","ObtenerComensales","GuardarComidas","ObtenerComidas","GuardarPrecioComidas","ObtenerPrecioComidas","GuardarHistorialExcel","GuardarComensalesExcel","ObtenerHistorial","GuardarEmpresasExcel","GuardarGerenciasExcel","GuardarComidasExcel","GuardarPreciosExcel","Paginator","BusquedaComensales","ObtenerReporteComedor","ObtenerCambioMoneda","ObtenerReporteEmpresa","ObtenerReporteComensal","ObtenerAlertasMarcacion","EditarAlertasMarcacion","ObtenerHistorialDocumentos","ObtenerDocumento",function(k,e,a,r,o,g,i,s,t,n,l,m,c,d,p,u,f,C,h,E,b,v,M,x,S,j,w,A,_,P,y,z,O,R,L){k.usuario=JSON.parse(a.usuario),k.modalEdicionAlias="modalAliasEmpresasCliente",k.modalEdicionGerencias="modalGerenciaEmpresasCliente",k.modalEdicionComensales="modalComensalesEmpresasCliente",k.modalEdicionComidas="modalComidasEmpresasCliente",k.modalEdicionPrecios="modalPreciosComidasEmpresasCliente",k.dialogClienteEmpresa="dialog-cliente-empresa",k.busquedaComensalesEmpresa="dialog-comensales-empresa",k.dialogAlertasMarcaciones="dialog-alerta-marcaciones",k.dialogHistorialDocumentos="dialog-historial-documentos",k.imagenEmpresa,k.$on("$viewContentLoaded",function(){ejecutarScriptsComensales(k.modalEdicionAlias,k.modalEdicionGerencias,k.modalEdicionComensales,k.modalEdicionComidas,k.modalEdicionPrecios,k.dialogClienteEmpresa,k.busquedaComensalesEmpresa,k.dialogAlertasMarcaciones,k.dialogHistorialDocumentos)}),k.$on("$routeChangeStart",function(e,a){k.eliminarPopup(k.modalEdicionAlias),k.eliminarPopup(k.modalEdicionGerencias),k.eliminarPopup(k.modalEdicionComensales),k.eliminarPopup(k.modalEdicionComidas),k.eliminarPopup(k.modalEdicionPrecios),k.eliminarPopup(k.dialogClienteEmpresa),k.eliminarPopup(k.busquedaComensalesEmpresa),k.eliminarPopup(k.dialogAlertasMarcaciones),k.eliminarPopup(k.dialogHistorialDocumentos)}),convertUrlToBase64Image(k.usuario.empresa.imagen,function(e){0<e.length&&"error"!==e?k.imagenEmpresa=e:convertUrlToBase64Image("img/agilsoftware.png",function(e){0<e.length&&"error"!==e?(k.mostrarMensaje("No se encuentra la imagen de la empresa."),k.imagenEmpresa=e):k.mostrarMensaje("No se encuentra imagenen de la empresa.")})}),k.inicio=function(){if(k.activeModal=0,k.obtenerClientes(),k.empresaExternaSeleccionada){var e=Object.assign({},k.empresaExternaSeleccionada);k.filtroComensales={desde:"",hasta:"",empresaCliente:e,id_usuario:"",id_cliente:"",mes:"",anio:"",gerencia:"",comida:"",comensal:""},k.reportes=[{id:1,nombre:"Reporte Comedor"},{id:2,nombre:"Empresa"},{id:3,nombre:"Por comensal"}],k.obtenerPaginador(),k.listaAliasclientesEmpresa=[],k.listaComensalesclienteEmpresa=[],k.listaGerenciasClienteEmpresa=[],k.listaComidasclienteEmpresa=[],k.listaPrecioComidasclienteEmpresa=[],k.alertaMarcaciones=[],k.historialesDocumentos=[],k.obtenerComidas(),k.obtenerGerencias(),k.obtenerHistoriales(),k.obtenerComensales()}g.stop()},k.PopoverConfiguracionComensales={templateUrl:"PopoverConfiguracionComensales.html",title:"Menu",isOpen:!1},k.buscarCliente=function(e){if(""!=e&&null!=e)return s(k.usuario.id_empresa,e)},k.buscarComensales=function(e){if(""!=e&&null!=e)return w(k.usuario.id_empresa,k.usuario.id,k.empresaExternaSeleccionada.id,e)},k.filtrarClientes=function(e){k.clientesProcesados=r("filter")(k.clientes,e)},k.filtrarComensales=function(e){k.comensalesProcesados=r("filter")(k.comensalesBusqueda,e)},k.obtenerHistorialDocumentos=function(){g.start(),k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0),k.paginator.filter=k.filtroComensales,R(k.usuario.id_empresa,k.usuario.id,k.empresaExternaSeleccionada.id,k.paginator).then(function(e){k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0,!0),e.hasErr?k.mostrarMensaje(e.mensaje):k.historialesDocumentos=e.documentos,g.stop()}).catch(function(e){g.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a)})},k.obtenerClientes=function(){g.start(),i(k.usuario.id_empresa).then(function(e){k.clientes=e,k.clientesProcesados=e,g.stop()}).catch(function(e){g.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a)})},k.establecerCliente=function(e){switch(k.activeModal){case 0:k.filtroComensales||(k.filtroComensales={}),k.empresaExternaSeleccionada||(k.empresaExternaSeleccionada=Object.assign({},e),k.inicio()),k.filtroComensales.empresaCliente=Object.assign({},e);break;case 1:k.clienteEmpresaAsignacionAlias||(k.clienteEmpresaAsignacionAlias={}),k.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},e);break;case 2:k.clienteEmpresaEdicionGerencias||(k.clienteEmpresaEdicionGerencias={}),k.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},e),k.obtenerGerencias(!0);break;case 3:k.clienteEmpresaEdicionComensales||(k.clienteEmpresaEdicionComensales={}),k.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},e),k.obtenerComensales(!0);break;case 4:k.clienteEmpresaComidas||(k.clienteEmpresaComidas={}),k.clienteEmpresaComidas.empresaCliente=Object.assign({},e),k.clienteEmpresaComidas.verTodos,k.obtenerComidas(!0);break;case 5:k.clienteEmpresaPreciosComidas||(k.clienteEmpresaPreciosComidas={}),k.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},e),k.obtenerPrecioComidas(!0);break;default:k.mostrarMensaje("Ocurrio un error al asignar")}},k.establecerComensal=function(e,a){k.filtroComensales.comensal=Object.assign({},e),a&&k.cerrardialogBusquedaComensales()},k.seleccionarcliente=function(e){switch(k.activeModal){case 0:k.filtroComensales||(k.filtroComensales={}),k.empresaExternaSeleccionada||(k.empresaExternaSeleccionada=Object.assign({},e),k.inicio()),k.filtroComensales.empresaCliente=Object.assign({},e);break;case 1:k.clienteEmpresaAsignacionAlias||(k.clienteEmpresaAsignacionAlias={}),k.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},e);break;case 2:k.clienteEmpresaEdicionGerencias||(k.clienteEmpresaEdicionGerencias={}),k.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},e),k.obtenerGerencias(!0);break;case 3:k.clienteEmpresaEdicionComensales||(k.clienteEmpresaEdicionComensales={}),k.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},e),k.obtenerComensales(!0);break;case 4:k.clienteEmpresaComidas||(k.clienteEmpresaComidas={}),k.clienteEmpresaComidas.empresaCliente=Object.assign({},e),k.clienteEmpresaComidas.verTodos=!1,k.obtenerComidas(!0);break;case 5:k.clienteEmpresaPreciosComidas||(k.clienteEmpresaPreciosComidas={}),k.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},e),k.obtenerPrecioComidas(!0);break;default:k.mostrarMensaje("Ocurrio un error al asignar")}k.cerrardialogClientesComensales()},k.obtenerAliasEmpresa=function(){g.start(),n(k.usuario.id_empresa,k.usuario.id).then(function(e){e.hasErr?k.mostrarMensaje(e.mensaje):k.listaAliasclientesEmpresa=e.lista,g.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.obtenerGerencias=function(e){g.start(),m(k.usuario.id_empresa,k.usuario.id,e?k.clienteEmpresaEdicionGerencias.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){e.hasErr?k.mostrarMensaje(e.mensaje):k.listaGerenciasClienteEmpresa=e.lista,g.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.obtenerComensales=function(e){g.start(),d(k.usuario.id_empresa,k.usuario.id,e?k.clienteEmpresaEdicionComensales.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){e.hasErr?k.mostrarMensaje(e.mensaje):(k.listaComensalesclienteEmpresa=e.lista,k.comensalesBusqueda=e.lista,k.comensalesProcesados=e.lista),g.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.verTodasLasComidas=function(){k.clienteEmpresaComidas?k.clienteEmpresaComidas.verTodos?k.clienteEmpresaComidas.verTodos=!1:k.clienteEmpresaComidas.verTodos=!0:(k.clienteEmpresaComidas={},k.clienteEmpresaComidas.verTodos=!1),k.obtenerComidas()},k.obtenerComidas=function(e){g.start(),k.clienteEmpresaComidas||(k.clienteEmpresaComidas={},k.clienteEmpresaComidas.verTodos=!1),(e?u(k.usuario.id_empresa,k.usuario.id,k.clienteEmpresaComidas.empresaCliente.id):k.clienteEmpresaComidas.verTodos?u(k.usuario.id_empresa,k.usuario.id,0):u(k.usuario.id_empresa,k.usuario.id,k.empresaExternaSeleccionada.id)).then(function(e){e.hasErr?k.mostrarMensaje(e.mensaje):k.listaComidasclienteEmpresa=e.lista,g.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.obtenerPrecioComidas=function(e){g.start(),C(k.usuario.id_empresa,k.usuario.id,e?k.clienteEmpresaPreciosComidas.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){e.hasErr?k.mostrarMensaje(e.mensaje):k.listaPrecioComidasclienteEmpresa=e.lista,g.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.obtenerHistoriales=function(e){g.start(),k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0),k.paginator.filter=k.filtroComensales,b(k.usuario.id_empresa,k.usuario.id,k.empresaExternaSeleccionada.id,k.paginator).then(function(e){k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0,!0),e.hasErr?e.mostrarMensaje(e.mensaje):(k.historialesComedor=e.historial.map(function(e){return e.fecha_texto=e.fecha.split("T")[0].split("-").reverse().join("/")+" "+e.fecha.split("T")[1].split(".")[0],e.fecha=new Date(e.fecha),e}),k.paginator.setPages(e.paginas)),g.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.obtenerAlertas=function(e){g.start(),z(k.usuario.id_empresa,k.usuario.id,k.empresaExternaSeleccionada.id).then(function(e){if(e.hasErr)e.mostrarMensaje(e.mensaje);else{k.alertaMarcaciones=e.alertas,k.Marcaciones=e.alertas;for(var a=0;a<k.alertaMarcaciones.length;a++){k.alertaMarcaciones[a].marcacionesFaltantes=[];for(var r=0;r<k.alertaMarcaciones[a].marcaciones.length;r++){var o=-1;if(k.alertaMarcaciones[a].marcacionesFaltantes.some(function(e){return o+=1,e.fecha.split("T")[0]===k.alertaMarcaciones[a].marcaciones[r].fecha.split("T")[0].split("-").reverse().join("/")})){if(k.alertaMarcaciones[a].marcacionesFaltantes[o].id_comida)(i=k.listaComidasclienteEmpresa.find(function(e){return e.id===k.alertaMarcaciones[a].marcaciones[r].id_comida}))?("desayuno"===i.nombre.toLowerCase()&&(k.alertaMarcaciones[a].marcacionesFaltantes[o].desayuno.cantidad+=1),"almuerzo"===i.nombre.toLowerCase()&&(k.alertaMarcaciones[a].marcacionesFaltantes[o].almuerzo.cantidad+=1),"cena"===i.nombre.toLowerCase()&&(k.alertaMarcaciones[a].marcacionesFaltantes[o].cena.cantidad+=1)):k.alertaMarcaciones[a].marcacionesFaltantes[o].fuera_horario+=1;else k.alertaMarcaciones[a].marcacionesFaltantes[o].fuera_horario+=1}else{var i,s={cantidad:0,id_comida:k.alertaMarcaciones[a].marcaciones[r].id_comida},t={id_comida:k.alertaMarcaciones[a].marcaciones[r].id_comida,fecha:k.alertaMarcaciones[a].marcaciones[r].fecha.split("T")[0].split("-").reverse().join("/"),desayuno:Object.assign({},s),almuerzo:Object.assign({},s),cena:Object.assign({},s),fuera_horario:0,gerencia:{id:k.alertaMarcaciones[a].marcaciones[r].id_gerencia}};(i=k.listaComidasclienteEmpresa.find(function(e){return e.id===k.alertaMarcaciones[a].marcaciones[r].id_comida}))?("desayuno"===i.nombre.toLowerCase()&&(t.desayuno.cantidad+=1),"almuerzo"===i.nombre.toLowerCase()&&(t.almuerzo.cantidad+=1),"cena"===i.nombre.toLowerCase()&&(t.cena.cantidad+=1)):t.fuera_horario+=1,k.alertaMarcaciones[a].marcacionesFaltantes.push(t)}}}var n=[];for(a=0;a<k.alertaMarcaciones.length;a++)for(r=0;r<k.alertaMarcaciones[a].marcacionesFaltantes.length;r++){var l=k.listaComidasclienteEmpresa.find(function(e){return"desayuno"===e.nombre.toLowerCase()}),c=k.listaComidasclienteEmpresa.find(function(e){return"almuerzo"===e.nombre.toLowerCase()}),m=k.listaComidasclienteEmpresa.find(function(e){return"cena"===e.nombre.toLowerCase()});if(0===k.alertaMarcaciones[a].marcacionesFaltantes[r].desayuno.cantidad){var d={comida:l,fecha:k.alertaMarcaciones[a].marcacionesFaltantes[r].fecha,gerencia:k.alertaMarcaciones[a].marcacionesFaltantes[r].gerencia,comensal:{id:k.alertaMarcaciones[a].id,nombre:k.alertaMarcaciones[a].nombre,id_cliente:k.alertaMarcaciones[a].id_cliente,id_empresa:k.alertaMarcaciones[a].id_empresa,tarjeta:k.alertaMarcaciones[a].tarjeta,tipo:k.alertaMarcaciones[a].tipo}};n.push(d)}if(0===k.alertaMarcaciones[a].marcacionesFaltantes[r].almuerzo.cantidad){d={comida:c,fecha:k.alertaMarcaciones[a].marcacionesFaltantes[r].fecha,gerencia:k.alertaMarcaciones[a].marcacionesFaltantes[r].gerencia,comensal:{id:k.alertaMarcaciones[a].id,nombre:k.alertaMarcaciones[a].nombre,id_cliente:k.alertaMarcaciones[a].id_cliente,id_empresa:k.alertaMarcaciones[a].id_empresa,tarjeta:k.alertaMarcaciones[a].tarjeta,tipo:k.alertaMarcaciones[a].tipo}};n.push(d)}if(0===k.alertaMarcaciones[a].marcacionesFaltantes[r].cena.cantidad){d={comida:m,fecha:k.alertaMarcaciones[a].marcacionesFaltantes[r].fecha,gerencia:k.alertaMarcaciones[a].marcacionesFaltantes[r].gerencia,comensal:{id:k.alertaMarcaciones[a].id,nombre:k.alertaMarcaciones[a].nombre,id_cliente:k.alertaMarcaciones[a].id_cliente,id_empresa:k.alertaMarcaciones[a].id_empresa,tarjeta:k.alertaMarcaciones[a].tarjeta,tipo:k.alertaMarcaciones[a].tipo}};n.push(d)}}k.alertaMarcaciones=n,g.stop()}g.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.obtenerPaginador=function(){k.paginator=j(),k.paginator.column="fecha",k.paginator.direccion="asc",k.paginator.callBack=k.obtenerHistoriales},k.filtrarHistorial=function(e,a,r){if(void 0!==r)for(var o in e)0==e[o]&&(e[o]="");else for(var o in e)""!==e[o]&&null!==e[o]||(e[o]=0);if(void 0!==a&&a)return e;k.obtenerHistoriales(!0)},k.subirExcelHistorial=function(e){var a,r,o=e.target.files;if(o)for(r=o[a=0];a!=o.length;++a){var i=new FileReader,l=r.name;i.onload=function(e){var a=e.target.result,r=XLSX.read(a,{type:"binary"}),o=r.SheetNames[0],i=2,s=r.Sheets[o],t=[];do{var n={};n.tarjeta=null!=s["A"+i]&&""!=s["A"+i]?s["A"+i].v.toString():null,n.nombre=null!=s["B"+i]&&""!=s["B"+i]?s["B"+i].v.toString():null,n.fecha_hora=null!=s["C"+i]&&""!=s["C"+i]?s["C"+i].v.toString():null,n.lectora=null!=s["D"+i]&&""!=s["D"+i]?s["D"+i].v.toString():null,n.alias=null!=s["E"+i]&&""!=s["E"+i]?s["E"+i].v.toString():null,n.documento=l,t.push(n),i++,0}while(null!=s["A"+i]);angular.element($("fileUpload-Historial").val(null)).triggerHandler("change"),k.guardarHistorialExcel(t)},i.readAsBinaryString(r)}else g.stop()},k.subirExcelComensales=function(e){var a,r,o=e.target.files;for(r=o[a=0];a!=o.length;++a){var i=new FileReader;r.name;i.onload=function(e){g.start();var a=e.target.result,r=XLSX.read(a,{type:"binary"}),o=r.SheetNames[0],i=2,s=r.Sheets[o],t=[];do{var n={};n.codigo=null!=s["A"+i]&&""!=s["A"+i]?s["A"+i].v.toString():null,n.tarjeta=null!=s["B"+i]&&""!=s["B"+i]?s["B"+i].v.toString():null,n.nombre=null!=s["C"+i]&&""!=s["C"+i]?s["C"+i].v.toString():null,n.empresaCliente=null!=s["D"+i]&&""!=s["D"+i]?s["D"+i].v.toString():null,n.gerencia=null!=s["E"+i]&&""!=s["E"+i]?s["E"+i].v.toString():null,n.tipo=null!=s["F"+i]&&""!=s["F"+i]?s["F"+i].v.toString():null,t.push(n),i++,0}while(null!=s["A"+i]);g.stop(),angular.element($("fileUploadComensales").val(null)).triggerHandler("change"),k.guardarComensalesExcel(t)},i.readAsBinaryString(r)}},k.subirExcelEmpresas=function(e){var a,r,o=e.target.files;for(r=o[a=0];a!=o.length;++a){var i=new FileReader;r.name;i.onload=function(e){g.start();var a=e.target.result,r=XLSX.read(a,{type:"binary"}),o=r.SheetNames[0],i=2,s=r.Sheets[o],t=[];do{var n={};n.codigo=null!=s["A"+i]&&""!=s["A"+i]?s["A"+i].v.toString():null,n.empresaCliente=null!=s["B"+i]&&""!=s["B"+i]?s["B"+i].v.toString():null,n.nombre=null!=s["C"+i]&&""!=s["C"+i]?s["C"+i].v.toString():null,t.push(n),i++,0}while(null!=s["A"+i]);g.stop(),angular.element($("fileUpload-Empresas").val(null)).triggerHandler("change"),k.guardarEmpresasExcel(t)},i.readAsBinaryString(r)}},k.subirExcelGerencias=function(e){var a,r,o=e.target.files;for(r=o[a=0];a!=o.length;++a){var i=new FileReader;r.name;i.onload=function(e){g.start();var a=e.target.result,r=XLSX.read(a,{type:"binary"}),o=r.SheetNames[0],i=2,s=r.Sheets[o],t=[];do{var n={};n.codigo=null!=s["A"+i]&&""!=s["A"+i]?s["A"+i].v.toString():null,n.empresaCliente=null!=s["B"+i]&&""!=s["B"+i]?s["B"+i].v.toString():null,n.nombre=null!=s["C"+i]&&""!=s["C"+i]?s["C"+i].v.toString():null,n.lectora=null!=s["D"+i]&&""!=s["D"+i]?s["D"+i].v.toString():null,t.push(n),i++,0}while(null!=s["A"+i]);g.stop(),angular.element($("fileUpload-Gerencias").val(null)).triggerHandler("change"),k.guardarGerenciasExcel(t)},i.readAsBinaryString(r)}},k.subirExcelComidas=function(e){var a,r,o=e.target.files;for(r=o[a=0];a!=o.length;++a){var i=new FileReader;r.name;i.onload=function(e){g.start();var a=e.target.result,r=XLSX.read(a,{type:"binary"}),o=r.SheetNames[0],i=2,s=r.Sheets[o],t=[];do{var n={};n.codigo=null!=s["A"+i]&&""!=s["A"+i]?s["A"+i].v.toString():null,n.nombre=null!=s["B"+i]&&""!=s["B"+i]?s["B"+i].v.toString():null,n.inicio=null!=s["C"+i]&&""!=s["C"+i]?s["C"+i].w.toString():null,n.final=null!=s["D"+i]&&""!=s["D"+i]?s["D"+i].w.toString():null,n.empresaCliente=null!=s["E"+i]&&""!=s["E"+i]?s["E"+i].v.toString():null,t.push(n),i++,0}while(null!=s["A"+i]);g.stop(),angular.element($("fileUpload-Comidas").val("")).triggerHandler("change"),k.guardarComidasExcel(t)},i.readAsBinaryString(r)}},k.subirExcelPrecios=function(e){var a,r,o=e.target.files;for(r=o[a=0];a!=o.length;++a){var i=new FileReader;r.name;i.onload=function(e){g.start();var a=e.target.result,r=XLSX.read(a,{type:"binary"}),o=r.SheetNames[0],i=2,s=r.Sheets[o],t=[];do{var n={};n.codigo=null!=s["A"+i]&&""!=s["A"+i]?s["A"+i].v.toString():null,n.nombre=null!=s["B"+i]&&""!=s["B"+i]?s["B"+i].v.toString():null,n.empresaCliente=null!=s["C"+i]&&""!=s["C"+i]?s["C"+i].v.toString():null,n.precio=null!=s["D"+i]&&""!=s["D"+i]?s["D"+i].v.toString():null,t.push(n),i++,0}while(null!=s["A"+i]);g.stop(),angular.element($("fileUpload-Precios").val("")).triggerHandler("change"),k.guardarPreciosExcel(t)},i.readAsBinaryString(r)}},k.extraerFechaExcel=function(e){var a=e.split(" ")[e.split(" ").length-1],r=e.split(" ")[0].split("/").reverse();0<a.indexOf("AM")?a=a.split("A")[0].split(":"):0<a.indexOf("PM")&&(a=a.split("P")[0].split(":"),parseInt(a[0])<12&&(a[0]=parseInt(a[0])+12+""));var o=r[0]+"-"+(2==r[2].length?r[2]:"0"+r[2])+"-"+(2==r[1].length?r[1]:"0"+r[1])+"T"+(2==a[0].length?a[0]:"0"+a[0])+":"+(2==a[1].length?a[1]:"0"+a[1])+":"+(2==a[2].length?a[2]:"0"+a[2])+".000Z";new Date(r[0],r[2]-1,r[1],2==a[0].length?a[0]:"0"+a[0],2==a[1].length?a[1]:"0"+a[1],2==a[2].length?a[2]:"0"+a[2]);return o},k.guardarComensalesExcel=function(e){0<e.length?E(k.usuario.id_empresa,e,k.usuario.id).then(function(e){k.obtenerComensales(),e.hasErr?k.mostrarMensaje(e.mensajes):e.mensajes?k.mostrarMensaje(e.mensaje+e.mensajes):k.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.guardarPreciosExcel=function(e){0<e.length?S(k.usuario.id_empresa,e,k.usuario.id).then(function(e){k.obtenerPrecioComidas(),e.hasErr?k.mostrarMensaje(e.mensajes):e.mensajes?k.mostrarMensaje(e.mensaje+e.mensajes):k.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.guardarHistorialExcel=function(e){var a=[];(0<e.length&&e.forEach(function(i){if(!a.some(function(e){var a=k.extraerFechaExcel(e.fecha_hora),r=k.extraerFechaExcel(i.fecha_hora);e.fecha=k.extraerFechaExcel(e.fecha_hora),e.fecha||console.log(e);var o=(new Date(r)-new Date(a))/1e3;return o<0&&(o*=-1),e.tarjeta===i.tarjeta&&e.nombre===i.nombre&&o<1800})){if(0===a.length)i.fecha=k.extraerFechaExcel(i.fecha_hora);a.push(i)}}),0<a.length)?h(k.usuario.id_empresa,a,k.usuario.id).then(function(e){k.obtenerHistoriales(),e.hasErr?k.mostrarMensaje(e.mensajes):(k.obtenerAliasEmpresa(),e.mensajes?k.mostrarMensaje(e.mensaje+e.mensajes):k.mostrarMensaje(e.mensaje))}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.guardarGerenciasExcel=function(e){0<e.length?M(k.usuario.id_empresa,e,k.usuario.id).then(function(e){k.obtenerGerencias(),e.hasErr?k.mostrarMensaje(e.mensajes):e.mensajes?k.mostrarMensaje(e.mensaje+e.mensajes):k.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.guardarEmpresasExcel=function(e){0<e.length?v(k.usuario.id_empresa,e,k.usuario.id).then(function(e){k.obtenerAliasEmpresa(),e.hasErr?k.mostrarMensaje(e.mensajes):e.mensajes?k.mostrarMensaje(e.mensaje+e.mensajes):k.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.guardarComidasExcel=function(e){0<e.length?x(k.usuario.id_empresa,e,k.usuario.id).then(function(e){k.obtenerComidas(),e.hasErr?k.mostrarMensaje(e.mensajes):e.mensajes?k.mostrarMensaje(e.mensaje+e.mensajes):k.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.guardarAliasClienteEmpresa=function(){var a=[];(0<k.listaAliasclientesEmpresa.length&&k.listaAliasclientesEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&a.push(e)}),0<a.length)?t(k.usuario.id_empresa,a,k.usuario.id).then(function(e){k.mostrarMensaje(e.mensaje),e.hasErr||k.obtenerAliasEmpresa()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.agregarAliasClienteEmpresa=function(a){var r="";if(k.listaAliasclientesEmpresa.some(function(e){return e.codigo?e.codigo===a.codigo?(r+="Código: "+e.codigo+" ya fué asigando. No se puede duplicar.",!0):e.empresaCliente?e.empresaCliente.id===a.empresaCliente.id?(r+="Empresa: "+e.empresaCliente.razon_social+" ya fué asigando. No se puede duplicar.",!0):e.nombre?e.nombre===a.nombre?(r+="Alias: "+e.nombre+" ya fué asigando. No se puede duplicar.",!0):void 0:(r+="Alias: Vacio",!0):(r+="Empresa: Vacio",!0):(r+="Código: Vacio",!0)}))k.mostrarMensaje(r);else{var e=Object.assign({},a);e.nuevo=!0,k.listaAliasclientesEmpresa.push(e)}},k.guardarGerenciasClienteEmpresa=function(e){var a=[];(0<k.listaGerenciasClienteEmpresa.length&&k.listaGerenciasClienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&a.push(e)}),0<a.length)?l(k.usuario.id_empresa,a,k.usuario.id).then(function(e){k.mostrarMensaje(e.mensaje),e.hasErr||k.obtenerGerencias()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.agregarGerenciaClienteEmpresa=function(a){var r="";if(k.listaGerenciasClienteEmpresa.some(function(e){return(e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id&&e.nombre===a.nombre||e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id||e.empresaCliente.id==a.empresaCliente.id&&e.nombre===a.nombre)&&(r+="Código y/o nombre",!0)}))k.mostrarMensaje(r+" ya fué asigando. No se puede duplicar.");else{var e=Object.assign({},a);e.nuevo=!0,k.listaGerenciasClienteEmpresa.push(e)}},k.guardarComensalesClienteEmpresa=function(){var a=[];(0<k.listaComensalesclienteEmpresa.length&&k.listaComensalesclienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&a.push(e)}),0<a.length)?c(k.usuario.id_empresa,a,k.usuario.id).then(function(e){k.mostrarMensaje(e.mensaje),e.hasErr||k.obtenerComensales()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.agregarComensalClienteEmpresa=function(a){var r="";if(k.listaComensalesclienteEmpresa.some(function(e){return e.codigo?e.codigo===a.codigo?(r+="Código: "+e.codigo+" ya fué asigando. No se puede duplicar.",!0):e.empresaCliente?(null!==e.empresaCliente.id&&e.empresaCliente.id,e.nombre?e.nombre===a.nombre&&e.tarjeta===a.tarjeta&&(r+="comensal y tarjeta"+e.nombre+" ya fué asigando. No se puede duplicar.",!0):(r+="comensal: Vacio",!0)):(r+="Empresa: Vacio",!0):(r+="Código: Vacio",!0)}))k.mostrarMensaje(r);else{var e=Object.assign({},a);e.nuevo=!0,k.listaComensalesclienteEmpresa.push(e)}},k.guardarComidasEmpresasCliente=function(){var a=[];(0<k.listaComidasclienteEmpresa.length&&k.listaComidasclienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&(e.inicio=new Date(0,0,0,e.inicio.getHours(),e.inicio.getMinutes(),0).toLocaleTimeString("es-ES"),e.final=new Date(0,0,0,e.final.getHours(),e.final.getMinutes(),0).toLocaleTimeString("es-ES"),a.push(e))}),0<a.length)?p(k.usuario.id_empresa,a,k.usuario.id,0).then(function(e){k.mostrarMensaje(e.mensaje),e.hasErr||k.obtenerComidas()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.agregarComidaClienteEmpresa=function(a){var r="";if(k.listaComidasclienteEmpresa.some(function(e){return(e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id&&e.nombre===a.nombre||e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id||e.empresaCliente.id==a.empresaCliente.id&&e.nombre===a.nombre)&&(r+="Código y/o nombre",!0)}))k.mostrarMensaje(r+" ya fué asigando. No se puede duplicar.");else{var e=Object.assign({},a);e.nuevo=!0,k.listaComidasclienteEmpresa.push(e)}},k.guardarPreciosComidasEmpresasCliente=function(){var a=[];(0<k.listaPrecioComidasclienteEmpresa.length&&k.listaPrecioComidasclienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&a.push(e)}),0<a.length)?f(k.usuario.id_empresa,a,k.usuario.id,0).then(function(e){k.mostrarMensaje(e.mensaje),e.hasErr||k.obtenerPrecioComidas()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):k.mostrarMensaje("Sin cambios.")},k.agregarPrecioComida=function(a){var r="";if(k.listaPrecioComidasclienteEmpresa.some(function(e){return(e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id&&e.comida.id===a.comida.id||e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id)&&(r+="Código y/o nombre",!0)}))k.mostrarMensaje(r+" ya fué asigando. No se puede duplicar.");else{var e=Object.assign({},a);e.nuevo=!0,e.id_comida=e.comida.id,k.listaPrecioComidasclienteEmpresa.push(e)}},k.agregarMarcacion=function(a,e){1===e?a.habilitado=!0:2===e&&(a.habilitado=!1),O(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id,a).then(function(e){k.mostrarMensaje(e.mensaje),e.hasErr||(a.id=e.marcacion.id,a.fecha=e.marcacion.fecha.split("T")[0].split("-").reverse().join("/"))}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.eliminarAsignacionaliasClienteEmpresa=function(e){k.listaAliasclientesEmpresa[k.listaAliasclientesEmpresa.indexOf(e)].eliminado=!0},k.eliminarAsignaciongerenciaClienteEmpresa=function(e){k.listaGerenciasClienteEmpresa[k.listaGerenciasClienteEmpresa.indexOf(e)].eliminado=!0},k.eliminarAsignacioncomensalClienteEmpresa=function(e){k.listaComensalesclienteEmpresa[k.listaComensalesclienteEmpresa.indexOf(e)].eliminado=!0},k.eliminarAsignacioncomidaClienteEmpresa=function(e){k.listaComidasclienteEmpresa[k.listaComidasclienteEmpresa.indexOf(e)].eliminado=!0},k.eliminarAsignacionprecioComidaClienteEmpresa=function(e){k.listaPrecioComidasclienteEmpresa[k.listaPrecioComidasclienteEmpresa.indexOf(e)].eliminado=!0},k.generarHistorialExcel=function(e){L(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id,e).then(function(e){if(e.hasErr)k.mostrarMensaje(e.mensaje);else{for(var a=[["TARJETA","EMPLEADO","FECHA / HORA","lectora","NAME"]],r=0;r<e.documento.length;r++){var o=[];o.push(e.documento[r].tarjeta),o.push(e.documento[r].comensal.nombre),o.push(e.documento[r].fecha.split("T")[0].split("-").reverse().join("/")+" "+e.documento[r].fecha.split("T")[1].split(".")[0]),o.push(e.documento[r].identificador_equipo),o.push(e.documento[r].empresaCliente.alias[0].nombre),a.push(o)}var i="SheetJS",s=new Workbook,t=sheet_from_array_of_arrays(a);t["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],t["!rows"]=[{hpx:28,level:3}],s.SheetNames.push(i),s.Sheets[i]=t;var n=XLSX.write(s,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),e.documento[0].documento)}})},k.generarReportePDF=function(){k.filtroComensales.generar?1===k.filtroComensales.generar?k.reportePDFComedor():2===k.filtroComensales.generar?k.reportePDFEmpresa():3===k.filtroComensales.generar?k.reportePDFComensal():k.mostrarMensaje("Existe un problema con la identificación del reporte."):k.mostrarMensaje("Seleccione un tipo de reporte.")},k.generarReporteEXCEL=function(){k.filtroComensales.generar?1===k.filtroComensales.generar?k.reportePDFComedor(!0):2===k.filtroComensales.generar?k.reportePDFEmpresa(!0):3===k.filtroComensales.generar?k.reportePDFComensal(!0):k.mostrarMensaje("Existe un problema con la identificación del reporte."):k.mostrarMensaje("Seleccione un tipo de reporte.")},k.reportePDFComedor=function(d){var p=0;_(new Date).then(function(e){p=e.monedaCambio.dolar,k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0),k.paginator.filter=k.filtroComensales,m(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){k.listaGerenciasClienteEmpresa=e.lista,u(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){var c=e.lista,m=[];0!==c.length?(c.forEach(function(e){m.push(e.nombre.toUpperCase())}),m.unshift("fecha".toUpperCase()),m.push("observación".toUpperCase()),A(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id,k.paginator).then(function(a){if(k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0,!0),a.hasErr)k.mostrarMensaje(a.mensaje);else{for(var e=[],r=0;r<a.reporte.length;r++){var o=[];if(0<a.reporte[r].historial.length)for(var i=0;i<a.reporte[r].historial.length;i++){var s=-1;if(o.some(function(e){return s+=1,e.gerencia.nombre===a.reporte[r].nombre&&e.fecha.split("T")[0]===a.reporte[r].historial[i].fecha.split("T")[0]}))a.reporte[r].historial[i].comida?("desayuno"===a.reporte[r].historial[i].comida.nombre.toLowerCase()&&(o[s].desayuno.cantidad+=1,o[s].desayuno.total+=a.reporte[r].historial[i].precio),"almuerzo"===a.reporte[r].historial[i].comida.nombre.toLowerCase()&&(o[s].almuerzo.cantidad+=1,o[s].almuerzo.total+=a.reporte[r].historial[i].precio),"cena"===a.reporte[r].historial[i].comida.nombre.toLowerCase()&&(o[s].cena.cantidad+=1,o[s].cena.total+=a.reporte[r].historial[i].precio)):o[s].fuera_horario+=1;else{var t={cantidad:0,total:0},n={empresaCliente:a.reporte[r].historial[i].empresaCliente,gerencia:{id:a.reporte[r].id,nombre:a.reporte[r].nombre,codigo:a.reporte[r].codigo,id_cliente:a.reporte[r].id_cliente,id_empresa:a.reporte[r].id_empresa},fecha:a.reporte[r].historial[i].fecha.split("T")[0],desayuno:Object.assign({},t),almuerzo:Object.assign({},t),cena:Object.assign({},t),fuera_horario:0};a.reporte[r].historial[i].comida?("desayuno"===a.reporte[r].historial[i].comida.nombre.toLowerCase()&&(n.desayuno.cantidad+=1,n.desayuno.total+=a.reporte[r].historial[i].precio),"almuerzo"===a.reporte[r].historial[i].comida.nombre.toLowerCase()&&(n.almuerzo.cantidad+=1,n.almuerzo.total+=a.reporte[r].historial[i].precio),"cena"===a.reporte[r].historial[i].comida.nombre.toLowerCase()&&(n.cena.cantidad+=1,n.cena.total+=a.reporte[r].historial[i].precio)):n.observacion="Fuera de horario, no se puede contabilizar.",o.push(n)}i===a.reporte[r].historial.length-1&&e.push(o)}}if(d)for(i=0;i<e.length;i++){var l=e[i];k.imprimirReporteComedorExcel(l,l[0].gerencia,m,c,p)}else for(i=0;i<e.length;i++)k.imprimirReporteComedor(e[i],e[i][0].gerencia,m,c,p);g.stop()}})):k.mostrarMensaje("El listado de comidas para esta empresa esta vacio, no se puede generar el reporte")})})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.reportePDFEmpresa=function(o){var i=0;_(new Date).then(function(e){i=e.monedaCambio.dolar,k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0),k.paginator.filter=k.filtroComensales,m(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){k.listaGerenciasClienteEmpresa=e.lista,u(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){var a=e.lista,r=[];a.forEach(function(e){r.push(e.nombre.toUpperCase())}),r.unshift("Empleado".toUpperCase()),r.push("Total general".toUpperCase()),P(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id,k.paginator).then(function(e){if(k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0,!0),e.hasErr)k.mostrarMensaje(e.mensaje);else{e.reporte.forEach(function(a){a.desayuno={cantidad:0,total:0},a.almuerzo={cantidad:0,total:0},a.cena={cantidad:0,total:0},a.fueraHorario=0,a.historial.forEach(function(e){e.comida?("desayuno"===e.comida.nombre.toLowerCase()&&(a.desayuno.cantidad+=1),"almuerzo"===e.comida.nombre.toLowerCase()&&(a.almuerzo.cantidad+=1),"cena"===e.comida.nombre.toLowerCase()&&(a.cena.cantidad+=1)):a.fueraHorario+=1})}),o?k.imprimirReporteEmpresaEXCEL(e.reporte,null,r,a,i):k.imprimirReporteEmpresa(e.reporte,null,r,a,i),g.stop()}})})})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.reportePDFAlertasMarcaciones=function(l,e){e?u(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){var a=e.lista,r=[];if(a.forEach(function(e){r.push(e.nombre.toUpperCase())}),r.unshift("empleado".toUpperCase()),r.unshift("empresa".toUpperCase()),r.push("Total general".toUpperCase()),0<k.alertaMarcaciones.length){k.alertaMarcaciones.reverse();for(var o=[],i=[];0<k.alertaMarcaciones.length;){var s=-1,t=k.alertaMarcaciones.pop();if(i.some(function(e){return s+=1,e.fecha===t.fecha}))i[s].alertas.push(t),o.push(t);else{o.push(t);var n={fecha:t.fecha,alertas:[t]};i.push(n)}1}k.alertaMarcaciones=o,l?k.imprimirAlertaMarcacionesMatriz(i,null,r,a):k.imprimirAlertaMarcaciones(i,null,r,a)}}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.stack&&null!==e.stack?e.stack:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()}):0<k.alertaMarcaciones.length&&(l?k.imprimirAlertaMarcacionesMatriz(k.alertaMarcaciones):k.imprimirAlertaMarcacionesLista(k.alertaMarcaciones))},k.reportePDFComensal=function(l){var c=0;_(new Date).then(function(e){c=e.monedaCambio.dolar,k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0),k.paginator.filter=k.filtroComensales,m(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){k.listaGerenciasClienteEmpresa=e.lista,u(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id).then(function(e){var t=e.lista,n=[];t.forEach(function(e){n.push(e.nombre.toUpperCase())}),n.unshift("FECHA".toUpperCase()),n.push("Total general".toUpperCase()),y(k.usuario.id_empresa,k.usuario.id,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.id?k.filtroComensales.empresaCliente.id:k.empresaExternaSeleccionada.id,k.paginator).then(function(a){if(k.filtroComensales=k.filtrarHistorial(k.filtroComensales,!0,!0),a.hasErr)k.mostrarMensaje(a.mensaje);else{for(var r=0;r<a.reporte.length;r++){for(var e=[],o=0;o<a.reporte[r].historial.length;o++){var i=-1;if(e.some(function(e){return i+=1,e.fecha.split("T")[0]===a.reporte[r].historial[o].fecha.split("T")[0]}))a.reporte[r].historial[o].comida?("desayuno"===a.reporte[r].historial[o].comida.nombre.toLowerCase()&&(e[i].desayuno+=1),"almuerzo"===a.reporte[r].historial[o].comida.nombre.toLowerCase()&&(e[i].almuerzo+=1),"cena"===a.reporte[r].historial[o].comida.nombre.toLowerCase()&&(e[i].cena+=1)):e[i].fueraHorario+=1;else{var s={fecha:a.reporte[r].historial[o].fecha,desayuno:0,almuerzo:0,cena:0,fueraHorario:0,empresaCliente:a.reporte[r].historial[o].empresaCliente};a.reporte[r].historial[o].comida?("desayuno"===a.reporte[r].historial[o].comida.nombre.toLowerCase()&&(s.desayuno+=1),"almuerzo"===a.reporte[r].historial[o].comida.nombre.toLowerCase()&&(s.almuerzo+=1),"cena"===a.reporte[r].historial[o].comida.nombre.toLowerCase()&&(s.cena+=1)):s.observacion="Fuera de horario, no se puede contabilizar.",e.push(s)}}a.reporte[r].reporte=e}for(o=0;o<a.reporte.length;o++)l?k.imprimirReporteComensalEXCEL(a.reporte[o],null,n,t,c):k.imprimirReporteComensal(a.reporte[o],null,n,t,c);g.stop()}})})})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";k.mostrarMensaje(a),g.stop()})},k.imprimirAlertaMarcacionesLista=function(e){var a=new PDFDocument({size:"letter",margin:10,compress:!1}),r=a.pipe(blobStream()),o=135,i=0,s=1,t=e[0].fecha+" al "+e[e.length-1].fecha,n=Math.ceil(e.length/10);k.cabeceraReporteAlertasMarcacionesLista(a,k.usuario.empresa.razon_social,t,s,n);for(var l=0;l<e.length;l++)a.text(l+1,70,o+5),a.text(e[l].comensal.nombre,120,o+5),a.text(e[l].fecha,320,o+5),a.text(e[l].comida.nombre,400,o+5),a.text(!0===e[l].habilitado?"Marcado":!1===e[l].habilitado?"Descartado":"Pendiente",500,o+5),a.rect(60,o,500,20).stroke(),o+=20,(10<i||700<o)&&(a.addPage({size:[612,792],margin:10}),o=195,i=0,s+=1,k.cabeceraReporteAlertasMarcacionesMatriz(a,k.usuario.empresa.razon_social,t,s,n));o+=20,a.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},k.imprimirAlertaMarcacionesMatriz=function(e,a,r,o){if(0<e.length){var i=new PDFDocument({size:"letter",margin:10,compress:!1}),s=i.pipe(blobStream()),t=150,n=0,l=1,c=Math.ceil(.1);k.Marcaciones.length,k.cabeceraReporteAlertasMarcacionesMatriz(i,l,c,r,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.razon_social?k.filtroComensales.empresaCliente.razon_social:k.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var m=0;m<e.length;m++)for(var d=0;d<e[m].alertas.length;d++)i.font("Helvetica",8),i.font("Helvetica",6).fill("black"),i.text(e[m].alertas[d].comida.empresaCliente.razon_social,50,t+7),i.text(e[m].alertas[d].comensal.nombre,90,t+7),"desayuno"===e[m].alertas[d].comida.nombre.toLowerCase()&&(i.font("Helvetica",8).fill("red"),i.text(e[m].alertas[d].comida.nombre,239,t+7).fill("black"),i.rect(380,t+3,80,20).stroke("red")),"almuerzo"===e[m].alertas[d].comida.nombre.toLowerCase()&&(i.font("Helvetica",8).fill("black"),i.text("Falta2",334,t+7).fill("black"),i.rect(300,t+3,80,20).stroke("black")),"cena"===e[m].alertas[d].comida.nombre.toLowerCase()&&(i.font("Helvetica",8).fill("black"),i.text("Falta3",414,t+7).fill("black")),i.text(e[m].alertas[d].comida.nombre,419,t+7),i.rect(50,t+3,170,20).stroke(),i.rect(220,t+3,80,20).stroke(),i.rect(300,t+3,80,20).stroke(),i.rect(380,t+3,80,20).stroke(),i.rect(460,t+3,110,20).stroke(),i.rect(50,t+3,80,20).stroke(),i.rect(130,t+3,90,20).stroke(),t+=20,(10<++n||700<t)&&(i.addPage({size:[612,792],margin:10}),t=195,n=0,l+=1,k.cabeceraReporteAlertasMarcacionesMatriz(i,l,c,r,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.razon_social?k.filtroComensales.empresaCliente.razon_social:k.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase()));i.text("Total general",56,t+7),i.rect(50,t+3,170,20).stroke(),i.rect(220,t+3,80,20).stroke(),i.rect(300,t+3,80,20).stroke(),i.rect(380,t+3,80,20).stroke(),i.rect(460,t+3,110,20).stroke(),t+=20,i.end(),s.on("finish",function(){var e=s.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})}else k.mostrarMensaje("No hay datos.")},k.imprimirReporteComedorExcel=function(e,a,r,o,i){e=e,r=r,i=i;for(var s=[[""],[""],["REPORTES DE COMEDOR "+(a=a).nombre.toUpperCase()+" "+e[0].empresaCliente.razon_social.toUpperCase()],[""],r],t=0,n=0,l=0,c=0;c<e.length;c++){(m=[]).push(e[c].fecha),0<e[c].desayuno.cantidad?(m.push(e[c].desayuno.cantidad),t+=e[c].desayuno.cantidad):m.push(""),0<e[c].almuerzo.cantidad?(m.push(e[c].almuerzo.cantidad),n+=e[c].almuerzo.cantidad):m.push(""),0<e[c].cena.cantidad?(m.push(e[c].cena.cantidad),l+=e[c].cena.cantidad):m.push(""),e[c].observacion&&m.push(e[c].observacion),s.push(m)}s.push([""]);var m=["TOTAL ==>",t,n,l];s.push(m),m=["TOTAL $us. ==>",t*i,n*i,l*i],s.push(m),m=["TOTAL General $us. ==>","",t*i+n*i+l*i],s.push(m);var d="SheetJS",p=new Workbook,u=sheet_from_array_of_arrays(s);u["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],u["!rows"]=[{hpx:28,level:3}],u["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+s.length,c:0},e:{r:3+s.length,c:1}}],p.SheetNames.push(d),p.Sheets[d]=u;var f=XLSX.write(p,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(f)],{type:"application/octet-stream"}),"REPORTE GERENCIA "+a.nombre.toUpperCase()+".xlsx"),g.stop()},k.imprimirReporteEmpresaEXCEL=function(e,a,r,o,i){r=r;for(var s=[["Reporte EMPRESA VS PERIODO"],["EMPRESA",(e=e)[0].historial[0].empresaCliente.razon_social],["GERENCIA",""],["PERIODO",e.fecha],r],t=0,n=0,l=0,c=0;c<e.length;c++){var m;t+=e[c].desayuno.cantidad,n+=e[c].almuerzo.cantidad,l+=e[c].cena.cantidad,m=e[c].desayuno.cantidad+e[c].almuerzo.cantidad+e[c].cena.cantidad,e[c].desayuno.cantidad,e[c].almuerzo.cantidad,e[c].cena.cantidad,(d=[]).push(e[c].nombre),d.push(e[c].desayuno.cantidad),d.push(e[c].almuerzo.cantidad),d.push(e[c].cena.cantidad),m,d.push(m),s.push(d)}var d=["TOTAL General",t,n,l,t+n+l];s.push(d);var p="SheetJS",u=new Workbook,f=sheet_from_array_of_arrays(s);f["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],f["!rows"]=[{hpx:28,level:3}],f["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+s.length,c:0},e:{r:3+s.length,c:1}}],u.SheetNames.push(p),u.Sheets[p]=f;var C=XLSX.write(u,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(C)],{type:"application/octet-stream"}),"REPORTE EMPRESA "+e[0].historial[0].empresaCliente.razon_social.toUpperCase()+".xlsx"),g.stop()},k.imprimirReporteComensalEXCEL=function(e,a,r,o,i){r=r;for(var s=[["REPORTE POR PERSONA"],["EMPLEADO",(e=e).nombre],["EMPRESA",e.reporte[0].empresaCliente.razon_social],["GERENCIA",""],["PERIODO",e.fecha],r],t=0,n=0,l=0,c=0;c<e.reporte.length;c++){var m;t+=e.reporte[c].desayuno,n+=e.reporte[c].almuerzo,l+=e.reporte[c].cena,m=e.reporte[c].desayuno+e.reporte[c].almuerzo+e.reporte[c].cena,e.reporte[c].desayuno,e.reporte[c].almuerzo,e.reporte[c].cena,(d=[]).push(e.reporte[c].fecha.split("T")[0]),d.push(e.reporte[c].desayuno),d.push(e.reporte[c].almuerzo),d.push(e.reporte[c].cena),d.push(m),s.push(d)}var d=["TOTAL General",t,n,l,t+n+l];s.push(d);var p="SheetJS",u=new Workbook,f=sheet_from_array_of_arrays(s);f["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],f["!rows"]=[{hpx:28,level:3}],f["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+s.length,c:0},e:{r:3+s.length,c:1}}],u.SheetNames.push(p),u.Sheets[p]=f;var C=XLSX.write(u,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(C)],{type:"application/octet-stream"}),"REPORTE COMENSAL "+e.nombre.toUpperCase()+".xlsx"),g.stop()},k.imprimirReporteComedor=function(e,a,r,o,i){var s=new PDFDocument({size:"letter",margin:10,compress:!1}),t=s.pipe(blobStream()),n=170,l=0,c=0,m=1,d=100,p=Math.ceil(.1);k.cabeceraReporteComedor(s,m,p,r,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.razon_social?k.filtroComensales.empresaCliente.razon_social:k.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var u=0,f=0,C=0,g=0;g<e.length;g++)r.forEach(function(e){s.rect(d+c,n,80,20).stroke(),c+=80}),c=0,s.font("Helvetica",8),0<e[g].desayuno.cantidad&&(s.text(e[g].fecha,109,n+7),s.text(e[g].desayuno.cantidad,204,n+7),u+=e[g].desayuno.cantidad),0<e[g].almuerzo.cantidad&&(s.text(e[g].fecha,109,n+7),s.text(e[g].almuerzo.cantidad,284,n+7),f+=e[g].almuerzo.cantidad),0<e[g].cena.cantidad&&(s.text(e[g].fecha,109,n+7),s.text(e[g].cena.cantidad,364,n+7),C+=e[g].cena.cantidad),e[g].observacion&&(s.text(e[g].fecha,109,n+7),s.text(e[g].observacion,421,n+3,{width:80})),n+=20,(10<++l||700<n)&&(s.addPage({size:[612,792],margin:10}),n=195,l=0,m+=1,k.cabeceraReporteComedor(s,m,p,r,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.razon_social?k.filtroComensales.empresaCliente.razon_social:k.empresaExternaSeleccionada.razon_social,e[g].gerencia?e[g].gerencia.nombre.toUpperCase():"Sin asignación.".toUpperCase()));s.rect(d,n,80,20).stroke(),s.rect(180,n,80,20).stroke(),s.rect(260,n,80,20).stroke(),s.rect(340,n,80,20).stroke(),s.rect(420,n,80,20).stroke(),n+=20;var h=u*("desayuno"===o[0].nombre.toLowerCase()?o[0].precio[0].precio:"desayuno"===o[1].nombre.toLowerCase()?o[1].precio[0].precio:"desayuno"===o[2].nombre.toLowerCase()?o[2].precio[0].precio:"ERROR"),E=f*("almuerzo"===o[0].nombre.toLowerCase()?o[0].precio[0].precio:"almuerzo"===o[1].nombre.toLowerCase()?o[1].precio[0].precio:"almuerzo"===o[2].nombre.toLowerCase()?o[2].precio[0].precio:"ERROR"),b=C*("cena"===o[0].nombre.toLowerCase()?o[0].precio[0].precio:"cena"===o[1].nombre.toLowerCase()?o[1].precio[0].precio:"cena"===o[2].nombre.toLowerCase()?o[2].precio[0].precio:"ERROR");s.text("Total.-",124,n+7),s.text("Total $us.-",124,n+7+20),s.text("Total General $us.-",124,n+7+40),s.rect(180,n,80,20).stroke(),s.text(u,204,n+7),s.rect(260,n,80,20).stroke(),s.text(f,284,n+7),s.rect(340,n,80,20).stroke(),s.text(C,364,n+7),s.rect(180,n+20,80,20).stroke(),s.rect(260,n+20,80,20).stroke(),s.rect(340,n+20,80,20).stroke(),s.rect(260,n+40,80,20).stroke(),s.text(h,204,n+7+20),s.text(E,284,n+7+20),s.text(b,364,n+7+20),s.text(h+E+b,284,n+7+40),s.rect(d,n+70,80,20).fill("yellow"),s.rect(d,n+90,80,20).fill("yellow"),s.rect(d,n+110,80,20).fill("yellow"),s.rect(180,n+70,80,20).fill("yellow"),s.rect(180,n+90,80,20).fill("yellow"),s.rect(180,n+110,80,20).fill("yellow"),s.rect(340,n+90,160,20).fill("yellow"),s.rect(d,n+70,80,20).stroke(),s.rect(d,n+90,80,20).stroke(),s.rect(d,n+110,80,20).stroke(),s.rect(180,n+70,80,20).stroke(),s.rect(180,n+90,80,20).stroke(),s.rect(180,n+110,80,20).stroke().fill("black"),s.text("Desayuno.-",124,n+7+70),s.text("almuerzo.-",124,n+7+90),s.text("Cena.-",124,n+7+110),s.rect(340,n+90,160,20).stroke(),s.text("T.C. "+i+"       Bs "+((h+E+b)*i).toFixed(2),364,n+7+90),s.text("desayuno"===o[0].nombre.toLowerCase()?o[0].precio[0].precio:"desayuno"===o[1].nombre.toLowerCase()?o[1].precio[0].precio:"desayuno"===o[2].nombre.toLowerCase()?o[2].precio[0].precio:"ERROR",204,n+7+70),s.text("almuerzo"===o[0].nombre.toLowerCase()?o[0].precio[0].precio:"almuerzo"===o[1].nombre.toLowerCase()?o[1].precio[0].precio:"almuerzo"===o[2].nombre.toLowerCase()?o[2].precio[0].precio:"ERROR",204,n+7+90),s.text("cena"===o[0].nombre.toLowerCase()?o[0].precio[0].precio:"cena"===o[1].nombre.toLowerCase()?o[1].precio[0].precio:"cena"===o[2].nombre.toLowerCase()?o[2].precio[0].precio:"ERROR",204,n+7+110);var v=ConvertirALiteral((h+E+b).toFixed(2));v=v.split("BOLIVIANOS")[0],s.text("Son: "+v+" Dólares Americanos",124,n+7+130),s.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},k.imprimirReporteEmpresa=function(e,a,r,o,i){var s=new PDFDocument({size:"letter",margin:10,compress:!1}),t=s.pipe(blobStream()),n=150,l=0,c=1,m=Math.ceil(.1);k.cabeceraReporteEmpresa(s,c,m,r,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.razon_social?k.filtroComensales.empresaCliente.razon_social:k.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var d=0,p=0,u=0,f=0,C=0;C<e.length;C++){var g;s.font("Helvetica",8),d+=e[C].desayuno.cantidad,p+=e[C].almuerzo.cantidad,u+=e[C].cena.cantidad,g=e[C].desayuno.cantidad+e[C].almuerzo.cantidad+e[C].cena.cantidad,e[C].desayuno.cantidad,e[C].almuerzo.cantidad,e[C].cena.cantidad,0,s.font("Helvetica",8).fill("black"),s.text(e[C].nombre,73,n+7),s.text(e[C].desayuno.cantidad,254,n+7),s.text(e[C].almuerzo.cantidad,334,n+7),s.text(e[C].cena.cantidad,414,n+7),s.text(g,494,n+7),f+=e[C].fueraHorario,s.rect(70,n+3,150,20).stroke(),s.rect(220,n+3,80,20).stroke(),s.rect(300,n+3,80,20).stroke(),s.rect(380,n+3,80,20).stroke(),s.rect(460,n+3,110,20).stroke(),n+=20,(10<++l||700<n)&&(s.addPage({size:[612,792],margin:10}),n=195,l=0,c+=1,k.cabeceraReporteEmpresa(s,c,m,r,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.razon_social?k.filtroComensales.empresaCliente.razon_social:k.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase()))}s.text("Total general",76,n+7),s.text(d,254,n+7),s.text(p,334,n+7),s.text(u,414,n+7),s.text(d+p+u,494,n+7),s.rect(70,n+3,150,20).stroke(),s.rect(220,n+3,80,20).stroke(),s.rect(300,n+3,80,20).stroke(),s.rect(380,n+3,80,20).stroke(),s.rect(460,n+3,110,20).stroke(),0<f&&(s.text("No contabilizados (fuera de horario):",470,n+7+20),s.text("Cant.: "+f,497,n+7+40)),n+=20,s.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},k.formatoFechaPDF=function(e){var a=new Date(e);return a.setDate(a.getDate()),("0"+a.getDate()).slice(-2)+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+a.getFullYear()},k.imprimirReporteComensal=function(e,a,r,o,i){var s=new PDFDocument({size:"letter",margin:10,compress:!1}),t=s.pipe(blobStream()),n=150,l=0,c=1,m=Math.ceil(.1);k.cabeceraReporteComensal(s,c,m,e,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.razon_social?k.filtroComensales.empresaCliente.razon_social:k.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var d=0,p=0,u=0,f=0;f<e.reporte.length;f++){0<e.reporte[f].cena&&(s.font("Helvetica",8).fill("black"),s.text(e.reporte[f].cena,254,n+7).fill("black"),s.rect(380,n+3,80,20).stroke("black")),0<e.reporte[f].almuerzo&&(s.font("Helvetica",8).fill("black"),s.text(e.reporte[f].almuerzo,334,n+7).fill("black"),s.rect(300,n+3,80,20).stroke("black")),0<e.reporte[f].desayuno&&(s.font("Helvetica",8).fill("black"),s.text(e.reporte[f].desayuno,414,n+7).fill("black"),s.rect(220,n+3,80,20).stroke("black"));var C;s.font("Helvetica",8).fill("black"),d+=e.reporte[f].desayuno,p+=e.reporte[f].almuerzo,u+=e.reporte[f].cena,C=e.reporte[f].desayuno+e.reporte[f].almuerzo+e.reporte[f].cena,e.reporte[f].desayuno,e.reporte[f].almuerzo,e.reporte[f].cena,0,s.font("Helvetica",8).fill("black"),s.rect(70,n+3,150,20).stroke("black"),s.rect(460,n+3,110,20).stroke("black"),s.text(k.formatoFechaPDF(e.reporte[f].fecha),78,n+7).fill("black"),s.text(C,494,n+7).fill("black"),0===e.reporte[f].cena&&(s.font("Helvetica",8).fill("red"),s.text("Falta",254,n+7).fill("red"),s.rect(380,n+3,80,20).stroke("red")),0===e.reporte[f].almuerzo&&(s.font("Helvetica",8).fill("red"),s.text("Falta",334,n+7).fill("red"),s.rect(300,n+3,80,20).stroke("red")),0===e.reporte[f].desayuno&&(s.font("Helvetica",8).fill("red"),s.text("Falta",414,n+7).fill("red"),s.rect(220,n+3,80,20).stroke("red")),n+=20,(10<++l||700<n)&&(s.addPage({size:[612,792],margin:10}),n=195,l=0,c+=1,k.cabeceraReporteComensal(s,c,m,e,k.filtroComensales.empresaCliente&&k.filtroComensales.empresaCliente.razon_social?k.filtroComensales.empresaCliente.razon_social:k.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase()))}s.font("Helvetica",8).fill("black"),s.text("Total general".toLocaleUpperCase(),76,n+7).fill("black"),s.text(d,254,n+7).fill("black"),s.text(p,334,n+7).fill("black"),s.text(u,414,n+7).fill("black"),s.text(d+p+u,494,n+7).fill("black"),s.rect(70,n+3,150,20).stroke("black"),s.rect(220,n+3,80,20).stroke("black"),s.rect(300,n+3,80,20).stroke("black"),s.rect(380,n+3,80,20).stroke("black"),s.rect(460,n+3,110,20).stroke("black"),n+=20,s.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},k.cabeceraReporteComedor=function(a,e,r,o,i,s){var t=0;(new Date).getDate(),(new Date).getMonth(),(new Date).getFullYear();a.font("Helvetica-Bold",12).fill("black"),a.text("REPORTES DE COMEDOR "+s.toUpperCase()+" "+i.toUpperCase(),150,80,{width:300,align:"center"}),a.font("Helvetica-Bold",8),o.forEach(function(e){a.rect(100+t,150,80,20).stroke(),a.text(e,100+t+9,157),t+=80}),a.rect(230,610,130,0).stroke(),a.text("Encargado",272,640),a.font("Helvetica",8),k.imagenEmpresa&&a.image(k.imagenEmpresa,40,30,{fit:[100,100]})},k.cabeceraReporteAlertasMarcacionesLista=function(e,a,r,o,i){e.font("Helvetica",6).fill("black"),e.text("Pag. "+o+" de "+i,560,40),e.font("Helvetica-Bold",12).fill("black"),e.text(a.toLocaleUpperCase(),260,60),e.font("Helvetica-Bold",8),e.text("Cochambamba - Bolivia",255,80),e.font("Helvetica-Bold",8),e.text("Del "+r,255,100),e.text("Nro.",70,120),e.text("comensal",120,120),e.text("fecha",320,120),e.text("Comida",400,120),e.text("Estado",500,120),e.rect(60,115,500,20).stroke(),k.imagenEmpresa&&e.image(k.imagenEmpresa,40,30,{fit:[100,100]})},k.cabeceraReporteAlertasMarcacionesMatriz=function(e,a,r,o,a,i){e.font("Helvetica-Bold",12).fill("black"),e.font("Helvetica-Bold",8),e.text("Alerta no Marcaciones".toLocaleUpperCase(),260,80),e.text("Fecha",60,120),e.text("Empresa",60,140),e.text("Empleado",134,140),e.text("DESAYUNO",240,140),e.text("ALMUERZO",320,140),e.text("CENA",400,140),e.text("TOTAL GENERAL",480,140),e.rect(50,113,170,20).stroke(),e.rect(220,113,350,20).stroke(),e.rect(50,133,80,20).stroke(),e.rect(130,133,90,20).stroke(),e.rect(220,133,80,20).stroke(),e.rect(300,133,80,20).stroke(),e.rect(380,133,80,20).stroke(),e.rect(460,133,110,20).stroke(),e.font("Helvetica",8),k.imagenEmpresa&&e.image(k.imagenEmpresa,40,30,{fit:[100,100]})},k.cabeceraReporteEmpresa=function(e,a,r,o,i,s){e.font("Helvetica-Bold",12).fill("black"),e.font("Helvetica-Bold",8),e.text("Empresa",124,80),e.text(i,300,80),e.text("Gerencia",124,100),e.text("Periodo",124,120),e.text("Empleado",124,140),e.text("DESAYUNO",240,140),e.text("ALMUERZO",320,140),e.text("CENA",400,140),e.text("TOTAL GENERAL",480,140),e.rect(70,73,150,20).stroke(),e.rect(70,93,150,20).stroke(),e.rect(70,113,150,20).stroke(),e.rect(70,133,150,20).stroke(),e.rect(220,73,350,20).stroke(),e.rect(220,93,350,20).stroke(),e.rect(220,113,350,20).stroke(),e.rect(220,133,80,20).stroke(),e.rect(300,133,80,20).stroke(),e.rect(380,133,80,20).stroke(),e.rect(460,133,110,20).stroke(),e.font("Helvetica",8),k.imagenEmpresa&&e.image(k.imagenEmpresa,40,30,{fit:[100,100]})},k.cabeceraReporteComensal=function(e,a,r,o,i,s){e.font("Helvetica-Bold",12).fill("black"),e.font("Helvetica-Bold",8),e.text("Empleado",124,80),e.text(o.nombre,300,80),e.text(i,300,100),e.text("Empresa",124,100),e.text("Periodo",124,120),e.text("Empleado",124,140),e.text("DESAYUNO",240,140),e.text("ALMUERZO",320,140),e.text("CENA",410,140),e.text("TOTAL GENERAL",490,140),e.rect(70,73,150,20).stroke(),e.rect(70,93,150,20).stroke(),e.rect(70,113,150,20).stroke(),e.rect(70,133,150,20).stroke(),e.rect(220,73,350,20).stroke(),e.rect(220,93,350,20).stroke(),e.rect(220,113,350,20).stroke(),e.rect(220,133,80,20).stroke(),e.rect(300,133,80,20).stroke(),e.rect(380,133,80,20).stroke(),e.rect(460,133,110,20).stroke(),e.font("Helvetica",8),k.imagenEmpresa&&e.image(k.imagenEmpresa,40,30,{fit:[100,100]})},k.abrirModalEdicionAlias=function(){k.clienteEmpresaAsignacionAlias={},k.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},k.empresaExternaSeleccionada),k.clienteEmpresaEdicionGerencias,k.obtenerAliasEmpresa(),k.activeModal=1,k.abrirPopup(k.modalEdicionAlias)},k.cerrarModalEdicionAlias=function(){k.activeModal=0,k.clienteEmpresaAsignacionAlias={},k.cerrarPopup(k.modalEdicionAlias)},k.abrirModalEdicionGerencias=function(){k.activeModal=2,k.clienteEmpresaEdicionGerencias={},k.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},k.empresaExternaSeleccionada),k.obtenerGerencias(),k.abrirPopup(k.modalEdicionGerencias)},k.cerrarModalEdicionGerencias=function(){k.activeModal=0,k.clienteEmpresaEdicionGerencias={},k.cerrarPopup(k.modalEdicionGerencias)},k.abrirModalEdicionComensales=function(){k.activeModal=3,k.clienteEmpresaEdicionComensales={},k.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},k.empresaExternaSeleccionada),k.obtenerGerencias(),k.obtenerComensales(),k.abrirPopup(k.modalEdicionComensales)},k.cerrarModalEdicionComensales=function(){k.activeModal=0,k.clienteEmpresaEdicionComensales={},k.cerrarPopup(k.modalEdicionComensales)},k.abrirModalEdicionComidas=function(){k.clienteEmpresaComidas={},k.clienteEmpresaComidas.empresaCliente=Object.assign({},k.empresaExternaSeleccionada),k.clienteEmpresaComidas.verTodos=!1,k.obtenerComidas(),k.activeModal=4,k.abrirPopup(k.modalEdicionComidas)},k.cerrarModalEdicionComidas=function(){k.clienteEmpresaComidas={},k.activeModal=0,k.cerrarPopup(k.modalEdicionComidas)},k.abrirModalEdicionPrecios=function(){k.clienteEmpresaPreciosComidas={},k.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},k.empresaExternaSeleccionada),k.activeModal=5,k.obtenerPrecioComidas(),k.abrirPopup(k.modalEdicionPrecios)},k.cerrarModalEdicionPrecios=function(){k.activeModal=0,k.clienteEmpresaPreciosComidas={},k.cerrarPopup(k.modalEdicionPrecios)},k.buscarCliente=function(e){if(""!=e&&null!=e)return s(k.usuario.id_empresa,e)},k.abrirdialogClientesComensales=function(){k.abrirPopup(k.dialogClienteEmpresa)},k.cerrardialogClientesComensales=function(){k.cerrarPopup(k.dialogClienteEmpresa)},k.abrirdialogBusquedaComensales=function(){k.activeModal=0,k.abrirPopup(k.busquedaComensalesEmpresa)},k.cerrardialogBusquedaComensales=function(){k.activeModal=0,k.cerrarPopup(k.busquedaComensalesEmpresa)},k.abrirdialogAlertaMarcaciones=function(){k.activeModal=0,k.obtenerAlertas(),k.abrirPopup(k.dialogAlertasMarcaciones)},k.cerrardialogAlertaMarcaciones=function(){k.activeModal=0,k.alertaMarcaciones=[],k.cerrarPopup(k.dialogAlertasMarcaciones)},k.abrirdialogHistorialDocumentos=function(){k.activeModal=0,k.obtenerHistorialDocumentos(),k.abrirPopup(k.dialogHistorialDocumentos)},k.cerrardialogHistorialDocumentos=function(){k.activeModal=0,k.historialesDocumentos=[],k.cerrarPopup(k.dialogHistorialDocumentos)},k.inicio()}]);