angular.module("agil.controladores").controller("ControladorRutas",["$scope","$localStorage","$location","$templateCache","$route","blockUI","$timeout","Clases","Clientes","Rutas","Ruta","uiGmapGoogleMapApi","$cordovaGeolocation","ClasesTipo","ClientesEmpresa",function(s,e,t,a,n,u,r,o,i,l,c,p,g,d,m){u.start(),s.usuario=JSON.parse(e.usuario),s.inicio=function(){s.obtenerDias(),s.obtenerClientes(),s.obtenerDepartamentos(),s.obtenerMunicipios(),setTimeout(function(){ejecutarScriptsTabla("tabla-rutas",10)},2e3)},s.obtenerClientes=function(){u.start(),i(s.usuario.id_empresa).then(function(t){s.clientes=t,u.stop()})},s.obtenerRutas=function(){u.start(),l(s.usuario.id_empresa).then(function(t){for(var a=0;a<t.length;a++){t[a].segmentos=JSON.parse(t[a].segmentos);for(var e=0;e<t[a].dias.length;e++)t[a].dias[e]=t[a].dias[e].id_dia;for(var n=0;n<t[a].clientes.length;n++)t[a].clientes[n]=t[a].clientes[n].id_cliente}s.rutas=t,u.stop()})},s.obtenerDepartamentos=function(){u.start(),d("DEP").then(function(t){s.departamentos=t.clases,u.stop()})},s.obtenerMunicipios=function(){u.start(),d("MUN").then(function(t){s.municipios=t.clases,u.stop()})},s.buscarMunicipios=function(t){o(t.nombre_corto+"M").then(function(t){s.municipios=t})},s.obtenerDias=function(){u.start(),d("DIAS").then(function(t){s.dias=t.clases,s.obtenerRutas(),u.stop()})},s.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsRuta("modal-wizard-ruta","modal-wizard-ruta-vista","dialog-eliminar-ruta","modal-wizard-container-ruta-edicion","modal-wizard-container-ruta-vista"),s.buscarAplicacion(s.usuario.aplicacionesUsuario,t.path().substring(1)),u.stop()}),s.abrirPopupRuta=function(a){s.formas=[],s.mostrarMap=!1,s.ruta=a,p.then(function(t){s.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},s.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},s.generarMarcadores(s.ruta),s.dibujarRuta(a)}),s.abrirPopup("modal-wizard-ruta")},s.eliminarLineas=function(){s.polylines=[],s.ruta.segmentos=[];for(var t=0;t<s.formas.length;t++)s.formas[t].setMap(null)},s.dibujarRuta=function(t){if(s.polylines=[],0<t.segmentos.length)for(var a=0;a<t.segmentos.length;a++){for(var e=[],n=0;n<t.segmentos[a].length;n++)e.push({latitude:t.segmentos[a][n].lat,longitude:t.segmentos[a][n].lng});s.polylines.push({id:a+1,path:e,stroke:{color:"#69AA46",weight:3},editable:!0,draggable:!0,geodesic:!0,visible:!0})}s.drawingManagerOptions={drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.POLYLINE]},polylineOptions:{strokeColor:"#69AA46",strokeWeight:5}},s.markersAndCircleFlag=!0,s.drawingManagerControl={},s.drawingManagerEvents={polylinecomplete:function(t,a,e,n){for(var r=n[0],o=r.getPath(),i=[],l=0;l<o.getArray().length;l++)i.push(o.getArray()[l].toJSON());s.ruta.segmentos.push(i),s.formas.push(r)}}},s.seleccionarMarcador=function(t,a,e){"blue"==e.options.icon.strokeColor?(e.options.icon={path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"red",scale:3},s.ruta.clientes.splice(s.ruta.clientes.indexOf(e.id),1)):(e.options.icon={path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"blue",scale:3},s.ruta.clientes.push(e.id))},s.generarMarcadores=function(t){var a=function(t,a,e,n,r,o,i){null==e&&(e="id");var l={latitude:n,longitude:r,title:"m"+t,options:o};return l[e]=i,l};s.markers=[];for(var e,n=[],r=0;r<s.clientes.length;r++){var o=0<$.grep(t.clientes,function(t){return t==s.clientes[r].id}).length?"blue":"red";e={labelContent:s.clientes[r].razon_social,labelAnchor:"8 35",labelClass:"marker-label",icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:o,scale:3}},n.push(a(r+1,s.map.bounds,null,s.clientes[r].latitud,s.clientes[r].longitud,e,s.clientes[r].id))}s.markers=n},s.mostrarMapa=function(){s.mostrarMap=!0,r(function(){s.$apply(function(){google.maps.event.trigger(s.map,"resize")})},2e3)},s.crearNuevaRuta=function(){var t=JSON.parse(e.usuario),a=new c({id_empresa:t.id_empresa,clientes:[],segmentos:[]});s.abrirPopupRuta(a)},s.verRuta=function(a){s.formas=[],s.mostrarMap=!1,s.ruta=a,p.then(function(t){s.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},s.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},s.generarMarcadores(s.ruta),s.dibujarRuta(a)}),s.abrirPopup("modal-wizard-ruta-vista")},s.cerrarPopPupVista=function(){s.cerrarPopup("modal-wizard-ruta-vista")},s.cerrarPopPupNuevaRuta=function(){s.cerrarPopup("modal-wizard-ruta")},s.modificarRuta=function(t){s.abrirPopupRuta(t)},s.mostrarConfirmacionEliminacion=function(t){s.ruta=new c(t),s.abrirPopup("dialog-eliminar-ruta")},s.cerrarConfirmacionEliminacion=function(){s.cerrarPopup("dialog-eliminar-ruta")},s.eliminarRuta=function(t){u.start(),s.cerrarConfirmacionEliminacion(),t.$delete(),s.mostrarMensaje("Eliminado exitosamente!"),s.recargarItemsTabla(),u.stop()},s.saveForm=function(t){"Siguiente"!=$("#siguiente").text().trim()&&(u.start(),t.segmentos=JSON.stringify(t.segmentos),t.id?c.update({idRuta:t.id},t,function(t){u.stop(),s.cerrarPopPupNuevaRuta(),s.mostrarMensaje(t.mensaje),s.recargarItemsTabla()}):t.$save(function(t){u.stop(),s.ruta=new c({}),s.cerrarPopPupNuevaRuta(),s.mostrarMensaje("¡Ruta creada con código "+t.id+"!"),s.recargarItemsTabla()},function(t){u.stop(),s.cerrarPopPupNuevaRuta(),s.mostrarMensaje("Ocurrio un problema al momento de guardar!"),s.recargarItemsTabla()}))},s.subirExcelRutas=function(t){var a,e,n=t.target.files;for(e=n[a=0];a!=n.length;++a){var r=new FileReader;e.name;r.onload=function(t){u.start();var a=t.target.result,e=XLSX.read(a,{type:"binary"}),n=e.SheetNames[0],r=2,o=e.Sheets[n],i=[];do{var l={};l.codigo=null!=o["A"+r]&&""!=o["A"+r]?o["A"+r].v.toString():null,l.razon_social=null!=o["B"+r]&&""!=o["B"+r]?o["B"+r].v.toString():null,l.nit=null!=o["C"+r]&&""!=o["C"+r]?o["C"+r].v.toString():null,l.direccion=null!=o["D"+r]&&""!=o["D"+r]?o["D"+r].v.toString():null,l.telefono1=null!=o["E"+r]&&""!=o["E"+r]?o["E"+r].v.toString():null,l.telefono2=null!=o["F"+r]&&""!=o["F"+r]?o["F"+r].v.toString():null,l.telefono3=null!=o["G"+r]&&""!=o["G"+r]?o["G"+r].v.toString():null,l.contacto=null!=o["H"+r]&&""!=o["H"+r]?o["H"+r].v.toString():null,l.ubicacion_geografica=null!=o["I"+r]&&""!=o["I"+r]?o["I"+r].v.toString():null,l.rubro=null!=o["J"+r]&&""!=o["J"+r]?o["J"+r].v.toString():null,l.categoria=null!=o["K"+r]&&""!=o["K"+r]?o["K"+r].v.toString():null,l.fecha1=null!=o["L"+r]&&""!=o["L"+r]?new Date(s.convertirFecha(o["L"+r].v.toString())):null,l.fecha2=null!=o["M"+r]&&""!=o["M"+r]?new Date(s.convertirFecha(o["M"+r].v.toString())):null,l.texto1=null!=o["N"+r]&&""!=o["N"+r]?o["N"+r].v.toString():null,l.texto2=null!=o["O"+r]&&""!=o["O"+r]?o["O"+r].v.toString():null,l.ruta1=null!=o["P"+r]&&""!=o["P"+r]?o["P"+r].v.toString():null,l.ruta2=null!=o["Q"+r]&&""!=o["Q"+r]?o["Q"+r].v.toString():null,l.ruta3=null!=o["R"+r]&&""!=o["R"+r]?o["R"+r].v.toString():null,i.push(l),r++,0}while(null!=o["A"+r]);s.guardarClientes(i),u.stop()},r.readAsBinaryString(e)}},s.guardarClientes=function(t){new m({clientes:t,id_empresa:s.usuario.id_empresa}).$save(function(t){u.stop(),s.mostrarMensaje(t.mensaje),s.recargarItemsTabla()},function(t){u.stop(),s.mostrarMensaje("Ocurrio un problema al momento de guardar!"),s.recargarItemsTabla()})},s.$on("$routeChangeStart",function(t,a){s.eliminarPopup("modal-wizard-ruta"),s.eliminarPopup("modal-wizard-ruta-vista"),s.eliminarPopup("dialog-eliminar-ruta")}),s.inicio()}]);