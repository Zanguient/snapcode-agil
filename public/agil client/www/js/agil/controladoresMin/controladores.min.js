angular.module("agil.controladores").controller("ControladorActivosFijos",["$scope","$timeout","Paginator","$localStorage","$location","blockUI","ListaSubGruposProductoEmpresa","FieldViewer","GuardarConfiguracionActivosFijos","ObtenerConfiguracionActivosFijos","ActivosFijosEmpresa","RevaluarActivo",function(t,a,e,o,i,r,n,s,c,l,d,u){t.idModalconfiguracionActivos="modal-configuracion-activos",t.idModalRevaluarActivo="modal-revaluar-activos",t.usuarioSesion=JSON.parse(o.usuario),t.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),ejecutarScriptsActivos(t.idModalconfiguracionActivos,t.idModalRevaluarActivo),t.buscarAplicacion(t.usuarioSesion.aplicacionesUsuario,i.path().substring(1)),t.obtenerColumnasAplicacion()}),t.$on("$routeChangeStart",function(e,a){t.eliminarPopup(t.idModalconfiguracionActivos),t.eliminarPopup(t.idModalRevaluarActivo)}),t.calcularTotales=function(){t.totalesActivosFijos={totalValores:0,totalActualizacion:0,totalActualizado:0,totalDepreciacionAcumulada:0,totalActualizacionDepreciacionAcumulada:0,totalDepreciacionActualizada:0,totalDepreciacionMensual:0,totalDepreciacion:0,totalNeto:0},t.activosFijos.forEach(function(e){t.totalesActivosFijos.totalValores+=e.valores[0].valor,t.totalesActivosFijos.totalActualizacion+=e.valores[0].incremento_actualizacion,t.totalesActivosFijos.totalActualizado+=e.valores[0].valor_actualizado,t.totalesActivosFijos.totalDepreciacionAcumulada+=e.valores[0].depreciacion_acumulada,t.totalesActivosFijos.totalActualizacionDepreciacionAcumulada+=e.valores[0].incremento_actualizacion_depreciacion_acumulada,t.totalesActivosFijos.totalDepreciacionActualizada+=e.valores[0].depreciacion_acumulada_actualizada,t.totalesActivosFijos.totalDepreciacionMensual+=e.valores[0].depreciacion,t.totalesActivosFijos.totalDepreciacion+=e.valores[0].total_depreciacion_acumulada,t.totalesActivosFijos.totalNeto+=e.valores[0].valor_neto})},t.factorConfiguracion=Array.apply(null,new Array(20)).map(function(e,a){return{id:5*(a+1)}}),t.abrirConfiguracionActivos=function(){t.abrirPopup(t.idModalconfiguracionActivos)},t.cerrarConfiguracionActivos=function(){t.cerrarPopup(t.idModalconfiguracionActivos)},t.inicio=function(){t.configuracionActivosFijos=[],t.obtenerConfiguracionActivos(),t.filtro={mes:{id:(new Date).getMonth()+1},anio:{id:(new Date).getFullYear()},subgrupo:0,codigo:0,activo:0,vida_util:0},t.obtenerSubGruposProductosEmpresaUsuario(),t.obtenerPaginadorActivos(),t.listaEstados=[{id:1,nombre:"Activo"},{id:2,nombre:"Inactivo"}],t.ConteoBusqueda=0},t.agregarDetalleConfiguracion=function(a){if(t.configuracionActivosFijos.some(function(e){return e.subgrupo.id===a.subgrupo.id}))t.mostrarMensaje("Ya existe en la lista de configuración.");else{var e={subgrupo:a.subgrupo,vida_util:a.vida_util,factor:a.factor};t.configuracionActivosFijos.push(e)}},t.obtenerColumnasAplicacion=function(){r.start(),t.fieldViewer=s({crear:!0,id_empresa:t.usuarioSesion.empresa.id,configuracion:{numero:{value:"Número",show:!0},activo:{value:"Activo",show:!0},codigo:{value:"Código",show:!0},cantidad:{value:"Cantidad",show:!0},mes:{value:"Mes",show:!0},anio:{value:"Año",show:!0},fecha_ingreso:{value:"Fecha ingreso",show:!0},valor:{value:"Valor",show:!0},actualizacion:{value:"Actualización",show:!0},valor_actualizado:{value:"Valor actualizado",show:!0},depreciacion_acumulada:{value:"Depreciación acumulada",show:!0},actualizacion_depreciacion_acumulada:{value:"Actualización de la depreciación acumulada",show:!0},depreciacion_acumulada_actualizada:{value:"Depreciación acumulada actualizada",show:!0},depreciacion_mes:{value:"Depreciación mensual",show:!0},total_depreciacion:{value:"Total depreciación",show:!0},valor_neto:{value:"Valor neto",show:!0},vida_util:{value:"Vida útil",show:!0},vida_restante:{value:"Vida restante (Meses)",show:!0},revaluado:{value:"Revaluado",show:!0}}},t.aplicacion.aplicacion.id),t.fieldViewer.updateObject(),r.stop()},t.obtenerSubGruposProductosEmpresaUsuario=function(){r.start(),n(t.usuarioSesion.id_empresa,t.usuarioSesion.id).then(function(e){r.stop(),0<e.length?t.subGruposProducto=e:(t.subGruposProducto=[],t.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){t.subGruposProducto=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";t.mostrarMensaje(a),r.stop()})},t.obtenerConfiguracionActivos=function(){r.start(),l(t.usuarioSesion.id_empresa,t.usuarioSesion.id).then(function(e){e.hasErr?(t.configuracionActivosFijos=[],t.mostrarMensaje(e.mensaje)):t.configuracionActivosFijos=e.configuracion,r.stop()}).catch(function(e){r.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";t.mostrarMensaje(a)})},t.obtenerPaginadorActivos=function(){t.paginator=e(),t.paginator.column="nombre",t.paginator.direccion="asc",t.paginator.callBack=t.buscarActivos,t.paginator.getSearch("",null,null)},t.filtrarFiltro=function(e,a,o){if(void 0!==o)for(var i in e)0==e[i]&&(e[i]="");else for(var i in e)""!==e[i]&&null!==e[i]&&void 0!==e[i]||(e[i]=0);if(void 0!==a&&a)return e;t.buscarActivos()},t.buscarActivos=function(){r.start(),t.filtro=t.filtrarFiltro(t.filtro,!0),t.paginator.filter=t.filtro,d(t.usuarioSesion.id_empresa,t.paginator).then(function(e){if(e.hasErr)t.mostrarMensaje(e.mensaje);else{if(0<e.activos.length){t.activosFijos=e.activos,t.paginator.setPages(e.paginas);var i=-1;0<t.configuracionActivosFijos.length&&t.activosFijos.forEach(function(o,e){if(t.configuracionActivosFijos.some(function(e,a){return i=a,e.subgrupo.id==o.activo.subgrupo.id})){var a=(new Date).getMonth()-new Date(o.fecha_ingreso).getMonth()+12*((new Date).getFullYear()-new Date(o.fecha_ingreso).getFullYear());t.activosFijos[e].vida_util=t.configuracionActivosFijos[i].vida_util,t.activosFijos[e].vida_restante=t.configuracionActivosFijos[i].vida_util-a}}),t.calcularTotales()}else{if(t.ConteoBusqueda<1)return t.ConteoBusqueda+=1,void a(function(){t.buscarActivos()},5e3);t.activosFijos=e.activos,t.totalesActivosFijos={totalValores:0,totalActualizacion:0,totalActualizado:0,totalDepreciacionAcumulada:0,totalActualizacionDepreciacionAcumulada:0,totalDepreciacionActualizada:0,totalDepreciacionMensual:0,totalDepreciacion:0,totalNeto:0}}r.stop()}r.stop(),t.filtrarFiltro(t.filtro,!0,!0)}).catch(function(e){r.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";t.mostrarMensaje(a)})},t.revaluarActivo=function(){r.start(),u(t.activo,t.usuarioSesion.id_empresa,t.usuarioSesion.id).then(function(e){e.hasErr?t.mostrarMensaje(e.mensaje):t.cerrarDialogRevaluarActivo(),r.stop()}).catch(function(e){r.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";t.mostrarMensaje(a)})},t.guardarConfiguracionActivos=function(){(r.start(),0<t.configuracionActivosFijos.length)?c(t.usuarioSesion.id_empresa,t.usuarioSesion.id,t.configuracionActivosFijos).then(function(e){e.hasErr?t.mostrarMensaje(e.mensaje):(t.mostrarMensaje(e.mensaje),t.cerrarConfiguracionActivos()),r.stop()}).catch(function(e){r.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";t.mostrarMensaje(a)}):t.mostrarMensaje("No hay cambios para guardar.")},t.abrirDialogRevaluarActivo=function(e){null!=e?(t.activo=e,t.abrirPopup(t.idModalRevaluarActivo)):t.mostrarMensaje("La información del activo es incorrecta.")},t.cerrarDialogRevaluarActivo=function(){t.activo={},t.cerrarPopup(t.idModalRevaluarActivo)},t.inicio()}]),angular.module("agil.controladores").controller("ControladorComprobantes",["$scope","$localStorage","$location","$templateCache","$route","blockUI","CodigoControl","Paginator","ComprobantePaginador","ClasesTipo","ListaCuentasComprobanteContabilidad","ListaAsientosComprobanteContabilidad","NuevoComprobanteContabilidad","ClasesTipo","LibroMayorCuenta","ComprobanteRevisarPaginador","AsignarComprobanteFavorito","Diccionario","ObtenerCambioMoneda","ImprimirComprobante","ComprasComprobante","VerificarUsuarioEmpresa","FieldViewer","DatosComprobante","EliminarComprobante","ListaCambioMoneda","ActualizarCambioMoneda","GuardarComprobantesImportados","ComprobanteTotalGeneralEmpresa","EdicionComprobanteContabilidad",function(h,e,a,o,i,b,t,r,n,s,c,l,d,s,u,p,m,f,g,v,C,P,_,M,D,E,x,S,A,T){b.start(),h.asientoNuevo=!1,h.usuario=JSON.parse(e.usuario),h.IdModalVerificarCuenta="modal-verificar-cuenta",h.IdModalEliminarComprobante="dialog-eliminar-comprobante",h.IdModalCambioMoneda="dialog-cambio-moneda",h.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsComprobante(h.IdModalVerificarCuenta,h.IdModalEliminarComprobante,h.IdModalCambioMoneda),h.buscarAplicacion(h.usuario.aplicacionesUsuario,a.path().substring(1)),h.obtenerColumnasAplicacion()}),h.$on("$routeChangeStart",function(e,a){h.eliminarPopup(h.IdModalVerificarCuenta),h.eliminarPopup(h.IdModalEliminarComprobante),h.eliminarPopup(h.IdModalCambioMoneda)}),h.inicio=function(){h.opcionBimonetario2=!1,h.detalleComprobante={},h.obtenerTiposComprobante(),h.asientos=[],h.cuenta={},h.diccionario=f,console.log(h.diccionario),h.comprobante={asientos:[]},h.sucursales=h.obtenerSucursales(),h.obtenerMeses(),h.ObtenerComprobantes(),h.obtenerGestiones(),h.obtenerAnios("2016"),h.obtenerCambioDolar()},h.obtenerColumnasAplicacion=function(){h.fieldViewer=_({crear:!0,id_empresa:h.usuario.id_empresa,configuracion:{abierto:{value:"Abierto",show:!0},comprobante:{value:"Comp.",show:!0},numero:{value:"Nro",show:!0},fecha:{value:"Fecha",show:!0},sucursal:{value:"Sucursal",show:!0},gloza:{value:"Gloza",show:!0},hora_fecha:{value:"Hora-Fecha",show:!0},importe:{value:"Importe",show:!0},usuario:{value:"Usuario",show:!0}}},h.aplicacion.aplicacion.id),h.fieldViewer.updateObject()},h.obtenerTotalGeneral=function(e){A(h.usuario.id_empresa).then(function(e){h.totalGeneralComprobantes=e.total[0].total})},h.obtenerSucursales=function(){for(var e=[],a=0;a<h.usuario.sucursalesUsuario.length;a++)e.push(h.usuario.sucursalesUsuario[a].sucursal);return console.log(h.usuario.sucursalesUsuario),e},h.ObtenerComprobantes=function(){h.paginator=r(),h.paginator.column="numero",h.paginator.direction="desc",h.paginator.callBack=h.obtenerLista;var e,a,o=new Date,i=h.fechaATexto(o),t=h.fechaATexto((a=-10,(e=o).setDate(e.getDate()+a),e));h.filtro={inicio:t,fin:i,empresa:h.usuario.id_empresa,clasificacion:"",tipo_comprobante:"",monto:""},null!=h.filtro.inicio&&h.paginator.getSearch("",h.filtro)},h.obtenerLista=function(){b.start();var a=h.paginator.filter.inicio,o=h.paginator.filter.fin;h.paginator.filter.inicio=new Date(h.convertirFecha(h.paginator.filter.inicio)),h.paginator.filter.fin=new Date(h.convertirFecha(h.paginator.filter.fin));var e=n(h.paginator);h.totalImporte=0,h.obtenerTotalGeneral(),e.then(function(e){h.paginator.setPages(e.paginas),h.comprobantes=e.comprobantes,h.comprobantes.forEach(function(e){h.totalImporte=h.totalImporte+e.importe},this),h.paginator.filter.inicio=a,h.paginator.filter.fin=o,b.stop()})},h.formatearFecha=function(e){var a=e.split("/");return a[0]+a[1]+a[2]},h.cerrarModalLibrosMayores=function(){h.cerrarPopup(h.IdModalLibroMayor)},h.obtenerTiposComprobante=function(){b.start(),s("TCMC").then(function(e){h.tiposComprobantes=e.clases,b.stop()})},h.obtenerGestiones=function(){b.start(),s("GTN").then(function(e){h.gestiones=e.clases,b.stop()})},h.buscarCuentas=function(e){if(""!=e&&null!=e){var a=c(h.usuario.id_empresa,e);return console.log(a),a}},h.DatosCodigoQr=[],h.cont2=1,h.disparo=!0,h.AgregarComprobante=function(){if(null!=h.nuevoComprobante.tipo_comprobante&&null!=h.nuevoComprobante.id_sucursal&&null!=h.nuevoComprobante.fecha){for(var e=0;e<h.nuevoComprobante.asientosContables.length;e++){var a=h.nuevoComprobante.asientosContables[e];0!=a.activo&&""!=a.debe_bs&&(h.nuevoComprobante.importe=Math.round(1e4*(h.nuevoComprobante.importe+a.debe_bs))/1e4)}h.nuevoComprobante.fecha=new Date(h.convertirFecha(h.nuevoComprobante.fecha)),d.save(h.nuevoComprobante,function(e){h.mostrarMensaje(e.mensaje),h.cerrarNuevoComprobante()})}},h.verComprobante=function(a,o){T(a.id).then(function(e){console.log(a),o?h.crearNuevoComprobante(null,null,e.comprobante,!0):a.abierto?(h.obtenerCambioMoneda2(h.fechaATexto(e.comprobante.fecha)),h.crearNuevoComprobante(null,null,e.comprobante)):e.comprobante.id||h.crearNuevoComprobante(null,null,e.comprobante)})},h.ComvertirDebeEnDolar=function(e){e.debe_sus=Math.round(e.debe_bs/h.valorDolar*1e4)/1e4},h.ComvertirHaberEnDolar=function(e){e.haber_sus=Math.round(e.haber_bs/h.valorDolar*1e4)/1e4},h.ComvertirDebeEnBolivianos=function(e){e.debe_bs=Math.round(e.debe_sus*h.valorDolar*1e4)/1e4},h.ComvertirHaberEnBolivianos=function(e){e.haber_bs=Math.round(e.haber_sus*h.valorDolar*1e4)/1e4},h.verificarCuentaAdmin=function(e){e.id_comprobante=h.dato.id,P.save({id_empresa:h.usuario.id_empresa},e,function(e){console.log(e),e.type?(h.mostrarMensaje(e.message),h.dato.abierto?h.dato.abierto=!1:h.dato.abierto=!0,h.cerrarModalVerificarCuenta()):h.mostrarMensaje(e.message)})},h.abrirModalVerificarCuenta=function(e){h.dato=e,h.abrirPopup(h.IdModalVerificarCuenta)},h.cerrarModalVerificarCuenta=function(){h.cerrarPopup(h.IdModalVerificarCuenta)},h.abrirModalEliminarComprobante=function(e){h.dato=e,h.abrirPopup(h.IdModalEliminarComprobante)},h.cerrarModalEliminarComprobante=function(){h.cerrarPopup(h.IdModalEliminarComprobante)},h.eliminarComprobante=function(){D(h.dato.id).then(function(e){h.recargarItemsTabla(),h.mostrarMensaje(e.mensaje),h.cerrarModalEliminarComprobante()})},h.opcionBimonetario=!0,h.VerBimonetario=function(){console.log(h.opcionBimonetario),1!=h.opcionBimonetario?h.opcionBimonetario=!1:h.opcionBimonetario=!0},h.imprimirComprobante=function(e,a){b.start(),M(e.id).then(function(e){e.comprobante.importe_literal=e.importeLiteral,v(e.comprobante,a,h.usuario,h.number_format),b.stop()})},h.buscarCambioMoneda=function(e){E(e).then(function(e){h.cambiosMoneda=e})},h.abrirCambioMoneda=function(){h.filtroMoneda={mes:"a",anio:2018},E(h.filtroMoneda).then(function(e){h.cambiosMoneda=e,h.abrirPopup(h.IdModalCambioMoneda)})},h.cerrarCambioMoneda=function(){h.cerrarPopup(h.IdModalCambioMoneda)},h.obtenerAnios=function(e){var a=(new Date).getFullYear(),o=[];for(e=e||1980;e<=a;)o.push(e++);h.listYears=o},h.EditarCambioMoneda=function(e){e.edit=!0},h.CancelarModificarMoneda=function(){E(h.filtroMoneda).then(function(e){h.cambiosMoneda=e})},h.GuardarCambio=function(a){x(a).then(function(e){h.mostrarMensaje(e.mensaje),a.edit=!1})},h.obtenerCambioDolar=function(){var e=new Date;g(e).then(function(e){console.log(e),e.monedaCambio&&(h.moneda=e.monedaCambio)})},h.subirExcelComprobantes=function(e){b.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){b.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=2,n=o.Sheets[i],s=[],c="",l="",d="";do{r=t;var u={asientosContables:[]};u.tipoCambio=h.moneda,u.tipo_comprobante=null!=n["A"+t]&&""!=n["A"+t]?n["A"+t].v.toString():null,d=u.tipo_comprobante,u.codigo=null!=n["B"+t]&&""!=n["B"+t]?n["B"+t].v.toString():null,c=u.codigo,u.fecha=null!=n["C"+t]&&""!=n["C"+t]?new Date(h.fecha_excel_angular(n["C"+t].v.toString())):null,u.fechaActual=new Date,u.sucursal=null!=n["D"+t]&&""!=n["D"+t]?n["D"+t].v.toString():null,l=null!=n["C"+t]&&""!=n["C"+t]?h.fecha_excel_angular(n["C"+t].v.toString()):null,u.importe=0,u.gloza=null!=n["E"+t]&&""!=n["E"+t]?n["E"+t].v.toString():null;do{var p={};p.numero_cuenta=null!=n["F"+r]&&""!=n["F"+r]?n["F"+r].v.toString():null,p.codigo=null!=n["G"+r]&&""!=n["G"+r]?n["G"+r].v.toString():null,p.gloza=null!=n["H"+r]&&""!=n["H"+r]?n["H"+r].v.toString():null,p.debe_bs=null!=n["I"+r]&&""!=n["I"+r]?parseFloat(n["I"+r].v.toString()):null,p.haber_bs=null!=n["J"+r]&&""!=n["J"+r]?parseFloat(n["J"+r].v.toString()):null,p.debe_sus=Math.round(p.debe_bs/h.moneda.dolar*1e4)/1e4,p.haber_sus=Math.round(p.haber_bs/h.moneda.dolar*1e4)/1e4,p.eliminado=!1;var m=null!=n["B"+r]&&""!=n["B"+r]?parseInt(n["B"+r].v.toString()):null,f=null!=n["C"+r]&&""!=n["C"+r]?h.fecha_excel_angular(n["C"+r].v.toString()):null,g=null!=n["A"+r]&&""!=n["A"+r]?n["A"+r].v.toString():null;m==c&&f==l&&d==g&&(u.importe+=p.debe_bs,u.asientosContables.push(p));var v=null!=n["B"+ ++r]&&""!=n["B"+r]?parseInt(n["B"+r].v.toString()):null}while(v==c);0==s.length?s.push(u):s[s.length-1].codigo==c&&s[s.length-1].tipo_comprobante==d||s.push(u),t=r,console.log(t),0}while(null!=n["A"+t]);h.GuardarComprobantesImportacion(s)},t.readAsBinaryString(o)}},h.GuardarComprobantesImportacion=function(e){h.comprobantesParaGuardar=e;var a=[];0<h.comprobantesParaGuardar.length?(300<h.comprobantesParaGuardar.length?(a=h.comprobantesParaGuardar.slice(0,300),h.comprobantesParaGuardar=h.comprobantesParaGuardar.slice(300,h.comprobantesParaGuardar.length)):(a=h.comprobantesParaGuardar,h.comprobantesParaGuardar=[]),S(a,h.usuario.id,h.usuario.id_empresa).then(function(e){b.stop(),h.mostrarMensaje("del codigo "+a[0].codigo+" hasta el codigo "+a[a.length-1].codigo+" "+e.mensaje+" faltan procesar "+h.comprobantesParaGuardar.length+" comprobantes"),h.GuardarComprobantesImportacion(h.comprobantesParaGuardar)})):b.stop()},h.imprimirFiltroExcelCajaCartaOficio=function(){b.start();h.paginator.filter.inicio,h.paginator.filter.fin;h.paginator.filter.inicio=new Date(h.convertirFecha(h.paginator.filter.inicio)),h.paginator.filter.fin=new Date(h.convertirFecha(h.paginator.filter.fin));var e=Object.assign({},h.paginator);e.itemsPerPage=0,n(e).then(function(e){h.ReporteComprovante=e.comprobantes;(e=[]).push(["N°","COMPROBANTE","NUMERO"]);for(var a=0,o=0;o<h.ReporteComprovante.length;o++)h.reporte=h.ReporteComprovante[o],columns=[],a+=1,columns.push(a),columns.push(h.reporte.tipoComprobante.nombre),columns.push(h.reporte.numero),e.push(columns);var i="SheetJS",t=new Workbook,r=sheet_from_array_of_arrays(e);t.SheetNames.push(i),t.Sheets[i]=r;var n=XLSX.write(t,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),"VENTAS-MENSUALES.xlsx"),b.stop()})},h.inicio()}]),angular.module("agil.controladores").controller("ControladorBancos",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","Clases","Banco","ListaBancos","BancoDatos","BancoPaginador","$window",function(i,e,a,o,t,r,n,s,c,l,d,u,p){r.start(),i.idModalWizardBancoEdicion="modal-wizard-banco",i.idModalWizardBancoVista="modal-wizard-banco-vista",i.idModalEliminarBanco="dialog-eliminar-banco",i.idModalContenedorBancoEdicion="modal-wizard-container-banco-edicion",i.idModalContenedorBancoVista="modal-wizard-container-banco-vista",i.usuario=JSON.parse(e.usuario),i.inicio=function(){i.paginadorBancos(i.usuario.id_empresa)},i.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsBanco(i.idModalWizardBancoEdicion,i.idModalContenedorBancoEdicion,i.idModalWizardBancoVista,i.idModalContenedorBancoVista,i.idModalEliminarBanco),i.buscarAplicacion(i.usuario.aplicacionesUsuario,a.path().substring(1));var e=n("TCB");e.then(function(e){i.tiposCuenta=e.clases,r.stop()}),(e=n("TM")).then(function(e){i.tiposMoneda=e.clases,r.stop()})}),i.crearNuevoBanco=function(){i.esNuevo=!0,i.banco=new c({id_empresa:i.usuario.id_empresa}),i.abrirPopup(i.idModalWizardBancoEdicion)},i.cerrarPopPupNuevoBanco=function(){i.cerrarPopup(i.idModalWizardBancoEdicion)},i.verBanco=function(e){i.banco=e,i.abrirPopup(i.idModalWizardBancoVista)},i.cerrarPopPupVista=function(){i.cerrarPopup(i.idModalWizardBancoVista)},i.cerrarPopPupEdicion=function(){i.cerrarPopup(i.idModalWizardBancoEdicion)},i.modificarBanco=function(e){i.banco=e,i.abrirPopup(i.idModalWizardBancoEdicion)},i.mostrarConfirmacionEliminacion=function(e){i.banco=new c(e),i.abrirPopup(i.idModalEliminarBanco)},i.cerrarConfirmacionEliminacion=function(){i.cerrarPopup(i.idModalEliminarBanco)},i.eliminarBanco=function(e){r.start(),i.cerrarConfirmacionEliminacion(),e.$delete(),i.mostrarMensaje("Eliminado exitosamente!"),i.recargarItemsTabla(),r.stop()},i.saveForm=function(e){var a=$("#siguiente").text().trim();console.log(a),"Siguiente"!=a&&(r.start(),e.id?d.update({id_banco:e.id},e,function(e){i.cerrarPopPupNuevoBanco(),i.mostrarMensaje("Actualizado Exitosamente!"),i.recargarItemsTabla()}):e.$save(function(e){r.stop(),i.banco=new c,i.cerrarPopPupNuevoBanco(),i.mostrarMensaje("Guardado Exitosamente!"),i.recargarItemsTabla()},function(e){r.stop(),i.cerrarPopPupNuevoBanco(),i.mostrarMensaje("Ocurrio un problema al momento de guardar!"),i.recargarItemsTabla()}))},i.obtenerBancos=function(e){r.start(),l(e).then(function(e){i.bancos=e,r.stop()})},i.$on("$routeChangeStart",function(e,a){i.eliminarPopup(i.idModalWizardBancoEdicion),i.eliminarPopup(i.idModalWizardBancoVista),i.eliminarPopup(i.idModalEliminarBanco)}),i.paginadorBancos=function(){i.abs=p.Math.abs,i.itemsPorPagina=10,i.buscarBancos(1,i.itemsPorPagina,"")},i.verificarPulso=function(e,a){13===e.keyCode&&i.buscarBancos(1,i.itemsPorPagina,a)},i.buscarBanco=function(e){if(""!=e&&null!=e)return u(i.usuario.id_empresa,e)},i.buscarBancos=function(e,a,o){r.start(),i.itemsPorPagina=a,""==o||null==o?o=0:i.textoBusqueda=o,i.paginaActual=e,u(i.usuario.id_empresa,e,a,o).then(function(e){i.paginas=[];for(var a=1;a<=e.paginas;a++)i.paginas.push(a);i.bancos=e.bancos,r.stop()})},i.inicio()}]),angular.module("agil.controladores").controller("ControladorCajaChica",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipoEmpresa","ClasesTipo","GuardarSolicitudCajaChica","GuardarConceptoMovimientoCajaChica","ObtenerConceptoMovimientoCajaChica","SolicitudesCajaPaginador","SolicitudesCajaChicaPaginador","ObtenerTodoPersonal","$filter","Paginator","VerificarUsuarioEmpresa","NuevoComprobante","ConfiguracionCompraVista","ConfiguracionesCuentasEmpresa","ConfiguracionCompraVistaDatos","ProveedoresNit","GuardarCajaChica","ListaProductosEmpresaUsuario","VerificarUsuarioEmpresaCaja","IngresosCajaPaginador","ObtenerDatosCierreCaja","CierreCajaCPaginador","FieldViewer",function(d,e,a,o,i,u,t,r,n,s,c,l,p,m,f,g,v,h,b,C,P,_,M,D,E,x,S,A,T){d.usuario=JSON.parse(e.usuario),d.idModalSolicitudCajaChica="dialog-solicitud",d.idModalConceptosMovimiento="dialog-conceptos-movimiento",d.idModalEliminarSolicitud="dialog-eliminar-solicitud",d.idModalVerificarAutorizacion="modal-verificar-autorizacion",d.idModalRegistroCajaChica="dialog-registro-caja-chica",d.idModalKardexCajaChica="dialog-kardex-caja-chica",d.idModalIngresosCajaChica="dialog-kardex-ingresos",d.idModalRegistroIngresoCajaChica="dialog-registro-ingreso-caja-chica",d.idModalHistorialCierreCajaChica="dialog-kardex-cierre-caja-chica",d.idModalRegistroDesembolsoCajaChica="dialog-registro-desembolso-caja-chica",d.idModalServicios="dialog-servicios",d.idModalRegistroAnticipoCajaChica="dialog-registro-anticipo-caja-chica",d.inicio=function(){d.sucursales=d.obtenerSucursales(),d.sucursalPrincipal=d.usuario.sucursalesUsuario[0].sucursal,d.obtenerTiposMovimiento(),d.obtenerConceptosMovimiento(),d.obtenerTiposEstados(),d.obtenerListaSolicitudes(),d.obtenerMovimientosIngreso(),d.obtenerTiposDePago(),d.obtenerCentrosDeCosto(),d.obtenerConfiguracionCompraVista(),d.obtenerconfiuracionCuentas(),d.obtenerServicios(),d.ConceptosMovimiento=[],d.tipoFiltro="TODOS",d.verificacionDatos=!0},d.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsCajaChicas(d.idModalSolicitudCajaChica,d.idModalConceptosMovimiento,d.idModalEliminarSolicitud,d.idModalVerificarAutorizacion,d.idModalRegistroCajaChica,d.idModalKardexCajaChica,d.idModalIngresosCajaChica,d.idModalRegistroIngresoCajaChica,d.idModalHistorialCierreCajaChica,d.idModalRegistroDesembolsoCajaChica,d.idModalServicios,d.idModalRegistroAnticipoCajaChica),d.buscarAplicacion(d.usuario.aplicacionesUsuario,a.path().substring(1)),d.obtenerColumnasAplicacion(),u.stop()}),d.obtenerColumnasAplicacion=function(){d.fieldViewer=T({crear:!0,id_empresa:d.usuario.id_empresa,configuracion:{usuario_solicitante:{value:"usuario_solicitante",show:!0},fecha:{value:"fecha",show:!0},beneficiario:{value:"Beneficiario",show:!0},autorizador:{value:"Autorizador",show:!0},verificador:{value:"Verificador",show:!0},movimiento:{value:"Movimiento",show:!0},concepto:{value:"Concepto",show:!0},detalle:{value:"Detalle",show:!0},estado:{value:"Estado",show:!0},monto:{value:"Monto",show:!0}}},d.aplicacion.aplicacion.id),d.fieldViewer.updateObject()},d.abrirModalConceptosMovimiento=function(){d.clase={edit:!1},d.abrirPopup(d.idModalConceptosMovimiento)},d.cerrarModalConceptosMovimiento=function(){d.cerrarPopup(d.idModalConceptosMovimiento)},d.abrirModalKardexCajaChica=function(e){d.solicitud=e,d.abrirPopup(d.idModalKardexCajaChica)},d.cerrarModalKardexCajaChica=function(){d.cerrarPopup(d.idModalKardexCajaChica)},d.abrirModalIngresosCajaChica=function(){d.obtenerListaIngresos(),d.abrirPopup(d.idModalIngresosCajaChica)},d.cerrarModalIngresosCajaChica=function(){d.cerrarPopup(d.idModalIngresosCajaChica)},d.abrirModalHistorialCierreCajaChica=function(){d.obtenerListaCierresCajaChica(),d.abrirPopup(d.idModalHistorialCierreCajaChica)},d.cerrarModalHistorialCierreCajaChica=function(){d.cerrarPopup(d.idModalHistorialCierreCajaChica)},d.abrirModalEliminarSolicitud=function(e){d.solicitud=e,d.abrirPopup(d.idModalEliminarSolicitud)},d.cerrarModalEliminarSolicitud=function(){d.cerrarPopup(d.idModalEliminarSolicitud)},d.abrirModalRegistroCajaChica=function(e,a,o,i){if(e){if(d.solicitud=e,a)i?(d.cajaChica=Object.assign({},i),d.cajaChica.compra=Object.assign({},i.compra),d.cajaChica.solicitud=Object.assign({},e),d.cajaChica.solicitud.cajasChicas[0].saldo+=d.cajaChica.compra.total,d.cajaChica.verDatosCompra=!0,d.cajaChica.descuentoGasolina=!1,10<d.cajaChica.fecha.length&&(d.cajaChica.fecha=d.fechaATexto(d.cajaChica.fecha)),d.cajaChica.compra.fechaTexto=d.fechaATexto(i.compra.fecha)):(d.cajaChica=Object.assign({},e.cajasChicas[0]),d.cajaChica.compra=Object.assign({},e.cajasChicas[0].compra),d.cajaChica.solicitud=Object.assign({},e),d.cajaChica.solicitud.cajasChicas[0].saldo+=d.cajaChica.compra.total,d.cajaChica.verDatosCompra=!0,d.cajaChica.descuentoGasolina=!1,10<d.cajaChica.fecha.length&&(d.cajaChica.fecha=d.fechaATexto(d.cajaChica.fecha)),d.cajaChica.compra.fechaTexto=d.fechaATexto(e.cajasChicas[0].compra.fecha)),null==d.cajaChica.compra.movimiento&&(d.cajaChica.compra.movimiento={clase:{}},d.cajaChica.compra.movimiento.clase=d.cajaChica.compra.tipoMovimiento),d.cajaChica.compra.movimiento.clase.nombre==d.diccionario.MOVING_POR_RETENCION_BIENES||d.cajaChica.compra.movimiento.clase.nombre==d.diccionario.MOVING_POR_RETENCION_SERVICIOS?(d.configuracionCompraVista.mostrar_it_retencion=!0,d.configuracionCompraVista.mostrar_iue=!0,d.configuracionCompraVista.mostrar_pagado=!0):(d.configuracionCompraVista.mostrar_it_retencion=!1,d.configuracionCompraVista.mostrar_iue=!1,d.configuracionCompraVista.mostrar_pagado=!1);else{if(0<e.cajasChicas.length)var t=0;else t=0;d.cajaChica={fecha:d.fechaATexto(new Date),concepto:e.concepto,detalle:e.detalle,compra:{sucursal:d.sucursalPrincipal,fecha:d.fechaATexto(new Date),generado_por_pedido:!1,usar_producto:!0,movimiento:{clase:{}},tipo_retencion:!0,total:t,id_empresa:d.usuario.id_empresa,id_usuario:d.usuario.id,proveedor:{},id_tipo_pago:d.tiposPago[0].id,tipoPago:d.tiposPago[0],detallesCompra:[],descuento_general:!1,tipo_descuento:!1,codigo_control:0,autorizacion:0,tipo_recargo:!1,descuento:0,recargo:0,ice:0,excento:0},solicitud:e,verDatosCompra:!1,descuentoGasolina:!1}}o?(d.cajaChica.ver=!0,d.cajaChica.verDatosCompra=!0):d.cajaChica.ver=!1}else i?(d.cajaChica=Object.assign({},i),d.cajaChica.compra=Object.assign({},i.compra),d.cajaChica.solicitud=null,d.cajaChica.verDatosCompra=!0,d.cajaChica.descuentoGasolina=!1,10<d.cajaChica.fecha.length&&(d.cajaChica.fecha=d.fechaATexto(d.cajaChica.fecha)),d.cajaChica.compra.fechaTexto=d.fechaATexto(i.compra.fecha)):d.cajaChica={fecha:d.fechaATexto(new Date),compra:{fecha:d.fechaATexto(new Date),generado_por_pedido:!1,usar_producto:!0,movimiento:{clase:{}},tipo_retencion:!0,total:"",id_empresa:d.usuario.id_empresa,id_usuario:d.usuario.id,proveedor:{},id_tipo_pago:d.tiposPago[0].id,tipoPago:d.tiposPago[0],detallesCompra:[],descuento_general:!1,tipo_descuento:!1,codigo_control:0,autorizacion:0,tipo_recargo:!1,descuento:0,recargo:0,ice:0,excento:0},solicitud:null,verDatosCompra:!1,descuentoGasolina:!1},o?(d.cajaChica.ver=!0,d.cajaChica.verDatosCompra=!0):d.cajaChica.ver=!1;d.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},d.cargarCentroCosto(d.detalleCompra),d.abrirPopup(d.idModalRegistroCajaChica)},d.cargarCentroCosto=function(i){d.centrosCosto.forEach(function(e,a,o){e.nombre==d.cajaChica.concepto.nombre?i.centroCosto=e:i.centroCosto.nombre=d.cajaChica.concepto.nombre})},d.abrirModalRegistroIngresoCajaChica=function(e,a){e?(d.cajaChica=e,d.cajaChica.fecha=d.fechaATexto(new Date(e.fecha)),d.cajaChica.total=e.monto,d.cajaChica.sucursal=d.sucursalPrincipal):d.cajaChica={fecha:d.fechaATexto(new Date),solicitud:null,verDatosCompra:!1,descuentoGasolina:!1,sucursal:d.sucursalPrincipal},a&&(d.cajaChica.ver=!0),d.abrirPopup(d.idModalRegistroIngresoCajaChica)},d.abrirModalRegistroAnticipoCajaChica=function(e,a){e?(d.cajaChica={},d.cajaChica.solicitud=e,d.cajaChica.concepto=e.concepto,d.cajaChica.detalle=e.detalle,d.cajaChica.fecha=d.fechaATexto(new Date(e.fecha)),d.cajaChica.total=e.monto,d.cajaChica.sucursal=d.sucursalPrincipal):d.cajaChica={fecha:d.fechaATexto(new Date),solicitud:null,verDatosCompra:!1,descuentoGasolina:!1,sucursal:d.sucursalPrincipal},a&&(d.cajaChica.ver=!0),d.cajaChica.Desembolso=!0,d.cajaChica.Anticipo=!0,d.abrirPopup(d.idModalRegistroAnticipoCajaChica)},d.cerrarModalRegistroAnticipoCajaChica=function(){d.cerrarPopup(d.idModalRegistroAnticipoCajaChica)},d.cerrarModalRegistroIngresoCajaChica=function(){d.cerrarPopup(d.idModalRegistroIngresoCajaChica)},d.abrirModalRegistroDesembolsoCajaChica=function(e,a,o){o?(d.cajaChica=Object.assign({},e.cajasChicas[0]),d.cajaChica.solicitud=Object.assign({},e),d.cajaChica.fecha=d.fechaATexto(new Date(d.cajaChica.fecha)),d.cajaChica.total=e.cajasChicas[0].monto,d.cajaChica.Desembolso=!0,d.cajaChica.sucursal=d.sucursalPrincipal):(d.cajaChica={solicitud:e,sucursal:d.sucursalPrincipal},d.cajaChica.fecha=d.fechaATexto(new Date(e.fecha)),d.cajaChica.total=e.monto,d.cajaChica.detalle=e.detalle,d.cajaChica.concepto=e.concepto,d.cajaChica.Desembolso=!0),a&&(d.cajaChica.ver=!0),d.abrirPopup(d.idModalRegistroDesembolsoCajaChica)},d.cerrarModalRegistroDesembolsoCajaChica=function(){d.cerrarPopup(d.idModalRegistroDesembolsoCajaChica)},d.obtenerTiposDePago=function(){u.start(),r("TIPA").then(function(e){d.tiposPago=e.clases,u.stop()})},d.cerrarModalRegistroCajaChica=function(){d.cerrarPopup(d.idModalRegistroCajaChica)},d.abrirModalVerificarAutorizacion=function(e){d.solicitud=e,d.tipoDatosPermiso="autorizacion",d.abrirPopup(d.idModalVerificarAutorizacion)},d.cerrarModalVerificarAutorizacion=function(){d.cerrarPopup(d.idModalVerificarAutorizacion)},d.obtenerTiposMovimiento=function(){r("CM_CCH").then(function(e){d.tiposMovimientos=e})},d.obtenerTiposEstados=function(){r("ES_CCH").then(function(e){d.tiposEstados=e.clases})},d.obtenerConceptosMovimiento=function(){c(d.usuario.id_empresa).then(function(e){d.ConceptosMovimiento=e,d.cerrarModalConceptosMovimiento()})},d.AgregarConceptosMovimientoCajaChica=function(e){e.habilitado=!0,e.edit?d.clase={edit:!1}:d.ConceptosMovimiento.push(e)},d.editarConceptoMovimientoCajaChica=function(e){e.edit=!0,d.clase=e},d.cancelarEdicionConcepotMovimientoCajaChica=function(e){d.clase={edit:!1}},d.guardarConceptoMovimientoCajaChica=function(){s(d.usuario.id_empresa,d.ConceptosMovimiento).then(function(e){d.obtenerConceptosMovimiento(),d.mostrarMensaje(e.mensaje)})},d.obtenerListaSolicitudes=function(e){d.paginator=g(),d.paginator.column="id",d.paginator.direccion="asc",d.paginator.itemsPerPage=10,e?(d.filtro=e,d.filtro.id_sucursal=d.sucursalPrincipal.id):d.filtro={empresa:d.usuario.id_empresa,inicio:"",fin:"",solicitante:"",usuario:"",estado:"",concepto:"",movimiento:"",id_usuario_no_autorizado:d.usuario.encargado_caja_chica?"":d.usuario.encargado_rendicion_caja_chica?"":d.usuario.id,id_sucursal:d.sucursalPrincipal.id,rendiciones:d.usuario.encargado_rendicion_caja_chica?1:""},d.paginator.callBack=d.listaSolicitudesCajaChica,d.paginator.getSearch("",d.filtro,null)},d.listaSolicitudesCajaChica=function(){u.start(),p(d.paginator).then(function(e){u.stop(),d.totalRlCaja=e.totalRlCaja,d.totalCaja=e.total,d.paginator.setPages(e.paginas),d.solicitudesCajaChica=e.solicitudes})},d.obtenerListaIngresos=function(){d.paginator=g(),d.paginator.column="id",d.paginator.direccion="asc",d.paginator.itemsPerPage=10,d.filtro2={empresa:d.usuario.id_empresa,inicio:"",fin:"",id_sucursal:d.sucursalPrincipal.id},d.paginator.callBack=d.listaIngresosCajaChica,d.paginator.getSearch("",d.filtro2,null)},d.listaIngresosCajaChica=function(){u.start(),x(d.paginator).then(function(e){u.stop(),d.paginator.setPages(e.paginas),d.IngresosCajaChica=e.ingresos})},d.obtenerListaCierresCajaChica=function(){d.paginator=g(),d.paginator.column="id",d.paginator.direccion="asc",d.paginator.itemsPerPage=10,d.filtro2={empresa:d.usuario.id_empresa,inicio:"",fin:"",id_sucursal:d.sucursalPrincipal.id},d.paginator.callBack=d.listaCierresCajaChica,d.paginator.getSearch("",d.filtro2,null)},d.listaCierresCajaChica=function(){u.start(),A(d.paginator).then(function(i){u.stop(),d.paginator.setPages(i.paginas),i.cierreCaja.forEach(function(a,e,o){a.saldo_final=a.saldo_inicial,a.detalleCierreCaja.forEach(function(e){"INGRESO"==e.concepto.concepto.nombre?a.saldo_final+=e.monto:a.saldo_final-=e.monto}),e==o.length-1&&(d.cierresCajaChica=i.cierreCaja)})})},d.eliminarSolicitud=function(){d.tiposEstados.forEach(function(e,a,o){(e.nombre===d.diccionario.CC_ESTADO_ANULADO&&(d.solicitud.estado=e),a===o.length-1)&&(d.solicitud.eliminado=!0,d.solicitud.autorizador=d.usuario.id,n(d.solicitud).then(function(e){d.obtenerListaSolicitudes(),d.cerrarModalEliminarSolicitud(),d.mostrarMensaje(e.mensaje)}))})},d.verificarPerimisoAutorizacion=function(e){e.nombre_usuario=d.usuario.nombre_usuario,E(d.usuario.id_empresa,e).then(function(e){e.type?(d.mostrarMensaje(e.message),"autorizacion"==d.tipoDatosPermiso&&d.tiposEstados.forEach(function(e,a,o){(e.nombre===d.diccionario.CC_ESTADO_AUTORIZADO&&(d.solicitud.estado=e),a===o.length-1)&&(d.solicitud.autorizador=d.usuario.id,n(d.solicitud).then(function(e){d.obtenerListaSolicitudes(),d.cerrarModalVerificarAutorizacion(),d.mostrarMensaje(e.mensaje)}))})):(d.cerrarModalVerificarAutorizacion(),d.mostrarMensaje(e.message))})},d.verDatosCompra=function(){d.cajaChica.compra.fechaTexto=d.fechaATexto(new Date),d.cajaChica.verDatosCompra=!d.cajaChica.verDatosCompra},d.obtenerMovimientosIngreso=function(e){u.start(),r("MOVING").then(function(e){d.movimientosIngreso=e.clases;var i=[];d.movimientosIngreso.forEach(function(e,a,o){e.nombre!==d.diccionario.MOVING_INVENTARIO_INICIAL&&e.nombre!==d.diccionario.MOVING_POR_TRASPASO&&e.nombre!==d.diccionario.MOVING_POR_DEVOLUCION&&e.nombre!==d.diccionario.MOVING_POR_AJUSTE||i.push(a)}),i.reverse().forEach(function(e){d.movimientosIngreso.splice(e,1)}),u.stop()})},d.buscarCuentasCajaChica=function(e){return h(d.mostrarMensaje,null,null,d.usuario,null,null,null,null,null,null,e)},d.buscarProveedor=function(e){if(""!=e&&null!=e)return _(d.usuario.id_empresa,e)},d.establecerProveedor=function(e){d.cajaChica.compra.proveedor=e},d.interceptarTecla=function(e,a,o){13===e.which&&(o?d.enfocar(a):$timeout(function(){$("#"+a).trigger("click")},0))},d.obtenerSucursales=function(){for(var e=[],a=0;a<d.usuario.sucursalesUsuario.length;a++)e.push(d.usuario.sucursalesUsuario[a].sucursal);return e},d.obtenerAlmacenes=function(a){d.almacenes=[];var e=$.grep(d.sucursales,function(e){return e.id==a})[0];d.almacenes=e.almacenes,null==d.cajaChica.compra.id&&(d.cajaChica.compra.almacen=1==d.almacenes.length?d.almacenes[0]:null)},d.verificarMomivmiento=function(e){e.movimiento.clase.nombre==d.diccionario.MOVING_POR_RETENCION_SERVICIOS?e.usar_producto=!1:e.movimiento.clase.nombre==d.diccionario.MOVING_POR_RETENCION_BIENES?e.usar_producto=!0:e.movimiento.clase.nombre==d.diccionario.MOVING_POR_IMPORTACION&&(e.factura=0,e.autorizacion=3,e.codigo_control=0,e.descuento_general=!1,e.usar_producto=!0)},d.generarDescuentoGasolina=function(){d.cajaChica.descuentoGasolina=!d.cajaChica.descuentoGasolina,d.cajaChica.descuentoGasolina?(d.cajaChica.compra.descuento_general=!0,d.cajaChica.compra.descuento=0,d.cajaChica.compra.recargo=0,d.cajaChica.compra.ice=0,d.cajaChica.compra.excento=30*d.cajaChica.solicitud.monto/100):(d.cajaChica.compra.descuento_general=!1,d.cajaChica.compra.descuento=0,d.cajaChica.compra.recargo=0,d.cajaChica.compra.ice=0,d.cajaChica.compra.excento=0)},d.guardarCajaChica=function(){if(u.start(),d.cajaChica.solicitud)if(d.cajaChica.Desembolso){d.cajaChica.fecha=new Date(d.convertirFecha(d.cajaChica.fecha));var e=new Date;d.cajaChica.fecha.setHours(e.getHours()),d.cajaChica.fecha.setMinutes(e.getMinutes()),d.cajaChica.fecha.setSeconds(e.getSeconds()),d.tiposEstados.forEach(function(e,a,o){(d.cajaChica.Anticipo?e.nombre===d.diccionario.CC_ESTADO_PROCESADO&&(d.cajaChica.solicitud.estado=e):e.nombre===d.diccionario.CC_ESTADO_DESEMBOLSADO&&(d.cajaChica.solicitud.estado=e),a===o.length-1)&&M(d.cajaChica,d.usuario.id_empresa).then(function(e){u.stop(),d.generarPdfBoletaCajaChica(d.cajaChica.solicitud,e.cajaChica),d.obtenerListaSolicitudes(),d.mostrarMensaje(e.mensaje),d.cajaChica.Anticipo?d.cerrarModalRegistroAnticipoCajaChica():d.cerrarModalRegistroDesembolsoCajaChica()})})}else{d.cajaChica.fecha=new Date(d.convertirFecha(d.cajaChica.fecha)),d.cajaChica.compra.fecha=new Date(d.convertirFecha(d.cajaChica.compra.fechaTexto));e=new Date;if(d.cajaChica.compra.fecha.setHours(e.getHours()),d.cajaChica.compra.fecha.setMinutes(e.getMinutes()),d.cajaChica.compra.fecha.setSeconds(e.getSeconds()),d.cajaChica.fecha.setHours(e.getHours()),d.cajaChica.fecha.setMinutes(e.getMinutes()),d.cajaChica.fecha.setSeconds(e.getSeconds()),null!=d.cajaChica.solicitud)if("KARDEX"==d.cajaChica.solicitud.concepto.concepto.nombre){if(0<d.cajaChica.solicitud.cajasChicas.length)var a=d.cajaChica.solicitud.cajasChicas[0].saldo;else a=-1;if(d.cajaChica.compra.total==a)d.tiposEstados.forEach(function(e,a,o){(e.nombre===d.diccionario.CC_ESTADO_PROCESADO&&(d.cajaChica.solicitud.estado=e),a===o.length-1)&&M(d.cajaChica,d.usuario.id_empresa).then(function(e){u.stop(),d.obtenerListaSolicitudes(),d.generarPdfBoletaCajaChica(d.cajaChica.solicitud,e.cajaChica,!0),d.mostrarMensaje(e.mensaje),d.cerrarModalRegistroCajaChica()})});else M(d.cajaChica,d.usuario.id_empresa).then(function(e){u.stop(),d.obtenerListaSolicitudes(),d.mostrarMensaje(e.mensaje),d.generarPdfBoletaCajaChica(d.cajaChica.solicitud,e.cajaChica,!0),d.cerrarModalRegistroCajaChica()})}else d.tiposEstados.forEach(function(e,a,o){(e.nombre===d.diccionario.CC_ESTADO_PROCESADO&&(d.cajaChica.solicitud.estado=e),a===o.length-1)&&M(d.cajaChica,d.usuario.id_empresa).then(function(e){u.stop(),d.generarPdfBoletaCajaChica(d.cajaChica.solicitud,e.cajaChica),d.obtenerListaSolicitudes(),d.mostrarMensaje(e.mensaje),d.cerrarModalRegistroCajaChica()})});else M(d.cajaChica,d.usuario.id_empresa).then(function(e){u.stop(),d.obtenerListaSolicitudes(),d.generarPdfBoletaCajaChica(d.cajaChica.solicitud,e.cajaChica),d.mostrarMensaje(e.mensaje),d.cerrarModalRegistroCajaChica()})}else{d.cajaChica.fecha=new Date(d.convertirFecha(d.cajaChica.fecha));e=new Date;d.cajaChica.fecha.setHours(e.getHours()),d.cajaChica.fecha.setMinutes(e.getMinutes()),d.cajaChica.fecha.setSeconds(e.getSeconds()),M(d.cajaChica,d.usuario.id_empresa).then(function(e){u.stop(),d.generarPdfBoletaCajaChica(d.cajaChica.solicitud,e.cajaChica),d.obtenerListaIngresos(),d.obtenerListaSolicitudes(),d.mostrarMensaje(e.mensaje),d.cerrarModalRegistroIngresoCajaChica()})}},d.filterPorTipo=function(i,t){"TODOS"==(d.tipoFiltro=i)?(t.movimiento=0,d.paginator.getSearch(d.paginator.search,t,null)):d.tiposMovimientos.clases.forEach(function(e,a,o){e.nombre==i&&(t.movimiento=e.id),a===o.length-1&&d.paginator.getSearch(d.paginator.search,t,null)})},d.obtenerDatosCierreCaja=function(){u.start();var e=new Date;S(d.usuario.id_empresa,e,d.totalRlCaja,d.sucursalPrincipal.id).then(function(e){u.stop();var a=e.cierreCaja;d.generarPdfCajaChica(a)})},d.generarPdfCajaChica=function(e){u.start();var a=new PDFDocument({size:"letter",margin:10}),o=a.pipe(blobStream()),i=120,t=0,r=1,n=Math.ceil(e.detalleCierreCaja.length/19);d.dibujarCabeceraPDFCajaChica(a,1,n,e),a.font("Helvetica",8);for(var s=e.saldo_inicial,c=0;c<e.detalleCierreCaja.length&&t<=19;c++){var l=e.detalleCierreCaja[c];a.rect(30,i-10,555,30).stroke(),a.text(l.id,45,i),a.text(d.fechaATexto(new Date(l.fecha)),85,i),l.solicitud&&a.text(l.solicitud.solicitante.persona.nombre_completo,150,i,{width:120}),a.text(l.concepto.nombre,270,i,{width:150}),l.compra&&a.text(l.compra.factura,430,i),"INGRESO"==l.concepto.concepto.nombre?(a.text(number_format(l.monto,2)+".-",490,i),s+=l.monto):(a.text("("+number_format(l.monto,2)+".-)",490,i),s-=l.monto),a.text(s.toFixed(2)+".-",540,i),i+=30,19==++t&&(a.addPage({margin:0,bufferPages:!0}),i=120,t=0,r+=1,d.dibujarCabeceraPDFCajaChica(a,r,n,e),a.font("Helvetica",8))}a.rect(350,i+25,200,0).dash(1,{space:5}).stroke(),a.text("Encargado Caja Chica",350,i+30,{width:200,align:"center"}),a.text(d.usuario.persona.nombre_completo,350,i+40,{width:200,align:"center"}),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),u.stop()},d.dibujarCabeceraPDFCajaChica=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("CIERRE CAJA CHICA",0,25,{align:"center"}),e.font("Helvetica",8),e.text("DEL "+d.fechaATexto(i.inicio)+" AL "+d.fechaATexto(i.fin),0,35,{align:"center"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"}),e.font("Helvetica-Bold",8),e.text("Saldo Inicial : bs. "+number_format(i.saldo_inicial,2)+".-",45,60),e.font("Helvetica",8),e.rect(30,80,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("N°",45,90),e.text("Fecha",85,90,{width:50}),e.text("Nombre",150,90,{width:60}),e.text("Gasto",270,90,{width:50}),e.text("N° factura",430,90,{width:50}),e.text("Monto",490,90,{width:50}),e.text("Saldo",540,90,{width:50}),e.font("Helvetica",8)},d.generarPdfBoletaCajaChica=function(r,n,s){convertUrlToBase64Image(d.usuario.empresa.imagen,function(e){var a=e,o=new PDFDocument({size:"letter",margin:10}),i=o.pipe(blobStream()),t=45;d.dibujarPDFBoletaCajaChica(o,r,n,t,a,s),t+=370,o.rect(0,t-35,650,0).dash(2,{space:5}).stroke(),d.dibujarPDFBoletaCajaChica(o,r,n,t,a,s),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},d.dibujarPDFBoletaCajaChica=function(e,a,o,i,t,r){if(e.font("Helvetica-Bold",12),e.image(t,30,i-20,{fit:[80,80]}),"INGRESO"!=o.concepto.concepto.nombre?r?e.text("RENDICIÓN FONDOS CAJA CHICA",0,i+20,{align:"center"}):e.text("SALIDA CAJA CHICA",0,i+20,{align:"center"}):e.text("INGRESO CAJA CHICA",0,i+20,{align:"center"}),e.font("Helvetica-Bold",8),e.text(o.sucursal.nombre,0,i+30,{align:"center"}),e.text("Nro. "+o.numero_correlativo,0,i+40,{align:"center"}),e.rect(465,i,90,20).dash(0,{space:0}).stroke(),e.rect(435,i,30,20).dash(0,{space:0}).stroke(),e.rect(465,i+20,90,20).dash(0,{space:0}).stroke(),e.rect(435,i+20,30,20).dash(0,{space:0}).stroke(),e.text("Bs.",445,i+10),o.id_padre?e.text(o.pagado.toFixed(2),485,i+10):e.text(o.monto.toFixed(2),485,i+10),e.text("$us.",445,i+30),e.font("Helvetica",8),e.text("Fecha en texto",45,i+65),a)var n=a.solicitante.persona.nombre_completo;else n=d.usuario.empresa.razon_social;e.text("Recibí de .: "+n,45,i+80),o.id_padre?e.text("La suma de .: "+ConvertirALiteral(o.pagado.toFixed(2)),45,i+95):e.text("La suma de .: "+ConvertirALiteral(o.monto.toFixed(2)),45,i+95),"INGRESO"!=o.concepto.concepto.nombre&&(e.text("Bajo el concepto de: "+o.concepto.nombre,45,i+110),i+=15),e.text("Por concepto de:",45,i+110),e.font("Helvetica-Bold",8),e.text("DETALLE",200,i+125),e.text(o.detalle,55,i+155,{width:410}),e.text("IMPORTE",485,i+125),e.font("Helvetica",8),o.id_padre?e.text(o.pagado.toFixed(2),485,i+155):e.text(o.monto.toFixed(2),485,i+155),e.font("Helvetica",8),e.rect(45,i+120,420,20).dash(0,{space:0}).stroke().stroke(),e.rect(45,i+140,420,60).dash(0,{space:0}).stroke().stroke(),e.rect(465,i+120,90,20).dash(0,{space:0}).stroke().stroke(),e.rect(465,i+140,90,60).dash(0,{space:0}).stroke().stroke(),e.font("Helvetica",6),e.rect(70,i+275,100,0).dash(2,{space:5}).stroke(),"INGRESO"==o.concepto.concepto.nombre?(e.text("Autorizado",45,i+295,{width:150,align:"center"}),e.rect(250,i+275,100,0).dash(2,{space:5}).stroke(),e.text("Entregue Conforme",225,i+295,{width:150,align:"center"}),e.rect(450,i+275,100,0).dash(2,{space:5}).stroke(),e.text(d.usuario.persona.nombre_completo,425,i+285,{width:150,align:"center"}),e.text("Recibí Conforme",425,i+295,{width:150,align:"center"})):(e.text(a.usuario.persona.nombre_completo,45,i+285,{width:150,align:"center"}),e.text("Autorizado",45,i+295,{width:150,align:"center"}),e.rect(250,i+275,100,0).dash(2,{space:5}).stroke(),e.text(a.solicitante.persona.nombre_completo,225,i+285,{width:150,align:"center"}),e.text("Recibí Conforme",225,i+295,{width:150,align:"center"}),e.rect(450,i+275,100,0).dash(2,{space:5}).stroke(),e.text(d.usuario.persona.nombre_completo,425,i+285,{width:150,align:"center"}),e.text("Entregue Conforme",425,i+295,{width:150,align:"center"}));var s=new Date;e.text("Usuario.: "+d.usuario.nombre_usuario+" Hora.: "+s.getHours()+":"+s.getMinutes()+" imp.: "+d.fechaATexto(s),425,i+310,{width:150,align:"center"})},d.dibujarCuerpoPDFBoletaCajaChica=function(e,a,o,i){},d.verificarProducto=function(e){null!=d.cajaChica.compra.movimiento.clase&&d.cajaChica.compra.movimiento.clase.nombre==d.diccionario.MOVING_POR_RETENCION_BIENES&&(e.descuento=0,e.ice=0,e.recargo=0,e.excento=0,d.configuracionCompraVista.mostrar_it_retencion=!0,d.configuracionCompraVista.mostrar_iue=!0,d.configuracionCompraVista.mostrar_pagado=!0),d.agregarDetalleCompra(e)},d.verificarServicio=function(e){e.servicio.id?(null!=d.cajaChica.compra.movimiento.clase&&d.cajaChica.compra.movimiento.clase.nombre==d.diccionario.MOVING_POR_RETENCION_SERVICIOS&&(e.descuento=0,e.ice=0,e.recargo=0,e.excento=0,d.configuracionCompraVista.mostrar_it_retencion=!0,d.configuracionCompraVista.mostrar_iue=!0,d.configuracionCompraVista.mostrar_pagado=!0),d.agregarDetalleCompraServicio(e),d.verificarCamposDetalleCompra(e,!0)):d.mostrarMensaje("El producto no se encuentra en el catalogo")},d.agregarDetalleCompra=function(e){if(e.producto.nombre.id&&(e.producto=e.producto.nombre),e.centroCosto.nombre.id)e.centroCosto=e.centroCosto.nombre;else if(e.centroCosto.nombre==d.diccionario.CENTRO_COSTO_ALMACEN){var a=$.grep(d.centrosCosto,function(e){return e.nombre==d.diccionario.CENTRO_COSTO_ALMACEN})[0];e.centroCosto=a}e.fechaVencimientoTexto&&(e.fecha_vencimiento=new Date(d.convertirFecha(e.fechaVencimientoTexto))),d.cajaChica.compra.descuento_general&&(e.descuento=d.cajaChica.compra.descuento,e.ice=d.cajaChica.compra.ice,e.recargo=d.cajaChica.compra.recargo,e.excento=d.cajaChica.compra.excento),d.cajaChica.compra.detallesCompra.push(e),d.sumarTotal(),d.sumarTotalImporte(),d.cajaChica.compra.descuento_general&&d.calcularImporteGeneral(),d.cajaChica.compra.tipoPago.nombre==d.diccionario.TIPO_PAGO_CREDITO&&d.calcularSaldo(),d.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},d.cargarCentroCosto(d.detalleCompra)},d.agregarDetalleCompraServicio=function(e){d.cajaChica.compra.detallesCompra.push(e),d.sumarTotal(),d.sumarTotalImporte(),d.cajaChica.compra.descuento_general&&d.calcularImporteGeneral(),d.cajaChica.compra.tipoPago.nombre==d.diccionario.TIPO_PAGO_CREDITO&&d.calcularSaldo(),d.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},d.cargarCentroCosto(d.detalleCompra)},d.obtenerConfiguracionCompraVista=function(){u.start(),P(d.usuario.id_empresa).then(function(e){d.configuracionCompraVista=e,u.stop()})},d.guardarConfiguracionCompraVista=function(){b.update({id_empresa:d.usuario.id_empresa},d.configuracionCompraVista,function(e){})},d.eliminarDetalleCompra=function(e){d.cajaChica.compra.id?e.eliminado=!0:d.cajaChica.compra.detallesCompra.splice(d.cajaChica.compra.detallesCompra.indexOf(e),1),d.sumarTotal(),d.sumarTotalImporte(),d.cajaChica.compra.descuento_general&&d.calcularImporteGeneral(),d.cajaChica.compra.tipoPago.nombre==d.diccionario.TIPO_PAGO_CREDITO&&d.calcularSaldo()},d.sumarTotalImporte=function(){for(var e=0,a=0;a<d.cajaChica.compra.detallesCompra.length;a++)d.cajaChica.compra.detallesCompra[a].eliminado||(e+=d.cajaChica.compra.detallesCompra[a].importe);d.cajaChica.compra.importe=Math.round(1e3*e)/1e3},d.sumarTotal=function(){for(var e=0,a=0;a<d.cajaChica.compra.detallesCompra.length;a++)d.cajaChica.compra.detallesCompra[a].eliminado||(e+=d.cajaChica.compra.detallesCompra[a].total);d.cajaChica.compra.total=Math.round(1e3*e)/1e3},d.calcularSaldo=function(){d.cajaChica.compra.saldo=d.cajaChica.compra.total-d.cajaChica.compra.a_cuenta},d.calcularImporteGeneral=function(){var e,a;e=d.cajaChica.compra.tipo_descuento?d.cajaChica.compra.importe*(d.cajaChica.compra.descuento/100):d.cajaChica.compra.descuento,a=d.cajaChica.compra.tipo_recargo?d.cajaChica.compra.importe*(d.cajaChica.compra.recargo/100):d.cajaChica.compra.recargo,d.cajaChica.compra.total=Math.round(1e3*(d.cajaChica.compra.importe-e+a-d.cajaChica.compra.ice-d.cajaChica.compra.excento))/1e3},d.eliminarDetalleCompra=function(e){d.cajaChica.compra.id?e.eliminado=!0:d.cajaChica.compra.detallesCompra.splice(d.cajaChica.compra.detallesCompra.indexOf(e),1),d.sumarTotal(),d.sumarTotalImporte(),d.cajaChica.compra.descuento_general&&d.calcularImporteGeneral(),d.cajaChica.compra.tipoPago.nombre==d.diccionario.TIPO_PAGO_CREDITO&&d.calcularSaldo()},d.cambiarTipoPago=function(a){a=$.grep(d.tiposPago,function(e){return e.id==a.id})[0];d.esContado="CONT"==a.nombre_corto,d.cajaChica.compra.id_tipo_pago=a.id,d.esContado||d.calcularSaldo()},d.buscarProducto=function(e){if(""!=e&&null!=e&&d.busquedaProductoHabilidato)return D(d.usuario.id_empresa,e,d.usuario.id,d.compra.almacen.id)},d.establecerProducto=function(e){e.tipoProducto=null==e.tipoProducto?{id:e["tipoProducto.id"],nombre:e["tipoProducto.nombre"],nombre_corto:e["tipoProducto.nombre_corto"]}:e.tipoProducto;var a=d.detalleCompra.centroCosto;d.precio_inventario,0<e.inventarios.length?d.precio_inventario=e.inventarios.pop().costo_unitario+" Bs":d.precio_inventario="Sin histórico",d.detalleCompra={centroCosto:a,producto:e,precio_unitario:e.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:0<e.descuento,tipo_recargo:!1},d.cerrarPopup(d.idModalInventario),d.enfocar("cantidad")},d.calcularImporte=function(){var e,a;d.detalleCompra.importe=Math.round(d.detalleCompra.cantidad*d.detalleCompra.costo_unitario*1e3)/1e3,d.cajaChica.compra.movimiento.clase.nombre==d.diccionario.MOVING_POR_RETENCION_BIENES?d.cajaChica.compra.tipo_retencion?(d.detalleCompra.total=d.detalleCompra.importe,d.detalleCompra.importe=d.detalleCompra.total*(d.plantilla.retencionBienesGasto.it.porsentaje+d.plantilla.retencionBienesGasto.iue.porsentaje)/(100-(d.plantilla.retencionBienesGasto.it.porsentaje+d.plantilla.retencionBienesGasto.iue.porsentaje))+d.detalleCompra.total,d.detalleCompra.it=d.detalleCompra.importe*d.plantilla.retencionBienesGasto.it.porsentaje/100,d.detalleCompra.iue=d.detalleCompra.importe*d.plantilla.retencionBienesGasto.iue.porsentaje/100):(d.detalleCompra.it=d.detalleCompra.importe*d.plantilla.retencionBienesGasto.it.porsentaje/100,d.detalleCompra.iue=d.detalleCompra.importe*d.plantilla.retencionBienesGasto.iue.porsentaje/100,d.detalleCompra.total=d.detalleCompra.importe*d.plantilla.retencionBienesGasto.gasto.porsentaje/100):d.cajaChica.compra.movimiento.clase.nombre==d.diccionario.MOVING_POR_IMPORTACION?d.detalleCompra.total=d.detalleCompra.importe:d.cajaChica.compra.movimiento.clase.nombre==d.diccionario.MOVING_POR_RETENCION_SERVICIOS?d.cajaChica.compra.tipo_retencion?(d.detalleCompra.total=d.detalleCompra.importe,d.detalleCompra.importe=d.detalleCompra.total*(d.plantilla.retencionServicios.it.porsentaje+d.plantilla.retencionServicios.iue.porsentaje)/(100-(d.plantilla.retencionServicios.it.porsentaje+d.plantilla.retencionServicios.iue.porsentaje))+d.detalleCompra.total,d.detalleCompra.it=d.detalleCompra.importe*d.plantilla.retencionServicios.it.porsentaje/100,d.detalleCompra.iue=d.detalleCompra.importe*d.plantilla.retencionServicios.iue.porsentaje/100):(d.detalleCompra.it=d.detalleCompra.importe*d.plantilla.retencionServicios.it.porsentaje/100,d.detalleCompra.iue=d.detalleCompra.importe*d.plantilla.retencionServicios.iue.porsentaje/100,d.detalleCompra.total=d.detalleCompra.importe*d.plantilla.retencionServicios.servicio.porsentaje/100):d.cajaChica.compra.descuento_general?(e=d.cajaChica.compra.tipo_descuento?d.detalleCompra.importe*(d.cajaChica.compra.descuento/100):d.cajaChica.compra.descuento,a=d.cajaChica.compra.tipo_recargo?d.detalleCompra.importe*(d.cajaChica.compra.recargo/100):d.cajaChica.compra.recargo,d.detalleCompra.total=d.detalleCompra.importe-e+a-d.cajaChica.compra.ice-d.cajaChica.compra.excento):(e=d.detalleCompra.tipo_descuento?d.detalleCompra.importe*(d.detalleCompra.descuento/100):d.detalleCompra.descuento,a=d.detalleCompra.tipo_recargo?d.detalleCompra.importe*(d.detalleCompra.recargo/100):d.detalleCompra.recargo,d.detalleCompra.total=d.detalleCompra.importe-e+a-d.detalleCompra.ice-d.detalleCompra.excento),importe=d.cajaChica.compra.importe?d.cajaChica.compra.importe:0,d.totalRestante=d.cajaChica.solicitud.monto-importe,d.cajaChica.solicitud&&(d.detalleCompra.importe>d.totalRestante?(d.detalleCompra.importe=NaN,d.ErrorImporte=!0):d.ErrorImporte=!1)},d.calcularImporteDetalleEdicion=function(e){var a,o;e.importe=Math.round(e.cantidad*e.costo_unitario*1e3)/1e3,a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,o=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+o-e.ice-e.excento,d.sumarTotal(),d.sumarTotalImporte(),d.cajaChica.compra.descuento_general&&d.calcularImporteGeneral(),d.cajaChica.compra.tipoPago.nombre==d.diccionario.TIPO_PAGO_CREDITO&&d.calcularSaldo()},d.sumarMonto=function(e){for(var a=0,o=0;o<e.length;o++)a+=e[o].total;return Math.round(100*a)/100},d.obtenerCentrosDeCosto=function(){u.start(),r("CCO").then(function(e){if(d.centrosCosto=e.clases,d.usuario.empresa.usar_funciones_erp){var i=[];d.centrosCosto.forEach(function(e,a,o){"ALM"==e.nombre_corto||"VR"==e.nombre_corto||i.push(a)}),i.reverse().forEach(function(e,a,o){d.centrosCosto.splice(e,1)})}u.stop()})},d.obtenerconfiuracionCuentas=function(){var e=C(d.usuario.id_empresa);d.plantilla={retencionServicios:{it:{},iue:{},servicio:{}},retencionBienesGasto:{it:{},iue:{},gasto:{}},retencionBienes:{it:{},iue:{},almacen:{}},egreso:{ivacf:{},cajaBanco:{}},ingreso:{ivadf:{},it:{},itPorPagar:{},cajaBanco:{}}},e.then(function(e){e.lista.forEach(function(e){d.diccionario.IVA_DF==e.nombre&&(d.plantilla.ingreso.ivadf={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IT==e.nombre&&(d.plantilla.ingreso.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IT_POR_PAGAR==e.nombre&&(d.plantilla.ingreso.itPorPagar={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.CAJA_BANCOS==e.nombre&&(d.plantilla.ingreso.cajaBanco={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IVA_CF==e.nombre&&(d.plantilla.egreso.ivacf={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.CAJA_BANCOS==e.nombre&&(d.plantilla.egreso.cajaBanco={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IT_RETENCION_BIEN==e.nombre&&(d.plantilla.retencionBienes.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IUE_RETENCION_BIEN==e.nombre&&(d.plantilla.retencionBienes.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.CUENTA_ALMACEN_RETENCION_BIEN==e.nombre&&(d.plantilla.retencionBienes.almacen={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IT_RETENCION_BIEN_GASTO==e.nombre&&(d.plantilla.retencionBienesGasto.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IUE_RETENCION_BIEN_GASTO==e.nombre&&(d.plantilla.retencionBienesGasto.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.CUENTA_GASTO_RETENCION_BIEN==e.nombre&&(d.plantilla.retencionBienesGasto.gasto={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IT_RETENCION_SERVICIO==e.nombre&&(d.plantilla.retencionServicios.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.IUE_RETENCION_SERVICIO==e.nombre&&(d.plantilla.retencionServicios.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),d.diccionario.CUENTA_RETENCION_SERVICIO==e.nombre&&(d.plantilla.retencionServicios.servicio={porsentaje:parseFloat(e.valor),cuenta:e.cuenta})},this)})},d.obtenerServicios=function(){u.start(),t("SERVICIOS_COMPRA",d.usuario.id_empresa).then(function(e){d.datosServicios=e,u.stop()})},d.abrirDialogServicios=function(e){d.tipo_edicion=e,d.clase={},d.abrirPopup(d.idModalServicios)},d.cerrarDialogServicios=function(){d.cerrarPopup(d.idModalServicios)},d.agregarConceptoEdicion=function(e){e.nombre&&e.nombre_corto&&(-1==d.tipo_edicion.clases.indexOf(e)&&d.tipo_edicion.clases.push(e),d.clase={})},d.modificarConceptoEdicion=function(e){d.clase=e},d.removerConceptoEdicion=function(e){e.eliminado=!0},d.guardarConceptoEdicion=function(a){u.start(),Tipos.update({id_tipo:a.id},a,function(e){r(a.nombre_corto).then(function(e){a=e,u.stop(),d.cerrarDialogServicios(),d.mostrarMensaje("Guardado Exitosamente!")})})},d.establecerServicioSeleccionado=function(e){d.establecerServicio(e),d.cerrarDialogServicios()},d.establecerServicio=function(e){e.tipoProducto=null==e.tipoProducto?{id:e["tipoProducto.id"],nombre:e["tipoProducto.nombre"],nombre_corto:e["tipoProducto.nombre_corto"]}:e.tipoProducto;d.detalleCompra.centroCosto;d.detalleCompra={centroCosto:null,servicio:e,precio_unitario:e.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},d.cerrarPopup(d.idModalInventario),d.enfocar("cantidad")},d.verificarCamposDetalleCompra=function(e,a){a?(d.verificacionDatos=!1,d.verificacionDatos=!e.servicio.nombre):(d.verificacionDatos=!1,d.verificacionDatos=!e.producto.nombre),0==d.verificacionDatos&&(d.verificacionDatos=!(1<=e.cantidad),0==d.verificacionDatos&&(d.verificacionDatos=!(1e-4<=e.costo_unitario)))},d.$on("$routeChangeStart",function(e,a){d.eliminarPopup(d.idModalSolicitudCajaChica),d.eliminarPopup(d.idModalConceptosMovimiento),d.eliminarPopup(d.idModalEliminarSolicitud),d.eliminarPopup(d.idModalVerificarAutorizacion),d.eliminarPopup(d.idModalRegistroCajaChica),d.eliminarPopup(d.idModalKardexCajaChica),d.eliminarPopup(d.idModalIngresosCajaChica),d.eliminarPopup(d.idModalHistorialCierreCajaChica),d.eliminarPopup(d.idModalRegistroIngresoCajaChica),d.eliminarPopup(d.idModalRegistroDesembolsoCajaChica),d.eliminarPopup(d.idModalServicios),d.eliminarPopup(d.idModalRegistroAnticipoCajaChica)}),d.inicio()}]).controller("ControladorSolicitudCajaChica",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipoEmpresa","ClasesTipo","GuardarSolicitudCajaChica","GuardarConceptoMovimientoCajaChica","ObtenerConceptoMovimientoCajaChica","VerificarUsuarioEmpresaCaja","SolicitudesCajaPaginador","ObtenerTodoPersonal","$filter","Paginator","VerificarUsuarioEmpresa",function(i,e,a,o,t,r,n,s,c,l,d,u,p,m,f,g,v){i.usuario=JSON.parse(e.usuario),i.idModalSolicitudCajaChica="dialog-solicitud",i.idModalConceptosMovimiento="dialog-conceptos-movimiento",i.idModalEliminarSolicitud="dialog-eliminar-solicitud",i.idModalVerificarAutorizacion="modal-verificar-autorizacion",i.inicio=function(){i.obtenerTiposMovimiento(),i.obtenerConceptosMovimiento(),i.obtenerTiposEstados(),i.obtenerListaSolicitudes(),i.ConceptosMovimiento=[]},i.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsSolicitudCajaChicas(i.idModalSolicitudCajaChica,i.idModalConceptosMovimiento,i.idModalEliminarSolicitud,i.idModalVerificarAutorizacion),i.buscarAplicacion(i.usuario.aplicacionesUsuario,a.path().substring(1)),r.stop()}),i.abrirModalSolicitudCajaChica=function(e){null==e&&(i.solicitud={fecha:new Date}),i.filtrarPersonal(),i.abrirPopup(i.idModalSolicitudCajaChica)},i.cerrarModalSolicitudCajaChica=function(){i.cerrarPopup(i.idModalSolicitudCajaChica)},i.abrirModalConceptosMovimiento=function(){i.clase={edit:!1},i.abrirPopup(i.idModalConceptosMovimiento)},i.cerrarModalConceptosMovimiento=function(){i.cerrarPopup(i.idModalConceptosMovimiento)},i.abrirModalEliminarSolicitud=function(e){i.solicitud=e,i.abrirPopup(i.idModalEliminarSolicitud)},i.cerrarModalEliminarSolicitud=function(){i.cerrarPopup(i.idModalEliminarSolicitud)},i.abrirModalVerificarAutorizacion=function(e){i.solicitud=e,i.tipoDatosPermiso="autorizacion",i.abrirPopup(i.idModalVerificarAutorizacion)},i.cerrarModalVerificarAutorizacion=function(){i.cerrarPopup(i.idModalVerificarAutorizacion)},i.obtenerTiposMovimiento=function(){s("CM_CCH").then(function(e){i.tiposMovimientos=e})},i.obtenerTiposEstados=function(){s("ES_CCH").then(function(e){i.tiposEstados=e.clases})},i.obtenerConceptosMovimiento=function(){d(i.usuario.id_empresa).then(function(e){i.ConceptosMovimiento=e,i.cerrarModalConceptosMovimiento()})},i.AgregarConceptosMovimientoCajaChica=function(e){e.habilitado=!0,e.edit?i.clase={edit:!1}:i.ConceptosMovimiento.push(e)},i.editarConceptoMovimientoCajaChica=function(e){e.edit=!0,i.clase=e},i.cancelarEdicionConcepotMovimientoCajaChica=function(e){i.clase={edit:!1}},i.guardarConceptoMovimientoCajaChica=function(){l(i.usuario.id_empresa,i.ConceptosMovimiento).then(function(e){i.obtenerConceptosMovimiento(),i.mostrarMensaje(e.mensaje)})},i.guardarSolicitudCajaChica=function(){i.solicitud.usuario=i.usuario,i.tiposEstados.forEach(function(e,a,o){(i.usuario.autorizacion_caja_chica?(i.solicitud.autorizador=i.usuario.id,e.nombre===i.diccionario.CC_ESTADO_AUTORIZADO&&(i.solicitud.estado=e)):e.nombre===i.diccionario.CC_ESTADO_PENDIENTE&&(i.solicitud.estado=e),a===o.length-1)&&c(i.solicitud).then(function(e){i.obtenerListaSolicitudes(),i.cerrarModalSolicitudCajaChica(),i.mostrarMensaje(e.mensaje)})})},i.buscarPersonal=function(e){if(""!=e&&null!=e)return f("filter")(i.todoPersonal,e)},i.filtrarPersonal=function(e){void 0!==i.todoPersonal?i.personalProcesado=f("filter")(i.todoPersonal,e):m(i.usuario.empresa.id).then(function(e){i.todoPersonal=e.personal,i.personalProcesado=e.personal,void 0!==e.mensaje&&i.mostrarMensaje(e.mensaje)},function(e){i.mostrarMensaje("Se perdió la conexión.")})},i.establecerPersonal=function(e){e.id,e.persona.nombre_completo},i.obtenerListaSolicitudes=function(){i.paginator=g(),i.paginator.column="id",i.paginator.direccion="asc",i.paginator.itemsPerPage=10,i.filtro={empresa:i.usuario.id_empresa,inicio:"",fin:"",solicitante:"",usuario:"",estado:"",concepto:"",movimiento:"",id_usuario_no_autorizado:i.usuario.autorizacion_caja_chica?"":i.usuario.id},i.paginator.callBack=i.listaSolicitudesCajaChica,i.paginator.getSearch("",i.filtro,null)},i.listaSolicitudesCajaChica=function(){r.start(),p(i.paginator).then(function(e){r.stop(),i.paginator.setPages(e.paginas),i.solicitudesCajaChica=e.solicitudes})},i.verSolicitudCajaChica=function(e){i.solicitud=e,i.solicitud.ver=!0,i.abrirModalSolicitudCajaChica(!0)},i.editarSolicitudCajaChica=function(e){i.usuario.persona.id==e.usuario.persona.id&&(i.solicitud=e,i.abrirModalSolicitudCajaChica(!0))},i.eliminarSolicitud=function(){i.tiposEstados.forEach(function(e,a,o){(e.nombre===i.diccionario.CC_ESTADO_ANULADO&&(i.solicitud.estado=e),a===o.length-1)&&(i.solicitud.eliminado=!0,c(i.solicitud).then(function(e){i.obtenerListaSolicitudes(),i.cerrarModalEliminarSolicitud(),i.mostrarMensaje(e.mensaje)}))})},i.verificarPerimisoAutorizacion=function(e){e.nombre_usuario=i.usuario.nombre_usuario,u(i.usuario.id_empresa,e).then(function(e){e.type?(i.mostrarMensaje(e.message),"autorizacion"==i.tipoDatosPermiso&&i.tiposEstados.forEach(function(e,a,o){(e.nombre===i.diccionario.CC_ESTADO_AUTORIZADO&&(i.solicitud.estado=e),a===o.length-1)&&(i.solicitud.autorizador=i.usuario.id,c(i.solicitud).then(function(e){i.cerrarModalVerificarAutorizacion(),i.mostrarMensaje(e.mensaje)}))})):(i.cerrarModalVerificarAutorizacion(),i.mostrarMensaje(e.message))})},i.$on("$routeChangeStart",function(e,a){i.eliminarPopup(i.idModalSolicitudCajaChica),i.eliminarPopup(i.idModalConceptosMovimiento),i.eliminarPopup(i.idModalEliminarSolicitud),i.eliminarPopup(i.idModalVerificarAutorizacion)}),i.inicio()}]),angular.module("agil.controladores").controller("ControladorCierresCaja",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","Clases","CierreCaja","ListaCierresCaja","CierreCajaDatos","VentasContado","VentasCredito","PagosVenta","ConfiguracionImpresionEmpresaDato","ListaBancos","PagosCompra","ComprasContado","ComprasCredito","CierresCajaPendiente","Paginator","CierreCajaDatosItem",function(I,e,a,o,i,R,t,r,l,n,s,d,u,p,f,c,m,g,v,h,b,C){R.start(),I.idModalWizardCierreEdicion="modal-wizard-cierre",I.idModalDeposito="modal-deposito",I.idModalWizardCierreVista="modal-wizard-cierre-vista",I.idModalEliminarCierre="dialog-eliminar-cierre",I.idModalContenedorCierreEdicion="modal-wizard-container-cierre-edicion",I.idModalContenedorCierreVista="modal-wizard-container-cierre-vista",I.idModalDatosAdicionalesReporte="dialog-datos-adicionales-reporte-cierre",I.usuario=JSON.parse(e.usuario),I.inicio=function(){I.obtenerCierres(I.usuario.id_empresa),I.obtenerBancos(I.usuario.id_empresa),I.sucursalesUsuario="";for(var e=0;e<I.usuario.sucursalesUsuario.length;e++)I.sucursalesUsuario=I.sucursalesUsuario+I.usuario.sucursalesUsuario[e].sucursal.id,e+1!=I.usuario.sucursalesUsuario.length&&(I.sucursalesUsuario=I.sucursalesUsuario+",");t("DC").then(function(e){I.destinos=e.clases,R.stop()})},I.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsCierre(I.idModalWizardCierreEdicion,I.idModalContenedorCierreEdicion,I.idModalWizardCierreVista,I.idModalContenedorCierreVista,I.idModalEliminarCierre,I.idModalDeposito,I.idModalDatosAdicionalesReporte),I.buscarAplicacion(I.usuario.aplicacionesUsuario,a.path().substring(1))}),I.seleccionarCierresPendientes=function(e){for(var a=0;a<I.sucursales.length;a++)for(var o=0;o<sucursalesUsuario.length;o++)I.sucursales[a].id==sucursalesUsuario[o].id&&(I.sucursales[a].ticked=!0)},I.llenarCierresPendientes=function(e,a){e.cierresPendientesOpciones=[];for(var o=0;o<a.length;o++){var i={name:a[o].cierreCaja.usuario.nombre_usuario+" - "+a[o].cierreCaja.importe,maker:"",ticked:!1,id:a[o].id,importe:a[o].cierreCaja.importe,usuario:a[o].cierreCaja.usuario.nombre_usuario};e.cierresPendientesOpciones.push(i)}},I.cambiarCierrePendiente=function(e){console.log(e)},I.crearNuevoCierre=function(){var e=new Date,a=new Date,o=d(I.sucursalesUsuario,e,a,I.usuario.id,0);o.then(function(c){(o=u(I.sucursalesUsuario,e,a,I.usuario.id,0)).then(function(s){(o=p(I.sucursalesUsuario,e,a,I.usuario.id,0)).then(function(n){(o=m(I.sucursalesUsuario,e,a,I.usuario.id,0)).then(function(r){(o=g(I.sucursalesUsuario,e,a,I.usuario.id,0)).then(function(t){(o=v(I.sucursalesUsuario,e,a,I.usuario.id,0)).then(function(i){(o=h(I.sucursalesUsuario)).then(function(e){var a=!1;I.nuevosCierresCaja=[];for(var o=0;o<I.usuario.sucursalesUsuario.length;o++)I.cierreCaja=new l({fecha:new Date,id_empresa:I.usuario.id_empresa,id_usuario:I.usuario.id,saldo_inicial:0,gastos:0}),I.cierreCaja.ventasContado=$.grep(c,function(e){return e.almacen.id_sucursal==I.usuario.sucursalesUsuario[o].sucursal.id}),I.cierreCaja.ventasCredito=$.grep(s,function(e){return e.almacen.id_sucursal==I.usuario.sucursalesUsuario[o].sucursal.id}),I.cierreCaja.pagosVenta=$.grep(n,function(e){return e.venta.almacen.id_sucursal==I.usuario.sucursalesUsuario[o].sucursal.id}),I.cierreCaja.pagosCompra=$.grep(r,function(e){return e.compra.almacen.id_sucursal==I.usuario.sucursalesUsuario[o].sucursal.id}),I.cierreCaja.comprasContado=$.grep(t,function(e){return e.almacen.id_sucursal==I.usuario.sucursalesUsuario[o].sucursal.id}),I.cierreCaja.comprasCredito=$.grep(i,function(e){return e.almacen.id_sucursal==I.usuario.sucursalesUsuario[o].sucursal.id}),I.cierreCaja.cierresPendientesLeidos=$.grep(e,function(e){return e.id_sucursal==I.usuario.sucursalesUsuario[o].sucursal.id}),I.cierreCaja.sucursal=I.usuario.sucursalesUsuario[o].sucursal,I.cierreCaja.id_sucursal=I.usuario.sucursalesUsuario[o].sucursal.id,(0<I.cierreCaja.ventasContado.length||0<I.cierreCaja.ventasCredito.length||0<I.cierreCaja.pagosVenta.length||0<I.cierreCaja.pagosCompra.length||0<I.cierreCaja.comprasContado.length||0<I.cierreCaja.comprasCredito.length||0<I.cierreCaja.cierresPendientesLeidos.length)&&(a=!0,I.cierreCaja.cierresPendientes=[],0<I.cierreCaja.cierresPendientesLeidos.length&&I.llenarCierresPendientes(I.cierreCaja,I.cierreCaja.cierresPendientesLeidos),I.nuevosCierresCaja.push(I.cierreCaja));R.stop(),a?I.abrirPopup(I.idModalWizardCierreEdicion):(I.cerrarPopPupEdicion(),I.mostrarMensaje("No existen Movimientos!"))})})})})})})})},I.calcularImporteCierre=function(e){for(var a=0,o=0;o<e.cierresPendientes.length;o++)a+=e.cierresPendientes[o].importe;return e.importe=Math.round(100*(a+e.saldo_inicial+I.sumarVentasContado(e.ventasContado)+I.sumarVentasCredito(e.ventasCredito)-I.sumarComprasContado(e.comprasContado)-I.sumarComprasCredito(e.comprasCredito)+I.sumarPagosVenta(e.pagosVenta)-I.sumarPagosCompra(e.pagosCompra)-e.gastos))/100,e.importe},I.cerrarPopPupNuevoCierre=function(){I.cerrarPopup(I.idModalWizardCierreEdicion)},I.cerrarPopPupDeposito=function(){I.cerrarPopup(I.idModalDeposito)},I.verCierreCaja=function(e){I.cierreCaja=e,I.abrirPopup(I.idModalWizardCierreVista)},I.cerrarPopPupVista=function(){I.cerrarPopup(I.idModalWizardCierreVista)},I.cerrarPopPupEdicion=function(){I.cerrarPopup(I.idModalWizardCierreEdicion)},I.modificarCierre=function(e){I.cierreCaja=e,I.abrirPopup(I.idModalWizardCierreEdicion)},I.mostrarConfirmacionEliminacion=function(e){I.cierreCaja=new l(e),I.abrirPopup(I.idModalEliminarCierre)},I.cerrarConfirmacionEliminacion=function(){I.cerrarPopup(I.idModalEliminarCierre)},I.eliminarCierre=function(e){R.start(),I.cerrarConfirmacionEliminacion(),banco.$delete(),I.mostrarMensaje("Eliminado exitosamente!"),I.recargarItemsTabla(),R.stop()},I.cerrarCaja=function(e){var a=$("#siguiente").text().trim();if(console.log(a),"Siguiente"!=a){R.start();for(var o=0;o<e.length;o++)I.guardarCierreCaja(e[o]),I.generarReporteCierreCaja(e[o].sucursal,e[o],e[o].ventasContado,e[o].ventasCredito,e[o].pagosVenta,e[o].pagosCompra,e[o].comprasContado,e[o].comprasCredito,e[o].cierresPendientes);I.cerrarPopPupNuevoCierre(),I.recargarItemsTabla(),I.mostrarMensaje("Guardado Exitosamente!")}},I.mostrarDatosAdicionalesReporte=function(e){I.cierreCajaImpresion=e,I.abrirPopup(I.idModalDatosAdicionalesReporte)},I.cerrarPopupDatosAdicionalesReporte=function(){I.cerrarPopup(I.idModalDatosAdicionalesReporte)},I.imprimirCierreCaja=function(c){var l=C(c.id);l.then(function(e){c=e,I.cerrarPopup(I.idModalDatosAdicionalesReporte);var n=new Date,s=new Date;(l=d(I.sucursalesUsuario,n,s,c.id_usuario,c.id)).then(function(r){(l=u(I.sucursalesUsuario,n,s,c.id_usuario,c.id)).then(function(t){(l=p(I.sucursalesUsuario,n,s,c.id_usuario,c.id)).then(function(i){(l=m(I.sucursalesUsuario,n,s,c.id_usuario,c.id)).then(function(o){(l=g(I.sucursalesUsuario,n,s,c.id_usuario,c.id)).then(function(a){(l=v(I.sucursalesUsuario,n,s,c.id_usuario,c.id)).then(function(e){I.generarReporteCierreCaja(c.sucursal,c,r,t,i,o,a,e,c.cajasSiguienteTurnoCerradas)})})})})})})})},I.generarReporteCierreCaja=function(r,n,s,c,l,d,u,p,m){var e=f(I.usuario.id_empresa,0);console.log(n),e.then(function(e){var a=[612,792];if(e.usar){if(e.tamanoPapelCierreCaja.nombre_corto==I.diccionario.FACT_PAPEL_OFICIO)a=[612,936],I.imprimirReporteCierreCajaCartaOficio(r,a,n,s,c,l,d,u,p,m);else if(e.tamanoPapelCierreCaja.nombre_corto==I.diccionario.FACT_PAPEL_CARTA)a=[612,792],I.imprimirReporteCierreCajaCartaOficio(r,a,n,s,c,l,d,u,p,m);else if(e.tamanoPapelCierreCaja.nombre_corto==I.diccionario.FACT_PAPEL_MEDIOOFICIO)a=[612,468],I.imprimirReporteCierreCajaCartaOficio(r,a,n,s,c,l,d,u,p,m);else if(e.tamanoPapelCierreCaja.nombre_corto==I.diccionario.FACT_PAPEL_ROLLO){var o=s.length+c.length+l.length+d.length+u.length+p.length+m.length;if(n.conMovimientoProductos){for(var i=0;i<s.length;i++)o+=s[i].detallesVenta.length;for(i=0;i<c.length;i++)o+=c[i].detallesVenta.length;for(i=0;i<u.length;i++)o+=u[i].detallesCompra.length;for(i=0;i<p.length;i++)o+=p[i].detallesCompra.length}if(n.conSaldoProductos){for(i=0;i<s.length;i++)o+=s[i].detallesVenta.length;for(i=0;i<c.length;i++)o+=c[i].detallesVenta.length;for(i=0;i<u.length;i++)o+=u[i].detallesCompra.length;for(i=0;i<p.length;i++)o+=p[i].detallesCompra.length}t=o<=2?470:470+20*(o-2),console.log(o),a=[227,t],I.imprimirReporteCierreCajaRollo(r,a,n,s,c,l,d,u,p,m)}}else{var t;o=s.length+c.length+l.length+d.length+u.length+p.length+m.length;if(n.conMovimientoProductos){for(i=0;i<s.length;i++)o+=s[i].detallesVenta.length;for(i=0;i<c.length;i++)o+=c[i].detallesVenta.length;for(i=0;i<u.length;i++)o+=u[i].detallesCompra.length;for(i=0;i<p.length;i++)o+=p[i].detallesCompra.length}if(n.conSaldoProductos){for(i=0;i<s.length;i++)o+=s[i].detallesVenta.length;for(i=0;i<c.length;i++)o+=c[i].detallesVenta.length;for(i=0;i<u.length;i++)o+=u[i].detallesCompra.length;for(i=0;i<p.length;i++)o+=p[i].detallesCompra.length}t=o<=2?470:470+20*(o-2),console.log(o),a=[227,t],I.imprimirReporteCierreCajaRollo(r,a,n,s,c,l,d,u,p,m)}})},I.imprimirReporteCierreCajaCartaOficio=function(e,a,o,i,t,r,n,s,c,l){var d=new PDFDocument({size:a,margin:0}),u=d.pipe(blobStream());d.font("Helvetica-Bold",15),d.text("CIERRE DE CAJA",55,50),d.text("SUCURSAL: "+e.nombre,200,50),d.font("Helvetica-Bold",8),d.text("SALDO INICIAL: ",55,80),d.text(o.saldo_inicial,350,80),d.font("Helvetica-Bold",8),d.text("VENTAS AL CONTADO: ",55,100),d.font("Helvetica",8);for(var p=100,m=0,f=0,g=0,v=0;v<i.length;v++)d.text("No. "+i[v].factura,55,p+20),d.text(i[v].cliente.razon_social,100,p+20),d.text(i[v].total,300,p+20),m+=i[v].total,p+=20;d.font("Helvetica-Bold",8),d.text(m,350,100),d.font("Helvetica-Bold",8),d.text("VENTAS AL CREDITO: ",55,p+20),d.font("Helvetica",8);var h=p+20;p+=20;var b=0;for(v=0;v<t.length;v++)0<t[v].pagosVenta.length?0<t[v].pagosVenta[0].a_cuenta_anterior&&(d.text("No. "+t[v].factura,55,p+20),d.text(t[v].cliente.razon_social,100,p+20),d.text(t[v].pagosVenta[0].a_cuenta_anterior,300,p+20),b+=t[v].pagosVenta[0].a_cuenta_anterior,p+=20):t[v].a_cuenta&&(d.text("No. "+t[v].factura,55,p+20),d.text(t[v].cliente.razon_social,100,p+20),d.text(t[v].a_cuenta,300,p+20),b+=t[v].a_cuenta,p+=20);d.font("Helvetica-Bold",8),d.text(b,350,h),d.font("Helvetica-Bold",8),d.text("COMPRAS AL CONTADO: ",55,p+20),d.font("Helvetica",8);var C=p+20;p+=20;var P=0;for(v=0;v<s.length;v++)d.text("No. "+s[v].factura,55,p+20),d.text(s[v].proveedor.razon_social,100,p+20),d.text(s[v].total,300,p+20),P+=s[v].total,p+=20;d.font("Helvetica-Bold",8),d.text(P,350,C),d.text("COMPRAS AL CREDITO: ",55,p+20),d.font("Helvetica",8);var _=p+20;p+=20;var M=0;for(v=0;v<c.length;v++)0<c[v].pagosCompra.length?0<c[v].pagosCompra[0].a_cuenta_anterior&&(d.text("No. "+c[v].factura,55,p+20),d.text(c[v].proveedor.razon_social,100,p+20),d.text(c[v].pagosCompra[0].a_cuenta_anterior,300,p+20),M+=c[v].pagosCompra[0].a_cuenta_anterior,p+=20):c[v].a_cuenta&&(d.text("No. "+c[v].factura,55,p+20),d.text(c[v].proveedor.razon_social,100,p+20),d.text(c[v].a_cuenta,300,p+20),M+=c[v].a_cuenta,p+=20);d.font("Helvetica-Bold",8),d.text(M,350,_);var D=p+20;d.text("COBROS REALIZADOS: ",55,p+20),d.font("Helvetica",8),p+=20;for(v=0;v<r.length;v++)d.text("No. "+r[v].venta.factura,55,p+20),d.text(r[v].venta.cliente.razon_social,100,p+20),d.text(r[v].monto_pagado,300,p+20),f+=r[v].monto_pagado,p+=20;d.text(f,350,D),d.font("Helvetica-Bold",8);var E=p+20;d.text("PAGOS REALIZADOS: ",55,p+20),d.font("Helvetica",8),p+=20;for(v=0;v<n.length;v++)d.text("No. "+n[v].compra.factura,55,p+20),d.text(n[v].compra.proveedor.razon_social,100,p+20),d.text(n[v].monto_pagado,300,p+20),g+=n[v].monto_pagado,p+=20;d.text(g,350,E),d.font("Helvetica-Bold",8),d.text("GASTOS: ",55,p+40),d.text(o.gastos,350,p+40),d.text("SALDO FINAL CAJA: ",55,p+60),d.text(o.importe,350,p+60),d.text("---------------------------------------------                       ---------------------------------------------",0,p+100,{align:"center"}),d.text("ENTREGUE CONFORME                                     RECIBI CONFORME",0,p+130,{align:"center"}),d.end(),u.on("finish",function(){var e=u.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),R.stop()},I.imprimirReporteCierreCajaRollo=function(e,a,o,i,t,r,n,s,c,l){var d=new PDFDocument({size:a,margins:{top:10,bottom:10,left:10,right:20}}),u=d.pipe(blobStream());if(o.fecha=new Date(o.fecha),d.moveDown(2),d.font("Helvetica-Bold",8),d.text("CIERRE DE CAJA",{align:"center"}),d.text("SUCURSAL: "+e.nombre,{align:"center"}),d.text("DEL: "+o.fecha.getDate()+"/"+(o.fecha.getMonth()+1)+"/"+o.fecha.getFullYear(),{align:"center"}),0<l.length){d.moveDown(.4);var p=d.y;d.text("SALDO ANTERIORES TURNOS: ",{align:"left"}),d.font("Helvetica",8),d.moveDown(.4);for(var m=d.y,f=0,g=0;g<l.length;g++)d.text(l[g].cierreCaja?l[g].cierreCaja.usuario.nombre_usuario:l[g].usuario,60,m,{width:90}),d.text(l[g].cierreCaja?l[g].cierreCaja.importe:l[g].importe,150,m),f+=l[g].cierreCaja?l[g].cierreCaja.importe:l[g].importe,m+=20;d.font("Helvetica-Bold",8),d.text(f,0,p,{align:"right"}),d.y=m,d.moveDown(.4),d.x=10}d.moveDown(.4),d.font("Helvetica-Bold",8);var v=d.y;d.text("SALDO INICIAL: ",{align:"left",width:100}),d.text(o.saldo_inicial,0,v,{align:"right"}),d.x=10,d.moveDown(.8),d.font("Helvetica-Bold",8);var h=d.y;d.text("VENTAS AL CONTADO: ",{align:"left"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y,suma=0,sumaPago=0;for(g=sumaCobro=0;g<i.length;g++)d.text("No. "+i[g].factura,20,m),d.text(i[g].cliente.razon_social,60,m,{width:90}),d.text(i[g].total,150,m),suma+=i[g].total,m+=20;d.font("Helvetica-Bold",8),d.text(suma,0,h,{align:"right"}),d.y=m,d.moveDown(.4),d.x=10,d.font("Helvetica-Bold",8);var b=d.y;d.text("VENTAS AL CREDITO: ",{align:"left"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y;var C=0;for(g=0;g<t.length;g++)0<t[g].pagosVenta.length?0<t[g].pagosVenta[0].a_cuenta_anterior&&(d.text("No. "+t[g].factura,20,m),d.text(t[g].cliente.razon_social,60,m,{width:90}),d.text(t[g].pagosVenta[0].a_cuenta_anterior,150,m),C+=t[g].pagosVenta[0].a_cuenta_anterior,m+=20):(d.text("No. "+t[g].factura,20,m),d.text(t[g].cliente.razon_social,60,m,{width:90}),d.text(t[g].a_cuenta,150,m),C+=t[g].a_cuenta,m+=20);d.font("Helvetica-Bold",8),d.text(C,0,b,{align:"right"}),d.y=m,d.moveDown(.4),d.x=10,d.font("Helvetica-Bold",8);var P=d.y;d.text("COMPRAS AL CONTADO: ",{align:"left"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y;var _=0;for(g=0;g<s.length;g++)d.text("No. "+s[g].factura,20,m),d.text(s[g].proveedor.razon_social,60,m,{width:90}),d.text(s[g].total,150,m),_+=s[g].total,m+=20;d.font("Helvetica-Bold",8),d.text(_,0,P,{align:"right"}),d.y=m,d.moveDown(.4),d.x=10;var M=d.y;d.text("COMPRAS AL CREDITO: ",{align:"left"}),d.font("Helvetica",8),m=d.y;var D=0;for(g=0;g<c.length;g++)0<c[g].pagosCompra.length?0<c[g].pagosCompra[0].a_cuenta_anterior&&(d.text("No. "+c[g].factura,20,m),d.text(c[g].proveedor.razon_social,60,m),d.text(c[g].pagosCompra[0].a_cuenta_anterior,150,m),D+=c[g].pagosCompra[0].a_cuenta_anterior,m+=20):c[g].a_cuenta&&(d.text("No. "+c[g].factura,20,m),d.text(c[g].proveedor.razon_social,60,m),d.text(c[g].a_cuenta,150,m),D+=c[g].a_cuenta,m+=20);d.font("Helvetica-Bold",8),d.text(D,0,M,{align:"right"}),d.y=m,d.moveDown(.4),d.x=10;var E=d.y;d.text("COBROS REALIZADOS: ",{align:"left"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y;for(g=0;g<r.length;g++)d.text("No. "+r[g].venta.factura,20,m),d.text(r[g].venta.cliente.razon_social,60,m,{width:90}),d.text(r[g].monto_pagado,150,m),sumaPago+=r[g].monto_pagado,m+=20;d.font("Helvetica-Bold",8),d.text(sumaPago,0,E,{align:"right"}),d.y=m,d.moveDown(.4),d.x=10;var x=d.y;d.text("PAGOS REALIZADOS: ",{align:"left"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y;for(g=0;g<n.length;g++)d.text("No. "+n[g].compra.factura,20,m),d.text(n[g].compra.proveedor.razon_social,60,m,{width:90}),d.text(n[g].monto_pagado,150,m),sumaCobro+=n[g].monto_pagado,m+=20;if(d.font("Helvetica-Bold",8),d.text(sumaCobro,0,x,{align:"right"}),d.y=m,d.moveDown(.4),d.x=10,d.font("Helvetica-Bold",8),v=d.y,d.text("GASTOS: ",{align:"left"}),d.text(o.gastos,0,v,{align:"right"}),d.x=10,d.moveDown(.4),v=d.y,d.text("SALDO FINAL CAJA: ",{align:"left"}),d.text(o.importe,0,v,{align:"right"}),d.moveDown(1.6),d.x=10,o.conMovimientoProductos){d.font("Helvetica-Bold",8),d.text("RESUMEN MOVIMIENTOS VENTA PRODUCTOS: ",{align:"center"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y;for(g=0;g<i.length;g++)for(var S=0;S<i[g].detallesVenta.length;S++)d.text(i[g].detallesVenta[S].cantidad,20,m),d.text(i[g].detallesVenta[S].producto.nombre,50,m,{width:100}),d.text(i[g].detallesVenta[S].total,160,m),m+=20;for(g=0;g<t.length;g++)for(S=0;S<t[g].detallesVenta.length;S++)d.text(t[g].detallesVenta[S].cantidad,20,m),d.text(t[g].detallesVenta[S].producto.nombre,50,m,{width:100}),d.text(t[g].detallesVenta[S].total,160,m),m+=20;d.y=m,d.moveDown(.4),d.x=10,d.font("Helvetica-Bold",8),d.text("RESUMEN MOVIMIENTOS COMPRA PRODUCTOS: ",{align:"center"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y;for(g=0;g<s.length;g++)for(S=0;S<s[g].detallesCompra.length;S++)d.text(s[g].detallesCompra[S].cantidad,20,m),d.text(s[g].detallesCompra[S].producto.nombre,50,m,{width:100}),d.text(s[g].detallesCompra[S].total,160,m),m+=20;for(g=0;g<c.length;g++)for(S=0;S<c[g].detallesCompra.length;S++)d.text(c[g].detallesCompra[S].cantidad,20,m),d.text(c[g].detallesCompra[S].producto.nombre,50,m,{width:100}),d.text(c[g].detallesCompra[S].total,160,m),m+=20;d.y=m,d.moveDown(.4),d.x=10}if(o.conSaldoProductos){d.font("Helvetica-Bold",8),d.text("RESUMEN SALDOS DE VENTA PRODUCTOS: ",{align:"center"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y;for(g=0;g<i.length;g++)for(S=0;S<i[g].detallesVenta.length;S++){d.text(i[g].detallesVenta[S].producto.nombre,50,m,{width:100});for(var A=0,T=0;T<i[g].detallesVenta[S].producto.inventarios.length;T++)i[g].detallesVenta[S].producto.inventarios[T].almacen.id_sucursal==e.id&&(A+=i[g].detallesVenta[S].producto.inventarios[T].cantidad);d.text(A+" Und.",160,m),m+=20}for(g=0;g<t.length;g++)for(S=0;S<t[g].detallesVenta.length;S++){d.text(t[g].detallesVenta[S].producto.nombre,50,m,{width:100});for(A=0,T=0;T<t[g].detallesVenta[S].producto.inventarios.length;T++)t[g].detallesVenta[S].producto.inventarios[T].almacen.id_sucursal==e.id&&(A+=t[g].detallesVenta[S].producto.inventarios[T].cantidad);d.text(A+" Und.",160,m),m+=20}d.y=m,d.moveDown(.4),d.x=10,d.font("Helvetica-Bold",8),d.text("RESUMEN SALDOS DE COMPRA PRODUCTOS: ",{align:"center"}),d.font("Helvetica",8),d.moveDown(.4),m=d.y;for(g=0;g<s.length;g++)for(S=0;S<s[g].detallesCompra.length;S++){d.text(s[g].detallesCompra[S].producto.nombre,50,m,{width:100});for(A=0,T=0;T<s[g].detallesCompra[S].producto.inventarios.length;T++)s[g].detallesCompra[S].producto.inventarios[T].almacen.id_sucursal==e.id&&(A+=s[g].detallesCompra[S].producto.inventarios[T].cantidad);d.text(A+" Und.",160,m),m+=20}for(g=0;g<c.length;g++)for(S=0;S<c[g].detallesCompra.length;S++){d.text(c[g].detallesCompra[S].producto.nombre,50,m,{width:100});for(A=0,T=0;T<c[g].detallesCompra[S].producto.inventarios.length;T++)c[g].detallesCompra[S].producto.inventarios[T].almacen.id_sucursal==e.id&&(A+=c[g].detallesCompra[S].producto.inventarios[T].cantidad);d.text(A+" Und.",160,m),m+=20}d.y=m,d.moveDown(.4),d.x=10}d.font("Helvetica-Bold",8),d.x=10,d.text("-----------------------------      -----------------------------",0,m+100,{align:"center"}),d.text("ENTREGUE CONFORME   RECIBI CONFORME",{align:"center"}),d.moveDown(.4),d.font("Helvetica",8);var w=new Date;d.text("Usuario: "+I.usuario.nombre_usuario+" "+w.getDate()+"/"+(w.getMonth()+1)+"/"+w.getFullYear()+" "+w.getHours()+":"+w.getMinutes(),{align:"center"}),d.end(),u.on("finish",function(){var e=u.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),R.stop()},I.sumarVentasContado=function(e){for(var a=0,o=0;o<e.length;o++)a+=e[o].total;return a},I.sumarVentasCredito=function(e){for(var a=0,o=0;o<e.length;o++)0<e[o].pagosVenta.length?0<e[o].pagosVenta[0].a_cuenta_anterior&&(a+=e[o].pagosVenta[0].a_cuenta_anterior):a+=e[o].a_cuenta;return a},I.sumarComprasContado=function(e){for(var a=0,o=0;o<e.length;o++)a+=e[o].total;return a},I.sumarComprasCredito=function(e){for(var a=0,o=0;o<e.length;o++)0<e[o].pagosCompra.length?0<e[o].pagosCompra[0].a_cuenta_anterior&&(a+=e[o].pagosCompra[0].a_cuenta_anterior):e[o].a_cuenta&&(a+=e[o].a_cuenta);return a},I.sumarPagosVenta=function(e){for(var a=0,o=0;o<e.length;o++)a+=e[o].monto_pagado;return a},I.sumarPagosCompra=function(e){for(var a=0,o=0;o<e.length;o++)a+=e[o].monto_pagado;return a},I.guardarCierreCaja=function(e){R.start(),e.$save(function(e){R.stop()},function(e){R.stop(),I.cerrarPopPupNuevoCierre(),I.mostrarMensaje("Ocurrio un problema al momento de guardar!"),I.recargarItemsTabla()})},I.guardarDeposito=function(e){R.start(),e.fecha_entrega=new Date(I.convertirFecha(e.fechaEntregaTexto)),s.update({id_cierre_caja:e.id},e,function(e){R.stop(),I.cerrarPopPupDeposito(),I.mostrarMensaje("Guardado Exitosamente!"),I.recargarItemsTabla()})},I.obtenerCierres=function(e){I.paginator=b(),I.paginator.column="fecha",I.paginator.direction="desc",I.paginator.callBack=I.obtenerLista;var a=0<$.grep(I.usuario.rolesUsuario,function(e){return e.rol.nombre==I.diccionario.ROL_ADMINISTRADOR}).length?0:I.usuario.id;I.filtro={empresa:I.usuario.id_empresa,usuario:a},I.paginator.getSearch("",I.filtro,null)},I.obtenerLista=function(){R.start(),n(I.paginator).then(function(e){I.paginator.setPages(e.paginas),I.cierresCaja=e.cierresCaja,R.stop()})},I.abrirPopupDeposito=function(e){I.cierreCaja=e,I.abrirPopup(I.idModalDeposito)},I.obtenerBancos=function(e){R.start(),c(e).then(function(e){I.bancos=e,R.stop()})},I.$on("$routeChangeStart",function(e,a){I.eliminarPopup(I.idModalWizardCierreEdicion),I.eliminarPopup(I.idModalWizardCierreVista),I.eliminarPopup(I.idModalEliminarCierre),I.eliminarPopup(I.idModalDeposito),I.eliminarPopup(I.idModalDatosAdicionalesReporte)}),I.inicio()}]),angular.module("agil.controladores").controller("ControladorClientes",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","$timeout","ClientesPaginador","Cliente","Clientes","Empresas","ClientesEmpresa","uiGmapGoogleMapApi","$cordovaGeolocation","DatoCodigoSiguienteClienteEmpresa","DestinosCliente","RazonesSocialesCliente","ClasesTipoEmpresa","Diccionario","Tipos","ClasesTipo","VerificarUsuarioEmpresa",function(d,e,i,a,o,t,u,n,s,p,c,l,m,f,g,v,h,b,C,P,_,M,D){u.start(),d.usuario=JSON.parse(i.usuario),d.idModalConceptoEdicionCorrelativos="dialog-conceptos-correlativos",d.IdModalVerificarCuenta="modal-verificar-cuenta",d.inicio=function(){d.diccionario=P,d.obtenerEmpresas(),d.obtenerClientes(),d.obtenerDestinos(),d.obtenerTiposPrecio(),f.then(function(e){console.log(e),d.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},d.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE}})},d.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsCliente("modal-wizard-cliente","modal-wizard-cliente-vista","dialog-eliminar-cliente","modal-wizard-container-cliente-edicion","modal-wizard-container-cliente-vista",d.idModalConceptoEdicionCorrelativos,d.IdModalVerificarCuenta),d.buscarAplicacion(d.usuario.aplicacionesUsuario,a.path().substring(1)),u.stop()}),d.obtenerCorrelativoCliente=function(){u.start(),C("correlativo_clientes",d.usuario.id_empresa).then(function(e){1<e.clases.length?e.clases.sort(function(e,a){return e.correlativo=e.nombre_corto.split("-")[0],e.correlativo_maximo=e.nombre_corto.split("-")[1],a.correlativo=a.nombre_corto.split("-")[0],a.correlativo_maximo=a.nombre_corto.split("-")[1],e.correlativo-a.correlativo}):1==e.clases.length&&(e.clases[0].correlativo=e.clases[0].nombre_corto.split("-")[0],e.clases[0].correlativo_maximo=e.clases[0].nombre_corto.split("-")[1]),d.correlativosClientes=e,u.stop()})},d.cargarCodigo=function(e){e.codigo=e.correlativo.correlativo},d.obtenerClientes=function(){d.abs=e.Math.abs,d.itemsPorPagina=10,d.buscarClientes(1,d.itemsPorPagina,"")},d.verificarPulso=function(e,a){13===e.keyCode&&d.buscarClientes(1,d.itemsPorPagina,a)},d.buscarClientes=function(e,a,o){u.start(),d.itemsPorPagina=a,""==o||null==o?o=0:d.textoBusqueda=o,d.paginaActual=e,s(d.usuario.id_empresa,e,a,o).then(function(e){d.paginas=[];for(var a=1;a<=e.paginas;a++)d.paginas.push(a);d.clientes=e.clientes,u.stop()})},d.abrirPopupCliente=function(e){d.mostrarMap=!1,d.cliente=e,d.map={center:{latitude:d.cliente.latitud,longitude:d.cliente.longitud},zoom:17,bounds:{northeast:{latitude:d.cliente.latitud,longitude:d.cliente.longitud}}},d.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE},d.coordsUpdates=0,d.dynamicMoveCtr=0,d.marker={id:0,coords:{latitude:d.cliente.latitud,longitude:d.cliente.longitud},options:{draggable:!0},events:{dragend:function(e,a,o){d.cliente.latitud=e.getPosition().lat(),d.cliente.longitud=e.getPosition().lng(),d.marker.options={draggable:!0,labelAnchor:"100 0",labelClass:"marker-labels"}}}},d.abrirPopup("modal-wizard-cliente")},d.mostrarMapa=function(){d.mostrarMap=!0,n(function(){d.$apply(function(){google.maps.event.trigger(d.map,"resize")})},2e3)},d.crearNuevoCliente=function(){d.obtenerCorrelativoCliente(),d.steps=[{cabeza:"cabeza-datos-cli",cuerpo:"cuerpo-datos-cli"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"}],console.log(d.steps),v(d.usuario.id_empresa).then(function(e){d.ultimo_codigo=e.ultimo_codigo?"CLI"+e.ultimo_codigo:0;var a=JSON.parse(i.usuario),o=new p({id_empresa:a.id_empresa,latitud:-17.403800007775388,longitud:-66.11349012184144,clientes_razon:[],cliente_destinos:[]});o.codigo="CLI"+((e.ultimo_codigo?e.ultimo_codigo:0)+1),d.abrirPopupCliente(o)})},d.verCliente=function(e){(d.cliente=e).fecha1=new Date(e.fecha1),e.fecha2=new Date(e.fecha2),d.cliente.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear(),d.cliente.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear(),d.abrirPopup("modal-wizard-cliente-vista")},d.cerrarPopPupVista=function(){d.cerrarPopup("modal-wizard-cliente-vista")},d.cerrarPopPupNuevoCliente=function(){d.cerrarPopup("modal-wizard-cliente")},d.modificarCliente=function(e){e.fecha1&&(e.fecha1=new Date(e.fecha1),e.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear()),e.fecha2&&(e.fecha2=new Date(e.fecha2),e.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear()),d.abrirPopupCliente(e)},d.verCliente=function(e){(d.cliente=e).fecha1=new Date(e.fecha1),e.fecha2=new Date(e.fecha2),d.cliente.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear(),d.cliente.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear(),d.abrirPopup("modal-wizard-cliente-vista")},d.cerrarPopPupVista=function(){d.cerrarPopup("modal-wizard-cliente-vista")},d.cerrarPopPupNuevoCliente=function(){d.cerrarPopup("modal-wizard-cliente")},d.modificarCliente=function(e){e.fecha1&&(e.fecha1=new Date(e.fecha1),e.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear()),e.fecha2&&(e.fecha2=new Date(e.fecha2),e.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear()),d.abrirPopupCliente(e)},d.mostrarConfirmacionEliminacion=function(e){d.cliente=new p(e),d.abrirPopup("dialog-eliminar-cliente")},d.cerrarConfirmacionEliminacion=function(){d.cerrarPopup("dialog-eliminar-cliente")},d.eliminarCliente=function(e){u.start(),d.cerrarConfirmacionEliminacion(),e.$delete(),d.mostrarMensaje("Eliminado exitosamente!"),d.recargarItemsTabla(),u.stop()},d.saveForm=function(t,e){if("Siguiente"!=$("#siguiente").text().trim()){u.start();var a=document.getElementById("doc-nit").files[0],o=document.getElementById("doc-funda").files[0],i=document.getElementById("doc-licencia").files[0],n=document.getElementById("doc-ci").files[0],s=document.getElementById("doc-seguro-social").files[0],c=[];[a,o,i,n,s].forEach(function(e,a,o){e&&c.push(e),a==o.length-1&&(0<c.length?c.forEach(function(a,o,i){r=new FileReader,a?(r.onloadend=function(e){a.nombre=a.name,a.data=e.target.result,o===i.length-1&&(t.fecha1=null,t.fechatexto1&&(t.fecha1=new Date(d.convertirFecha(t.fechatexto1))),t.fecha2=null,t.fechatexto2&&(t.fecha2=new Date(d.convertirFecha(t.fechatexto2))),t.id?p.update({idCliente:t.id},t,function(e){u.stop(),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje(e.mensaje),d.recargarItemsTabla()}):t.$save(function(e){u.stop(),d.cliente=new p({}),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje(e.mensaje),d.recargarItemsTabla()},function(e){u.stop(),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()}))},r.readAsBinaryString(a)):o===i.length-1&&(t.fecha1=null,t.fechatexto1&&(t.fecha1=new Date(d.convertirFecha(t.fechatexto1))),t.fecha2=null,t.fechatexto2&&(t.fecha2=new Date(d.convertirFecha(t.fechatexto2))),t.id?p.update({idCliente:t.id},t,function(e){u.stop(),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje(e.mensaje),d.recargarItemsTabla()}):t.$save(function(e){u.stop(),d.cliente=new p({}),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje(e.mensaje),d.recargarItemsTabla()},function(e){u.stop(),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()}))}):(t.fecha1=null,t.fechatexto1&&(t.fecha1=new Date(d.convertirFecha(t.fechatexto1))),t.fecha2=null,t.fechatexto2&&(t.fecha2=new Date(d.convertirFecha(t.fechatexto2))),t.id?p.update({idCliente:t.id},t,function(e){u.stop(),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje(e.mensaje),d.recargarItemsTabla()}):t.$save(function(e){u.stop(),d.cliente=new p({}),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje(e.mensaje),d.recargarItemsTabla()},function(e){u.stop(),d.cerrarPopPupNuevoCliente(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()})))})}if(!d.usuario.usar_creditos){var l=$("#credito").attr("class");console.log(l),"ng-hide active"==l&&$("#siguiente").click()}if(!d.usuario.usar_razon_social){l=$("#razonsocial").attr("class");console.log(l),"ng-hide active"==l&&$("#siguiente").click()}if(!d.usuario.destinos){l=$("#destinos").attr("class");console.log(l),"ng-hide active"==l&&$("#siguiente").click()}},d.regresarwizard=function(){if(!d.usuario.destinos){var e=$("#destinos").attr("class");console.log(e),"ng-hide complete"==e&&$("#anterior").click()}if(!d.usuario.usar_razon_social){e=$("#razonsocial").attr("class");console.log(e),"ng-hide complete"==e&&$("#anterior").click()}if(!d.usuario.usar_creditos){e=$("#credito").attr("class");console.log(e),"ng-hide complete"==e&&$("#anterior").click()}},d.obtenerEmpresas=function(){u.start(),l().then(function(e){d.empresas=e,u.stop()})},d.agregarClienteRazon=function(e){e.nit&&e.razon_social&&(-1==d.cliente.clientes_razon.indexOf(e)&&d.cliente.clientes_razon.push(e),d.cliente_razon={})},d.modificarClienteRazon=function(e){d.cliente_razon=e},d.removerClienteRazon=function(e){e.eliminado=!0},d.obtenerDestinos=function(){h(d.usuario.id_empresa).then(function(e){d.destinos=e})},d.agregarDestino=function(e){if(e.id){var a={id_destino:e.id,destino:e};-1==d.cliente.cliente_destinos.indexOf(a)&&d.cliente.cliente_destinos.push(a),d.dato_destino={}}},d.removerDestino=function(e){e.eliminado=!0},d.generarExcelComprobacionDatosClientes=function(e,a){d.obtenerClientes();for(var o=[["N°","CODIGO","CLIENTE","NIT PRINCIPAL","RAZÓN SOCIAL PRINCIPAL","DIRECCION","TELEFONO UNO","TELEFONO DOS","TELEFONO TRES","UBIC. GEO.","RUBRO","CATEGORIA","FECHA IMP. 1","FECHA IMP. 2","TEXTO 1","TEXTO 2","RAZONES CLIENTE","NIT -RAZON","CODIGO SAP","DESTINOS","DIRECCION DESTINO"]],i=0;i<d.clientes.length;i++){var t=[];0<d.clientes[i].clientes_razon.length?d.clientes[i].clientes_razon.map(function(a,e){0<d.clientes[i].cliente_destinos.length?d.clientes[i].cliente_destinos.map(function(e){(t=[]).push(i+1),t.push(d.clientes[i].codigo),t.push(d.clientes[i].contacto),t.push(d.clientes[i].nit),t.push(d.clientes[i].razon_social),t.push(d.clientes[i].direccion),t.push(d.clientes[i].telefono1),t.push(d.clientes[i].telefono2),t.push(d.clientes[i].telefono3),t.push(d.clientes[i].ubicacion_geografica),t.push(d.clientes[i].rubro),t.push(d.clientes[i].categoria),t.push(d.fechaATexto(d.clientes[i].fecha1)),t.push(d.fechaATexto(d.clientes[i].fecha2)),t.push(d.clientes[i].texto2),t.push(d.clientes[i].texto2),t.push(a.razon_social),t.push(a.nit),t.push(a.codigo_sap),t.push(e.destino.destino),t.push(e.destino.direccion),o.push(t)}):((t=[]).push(i+1),t.push(d.clientes[i].codigo),t.push(d.clientes[i].contacto),t.push(d.clientes[i].nit),t.push(d.clientes[i].razon_social),t.push(d.clientes[i].direccion),t.push(d.clientes[i].telefono1),t.push(d.clientes[i].telefono2),t.push(d.clientes[i].telefono3),t.push(d.clientes[i].ubicacion_geografica),t.push(d.clientes[i].rubro),t.push(d.clientes[i].categoria),t.push(d.fechaATexto(d.clientes[i].fecha1)),t.push(d.fechaATexto(d.clientes[i].fecha2)),t.push(d.clientes[i].texto2),t.push(d.clientes[i].texto2),t.push(a.razon_social),t.push(a.nit),t.push(a.codigo_sap),t.push("sin dato"),t.push("sin dato"),o.push(t))}):0<d.clientes[i].cliente_destinos.length?d.clientes[i].cliente_destinos.map(function(e){(t=[]).push(i+1),t.push(d.clientes[i].codigo),t.push(d.clientes[i].contacto),t.push(d.clientes[i].nit),t.push(d.clientes[i].razon_social),t.push(d.clientes[i].direccion),t.push(d.clientes[i].telefono1),t.push(d.clientes[i].telefono2),t.push(d.clientes[i].telefono3),t.push(d.clientes[i].ubicacion_geografica),t.push(d.clientes[i].rubro),t.push(d.clientes[i].categoria),t.push(d.fechaATexto(d.clientes[i].fecha1)),t.push(d.fechaATexto(d.clientes[i].fecha2)),t.push(d.clientes[i].texto2),t.push(d.clientes[i].texto2),t.push("sin dato"),t.push("sin dato"),t.push("sin dato"),t.push(e.destino.destino),t.push(e.destino.direccion),o.push(t)}):((t=[]).push(i+1),t.push(d.clientes[i].codigo),t.push(d.clientes[i].contacto),t.push(d.clientes[i].nit),t.push(d.clientes[i].razon_social),t.push(d.clientes[i].direccion),t.push(d.clientes[i].telefono1),t.push(d.clientes[i].telefono2),t.push(d.clientes[i].telefono3),t.push(d.clientes[i].ubicacion_geografica),t.push(d.clientes[i].rubro),t.push(d.clientes[i].categoria),t.push(d.fechaATexto(d.clientes[i].fecha1)),t.push(d.fechaATexto(d.clientes[i].fecha2)),t.push(d.clientes[i].texto2),t.push(d.clientes[i].texto2),t.push("sin dato"),t.push("sin dato"),t.push("sin dato"),t.push("sin dato"),t.push("sin dato"),o.push(t))}var r="SheetJS",n=new Workbook,s=sheet_from_array_of_arrays(o);n.SheetNames.push(r),n.Sheets[r]=s;var c=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"COMPROBACION DATOS CLIENTES RAZONES DESTINOS.xlsx"),u.stop()},d.subirExcelClientes=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){u.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.razon_social=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.nit=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.direccion=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.telefono1=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.telefono2=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.telefono3=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.contacto=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,s.ubicacion_geografica=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,s.rubro=null!=r["J"+t]&&""!=r["J"+t]?r["J"+t].v.toString():null,s.categoria=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,s.fecha1=null!=r["L"+t]&&""!=r["L"+t]?new Date(d.convertirFecha(r["L"+t].v.toString())):null,s.fecha2=null!=r["M"+t]&&""!=r["M"+t]?new Date(d.convertirFecha(r["M"+t].v.toString())):null,s.texto1=null!=r["N"+t]&&""!=r["N"+t]?r["N"+t].v.toString():null,s.texto2=null!=r["O"+t]&&""!=r["O"+t]?r["O"+t].v.toString():null,s.tipoPrecioVenta=null!=r["P"+t]&&""!=r["P"+t]?r["P"+t].v.toString():null,null!=s.tipoPrecioVenta&&(s.tipoPrecioVenta=d.tiposPrecios.clases.find(function(e){return s.tipoPrecioVenta.toUpperCase()===e.nombre})),n.push(s),t++,0}while(null!=r["A"+t]);d.guardarClientes(n),u.stop()},t.readAsBinaryString(o)}},d.subirExcelRazonesSocialesCliente=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){u.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.razon_social=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.nit=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.codigo_sap=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);d.guardarRazonesSocialesClientes(n),u.stop()},t.readAsBinaryString(o)}},d.guardarRazonesSocialesClientes=function(e){b(e,d.usuario.id_empresa).then(function(e){u.stop(),d.mostrarMensaje(e.mensaje),d.recargarItemsTabla()})},d.guardarClientes=function(e){new m({clientes:e,id_empresa:d.usuario.id_empresa}).$save(function(e){u.stop(),d.mostrarMensaje(e.mensaje),d.recargarItemsTabla()},function(e){u.stop(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()})},d.abrirModalConceptoEdicionCorrelativos=function(e){u.start(),C("correlativo_clientes",d.usuario.id_empresa).then(function(e){1<e.clases.length?(e.clases.sort(function(e,a){return e.correlativo=e.nombre_corto.split("-")[0],e.correlativo_maximo=e.nombre_corto.split("-")[1],a.correlativo=a.nombre_corto.split("-")[0],a.correlativo_maximo=a.nombre_corto.split("-")[1],e.correlativo-a.correlativo}),d.minimo=parseInt(e.clases[e.clases.length-1].correlativo_maximo)+1):1==e.clases.length&&(e.clases[0].correlativo=e.clases[0].nombre_corto.split("-")[0],e.clases[0].correlativo_maximo=e.clases[0].nombre_corto.split("-")[1],d.minimo=parseInt(e.clases[0].correlativo_maximo)+1),d.tipo_edicion=e,d.clase={},d.abrirPopup(d.idModalConceptoEdicionCorrelativos),u.stop()})},d.cerrarModalConceptoEdicionCorrelativos=function(){d.cerrarPopup(d.idModalConceptoEdicionCorrelativos)},d.agregarConceptoEdicion=function(e){e.nombre_corto=e.correlativo+"-"+e.correlativo_maximo,-1==d.tipo_edicion.clases.indexOf(e)&&(d.tipo_edicion.clases.length,d.tipo_edicion.clases.push(e),d.minimo=e.correlativo_maximo+1),d.clase={}},d.modificarConceptoEdicion=function(e){e.correlativo=parseInt(e.correlativo),e.correlativo_maximo=parseInt(e.correlativo_maximo),d.clase=e},d.removerConceptoEdicion=function(e){e.eliminado=!0},d.guardarConceptoEdicion=function(a){u.start(),_.update({id_tipo:a.id},a,function(e){M(a.nombre_corto).then(function(e){a=e,u.stop(),d.cerrarModalConceptoEdicionCorrelativos(),d.mostrarMensaje("Guardado Exitosamente!")})})},d.abrirModalVerificarCuenta=function(e,a){d.dato=e,d.tipoDatosPermiso=a,d.abrirPopup(d.IdModalVerificarCuenta)},d.cerrarModalVerificarCuenta=function(){d.cerrarPopup(d.IdModalVerificarCuenta)},d.verificarCuentaAdmin=function(e){D.save({id_empresa:d.usuario.id_empresa},e,function(e){e.type?(d.mostrarMensaje(e.message),"correlativo"==d.tipoDatosPermiso&&d.modificarConceptoEdicion(d.dato),d.cerrarModalVerificarCuenta()):d.mostrarMensaje(e.message)})},d.obtenerTiposPrecio=function(){u.start(),C("T_PAGO_PRODUCTO",d.usuario.id_empresa).then(function(e){d.tiposPrecios=e,u.stop()})},d.$on("$routeChangeStart",function(e,a){d.eliminarPopup("modal-wizard-cliente"),d.eliminarPopup("modal-wizard-cliente-vista"),d.eliminarPopup("dialog-eliminar-cliente"),d.eliminarPopup(d.idModalConceptoEdicionCorrelativos),d.eliminarPopup(d.IdModalVerificarCuenta)}),d.inicio()}]),angular.module("agil.controladores").controller("ControladorCodigoControl",["$scope","$localStorage","$location","$templateCache","$route","blockUI","CodigoControl",function(c,e,a,o,i,l,t){l.start(),c.usuario=JSON.parse(e.usuario),c.inicio=function(){c.descargarPruebasExcel=restServer+"/downloadReport/PRUEBAS-CODIGO-CONTROL.xlsx"},c.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),c.buscarAplicacion(c.usuario.aplicacionesUsuario,a.path().substring(1)),l.stop()}),c.subirExcelPruebasDosificaciones=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){l.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.autorizacion=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.factura=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.nit=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.fecha=null!=r["E"+t]&&""!=r["E"+t]?c.formatearFecha(r["E"+t].v.toString()):null,s.monto=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.llave_digital=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.codigo_control_esperado=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);c.generarPruebas(n),l.stop()},t.readAsBinaryString(o)}},c.formatearFecha=function(e){if(3==(o=e.split("/")).length)if(2<o[0].length)var a=o[0]+o[1]+o[2];else a=o[2]+o[1]+o[0];else{var o;a=(o=(e=c.fechaATexto(new Date(c.fecha_excel_angular(e)))).split("/"))[2]+o[1]+o[0]}return a},c.fecha_excel_angular=function(e){var a=new Date(1/1970),o=e-25568;return a.setTime(a.getTime()+864e5*o)},c.generarPruebas=function(e){(e=new t({pruebas:e})).$save(function(e){c.pruebasCodigoControl=e.resultados,c.aplicarTabla("tabla-pruebas-codigo-control",8),l.stop(),c.mostrarMensaje("Pruebas generadas Exitosamente!")},function(e){l.stop(),c.mostrarMensaje("Ocurrio un problema al momento de generar las pruebas!")})},c.inicio()}]),angular.module("agil.controladores").controller("controladorComensalesEmpresa",["$scope","$timeout","$localStorage","$filter","$location","blockUI","Clientes","ClientesNit","GuardarAlias","ObtenerAlias","GuardarGerencias","ObtenerGerencias","GuardarComensales","ObtenerComensales","GuardarComidas","ObtenerComidas","GuardarPrecioComidas","ObtenerPrecioComidas","GuardarHistorialExcel","GuardarComensalesExcel","ObtenerHistorial","GuardarEmpresasExcel","GuardarGerenciasExcel","GuardarComidasExcel","GuardarPreciosExcel","Paginator","BusquedaComensales","ObtenerReporteComedor","ObtenerCambioMoneda","ObtenerReporteEmpresa","ObtenerReporteComensal","ObtenerAlertasMarcacion","EditarAlertasMarcacion","ObtenerHistorialDocumentos","ObtenerDocumento",function(_,e,a,o,i,v,t,r,n,s,c,d,l,u,p,m,f,g,h,b,C,P,M,D,E,x,S,A,T,w,I,R,j,O,F){_.usuario=JSON.parse(a.usuario),_.modalEdicionAlias="modalAliasEmpresasCliente",_.modalEdicionGerencias="modalGerenciaEmpresasCliente",_.modalEdicionComensales="modalComensalesEmpresasCliente",_.modalEdicionComidas="modalComidasEmpresasCliente",_.modalEdicionPrecios="modalPreciosComidasEmpresasCliente",_.dialogClienteEmpresa="dialog-cliente-empresa",_.busquedaComensalesEmpresa="dialog-comensales-empresa",_.dialogAlertasMarcaciones="dialog-alerta-marcaciones",_.dialogHistorialDocumentos="dialog-historial-documentos",_.imagenEmpresa,_.$on("$viewContentLoaded",function(){ejecutarScriptsComensales(_.modalEdicionAlias,_.modalEdicionGerencias,_.modalEdicionComensales,_.modalEdicionComidas,_.modalEdicionPrecios,_.dialogClienteEmpresa,_.busquedaComensalesEmpresa,_.dialogAlertasMarcaciones,_.dialogHistorialDocumentos)}),_.$on("$routeChangeStart",function(e,a){_.eliminarPopup(_.modalEdicionAlias),_.eliminarPopup(_.modalEdicionGerencias),_.eliminarPopup(_.modalEdicionComensales),_.eliminarPopup(_.modalEdicionComidas),_.eliminarPopup(_.modalEdicionPrecios),_.eliminarPopup(_.dialogClienteEmpresa),_.eliminarPopup(_.busquedaComensalesEmpresa),_.eliminarPopup(_.dialogAlertasMarcaciones),_.eliminarPopup(_.dialogHistorialDocumentos)}),convertUrlToBase64Image(_.usuario.empresa.imagen,function(e){0<e.length&&"error"!==e?_.imagenEmpresa=e:convertUrlToBase64Image("img/agilsoftware.png",function(e){0<e.length&&"error"!==e?(_.mostrarMensaje("No se encuentra la imagen de la empresa."),_.imagenEmpresa=e):_.mostrarMensaje("No se encuentra imagenen de la empresa.")})}),_.inicio=function(){if(_.activeModal=0,_.obtenerClientes(),_.empresaExternaSeleccionada){var e=Object.assign({},_.empresaExternaSeleccionada);_.filtroComensales={desde:"",hasta:"",empresaCliente:e,id_usuario:"",id_cliente:"",mes:"",anio:"",gerencia:"",comida:"",comensal:""},_.reportes=[{id:1,nombre:"Reporte Comedor"},{id:2,nombre:"Empresa"},{id:3,nombre:"Por comensal"}],_.obtenerPaginador(),_.listaAliasclientesEmpresa=[],_.listaComensalesclienteEmpresa=[],_.listaGerenciasClienteEmpresa=[],_.listaComidasclienteEmpresa=[],_.listaPrecioComidasclienteEmpresa=[],_.alertaMarcaciones=[],_.historialesDocumentos=[],_.obtenerComidas(),_.obtenerGerencias(),_.obtenerHistoriales(),_.obtenerComensales()}v.stop()},_.PopoverConfiguracionComensales={templateUrl:"PopoverConfiguracionComensales.html",title:"Menu",isOpen:!1},_.buscarCliente=function(e){if(""!=e&&null!=e)return r(_.usuario.id_empresa,e)},_.buscarComensales=function(e){if(""!=e&&null!=e)return S(_.usuario.id_empresa,_.usuario.id,_.empresaExternaSeleccionada.id,e)},_.filtrarClientes=function(e){_.clientesProcesados=o("filter")(_.clientes,e)},_.filtrarComensales=function(e){_.comensalesProcesados=o("filter")(_.comensalesBusqueda,e)},_.obtenerHistorialDocumentos=function(){v.start(),_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0),_.paginator.filter=_.filtroComensales,O(_.usuario.id_empresa,_.usuario.id,_.empresaExternaSeleccionada.id,_.paginator).then(function(e){_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0,!0),e.hasErr?_.mostrarMensaje(e.mensaje):_.historialesDocumentos=e.documentos,v.stop()}).catch(function(e){v.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a)})},_.obtenerClientes=function(){v.start(),t(_.usuario.id_empresa).then(function(e){_.clientes=e,_.clientesProcesados=e,v.stop()}).catch(function(e){v.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a)})},_.establecerCliente=function(e){switch(_.activeModal){case 0:_.filtroComensales||(_.filtroComensales={}),_.empresaExternaSeleccionada||(_.empresaExternaSeleccionada=Object.assign({},e),_.inicio()),_.filtroComensales.empresaCliente=Object.assign({},e);break;case 1:_.clienteEmpresaAsignacionAlias||(_.clienteEmpresaAsignacionAlias={}),_.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},e);break;case 2:_.clienteEmpresaEdicionGerencias||(_.clienteEmpresaEdicionGerencias={}),_.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},e),_.obtenerGerencias(!0);break;case 3:_.clienteEmpresaEdicionComensales||(_.clienteEmpresaEdicionComensales={}),_.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},e),_.obtenerComensales(!0);break;case 4:_.clienteEmpresaComidas||(_.clienteEmpresaComidas={}),_.clienteEmpresaComidas.empresaCliente=Object.assign({},e),_.clienteEmpresaComidas.verTodos,_.obtenerComidas(!0);break;case 5:_.clienteEmpresaPreciosComidas||(_.clienteEmpresaPreciosComidas={}),_.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},e),_.obtenerPrecioComidas(!0);break;default:_.mostrarMensaje("Ocurrio un error al asignar")}},_.establecerComensal=function(e,a){_.filtroComensales.comensal=Object.assign({},e),a&&_.cerrardialogBusquedaComensales()},_.seleccionarcliente=function(e){switch(_.activeModal){case 0:_.filtroComensales||(_.filtroComensales={}),_.empresaExternaSeleccionada||(_.empresaExternaSeleccionada=Object.assign({},e),_.inicio()),_.filtroComensales.empresaCliente=Object.assign({},e);break;case 1:_.clienteEmpresaAsignacionAlias||(_.clienteEmpresaAsignacionAlias={}),_.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},e);break;case 2:_.clienteEmpresaEdicionGerencias||(_.clienteEmpresaEdicionGerencias={}),_.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},e),_.obtenerGerencias(!0);break;case 3:_.clienteEmpresaEdicionComensales||(_.clienteEmpresaEdicionComensales={}),_.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},e),_.obtenerComensales(!0);break;case 4:_.clienteEmpresaComidas||(_.clienteEmpresaComidas={}),_.clienteEmpresaComidas.empresaCliente=Object.assign({},e),_.clienteEmpresaComidas.verTodos=!1,_.obtenerComidas(!0);break;case 5:_.clienteEmpresaPreciosComidas||(_.clienteEmpresaPreciosComidas={}),_.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},e),_.obtenerPrecioComidas(!0);break;default:_.mostrarMensaje("Ocurrio un error al asignar")}_.cerrardialogClientesComensales()},_.obtenerAliasEmpresa=function(){v.start(),s(_.usuario.id_empresa,_.usuario.id).then(function(e){e.hasErr?_.mostrarMensaje(e.mensaje):_.listaAliasclientesEmpresa=e.lista,v.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.obtenerGerencias=function(e){v.start(),d(_.usuario.id_empresa,_.usuario.id,e?_.clienteEmpresaEdicionGerencias.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){e.hasErr?_.mostrarMensaje(e.mensaje):_.listaGerenciasClienteEmpresa=e.lista,v.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.obtenerComensales=function(e){v.start(),u(_.usuario.id_empresa,_.usuario.id,e?_.clienteEmpresaEdicionComensales.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){e.hasErr?_.mostrarMensaje(e.mensaje):(_.listaComensalesclienteEmpresa=e.lista,_.comensalesBusqueda=e.lista,_.comensalesProcesados=e.lista),v.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.verTodasLasComidas=function(){_.clienteEmpresaComidas?_.clienteEmpresaComidas.verTodos?_.clienteEmpresaComidas.verTodos=!1:_.clienteEmpresaComidas.verTodos=!0:(_.clienteEmpresaComidas={},_.clienteEmpresaComidas.verTodos=!1),_.obtenerComidas()},_.obtenerComidas=function(e){v.start(),_.clienteEmpresaComidas||(_.clienteEmpresaComidas={},_.clienteEmpresaComidas.verTodos=!1),(e?m(_.usuario.id_empresa,_.usuario.id,_.clienteEmpresaComidas.empresaCliente.id):_.clienteEmpresaComidas.verTodos?m(_.usuario.id_empresa,_.usuario.id,0):m(_.usuario.id_empresa,_.usuario.id,_.empresaExternaSeleccionada.id)).then(function(e){e.hasErr?_.mostrarMensaje(e.mensaje):_.listaComidasclienteEmpresa=e.lista,v.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.obtenerPrecioComidas=function(e){v.start(),g(_.usuario.id_empresa,_.usuario.id,e?_.clienteEmpresaPreciosComidas.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){e.hasErr?_.mostrarMensaje(e.mensaje):_.listaPrecioComidasclienteEmpresa=e.lista,v.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.obtenerHistoriales=function(e){v.start(),_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0),_.paginator.filter=_.filtroComensales,C(_.usuario.id_empresa,_.usuario.id,_.empresaExternaSeleccionada.id,_.paginator).then(function(e){_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0,!0),e.hasErr?e.mostrarMensaje(e.mensaje):(_.historialesComedor=e.historial.map(function(e){return e.fecha_texto=e.fecha.split("T")[0].split("-").reverse().join("/")+" "+e.fecha.split("T")[1].split(".")[0],e.fecha=new Date(e.fecha),e}),_.paginator.setPages(e.paginas)),v.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.obtenerAlertas=function(e){v.start(),R(_.usuario.id_empresa,_.usuario.id,_.empresaExternaSeleccionada.id).then(function(e){if(e.hasErr)e.mostrarMensaje(e.mensaje);else{_.alertaMarcaciones=e.alertas,_.Marcaciones=e.alertas;for(var a=0;a<_.alertaMarcaciones.length;a++){_.alertaMarcaciones[a].marcacionesFaltantes=[];for(var o=0;o<_.alertaMarcaciones[a].marcaciones.length;o++){var i=-1;if(_.alertaMarcaciones[a].marcacionesFaltantes.some(function(e){return i+=1,e.fecha.split("T")[0]===_.alertaMarcaciones[a].marcaciones[o].fecha.split("T")[0].split("-").reverse().join("/")})){if(_.alertaMarcaciones[a].marcacionesFaltantes[i].id_comida)(t=_.listaComidasclienteEmpresa.find(function(e){return e.id===_.alertaMarcaciones[a].marcaciones[o].id_comida}))?("desayuno"===t.nombre.toLowerCase()&&(_.alertaMarcaciones[a].marcacionesFaltantes[i].desayuno.cantidad+=1),"almuerzo"===t.nombre.toLowerCase()&&(_.alertaMarcaciones[a].marcacionesFaltantes[i].almuerzo.cantidad+=1),"cena"===t.nombre.toLowerCase()&&(_.alertaMarcaciones[a].marcacionesFaltantes[i].cena.cantidad+=1)):_.alertaMarcaciones[a].marcacionesFaltantes[i].fuera_horario+=1;else _.alertaMarcaciones[a].marcacionesFaltantes[i].fuera_horario+=1}else{var t,r={cantidad:0,id_comida:_.alertaMarcaciones[a].marcaciones[o].id_comida},n={id_comida:_.alertaMarcaciones[a].marcaciones[o].id_comida,fecha:_.alertaMarcaciones[a].marcaciones[o].fecha.split("T")[0].split("-").reverse().join("/"),desayuno:Object.assign({},r),almuerzo:Object.assign({},r),cena:Object.assign({},r),fuera_horario:0,gerencia:{id:_.alertaMarcaciones[a].marcaciones[o].id_gerencia}};(t=_.listaComidasclienteEmpresa.find(function(e){return e.id===_.alertaMarcaciones[a].marcaciones[o].id_comida}))?("desayuno"===t.nombre.toLowerCase()&&(n.desayuno.cantidad+=1),"almuerzo"===t.nombre.toLowerCase()&&(n.almuerzo.cantidad+=1),"cena"===t.nombre.toLowerCase()&&(n.cena.cantidad+=1)):n.fuera_horario+=1,_.alertaMarcaciones[a].marcacionesFaltantes.push(n)}}}var s=[];for(a=0;a<_.alertaMarcaciones.length;a++)for(o=0;o<_.alertaMarcaciones[a].marcacionesFaltantes.length;o++){var c=_.listaComidasclienteEmpresa.find(function(e){return"desayuno"===e.nombre.toLowerCase()}),l=_.listaComidasclienteEmpresa.find(function(e){return"almuerzo"===e.nombre.toLowerCase()}),d=_.listaComidasclienteEmpresa.find(function(e){return"cena"===e.nombre.toLowerCase()});if(0===_.alertaMarcaciones[a].marcacionesFaltantes[o].desayuno.cantidad){var u={comida:c,fecha:_.alertaMarcaciones[a].marcacionesFaltantes[o].fecha,gerencia:_.alertaMarcaciones[a].marcacionesFaltantes[o].gerencia,comensal:{id:_.alertaMarcaciones[a].id,nombre:_.alertaMarcaciones[a].nombre,id_cliente:_.alertaMarcaciones[a].id_cliente,id_empresa:_.alertaMarcaciones[a].id_empresa,tarjeta:_.alertaMarcaciones[a].tarjeta,tipo:_.alertaMarcaciones[a].tipo}};s.push(u)}if(0===_.alertaMarcaciones[a].marcacionesFaltantes[o].almuerzo.cantidad){u={comida:l,fecha:_.alertaMarcaciones[a].marcacionesFaltantes[o].fecha,gerencia:_.alertaMarcaciones[a].marcacionesFaltantes[o].gerencia,comensal:{id:_.alertaMarcaciones[a].id,nombre:_.alertaMarcaciones[a].nombre,id_cliente:_.alertaMarcaciones[a].id_cliente,id_empresa:_.alertaMarcaciones[a].id_empresa,tarjeta:_.alertaMarcaciones[a].tarjeta,tipo:_.alertaMarcaciones[a].tipo}};s.push(u)}if(0===_.alertaMarcaciones[a].marcacionesFaltantes[o].cena.cantidad){u={comida:d,fecha:_.alertaMarcaciones[a].marcacionesFaltantes[o].fecha,gerencia:_.alertaMarcaciones[a].marcacionesFaltantes[o].gerencia,comensal:{id:_.alertaMarcaciones[a].id,nombre:_.alertaMarcaciones[a].nombre,id_cliente:_.alertaMarcaciones[a].id_cliente,id_empresa:_.alertaMarcaciones[a].id_empresa,tarjeta:_.alertaMarcaciones[a].tarjeta,tipo:_.alertaMarcaciones[a].tipo}};s.push(u)}}_.alertaMarcaciones=s,v.stop()}v.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.obtenerPaginador=function(){_.paginator=x(),_.paginator.column="fecha",_.paginator.direccion="asc",_.paginator.callBack=_.obtenerHistoriales},_.filtrarHistorial=function(e,a,o){if(void 0!==o)for(var i in e)0==e[i]&&(e[i]="");else for(var i in e)""!==e[i]&&null!==e[i]||(e[i]=0);if(void 0!==a&&a)return e;_.obtenerHistoriales(!0)},_.subirExcelHistorial=function(e){var a,o,i=e.target.files;if(i)for(o=i[a=0];a!=i.length;++a){var t=new FileReader,c=o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.tarjeta=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.nombre=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.fecha_hora=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.lectora=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.alias=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.documento=c,n.push(s),t++,0}while(null!=r["A"+t]);angular.element($("fileUpload-Historial").val(null)).triggerHandler("change"),_.guardarHistorialExcel(n)},t.readAsBinaryString(o)}else v.stop()},_.subirExcelComensales=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){v.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.tarjeta=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.nombre=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.empresaCliente=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.gerencia=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.tipo=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);v.stop(),angular.element($("fileUploadComensales").val(null)).triggerHandler("change"),_.guardarComensalesExcel(n)},t.readAsBinaryString(o)}},_.subirExcelEmpresas=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){v.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.empresaCliente=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.nombre=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);v.stop(),angular.element($("fileUpload-Empresas").val(null)).triggerHandler("change"),_.guardarEmpresasExcel(n)},t.readAsBinaryString(o)}},_.subirExcelGerencias=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){v.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.empresaCliente=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.nombre=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.lectora=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);v.stop(),angular.element($("fileUpload-Gerencias").val(null)).triggerHandler("change"),_.guardarGerenciasExcel(n)},t.readAsBinaryString(o)}},_.subirExcelComidas=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){v.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.nombre=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.inicio=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].w.toString():null,s.final=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].w.toString():null,s.empresaCliente=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);v.stop(),angular.element($("fileUpload-Comidas").val("")).triggerHandler("change"),_.guardarComidasExcel(n)},t.readAsBinaryString(o)}},_.subirExcelPrecios=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){v.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.nombre=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.empresaCliente=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.precio=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);v.stop(),angular.element($("fileUpload-Precios").val("")).triggerHandler("change"),_.guardarPreciosExcel(n)},t.readAsBinaryString(o)}},_.extraerFechaExcel=function(e){var a=e.split(" ")[e.split(" ").length-1],o=e.split(" ")[0].split("/").reverse();0<a.indexOf("AM")?a=a.split("A")[0].split(":"):0<a.indexOf("PM")&&(a=a.split("P")[0].split(":"),parseInt(a[0])<12&&(a[0]=parseInt(a[0])+12+""));var i=o[0]+"-"+(2==o[2].length?o[2]:"0"+o[2])+"-"+(2==o[1].length?o[1]:"0"+o[1])+"T"+(2==a[0].length?a[0]:"0"+a[0])+":"+(2==a[1].length?a[1]:"0"+a[1])+":"+(2==a[2].length?a[2]:"0"+a[2])+".000Z";new Date(o[0],o[2]-1,o[1],2==a[0].length?a[0]:"0"+a[0],2==a[1].length?a[1]:"0"+a[1],2==a[2].length?a[2]:"0"+a[2]);return i},_.guardarComensalesExcel=function(e){0<e.length?b(_.usuario.id_empresa,e,_.usuario.id).then(function(e){_.obtenerComensales(),e.hasErr?_.mostrarMensaje(e.mensajes):e.mensajes?_.mostrarMensaje(e.mensaje+e.mensajes):_.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.guardarPreciosExcel=function(e){0<e.length?E(_.usuario.id_empresa,e,_.usuario.id).then(function(e){_.obtenerPrecioComidas(),e.hasErr?_.mostrarMensaje(e.mensajes):e.mensajes?_.mostrarMensaje(e.mensaje+e.mensajes):_.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.guardarHistorialExcel=function(e){var a=[];(0<e.length&&e.forEach(function(t){if(!a.some(function(e){var a=_.extraerFechaExcel(e.fecha_hora),o=_.extraerFechaExcel(t.fecha_hora);e.fecha=_.extraerFechaExcel(e.fecha_hora),e.fecha||console.log(e);var i=(new Date(o)-new Date(a))/1e3;return i<0&&(i*=-1),e.tarjeta===t.tarjeta&&e.nombre===t.nombre&&i<1800})){if(0===a.length)t.fecha=_.extraerFechaExcel(t.fecha_hora);a.push(t)}}),0<a.length)?h(_.usuario.id_empresa,a,_.usuario.id).then(function(e){_.obtenerHistoriales(),e.hasErr?_.mostrarMensaje(e.mensajes):(_.obtenerAliasEmpresa(),e.mensajes?_.mostrarMensaje(e.mensaje+e.mensajes):_.mostrarMensaje(e.mensaje))}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.guardarGerenciasExcel=function(e){0<e.length?M(_.usuario.id_empresa,e,_.usuario.id).then(function(e){_.obtenerGerencias(),e.hasErr?_.mostrarMensaje(e.mensajes):e.mensajes?_.mostrarMensaje(e.mensaje+e.mensajes):_.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.guardarEmpresasExcel=function(e){0<e.length?P(_.usuario.id_empresa,e,_.usuario.id).then(function(e){_.obtenerAliasEmpresa(),e.hasErr?_.mostrarMensaje(e.mensajes):e.mensajes?_.mostrarMensaje(e.mensaje+e.mensajes):_.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.guardarComidasExcel=function(e){0<e.length?D(_.usuario.id_empresa,e,_.usuario.id).then(function(e){_.obtenerComidas(),e.hasErr?_.mostrarMensaje(e.mensajes):e.mensajes?_.mostrarMensaje(e.mensaje+e.mensajes):_.mostrarMensaje(e.mensaje)}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.guardarAliasClienteEmpresa=function(){var a=[];(0<_.listaAliasclientesEmpresa.length&&_.listaAliasclientesEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&a.push(e)}),0<a.length)?n(_.usuario.id_empresa,a,_.usuario.id).then(function(e){_.mostrarMensaje(e.mensaje),e.hasErr||_.obtenerAliasEmpresa()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.agregarAliasClienteEmpresa=function(a){var o="";if(_.listaAliasclientesEmpresa.some(function(e){return e.codigo?e.codigo===a.codigo?(o+="Código: "+e.codigo+" ya fué asigando. No se puede duplicar.",!0):e.empresaCliente?e.empresaCliente.id===a.empresaCliente.id?(o+="Empresa: "+e.empresaCliente.razon_social+" ya fué asigando. No se puede duplicar.",!0):e.nombre?e.nombre===a.nombre?(o+="Alias: "+e.nombre+" ya fué asigando. No se puede duplicar.",!0):void 0:(o+="Alias: Vacio",!0):(o+="Empresa: Vacio",!0):(o+="Código: Vacio",!0)}))_.mostrarMensaje(o);else{var e=Object.assign({},a);e.nuevo=!0,_.listaAliasclientesEmpresa.push(e)}},_.guardarGerenciasClienteEmpresa=function(e){var a=[];(0<_.listaGerenciasClienteEmpresa.length&&_.listaGerenciasClienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&a.push(e)}),0<a.length)?c(_.usuario.id_empresa,a,_.usuario.id).then(function(e){_.mostrarMensaje(e.mensaje),e.hasErr||_.obtenerGerencias()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.agregarGerenciaClienteEmpresa=function(a){var o="";if(_.listaGerenciasClienteEmpresa.some(function(e){return(e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id&&e.nombre===a.nombre||e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id||e.empresaCliente.id==a.empresaCliente.id&&e.nombre===a.nombre)&&(o+="Código y/o nombre",!0)}))_.mostrarMensaje(o+" ya fué asigando. No se puede duplicar.");else{var e=Object.assign({},a);e.nuevo=!0,_.listaGerenciasClienteEmpresa.push(e)}},_.guardarComensalesClienteEmpresa=function(){var a=[];(0<_.listaComensalesclienteEmpresa.length&&_.listaComensalesclienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&a.push(e)}),0<a.length)?l(_.usuario.id_empresa,a,_.usuario.id).then(function(e){_.mostrarMensaje(e.mensaje),e.hasErr||_.obtenerComensales()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.agregarComensalClienteEmpresa=function(a){var o="";if(_.listaComensalesclienteEmpresa.some(function(e){return e.codigo?e.codigo===a.codigo?(o+="Código: "+e.codigo+" ya fué asigando. No se puede duplicar.",!0):e.empresaCliente?(null!==e.empresaCliente.id&&e.empresaCliente.id,e.nombre?e.nombre===a.nombre&&e.tarjeta===a.tarjeta&&(o+="comensal y tarjeta"+e.nombre+" ya fué asigando. No se puede duplicar.",!0):(o+="comensal: Vacio",!0)):(o+="Empresa: Vacio",!0):(o+="Código: Vacio",!0)}))_.mostrarMensaje(o);else{var e=Object.assign({},a);e.nuevo=!0,_.listaComensalesclienteEmpresa.push(e)}},_.guardarComidasEmpresasCliente=function(){var a=[];(0<_.listaComidasclienteEmpresa.length&&_.listaComidasclienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&(e.inicio=new Date(0,0,0,e.inicio.getHours(),e.inicio.getMinutes(),0).toLocaleTimeString("es-ES"),e.final=new Date(0,0,0,e.final.getHours(),e.final.getMinutes(),0).toLocaleTimeString("es-ES"),a.push(e))}),0<a.length)?p(_.usuario.id_empresa,a,_.usuario.id,0).then(function(e){_.mostrarMensaje(e.mensaje),e.hasErr||_.obtenerComidas()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.agregarComidaClienteEmpresa=function(a){var o="";if(_.listaComidasclienteEmpresa.some(function(e){return(e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id&&e.nombre===a.nombre||e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id||e.empresaCliente.id==a.empresaCliente.id&&e.nombre===a.nombre)&&(o+="Código y/o nombre",!0)}))_.mostrarMensaje(o+" ya fué asigando. No se puede duplicar.");else{var e=Object.assign({},a);e.nuevo=!0,_.listaComidasclienteEmpresa.push(e)}},_.guardarPreciosComidasEmpresasCliente=function(){var a=[];(0<_.listaPrecioComidasclienteEmpresa.length&&_.listaPrecioComidasclienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&a.push(e)}),0<a.length)?f(_.usuario.id_empresa,a,_.usuario.id,0).then(function(e){_.mostrarMensaje(e.mensaje),e.hasErr||_.obtenerPrecioComidas()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):_.mostrarMensaje("Sin cambios.")},_.agregarPrecioComida=function(a){var o="";if(_.listaPrecioComidasclienteEmpresa.some(function(e){return(e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id&&e.comida.id===a.comida.id||e.codigo==a.codigo&&e.empresaCliente.id==a.empresaCliente.id)&&(o+="Código y/o nombre",!0)}))_.mostrarMensaje(o+" ya fué asigando. No se puede duplicar.");else{var e=Object.assign({},a);e.nuevo=!0,e.id_comida=e.comida.id,_.listaPrecioComidasclienteEmpresa.push(e)}},_.agregarMarcacion=function(a,e){1===e?a.habilitado=!0:2===e&&(a.habilitado=!1),j(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id,a).then(function(e){_.mostrarMensaje(e.mensaje),e.hasErr||(a.id=e.marcacion.id,a.fecha=e.marcacion.fecha.split("T")[0].split("-").reverse().join("/"))}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.eliminarAsignacionaliasClienteEmpresa=function(e){_.listaAliasclientesEmpresa[_.listaAliasclientesEmpresa.indexOf(e)].eliminado=!0},_.eliminarAsignaciongerenciaClienteEmpresa=function(e){_.listaGerenciasClienteEmpresa[_.listaGerenciasClienteEmpresa.indexOf(e)].eliminado=!0},_.eliminarAsignacioncomensalClienteEmpresa=function(e){_.listaComensalesclienteEmpresa[_.listaComensalesclienteEmpresa.indexOf(e)].eliminado=!0},_.eliminarAsignacioncomidaClienteEmpresa=function(e){_.listaComidasclienteEmpresa[_.listaComidasclienteEmpresa.indexOf(e)].eliminado=!0},_.eliminarAsignacionprecioComidaClienteEmpresa=function(e){_.listaPrecioComidasclienteEmpresa[_.listaPrecioComidasclienteEmpresa.indexOf(e)].eliminado=!0},_.generarHistorialExcel=function(e){F(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id,e).then(function(e){if(e.hasErr)_.mostrarMensaje(e.mensaje);else{for(var a=[["TARJETA","EMPLEADO","FECHA / HORA","lectora","NAME"]],o=0;o<e.documento.length;o++){var i=[];i.push(e.documento[o].tarjeta),i.push(e.documento[o].comensal.nombre),i.push(e.documento[o].fecha.split("T")[0].split("-").reverse().join("/")+" "+e.documento[o].fecha.split("T")[1].split(".")[0]),i.push(e.documento[o].identificador_equipo),i.push(e.documento[o].empresaCliente.alias[0].nombre),a.push(i)}var t="SheetJS",r=new Workbook,n=sheet_from_array_of_arrays(a);n["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],n["!rows"]=[{hpx:28,level:3}],r.SheetNames.push(t),r.Sheets[t]=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),e.documento[0].documento)}})},_.generarReportePDF=function(){_.filtroComensales.generar?1===_.filtroComensales.generar?_.reportePDFComedor():2===_.filtroComensales.generar?_.reportePDFEmpresa():3===_.filtroComensales.generar?_.reportePDFComensal():_.mostrarMensaje("Existe un problema con la identificación del reporte."):_.mostrarMensaje("Seleccione un tipo de reporte.")},_.generarReporteEXCEL=function(){_.filtroComensales.generar?1===_.filtroComensales.generar?_.reportePDFComedor(!0):2===_.filtroComensales.generar?_.reportePDFEmpresa(!0):3===_.filtroComensales.generar?_.reportePDFComensal(!0):_.mostrarMensaje("Existe un problema con la identificación del reporte."):_.mostrarMensaje("Seleccione un tipo de reporte.")},_.reportePDFComedor=function(u){var p=0;T(new Date).then(function(e){p=e.monedaCambio.dolar,_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0),_.paginator.filter=_.filtroComensales,d(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){_.listaGerenciasClienteEmpresa=e.lista,m(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){var l=e.lista,d=[];0!==l.length?(l.forEach(function(e){d.push(e.nombre.toUpperCase())}),d.unshift("fecha".toUpperCase()),d.push("observación".toUpperCase()),A(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id,_.paginator).then(function(a){if(_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0,!0),a.hasErr)_.mostrarMensaje(a.mensaje);else{for(var e=[],o=0;o<a.reporte.length;o++){var i=[];if(0<a.reporte[o].historial.length)for(var t=0;t<a.reporte[o].historial.length;t++){var r=-1;if(i.some(function(e){return r+=1,e.gerencia.nombre===a.reporte[o].nombre&&e.fecha.split("T")[0]===a.reporte[o].historial[t].fecha.split("T")[0]}))a.reporte[o].historial[t].comida?("desayuno"===a.reporte[o].historial[t].comida.nombre.toLowerCase()&&(i[r].desayuno.cantidad+=1,i[r].desayuno.total+=a.reporte[o].historial[t].precio),"almuerzo"===a.reporte[o].historial[t].comida.nombre.toLowerCase()&&(i[r].almuerzo.cantidad+=1,i[r].almuerzo.total+=a.reporte[o].historial[t].precio),"cena"===a.reporte[o].historial[t].comida.nombre.toLowerCase()&&(i[r].cena.cantidad+=1,i[r].cena.total+=a.reporte[o].historial[t].precio)):i[r].fuera_horario+=1;else{var n={cantidad:0,total:0},s={empresaCliente:a.reporte[o].historial[t].empresaCliente,gerencia:{id:a.reporte[o].id,nombre:a.reporte[o].nombre,codigo:a.reporte[o].codigo,id_cliente:a.reporte[o].id_cliente,id_empresa:a.reporte[o].id_empresa},fecha:a.reporte[o].historial[t].fecha.split("T")[0],desayuno:Object.assign({},n),almuerzo:Object.assign({},n),cena:Object.assign({},n),fuera_horario:0};a.reporte[o].historial[t].comida?("desayuno"===a.reporte[o].historial[t].comida.nombre.toLowerCase()&&(s.desayuno.cantidad+=1,s.desayuno.total+=a.reporte[o].historial[t].precio),"almuerzo"===a.reporte[o].historial[t].comida.nombre.toLowerCase()&&(s.almuerzo.cantidad+=1,s.almuerzo.total+=a.reporte[o].historial[t].precio),"cena"===a.reporte[o].historial[t].comida.nombre.toLowerCase()&&(s.cena.cantidad+=1,s.cena.total+=a.reporte[o].historial[t].precio)):s.observacion="Fuera de horario, no se puede contabilizar.",i.push(s)}t===a.reporte[o].historial.length-1&&e.push(i)}}if(u)for(t=0;t<e.length;t++){var c=e[t];_.imprimirReporteComedorExcel(c,c[0].gerencia,d,l,p)}else for(t=0;t<e.length;t++)_.imprimirReporteComedor(e[t],e[t][0].gerencia,d,l,p);v.stop()}})):_.mostrarMensaje("El listado de comidas para esta empresa esta vacio, no se puede generar el reporte")})})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.reportePDFEmpresa=function(i){var t=0;T(new Date).then(function(e){t=e.monedaCambio.dolar,_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0),_.paginator.filter=_.filtroComensales,d(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){_.listaGerenciasClienteEmpresa=e.lista,m(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){var a=e.lista,o=[];a.forEach(function(e){o.push(e.nombre.toUpperCase())}),o.unshift("Empleado".toUpperCase()),o.push("Total general".toUpperCase()),w(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id,_.paginator).then(function(e){if(_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0,!0),e.hasErr)_.mostrarMensaje(e.mensaje);else{e.reporte.forEach(function(a){a.desayuno={cantidad:0,total:0},a.almuerzo={cantidad:0,total:0},a.cena={cantidad:0,total:0},a.fueraHorario=0,a.historial.forEach(function(e){e.comida?("desayuno"===e.comida.nombre.toLowerCase()&&(a.desayuno.cantidad+=1),"almuerzo"===e.comida.nombre.toLowerCase()&&(a.almuerzo.cantidad+=1),"cena"===e.comida.nombre.toLowerCase()&&(a.cena.cantidad+=1)):a.fueraHorario+=1})}),i?_.imprimirReporteEmpresaEXCEL(e.reporte,null,o,a,t):_.imprimirReporteEmpresa(e.reporte,null,o,a,t),v.stop()}})})})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.reportePDFAlertasMarcaciones=function(c,e){e?m(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){var a=e.lista,o=[];if(a.forEach(function(e){o.push(e.nombre.toUpperCase())}),o.unshift("empleado".toUpperCase()),o.unshift("empresa".toUpperCase()),o.push("Total general".toUpperCase()),0<_.alertaMarcaciones.length){_.alertaMarcaciones.reverse();for(var i=[],t=[];0<_.alertaMarcaciones.length;){var r=-1,n=_.alertaMarcaciones.pop();if(t.some(function(e){return r+=1,e.fecha===n.fecha}))t[r].alertas.push(n),i.push(n);else{i.push(n);var s={fecha:n.fecha,alertas:[n]};t.push(s)}1}_.alertaMarcaciones=i,c?_.imprimirAlertaMarcacionesMatriz(t,null,o,a):_.imprimirAlertaMarcaciones(t,null,o,a)}}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.stack&&null!==e.stack?e.stack:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()}):0<_.alertaMarcaciones.length&&(c?_.imprimirAlertaMarcacionesMatriz(_.alertaMarcaciones):_.imprimirAlertaMarcacionesLista(_.alertaMarcaciones))},_.reportePDFComensal=function(c){var l=0;T(new Date).then(function(e){l=e.monedaCambio.dolar,_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0),_.paginator.filter=_.filtroComensales,d(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){_.listaGerenciasClienteEmpresa=e.lista,m(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id).then(function(e){var n=e.lista,s=[];n.forEach(function(e){s.push(e.nombre.toUpperCase())}),s.unshift("FECHA".toUpperCase()),s.push("Total general".toUpperCase()),I(_.usuario.id_empresa,_.usuario.id,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.id?_.filtroComensales.empresaCliente.id:_.empresaExternaSeleccionada.id,_.paginator).then(function(a){if(_.filtroComensales=_.filtrarHistorial(_.filtroComensales,!0,!0),a.hasErr)_.mostrarMensaje(a.mensaje);else{for(var o=0;o<a.reporte.length;o++){for(var e=[],i=0;i<a.reporte[o].historial.length;i++){var t=-1;if(e.some(function(e){return t+=1,e.fecha.split("T")[0]===a.reporte[o].historial[i].fecha.split("T")[0]}))a.reporte[o].historial[i].comida?("desayuno"===a.reporte[o].historial[i].comida.nombre.toLowerCase()&&(e[t].desayuno+=1),"almuerzo"===a.reporte[o].historial[i].comida.nombre.toLowerCase()&&(e[t].almuerzo+=1),"cena"===a.reporte[o].historial[i].comida.nombre.toLowerCase()&&(e[t].cena+=1)):e[t].fueraHorario+=1;else{var r={fecha:a.reporte[o].historial[i].fecha,desayuno:0,almuerzo:0,cena:0,fueraHorario:0,empresaCliente:a.reporte[o].historial[i].empresaCliente};a.reporte[o].historial[i].comida?("desayuno"===a.reporte[o].historial[i].comida.nombre.toLowerCase()&&(r.desayuno+=1),"almuerzo"===a.reporte[o].historial[i].comida.nombre.toLowerCase()&&(r.almuerzo+=1),"cena"===a.reporte[o].historial[i].comida.nombre.toLowerCase()&&(r.cena+=1)):r.observacion="Fuera de horario, no se puede contabilizar.",e.push(r)}}a.reporte[o].reporte=e}for(i=0;i<a.reporte.length;i++)c?_.imprimirReporteComensalEXCEL(a.reporte[i],null,s,n,l):_.imprimirReporteComensal(a.reporte[i],null,s,n,l);v.stop()}})})})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";_.mostrarMensaje(a),v.stop()})},_.imprimirAlertaMarcacionesLista=function(e){var a=new PDFDocument({size:"letter",margin:10,compress:!1}),o=a.pipe(blobStream()),i=135,t=0,r=1,n=e[0].fecha+" al "+e[e.length-1].fecha,s=Math.ceil(e.length/10);_.cabeceraReporteAlertasMarcacionesLista(a,_.usuario.empresa.razon_social,n,r,s);for(var c=0;c<e.length;c++)a.text(c+1,70,i+5),a.text(e[c].comensal.nombre,120,i+5),a.text(e[c].fecha,320,i+5),a.text(e[c].comida.nombre,400,i+5),a.text(!0===e[c].habilitado?"Marcado":!1===e[c].habilitado?"Descartado":"Pendiente",500,i+5),a.rect(60,i,500,20).stroke(),i+=20,(10<t||700<i)&&(a.addPage({size:[612,792],margin:10}),i=195,t=0,r+=1,_.cabeceraReporteAlertasMarcacionesMatriz(a,_.usuario.empresa.razon_social,n,r,s));i+=20,a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},_.imprimirAlertaMarcacionesMatriz=function(e,a,o,i){if(0<e.length){var t=new PDFDocument({size:"letter",margin:10,compress:!1}),r=t.pipe(blobStream()),n=150,s=0,c=1,l=Math.ceil(.1);_.Marcaciones.length,_.cabeceraReporteAlertasMarcacionesMatriz(t,c,l,o,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.razon_social?_.filtroComensales.empresaCliente.razon_social:_.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var d=0;d<e.length;d++)for(var u=0;u<e[d].alertas.length;u++)t.font("Helvetica",8),t.font("Helvetica",6).fill("black"),t.text(e[d].alertas[u].comida.empresaCliente.razon_social,50,n+7),t.text(e[d].alertas[u].comensal.nombre,90,n+7),"desayuno"===e[d].alertas[u].comida.nombre.toLowerCase()&&(t.font("Helvetica",8).fill("red"),t.text(e[d].alertas[u].comida.nombre,239,n+7).fill("black"),t.rect(380,n+3,80,20).stroke("red")),"almuerzo"===e[d].alertas[u].comida.nombre.toLowerCase()&&(t.font("Helvetica",8).fill("black"),t.text("Falta2",334,n+7).fill("black"),t.rect(300,n+3,80,20).stroke("black")),"cena"===e[d].alertas[u].comida.nombre.toLowerCase()&&(t.font("Helvetica",8).fill("black"),t.text("Falta3",414,n+7).fill("black")),t.text(e[d].alertas[u].comida.nombre,419,n+7),t.rect(50,n+3,170,20).stroke(),t.rect(220,n+3,80,20).stroke(),t.rect(300,n+3,80,20).stroke(),t.rect(380,n+3,80,20).stroke(),t.rect(460,n+3,110,20).stroke(),t.rect(50,n+3,80,20).stroke(),t.rect(130,n+3,90,20).stroke(),n+=20,(10<++s||700<n)&&(t.addPage({size:[612,792],margin:10}),n=195,s=0,c+=1,_.cabeceraReporteAlertasMarcacionesMatriz(t,c,l,o,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.razon_social?_.filtroComensales.empresaCliente.razon_social:_.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase()));t.text("Total general",56,n+7),t.rect(50,n+3,170,20).stroke(),t.rect(220,n+3,80,20).stroke(),t.rect(300,n+3,80,20).stroke(),t.rect(380,n+3,80,20).stroke(),t.rect(460,n+3,110,20).stroke(),n+=20,t.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})}else _.mostrarMensaje("No hay datos.")},_.imprimirReporteComedorExcel=function(e,a,o,i,t){e=e,o=o,t=t;for(var r=[[""],[""],["REPORTES DE COMEDOR "+(a=a).nombre.toUpperCase()+" "+e[0].empresaCliente.razon_social.toUpperCase()],[""],o],n=0,s=0,c=0,l=0;l<e.length;l++){(d=[]).push(e[l].fecha),0<e[l].desayuno.cantidad?(d.push(e[l].desayuno.cantidad),n+=e[l].desayuno.cantidad):d.push(""),0<e[l].almuerzo.cantidad?(d.push(e[l].almuerzo.cantidad),s+=e[l].almuerzo.cantidad):d.push(""),0<e[l].cena.cantidad?(d.push(e[l].cena.cantidad),c+=e[l].cena.cantidad):d.push(""),e[l].observacion&&d.push(e[l].observacion),r.push(d)}r.push([""]);var d=["TOTAL ==>",n,s,c];r.push(d),d=["TOTAL $us. ==>",n*t,s*t,c*t],r.push(d),d=["TOTAL General $us. ==>","",n*t+s*t+c*t],r.push(d);var u="SheetJS",p=new Workbook,m=sheet_from_array_of_arrays(r);m["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],m["!rows"]=[{hpx:28,level:3}],m["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+r.length,c:0},e:{r:3+r.length,c:1}}],p.SheetNames.push(u),p.Sheets[u]=m;var f=XLSX.write(p,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(f)],{type:"application/octet-stream"}),"REPORTE GERENCIA "+a.nombre.toUpperCase()+".xlsx"),v.stop()},_.imprimirReporteEmpresaEXCEL=function(e,a,o,i,t){o=o;for(var r=[["Reporte EMPRESA VS PERIODO"],["EMPRESA",(e=e)[0].historial[0].empresaCliente.razon_social],["GERENCIA",""],["PERIODO",e.fecha],o],n=0,s=0,c=0,l=0;l<e.length;l++){var d;n+=e[l].desayuno.cantidad,s+=e[l].almuerzo.cantidad,c+=e[l].cena.cantidad,d=e[l].desayuno.cantidad+e[l].almuerzo.cantidad+e[l].cena.cantidad,e[l].desayuno.cantidad,e[l].almuerzo.cantidad,e[l].cena.cantidad,(u=[]).push(e[l].nombre),u.push(e[l].desayuno.cantidad),u.push(e[l].almuerzo.cantidad),u.push(e[l].cena.cantidad),d,u.push(d),r.push(u)}var u=["TOTAL General",n,s,c,n+s+c];r.push(u);var p="SheetJS",m=new Workbook,f=sheet_from_array_of_arrays(r);f["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],f["!rows"]=[{hpx:28,level:3}],f["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+r.length,c:0},e:{r:3+r.length,c:1}}],m.SheetNames.push(p),m.Sheets[p]=f;var g=XLSX.write(m,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(g)],{type:"application/octet-stream"}),"REPORTE EMPRESA "+e[0].historial[0].empresaCliente.razon_social.toUpperCase()+".xlsx"),v.stop()},_.imprimirReporteComensalEXCEL=function(e,a,o,i,t){o=o;for(var r=[["REPORTE POR PERSONA"],["EMPLEADO",(e=e).nombre],["EMPRESA",e.reporte[0].empresaCliente.razon_social],["GERENCIA",""],["PERIODO",e.fecha],o],n=0,s=0,c=0,l=0;l<e.reporte.length;l++){var d;n+=e.reporte[l].desayuno,s+=e.reporte[l].almuerzo,c+=e.reporte[l].cena,d=e.reporte[l].desayuno+e.reporte[l].almuerzo+e.reporte[l].cena,e.reporte[l].desayuno,e.reporte[l].almuerzo,e.reporte[l].cena,(u=[]).push(e.reporte[l].fecha.split("T")[0]),u.push(e.reporte[l].desayuno),u.push(e.reporte[l].almuerzo),u.push(e.reporte[l].cena),u.push(d),r.push(u)}var u=["TOTAL General",n,s,c,n+s+c];r.push(u);var p="SheetJS",m=new Workbook,f=sheet_from_array_of_arrays(r);f["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],f["!rows"]=[{hpx:28,level:3}],f["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+r.length,c:0},e:{r:3+r.length,c:1}}],m.SheetNames.push(p),m.Sheets[p]=f;var g=XLSX.write(m,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(g)],{type:"application/octet-stream"}),"REPORTE COMENSAL "+e.nombre.toUpperCase()+".xlsx"),v.stop()},_.imprimirReporteComedor=function(e,a,o,i,t){var r=new PDFDocument({size:"letter",margin:10,compress:!1}),n=r.pipe(blobStream()),s=170,c=0,l=0,d=1,u=100,p=Math.ceil(.1);_.cabeceraReporteComedor(r,d,p,o,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.razon_social?_.filtroComensales.empresaCliente.razon_social:_.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var m=0,f=0,g=0,v=0;v<e.length;v++)o.forEach(function(e){r.rect(u+l,s,80,20).stroke(),l+=80}),l=0,r.font("Helvetica",8),0<e[v].desayuno.cantidad&&(r.text(e[v].fecha,109,s+7),r.text(e[v].desayuno.cantidad,204,s+7),m+=e[v].desayuno.cantidad),0<e[v].almuerzo.cantidad&&(r.text(e[v].fecha,109,s+7),r.text(e[v].almuerzo.cantidad,284,s+7),f+=e[v].almuerzo.cantidad),0<e[v].cena.cantidad&&(r.text(e[v].fecha,109,s+7),r.text(e[v].cena.cantidad,364,s+7),g+=e[v].cena.cantidad),e[v].observacion&&(r.text(e[v].fecha,109,s+7),r.text(e[v].observacion,421,s+3,{width:80})),s+=20,(10<++c||700<s)&&(r.addPage({size:[612,792],margin:10}),s=195,c=0,d+=1,_.cabeceraReporteComedor(r,d,p,o,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.razon_social?_.filtroComensales.empresaCliente.razon_social:_.empresaExternaSeleccionada.razon_social,e[v].gerencia?e[v].gerencia.nombre.toUpperCase():"Sin asignación.".toUpperCase()));r.rect(u,s,80,20).stroke(),r.rect(180,s,80,20).stroke(),r.rect(260,s,80,20).stroke(),r.rect(340,s,80,20).stroke(),r.rect(420,s,80,20).stroke(),s+=20;var h=m*("desayuno"===i[0].nombre.toLowerCase()?i[0].precio[0].precio:"desayuno"===i[1].nombre.toLowerCase()?i[1].precio[0].precio:"desayuno"===i[2].nombre.toLowerCase()?i[2].precio[0].precio:"ERROR"),b=f*("almuerzo"===i[0].nombre.toLowerCase()?i[0].precio[0].precio:"almuerzo"===i[1].nombre.toLowerCase()?i[1].precio[0].precio:"almuerzo"===i[2].nombre.toLowerCase()?i[2].precio[0].precio:"ERROR"),C=g*("cena"===i[0].nombre.toLowerCase()?i[0].precio[0].precio:"cena"===i[1].nombre.toLowerCase()?i[1].precio[0].precio:"cena"===i[2].nombre.toLowerCase()?i[2].precio[0].precio:"ERROR");r.text("Total.-",124,s+7),r.text("Total $us.-",124,s+7+20),r.text("Total General $us.-",124,s+7+40),r.rect(180,s,80,20).stroke(),r.text(m,204,s+7),r.rect(260,s,80,20).stroke(),r.text(f,284,s+7),r.rect(340,s,80,20).stroke(),r.text(g,364,s+7),r.rect(180,s+20,80,20).stroke(),r.rect(260,s+20,80,20).stroke(),r.rect(340,s+20,80,20).stroke(),r.rect(260,s+40,80,20).stroke(),r.text(h,204,s+7+20),r.text(b,284,s+7+20),r.text(C,364,s+7+20),r.text(h+b+C,284,s+7+40),r.rect(u,s+70,80,20).fill("yellow"),r.rect(u,s+90,80,20).fill("yellow"),r.rect(u,s+110,80,20).fill("yellow"),r.rect(180,s+70,80,20).fill("yellow"),r.rect(180,s+90,80,20).fill("yellow"),r.rect(180,s+110,80,20).fill("yellow"),r.rect(340,s+90,160,20).fill("yellow"),r.rect(u,s+70,80,20).stroke(),r.rect(u,s+90,80,20).stroke(),r.rect(u,s+110,80,20).stroke(),r.rect(180,s+70,80,20).stroke(),r.rect(180,s+90,80,20).stroke(),r.rect(180,s+110,80,20).stroke().fill("black"),r.text("Desayuno.-",124,s+7+70),r.text("almuerzo.-",124,s+7+90),r.text("Cena.-",124,s+7+110),r.rect(340,s+90,160,20).stroke(),r.text("T.C. "+t+"       Bs "+((h+b+C)*t).toFixed(2),364,s+7+90),r.text("desayuno"===i[0].nombre.toLowerCase()?i[0].precio[0].precio:"desayuno"===i[1].nombre.toLowerCase()?i[1].precio[0].precio:"desayuno"===i[2].nombre.toLowerCase()?i[2].precio[0].precio:"ERROR",204,s+7+70),r.text("almuerzo"===i[0].nombre.toLowerCase()?i[0].precio[0].precio:"almuerzo"===i[1].nombre.toLowerCase()?i[1].precio[0].precio:"almuerzo"===i[2].nombre.toLowerCase()?i[2].precio[0].precio:"ERROR",204,s+7+90),r.text("cena"===i[0].nombre.toLowerCase()?i[0].precio[0].precio:"cena"===i[1].nombre.toLowerCase()?i[1].precio[0].precio:"cena"===i[2].nombre.toLowerCase()?i[2].precio[0].precio:"ERROR",204,s+7+110);var P=ConvertirALiteral((h+b+C).toFixed(2));P=P.split("BOLIVIANOS")[0],r.text("Son: "+P+" Dólares Americanos",124,s+7+130),r.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},_.imprimirReporteEmpresa=function(e,a,o,i,t){var r=new PDFDocument({size:"letter",margin:10,compress:!1}),n=r.pipe(blobStream()),s=150,c=0,l=1,d=Math.ceil(.1);_.cabeceraReporteEmpresa(r,l,d,o,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.razon_social?_.filtroComensales.empresaCliente.razon_social:_.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var u=0,p=0,m=0,f=0,g=0;g<e.length;g++){var v;r.font("Helvetica",8),u+=e[g].desayuno.cantidad,p+=e[g].almuerzo.cantidad,m+=e[g].cena.cantidad,v=e[g].desayuno.cantidad+e[g].almuerzo.cantidad+e[g].cena.cantidad,e[g].desayuno.cantidad,e[g].almuerzo.cantidad,e[g].cena.cantidad,0,r.font("Helvetica",8).fill("black"),r.text(e[g].nombre,73,s+7),r.text(e[g].desayuno.cantidad,254,s+7),r.text(e[g].almuerzo.cantidad,334,s+7),r.text(e[g].cena.cantidad,414,s+7),r.text(v,494,s+7),f+=e[g].fueraHorario,r.rect(70,s+3,150,20).stroke(),r.rect(220,s+3,80,20).stroke(),r.rect(300,s+3,80,20).stroke(),r.rect(380,s+3,80,20).stroke(),r.rect(460,s+3,110,20).stroke(),s+=20,(10<++c||700<s)&&(r.addPage({size:[612,792],margin:10}),s=195,c=0,l+=1,_.cabeceraReporteEmpresa(r,l,d,o,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.razon_social?_.filtroComensales.empresaCliente.razon_social:_.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase()))}r.text("Total general",76,s+7),r.text(u,254,s+7),r.text(p,334,s+7),r.text(m,414,s+7),r.text(u+p+m,494,s+7),r.rect(70,s+3,150,20).stroke(),r.rect(220,s+3,80,20).stroke(),r.rect(300,s+3,80,20).stroke(),r.rect(380,s+3,80,20).stroke(),r.rect(460,s+3,110,20).stroke(),0<f&&(r.text("No contabilizados (fuera de horario):",470,s+7+20),r.text("Cant.: "+f,497,s+7+40)),s+=20,r.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},_.formatoFechaPDF=function(e){var a=new Date(e);return a.setDate(a.getDate()),("0"+a.getDate()).slice(-2)+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+a.getFullYear()},_.imprimirReporteComensal=function(e,a,o,i,t){var r=new PDFDocument({size:"letter",margin:10,compress:!1}),n=r.pipe(blobStream()),s=150,c=0,l=1,d=Math.ceil(.1);_.cabeceraReporteComensal(r,l,d,e,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.razon_social?_.filtroComensales.empresaCliente.razon_social:_.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var u=0,p=0,m=0,f=0;f<e.reporte.length;f++){0<e.reporte[f].cena&&(r.font("Helvetica",8).fill("black"),r.text(e.reporte[f].cena,254,s+7).fill("black"),r.rect(380,s+3,80,20).stroke("black")),0<e.reporte[f].almuerzo&&(r.font("Helvetica",8).fill("black"),r.text(e.reporte[f].almuerzo,334,s+7).fill("black"),r.rect(300,s+3,80,20).stroke("black")),0<e.reporte[f].desayuno&&(r.font("Helvetica",8).fill("black"),r.text(e.reporte[f].desayuno,414,s+7).fill("black"),r.rect(220,s+3,80,20).stroke("black"));var g;r.font("Helvetica",8).fill("black"),u+=e.reporte[f].desayuno,p+=e.reporte[f].almuerzo,m+=e.reporte[f].cena,g=e.reporte[f].desayuno+e.reporte[f].almuerzo+e.reporte[f].cena,e.reporte[f].desayuno,e.reporte[f].almuerzo,e.reporte[f].cena,0,r.font("Helvetica",8).fill("black"),r.rect(70,s+3,150,20).stroke("black"),r.rect(460,s+3,110,20).stroke("black"),r.text(_.formatoFechaPDF(e.reporte[f].fecha),78,s+7).fill("black"),r.text(g,494,s+7).fill("black"),0===e.reporte[f].cena&&(r.font("Helvetica",8).fill("red"),r.text("Falta",254,s+7).fill("red"),r.rect(380,s+3,80,20).stroke("red")),0===e.reporte[f].almuerzo&&(r.font("Helvetica",8).fill("red"),r.text("Falta",334,s+7).fill("red"),r.rect(300,s+3,80,20).stroke("red")),0===e.reporte[f].desayuno&&(r.font("Helvetica",8).fill("red"),r.text("Falta",414,s+7).fill("red"),r.rect(220,s+3,80,20).stroke("red")),s+=20,(10<++c||700<s)&&(r.addPage({size:[612,792],margin:10}),s=195,c=0,l+=1,_.cabeceraReporteComensal(r,l,d,e,_.filtroComensales.empresaCliente&&_.filtroComensales.empresaCliente.razon_social?_.filtroComensales.empresaCliente.razon_social:_.empresaExternaSeleccionada.razon_social,a?a.nombre.toUpperCase():"Sin asignación.".toUpperCase()))}r.font("Helvetica",8).fill("black"),r.text("Total general".toLocaleUpperCase(),76,s+7).fill("black"),r.text(u,254,s+7).fill("black"),r.text(p,334,s+7).fill("black"),r.text(m,414,s+7).fill("black"),r.text(u+p+m,494,s+7).fill("black"),r.rect(70,s+3,150,20).stroke("black"),r.rect(220,s+3,80,20).stroke("black"),r.rect(300,s+3,80,20).stroke("black"),r.rect(380,s+3,80,20).stroke("black"),r.rect(460,s+3,110,20).stroke("black"),s+=20,r.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},_.cabeceraReporteComedor=function(a,e,o,i,t,r){var n=0;(new Date).getDate(),(new Date).getMonth(),(new Date).getFullYear();a.font("Helvetica-Bold",12).fill("black"),a.text("REPORTES DE COMEDOR "+r.toUpperCase()+" "+t.toUpperCase(),150,80,{width:300,align:"center"}),a.font("Helvetica-Bold",8),i.forEach(function(e){a.rect(100+n,150,80,20).stroke(),a.text(e,100+n+9,157),n+=80}),a.rect(230,610,130,0).stroke(),a.text("Encargado",272,640),a.font("Helvetica",8),_.imagenEmpresa&&a.image(_.imagenEmpresa,40,30,{fit:[100,100]})},_.cabeceraReporteAlertasMarcacionesLista=function(e,a,o,i,t){e.font("Helvetica",6).fill("black"),e.text("Pag. "+i+" de "+t,560,40),e.font("Helvetica-Bold",12).fill("black"),e.text(a.toLocaleUpperCase(),260,60),e.font("Helvetica-Bold",8),e.text("Cochambamba - Bolivia",255,80),e.font("Helvetica-Bold",8),e.text("Del "+o,255,100),e.text("Nro.",70,120),e.text("comensal",120,120),e.text("fecha",320,120),e.text("Comida",400,120),e.text("Estado",500,120),e.rect(60,115,500,20).stroke(),_.imagenEmpresa&&e.image(_.imagenEmpresa,40,30,{fit:[100,100]})},_.cabeceraReporteAlertasMarcacionesMatriz=function(e,a,o,i,a,t){e.font("Helvetica-Bold",12).fill("black"),e.font("Helvetica-Bold",8),e.text("Alerta no Marcaciones".toLocaleUpperCase(),260,80),e.text("Fecha",60,120),e.text("Empresa",60,140),e.text("Empleado",134,140),e.text("DESAYUNO",240,140),e.text("ALMUERZO",320,140),e.text("CENA",400,140),e.text("TOTAL GENERAL",480,140),e.rect(50,113,170,20).stroke(),e.rect(220,113,350,20).stroke(),e.rect(50,133,80,20).stroke(),e.rect(130,133,90,20).stroke(),e.rect(220,133,80,20).stroke(),e.rect(300,133,80,20).stroke(),e.rect(380,133,80,20).stroke(),e.rect(460,133,110,20).stroke(),e.font("Helvetica",8),_.imagenEmpresa&&e.image(_.imagenEmpresa,40,30,{fit:[100,100]})},_.cabeceraReporteEmpresa=function(e,a,o,i,t,r){e.font("Helvetica-Bold",12).fill("black"),e.font("Helvetica-Bold",8),e.text("Empresa",124,80),e.text(t,300,80),e.text("Gerencia",124,100),e.text("Periodo",124,120),e.text("Empleado",124,140),e.text("DESAYUNO",240,140),e.text("ALMUERZO",320,140),e.text("CENA",400,140),e.text("TOTAL GENERAL",480,140),e.rect(70,73,150,20).stroke(),e.rect(70,93,150,20).stroke(),e.rect(70,113,150,20).stroke(),e.rect(70,133,150,20).stroke(),e.rect(220,73,350,20).stroke(),e.rect(220,93,350,20).stroke(),e.rect(220,113,350,20).stroke(),e.rect(220,133,80,20).stroke(),e.rect(300,133,80,20).stroke(),e.rect(380,133,80,20).stroke(),e.rect(460,133,110,20).stroke(),e.font("Helvetica",8),_.imagenEmpresa&&e.image(_.imagenEmpresa,40,30,{fit:[100,100]})},_.cabeceraReporteComensal=function(e,a,o,i,t,r){e.font("Helvetica-Bold",12).fill("black"),e.font("Helvetica-Bold",8),e.text("Empleado",124,80),e.text(i.nombre,300,80),e.text(t,300,100),e.text("Empresa",124,100),e.text("Periodo",124,120),e.text("Empleado",124,140),e.text("DESAYUNO",240,140),e.text("ALMUERZO",320,140),e.text("CENA",410,140),e.text("TOTAL GENERAL",490,140),e.rect(70,73,150,20).stroke(),e.rect(70,93,150,20).stroke(),e.rect(70,113,150,20).stroke(),e.rect(70,133,150,20).stroke(),e.rect(220,73,350,20).stroke(),e.rect(220,93,350,20).stroke(),e.rect(220,113,350,20).stroke(),e.rect(220,133,80,20).stroke(),e.rect(300,133,80,20).stroke(),e.rect(380,133,80,20).stroke(),e.rect(460,133,110,20).stroke(),e.font("Helvetica",8),_.imagenEmpresa&&e.image(_.imagenEmpresa,40,30,{fit:[100,100]})},_.abrirModalEdicionAlias=function(){_.clienteEmpresaAsignacionAlias={},_.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},_.empresaExternaSeleccionada),_.clienteEmpresaEdicionGerencias,_.obtenerAliasEmpresa(),_.activeModal=1,_.abrirPopup(_.modalEdicionAlias)},_.cerrarModalEdicionAlias=function(){_.activeModal=0,_.clienteEmpresaAsignacionAlias={},_.cerrarPopup(_.modalEdicionAlias)},_.abrirModalEdicionGerencias=function(){_.activeModal=2,_.clienteEmpresaEdicionGerencias={},_.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},_.empresaExternaSeleccionada),_.obtenerGerencias(),_.abrirPopup(_.modalEdicionGerencias)},_.cerrarModalEdicionGerencias=function(){_.activeModal=0,_.clienteEmpresaEdicionGerencias={},_.cerrarPopup(_.modalEdicionGerencias)},_.abrirModalEdicionComensales=function(){_.activeModal=3,_.clienteEmpresaEdicionComensales={},_.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},_.empresaExternaSeleccionada),_.obtenerGerencias(),_.obtenerComensales(),_.abrirPopup(_.modalEdicionComensales)},_.cerrarModalEdicionComensales=function(){_.activeModal=0,_.clienteEmpresaEdicionComensales={},_.cerrarPopup(_.modalEdicionComensales)},_.abrirModalEdicionComidas=function(){_.clienteEmpresaComidas={},_.clienteEmpresaComidas.empresaCliente=Object.assign({},_.empresaExternaSeleccionada),_.clienteEmpresaComidas.verTodos=!1,_.obtenerComidas(),_.activeModal=4,_.abrirPopup(_.modalEdicionComidas)},_.cerrarModalEdicionComidas=function(){_.clienteEmpresaComidas={},_.activeModal=0,_.cerrarPopup(_.modalEdicionComidas)},_.abrirModalEdicionPrecios=function(){_.clienteEmpresaPreciosComidas={},_.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},_.empresaExternaSeleccionada),_.activeModal=5,_.obtenerPrecioComidas(),_.abrirPopup(_.modalEdicionPrecios)},_.cerrarModalEdicionPrecios=function(){_.activeModal=0,_.clienteEmpresaPreciosComidas={},_.cerrarPopup(_.modalEdicionPrecios)},_.buscarCliente=function(e){if(""!=e&&null!=e)return r(_.usuario.id_empresa,e)},_.abrirdialogClientesComensales=function(){_.abrirPopup(_.dialogClienteEmpresa)},_.cerrardialogClientesComensales=function(){_.cerrarPopup(_.dialogClienteEmpresa)},_.abrirdialogBusquedaComensales=function(){_.activeModal=0,_.abrirPopup(_.busquedaComensalesEmpresa)},_.cerrardialogBusquedaComensales=function(){_.activeModal=0,_.cerrarPopup(_.busquedaComensalesEmpresa)},_.abrirdialogAlertaMarcaciones=function(){_.activeModal=0,_.obtenerAlertas(),_.abrirPopup(_.dialogAlertasMarcaciones)},_.cerrardialogAlertaMarcaciones=function(){_.activeModal=0,_.alertaMarcaciones=[],_.cerrarPopup(_.dialogAlertasMarcaciones)},_.abrirdialogHistorialDocumentos=function(){_.activeModal=0,_.obtenerHistorialDocumentos(),_.abrirPopup(_.dialogHistorialDocumentos)},_.cerrardialogHistorialDocumentos=function(){_.activeModal=0,_.historialesDocumentos=[],_.cerrarPopup(_.dialogHistorialDocumentos)},_.inicio()}]),angular.module("agil.controladores").controller("ControladorCompras",["$scope","$localStorage","$location","$templateCache","$route","blockUI","DatosCompra","$timeout","Compra","Compras","Proveedores","ProveedoresNit","ListaProductosEmpresaUsuario","ClasesTipo","CompraDatos","ConfiguracionCompraVistaDatos","ConfiguracionCompraVista","ConfiguracionesCuentasEmpresa","ClasesTipoEmpresa","Tipos","SaveCompra","ListaCompraPedidosEmpresa","EliminarPedidoEmpresa","EliminarDetallePedidoEmpresa",function(m,e,a,o,i,f,t,r,n,d,s,c,l,u,p,g,v,h,b,C,P,_,M,D){f.start(),m.usuario=JSON.parse(e.usuario),m.idModalPago="dialog-pago",m.idModalWizardCompraEdicion="modal-wizard-compra-edicion",m.idModalWizardCompraVista="modal-wizard-compra-vista",m.idModalEliminarCompra="dialog-eliminar-compra",m.idModalContenedorCompraEdicion="modal-wizard-container-compra-edicion",m.idModalContenedorCompraVista="modal-wizard-container-compra-vista",m.idInputCompletar="nit",m.idModalServicios="dialog-servicios",m.idModalPedidos="dialog-pedidos",m.idModalDetallePedidos="dialog-detalle-pedidos",m.idModalEliminarPedido="dialog-eliminar-pedido",m.idModalEliminarProductoPedido="dialog-eliminar-producto-pedido",m.url=restServer+"/proveedores/empresa/"+m.usuario.id_empresa+"/texto/",m.inicio=function(){m.esContado=!0,m.obtenerProveedores(),m.obtenerTiposDePago(),m.obtenerConfiguracionCompraVista(),m.obtenerCentrosDeCosto(),m.sucursales=m.obtenerSucursales(),m.obtenerCompras(),m.busquedaProductoHabilidato=!1,m.usuario.empresa.usar_funciones_erp&&(m.obtenerMovimientosIngreso(),m.obtenerconfiuracionCuentas()),m.detalleCompra={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1}},m.obtenerconfiuracionCuentas=function(){var e=h(m.usuario.id_empresa);m.plantilla={retencionServicios:{it:{},iue:{},servicio:{}},retencionBienesGasto:{it:{},iue:{},gasto:{}},retencionBienes:{it:{},iue:{},almacen:{}},egreso:{ivacf:{},cajaBanco:{}},ingreso:{ivadf:{},it:{},itPorPagar:{},cajaBanco:{}}},e.then(function(e){e.lista.forEach(function(e){m.diccionario.IVA_DF==e.nombre&&(m.plantilla.ingreso.ivadf={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IT==e.nombre&&(m.plantilla.ingreso.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IT_POR_PAGAR==e.nombre&&(m.plantilla.ingreso.itPorPagar={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.CAJA_BANCOS==e.nombre&&(m.plantilla.ingreso.cajaBanco={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IVA_CF==e.nombre&&(m.plantilla.egreso.ivacf={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.CAJA_BANCOS==e.nombre&&(m.plantilla.egreso.cajaBanco={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IT_RETENCION_BIEN==e.nombre&&(m.plantilla.retencionBienes.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IUE_RETENCION_BIEN==e.nombre&&(m.plantilla.retencionBienes.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.CUENTA_ALMACEN_RETENCION_BIEN==e.nombre&&(m.plantilla.retencionBienes.almacen={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IT_RETENCION_BIEN_GASTO==e.nombre&&(m.plantilla.retencionBienesGasto.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IUE_RETENCION_BIEN_GASTO==e.nombre&&(m.plantilla.retencionBienesGasto.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.CUENTA_GASTO_RETENCION_BIEN==e.nombre&&(m.plantilla.retencionBienesGasto.gasto={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IT_RETENCION_SERVICIO==e.nombre&&(m.plantilla.retencionServicios.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.IUE_RETENCION_SERVICIO==e.nombre&&(m.plantilla.retencionServicios.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),m.diccionario.CUENTA_RETENCION_SERVICIO==e.nombre&&(m.plantilla.retencionServicios.servicio={porsentaje:parseFloat(e.valor),cuenta:e.cuenta})},this)})},m.obtenerConfiguracionCompraVista=function(){f.start(),g(m.usuario.id_empresa).then(function(e){m.configuracionCompraVista=e,f.stop()})},m.guardarConfiguracionCompraVista=function(){v.update({id_empresa:m.usuario.id_empresa},m.configuracionCompraVista,function(e){})},m.obtenerTiposDePago=function(){f.start(),u("TIPA").then(function(e){m.tiposPago=e.clases,f.stop()})},m.obtenerCentrosDeCosto=function(){f.start(),u("CCO").then(function(e){if(m.centrosCosto=e.clases,m.usuario.empresa.usar_funciones_erp){var i=[];m.centrosCosto.forEach(function(e,a,o){"ALM"==e.nombre_corto||"VR"==e.nombre_corto||i.push(a)}),i.reverse().forEach(function(e,a,o){m.centrosCosto.splice(e,1)})}f.stop()})},m.obtenerProveedores=function(){s(m.usuario.id_empresa).then(function(e){for(var a=0;a<e.length;a++)e[a].nit=e[a].nit.toString();m.proveedores=e})},m.modificarCompra=function(e){p(e.id).then(function(e){""!=e.observacion&&(e.usarObservacion=!0),m.compra=e,m.compra.fecha=new Date(m.compra.fecha),m.compra.fechaTexto=m.compra.fecha.getDate()+"/"+(m.compra.fecha.getMonth()+1)+"/"+m.compra.fecha.getFullYear(),null==m.compra.sucursal&&(m.compra.sucursal=e.almacen.sucursal),null==m.compra.movimiento&&(m.compra.movimiento={clase:{}},m.compra.movimiento.clase=m.compra.tipoMovimiento),m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_BIENES||m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_SERVICIOS?(m.configuracionCompraVista.mostrar_it_retencion=!0,m.configuracionCompraVista.mostrar_iue=!0,m.configuracionCompraVista.mostrar_pagado=!0):(m.configuracionCompraVista.mostrar_it_retencion=!1,m.configuracionCompraVista.mostrar_iue=!1,m.configuracionCompraVista.mostrar_pagado=!1),m.obtenerAlmacenes(m.compra.sucursal.id),m.cambiarTipoPago(m.compra.tipoPago),m.usuario.empresa.usar_vencimientos&&m.compra.usar_producto&&m.aplicarFechaTextoDetalleCompra(m.compra),m.abrirPopup(m.idModalWizardCompraEdicion)})},m.aplicarFechaTextoDetalleCompra=function(e){for(var a=0;a<e.detallesCompra.length;a++)"ALM"==e.detallesCompra[a].centroCosto.nombre_corto&&(e.detallesCompra[a].inventario.fecha_vencimiento=new Date(e.detallesCompra[a].inventario.fecha_vencimiento),e.detallesCompra[a].inventario.fechaVencimientoTexto=e.detallesCompra[a].inventario.fecha_vencimiento.getDate()+"/"+(e.detallesCompra[a].inventario.fecha_vencimiento.getMonth()+1)+"/"+e.detallesCompra[a].inventario.fecha_vencimiento.getFullYear())},m.buscarProveedor=function(e){if(""!=e&&null!=e)return c(m.usuario.id_empresa,e)},m.establecerProveedor=function(e){m.compra.proveedor=e},m.buscarProducto=function(e){if(""!=e&&null!=e&&m.busquedaProductoHabilidato)return l(m.usuario.id_empresa,e,m.usuario.id,m.compra.almacen.id)},m.verificarProducto=function(e){e.centroCosto.nombre.nombre==m.diccionario.CENTRO_COSTO_ALMACEN?e.producto.id?(null!=m.compra.movimiento.clase&&m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_BIENES&&(e.descuento=0,e.ice=0,e.recargo=0,e.excento=0,m.configuracionCompraVista.mostrar_it_retencion=!0,m.configuracionCompraVista.mostrar_iue=!0,m.configuracionCompraVista.mostrar_pagado=!0),m.agregarDetalleCompra(e)):m.mostrarMensaje("El producto no se encuentra en el catalogo"):(null!=m.compra.movimiento.clase&&m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_BIENES&&(e.descuento=0,e.ice=0,e.recargo=0,e.excento=0,m.configuracionCompraVista.mostrar_it_retencion=!0,m.configuracionCompraVista.mostrar_iue=!0,m.configuracionCompraVista.mostrar_pagado=!0),m.agregarDetalleCompra(e))},m.verificarServicio=function(e){e.servicio.id?(null!=m.compra.movimiento.clase&&m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_SERVICIOS&&(e.descuento=0,e.ice=0,e.recargo=0,e.excento=0,m.configuracionCompraVista.mostrar_it_retencion=!0,m.configuracionCompraVista.mostrar_iue=!0,m.configuracionCompraVista.mostrar_pagado=!0),m.agregarDetalleCompraServicio(e)):m.mostrarMensaje("El producto no se encuentra en el catalogo")},m.agregarDetalleCompra=function(e){if(e.producto.nombre.id&&(e.producto=e.producto.nombre),e.centroCosto.nombre.id)e.centroCosto=e.centroCosto.nombre;else if(e.centroCosto.nombre==m.diccionario.CENTRO_COSTO_ALMACEN){var a=$.grep(m.centrosCosto,function(e){return e.nombre==m.diccionario.CENTRO_COSTO_ALMACEN})[0];e.centroCosto=a}e.fechaVencimientoTexto&&(e.fecha_vencimiento=new Date(m.convertirFecha(e.fechaVencimientoTexto))),m.compra.detallesCompra.push(e),m.sumarTotal(),m.sumarTotalImporte(),m.compra.descuento_general&&m.calcularImporteGeneral(),m.compra.tipoPago.nombre==m.diccionario.TIPO_PAGO_CREDITO?m.calcularSaldo():(m.compra.a_cuenta=null,m.compra.saldo=null,m.compra.dias_credito=null),m.detalleCompra={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},m.enfocar("centro_costo")},m.agregarDetalleCompraServicio=function(e){m.compra.detallesCompra.push(e),m.sumarTotal(),m.sumarTotalImporte(),m.compra.descuento_general&&m.calcularImporteGeneral(),m.compra.tipoPago.nombre==m.diccionario.TIPO_PAGO_CREDITO?m.calcularSaldo():(m.compra.a_cuenta=null,m.compra.saldo=null,m.compra.dias_credito=null),m.detalleCompra={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},m.enfocar("centro_costo")},m.eliminarDetalleCompra=function(e){m.compra.id?e.eliminado=!0:m.compra.detallesCompra.splice(m.compra.detallesCompra.indexOf(e),1),m.sumarTotal(),m.sumarTotalImporte(),m.compra.descuento_general&&m.calcularImporteGeneral(),m.compra.tipoPago.nombre==m.diccionario.TIPO_PAGO_CREDITO?m.calcularSaldo():(m.compra.a_cuenta=null,m.compra.saldo=null,m.compra.dias_credito=null)},m.cambiarTipoPago=function(a){a=$.grep(m.tiposPago,function(e){return e.id==a.id})[0];m.esContado="CONT"==a.nombre_corto,m.compra.id_tipo_pago=a.id,m.esContado?(m.compra.a_cuenta=null,m.compra.saldo=null,m.compra.dias_credito=null):m.calcularSaldo()},m.recalcular=function(){m.calcularImporteGeneral(),m.calcularImporte()},m.calcularImporteGeneral=function(){var e,a;e=m.compra.tipo_descuento?m.compra.importe*(m.compra.descuento/100):m.compra.descuento,a=m.compra.tipo_recargo?m.compra.importe*(m.compra.recargo/100):m.compra.recargo,m.compra.total=Math.round(1e3*(m.compra.importe-e+a-m.compra.ice-m.compra.excento))/1e3},m.calcularImportePedido=function(e){var a,o;e.importe=Math.round(e.cantidad*e.costo_unitario*1e3)/1e3,m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_BIENES?m.compra.tipo_retencion?e.centroCosto.nombre.nombre==m.diccionario.CENTRO_COSTO_ALMACEN?(e.total=e.importe,e.importe=e.total*(m.plantilla.retencionBienes.it.porsentaje+m.plantilla.retencionBienes.iue.porsentaje)/(100-(m.plantilla.retencionBienes.it.porsentaje+m.plantilla.retencionBienes.iue.porsentaje))+e.total,e.it=e.importe*m.plantilla.retencionBienes.it.porsentaje/100,e.iue=e.importe*m.plantilla.retencionBienes.iue.porsentaje/100):(e.total=e.importe,e.importe=e.total*(m.plantilla.retencionBienesGasto.it.porsentaje+m.plantilla.retencionBienesGasto.iue.porsentaje)/(100-(m.plantilla.retencionBienesGasto.it.porsentaje+m.plantilla.retencionBienesGasto.iue.porsentaje))+e.total,e.it=e.importe*m.plantilla.retencionBienesGasto.it.porsentaje/100,e.iue=e.importe*m.plantilla.retencionBienesGasto.iue.porsentaje/100):e.centroCosto.nombre.nombre==m.diccionario.CENTRO_COSTO_ALMACEN?(e.it=e.importe*m.plantilla.retencionBienes.it.porsentaje/100,e.iue=e.importe*m.plantilla.retencionBienes.iue.porsentaje/100,e.total=e.importe*m.plantilla.retencionBienes.almacen.porsentaje/100):(e.it=e.importe*m.plantilla.retencionBienesGasto.it.porsentaje/100,e.iue=e.importe*m.plantilla.retencionBienesGasto.iue.porsentaje/100,e.total=e.importe*m.plantilla.retencionBienesGasto.gasto.porsentaje/100):m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_IMPORTACION?e.total=e.importe:m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_SERVICIOS?m.compra.tipo_retencion?(e.total=e.importe,e.importe=e.total*(m.plantilla.retencionServicios.it.porsentaje+m.plantilla.retencionServicios.iue.porsentaje)/(100-(m.plantilla.retencionServicios.it.porsentaje+m.plantilla.retencionServicios.iue.porsentaje))+e.total,e.it=e.importe*m.plantilla.retencionServicios.it.porsentaje/100,e.iue=e.importe*m.plantilla.retencionServicios.iue.porsentaje/100):(e.it=e.importe*m.plantilla.retencionServicios.it.porsentaje/100,e.iue=e.importe*m.plantilla.retencionServicios.iue.porsentaje/100,e.total=e.importe*m.plantilla.retencionServicios.servicio.porsentaje/100):m.compra.descuento_general?(a=m.compra.tipo_descuento?e.importe*(m.compra.descuento/100):m.compra.descuento,o=m.compra.tipo_recargo?e.importe*(m.compra.recargo/100):m.compra.recargo,e.total=e.importe-a+o-m.compra.ice-m.compra.excento):(a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,o=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+o-e.ice-e.excento)},m.calcularImporte=function(){var e,a;m.detalleCompra.importe=Math.round(m.detalleCompra.cantidad*m.detalleCompra.costo_unitario*1e3)/1e3,m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_BIENES?m.compra.tipo_retencion?m.detalleCompra.centroCosto.nombre.nombre==m.diccionario.CENTRO_COSTO_ALMACEN?(m.detalleCompra.total=m.detalleCompra.importe,m.detalleCompra.importe=m.detalleCompra.total*(m.plantilla.retencionBienes.it.porsentaje+m.plantilla.retencionBienes.iue.porsentaje)/(100-(m.plantilla.retencionBienes.it.porsentaje+m.plantilla.retencionBienes.iue.porsentaje))+m.detalleCompra.total,m.detalleCompra.it=m.detalleCompra.importe*m.plantilla.retencionBienes.it.porsentaje/100,m.detalleCompra.iue=m.detalleCompra.importe*m.plantilla.retencionBienes.iue.porsentaje/100):(m.detalleCompra.total=m.detalleCompra.importe,m.detalleCompra.importe=m.detalleCompra.total*(m.plantilla.retencionBienesGasto.it.porsentaje+m.plantilla.retencionBienesGasto.iue.porsentaje)/(100-(m.plantilla.retencionBienesGasto.it.porsentaje+m.plantilla.retencionBienesGasto.iue.porsentaje))+m.detalleCompra.total,m.detalleCompra.it=m.detalleCompra.importe*m.plantilla.retencionBienesGasto.it.porsentaje/100,m.detalleCompra.iue=m.detalleCompra.importe*m.plantilla.retencionBienesGasto.iue.porsentaje/100):m.detalleCompra.centroCosto.nombre.nombre==m.diccionario.CENTRO_COSTO_ALMACEN?(m.detalleCompra.it=m.detalleCompra.importe*m.plantilla.retencionBienes.it.porsentaje/100,m.detalleCompra.iue=m.detalleCompra.importe*m.plantilla.retencionBienes.iue.porsentaje/100,m.detalleCompra.total=m.detalleCompra.importe*m.plantilla.retencionBienes.almacen.porsentaje/100):(m.detalleCompra.it=m.detalleCompra.importe*m.plantilla.retencionBienesGasto.it.porsentaje/100,m.detalleCompra.iue=m.detalleCompra.importe*m.plantilla.retencionBienesGasto.iue.porsentaje/100,m.detalleCompra.total=m.detalleCompra.importe*m.plantilla.retencionBienesGasto.gasto.porsentaje/100):m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_IMPORTACION?m.detalleCompra.total=m.detalleCompra.importe:m.compra.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_SERVICIOS?m.compra.tipo_retencion?(m.detalleCompra.total=m.detalleCompra.importe,m.detalleCompra.importe=m.detalleCompra.total*(m.plantilla.retencionServicios.it.porsentaje+m.plantilla.retencionServicios.iue.porsentaje)/(100-(m.plantilla.retencionServicios.it.porsentaje+m.plantilla.retencionServicios.iue.porsentaje))+m.detalleCompra.total,m.detalleCompra.it=m.detalleCompra.importe*m.plantilla.retencionServicios.it.porsentaje/100,m.detalleCompra.iue=m.detalleCompra.importe*m.plantilla.retencionServicios.iue.porsentaje/100):(m.detalleCompra.it=m.detalleCompra.importe*m.plantilla.retencionServicios.it.porsentaje/100,m.detalleCompra.iue=m.detalleCompra.importe*m.plantilla.retencionServicios.iue.porsentaje/100,m.detalleCompra.total=m.detalleCompra.importe*m.plantilla.retencionServicios.servicio.porsentaje/100):m.compra.descuento_general?(e=m.compra.tipo_descuento?m.detalleCompra.importe*(m.compra.descuento/100):m.compra.descuento,a=m.compra.tipo_recargo?m.detalleCompra.importe*(m.compra.recargo/100):m.compra.recargo,m.detalleCompra.total=m.detalleCompra.importe-e+a-m.compra.ice-m.compra.excento):(e=m.detalleCompra.tipo_descuento?m.detalleCompra.importe*(m.detalleCompra.descuento/100):m.detalleCompra.descuento,a=m.detalleCompra.tipo_recargo?m.detalleCompra.importe*(m.detalleCompra.recargo/100):m.detalleCompra.recargo,m.detalleCompra.total=m.detalleCompra.importe-e+a-m.detalleCompra.ice-m.detalleCompra.excento)},m.calcularImporteDetalleEdicion=function(e){var a,o;e.importe=Math.round(e.cantidad*e.costo_unitario*1e3)/1e3,a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,o=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+o-e.ice-e.excento,m.sumarTotal(),m.sumarTotalImporte(),m.compra.descuento_general&&m.calcularImporteGeneral(),m.compra.tipoPago.nombre==m.diccionario.TIPO_PAGO_CREDITO?m.calcularSaldo():(m.compra.a_cuenta=null,m.compra.saldo=null,m.compra.dias_credito=null)},m.sumarMonto=function(e){for(var a=0,o=0;o<e.length;o++)a+=e[o].total;return Math.round(100*a)/100},m.sumarTotalImporte=function(){for(var e=0,a=0;a<m.compra.detallesCompra.length;a++)m.compra.detallesCompra[a].eliminado||(e+=m.compra.detallesCompra[a].importe);m.compra.importe=Math.round(1e3*e)/1e3},m.sumarTotal=function(){for(var e=0,a=0;a<m.compra.detallesCompra.length;a++)m.compra.detallesCompra[a].eliminado||(e+=m.compra.detallesCompra[a].total);m.compra.total=Math.round(1e3*e)/1e3},m.calcularSaldo=function(){m.compra.saldo=m.compra.total-m.compra.a_cuenta},m.obtenerSucursales=function(){for(var e=[],a=0;a<m.usuario.sucursalesUsuario.length;a++)e.push(m.usuario.sucursalesUsuario[a].sucursal);return e},m.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},m.enfocar=function(e){r(function(){$("#"+e).focus()},0)},m.interceptarTecla=function(e,a,o){13===e.which&&(o?m.enfocar(a):r(function(){$("#"+a).trigger("click")},0))},m.obtenerMovimientosIngreso=function(e){f.start(),u("MOVING").then(function(e){m.movimientosIngreso=e.clases;var i=[];m.movimientosIngreso.forEach(function(e,a,o){e.nombre!==m.diccionario.MOVING_INVENTARIO_INICIAL&&e.nombre!==m.diccionario.MOVING_POR_TRASPASO&&e.nombre!==m.diccionario.MOVING_POR_DEVOLUCION&&e.nombre!==m.diccionario.MOVING_POR_AJUSTE||i.push(a)}),i.reverse().forEach(function(e){m.movimientosIngreso.splice(e,1)}),f.stop()})},m.verificarMomivmiento=function(e){e.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_SERVICIOS?e.usar_producto=!1:e.movimiento.clase.nombre==m.diccionario.MOVING_POR_RETENCION_BIENES?e.usar_producto=!0:e.movimiento.clase.nombre==m.diccionario.MOVING_POR_IMPORTACION&&(e.factura=0,e.autorizacion=3,e.codigo_control=0,e.descuento_general=!1,e.usar_producto=!0)},m.obtenerAlmacenes=function(a){m.almacenes=[];var e=$.grep(m.sucursales,function(e){return e.id==a})[0];m.almacenes=e.almacenes,null==m.compra.id&&(m.compra.almacen=1==m.almacenes.length?m.almacenes[0]:null)},m.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsCompra(m.idModalWizardCompraEdicion,m.idModalWizardCompraVista,m.idModalEliminarCompra,m.idModalContenedorCompraEdicion,m.idModalContenedorCompraVista,m.idInputCompletar,m.url,m.idModalPago,m.idModalServicios,m.idModalPedidos,m.idModalDetallePedidos,m.idModalEliminarPedido,m.idModalEliminarProductoPedido),m.buscarAplicacion(m.usuario.aplicacionesUsuario,a.path().substring(1)),$("#formularioCompra").ketchup({validateEvents:"blur focus keyup change submit"}),f.stop()}),m.formatearCodigoControl=function(e){for(var a="",o=0;o<e.length;o++)o%2==0&&(a+=e.substring(o,o+2),2<e.length-o&&(a+="-"));return a},m.obtenerCompras=function(){m.sucursalesUsuario="";for(var e=0;e<m.usuario.sucursalesUsuario.length;e++)m.sucursalesUsuario=m.sucursalesUsuario+m.usuario.sucursalesUsuario[e].sucursal.id,e+1!=m.usuario.sucursalesUsuario.length&&(m.sucursalesUsuario=m.sucursalesUsuario+",");var a=new Date,o=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear();m.filtrarCompras(m.sucursalesUsuario,o,o)},m.filtrarCompras=function(e,a,o,i,t,r,n,s,c,l){i=""==i||null==i?0:i,t=null==t||null==t?0:t,r=null==r||null==r?0:r,n=null==n?0:n,l=null==l?0:l,s=null==s||null==s?0:s,c=0<$.grep(m.usuario.rolesUsuario,function(e){return e.rol.nombre==m.diccionario.ROL_ADMINISTRADOR}).length?""==c||null==c?0:c:m.usuario.nombre_usuario,f.start(),a=new Date(m.convertirFecha(a)),o=new Date(m.convertirFecha(o)),d(e,a,o,i,t,r,n,s,c,m.usuario.id,l).then(function(e){m.compras=e,f.stop()})},m.abrirPopupPago=function(e){m.compra=e,m.pago=null,m.abrirPopup(m.idModalPago)},m.cerrarPopupPago=function(){m.cerrarPopup(m.idModalPago)},m.abrirDialogServicios=function(e){m.tipo_edicion=e,m.clase={},m.abrirPopup(m.idModalServicios)},m.cerrarDialogServicios=function(){m.cerrarPopup(m.idModalServicios)},m.abrirDialogPedidos=function(){m.obtenerPedidosEmpresa(),m.abrirPopup(m.idModalPedidos)},m.cerrarDialogPedidos=function(){m.cerrarPopup(m.idModalPedidos)},m.abrirDialogDetallePedidos=function(e){m.pedido=e,m.cerrarDialogPedidos(),m.obtenerAlmacenes(e.sucursal.id),m.compra.proveedor=e.proveedor,m.compra.almacen=e.almacen,m.compra.sucursal=e.sucursal,m.pedido.detallesPedido.forEach(function(e){var a=0;0<e.producto.inventarios.length&&(a=e.producto.inventarios[e.producto.inventarios.length-1].costo_unitario?e.producto.inventarios[e.producto.inventarios.length-1].costo_unitario:0),e.producto.costoanterior=a,m.establecerProductoPedido(e,e.producto,a)}),m.abrirPopup(m.idModalDetallePedidos)},m.guardarDetalleCompraDePedido=function(e){m.compra.generado_por_pedido=!0,m.compra.pedido=m.pedido,e.forEach(function(e){1!=e.eliminado&&m.verificarProducto(e.detalleCompra)}),m.cerrarDialogDetallePedidos()},m.establecerProductoPedido=function(i,t,r){t.tipoProducto=null==t.tipoProducto?{id:t["tipoProducto.id"],nombre:t["tipoProducto.nombre"],nombre_corto:t["tipoProducto.nombre_corto"]}:t.tipoProducto;var n={};m.centrosCosto.forEach(function(e,a,o){"ALM"==e.nombre_corto&&(n=e),a===o.length-1&&(i.detalleCompra={centroCosto:n,producto:t,costo_unitario:r,cantidad:1,descuento:t.descuento,recargo:0,ice:0,excento:0,tipo_descuento:0<t.descuento,tipo_recargo:!1})}),m.cerrarPopup(m.idModalInventario),m.enfocar("cantidad")},m.cerrarDialogDetallePedidos=function(){m.cerrarPopup(m.idModalDetallePedidos)},m.cerrarDialogEliminarPedido=function(){m.cerrarPopup(m.idModalEliminarPedido)},m.abrirDialogEliminarPedido=function(e){m.pedido=e,m.abrirPopup(m.idModalEliminarPedido)},m.cerrarDialogEliminarDetallePedido=function(){m.cerrarPopup(m.idModalEliminarProductoPedido)},m.abrirDialogEliminarDetallePedido=function(e){m.detalle=e,m.abrirPopup(m.idModalEliminarProductoPedido)},m.obtenerPedidosEmpresa=function(){_(m.usuario.id_empresa).then(function(e){m.pedidos=e.pedidos})},m.obtenerServicios=function(){f.start(),b("SERVICIOS_COMPRA",m.usuario.id_empresa).then(function(e){m.datosServicios=e,f.stop()})},m.agregarConceptoEdicion=function(e){e.nombre&&e.nombre_corto&&(-1==m.tipo_edicion.clases.indexOf(e)&&m.tipo_edicion.clases.push(e),m.clase={})},m.modificarConceptoEdicion=function(e){m.clase=e},m.removerConceptoEdicion=function(e){e.eliminado=!0},m.guardarConceptoEdicion=function(a){f.start(),C.update({id_tipo:a.id},a,function(e){u(a.nombre_corto).then(function(e){a=e,f.stop(),m.cerrarDialogServicios(),m.mostrarMensaje("Guardado Exitosamente!")})})},m.efectuarPago=function(a){f.start(),n.update({id:m.compra.id},{pago:a,id_usuario_cajero:m.usuario.id},function(e){m.mostrarMensaje(e.mensaje),m.cerrarPopup(m.idModalPago),m.obtenerCompras(),m.imprimirRecibo(e,e.compra,a),f.stop()},function(e){m.mostrarMensaje(e),m.cerrarPopup(m.idModalPago),m.obtenerCompras(),f.stop()})},m.imprimirRecibo=function(e,a,o){f.start();var i=new PDFDocument({size:[227,353],margin:10}),t=i.pipe(blobStream());i.moveDown(2),i.font("Helvetica-Bold",8),i.text(m.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),i.moveDown(.4),i.font("Helvetica",7),i.text(a.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),i.moveDown(.4),i.text(a.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),i.moveDown(.4);var r=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");i.text("TELF.: "+r,{align:"center"}),i.moveDown(.4),i.text("COCHABAMBA - BOLIVIA",{align:"center"}),i.moveDown(.5),i.font("Helvetica-Bold",8),i.text("PAGO",{align:"center"}),i.font("Helvetica",7),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.moveDown(.4),i.text(a.almacen.sucursal.nota_recibo_correlativo,{align:"center"}),i.moveDown(.4),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.moveDown(.6);var n=new Date;i.text("FECHA : "+n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear(),{align:"left"}),i.moveDown(.4),i.text("Pagado a : "+m.compra.proveedor.razon_social,{align:"left"}),i.moveDown(.4),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.2),i.text("       CONCEPTO                                   ",{align:"left"}),i.moveDown(.2),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.4),a.fecha=new Date(a.fecha),i.text("Fecha: "+a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear(),15,210);var s=m.compra.factura;i.text(s,105,210,{width:100}),i.text("Bs "+o+".-",170,210,{width:100}),i.text("--------------",10,230,{align:"right"}),i.moveDown(.3),i.text("TOTAL Bs.              "+o.toFixed(2),{align:"right"}),i.moveDown(.4),i.moveDown(.4),i.text("SON: "+e.pago,{align:"left"}),i.moveDown(.6),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.text("-------------------------                       -------------------------",{align:"center"}),i.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()},m.establecerCentroCosto=function(e){console.log(e),(e.nombre?e.nombre:e)==m.diccionario.CENTRO_COSTO_ALMACEN?m.busquedaProductoHabilidato=!0:m.busquedaProductoHabilidato=!1},m.crearNuevaCompra=function(){m.obtenerServicios(),m.verDescuento=!1,m.compra=new n({generado_por_pedido:!1,usar_producto:!0,movimiento:{clase:{}},tipo_retencion:!0,id_empresa:m.usuario.id_empresa,id_usuario:m.usuario.id,proveedor:{},id_tipo_pago:m.tiposPago[0].id,tipoPago:m.tiposPago[0],detallesCompra:[],descuento_general:!1,tipo_descuento:!1,codigo_control:0,autorizacion:0,tipo_recargo:!1,descuento:0,recargo:0,ice:0,excento:0}),m.usuario.empresa.usar_funciones_erp&&(m.compra.movimiento.clase=m.movimientosIngreso[0]),m.compra.sucursal=1==m.sucursales.length?m.sucursales[0]:null,m.compra.sucursal&&m.obtenerAlmacenes(m.compra.sucursal.id);var e=new Date;m.compra.fechaTexto=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear(),m.abrirPopup(m.idModalWizardCompraEdicion),m.enfocar("nit")},m.verCompra=function(e){m.compra=e,m.abrirPopup(m.idModalWizardCompraVista)},m.cerrarPopupVista=function(){m.cerrarPopup(m.idModalWizardCompraVista)},m.cerrarPopupEdicion=function(){m.ocultarMensajesValidacion(),m.cerrarPopup(m.idModalWizardCompraEdicion)},m.verificarDescuentos=function(e){for(var a=!1,o=0;o<e.length;o++)(0<e[o].descuento||0<e[o].recargo||0<e[o].ice||0<e[o].excento)&&(a=!0);return a},m.dibujarCabeceraImpresionCompra=function(e,a,o,i,t){100<m.usuario.empresa.imagen.length&&e.image(m.usuario.empresa.imagen,60,50,{width:50,height:50}),e.font("Helvetica-Bold",8),e.text(m.usuario.empresa.razon_social.toUpperCase(),60,105),e.font("Helvetica",7),e.text(a.sucursal.nombre.toUpperCase(),60,113),e.text(a.sucursal.direccion.toUpperCase(),60,121);var r=(null!=a.sucursal.telefono1?a.sucursal.telefono1:"")+(null!=a.sucursal.telefono2?"-"+a.sucursal.telefono2:"")+(null!=a.sucursal.telefono3?"-"+a.sucursal.telefono3:"");e.text("TELF.: "+r,60,129),e.text("COCHABAMBA - BOLIVIA",60,137),e.font("Helvetica-Bold",16),e.text("NOTA DE COMPRA",150,50),e.font("Helvetica-Bold",8),e.rect(380,50,190,50).stroke(),e.text("NIT : ",390,60),e.text("FACTURA No : ",390,70),e.text("AUTORIZACIÓN No : ",390,80),e.text(m.usuario.empresa.nit,500,60),e.text(a.factura,500,70),e.text(a.autorizacion,500,80),e.rect(50,150,540,50).stroke(),e.text("FECHA : ",60,165),e.text("SEÑOR(ES) : ",60,175),e.text("NIT : ",360,165),e.text(a.fechaTexto,120,165),e.text(a.proveedor.razon_social,120,175),e.text(a.proveedor.nit,400,165),e.rect(50,200,540,25).stroke(),e.rect(50,225,540,449).stroke(),t?m.usuario.empresa.usar_vencimientos?(e.font("Helvetica-Bold",7),e.text("CODIGO",55,210),e.text("CANT.",105,210),e.text("UNID.",135,210),e.text("DETALLE",170,210),e.text("P. UNIT.",280,210),e.text("IMPORTE",315,210),e.text("DESC.",365,210),e.text("REC.",395,210),e.text("ICE",425,210),e.text("EXC.",455,210),e.text("F. VENC.",485,210,{width:50}),e.text("LOTE",525,210),e.text("TOTAL",555,210)):(e.font("Helvetica-Bold",8),e.text("CODIGO",55,210),e.text("CANT.",105,210),e.text("UNID.",135,210),e.text("DETALLE",170,210),e.text("P. UNIT.",300,210),e.text("IMPORTE",335,210),e.text("DESC.",385,210),e.text("REC.",420,210),e.text("ICE",455,210),e.text("EXC.",490,210),e.text("TOTAL",520,210)):(e.font("Helvetica-Bold",8),e.text("CODIGO",55,210),e.text("CANT.",135,210),e.text("UNID.",165,210),m.usuario.empresa.usar_vencimientos?(e.text("DETALLE",210,210),e.text("FECHA VENC.",400,205,{width:50}),e.text("LOTE",450,210)):e.text("DETALLE",210,210),e.text("P.UNIT.",495,210),e.text("TOTAL",540,210)),e.font("Helvetica",6);var n=new Date;e.text("Usuario: "+m.usuario.nombre_usuario+"   Fecha:"+n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear()+"   Hr:"+n.getHours()+":"+n.getMinutes(),50,750)},m.imprimirCompra=function(p){t(p.id,m.usuario.id_empresa).then(function(e){(p=e.compra).sucursal=e.sucursal,p.numero_literal=e.numero_literal,p.fecha=new Date(p.fecha),p.fechaTexto=p.fecha.getDate()+"/"+(p.fecha.getMonth()+1)+"/"+p.fecha.getFullYear(),p.configuracion=e.configuracion;var a=new PDFDocument({size:[612,792],margin:10}),o=a.pipe(blobStream()),i=240,t=0,r=0,n=1,s=Math.ceil(p.detallesCompra.length/15),c=m.verificarDescuentos(p.detallesCompra);m.dibujarCabeceraImpresionCompra(a,p,n,s,c);i=240;for(var l=0;l<p.detallesCompra.length;l++){if(c)if(m.usuario.empresa.usar_vencimientos){a.font("Helvetica",7);var d=(u=p.detallesCompra[l].producto.codigo.length)<=11?i:11<u&&u<=22?i-4:i-11;p.detallesCompra[l].producto&&a.text(p.detallesCompra[l].producto.codigo,55,d,{width:50}),a.text(p.detallesCompra[l].cantidad,110,i),p.detallesCompra[l].producto&&a.text(p.detallesCompra[l].producto.unidad_medida,135,i),p.detallesCompra[l].producto?a.text(p.detallesCompra[l].producto.nombre,170,i-6,{width:130}):a.text(p.detallesCompra[l].servicio.nombre,170,i-6,{width:130}),a.text(p.detallesCompra[l].costo_unitario.toFixed(2),280,i),a.text(p.detallesCompra[l].importe.toFixed(2),315,i),a.text(p.detallesCompra[l].tipo_descuento?"%":"Bs",365,i-10),a.text(p.detallesCompra[l].descuento.toFixed(2),365,i),a.text(p.detallesCompra[l].tipo_recargo?"%":"Bs",395,i-10),a.text(p.detallesCompra[l].recargo.toFixed(2),395,i),a.text(p.detallesCompra[l].ice.toFixed(2),425,i),a.text(p.detallesCompra[l].excento.toFixed(2),455,i),a.text(p.detallesCompra[l].total.toFixed(2),555,i),p.detallesCompra[l].inventario&&(p.detallesCompra[l].inventario.fecha_vencimiento=new Date(p.detallesCompra[l].inventario.fecha_vencimiento),p.detallesCompra[l].inventario.fechaVencimientoTexto=p.detallesCompra[l].inventario.fecha_vencimiento.getDate()+"/"+(p.detallesCompra[l].inventario.fecha_vencimiento.getMonth()+1)+"/"+p.detallesCompra[l].inventario.fecha_vencimiento.getYear(),a.text(p.detallesCompra[l].inventario.fechaVencimientoTexto,485,i),a.text(p.detallesCompra[l].inventario.lote?p.detallesCompra[l].inventario.lote:"",525,i))}else{a.font("Helvetica",8);d=(u=p.detallesCompra[l].producto.codigo.length)<=11?i:11<u&&u<=22?i-4:i-11;p.detallesCompra[l].producto&&a.text(p.detallesCompra[l].producto.codigo,55,d,{width:70}),a.text(p.detallesCompra[l].cantidad,110,i),p.detallesCompra[l].producto&&a.text(p.detallesCompra[l].producto.unidad_medida,135,i),p.detallesCompra[l].producto?a.text(p.detallesCompra[l].producto.nombre,170,i-6,{width:130}):a.text(p.detallesCompra[l].servicio.nombre,170,i-6,{width:130}),a.text(p.detallesCompra[l].costo_unitario.toFixed(2),300,i),a.text(p.detallesCompra[l].importe.toFixed(2),335,i),a.text(p.detallesCompra[l].tipo_descuento?"%":"Bs",385,i-10),a.text(p.detallesCompra[l].descuento.toFixed(2),385,i),a.text(p.detallesCompra[l].tipo_recargo?"%":"Bs",420,i-10),a.text(p.detallesCompra[l].recargo.toFixed(2),420,i),a.text(p.detallesCompra[l].ice.toFixed(2),455,i),a.text(p.detallesCompra[l].excento.toFixed(2),490,i),a.text(p.detallesCompra[l].total.toFixed(2),520,i)}else{if(a.font("Helvetica",8),p.detallesCompra[l].producto&&a.text(p.detallesCompra[l].producto.codigo,55,i,{width:70}),a.text(p.detallesCompra[l].cantidad,140,i),p.detallesCompra[l].producto&&a.text(p.detallesCompra[l].producto.unidad_medida,160,i),p.detallesCompra[l].producto)d=(u=p.detallesCompra[l].producto.nombre.length)<=45?i:45<u&&u<=90?i-4:i-11;else{var u;d=(u=p.detallesCompra[l].servicio.nombre.length)<=45?i:45<u&&u<=90?i-4:i-11}m.usuario.empresa.usar_vencimientos?(p.detallesCompra[l].inventario&&(p.detallesCompra[l].inventario.fecha_vencimiento=new Date(p.detallesCompra[l].inventario.fecha_vencimiento),p.detallesCompra[l].inventario.fechaVencimientoTexto=p.detallesCompra[l].inventario.fecha_vencimiento.getDate()+"/"+(p.detallesCompra[l].inventario.fecha_vencimiento.getMonth()+1)+"/"+p.detallesCompra[l].inventario.fecha_vencimiento.getFullYear(),a.text(p.detallesCompra[l].inventario.fechaVencimientoTexto,400,i),a.text(p.detallesCompra[l].inventario.lote,460,i)),p.detallesCompra[l].producto?a.text(p.detallesCompra[l].producto.nombre,210,d-11.5,{width:185}):a.text(p.detallesCompra[l].servicio.nombre,210,d-11.5,{width:185})):p.detallesCompra[l].producto?a.text(p.detallesCompra[l].producto.nombre,210,d-11.5,{width:225}):a.text(p.detallesCompra[l].servicio.nombre,210,d-11.5,{width:185}),a.text(p.detallesCompra[l].costo_unitario.toFixed(2),500,i),a.text(p.detallesCompra[l].total.toFixed(2),540,i)}a.rect(50,i-15,540,30).stroke(),i+=30,15==++r&&(t+=r)!=p.detallesCompra.length&&(a.addPage({size:[612,792],margin:10}),i=240,r=0,n+=1,m.dibujarCabeceraImpresionCompra(a,p,n,s,c))}a.font("Helvetica-Bold",8),a.text("TOTAL",455,695),a.font("Helvetica",8),a.text(p.total.toFixed(2),520,695),a.text("SON : "+p.numero_literal,55,695),a.text("CÓDIGO DE CONTROL : "+p.codigo_control,55,730),a.rect(50,685,540,30).stroke(),a.rect(50,720,400,20).stroke(),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()})},m.guardarCompra=function(e,a){if(e){m.ocultarMensajesValidacion(),a.proveedor.nit.id&&(a.proveedor=a.proveedor.nit),a.usar_peps=m.usuario.empresa.usar_peps;var o=new Date;if(a.fecha=new Date(m.convertirFecha(a.fechaTexto)),a.fecha.setHours(o.getHours()),a.fecha.setMinutes(o.getMinutes()),a.fecha.setSeconds(o.getSeconds()),f.start(),a.id)a.esModificacion=!0,n.update({id:a.id},a,function(e){f.stop(),m.cerrarPopPupEdicion(),m.mostrarMensaje(e.mensaje),m.recargarItemsTabla()});else P(a).then(function(e){m.cerrarPopPupEdicion(),m.mostrarMensaje(e.mensaje),m.recargarItemsTabla(),e.compra&&m.imprimirCompra(e.compra)})}},m.establecerProducto=function(e){e.tipoProducto=null==e.tipoProducto?{id:e["tipoProducto.id"],nombre:e["tipoProducto.nombre"],nombre_corto:e["tipoProducto.nombre_corto"]}:e.tipoProducto;var a=m.detalleCompra.centroCosto;m.precio_inventario,0<e.inventarios.length?m.precio_inventario=e.inventarios.pop().costo_unitario+" Bs":m.precio_inventario="Sin histórico",m.detalleCompra={centroCosto:a,producto:e,precio_unitario:e.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:0<e.descuento,tipo_recargo:!1},m.cerrarPopup(m.idModalInventario),m.enfocar("cantidad")},m.verDescuentosPedido=function(){m.verDescuento=0==m.verDescuento},m.establecerServicioSeleccionado=function(e){m.establecerServicio(e),m.cerrarDialogServicios()},m.establecerServicio=function(e){e.tipoProducto=null==e.tipoProducto?{id:e["tipoProducto.id"],nombre:e["tipoProducto.nombre"],nombre_corto:e["tipoProducto.nombre_corto"]}:e.tipoProducto;m.detalleCompra.centroCosto;m.detalleCompra={centroCosto:null,servicio:e,precio_unitario:e.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},m.cerrarPopup(m.idModalInventario),m.enfocar("cantidad")},m.cerrarPopPupEdicion=function(){m.cerrarPopup(m.idModalWizardCompraEdicion)},m.generarCompraDePedido=function(e){e.detallesPedido.forEach(function(e,a,o){})},m.EliminarPedido=function(e){M(e.id).then(function(e){m.mostrarMensaje(e.mensaje),m.obtenerPedidosEmpresa(),m.cerrarDialogEliminarPedido()})},m.EliminarPedidoDetalle=function(e){e.eliminado=!0,D(e.id).then(function(e){m.mostrarMensaje(e.mensaje),m.cerrarDialogEliminarDetallePedido()})},m.$on("$routeChangeStart",function(e,a){m.eliminarPopup(m.idModalWizardCompraEdicion),m.eliminarPopup(m.idModalWizardCompraVista),m.eliminarPopup(m.idModalEliminarCompra),m.eliminarPopup(m.idModalPago),m.eliminarPopup(m.idModalServicios),m.eliminarPopup(m.idModalPedidos),m.eliminarPopup(m.idModalDetallePedidos),m.eliminarPopup(m.idModalEliminarPedido),m.eliminarPopup(m.idModalEliminarProductoPedido)}),m.inicio()}]),angular.module("agil.controladores").controller("ControladorComprobanteContabilidad",["$scope","blockUI","$localStorage","$location","$templateCache","$window","CuentasPaginador","ContabilidadCuenta","CuentasClasificaciones","ClasesTipo","lasClasificaciones","losSaldos","losMovimientos","losTiposDeCuentas","lasOperacionesCalculos","CuentaContabilidad",function(a,e,o,i,t,r,n,s,c,l,d,u,p,m,f,g){a.usuario=JSON.parse(o.usuario),a.inicio=function(){a.sucursalesUsuario="";for(var e=0;e<a.usuario.sucursalesUsuario.length;e++)a.sucursalesUsuario=a.sucursalesUsuario+a.usuario.sucursalesUsuario[e].sucursal.id,e+1!=a.usuario.sucursalesUsuario.length&&(a.sucursalesUsuario=a.sucursalesUsuario+",")},a.obtenerComprobantes=function(){a.comprobantes=ListaComprobanteContabilidad(a.usuario.id)}}]),angular.module("agil.controladores").controller("ControladorConfiguracionesApp",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ConfiguracionesApp","ConfiguracionGeneralAppDato","ClasesTipo","ConfiguracionAppVendedor","ConfiguracionAppEmpresa",function(o,e,a,i,t,r,n,s,c,l,d){r.start(),o.idModalWizardConfiguracionEdicion="modal-wizard-configuracion-edicion",o.idModalWizardConfiguracionGeneralEdicion="modal-wizard-configuracion-general-edicion",o.idModalContenedorConfiguracionEdicion="modal-wizard-container-configuracion-edicion",o.idModalContenedorConfiguracionGeneralEdicion="modal-wizard-container-configuracion-general-edicion",o.usuario=JSON.parse(e.usuario),o.obtenerTiposVenta=function(){r.start(),c("MEA").then(function(e){o.tiposVenta=e.clases,r.stop()})},o.obtenerCobros=function(){r.start(),c("COA").then(function(e){o.cobros=e.clases,r.stop()})},o.obtenerTiposPago=function(){r.start(),c("TPA").then(function(e){o.tiposPago=e.clases,r.stop()})},o.obtenerListadoProductos=function(){r.start(),c("LPA").then(function(e){o.listadoProductos=e.clases,r.stop()})},o.obtenerConfiguracionesApp=function(){r.start(),n(o.usuario.id_empresa).then(function(e){o.vendedores=e,r.stop()})},o.obtenerConfiguracionGeneralApp=function(){r.start(),s(o.usuario.id_empresa).then(function(e){o.configuracion_general=e,r.stop()})},o.$on("$routeChangeStart",function(e,a){o.eliminarPopup(o.idModalWizardConfiguracionEdicion),o.eliminarPopup(o.idModalWizardConfiguracionGeneralEdicion)}),o.inicio=function(){o.obtenerConfiguracionesApp(),o.obtenerConfiguracionGeneralApp(),o.obtenerTiposVenta(),o.obtenerCobros(),o.obtenerTiposPago(),o.obtenerListadoProductos(),setTimeout(function(){ejecutarScriptsTabla("tabla-configuraciones",8),ejecutarScriptsTabla("tabla-configuracion-general",8)},2e3)},o.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsConfiguracionApp(o.idModalWizardConfiguracionEdicion,o.idModalContenedorConfiguracionEdicion,o.idModalWizardConfiguracionGeneralEdicion,o.idModalContenedorConfiguracionGeneralEdicion),o.buscarAplicacion(o.usuario.aplicacionesUsuario,a.path().substring(1)),r.stop()}),o.cerrarPopPupEdicion=function(){o.cerrarPopup(o.idModalWizardConfiguracionEdicion)},o.cerrarPopPupEdicionGeneral=function(){o.cerrarPopup(o.idModalWizardConfiguracionGeneralEdicion)},o.modificarConfiguracionVendedor=function(e){o.vendedor=e,o.abrirPopup(o.idModalWizardConfiguracionEdicion)},o.modificarConfiguracionGeneralApp=function(e){o.abrirPopup(o.idModalWizardConfiguracionGeneralEdicion)},o.guardarConfiguracion=function(e){"Siguiente"!=$("#siguiente").text().trim()&&(r.start(),l.update({id_configuracion:e.configuracionVendedorApp.id},e.configuracionVendedorApp,function(e){r.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje(e.mensaje),o.recargarItemsTabla()}))},o.guardarConfiguracionGeneral=function(e){"Siguiente"!=$("#siguiente-g").text().trim()&&(r.start(),d.update({id_configuracion:e.id},e,function(e){r.stop(),o.cerrarPopPupEdicionGeneral(),o.mostrarMensaje(e.mensaje),o.recargarItemsTabla()}))},o.inicio()}]),angular.module("agil.controladores").controller("ControladorContabilidadCuenta",["$scope","blockUI","$localStorage","$location","$templateCache","$window","CuentasPaginador","ContabilidadCuenta","CuentasClasificaciones","ClasesTipo","lasClasificaciones","losSaldos","losMovimientos","losTiposDeCuentas","lasOperacionesCalculos","CuentaContabilidad","Paginator","CuentasEmpresaCreacion","ClientesNit","ProveedoresNit","$timeout","Tipos","ConfiguracionCuentaEmpresa","ListaContabilidadCuentas","ListaCuentasComprobanteContabilidad","ConfiguracionCuentas","CuentasClasificacionesEdicion","Diccionario","VistaColumnasAplicacion","FieldViewer","ValidarCodigoCuenta","ClaseTexto","ClasesTipoEmpresa",function(c,l,e,a,o,i,t,r,n,s,d,u,p,m,f,g,v,h,b,C,P,_,M,D,E,x,S,A,T,w,I,R,j){c.usuario=JSON.parse(e.usuario),c.idModalWizardCuentaEdicion="modal-wizard-cuenta-edicion",c.idModalWizardContainerCuentaEdicion="modal-wizard-container-cuenta-edicion",c.idModalWizardCuentaVer="modal-wizard-cuenta-ver",c.idModalWizardContainerCuentaVer="modal-wizard-container-cuenta-ver",c.idModalWizardClasificacionNueva="modal-wizard-agregar-clasificacion-cuenta",c.idModalWizardClasificacionVer="modal-wizard-ver-clasificacion",c.idModalWizardContainerClasificacionNueva="modal-wizard-container-agregar-clasificacion",c.idModalEliminarCuenta="dialog-eliminar-cuenta",c.idModalWizardPlantillaIngreso="modal-wizard-plantilla-ingreso",c.idModalWizardConceptoEdicion="modal-wizard-concepto-edicion",c.idModalWizardClasificacionEdicion="modal-wizard-clasificacion-edicion",c.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsContabilidadCuentas(c.idModalWizardCuentaEdicion,c.idModalWizardContainerCuentaEdicion,c.idModalWizardClasificacionNueva,c.idModalWizardContainerClasificacionNueva,c.idModalWizardClasificacionVer,c.idModalWizardCuentaVer,c.idModalWizardContainerCuentaVer,c.idModalEliminarCuenta,c.idModalWizardPlantillaIngreso,c.idModalWizardConceptoEdicion,c.idModalWizardClasificacionEdicion),c.buscarAplicacion(c.usuario.aplicacionesUsuario,a.path().substring(1)),c.obtenerColumnasAplicacion(),l.stop()}),c.inicio=function(){c.obtenerCuentas(),c.obtenerTiposCuenta(),c.obtenerTiposCuentasAuxilires(),c.obtenerClasificacionCuenta(),c.obtenerClasificacionSaldos(),c.obtenerClasificacionTipos(),c.obtenerClasificacionMovimientos(),c.obtenerOperacionesCalculo(),c.obtenerTotalesGeneral(),c.sucursalesUsuario="";for(var e=0;e<c.usuario.sucursalesUsuario.length;e++)c.sucursalesUsuario=c.sucursalesUsuario+c.usuario.sucursalesUsuario[e].sucursal.id,e+1!=c.usuario.sucursalesUsuario.length&&(c.sucursalesUsuario=c.sucursalesUsuario+",")},c.agregarTipoCuenta=function(){l.start(),j("TCC",c.usuario.id_empresa).then(function(e){c.tipo=e,l.stop()}),c.abrirPopup(c.idModalWizardConceptoEdicion)},c.obtenerColumnasAplicacion=function(){c.fieldViewer=w({crear:!0,id_empresa:c.usuario.id_empresa,configuracion:{codigo:{value:"Codigo",show:!0},nombre:{value:"Nombre",show:!0},debe:{value:"Debe",show:!0},haber:{value:"Haber",show:!0},saldo:{value:"Saldo",show:!0},clasificacion:{value:"Clasificacion",show:!0},tipo_cuenta:{value:"Tipo Cuenta",show:!0}}},c.aplicacion.aplicacion.id),c.fieldViewer.updateObject()},c.adicionarTipoCuenta=function(e){e.nombre&&e.nombre_corto&&(e.id||c.tipo.clases.push(e),c.clase={})},c.adicionarClasificacionCuenta=function(e){e.nombre&&e.saldo.id&&e.movimiento.id&&(e.id||c.cuentaClasificaciones.push(e),c.clasificacionEdicion={})},c.modificarClasificacionEdicionCuenta=function(e){c.clasificacionEdicion=e},c.guardarTipoCuenta=function(e,a){e&&(l.start(),_.update({id_tipo:a.id},a,function(e){l.stop(),c.cerrarPopPupTipoCuenta(),c.mostrarMensaje("Guardado Exitosamente!"),c.obtenerTiposCuenta()}))},c.guardarClasificacionCuenta=function(e,a){e&&(l.start(),S.update({id_empresa:c.usuario.id_empresa},a,function(e){l.stop(),c.cerrarPopPupCalsificacionEdicionCuenta(),c.mostrarMensaje("Guardado Exitosamente!"),c.obtenerClasificacionCuenta()}))},c.modificarTipoCuenta=function(e){c.clase=e},c.removerTipoCuenta=function(e){e.eliminado=!0},c.removerClasificacionCuenta=function(e){e.eliminado=!0},c.cerrarPopPupTipoCuenta=function(){c.cerrarPopup(c.idModalWizardConceptoEdicion)},c.cerrarPopPupCalsificacionEdicionCuenta=function(){c.cerrarPopup(c.idModalWizardClasificacionEdicion)},c.guardarPlantillaIngreso=function(e,a){c.visible.verPlantillaIngreso=!0,c.visible.verPlantillaEgreso=!0,c.visible.verPlantillarRetencionBien=!0,c.visible.verPlantillarRetencionBienGasto=!0,a.ingreso.ivadf.cuenta&&a.ingreso.ivadf.cuenta.id?(c.verPlantillaIngreso=!1,c.errorIvadf=null):(c.visible.verPlantillaIngreso=!0,c.errorIvadf="sdf"),e.asignarCuentaIvaDf&&(e.asignarCuentaIvaDf.$error.cuenta=!1),a.ingreso.it.cuenta&&a.ingreso.it.cuenta.id?(c.verPlantillaIngreso=!1,c.errorIT=null):(c.visible.verPlantillaIngreso=!0,c.errorIT="sdf"),e.asignarCuentaIt&&(e.asignarCuentaIt.$error.cuenta=!1),a.ingreso.itPorPagar.cuenta&&a.ingreso.itPorPagar.cuenta.id?(c.verPlantillaIngreso=!1,c.errorItPorPagar=null):(c.visible.verPlantillaIngreso=!0,c.errorItPorPagar="sdf"),e.asignarCuentaItPorPagar&&(e.asignarCuentaItPorPagar.$error.cuenta=!1),a.ingreso.cajaBanco.cuenta&&a.ingreso.cajaBanco.cuenta.id?(c.verPlantillaIngreso=!1,c.errorIngresoCaja=null):(c.visible.verPlantillaIngreso=!0,c.errorIngresoCaja="sdf"),e.asignarCuentaIngresoCaja&&(e.asignarCuentaIngresoCaja.$error.cuenta=!1),a.egreso.ivacf.cuenta&&a.egreso.ivacf.cuenta.id?(c.verPlantillaEgreso=!1,c.errorIvacf=null):(c.visible.verPlantillaEgreso=!0,c.errorIvacf="sdf"),e.asignarCuentaIvaCf&&(e.asignarCuentaIvaCf.$error.cuenta=!1),a.egreso.cajaBanco.cuenta&&a.egreso.cajaBanco.cuenta.id?(c.verPlantillaEgreso=!1,c.errorEgresoCaja=null):(c.visible.verPlantillaEgreso=!0,c.errorEgresoCaja="sdf"),e.asignarCuentaEgresoCaja&&(e.asignarCuentaEgresoCaja.$error.cuenta=!1),c.usuario.empresa.usar_funciones_erp?(a.retencionBienes.almacen.cuenta&&a.retencionBienes.almacen.cuenta.id?(c.verPlantillarRetencionBien=!1,c.errorEgresoBienAlmacen=null):(c.visible.verPlantillarRetencionBien=!0,c.errorEgresoBienAlmacen="sdf"),e.asignarAlmacenBienes&&(e.asignarAlmacenBienes.$error.cuenta=!1),a.retencionBienes.it.cuenta&&a.retencionBienes.it.cuenta.id?(c.verPlantillarRetencionBien=!1,c.errorEgresoBienIt=null):(c.visible.verPlantillarRetencionBien=!0,c.errorEgresoBienIt="sdf"),e.asignarItBienes&&(e.asignarItBienes.$error.cuenta=!1),a.retencionBienes.iue.cuenta&&a.retencionBienes.iue.cuenta.id?(c.verPlantillarRetencionBien=!1,c.errorEgresoBienIue=null):(c.visible.verPlantillarRetencionBien=!0,c.errorEgresoBienIue="sdf"),e.asignarIueBienes&&(e.asignarIueBienes.$error.cuenta=!1),a.retencionBienesGasto.gasto.cuenta&&a.retencionBienesGasto.gasto.cuenta.id?(c.verPlantillarRetencionBienGasto=!1,c.errorEgresoBienGasto=null):(c.visible.verPlantillarRetencionBienGasto=!0,c.errorEgresoBienGasto="sdf"),e.asignarGastoBienes&&(e.asignarGastoBienes.$error.cuenta=!1),a.retencionBienesGasto.it.cuenta&&a.retencionBienesGasto.it.cuenta.id?(c.verPlantillarRetencionBienGasto=!1,c.errorEgresoBienGastoIt=null):(c.visible.verPlantillarRetencionBienGasto=!0,c.errorEgresoBienGastoIt="sdf"),e.asignarGastoItBienes&&(e.asignarGastoItBienes.$error.cuenta=!1),a.retencionBienesGasto.iue.cuenta&&a.retencionBienesGasto.iue.cuenta.id?(c.verPlantillarRetencionBienGasto=!1,c.errorEgresoBienGastoIue=null):(c.visible.verPlantillarRetencionBienGasto=!0,c.errorEgresoBienGastoIue="sdf"),e.asignarGastoIueBienes&&(e.asignarGastoIueBienes.$error.cuenta=!1)):(c.errorEgresoBienAlmacen=null,c.errorEgresoBienIt=null,c.errorEgresoBienIue=null,c.errorEgresoBienGasto=null,c.errorEgresoBienGastoIt=null,c.errorEgresoBienGastoIue=null),null==c.errorEgresoBienGasto&&null==c.errorEgresoBienGastoIt&&null==c.errorEgresoBienGastoIue&&null==c.errorEgresoBienIue&&null==c.errorEgresoBienIt&&null==c.errorEgresoBienAlmacen&&null==c.errorIvacf&&null==c.errorEgresoCaja&&null==c.errorIvadf&&null==c.errorIT&&null==c.errorItPorPagar&&(a.usar_funciones_erp=c.usuario.empresa.usar_funciones_erp,x.update({id_empresa:c.usuario.id_empresa},a,function(e){c.mostrarMensaje(e.menssage),c.cerrarPlantillaIngreso()}))},c.BoscarOcrearPlantillaIngreso=function(){c.plantilla={retencionServicios:{it:{},iue:{},servicio:{}},retencionBienesGasto:{it:{},iue:{},gasto:{}},retencionBienes:{it:{},iue:{},almacen:{}},egreso:{ivacf:{},cajaBanco:{}},ingreso:{ivadf:{},it:{},itPorPagar:{},cajaBanco:{}}},M(c.usuario.id_empresa).then(function(e){console.log(e.lista),e.lista.forEach(function(e){A.IVA_DF==e.nombre&&(c.plantilla.ingreso.ivadf={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IT==e.nombre&&(c.plantilla.ingreso.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IT_POR_PAGAR==e.nombre&&(c.plantilla.ingreso.itPorPagar={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.CAJA_BANCOS==e.nombre&&(c.plantilla.ingreso.cajaBanco={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IVA_CF==e.nombre&&(c.plantilla.egreso.ivacf={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.CAJA_BANCOS==e.nombre&&(c.plantilla.egreso.cajaBanco={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IT_RETENCION_BIEN==e.nombre&&(c.plantilla.retencionBienes.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IUE_RETENCION_BIEN==e.nombre&&(c.plantilla.retencionBienes.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.CUENTA_ALMACEN_RETENCION_BIEN==e.nombre&&(c.plantilla.retencionBienes.almacen={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IT_RETENCION_BIEN_GASTO==e.nombre&&(c.plantilla.retencionBienesGasto.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IUE_RETENCION_BIEN_GASTO==e.nombre&&(c.plantilla.retencionBienesGasto.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.CUENTA_GASTO_RETENCION_BIEN==e.nombre&&(c.plantilla.retencionBienesGasto.gasto={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IT_RETENCION_SERVICIO==e.nombre&&(c.plantilla.retencionServicios.it={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.IUE_RETENCION_SERVICIO==e.nombre&&(c.plantilla.retencionServicios.iue={porsentaje:parseFloat(e.valor),cuenta:e.cuenta}),A.CUENTA_RETENCION_SERVICIO==e.nombre&&(c.plantilla.retencionServicios.servicio={porsentaje:parseFloat(e.valor),cuenta:e.cuenta})},this),l.stop()})},c.buscarCuentas=function(e){if(""!=e&&null!=e){var a=E(c.usuario.id_empresa,e);return console.log(a),a}},c.obtenerConfigCuentas=function(){D(c.usuario.id_empresa).then(function(e){c.ListaCuentas=e,console.log(c.ListaCuentas),l.stop()})},c.updateFiltro=function(e){c.filtro=e},c.abrirPlantillaIngreso=function(){c.visible={},c.visible.verPlantillaIngreso=!0,c.visible.verPlantillaEgreso=!0,c.visible.verPlantillarRetencionBien=!0,c.visible.verPlantillarRetencionBienGasto=!0,c.visible.verPlantillarRetencionServicio=!0,c.BoscarOcrearPlantillaIngreso(),c.obtenerConfigCuentas(),c.abrirPopup(c.idModalWizardPlantillaIngreso)},c.cerrarPlantillaIngreso=function(){c.cerrarPopup(c.idModalWizardPlantillaIngreso)},c.agregarClasificacionCuenta=function(){c.clasificacion=new n({saldo:{},movimiento:{}}),c.abrirPopup(c.idModalWizardClasificacionNueva)},c.modificarClasificacionCuenta=function(e){c.clasificacion=e,c.abrirPopup(c.idModalWizardClasificacionNueva)},c.guardarClasificacion=function(e,a){e&&(c.ocultarMensajesValidacion(),l.start(),a.id?n.update({id:a.id},a,function(e){l.stop(),c.cerrarPopPupAgregarClasificacion(),c.obtenerClasificacionCuenta(),c.mostrarMensaje("Actualizado exitosamente!")}):(a.id_empresa=c.usuario.id_empresa,a.$save(function(e){l.stop(),c.mostrarMensaje("Clasificacion registrada exitosamente!",e),c.cerrarPopPupAgregarClasificacion(),c.obtenerClasificacionCuenta()},function(e){l.stop(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!"),c.obtenerClasificacionCuenta()})))},c.mostrarConfirmacionEliminacion=function(e){c.cuenta=new r({id_empresa:c.usuario.id_empresa,id_usuario:c.usuario.id,tipoCuenta:{},clasificacion:{},eliminado:!1,bimonetaria:!1,aplicar_calculo:!1}),c.cuenta=e,c.abrirPopup(c.idModalEliminarCuenta)},c.cerrarPopPupConfirmacionEliminacion=function(){c.cerrarPopup(c.idModalEliminarCuenta)},c.eliminarCuenta=function(e){e.eliminado=!0,c.cuenta=e,c.cuenta.eliminado=!0,r.update({id:e.id,eliminado:!0},e,function(e){l.stop(),c.cerrarPopPupConfirmacionEliminacion(),c.recargarItemsTabla(),c.mostrarMensaje("Borrado exitosamente!")},function(e){l.stop(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!"),c.recargarItemsTabla()})},c.crearNuevaCuenta=function(){c.cuenta=new r({id_empresa:c.usuario.id_empresa,id_usuario:c.usuario.id,tipoCuenta:{},clasificacion:{},eliminado:!1,bimonetaria:!1,especifica_texto1:"",especifica_texto2:"",especifica_texto3:""});var e=new Date;c.cuenta.fechaTexto=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear(),c.abrirPopup(c.idModalWizardCuentaEdicion)},c.optenerCfDf=function(e,a){a?e?(R("CF_TEXTO_1").then(function(e){c.cuenta.especifica_texto1=e.clase}),R("CF_TEXTO_2").then(function(e){c.cuenta.especifica_texto2=e.clase}),R("CF_TEXTO_3").then(function(e){c.cuenta.especifica_texto3=e.clase})):(R("DF_TEXTO_1").then(function(e){c.cuenta.especifica_texto1=e.clase}),R("DF_TEXTO_2").then(function(e){c.cuenta.especifica_texto2=e.clase}),R("DF_TEXTO_3").then(function(e){c.cuenta.especifica_texto3=e.clase})):(c.cuenta.tipo_especifica=!1,c.cuenta.especifica_texto1="",c.cuenta.especifica_texto2="",c.cuenta.especifica_texto3="")},c.modificarCuenta=function(e){(c.cuenta=e).especifica&&c.optenerCfDf(e.tipo_especifica,e.especifica),c.abrirPopup(c.idModalWizardCuentaEdicion)},c.modificarClasificacionesCuenta=function(){c.abrirPopup(c.idModalWizardClasificacionEdicion)},c.verCuenta=function(e){c.cuenta=e,c.abrirPopup(c.idModalWizardCuentaVer)},c.validarCodigoCuenta=function(e){""!=e&&P(function(){c.validar=new I,c.validar.codigo=e,c.validar.$save(function(e){c.data=e})},1500)},c.guardarCuenta=function(e,a){e&&("Siguiente"!=$("#siguiente").text().trim()&&(c.ocultarMensajesValidacion(),l.start(),a.id?r.update({id:a.id},a,function(e){l.stop(),c.cerrarPopPupEdicion(),c.recargarItemsTabla(),c.mostrarMensaje("Actualizado exitosamente!")}):a.$save(function(e){l.stop(),c.mostrarMensaje("Cuenta registrada exitosamente!",e),c.cerrarPopPupEdicion(),c.recargarItemsTabla()},function(e){l.stop(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!"),c.recargarItemsTabla()})))},c.obtenerCuentas=function(){c.paginator=v(),c.paginator.column="codigo",c.paginator.callBack=c.obtenerLista,c.filtro={empresa:c.usuario.id_empresa,clasificacion:"",tipo_cuenta:"",monto:""},c.paginator.getSearch("",c.filtro,null)},c.cerrarPopPupCuentaVer=function(){c.cerrarPopup(c.idModalWizardCuentaVer)},c.cerrarPopPupEdicion=function(){c.obtenerCuentas(),c.cerrarPopup(c.idModalWizardCuentaEdicion)},c.cerrarPopPupVerClasificacion=function(){c.cerrarPopup(c.idModalWizardClasificacionVer)},c.cerrarPopPupAgregarClasificacion=function(){c.cerrarPopup(c.idModalWizardClasificacionNueva)},c.obtenerClasificacionCuenta=function(){l.start(),d(c.usuario.id_empresa).then(function(e){c.cuentaClasificaciones=e.clasificaciones,l.stop()})},c.obtenerClasificacionSaldos=function(){l.start(),s("CONTCLSSAL").then(function(e){c.cuentaSaldos=e.clases,l.stop()})},c.obtenerClasificacionTipos=function(){l.start(),s("TIPOS_CLAS_CUENTA").then(function(e){c.tiposClasificaciones=e.clases,l.stop()})},c.obtenerClasificacionMovimientos=function(){l.start(),s("CONTCLSMOV").then(function(e){c.cuentaMovimientos=e.clases,l.stop()})},c.obtenerTiposCuenta=function(){l.start(),j("TCC",c.usuario.id_empresa).then(function(e){c.cuentaTipos=[{id:0,nombre:"TODOS"}],c.cuentaTipos=c.cuentaTipos.concat(e.clases),l.stop()})},c.obtenerTiposCuentasAuxilires=function(){l.start(),s("AUXCU").then(function(e){console.log(e),c.tiposCuentasAuxiliares=e.clases,l.stop()})},c.obtenerOperacionesCalculo=function(){l.start(),s("OPE").then(function(e){c.operacionesCalculo=e.clases,l.stop()})},c.obtenerLista=function(){l.start(),c.sumaTotales={debe:0,haber:0,saldo:0},g(c.paginator).then(function(e){c.paginator.setPages(e.paginas),e.cuentas.forEach(function(e,a,o){c.sumaTotales.debe+=e.debe,c.sumaTotales.haber+=e.haber,c.sumaTotales.saldo+=e.saldo}),l.stop(),c.Cuentas=e.cuentas})},c.obtenerTotalesGeneral=function(){c.sumaTotalesGenerales={debe:0,haber:0,saldo:0};var e={filter:{empresa:c.usuario.id_empresa,clasificacion:0,tipo_cuenta:0,monto:0},currentPage:1,itemsPerPage:0,search:0,column:"codigo",direction:"asc"};g(e).then(function(e){e.cuentas.forEach(function(e,a,o){c.sumaTotalesGenerales.debe+=e.debe,c.sumaTotalesGenerales.haber+=e.haber,c.sumaTotalesGenerales.saldo+=e.saldo,l.stop()})})},c.subirExcelCuentas=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){l.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={clasificacion:{},tipoCuenta:{}};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.nombre=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.descripcion=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.clasificacion.nombre=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.tipoCuenta.nombre=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.debe=null!=r["F"+t]&&""!=r["F"+t]?parseFloat(r["F"+t].v.toString()):null,s.haber=null!=r["G"+t]&&""!=r["G"+t]?parseFloat(r["G"+t].v.toString()):null,s.saldo=null!=r["H"+t]&&""!=r["H"+t]?parseFloat(r["H"+t].v.toString()):null,s.bimonetaria=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,"SI"!=s.bimonetaria?s.bimonetaria=0:s.bimonetaria=1,n.push(s),t++,0}while(null!=r["A"+t]);c.guardarCuentas(n),console.log(n),l.stop()},t.readAsBinaryString(o)}},c.guardarCuentas=function(e){new h({cuentas:e,id_empresa:c.usuario.id_empresa}).$save(function(e){l.stop(),c.mostrarMensaje("Guardado Exitosamente!"),c.recargarItemsTabla()},function(e){l.stop(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!"),c.recargarItemsTabla()})},c.establecerCliente=function(e){c.cuenta.cliente=e},c.interceptarTecla=function(e,a,o){13===e.which&&(o?c.enfocar(a):P(function(){$("#"+a).trigger("click")},0))},c.buscarCliente=function(e){if(""!=e&&null!=e)return b(c.usuario.id_empresa,e)},c.establecerProveedor=function(e){c.cuenta.proveedor=e},c.buscarProveedor=function(e){if(""!=e&&null!=e)return C(c.usuario.id_empresa,e)},c.$on("$routeChangeStart",function(e,a){c.eliminarPopup(c.idModalWizardCuentaEdicion),c.eliminarPopup(c.idModalWizardClasificacionNueva),c.eliminarPopup(c.idModalWizardCuentaVer),c.eliminarPopup(c.idModalEliminarCuenta),c.eliminarPopup(c.idModalWizardPlantillaIngreso),c.eliminarPopup(c.idModalWizardClasificacionEdicion),c.eliminarPopup(c.idModalWizardConceptoEdicion)}),c.inicio()}]),angular.module("agil.controladores").controller("ControladorCotizacion",["$scope","blockUI","$localStorage","$location","$templateCache","$route","$timeout","ListaCotizacion","Cotizaciones","Cotizacion","filtroCotizaciones","Diccionario","ListaInventariosProducto","ClasesTipo","$window","ListaProductosEmpresa","InventarioPaginador","ConfiguracionCotizacionVista","ConfiguracionCotizacionVistaDatos","FiltroCotizacionPaginador","Paginator","DatosImpresionCotizacion","ultimaCotizacion","ListaSucursalesUsuario","ClientesNit","CotizacionRechazo",function(b,C,e,a,o,i,t,r,n,s,c,p,l,d,g,u,m,f,v,h,P,_,M,D,E,x){b.usuario=JSON.parse(e.usuario),b.idModalWizardCotizacionNueva="modal-wizard-cotizacion-nueva",b.idModalInventario="dialog-productos-venta",b.idModalDialogRechazo="dialog-editar-rechazo",b.inicio=function(){b.obtenerCotizaciones(),b.detalleCotizacion={producto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},b.sucursales=[],b.obtenerSucursales(),b.cotizacionModel=["id","nombre","descripcion","fecha","numero_documento","importe","usuario"],b.productoSeleccionado=!1},b.obtenerSucursales=function(){D(b.usuario.id).then(function(e){e.sucursales.map(function(e){b.sucursales.push(e.sucursal)}),b.usuario.sucursalesUsuario=e.sucursales;for(var a=0;a<b.usuario.sucursalesUsuario.length;a++)b.sucursalesUsuario=b.sucursalesUsuario+b.usuario.sucursalesUsuario[a].sucursal.id,a+1!=b.usuario.sucursalesUsuario.length&&(b.sucursalesUsuario=b.sucursalesUsuario+",")})},b.obtenerCotizaciones=function(){b.paginator=P(),b.paginator.column="id",b.paginator.direction="desc",b.dynamicPopoverRechazo={templateUrl:"myPopoverTemplate.html"},b.paginator.callBack=b.obtenerLista,b.filtro={empresa:b.usuario.id_empresa,inicio:"",fin:"",fecha_inicio:new Date,fecha_fin:new Date,busqueda:"",importe:0,estado:"",sucursal:"",usuario:"",razon_social:"",nit:""}},b.establecerFechas=function(e,a){b.filtro.fecha_inicio=new Date(convertirFecha(e)),b.filtro.fecha_fin=new Date(convertirFecha(a))},b.obtenerLista=function(){C.start(),c(b.paginator).then(function(e){b.paginator.setPages(e.paginas),b.cotizaciones=e.cotizaciones,C.stop()})},b.sumarMonto=function(){for(var e=0,a=0;a<b.cotizaciones.length;a++)e+=b.cotizaciones[a].importe;return Math.round(100*e)/100},b.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsCotizacion(b.idModalWizardCotizacionNueva,b.idModalInventario,b.idModalDialogRechazo),b.buscarAplicacion(b.usuario.aplicacionesUsuario,a.path().substring(1))}),b.cerrarNuevaCotizacion=function(){b.cerrarPopup(b.idModalWizardCotizacionNueva)},b.abrirPopup=function(e){abrirPopup(e)},b.cerrarPopup=function(e){ocultarPopup(e)},b.eliminarPopup=function(e){eliminarPopup(e)},b.$on("$routeChangeStart",function(e,a){b.eliminarPopup(b.idModalWizardCotizacionNueva),b.eliminarPopup(b.idModalInventario),b.eliminarPopup(b.idModalDialogRechazo)}),b.ModificarCotizacion=function(e){b.cotizacion=e,b.obtenerAlmacenes(e.sucursal.id),b.cotizacion.fecha=new Date(b.cotizacion.fecha),b.cotizacion.fechaTexto=b.cotizacion.fecha.getDate()+"/"+(b.cotizacion.fecha.getMonth()+1)+"/"+b.cotizacion.fecha.getFullYear(),b.abrirPopup(b.idModalWizardCotizacionNueva)},b.buscarProducto=function(e){if(""!=e&&null!=e){var a=u(b.usuario.id_empresa,e);return setTimeout(b.enfocar("id_productoTB"),0),a}},b.eliminarDetalleCotizacion=function(e){indx=b.cotizacion.detallesCotizacion.indexOf(e),b.cotizacion.detallesCotizacion[indx].eliminado=!0,b.sumarTotalImporte()},b.establecerProducto=function(a){a.tipoProducto=null==a.tipoProducto?{id:a["tipoProducto.id"],nombre:a["tipoProducto.nombre"],nombre_corto:a["tipoProducto.nombre_corto"]}:a.tipoProducto,b.detalleCotizacion={producto:a,precio_unitario:a.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,descuento:a.descuento,eliminado:!1},b.editar_precio=!1,a.activar_inventario=!1,b.calcularImporte(),b.productoSeleccionado=!0,l(a.id,b.cotizacion.almacen.id).then(function(e){a.inventarios=e,b.precio_inventario,0<a.inventarios.length?b.precio_inventario=a.inventarios[a.inventarios.length-1].costo_unitario+" Bs":b.precio_inventario="Sin histórico"})},b.calcularImporte=function(){var e,a;b.detalleCotizacion.importe=Math.round(b.detalleCotizacion.cantidad*b.detalleCotizacion.precio_unitario*1e3)/1e3,e=b.detalleCotizacion.tipo_descuento?b.detalleCotizacion.importe*(b.detalleCotizacion.descuento/100):b.detalleCotizacion.descuento,a=b.detalleCotizacion.tipo_recargo?b.detalleCotizacion.importe*(b.detalleCotizacion.recargo/100):b.detalleCotizacion.recargo,b.detalleCotizacion.total=b.detalleCotizacion.importe-e+a-b.detalleCotizacion.ice-b.detalleCotizacion.excento},b.agregarDetalleCotizacion=function(e){b.cotizacion.detallesCotizacion.push(e),b.sumarTotalImporte(),b.detalleCotizacion={producto:{},cantidad:0,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},b.productoSeleccionado=!1},b.sumarTotalImporte=function(){for(var e=0,a=0;a<b.cotizacion.detallesCotizacion.length;a++)b.cotizacion.detallesCotizacion[a].eliminado||(e+=b.cotizacion.detallesCotizacion[a].importe);b.cotizacion.importe=Math.round(1e3*e)/1e3},b.crearNuevaCotizacion=function(){b.cotizacion=new s({id_empresa:b.usuario.id_empresa,id_usuario:b.usuario.id,cliente:{},detallesCotizacion:[]});var e=new Date;b.cotizacion.fechaTexto=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear(),b.detalleCotizacion={producto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},b.abrirPopup(b.idModalWizardCotizacionNueva),b.enfocar("nombreCotizacion")},b.guardarCotizacion=function(e,a){if(e){var o=new Date;if(a.fecha=new Date(b.convertirFecha(a.fechaTexto)),C.start(),a.id)s.update({id_cotizacion:a.id},a,function(e){C.stop(),b.imprimirCotizacion(a),b.cerrarNuevaCotizacion(),b.recargarItemsTabla(),b.mostrarMensaje("Actualizado exitosamente!")});else{o=new Date;a.fecha=new Date(b.convertirFecha(a.fechaTexto)),a.fecha.setHours(o.getHours()),a.fecha.setMinutes(o.getMinutes()),a.fecha.setSeconds(o.getSeconds()),a.$save(function(e){console.log("cotizacion guardaoooo ",e),C.stop(),b.imprimirCotizacion(e.cotizacion),b.cerrarNuevaCotizacion(),b.recargarItemsTabla(),b.mostrarMensaje("Cotización registrada exitosamente!"),C.stop()},function(e){C.stop(),b.mostrarMensaje("Ocurrio un problema al momento de guardar!"),b.recargarItemsTabla()})}}},b.obtenerAlmacenesActividades=function(e){b.obtenerAlmacenes(e)},b.obtenerAlmacenes=function(a){console.log("seleccion sucursallllllll ",a),b.almacenes=[];var e=$.grep(b.sucursales,function(e){return e.id==a})[0];b.almacenes=e.almacenes},b.buscarCliente=function(e){if(""!=e&&null!=e)return E(b.usuario.id_empresa,e)},b.establecerCliente=function(e){b.cotizacion.cliente=e,b.enfocar("razon_social")},b.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},b.enfocar=function(e){t(function(){$("#"+e).focus()},0)},b.interceptarTecla=function(e,a,o){13===e.which&&(o?b.enfocar(a):t(function(){$("#"+a).trigger("click")},0))},b.verificarPulso=function(e,a){13===e.keyCode&&a&&b.buscarCotizaciones(1,b.itemsPorPagina,a)},b.filtrarCotizaciones=function(e,a,o,i,t){C.start(),""==t||null==t?t=0:b.textoBusqueda=t,e=null==a||null==a?0:new Date(b.convertirFecha(e)),a=null==a||null==a?0:new Date(b.convertirFecha(a)),h(b.usuario.id_empresa,o,i,t,e,a).then(function(e){if(0==e.cotizaciones.length)return C.stop(),b.buscarCotizaciones(1,b.itemsPorPagina,"");b.cotizaciones=e.cotizaciones,b.paginas=[];for(var a=1;a<=e.paginas;a++)b.paginas.push(a);C.stop()})},b.verificarDescuentos=function(e){for(var a=!1,o=0;o<e.length;o++)(0<e[o].descuento||0<e[o].recargo||0<e[o].ice||0<e[o].excento)&&(a=!0);return a},b.dibujarCabeceraImpresionCotizacion=function(e,a,o,i,t,r){100<b.usuario.empresa.imagen.length&&e.image(b.usuario.empresa.imagen,60,40,{fit:[65,65]}),e.font("Helvetica-Bold",16),e.text("COTIZACIÓN",250,90),e.font("Helvetica-Bold",8),e.text(b.usuario.empresa.razon_social.toUpperCase(),60,110),e.font("Helvetica",7),e.text(a.sucursal.nombre.toUpperCase(),60,118);var n=a.sucursal.direccion.length,s=n<=45?129:45<n&&n<=90?139:145;e.text(a.sucursal.direccion.toUpperCase(),60,126);var c=(null!=a.sucursal.telefono1?a.sucursal.telefono1:"")+(null!=a.sucursal.telefono2?"-"+a.sucursal.telefono2:"")+(null!=a.sucursal.telefono3?"-"+a.sucursal.telefono3:"");e.text("TELF.: "+c,60,s+5),e.text("COCHABAMBA - BOLIVIA",60,s+13),e.font("Helvetica-Bold",10),e.rect(450,40,120,50).stroke(),e.text("NRO : ",460,60),e.text(a.numero_documento,500,60),e.font("Helvetica-Bold",8),e.rect(50,160,520,40).stroke(),e.text("FECHA : ",60,165),e.text("SEÑOR(ES) : ",60,180),e.text("NIT : ",360,165),e.text(a.fechaTexto,120,165),e.text(a.cliente.razon_social,120,180),e.text(a.cliente.nit,400,165),e.rect(50,200,520,25).stroke(),e.text("CODIGO",55,210,{width:70}),e.text("CANT.",125,210),a.detallesCotizacion[0].producto&&e.text("UNIDAD",155,210),e.text("DETALLE",198,210),a.detallesCotizacion[0].producto&&e.text("P.UNIT.",470,210),e.text("TOTAL",530,210),e.font("Helvetica",8);new Date},b.imprimirCotizacionCartaOficio=function(e,a,o,i){var t=new PDFDocument({size:e,compress:!1,margin:10}),r=t.pipe(blobStream());a.fecha=new Date(a.fecha),a.fechaTexto=a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear();var n=240,s=0,c=0,l=1,d=Math.ceil(a.detallesCotizacion.length/o),u=b.verificarDescuentos(a.detallesCotizacion);b.dibujarCabeceraImpresionCotizacion(t,a,l,d,u,n-20);for(var p=0,m=0;m<a.detallesCotizacion.length;m++){t.font("Helvetica",7),indx=m+1,p+=a.detallesCotizacion[m].total,t.text(a.detallesCotizacion[m].producto.codigo,55,n,{width:70}),t.text(a.detallesCotizacion[m].cantidad,135,n),t.text(a.detallesCotizacion[m].producto.unidad_medida,155,n);var f=a.detallesCotizacion[m].producto.nombre.length,g=f<=45?n:45<f&&f<=90?n-7:n-14;t.text(a.detallesCotizacion[m].producto.nombre,200,g-5,{width:225}),t.text(null===a.detallesCotizacion[m].precio_unitario?"null":a.detallesCotizacion[m].precio_unitario.toFixed(2),470,n),t.text(a.detallesCotizacion[m].total.toFixed(2),530,n),ancho=f<=80?20:30,t.rect(50,n-15,520,30).stroke(),n+=30,(c+=1)==o&&(s+=c)!=a.detallesCotizacion.length&&(t.text("Pag. "+l+" de "+d,520,e[1]-40),t.addPage({size:e,margin:10}),n=240,c=0,l+=1,b.dibujarCabeceraImpresionCotizacion(t,a,l,d,u,n-20))}t.font("Helvetica-Bold",8),t.text("TOTAL",470,n),t.font("Helvetica",8),t.text(p.toFixed(2),530,n),t.text("SON : "+i,55,n),t.rect(50,n-15,520,30).stroke(),o-6<c&&(t.addPage({size:e,margin:10}),n=240,c=0,l+=1,b.dibujarCabeceraImpresionCotizacion(t,a,l,d,u,n-20)),t.rect(50,n+40,420,25).stroke(),t.font("Helvetica",8),t.text("Plazo de cotizacion: "+a.plazo,55,n+50),t.rect(50,n+80,420,25).stroke(),t.font("Helvetica",8),t.text("Nota: "+a.nota,55,n+90),t.rect(50,n+120,420,25).stroke(),t.font("Helvetica",8),null==a.descripcion&&(a.descripcion="Ninguna"),t.text("Observaciones: "+a.descripcion,55,n+130);var v=new Date,h=v.getMinutes();h<10&&(h="0"+h),t.font("Helvetica",8),t.text(a.firma,55,e[1]-90),t.text(a.cargo.toUpperCase(),55,e[1]-80),t.text("usuario : "+b.usuario.nombre_usuario,380,e[1]-60),t.text("fecha : "+v.getDate()+"/"+(v.getMonth()+1)+"/"+v.getFullYear()+"  "+v.getHours()+":"+h,480,e[1]-60),1<d&&t.text("Pag. "+l+" de "+d,520,e[1]-40),t.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),C.stop()},convertUrlToBase64Image(b.usuario.empresa.imagen,function(e){b.usuario.empresa.imagen=e}),b.dibujarCabeceraImpresionCotizacionCuartoCarta=function(e,a,o,i,t,r){100<b.usuario.empresa.imagen.length?e.image(b.usuario.empresa.imagen,20,r-80,{width:50,height:50}):e.image(b.usuario.empresa.imagen,20,r-80),sucurTel={};for(var n=0;n<b.sucursales.length;n++)b.sucursales[n].id==a.id_sucursal&&(sucurTel=b.sucursales[n].telefono1);e.font("Helvetica-Bold",8),e.text("COTIZACIÓN N°"+a.id,120,r-80),e.font("Helvetica",7),e.text("Nombre: "+a.nombre+"    Descripción: "+a.descripcion,20,r-20),e.text("Fecha: "+a.fechaTexto,225,r-20),e.font("Helvetica-Bold",7),e.text(b.usuario.empresa.razon_social.toUpperCase(),220,r-80+0),e.font("Helvetica",6),e.text("NIT "+b.usuario.empresa.nit,225,r-80+10),e.text("TELF.: "+sucurTel,225,r-80+20),e.text("Fecha: "+a.fechaTexto,225,r-80+30),e.font("Helvetica",5),e.text("COCHABAMBA - BOLIVIA",220,r-80+40),e.rect(15,r-10,282,20).stroke(),e.font("Helvetica",6),e.text("N°",20,r),t?(e.text("Cod.",30,r),e.text("Cant.",60,r),e.text("Unid.",80,r),e.text("Det.",100,r),e.text("P.Unit.",184,r),e.text("Imp.",212,r),e.text("Desc.",240,r),e.text("Totl.",270,r)):(e.text("Cod.",30,r),e.text("Cant.",60,r),e.text("Unid.",80,r),e.text("Detalle.",100,r),e.text("P.Unit.",195,r),e.text("Total.",270,r)),e.font("Helvetica",8)},b.imprimirCotizacionRollo=function(e,a){var o=new PDFDocument({size:e,compress:!1,margin:10}),i=o.pipe(blobStream());a.fecha=new Date(a.fecha),a.fechaTexto=a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear();var t=0;a.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_MEDIOOFICIO?t=13:a.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_CUARTOCARTA&&(t=13);var r=140,n=Math.ceil(a.detallesCotizacion.length/t),s=b.verificarDescuentos(a.detallesCotizacion);b.dibujarCabeceraImpresionCotizacionCuartoCarta(o,a,1,n,s,r-20);for(var c=0,l=0;l<a.detallesCotizacion.length;l++){o.font("Helvetica",7),c+=a.detallesCotizacion[l].importe,indx=l+1;var d=a.detallesCotizacion[l].producto.nombre.length;if(o.text(indx,20,r),s){o.text(a.detallesCotizacion[l].producto.codigo,30,r-7,{width:32}),o.text(a.detallesCotizacion[l].cantidad,64,r,{width:30}),o.text(a.detallesCotizacion[l].producto.unidad_medida,79,r,{width:30});var u=d<=45?r-7:r;o.text(a.detallesCotizacion[l].producto.nombre,100,u-7,{width:80}),o.text(a.detallesCotizacion[l].precio_unitario.toFixed(2),184,r,{width:30}),o.text(a.detallesCotizacion[l].importe.toFixed(2),212,r),o.text(a.detallesCotizacion[l].tipo_descuento?"%":"Bs",240,r),o.text(a.detallesCotizacion[l].descuento.toFixed(2),250,r),o.text(a.detallesCotizacion[l].total.toFixed(2),270,r)}else{o.text(a.detallesCotizacion[l].producto.codigo,30,r-7,{width:32}),o.text(a.detallesCotizacion[l].cantidad,64,r,{width:30}),o.text(a.detallesCotizacion[l].producto.unidad_medida,79,r,{width:30}),console.log(d);u=d<=65?r-7:r;o.text(a.detallesCotizacion[l].producto.nombre,100,u,{width:80}),o.text(a.detallesCotizacion[l].precio_unitario.toFixed(2),184,r,{width:30}),o.text(a.detallesCotizacion[l].total.toFixed(2),270,r)}ancho=d<=80?20:30,o.rect(15,r-10,282,ancho).stroke(),r+=20,0}o.font("Helvetica-Bold",7),o.text("TOTAL BS.",225,r),o.text(c.toFixed(1),270,r),o.rect(220,r-10,77,20).stroke(),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),C.stop()},b.imprimirCotizacionCuartoCarta=function(e,a,o){var i=new PDFDocument({size:e,compress:!1,margin:10}),t=i.pipe(blobStream());a.fecha=new Date(a.fecha),a.fechaTexto=a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear();var r=140,n=0,s=0,c=1,l=Math.ceil(a.detallesCotizacion.length/o),d=b.verificarDescuentos(a.detallesCotizacion);b.dibujarCabeceraImpresionCotizacionCuartoCarta(i,a,c,l,d,r-20);for(var u=0,p=0;p<a.detallesCotizacion.length;p++){i.font("Helvetica",7),u+=a.detallesCotizacion[p].importe,indx=p+1;var m=a.detallesCotizacion[p].producto.nombre.length;if(i.text(indx,20,r),d){i.text(a.detallesCotizacion[p].producto.codigo,30,r-7,{width:32}),i.text(a.detallesCotizacion[p].cantidad,64,r,{width:30}),i.text(a.detallesCotizacion[p].producto.unidad_medida,79,r,{width:30});var f=m<=45?r-7:r;i.text(a.detallesCotizacion[p].producto.nombre,100,f,{width:80}),i.text(a.detallesCotizacion[p].precio_unitario.toFixed(2),184,r,{width:30}),i.text(a.detallesCotizacion[p].importe.toFixed(2),212,r),i.text(a.detallesCotizacion[p].tipo_descuento?"%":"Bs",240,r),i.text(a.detallesCotizacion[p].descuento.toFixed(2),250,r),i.text(a.detallesCotizacion[p].total.toFixed(2),270,r)}else{i.text(a.detallesCotizacion[p].producto.codigo,30,r,{width:32}),i.text(a.detallesCotizacion[p].cantidad,64,r,{width:30}),i.text(a.detallesCotizacion[p].producto.unidad_medida,79,r,{width:30});f=m<=45?r-7:r;i.text(a.detallesCotizacion[p].producto.nombre,100,f,{width:80}),i.text(a.detallesCotizacion[p].precio_unitario.toFixed(2),184,r,{width:30}),i.text(a.detallesCotizacion[p].total.toFixed(2),270,r)}ancho=m<=80?20:30,i.rect(15,r-10,282,ancho).stroke(),r+=20,++s==o&&(n+=s)!=a.detallesCotizacion.length&&(i.text("Pag. "+c+" de "+l,260,e[1]-40),i.addPage({size:e,margin:10}),r=140,s=0,c+=1,b.dibujarCabeceraImpresionCotizacionCuartoCarta(i,a,c,l,d,r-20))}i.font("Helvetica-Bold",7),i.text("TOTAL BS.",225,r),i.text(u.toFixed(2),270,r),i.rect(220,r-10,77,20).stroke(),1<l&&i.text("Pag. "+c+" de "+l,255,e[1]-40),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");g.open(e,"_blank","location=no")}),C.stop()},b.imprimirCotizacion=function(e){console.log("cotizacion id"),console.log(e),_(e.id,b.usuario.id_empresa).then(function(e){console.log("datos"),console.log(e.cotizacion);var a=e.cotizacion;a.configuracion=e.configuracionGeneralFactura;var o,i=new Date(a.fecha);if(a.fechaTexto=i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),a.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_OFICIO)console.log("impresion papel oficio"),o=[612,936],itemsPorPagina=20,b.imprimirCotizacionCartaOficio(o,a,itemsPorPagina,e.numero_literal);else if(a.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_CARTA)console.log("impresion papel carta"),o=[612,792],itemsPorPagina=15,b.imprimirCotizacionCartaOficio(o,a,itemsPorPagina,e.numero_literal);else if(a.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_MEDIOOFICIO)console.log("impresion papel medio oficio"),o=[612,468],itemsPorPagina=5,b.imprimirCotizacionCartaOficio(o,a,itemsPorPagina,e.numero_literal);else if(a.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_ROLLO){var t;console.log("impresion papel rollo"),a.detallesCotizacion.length<=2?(console.log("impresion papel rollo detalle <= 2"),t=610):(console.log("impresion papel rollo detalle > 2"),t=610+20*(a.detallesCotizacion.length-2)),console.log("impresion papel rollo alto: "+t),o=[306,t],itemsPorPagina=10,b.imprimirCotizacionRollo(o,a)}else a.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_CUARTOCARTA&&(o=[306,396],itemsPorPagina=8,b.imprimirCotizacionCuartoCarta(o,a,itemsPorPagina))})},b.abrirDialogDialogRechazo=function(e){b.cotizacion=e,b.abrirPopup(b.idModalDialogRechazo)},b.cerrarDialogDialogRechazo=function(){b.cerrarPopup(b.idModalDialogRechazo)},b.saveRechazo=function(e){console.log("cotizacion ssssss ",e),e.fecha_estado=new Date(b.convertirFecha(e.fechaTexto)),e.estado="RECHAZADO",x.update({id_cotizacion:e.id},e,function(e){b.mostrarMensaje("actualizado Exitosamente!")},function(e){b.mostrarMensaje("Hubo un problema al guardar.")}),C.stop(),b.cerrarDialogDialogRechazo()},b.imprimirFiltroCajaCartaOficio=function(e,a,o){var i=new PDFDocument({compress:!1,size:[612,792],margin:0}),t=i.pipe(blobStream()),r=Math.ceil(e.length/20),n=100,s=0,c=1;b.imprimirCabeceraFiltroCajaCartaOficio(i,1,r,e,a,o),i.font("Helvetica",7);for(var l=0;l<e.length;l++){i.font("Helvetica",7),i.rect(50,n+9,520,0).stroke(),i.text(l+1,55,n+20),i.font("Helvetica",6),i.text(e[l].sucursal.nombre,80,n+20),e[l].cliente?(i.font("Helvetica",6),i.text(e[l].cliente.razon_social,150,n+15,{width:75}),i.font("Helvetica",7),i.text(e[l].cliente.nit,270,n+20)):(i.text("",150,n+16,{width:75}),i.text("",270,n+20)),e[l].fecha=new Date(e[l].fecha),i.text(e[l].fecha.getHours()+":"+e[l].fecha.getMinutes()+" - ",340,n+21,{width:28});var d=360;if(10<e[l].fecha.getMinutes()&&(d=365),i.text(e[l].fecha.getDate()+"/"+(e[l].fecha.getMonth()+1)+"/"+e[l].fecha.getFullYear(),d,n+21,{width:32}),i.text(e[l].importe,425,n+20),i.text(e[l].usuario.nombre_usuario,455,n+20),i.text(e[l].estado,500,n+16,{width:65}),i.font("Helvetica",7),n+=30,20==++s){i.text(c+" de "+r,520,705);var u=new Date;i.text("FECHA : "+u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear()+"   Hr:"+u.getHours()+":"+u.getMinutes(),55,705),i.text("USUARIO: "+b.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),n=100,s=0,c+=1,b.imprimirCabeceraFiltroCajaCartaOficio(i,1,r,e,a,o)}}i.font("Helvetica",7),i.text(c+" de "+r,520,705);u=new Date;i.text("FECHA : "+u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear()+"   Hr:"+u.getHours()+":"+u.getMinutes(),55,705),i.text("USUARIO: "+b.usuario.nombre_usuario,150,705),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),C.stop()},b.imprimirCabeceraFiltroCajaCartaOficio=function(e,a,o,i,t,r){e.font("Helvetica-Bold",16),e.text("REPORTE DE COTIZACIONES",0,40,{align:"center"}),e.font("Helvetica-Bold",8),e.rect(50,80,520,620).stroke(),e.text("Desde: "+t+" Hasta: "+r,0,55,{align:"center"}),e.font("Helvetica-Bold",7),e.font("Helvetica-Bold",8),e.text("N°",55,90),e.text("Sucursal",80,90),e.text("Razon Social",150,90),e.text("Nit Cliente",270,90),e.text("Fecha",340,90),e.text("Monto",420,90),e.text("Usuario",455,90),e.text("Estado",500,90)},b.imprimirFiltroExcelCajaCartaOficio=function(e){C.start();for(var a=[["N°","Sucursal","Razon Social","Nit Cliente","Fecha","Monto","Usuario","Estado"]],o=0;o<e.length;o++)e[o].fecha=new Date(e[o].fecha);e.sort(function(e,a){return e.fecha>a.fecha?1:e.fecha<a.fecha?-1:0});for(o=0;o<e.length;o++){var i=[];i.push(o+1),i.push(e[o].sucursal.nombre),e[o].cliente?(i.push(e[o].cliente.razon_social),i.push(e[o].cliente.nit)):(i.push(""),i.push("")),i.push(e[o].fecha),i.push(e[o].importe),i.push(e[o].usuario.nombre_usuario),i.push(e[o].estado),a.push(i)}var t="SheetJS",r=new Workbook,n=sheet_from_array_of_arrays(a);r.SheetNames.push(t),r.Sheets[t]=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"Reporte-cotizaciones.xlsx"),C.stop()},b.inicio()}]),angular.module("agil.controladores").controller("ControladorDosificaciones",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Dosificacion","Dosificaciones","DosificacionesEmpresa","ClasesTipo",function(o,a,e,i,t,r,n,s,c,l){o.idModalWizardDosificacionEdicion="modal-wizard-dosificacion-edicion",o.idModalWizardDosificacionVista="modal-wizard-dosificacion-vista",o.idModalEliminarDosificacion="dialog-eliminar-dosificacion",o.idModalContenedorDosificacionEdicion="modal-wizard-container-dosificacion-edicion",o.idModalContenedorDosificacionVista="modal-wizard-container-dosificacion-vista",o.usuario=JSON.parse(a.usuario),o.inicio=function(){o.obtenerDosificaciones(),o.obtenerPiesFactura(),setTimeout(function(){ejecutarScriptsTabla("tabla-dosificaciones",6)},2e3)},o.obtenerPiesFactura=function(){r.start(),l("PIÉFACT").then(function(e){o.piesFactura=e.clases,r.stop()})},o.obtenerDosificaciones=function(){r.start(),s(o.usuario.id_empresa).then(function(e){o.dosificaciones=e,r.stop()})},o.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsDosificacion(o.idModalWizardDosificacionEdicion,o.idModalWizardDosificacionVista,o.idModalEliminarDosificacion,o.idModalContenedorDosificacionEdicion,o.idModalContenedorDosificacionVista),o.buscarAplicacion(o.usuario.aplicacionesUsuario,e.path().substring(1)),r.stop()}),o.crearNuevaDosificacion=function(){var e=JSON.parse(a.usuario);o.dosificacion=new n({id_empresa:e.id_empresa}),o.abrirPopup(o.idModalWizardDosificacionEdicion)},o.verDosificacion=function(e){(o.dosificacion=e).fecha_limite_emision=new Date(e.fecha_limite_emision),o.dosificacion.fechaTexto=e.fecha_limite_emision.getDate()+"/"+(e.fecha_limite_emision.getMonth()+1)+"/"+e.fecha_limite_emision.getFullYear(),o.abrirPopup(o.idModalWizardDosificacionVista)},o.cerrarPopPupVista=function(){o.cerrarPopup(o.idModalWizardDosificacionVista)},o.cerrarPopPupEdicion=function(){o.cerrarPopup(o.idModalWizardDosificacionEdicion)},o.modificarDosificacion=function(e){(o.dosificacion=e).fecha_limite_emision=new Date(e.fecha_limite_emision),o.dosificacion.fechaTexto=e.fecha_limite_emision.getDate()+"/"+(e.fecha_limite_emision.getMonth()+1)+"/"+e.fecha_limite_emision.getFullYear(),o.abrirPopup(o.idModalWizardDosificacionEdicion)},o.mostrarConfirmacionEliminacion=function(e){o.dosificacion=new n(e),o.abrirPopup(o.idModalEliminarDosificacion)},o.cerrarConfirmacionEliminacion=function(){o.cerrarPopup(o.idModalEliminarDosificacion)},o.eliminarDosificacion=function(e){r.start(),o.cerrarConfirmacionEliminacion(),e.$delete(),o.mostrarMensaje("Eliminado exitosamente!"),o.recargarItemsTabla(),r.stop()},o.saveForm=function(e){"Siguiente"!=$("#siguiente").text().trim()&&(r.start(),e.fecha_limite_emision=new Date(o.convertirFecha(e.fechaTexto)),e.id?n.update({idDosificacion:e.id},e,function(e){r.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje("Actualizado Exitosamente!"),o.recargarItemsTabla()}):e.$save(function(e){r.stop(),o.dosificacion=new n({}),o.cerrarPopPupEdicion(),o.mostrarMensaje("Guardado Exitosamente!"),o.recargarItemsTabla()},function(e){r.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje("Ocurrio un problema al momento de guardar!"),o.recargarItemsTabla()}))},o.$on("$routeChangeStart",function(e,a){o.eliminarPopup(o.idModalWizardDosificacionEdicion),o.eliminarPopup(o.idModalWizardDosificacionVista),o.eliminarPopup(o.idModalEliminarDosificacion)}),o.inicio()}]),angular.module("agil.controladores").controller("ControladorEmpresas",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","Clases","Empresa","Empresas","ListaAplicacionesSistema",function(c,e,a,o,i,l,t,r,d,n,s){l.start(),c.idModalWizardEmpresaEdicion="modal-wizard-empresa",c.idModalWizardEmpresaVista="modal-wizard-empresa-vista",c.idModalEliminarEmpresa="dialog-eliminar-empresa",c.idModalContenedorEmpresaEdicion="modal-wizard-container-empresa-edicion",c.idModalContenedorEmpresaVista="modal-wizard-container-empresa-vista",c.idImagenEmpresa="imagen-empresa",c.usuario=JSON.parse(e.usuario),c.inicio=function(){c.obtenerEmpresas(c.usuario.id_empresa),c.obtenerAplicaciones(),setTimeout(function(){ejecutarScriptsTabla("tabla-empresas",11)},2e3)},c.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsEmpresa(c.idModalWizardEmpresaEdicion,c.idImagenEmpresa,c.idModalContenedorEmpresaEdicion,c.idModalWizardEmpresaVista,c.idModalContenedorEmpresaVista,c.idModalEliminarEmpresa),c.buscarAplicacion(c.usuario.aplicacionesUsuario,a.path().substring(1)),l.stop(),t("DEP").then(function(e){c.departamentos=e.clases})}),c.crearNuevaEmpresa=function(){c.esNuevo=!0,c.empresa=new d({sucursal:{},imagen:"img/icon-user-default.png",aplicaciones:[]}),c.abrirPopup(c.idModalWizardEmpresaEdicion)},c.cerrarPopPupNuevaEmpresa=function(){c.cerrarPopup(c.idModalWizardEmpresaEdicion)},c.verEmpresa=function(e){c.empresa=e,c.abrirPopup(c.idModalWizardEmpresaVista)},c.cerrarPopPupVista=function(){c.cerrarPopup(c.idModalWizardEmpresaVista)},c.cerrarPopPupEdicion=function(){c.cerrarPopup(c.idModalWizardEmpresaEdicion)},c.modificarEmpresa=function(e){e.aplicaciones=[],c.esNuevo=!1,(c.empresa=e).departamento&&c.buscarMunicipios(e.id_departamento+"-"+e.departamento.nombre_corto),c.seleccionarAplicaciones(e.aplicacionesEmpresa),c.abrirPopup(c.idModalWizardEmpresaEdicion)},c.mostrarConfirmacionEliminacion=function(e){c.empresa=new d(e),c.abrirPopup(c.idModalEliminarEmpresa)},c.cerrarConfirmacionEliminacion=function(){c.cerrarPopup(c.idModalEliminarEmpresa)},c.eliminarEmpresa=function(e){l.start(),c.cerrarConfirmacionEliminacion(),e.$delete(),c.mostrarMensaje("Eliminado exitosamente!"),c.recargarItemsTabla(),l.stop()},c.buscarMunicipios=function(e){var a=e.split("-")[1];r(a+"M").then(function(e){c.municipios=e})},c.saveForm=function(e){var a=$("#siguiente").text().trim();if(console.log(a),"Siguiente"!=a){l.start();var s=e.imagen;"string"==typeof e.id_departamento&&(e.id_departamento=e.id_departamento.split("-")[0]),c.esNuevo&&"string"==typeof e.sucursal.id_departamento&&(e.sucursal.id_departamento=e.sucursal.id_departamento.split("-")[0]),e.id?d.update({idEmpresa:e.id},e,function(e){if(null==e.signedRequest)l.stop(),c.cerrarPopPupNuevaEmpresa(),c.mostrarMensaje("Actualizado Exitosamente!"),c.recargarItemsTabla();else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(l.stop(),c.cerrarPopPupNuevaEmpresa(),c.mostrarMensaje("Actualizado Exitosamente!"),c.recargarItemsTabla()):alert("Could not upload file."))};for(var o=atob(s.split(",")[1]),i=[],t=0;t<o.length;t++)i.push(o.charCodeAt(t));var r=new Blob([new Uint8Array(i)],{type:"image/jpeg"}),n=new File([r],e.image_name,{type:"image/jpeg"});console.log(n),a.send(n)}}):e.$save(function(e){if(null==e.signedRequest)l.stop(),c.empresa=new d({sucursal:{},imagen:"img/icon-user-default.png"}),c.cerrarPopPupNuevaEmpresa(),c.mostrarMensaje("Guardado Exitosamente!"),c.recargarItemsTabla();else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(l.stop(),c.empresa=new d({sucursal:{},imagen:"img/icon-user-default.png"}),c.cerrarPopPupNuevaEmpresa(),c.mostrarMensaje("Guardado Exitosamente!"),c.recargarItemsTabla()):alert("Could not upload file."))};for(var o=atob(s.split(",")[1]),i=[],t=0;t<o.length;t++)i.push(o.charCodeAt(t));var r=new Blob([new Uint8Array(i)],{type:"image/jpeg"}),n=new File([r],e.image_name,{type:"image/jpeg"});a.send(n)}},function(e){l.stop(),c.cerrarPopPupNuevaEmpresa(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!"),c.recargarItemsTabla()})}},c.obtenerEmpresas=function(e){l.start(),null==e&&(e=0),n(e).then(function(e){c.empresas=e,l.stop()})},c.obtenerAplicaciones=function(){var e="";if(c.usuario.empresa)e=c.usuario.empresa.aplicacionesEmpresa.map(function(e){return e.id_aplicacion}).join(",");s(e).then(function(e){c.llenarAplicaciones(e)})},c.llenarAplicaciones=function(e){c.aplicacionesSistema=[];for(var a=0;a<e.length;a++){var o={name:e[a].titulo,maker:"",ticked:!1,id:e[a].id};c.aplicacionesSistema.push(o)}},c.seleccionarAplicaciones=function(e){for(var a=0;a<c.aplicacionesSistema.length;a++)for(var o=0;o<e.length;o++)c.aplicacionesSistema[a].id==e[o].id_aplicacion&&(c.aplicacionesSistema[a].ticked=!0)},c.$on("$routeChangeStart",function(e,a){c.eliminarPopup(c.idModalWizardEmpresaEdicion),c.eliminarPopup(c.idModalWizardEmpresaVista),c.eliminarPopup(c.idModalEliminarEmpresa)}),c.inicio()}]),angular.module("agil.controladores").controller("ControladorFacturas",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ConfiguracionesFactura","ConfiguracionGeneralFacturaDato","ClasesTipo","ConfiguracionFacturaSucursal","ConfiguracionFacturaEmpresa",function(o,e,a,i,t,r,n,s,c,l,d){r.start(),o.idModalWizardConfiguracionEdicion="modal-wizard-configuracion-edicion",o.idModalWizardConfiguracionGeneralEdicion="modal-wizard-configuracion-general-edicion",o.idModalContenedorConfiguracionEdicion="modal-wizard-container-configuracion-edicion",o.idModalContenedorConfiguracionGeneralEdicion="modal-wizard-container-configuracion-general-edicion",o.usuario=JSON.parse(e.usuario),o.obtenerImpresionesFactura=function(){r.start(),c("IMPFACT").then(function(e){o.impresionesFactura=e.clases,r.stop()})},o.obtenerTiposFacturacion=function(){r.start(),c("TIPOFACT").then(function(e){o.tiposFacturacion=e.clases,r.stop()})},o.obtenerTamanosPapelFactura=function(){r.start(),c("TAMPAPFACT").then(function(e){o.tamanosPapelFactura=e.clases,r.stop()})},o.obtenerTitulosFactura=function(){r.start(),c("TITFACT").then(function(e){o.titulosFactura=e.clases,r.stop()})},o.obtenerSubtitulosFactura=function(){r.start(),c("SUBTITFACT").then(function(e){o.subTitulosFactura=e.clases,r.stop()})},o.obtenerPiesFactura=function(){r.start(),c("PIÉFACT").then(function(e){o.piesFactura=e.clases,r.stop()})},o.obtenerFormatoFactura=function(){r.start(),c("FORM_IMP_FAC").then(function(e){o.formatosFactura=e.clases,r.stop()})},o.obtenerFormatoFacturaColor=function(){r.start(),c("FORM_IMP_FAC_COL").then(function(e){o.formatosFacturaColor=e.clases,r.stop()})},o.obtenerConfiguracionesFactura=function(){r.start(),n(o.usuario.id_empresa).then(function(e){o.sucursales=e,r.stop()})},o.obtenerConfiguracionGeneralFactura=function(){r.start(),s(o.usuario.id_empresa).then(function(e){o.configuracion_general=e,console.log(o.configuracion_general),r.stop()})},o.$on("$routeChangeStart",function(e,a){o.eliminarPopup(o.idModalWizardConfiguracionEdicion),o.eliminarPopup(o.idModalWizardConfiguracionGeneralEdicion)}),o.inicio=function(){o.obtenerConfiguracionesFactura(),o.obtenerConfiguracionGeneralFactura(),o.obtenerImpresionesFactura(),o.obtenerTiposFacturacion(),o.obtenerTamanosPapelFactura(),o.obtenerTitulosFactura(),o.obtenerSubtitulosFactura(),o.obtenerPiesFactura(),o.obtenerFormatoFactura(),o.obtenerFormatoFacturaColor(),setTimeout(function(){ejecutarScriptsTabla("tabla-configuraciones",7),ejecutarScriptsTabla("tabla-configuracion-general",7)},2e3)},o.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsConfiguracionFactura(o.idModalWizardConfiguracionEdicion,o.idModalContenedorConfiguracionEdicion,o.idModalWizardConfiguracionGeneralEdicion,o.idModalContenedorConfiguracionGeneralEdicion),o.buscarAplicacion(o.usuario.aplicacionesUsuario,a.path().substring(1)),r.stop()}),o.cerrarPopPupEdicion=function(){o.cerrarPopup(o.idModalWizardConfiguracionEdicion)},o.cerrarPopPupEdicionGeneral=function(){o.cerrarPopup(o.idModalWizardConfiguracionGeneralEdicion)},o.modificarConfiguracionSucursal=function(e){o.sucursal=e,o.abrirPopup(o.idModalWizardConfiguracionEdicion)},o.modificarConfiguracionGeneralFactura=function(e){o.abrirPopup(o.idModalWizardConfiguracionGeneralEdicion)},o.guardarConfiguracion=function(e){"Siguiente"!=$("#siguiente").text().trim()&&(r.start(),l.update({id_configuracion:e.configuracionFactura.id},e,function(e){r.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje(e.mensaje),o.recargarItemsTabla()}))},o.guardarConfiguracionGeneral=function(e){console.log($("#siguiente-g").text().trim()),"Siguiente"!=$("#siguiente-g").text().trim()&&(r.start(),d.update({id_configuracion:e.id},e,function(e){r.stop(),o.cerrarPopPupEdicionGeneral(),o.mostrarMensaje(e.mensaje),o.recargarItemsTabla()}))},o.inicio()}]),angular.module("agil.controladores").controller("ControladoresFarmacia",["$scope","$localStorage","$location","$templateCache"," $route","$filter","$window","$timeout","blockUI","ClasesTipo","ConfiguracionVentaVistaDatos","ProductosPanel","InventarioPaginador","ListaInventariosProducto","ListaProductosEmpresa","Venta","PacientesNit","ImprimirSalidaFarmacia","Ventas","VentasFarmacia","DatosVentaFarmacia","VentaEmpresaDatos","VentaFarmacia",function(v,i,e,a,o,t,r,n,h,s,c,l,d,u,p,m,f,g,b,C,P,_,M){v.usuario=JSON.parse(i.usuario),convertUrlToBase64Image(v.usuario.empresa.imagen,function(e){v.usuario.empresa.imagen=e}),v.idModalWizardFarmaciaEdicion="modal-wizard-farmacia-edicion",v.idModalInventario="dialog-productos-venta",v.idModalWizardVentaVista="modal-wizard-venta-vista",v.idModalPago="dialog-pago",v.$on("$viewContentLoaded",function(){ejecutarScriptsFarmacia(v.idModalWizardFarmaciaEdicion,v.idModalInventario,v.idModalWizardVentaVista,v.idModalPago)}),v.inicio=function(){v.ordenProductos=!0,v.esContado=!0,v.obtenerCargos(),v.obtenerTiposDePago(),v.obtenerConfiguracionVentaVista(),v.sucursales=v.obtenerSucursales(),v.sucursalesUsuario="";for(var e=0;e<v.usuario.sucursalesUsuario.length;e++)v.sucursalesUsuario=v.sucursalesUsuario+v.usuario.sucursalesUsuario[e].sucursal.id,e+1!=v.usuario.sucursalesUsuario.length&&(v.sucursalesUsuario=v.sucursalesUsuario+",");v.obtenerMovimientosEgreso(),v.detalleVenta={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1}},v.obtenerTiposDePago=function(){h.start(),s("TIPA").then(function(e){v.tiposPago=e.clases,h.stop()})},v.obtenerConfiguracionVentaVista=function(){h.start(),c(v.usuario.id_empresa).then(function(e){v.configuracionVentaVista=e,h.stop()})},v.obtenerSucursales=function(){for(var e=[],a=0;a<v.usuario.sucursalesUsuario.length;a++)e.push(v.usuario.sucursalesUsuario[a].sucursal);return e},v.obtenerMovimientosEgreso=function(){h.start(),s("MOVEGR").then(function(e){console.log("la entidada es  ",e.clases),v.movimientosEgreso=t("filter")(e.clases,function(e){return"PROFORMA"==e.nombre||"PRE_FACTURACION"==e.nombre||"PLANILLA_ANTICIPOS"==e.nombre}),h.stop()})},v.obtenerTipoEgreso=function(e){var a=e.nombre_corto;v.tipoEgreso=a},v.obtenerAlmacenesActividades=function(e){v.obtenerAlmacenes(e),v.obtenerActividades(e)},v.obtenerAlmacenes=function(a){v.almacenes=[];var e=$.grep(v.sucursales,function(e){return e.id==a})[0];v.almacenes=e.almacenes,v.venta.almacen=1==v.almacenes.length?v.almacenes[0]:null,v.venta.almacen&&v.cargarProductos()},v.cargarProductos=function(){l(v.usuario.id_empresa,v.venta.almacen.id).then(function(e){for(var a=0;a<e.length;a++)e[a].activar_inventario&&(e[a].inventario_disponible=v.obtenerInventarioTotal(e[a]));if(v.productos=e,angular.isDefined(i.productosProcesados)){v.productosProcesados=e;for(a=0;a<i.productosProcesados.length;a++)for(var o=0;o<v.productosProcesados.length;o++)i.productosProcesados[a].id==v.productosProcesados[o].id&&(v.productosProcesados[o].rankin=i.productosProcesados[a].rankin)}else v.productosProcesados=e;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},v.obtenerActividades=function(a){v.actividades=[];var e=$.grep(v.sucursales,function(e){return e.id==a})[0];v.actividadesDosificaciones=e.actividadesDosificaciones,v.actividades=[];for(var o=0;o<v.actividadesDosificaciones.length;o++)v.actividades.push(v.actividadesDosificaciones[o].actividad);v.venta.actividad=1==v.actividades.length?v.actividades[0]:null},v.buscarInventarios=function(e,a,o,i,t,r,n){h.start(),v.itemsPorPagina=o,""==i||null==i?i=0:v.textoBusqueda=i,v.paginaActual=a,d(v.usuario.id_empresa,e,a,o,i,t,r,n).then(function(e){for(var a=e.productos,o=0;o<a.length;o++){a[o].fecha_vencimiento=new Date(a[o].fecha_vencimiento),a[o].cantidad_total=a[o].cantidad}v.paginas=[];for(o=1;o<=e.paginas;o++)v.paginas.push(o);v.productos=a,h.stop()})},v.buscarProducto=function(e){if(""!=e&&null!=e)return p(v.usuario.id_empresa,e)},v.establecerProducto=function(i){i.tipoProducto=null==i.tipoProducto?{id:i["tipoProducto.id"],nombre:i["tipoProducto.nombre"],nombre_corto:i["tipoProducto.nombre_corto"]}:i.tipoProducto,v.editar_precio=!1,u(i.id,v.venta.almacen.id).then(function(e){i.inventarios=e;for(var a=0;a<i.inventarios.length;a++)i.inventarios[a].fecha_vencimiento=i.inventarios[a].fecha_vencimiento?new Date(i.inventarios[a].fecha_vencimiento):null,i.inventarios[a].fechaVencimientoTexto=i.inventarios[a].fecha_vencimiento?i.inventarios[a].fecha_vencimiento.getDate()+"/"+(i.inventarios[a].fecha_vencimiento.getMonth()+1)+"/"+i.inventarios[a].fecha_vencimiento.getFullYear():"",i.inventarios[a].detallesMovimiento[0].movimiento.fecha=new Date(i.inventarios[a].detallesMovimiento[0].movimiento.fecha),i.inventarios[a].detallesMovimiento[0].movimiento.fechaTexto=i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getFullYear();v.inventariosDisponibleProducto=[],v.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),v.inventariosDisponibleProducto=v.inventariosDisponibleProducto.concat(i.inventarios);var o=v.obtenerInventarioTotal(i);v.detalleVenta={producto:i,precio_unitario:i.precio_unitario,inventarioProducto:v.inventariosDisponibleProducto[0],inventario_disponible:o,costos:i.activar_inventario?i.inventarios:[],cantidad:1,descuento:i.descuento,recargo:0,ice:0,excento:0,tipo_descuento:0<i.descuento,tipo_recargo:!1},v.colorearInventarioDisponible(o,i),v.calcularImporte(),v.cerrarPopup(v.idModalInventario),v.enfocar("cantidad")})},v.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario){for(var o=0;o<e.inventarios.length;o++)a+=e.inventarios[o].cantidad;for(var i=0;i<v.venta.detallesVenta.length;i++)v.venta.detallesVenta[i].producto.id==e.id&&(a-=v.venta.detallesVenta[i].cantidad)}else a=5e5;return a},v.colorearInventarioDisponible=function(e,a){0==e?(v.porcentaje="100",v.color="red"):e>3*a.inventario_minimo+1?(v.porcentaje="100",v.color="green"):e>2*a.inventario_minimo+1?(v.porcentaje="75",v.color="green"):e>1.5*a.inventario_minimo+1?(v.porcentaje="50",v.color="green"):e==a.inventario_minimo+1?(v.porcentaje="38",v.color="yellow"):e==a.inventario_minimo?(v.porcentaje="25",v.color="red"):e<a.inventario_minimo&&0<e&&(v.porcentaje="12",v.color="red")},v.actualizarInventarioDisponibleFechaVencimiento=function(e){0!=e.inventarioProducto.id?(e.costos=[],e.costos.push(e.inventarioProducto),e.inventario_disponible=v.obtenerInventarioTotalPorFechaVencimiento(e),e.lote=e.inventarioProducto.lote):(e.inventario_disponible=v.obtenerInventarioTotal(e.producto),e.costos=e.producto.inventarios,e.lote=""),v.colorearInventarioDisponible(e.inventario_disponible,e.producto),v.calcularImporte()},v.enfocar=function(e){n(function(){$("#"+e).focus()},0)},v.interceptarTecla=function(e,a,o){13===e.which&&(o?v.enfocar(a):n(function(){$("#"+a).trigger("click")},0))},v.establecerCliente=function(e,a,o){console.log("el clientes es ::::: ",e),v.$model=a,v.$label=o,v.venta.cliente.id=e.id,v.venta.cliente.razon_social=e.persona.nombre_completo,v.venta.cliente.nit=parseInt(e.persona.ci),v.venta.cliente.campo=e.campo,v.venta.cliente.cargos=e.cargos,v.venta.cliente.designacion_empresa=e.designacion_empresa,v.enfocar("razon_social"),v.$apply()},v.obtenerInventarioTotalPorFechaVencimiento=function(e){for(var a=e.inventarioProducto.cantidad,o=0;o<v.venta.detallesVenta.length;o++)v.venta.detallesVenta[o].producto.id==e.producto.id&&v.venta.detallesVenta[o].costos[0].id==e.inventarioProducto.id&&(a-=v.venta.detallesVenta[o].cantidad);return a},v.agregarDetalleVenta=function(e){if(e.producto.activar_inventario)if(1<e.costos.length)for(var a=e.cantidad,o=0,i=JSON.parse(JSON.stringify(e));o<e.costos.length&&0<a;){e.inventarioProducto=e.costos[o];var t=v.obtenerInventarioTotalPorFechaVencimiento(e);if(0<t){var r,n=JSON.parse(JSON.stringify(i));0<o&&(n.descuento=0,n.recargo=0,n.ice=0,n.excento=0),t<a?a-=r=t:(r=a,a=0),(v.detalleVenta=n).cantidad=r,n.fecha_vencimiento=e.costos[o].fecha_vencimiento,n.lote=e.costos[o].lote,n.costos=[],n.costos.push(e.costos[o]),n.inventario=e.costos[o],v.calcularImporte(),v.venta.detallesVenta.push(n)}o++}else e.fecha_vencimiento=e.costos[0].fecha_vencimiento,e.lote=e.costos[0].lote,e.inventario=e.costos[0],v.venta.detallesVenta.push(e);else v.venta.detallesVenta.push(e);v.inventariosDisponibleProducto=[],v.sumarTotal(),v.sumarTotalImporte(),v.calcularSaldo(),v.calcularCambio(),v.detalleVenta={producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},v.enfocar("id_producto")},v.eliminarDetalleVenta=function(e){v.venta.detallesVenta.splice(v.venta.detallesVenta.indexOf(e),1),v.sumarTotal(),v.sumarTotalImporte(),v.calcularSaldo(),v.calcularCambio(),v.capturarInteraccion()},v.cambiarTipoPago=function(a){var e=$.grep(v.tiposPago,function(e){return e.id==a.id})[0];v.esContado="CONT"==e.nombre_corto,v.calcularCambio()},v.recalcular=function(){v.calcularImporte()},v.calcularCambio=function(){v.esContado?(v.venta.cambio=Math.round(100*(v.venta.pagado-v.venta.total))/100,v.pagoMinimo=v.venta.total):(v.venta.cambio=0,v.pagoMinimo=0)},v.calcularImporte=function(){var e,a;v.detalleVenta.importe=Math.round(v.detalleVenta.cantidad*v.detalleVenta.precio_unitario*1e3)/1e3,e=v.detalleVenta.tipo_descuento?v.detalleVenta.importe*(v.detalleVenta.descuento/100):v.detalleVenta.descuento,a=v.detalleVenta.tipo_recargo?v.detalleVenta.importe*(v.detalleVenta.recargo/100):v.detalleVenta.recargo,v.detalleVenta.total=Math.round(1e3*(v.detalleVenta.importe-e+a-v.detalleVenta.ice-v.detalleVenta.excento))/1e3},v.sumarTotalImporte=function(){for(var e=0,a=0;a<v.venta.detallesVenta.length;a++)e+=v.venta.detallesVenta[a].importe;v.venta.importe=Math.round(1e3*e)/1e3},v.sumarTotal=function(){for(var e=0,a=0;a<v.venta.detallesVenta.length;a++)e+=v.venta.detallesVenta[a].total;v.venta.total=Math.round(1e3*e)/1e3,v.venta.pagado=v.venta.total},v.calcularSaldo=function(){v.venta.saldo=v.venta.total-v.venta.a_cuenta},v.modificarPrecio=function(){v.editar_precio=!0},v.establecerPrecio=function(){v.editar_precio=!1},v.crearNuevaVenta=function(){v.venta=new M({id_empresa:v.usuario.id_empresa,id_usuario:v.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],pagado:0,cambio:0,despachado:!1,vendedor:null}),v.venta.sucursal=1==v.sucursales.length?v.sucursales[0]:null,v.venta.sucursal&&v.obtenerAlmacenesActividades(v.venta.sucursal.id),v.venta.movimiento=v.movimientosEgreso[0],v.obtenerTipoEgreso(v.venta.movimiento);var e=new Date;v.venta.fechaTexto=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear(),v.venta.tipoPago=v.tiposPago[0],v.cambiarTipoPago(v.venta.tipoPago),v.editar_precio=!1,v.detalleVenta={producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},v.abrirPopup(v.idModalWizardFarmaciaEdicion),v.enfocar("nit")},v.buscarCliente=function(e){if(""!=e&&null!=e)return f(v.usuario.id_empresa,e)},v.cerrarPopupFarmaciaEdicion=function(){v.cerrarPopup(v.idModalWizardFarmaciaEdicion)},v.abrirPopupInventario=function(){v.abs=r.Math.abs,v.itemsPorPagina=10,v.paginaActual=1,v.columna="nombre",v.direccion="asc",v.cantidadInv="0",v.textoBusqueda="",v.venta.almacen&&(v.almacenBusqueda=v.venta.almacen,v.buscarInventarios(v.almacenBusqueda.id,v.paginaActual,v.itemsPorPagina,v.textoBusqueda,v.columna,v.direccion,v.cantidadInv)),v.abrirPopup(v.idModalInventario)},v.obtenerCargos=function(){h.start(),s("RRHH_CARGO").then(function(e){var a=e.clases;v.llenarCargos(a),h.stop()})},v.llenarCargos=function(e){v.nuevoRH="",v.cargos=[];for(var a=0;a<e.length;a++){var o={nombre:e[a].nombre,maker:"",ticked:!1,id:e[a].id};v.cargos.push(o)}},v.obtenerVentas=function(){var e=new Date,a=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear();v.filtrarVentas(v.sucursalesUsuario,a,a)},v.filtrarVentas=function(e,a,o,i,t,r,n,s,c,l,d){i=""==i||null==i?0:i,t=""==t||null==t?0:t,r=null==r||null==r?0:r,n=null==n?0:n,s=""==s||null==s?0:s,c=null==c||null==c?0:c,l=""==l||null==l?0:l,d=""==d||null==d||null==d?0:d,h.start(),0!=n&&(v.tipoPagod=0<$.grep(v.tiposPago,function(e){return e.id==n}).length?$.grep(v.tiposPago,function(e){return e.id==n})[0].nombre:"todos"),a=new Date(v.convertirFecha(a)),o=new Date(v.convertirFecha(o)),C(e,a,o,i,t,r,n,s,c,l,d).then(function(e){v.ventas=e,h.stop()})},v.verVenta=function(e){v.venta=e,v.abrirPopup(v.idModalWizardVentaVista)},v.cerrarPopupVista=function(){v.cerrarPopup(v.idModalWizardVentaVista)},v.imprimirVenta=function(e){P(e.id,v.usuario.id_empresa).then(function(e){var a=e.venta;a.configuracion=e.configuracion,a.sucursal=e.sucursal,a.numero_literal=e.numero_literal,a.pieFactura=e.pieFactura,a.sucursalDestino=e.sucursalDestino;var o=new Date(a.fecha);a.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),g(a.movimiento.clase.nombre_corto,a,!1,v.usuario)})},v.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},v.guardarVenta=function(e,a){if(e){v.ocultarMensajesValidacion();var o=new Date;if(a.fecha=new Date(v.convertirFecha(a.fechaTexto)),a.fecha.setHours(o.getHours()),a.fecha.setMinutes(o.getMinutes()),a.esFarmacia=!0,console.log("las ventas son ==== ",a),h.start(),a.id)m.update({idCompra:compra.id},compra,function(e){h.stop(),v.cerrarPopupFarmaciaEdicion(),v.mostrarMensaje("Actualizado Exitosamente!"),v.recargarItemsTabla()});else{a.movimiento.nombre_corto;a.$save(function(e){console.log("res ==================",e),e.hasError?(h.stop(),v.crearNuevaVenta(),v.mostrarMensaje(e.message)):(h.stop(),v.cerrarPopupFarmaciaEdicion(),v.imprimirVenta(e),v.crearNuevaVenta(),v.ocultarMensajesValidacion(),v.mostrarMensaje("Venta registrada exitosamente!"))},function(e){h.stop(),v.cerrarPopupFarmaciaEdicion(),v.mostrarMensaje("Ocurrio un problema al momento de guardar!"),v.recargarItemsTabla()})}}},v.sumarMonto=function(){for(var e=0,a=0;a<v.ventas.length;a++)v.ventas[a].movimiento.clase.nombre_corto!=v.diccionario.EGRE_FACTURACION&&v.ventas[a].movimiento.clase.nombre_corto!=v.diccionario.EGRE_PROFORMA||!v.ventas[a].activa||(e+=v.ventas[a].total);return Math.round(100*e)/100},v.trueDetalle=!0,v.verDetalle=function(){v.trueDetalle?v.trueDetalle=!1:v.trueDetalle=!0},v.imprimirFiltroCajaCartaOficio=function(e,a,o){var i=new PDFDocument({compress:!1,size:[612,792],margin:0}),t=i.pipe(blobStream()),r=20;if(v.trueDetalle){for(var n=2*e.length,s=0;s<e.length;s++)n+=e[s].detallesVenta.length;var c=Math.ceil(n/r)}else r=20,c=Math.ceil(e.length/r);var l=100,d=0,u=1;v.imprimirCabeceraFiltroCajaCartaOficio(i,1,c,e,a,o),i.font("Helvetica",7);for(s=0;s<e.length;s++){i.font("Helvetica",7),i.rect(50,l+9,520,0).stroke(),i.text(s+1,55,l+20),i.font("Helvetica",6),e[s].fecha=new Date(e[s].fecha),i.text(e[s].fecha.getDate()+"/"+(e[s].fecha.getMonth()+1)+"/"+e[s].fecha.getFullYear(),65,l+20),i.text(e[s].factura,120,l+20,{width:60}),i.font("Helvetica",6),i.text(e[s].farmacia.paciente.persona.nombre_completo,170,l+15,{width:75}),i.font("Helvetica",7),i.text(e[s].farmacia.paciente.designacion_empresa,245,l+20),i.text(e[s].farmacia.paciente.codigo,305,l+20),i.text(e[s].farmacia.paciente.campo,345,l+20);for(var p=[],m=0;m<e[s].farmacia.paciente.empleadosFichas[e[s].farmacia.paciente.empleadosFichas.length-1].cargos.length;m++)p.push(e[s].farmacia.paciente.empleadosFichas[e[s].farmacia.paciente.empleadosFichas.length-1].cargos[m].cargo.nombre);if(i.text(p.toString(),385,l+20,{width:50}),i.text(e[s].total,425,l+20),e[s].tipoPago?(i.text(e[s].tipoPago.nombre,455,l+20),e[s].tipoPago.nombre==v.diccionario.TIPO_PAGO_CREDITO&&(i.font("Helvetica",6),i.text("Plazo: "+e[s].dias_credito+" A cuenta: Bs "+e[s].a_cuenta+" Saldo: Bs "+e[s].saldo,510,l+16,{width:55}))):(i.text("",455,l+20),i.text("",520,l+16,{width:65})),v.trueDetalle){i.rect(50,l+34,520,0).stroke(),i.font("Helvetica",7),l+=50,i.text("N°",105,l),i.text("Nombre",115,l),i.text("Codigo Item",170,l),i.text("Unidad de Med",230,l),i.text("Cantidad",295,l),i.text("Importe",355,l),d++;for(var f=0;f<e[s].detallesVenta.length;f++)if(i.font("Helvetica",7),i.text(f+1,105,l+20),i.text(e[s].detallesVenta[f].producto.nombre,115,l+20,{width:55}),i.text(e[s].detallesVenta[f].producto.id,170,l+20),i.text(e[s].detallesVenta[f].producto.unidad_medida,230,l+20),i.text(e[s].detallesVenta[f].cantidad,295,l+20),i.text(e[s].detallesVenta[f].importe,355,l+20),l+=24,r-1<++d+1){l+=10,i.text(u+" de "+c,520,705);var g=new Date;i.text("FECHA : "+g.getDate()+"/"+(g.getMonth()+1)+"/"+g.getFullYear()+"   Hr:"+g.getHours()+":"+g.getMinutes(),55,705),i.text("USUARIO: "+v.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),l=100,d=0,u+=1,v.imprimirCabeceraFiltroCajaCartaOficio(i,1,c,e,a,o)}if(i.font("Helvetica",7),l+=4,r<++d){l+=10,i.text(u+" de "+c,520,705);g=new Date;i.text("FECHA : "+g.getDate()+"/"+(g.getMonth()+1)+"/"+g.getFullYear()+"   Hr:"+g.getHours()+":"+g.getMinutes(),55,705),i.text("USUARIO: "+v.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),l=100,d=0,u+=1,v.imprimirCabeceraFiltroCajaCartaOficio(i,1,c,e,a,o)}}else if(i.font("Helvetica",7),l+=30,++d==r){i.text(u+" de "+c,520,705);g=new Date;i.text("FECHA : "+g.getDate()+"/"+(g.getMonth()+1)+"/"+g.getFullYear()+"   Hr:"+g.getHours()+":"+g.getMinutes(),55,705),i.text("USUARIO: "+v.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),l=100,d=0,u+=1,v.imprimirCabeceraFiltroCajaCartaOficio(i,1,c,e,a,o)}}i.font("Helvetica",7),i.text(u+" de "+c,520,705);g=new Date;i.text("FECHA : "+g.getDate()+"/"+(g.getMonth()+1)+"/"+g.getFullYear()+"   Hr:"+g.getHours()+":"+g.getMinutes(),55,705),i.text("USUARIO: "+v.usuario.nombre_usuario,150,705),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),h.stop()},v.imprimirCabeceraFiltroCajaCartaOficio=function(e,a,o,i,t,r){e.font("Helvetica-Bold",16),e.text("REPORTE",0,40,{align:"center"}),e.font("Helvetica-Bold",8),e.rect(50,80,520,620).stroke(),e.text("Desde: "+t+" Hasta: "+r,0,55,{align:"center"});var n=[v.razon_sociald,v.nitd,v.montod,v.usuariod,v.transacciond,v.sucursald,v.tipoPagod],s=0,c="";e.text("Filtro: ",55,65);for(var l=0;l<n.length;l++)0!=n[l]&&null!=n[l]?(c=c+n[l]+", ",65):7==(s+=1)&&e.text("GENERAL",85,65);e.text(c,85,65),e.font("Helvetica-Bold",7),e.font("Helvetica-Bold",8),e.text("N°",55,90),e.text("Fecha",65,90),e.text("Receta",120,90,{width:43}),e.text("Nombre Completo",170,90),e.text("Empresa",245,90,{width:43}),e.text("Código",305,90),e.text("Campo",345,90,{width:43}),e.text("Cargo",385,90,{width:43}),e.text("Monto",420,90),e.text("Tipo de Pago",455,90),e.text("Pago",520,90)},v.imprimirFiltroExcelCajaCartaOficio=function(e){h.start();for(var a=[["N°","Fecha","Receta","Nombre Completo","Empresa","Código","Campo","Cargo","Monto","Tipo de Pago","Pago"]],o=0;o<e.length;o++){var i=[];e[o].fecha=new Date(e[o].fecha),i.push(o+1),i.push(e[o].fecha.getDate()+"/"+(e[o].fecha.getMonth()+1)+"/"+e[o].fecha.getFullYear()),i.push(e[o].factura),i.push(e[o].farmacia.paciente.persona.nombre_completo),i.push(e[o].farmacia.paciente.designacion_empresa),i.push(e[o].farmacia.paciente.codigo),i.push(e[o].farmacia.paciente.campo);for(var t=[],r=0;r<e[o].farmacia.paciente.empleadosFichas[e[o].farmacia.paciente.empleadosFichas.length-1].cargos.length;r++)t.push(e[o].farmacia.paciente.empleadosFichas[e[o].farmacia.paciente.empleadosFichas.length-1].cargos[r].cargo.nombre);if(i.push(t.toString()),i.push(e[o].total),e[o].tipoPago?(i.push(e[o].tipoPago.nombre),e[o].tipoPago.nombre==v.diccionario.TIPO_PAGO_CREDITO&&i.push("Plazo: "+e[o].dias_credito+" A cuenta: Bs "+e[o].a_cuenta+" Saldo: Bs "+e[o].saldo)):i.push(""),"TRASPASO"==e[o].movimiento.clase.nombre&&(i.push(""),i.push(e[o].almacenTraspaso.sucursal.nombre)),a.push(i),v.trueDetalle){a.push(["","","","","N°","Nombre","Codigo Item","Unidad de Med","Cantidad","Importe"]);for(r=0;r<e[o].detallesVenta.length;r++)(i=[]).push(""),i.push(""),i.push(""),i.push(""),i.push(r+1),i.push(e[o].detallesVenta[r].producto.nombre),i.push(e[o].detallesVenta[r].producto.id),i.push(e[o].detallesVenta[r].producto.unidad_medida),i.push(e[o].detallesVenta[r].cantidad),i.push(e[o].detallesVenta[r].importe),a.push(i)}o+1==e.length&&((i=[]).push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),a.push(i))}var n="SheetJS",s=new Workbook,c=sheet_from_array_of_arrays(a);s.SheetNames.push(n),s.Sheets[n]=c;var l=XLSX.write(s,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"Reporte-ventas-farmacia.xlsx"),h.stop()},v.abrirPopupPago=function(e){v.venta=e,v.pago=null,v.abrirPopup(v.idModalPago)},v.cerrarPopupPago=function(){v.cerrarPopup(v.idModalPago)},v.efectuarPago=function(a){h.start(),_.update({id:v.venta.id,id_empresa:v.usuario.id_empresa},{pago:a,id_usuario_cajero:v.usuario.id},function(e){v.mostrarMensaje(e.mensaje),v.cerrarPopup(v.idModalPago),v.obtenerVentas(),v.imprimirRecibo(e,e.venta,a),h.stop()},function(e){v.mostrarMensaje(e),v.cerrarPopup(v.idModalPago),v.obtenerVentas(),h.stop()})},v.imprimirRecibo=function(e,a,o){h.start();var i=new PDFDocument({compress:!1,size:[227,353],margin:10}),t=i.pipe(blobStream());i.moveDown(2),i.font("Helvetica-Bold",8),i.text(v.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),i.moveDown(.4),i.font("Helvetica",7),i.text(a.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),i.moveDown(.4),i.text(a.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),i.moveDown(.4);var r=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");i.text("TELF.: "+r,{align:"center"}),i.moveDown(.4),i.text("COCHABAMBA - BOLIVIA",{align:"center"}),i.moveDown(.5),i.font("Helvetica-Bold",8),i.text("RECIBO",{align:"center"}),i.font("Helvetica",7),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.text(a.almacen.sucursal.nota_recibo_correlativo,{align:"center"}),i.moveDown(.4),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.moveDown(.6);var n=new Date;i.text("FECHA : "+n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear(),{align:"left"}),i.moveDown(.4),i.text("He recibido de : "+v.venta.farmacia.paciente.persona.nombre_completo,{align:"left"}),i.moveDown(.4),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.2),i.text("       CONCEPTO                                   ",{align:"left"}),i.moveDown(.2),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.4),a.fecha=new Date(a.fecha),i.text("Fecha: "+a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear(),15,210);var s=v.venta.movimiento.clase.nombre_corto==v.diccionario.EGRE_FACTURACION?"Factura nro. "+v.venta.factura:"Proforma nro. "+v.venta.factura;i.text(s,105,210,{width:100}),i.text("Saldo Bs "+(a.saldo-o)+".-",105,220,{width:100}),i.text("Bs "+o+".-",170,210,{width:100}),i.text("--------------",10,230,{align:"right"}),i.moveDown(.3),i.text("TOTAL Bs.              "+o.toFixed(2),{align:"right"}),i.moveDown(.4),i.moveDown(.4),i.text("SON: "+e.pago,{align:"left"}),i.moveDown(.6),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.text("-------------------------                       -------------------------",{align:"center"}),i.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),h.stop()},v.$on("$routeChangeStart",function(e,a){v.eliminarPopup(v.idModalWizardFarmaciaEdicion),v.eliminarPopup(v.idModalInventario),v.eliminarPopup(v.idModalWizardVentaVista),v.eliminarPopup(v.idModalPago)}),v.inicio()}]),angular.module("agil.controladores").controller("ControladorInventarios",["$scope","$timeout","$filter","$window","$localStorage","$location","$templateCache","$route","blockUI","ListaInventariosProducto","Inventario","InventarioPaginador","Productos","ActualizacionInventario","ListaProductosEmpresa","IngresosPorInventario","ActualizarDetalleMovimiento","ListaGruposProductoUsuario","ProductosUsuario","IngPorInventario","InventarioInicial",function(d,a,r,e,o,i,t,n,u,s,c,l,p,m,f,g,v,h,b,C,P){function _(e,a){return"asc"==d.direccion?e.cantidad_total-a.cantidad_total:a.cantidad_total-e.cantidad_total}u.start(),d.usuario=JSON.parse(o.usuario),d.idModalActualizacionInventario="dialog-actualizacion-inventario",d.idModalIngresosPorInventario="dialog-ingreso-por-inventario",d.idModalCreacionInventario="dialog-creacion-inventario-inicial",d.inicio=function(){d.seleccionGrupo={},d.obtenerSucursales(),d.obtenerInventarios(),d.compraIngresosPorInventario(),d.obtenerGruposProductosEmpresaUsuario()},d.establecerCantidad=function(e){d.cantidadInventario=e},d.obtenerSucursales=function(){for(var e=[],a=0;a<d.usuario.sucursalesUsuario.length;a++)e.push(d.usuario.sucursalesUsuario[a].sucursal);d.sucursales=e},d.obtenerAlmacenes=function(a){d.almacenes=[];var e=$.grep(d.sucursales,function(e){return e.id==a})[0];d.almacenes=e.almacenes},d.establecerAlmacen=function(e){d.id_almacen=e},d.establecerAlmacenBusqueda=function(e){console.log(e.id),d.almacenBusqueda=e},d.obtenerInventarios=function(){d.abs=e.Math.abs,d.itemsPorPagina=10,d.paginaActual=1,d.columna="nombre",d.direccion="asc",d.textoBusqueda="",d.cantidadInventario="0",1==d.sucursales.length&&(d.sucursalBusqueda=d.sucursales[0],d.almacenes=d.sucursalBusqueda.almacenes,1==d.almacenes.length&&(d.almacenBusqueda=d.sucursalBusqueda.almacenes[0],d.buscarInventarios(d.almacenBusqueda.id,d.paginaActual,d.itemsPorPagina,d.textoBusqueda,d.columna,d.direccion,0)))},d.obtenerGruposProductosEmpresaUsuario=function(){u.start(),h(d.usuario.id_empresa,d.usuario.id).then(function(e){u.stop(),0<e.length?d.gruposProducto=e:(d.gruposProducto=[],d.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){u.stop(),d.gruposProducto=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";d.mostrarMensaje(a)})},d.verificarPulso=function(e,a){13===e.keyCode&&(d.textoBusqueda=a,d.almacenBusqueda&&d.buscarInventarios(d.almacenBusqueda.id,1,d.itemsPorPagina,d.textoBusqueda,d.columna,d.direccion,d.cantidadInventario))},d.verDetalleInventario=function(a){s(a.id,d.almacenBusqueda.id).then(function(e){a.inventarios=e}),"none"==$("#"+a.id).css("display")?$("#"+a.id).css("display",""):$("#"+a.id).css("display","none")},d.clasificarColumna=function(e){"cantidad"==e?("asc"==d.direccion?d.direccion="desc":d.direccion="asc",d.productos.sort(_)):(d.columna==e?"asc"==d.direccion?(d.direccion="desc",$("#"+e).removeClass("fa-caret-up"),$("#"+e).addClass("fa-caret-down")):(d.direccion="asc",$("#"+e).removeClass("fa-caret-down"),$("#"+e).addClass("fa-caret-up")):(d.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+e).addClass("fa-caret-up"),$("#"+e).removeClass("fa-sort")),d.columna=e,d.buscarInventarios(d.almacenBusqueda.id,d.paginaActual,d.itemsPorPagina,d.textoBusqueda,d.columna,d.direccion,d.cantidadInventario,d.seleccionGrupo.id))},d.buscarInventarios=function(e,a,o,i,t,r,n,s){u.start(),d.itemsPorPagina=o,""==i||null==i?i=0:d.textoBusqueda=i,d.paginaActual=a,l(d.usuario.id_empresa,e,a,o,i,t,r,n,s,d.usuario.id).then(function(e){for(var a=e.productos,o=[],i=0;i<a.length;i++){d.colorearInventarioDisponible(a[i].cantidad,a[i]),o.push({id:a[i].id,nombre:a[i].nombre,descripcion:a[i].descripcion,codigo:a[i].codigo,grupo:a[i].grupo,subgrupo:a[i].subgrupo,inventarios:[],cantidad_total:a[i].cantidad,fecha_vencimiento:new Date(a[i].fecha_vencimiento),precio_unitario:a[i].precio_unitario,porcentaje:d.porcentaje,color:d.color,unidad_medida:a[i].unidad_medida})}d.paginas=[];for(i=1;i<=e.paginas;i++)d.paginas.push(i);d.productos=o,u.stop()}).catch(function(e){u.stop(),d.Productos=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";d.mostrarMensaje(a)})},d.colorearInventarioDisponible=function(e,a){0==e?(d.porcentaje="100",d.color="red"):e>3*a.inventario_minimo+1?(d.porcentaje="100",d.color="green"):e>2*a.inventario_minimo+1?(d.porcentaje="75",d.color="green"):e>1.5*a.inventario_minimo+1?(d.porcentaje="50",d.color="green"):e==a.inventario_minimo+1?(d.porcentaje="38",d.color="yellow"):e==a.inventario_minimo?(d.porcentaje="25",d.color="red"):e<a.inventario_minimo&&0<e&&(d.porcentaje="12",d.color="red")},d.abrirPopupActualizacionInventario=function(e){d.inventario=e,d.abrirPopup(d.idModalActualizacionInventario)},d.modificarCantidadInventario=function(e){m.update({id:e.id},e,function(e){d.cerrarPopupActualizacionInventario(),d.mostrarMensaje(e.message),d.obtenerInventarios()},function(e){d.cerrarPopupActualizacionInventario(),d.mostrarMensaje(e)})},d.editing=!1,d.editDesalleMovimiento=function(e){(console.log(d.editing),console.log(d.editing),d.display)?d.editing?d.editing=!1:d.editing=!0:(d.editing?d.editing=!1:d.editing=!0,"none"==$("#"+e.id).css("display")?$("#"+e.id).css("display",""):(d.display=!1,$("#"+e.id).css("display","none")))},d.verDetalleMovimiento=function(e){console.log(e),d.editing=!1,"none"==$("#"+e.id).css("display")?($("#"+e.id).css("display",""),d.display=!0):(d.display=!1,d.editing=!1,$("#"+e.id).css("display","none"))},d.generarPdfIngresosPorInventario=function(e){u.start();var a=new PDFDocument({size:"letter",margin:10}),o=a.pipe(blobStream()),i=205,t=0,r=1,n=Math.ceil(e.detallesMovimiento.length/17);d.dibujarCabeceraPDFIngresosPorInventario(a,e,1,n),a.font("Helvetica",8);for(var s=0;s<e.detallesMovimiento.length&&t<=17;s++){if(a.rect(50,i,540,30).stroke(),d.usuario.empresa.usar_vencimientos){a.text(e.detallesMovimiento[s].producto.codigo,60,i+10,{width:50}),a.text(e.detallesMovimiento[s].cantidad,120,i+10),a.text(e.detallesMovimiento[s].producto.unidad_medida,150,i+10,{width:50}),a.text(e.detallesMovimiento[s].producto.nombre,190,i+10,{width:180}),a.text(e.detallesMovimiento[s].inventario.lote,380,i+10);var c=new Date(e.detallesMovimiento[s].inventario.fecha_vencimiento);a.text(c.getDate()+"/"+(c.getMonth()+1)+"/"+c.getFullYear(),420,i+10)}else a.text(e.detallesMovimiento[s].producto.codigo,70,i+10),a.text(e.detallesMovimiento[s].cantidad,145,i+10),a.text(e.detallesMovimiento[s].producto.unidad_medida,200,i+10,{width:50}),a.text(e.detallesMovimiento[s].producto.nombre,270,i+10,{width:200});a.text(e.detallesMovimiento[s].producto.precio_unitario,470,i+10),a.text(e.detallesMovimiento[s].total,530,i+10),i+=30,17==++t&&(a.addPage({margin:0,bufferPages:!0}),i=205,t=0,r+=1,d.dibujarCabeceraPDFIngresosPorInventario(a,e,r,n),a.font("Helvetica",8))}a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),u.stop()},d.dibujarCabeceraPDFIngresosPorInventario=function(e,a,o,i){100<d.usuario.empresa.imagen.length&&e.image(d.usuario.empresa.imagen,60,50,{width:50,height:50}),e.font("Helvetica-Bold",8),e.text(d.usuario.empresa.razon_social.toUpperCase(),60,105),e.font("Helvetica",7),e.text(a.almacen.sucursal.nombre.toUpperCase(),60,113),e.text(a.almacen.sucursal.direccion.toUpperCase(),60,121);var t=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");e.text("TELF.: "+t,60,129),e.text("COCHABAMBA - BOLIVIA",60,137),e.font("Helvetica-Bold",16),e.text("NOTA DE INGRESO",150,50),e.font("Helvetica-Bold",8),e.rect(380,50,190,50).stroke(),e.text("NIT : ",390,60),e.text(d.usuario.empresa.nit,500,60),e.rect(50,150,540,30).stroke(),e.text("FECHA : ",60,165),e.font("Helvetica-Bold",14),e.text("Inventario Inicial",360,165),e.font("Helvetica-Bold",8),e.rect(50,180,540,25).stroke(),e.rect(50,205,540,510).stroke(),d.usuario.empresa.usar_vencimientos?(e.text("CODIGO",60,195),e.text("CANT.",115,195),e.text("UNID.",150,195),e.text("DETALLE",185,195),e.text("Lote",380,195),e.text("Venc.",420,195)):(e.text("CODIGO",70,195),e.text("CANT.",140,195),e.text("UNID.",200,195),e.text("DETALLE",270,195)),e.text("P. UNIT.",470,195),e.text("TOTAL",530,195);var r=new Date,n=r.getMinutes();n<10&&(n="0"+n),e.font("Helvetica",7),e.text("USUARIO: "+d.usuario.nombre_usuario,55,740),e.text("EMISIÓN : "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear()+" Hr. "+r.getHours()+":"+n,490,740),e.font("Helvetica-Bold",8),e.text("PÁGINA "+o+" DE "+i,0,740,{align:"center"})},d.compraIngresosPorInventario=function(){C(d.usuario.id_empresa).then(function(e){e.hasErr?(d.mostrarMensaje(e.mensaje),d.ingPorInventario=[]):d.ingPorInventario=e})},d.excelIngPorInventario=function(){for(var e=[["Compra","Fecha","Sucursal","Código","Cantidad","Unidad","Detalle","Lote","Vencimiento","Costo Unitario","Total"]],a=0;a<d.ingPorInventario.length;a++)for(var o=0;o<d.ingPorInventario[a].detallesMovimiento.length;o++){var i=[];i.push(d.ingPorInventario[a].id),i.push(d.ingPorInventario[a].fecha.split("T")[0].split("-").reverse().join("/")),i.push(d.ingPorInventario[a].almacen.sucursal.nombre),i.push(d.ingPorInventario[a].detallesMovimiento[o].producto.codigo),i.push(d.ingPorInventario[a].detallesMovimiento[o].cantidad),i.push(d.ingPorInventario[a].detallesMovimiento[o].producto.unidad_medida),i.push(d.ingPorInventario[a].detallesMovimiento[o].producto.nombre),i.push(d.ingPorInventario[a].detallesMovimiento[o].inventario.lote),i.push(d.ingPorInventario[a].detallesMovimiento[o].inventario.fecha_vencimientoTexto?d.ingPorInventario[a].detallesMovimiento[o].inventario.fecha_vencimientoTexto:""),i.push(d.ingPorInventario[a].detallesMovimiento[o].costo_unitario),i.push(d.ingPorInventario[a].detallesMovimiento[o].total),e.push(i)}var t="SheetJS",r=new Workbook,n=sheet_from_array_of_arrays(e);r.SheetNames.push(t),r.Sheets[t]=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"INGRESOS POR INVENTARIO.xlsx")},d.cerrarPopupActualizacionInventario=function(){d.cerrarPopup(d.idModalActualizacionInventario)},d.abrirPopupIngresosPorInventario=function(e){d.inventario=e,d.abrirPopup(d.idModalIngresosPorInventario)},d.cerrarPopupIngresosPorInventario=function(){d.cerrarPopup(d.idModalIngresosPorInventario)},d.crearNuevoInventario=function(){d.abrirPopup(d.idModalCreacionInventario)},d.buscarProducto=function(e){if(""!=e&&null!=e)return f(d.usuario.id_empresa,e)},d.cerrarPopupInvInicial=function(){d.cerrarPopup(d.idModalCreacionInventario)},d.sumarCantidadAlmacen=function(e,a,o){e=r("filter")(e,a),e=r("filter")(e,o);for(var i=0,t=0;t<e.length;t++)i+=e[t].cantidad;return i},d.sumarCostoTotalAlmacen=function(e,a,o){e=r("filter")(e,a),e=r("filter")(e,o);for(var i=0,t=0;t<e.length;t++)i+=e[t].costo_total;return i},d.sumarCantidadSucursal=function(e,a){e=r("filter")(e,a);for(var o=0,i=0;i<e.length;i++)o+=e[i].cantidad;return o},d.sumarCostoTotalSucursal=function(e,a){e=r("filter")(e,a);for(var o=0,i=0;i<e.length;i++)o+=e[i].costo_total;return o},d.bajarExcelInventarios=function(){b(d.usuario.id_empresa,d.usuario.id).then(function(e){for(var a=[["Codigo","Nombre o Descripción","Unidad de medida","Costo Unitario","Cantidad a ingresar","Fecha de vencimiento (dia/mes/año)","Lote"]],o=0;o<e.length;o++){var i=[];i.push(e[o].codigo),i.push(e[o].nombre),i.push(e[o].unidad_medida),a.push(i)}var t="INVENTARIO",r=new Workbook,n=sheet_from_array_of_arrays(a);r.SheetNames.push(t),r.Sheets[t]=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"EJEMPLO-DATOS-INVENTARIOS.xlsx"),u.stop()})},d.guardarInventarioInicial=function(e,a){e.fechaVencimientoTexto&&(e.fecha_vencimiento=new Date(d.convertirFecha(e.fechaVencimientoTexto)));var o=[];o.push(e);new c({productos:o,id_empresa:d.usuario.id_empresa,id_almacen:d.id_almacen});var i={productos:o,id_empresa:d.usuario.id_empresa,id_almacen:d.id_almacen};P(i).then(function(e){e.hasErr?d.mostrarMensaje(e.message):(d.mostrarMensaje(e.message),d.cerrarPopupInvInicial(),d.recargarItemsTabla())}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";d.mostrarMensaje(a),u.stop()})},d.subirExcelInventarios=function(e,l){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){u.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.nombre=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.unidad_medida=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.costo_unitario=null!=r["D"+t]&&""!=r["D"+t]?parseFloat(r["D"+t].v.toString()):null,s.cantidad=null!=r["E"+t]&&""!=r["E"+t]?parseFloat(r["E"+t].v.toString()):null;var c=null;null!=r["F"+t]&&""!=r["F"+t]&&("number"==typeof r["F"+t].v?r["F"+t].v%1==0&&(c=new Date(86400*(r["F"+t].v-25568)*1e3)):c=new Date(d.convertirFecha(r["F"+t].v))),s.fecha_vencimiento=c,s.lote=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);d.guardarInventario(n,l),u.stop()},t.readAsBinaryString(o)}},d.guardarInventario=function(e,a){new c({productos:e,id_empresa:d.usuario.id_empresa,id_almacen:d.id_almacen}).$save(function(e){u.stop(),d.mostrarMensaje(e.message),d.recargarItemsTabla()},function(e){u.stop(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()})},d.animate=!1,d.editMovientoDetalle=function(e){e.inventario.fecha_vencimiento=new Date(d.convertirFecha(e.inventario.fecha_vencimientoTexto)),e.total=e.cantidad*e.costo_unitario-e.descuento+e.recargo-e.ice-e.excento,console.log(e),v.update({id:e.id},e,function(e){a(function(){d.animate=!0,a(function(){d.animate=!1},1e3)},1e3)},function(e){d.mostrarMensaje(e)})},d.editItem=function(e){e.editing=!0},d.doneEditing=function(e){e.editing=!1},d.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),d.buscarAplicacion(d.usuario.aplicacionesUsuario,i.path().substring(1)),ejecutarScriptsInventario(d.idModalActualizacionInventario,d.idModalCreacionInventario,d.idModalIngresosPorInventario),u.stop()}),d.$on("$routeChangeStart",function(e,a){d.eliminarPopup(d.idModalActualizacionInventario),d.eliminarPopup(d.idModalCreacionInventario),d.eliminarPopup(d.idModalIngresosPorInventario)}),d.inicio()}]),angular.module("agil.controladores").controller("ControladorMantenimientos",["$scope","blockUI","$localStorage","$location","$templateCache","$route","Usuario","Paginator",function(o,e,a,i,t,r,n,s){o.$on("$viewContentLoaded",function(){o.idModalInicioMantenimiento="dialog-iniciar-mantenimiento",o.idModalOTNuevo="dialog-ot-nuevo",o.idModalFacturaServicioExterno="dialog-factura-servicioExterno",o.idModaRepuestosOT="panel-repuestos-ot",o.idModalwizardContainerOTNuevo="modal-wizard-ot-nuevo-container",ejecutarScriptsMantenimientos(o.idModalInicioMantenimiento,o.idModalOTNuevo,o.idModalwizardContainerOTNuevo,o.idModalFacturaServicioExterno,o.idModaRepuestosOT)}),o.$on("$routeChangeStart",function(e,a){o.eliminarPopup(o.idModalInicioMantenimiento,o.idModalOTNuevo,o.idModalFacturaServicioExterno,o.idModaRepuestosOT)}),o.abrirDialogInicioMantenimiento=function(){o.abrirPopup(o.idModalInicioMantenimiento)},o.cerrarPopUpInicioMantenimiento=function(){o.cerrarPopup(o.idModalInicioMantenimiento)},o.abrirDialogOTnuevo=function(){o.abrirPopup(o.idModalOTNuevo)},o.cerrarOTnuevo=function(){o.cerrarPopup(o.idModalOTNuevo)},o.abrirDialogFacturaServicioExterno=function(){o.abrirPopup(o.idModalFacturaServicioExterno)},o.cerrarDialogFacturaServicioExterno=function(){o.cerrarPopup(o.idModalFacturaServicioExterno)},o.abrirDialogRepuestosOT=function(){o.abrirPopup(o.idModaRepuestosOT)},o.cerrarDialogRepuestosOT=function(){o.cerrarPopup(o.idModaRepuestosOT)}}]),angular.module("agil.controladores").controller("ControladorMesa",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ListaSalas","ListaGruposProductoEmpresa","ProductosPanel","Sala","Mesa","ClasesTipo","MesaPedidoRestaurante","PedidoRestaurante","PedidoRestauranteActualizacion","MesaActualizacion","$timeout","Venta","ImprimirSalida","ListaInventariosProducto","InactivarPedido","ClientesNit","ActualizarGarzon","CrearGarzon","Garzon","ListaGarzones","EliminacionMesaPedidoRestaurante",function(c,e,a,o,i,l,t,r,n,s,d,u,p,m,f,g,v,h,b,C,P,_,M,D,E,x,S){l.start(),c.usuario=JSON.parse(e.usuario),c.idModalPanelPedido="dialog-panel-ventas",c.idModalSalaEdicion="modal-wizard-sala-edicion",c.idModalContenedorSalaEdicion="modal-wizard-container-sala-edicion",c.idModalMesaEdicion="modal-wizard-mesa-edicion",c.idModalContenedorMesaEdicion="modal-wizard-container-mesa-edicion",c.idModalGarzonEdicion="modal-wizard-garzon-edicion",c.idModalContenedorGarzonEdicion="modal-wizard-container-garzon-edicion",c.idModalFacturacion="modal-wizard-facturacion",c.idModalContenedorFacturacion="modal-wizard-container-facturacion",c.idModalReserva="modal-wizard-reserva",c.idModalContenedorReserva="modal-wizard-container-reserva",c.idModalCambioMesa="modal-wizard-cambio-mesa",c.idModalContenedorCambioMesa="modal-wizard-container-cambio-mesa",c.idModalUnionMesas="modal-wizard-union-mesas",c.idModalContenedorUnionMesas="modal-wizard-container-union-mesas",c.idModalAsignacionGarzon="modal-wizard-asignacion-garzon",c.idModalContenedorAsignacionGarzon="modal-wizard-container-asignacion-garzon",c.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsMesas(c.idModalPanelPedido,c.idModalSalaEdicion,c.idModalContenedorSalaEdicion,c.idModalMesaEdicion,c.idModalContenedorMesaEdicion,c.idModalGarzonEdicion,c.idModalContenedorGarzonEdicion,c.idModalFacturacion,c.idModalContenedorFacturacion,c.idModalReserva,c.idModalContenedorReserva,c.idModalCambioMesa,c.idModalContenedorCambioMesa,c.idModalUnionMesas,c.idModalContenedorUnionMesas,c.idModalAsignacionGarzon,c.idModalContenedorAsignacionGarzon),c.buscarAplicacion(c.usuario.aplicacionesUsuario,a.path().substring(1)),l.stop()}),c.inicio=function(){l.start(),u("EM").then(function(e){c.estadosMesa=e.clases,l.stop()}),c.sucursales=c.obtenerSucursales(),c.obtenerMovimientosEgreso(),c.obtenerTiposDePago(),c.obtenerGarzones()},c.obtenerMovimientosEgreso=function(){l.start(),u("MOVEGR").then(function(e){c.movimientosEgreso=e.clases,l.stop()})},c.obtenerTiposDePago=function(){l.start(),u("TIPA").then(function(e){c.tiposPago=e.clases,l.stop()})},c.obtenerSalas=function(e){l.start(),c.obtenerAlmacenes(e),t(e).then(function(e){c.salas=e,c.mesas=[],l.stop()})},c.obtenerSucursales=function(){for(var e=[],a=0;a<c.usuario.sucursalesUsuario.length;a++)e.push(c.usuario.sucursalesUsuario[a].sucursal);return e},c.obtenerAlmacenes=function(a){c.almacenes=[];var e=$.grep(c.sucursales,function(e){return e.id==a})[0];c.almacenes=e.almacenes,c.filtro.almacen=1==c.almacenes.length?c.almacenes[0]:null},c.obtenerGarzones=function(){l.start(),x(c.usuario.empresa.id).then(function(e){c.garzones=e,c.llenarGarzonesOpciones(),l.stop()})},c.cargarProductosPanel=function(){n(c.usuario.id_empresa,c.filtro.almacen.id).then(function(e){for(var a=0;a<e.length;a++)e[a].activar_inventario&&(e[a].inventario_disponible=c.obtenerInventarioTotal(e[a]));c.productos=e,c.productosProcesados=e})},c.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario)for(var o=0;o<e.inventarios.length;o++)a+=e.inventarios[o].cantidad;else a=5e5;return a},c.verSala=function(e){c.salaVista=e,c.mesas=e.mesas,c.llenarMesasOpciones()},c.llenarMesasOpciones=function(){c.mesas_unidas=[];for(var e=0;e<c.mesas.length;e++){var a={name:c.mesas[e].numero+"",numero:c.mesas[e].numero,maker:"",ticked:!1,id:c.mesas[e].id};c.mesas_unidas.push(a)}},c.llenarGarzonesOpciones=function(){c.garzonesOpciones=[];for(var e=0;e<c.garzones.length;e++){var a={name:c.garzones[e].persona.nombre_completo,maker:"",ticked:!1,id:c.garzones[e].id,persona:{imagen:c.garzones[e].persona.imagen}};c.garzonesOpciones.push(a)}},c.verGarzon=function(e){c.garzon=e,c.garzonVista=e,c.abrirPopup(c.idModalGarzonEdicion),null!=c.garzon&&(c.garzon.persona.imagen="img/icon-user-default.png")},c.obtenerGruposProductoEmpresa=function(){r(c.usuario.id_empresa).then(function(e){c.grupos_productos=e})},c.verPedido=function(o){c.cargarProductosPanel(),p(o.id,c.filtro.almacen.id).then(function(e){if(e.pedidosRestaurante){c.pedidoRestaurante=e.pedidosRestaurante[0].pedidoRestaurante;for(var a=0;a<c.pedidoRestaurante.detallesPedidoRestaurante.length;a++)c.pedidoRestaurante.detallesPedidoRestaurante[a].producto.activar_inventario?c.pedidoRestaurante.detallesPedidoRestaurante[a].costos=c.pedidoRestaurante.detallesPedidoRestaurante[a].producto.inventarios:c.pedidoRestaurante.detallesPedidoRestaurante[a].costos=[]}else c.pedidoRestaurante=new m({detallesPedidoRestaurante:[],mesas:[],pedido_activo:!0,garzones:[]}),c.pedidoRestaurante.mesas.push(o);c.obtenerGruposProductoEmpresa(),c.abrirPopup(c.idModalPanelPedido),c.sumarTotal(),c.sumarTotalImporte(),setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},c.liberarMesa=function(a){p(a.id,c.filtro.almacen.id).then(function(e){e.pedidosRestaurante?c.mostrarMensaje("La mesa no puede ser liberada porque aun existe un pedido pendiente!"):(a.estado=$.grep(c.estadosMesa,function(e){return e.nombre_corto==c.diccionario.ESTADO_MESA_DISPONIBLE})[0],g.update({id_mesa:a.id},a,function(e){l.stop(),c.mostrarMensaje("Mesa liberada exitosamente!")}))})},c.reservarMesa=function(e){c.mesa=e,c.abrirPopup(c.idModalReserva)},c.crearReserva=function(){c.abrirPopup(c.idModalReserva)},c.guardarPedidoRestaurante=function(e,a){if(e)if(a.id)f.update({id_pedido_restaurante:a.id},a,function(e){l.stop(),c.cerrarPedido(),c.mostrarMensaje("Pedido actualizado Exitosamente!")});else{var o=a.mesas;a.$save(function(e){for(var a=0;a<o.length;a++)o[a].estado=e;l.stop(),c.cerrarPedido(),c.mostrarMensaje("Pedido guardado Exitosamente!")},function(e){l.stop(),c.cerrarPedido(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},c.abrirPopupDatosFacturacion=function(){c.venta=new h({cliente:{},pagado:0}),c.abrirPopup(c.idModalFacturacion)},c.buscarNit=function(a,e){13===a.which&&_(c.usuario.id_empresa,e).then(function(e){1==e.length||1<e.length?c.establecerCliente(e[0]):c.venta.cliente.razon_social=null,c.interceptarTecla(a,"razon_social",!0)})},c.interceptarTecla=function(e,a,o){13===e.which&&(o?c.enfocar(a):v(function(){$("#"+a).trigger("click")},0))},c.cerrarPopupFacturacion=function(){c.cerrarPopup(c.idModalFacturacion)},c.cerrarPopupReserva=function(){c.cerrarPopup(c.idModalReserva)},c.enfocar=function(e){v(function(){$("#"+e).focus()},0)},c.establecerCliente=function(e){c.venta.cliente=e,c.enfocar("razon_social")},c.calcularCambio=function(){c.venta.cambio=Math.round(100*(c.venta.pagado-c.pedidoRestaurante.total))/100,c.pagoMinimo=c.pedidoRestaurante.total},c.facturarPedidoRestaurante=function(){if("Siguiente"!=$("#siguienteFacturacion").text().trim()){l.start(),c.venta.total=c.pedidoRestaurante.total,c.venta.importe=c.pedidoRestaurante.importe,c.venta.id_usuario=c.usuario.id,c.venta.id_empresa=c.usuario.empresa.id,c.venta.detallesVentaNoConsolidadas=[],c.venta.fecha=new Date,c.venta.fechaTexto=c.venta.fecha.getDate()+"/"+(c.venta.fecha.getMonth()+1)+"/"+c.venta.fecha.getFullYear(),c.venta.almacen=c.filtro.almacen,c.venta.sucursal=c.filtro.sucursal,c.venta.actividad=c.filtro.sucursal.actividadesDosificaciones[0].actividad,c.venta.detallesVenta=c.pedidoRestaurante.detallesPedidoRestaurante,c.venta.movimiento=$.grep(c.movimientosEgreso,function(e){return e.nombre_corto==c.diccionario.EGRE_FACTURACION})[0],c.venta.tipoPago=$.grep(c.tiposPago,function(e){return e.nombre==c.diccionario.TIPO_PAGO_CONTADO})[0];var t=c.venta.movimiento.nombre_corto;c.venta.$save(function(e){if(c.pedidoRestaurante.id)P.update({id:c.pedidoRestaurante.id},c.pedidoRestaurante,function(e){for(var a=0;a<c.pedidoRestaurante.mesasPedidoRestaurante.length;a++){var o=$.grep(c.mesas,function(e){return e.id==c.pedidoRestaurante.mesasPedidoRestaurante[a].mesa.id})[0];c.liberarMesa(o)}l.stop()});else{console.log(c.pedidoRestaurante),c.pedidoRestaurante.pedido_activo=!1;var a=Object.create(c.pedidoRestaurante);c.guardarPedidoRestaurante(!0,c.pedidoRestaurante);for(var o=0;o<a.mesas.length;o++){var i=$.grep(c.mesas,function(e){return e.id==a.mesas[o].id})[0];c.liberarMesa(i)}}b(t,e,!0,c.usuario),c.cerrarPopup(c.idModalFacturacion),c.cerrarPedido(),c.mostrarMensaje("Venta registrada exitosamente!"),l.stop()},function(e){l.stop(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},c.eliminarDetallePedidoRestaurante=function(e){e.eliminado=!0,c.sumarTotal(),c.sumarTotalImporte()},c.disminuirDetallePedidoRestaurante=function(e){1==e.cantidad?c.eliminarDetallePedidoRestaurante(e):(e.cantidad=e.cantidad-1,c.calcularImporteDetallePedido(e),c.sumarTotal(),c.sumarTotalImporte())},c.agregarDetallePedido=function(e){var a;if(c.cantidadInventario=0,e.activar_inventario)for(var o=0;o<e.inventarios.length;o++)c.cantidadInventario=c.cantidadInventario+e.inventarios[o].cantidad;for(var i=0,t=!1;i<c.pedidoRestaurante.detallesPedidoRestaurante.length&&!t;)c.pedidoRestaurante.detallesPedidoRestaurante[i].eliminado||c.pedidoRestaurante.detallesPedidoRestaurante[i].producto.id!=e.id||(e.activar_inventario?c.pedidoRestaurante.detallesPedidoRestaurante[i].cantidad+1<=c.cantidadInventario?c.pedidoRestaurante.detallesPedidoRestaurante[i].cantidad=c.pedidoRestaurante.detallesPedidoRestaurante[i].cantidad+1:c.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+c.cantidadInventario+"!"):c.pedidoRestaurante.detallesPedidoRestaurante[i].cantidad=c.pedidoRestaurante.detallesPedidoRestaurante[i].cantidad+1,t=!0,a=c.pedidoRestaurante.detallesPedidoRestaurante[i]),i++;t?c.calcularImporteDetallePedido(a):e.activar_inventario?1<=c.cantidadInventario?(a={producto:e,precio_unitario:e.precio_unitario,inventario_disponible:c.cantidadInventario,costos:e.inventarios,cantidad:1,descuento:e.descuento,tipo_descuento:0<e.descuento,recargo:0,ice:0,excento:0,tipo_recargo:!1},c.pedidoRestaurante.detallesPedidoRestaurante.push(a),c.calcularImporteDetallePedido(a)):c.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+c.cantidadInventario+"!"):(a={producto:e,precio_unitario:e.precio_unitario,inventario_disponible:c.cantidadInventario,costos:[],cantidad:1,descuento:e.descuento,tipo_descuento:0<e.descuento,recargo:0,ice:0,excento:0,tipo_recargo:!1},c.pedidoRestaurante.detallesPedidoRestaurante.push(a),c.calcularImporteDetallePedido(a)),c.sumarTotal(),c.sumarTotalImporte()},c.sumarTotalImporte=function(){for(var e=0,a=0;a<c.pedidoRestaurante.detallesPedidoRestaurante.length;a++)c.pedidoRestaurante.detallesPedidoRestaurante[a].eliminado||(e+=c.pedidoRestaurante.detallesPedidoRestaurante[a].importe);c.pedidoRestaurante.importe=Math.round(1e3*e)/1e3},c.sumarTotal=function(){for(var e=0,a=0;a<c.pedidoRestaurante.detallesPedidoRestaurante.length;a++)c.pedidoRestaurante.detallesPedidoRestaurante[a].eliminado||(e+=c.pedidoRestaurante.detallesPedidoRestaurante[a].total);c.pedidoRestaurante.total=Math.round(1e3*e)/1e3},c.calcularImporteDetallePedido=function(e){var a,o;e.importe=Math.round(e.cantidad*e.precio_unitario*1e3)/1e3,a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,o=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+o-e.ice-e.excento},c.cerrarPedido=function(){c.cerrarPopup(c.idModalPanelPedido)},c.clasificarGrupo=function(e){c.productosProcesados=$filter("filter")(c.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},c.ordenarProductos=function(e){console.log(e),c.productosProcesados=$filter("orderBy")(c.productos,["nombre"],e),c.ordenProductos=!e,setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},c.filtrarProductos=function(e){c.productosProcesados=$filter("filter")(c.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},c.cambiarColor=function(e,a){$("#dialog-panel-ventas .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-ventas .widget-main").addClass(e),$("#dialog-panel-ventas .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-ventas .widget-main .button-style").addClass(a)},c.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},c.crearSala=function(e){c.sala=new s({id_sucursal:e}),c.abrirPopup(c.idModalSalaEdicion),$("#sala_step_1").trigger("click")},c.crearMesa=function(e){c.mesa=new d({id_sala:e,imagen:"img/table.png"}),c.mesa.estado=$.grep(c.estadosMesa,function(e){return e.nombre_corto==c.diccionario.ESTADO_MESA_DISPONIBLE})[0],c.abrirPopup(c.idModalMesaEdicion),$("#mesa_step_1").trigger("click")},c.crearGarzon=function(e){c.garzon=new D({id_empresa:c.usuario.id_empresa,persona:{imagen:"img/icon-user-default.png"}}),c.abrirPopup(c.idModalGarzonEdicion),$("#garzon_step_1").trigger("click")},c.cerrarPopPupEdicionSala=function(){c.cerrarPopup(c.idModalSalaEdicion)},c.cerrarPopPupEdicionMesa=function(){c.cerrarPopup(c.idModalMesaEdicion)},c.cerrarPopPupEdicionGarzon=function(){c.cerrarPopup(c.idModalGarzonEdicion)},c.guardarSala=function(a){"Siguiente"!=$("#siguiente").text().trim()&&(l.start(),a.id?s.update({id_sala:a.id},a,function(e){l.stop(),c.cerrarPopPupEdicionSala(),c.mostrarMensaje("Sala actualizada Exitosamente!")}):a.$save(function(e){l.stop(),c.cerrarPopPupEdicionSala(),c.obtenerSalas(a.id_sucursal),c.mostrarMensaje("Sala guardada Exitosamente!")},function(e){l.stop(),c.cerrarPopPupEdicionSala(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!")}))},c.guardarMesa=function(e){if("Siguiente"!=$("#siguienteMesa").text().trim()){l.start();var a=e.estado;e.id?d.update({id_mesa:e.id},e,function(e){l.stop(),c.cerrarPopPupEdicionMesa(),c.mostrarMensaje("Mesa actualizada Exitosamente!")}):e.$save(function(e){e.estado=a,c.salaVista.mesas.push(e),l.stop(),c.cerrarPopPupEdicionMesa(),c.mostrarMensaje("Mesa guardada Exitosamente!")},function(e){l.stop(),c.cerrarPopPupEdicionMesa(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},c.guardarGarzon=function(e){if(c.garzon=e,"Siguiente"!=$("#siguienteGarzon").text().trim()){l.start();var s=e.persona.imagen;e.id?M.update({id_garzon:e.id},c.garzon,function(e){if(null==e.signedRequest)c.obtenerGarzones(),l.stop(),c.cerrarPopPupEdicionGarzon(),c.mostrarMensaje("Garzon actualizado Exitosamente!");else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(c.obtenerGarzones(),l.stop(),c.cerrarPopPupEdicionGarzon(),c.mostrarMensaje("Garzon actualizado Exitosamente!")):alert("Could not upload file."))};for(var o=atob(s.split(",")[1]),i=[],t=0;t<o.length;t++)i.push(o.charCodeAt(t));var r=new Blob([new Uint8Array(i)],{type:"image/jpeg"}),n=new File([r],e.image_name,{type:"image/jpeg"});console.log(n),a.send(n)}}):e.$save(function(e){if(null==e.signedRequest)c.verGarzon(),c.obtenerGarzones(),l.stop(),c.cerrarPopPupEdicionGarzon(),c.mostrarMensaje("Garzon guardado Exitosamente!");else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(c.verGarzon(),c.obtenerGarzones(),l.stop(),c.cerrarPopPupEdicionGarzon(),c.mostrarMensaje("Garzon guardado Exitosamente!")):alert("Could not upload file."))};for(var o=atob(s.split(",")[1]),i=[],t=0;t<o.length;t++)i.push(o.charCodeAt(t));var r=new Blob([new Uint8Array(i)],{type:"image/jpeg"}),n=new File([r],e.image_name,{type:"image/jpeg"});a.send(n)}},function(e){l.stop(),c.cerrarPopPupEdicionGarzon(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},c.abrirPopupAsignacionGarzon=function(){if(c.llenarGarzonesOpciones(),c.pedidoRestaurante.garzones)for(var e=0;e<c.garzonesOpciones.length;e++)for(var a=0;a<c.pedidoRestaurante.garzones.length;a++)c.garzonesOpciones[e].id==c.pedidoRestaurante.garzones[a].id&&(c.garzonesOpciones[e].ticked=!0);else for(e=0;e<c.garzonesOpciones.length;e++)for(a=0;a<c.pedidoRestaurante.garzonesPedidoRestaurante.length;a++)c.garzonesOpciones[e].id==c.pedidoRestaurante.garzonesPedidoRestaurante[a].garzon.id&&(c.garzonesOpciones[e].ticked=!0);c.abrirPopup(c.idModalAsignacionGarzon)},c.abrirPopupUnionMesas=function(){if(c.llenarMesasOpciones(),c.pedidoRestaurante.mesas)for(var e=0;e<c.mesas_unidas.length;e++)for(var a=0;a<c.pedidoRestaurante.mesas.length;a++)c.mesas_unidas[e].id==c.pedidoRestaurante.mesas[a].id&&(c.mesas_unidas[e].ticked=!0);else for(e=0;e<c.mesas_unidas.length;e++)for(a=0;a<c.pedidoRestaurante.mesasPedidoRestaurante.length;a++)c.mesas_unidas[e].id==c.pedidoRestaurante.mesasPedidoRestaurante[a].mesa.id&&(c.mesas_unidas[e].ticked=!0);c.abrirPopup(c.idModalUnionMesas)},c.abrirPopupCambioMesa=function(){c.mesaAcambiar=null,c.abrirPopup(c.idModalCambioMesa)},c.cerrarPopupCambioMesa=function(){c.cerrarPopup(c.idModalCambioMesa)},c.cerrarPopupUnionMesas=function(){c.cerrarPopup(c.idModalUnionMesas)},c.cerrarPopupAsignacionGarzones=function(){c.cerrarPopup(c.idModalAsignacionGarzon)},c.cambiarMesa=function(a){c.pedidoRestaurante.mesas||P.update({id:c.pedidoRestaurante.id},c.pedidoRestaurante,function(e){for(var a=0;a<c.pedidoRestaurante.mesasPedidoRestaurante.length;a++){var o=$.grep(c.mesas,function(e){return e.id==c.pedidoRestaurante.mesasPedidoRestaurante[a].mesa.id})[0];c.liberarMesa(o)}c.guardarPedidoRestaurante(!0,c.pedidoRestaurante)}),c.pedidoRestaurante.mesas=[],c.pedidoRestaurante.mesas.push(a),$.grep(c.mesas,function(e){return e.id==a.id})[0].estado=$.grep(c.estadosMesa,function(e){return e.nombre_corto==c.diccionario.ESTADO_MESA_OCUPADO})[0],c.cerrarPopupCambioMesa()},c.estaMesaUnida=function(e){for(var a=!1,o=0,i=c.pedidoRestaurante.mesas?c.pedidoRestaurante.mesas:c.pedidoRestaurante.mesasPedidoRestaurante;o<i.length&&!a;){(i[o].mesa?i[o].mesa:i[o]).id==e.id&&(a=!0),o++}return a},c.unirMesas=function(e){for(var a=[],o=0;o<e.length;o++){if(!c.estaMesaUnida(e[o]))a.push(e[o]),p(e[o].id,c.filtro.almacen.id).then(function(e){if(e.pedidosRestaurante)for(var a=e.pedidosRestaurante[0].pedidoRestaurante,o=0;o<a.detallesPedidoRestaurante.length;o++){a.detallesPedidoRestaurante[o].producto.activar_inventario?a.detallesPedidoRestaurante[o].costos=a.detallesPedidoRestaurante[o].producto.inventarios:a.detallesPedidoRestaurante[o].costos=[];for(var i=0;i<a.detallesPedidoRestaurante[o].cantidad;i++)c.agregarDetallePedido(a.detallesPedidoRestaurante[o].producto)}c.sumarTotal(),c.sumarTotalImporte()})}if(0<a.length){for(var i="",t=0;t<a.length;t++)i=t==a.length-1?i+""+a[t].id:a[t].id+","+i;new S({id:i}).$delete(function(){c.pedidoRestaurante.mesas=e,f.update({id_pedido_restaurante:c.pedidoRestaurante.id},c.pedidoRestaurante,function(e){l.stop(),c.cerrarPopupUnionMesas(),c.mostrarMensaje("Mesas Unidas satisfactoriamente!")})})}c.cerrarPopupUnionMesas(),c.mostrarMensaje("Mesas Unidas satisfactoriamente!")},c.estaGarzon=function(e){for(var a=!1,o=0,i=c.pedidoRestaurante.garzones?c.pedidoRestaurante.garzones:c.pedidoRestaurante.garzonesPedidoRestaurante;o<i.length&&!a;){(i[o].garzon?i[o].mesa:i[o]).id==e.id&&(a=!0),o++}return a},c.asignarGarzones=function(a){c.pedidoRestaurante.garzones=a,c.pedidoRestaurante.id?f.update({id_pedido_restaurante:c.pedidoRestaurante.id},c.pedidoRestaurante,function(e){c.pedidoRestaurante.garzones=a,l.stop(),c.cerrarPopupAsignacionGarzones(),c.mostrarMensaje("Garzones asignados satisfactoriamente!")}):(c.cerrarPopupAsignacionGarzones(),c.mostrarMensaje("Garzones asignados satisfactoriamente!"))},c.generarCuenta=function(e){var a=new PDFDocument({size:[227,350],margins:{top:10,bottom:10,left:20,right:20}});stream=a.pipe(blobStream()),a.font("Helvetica-Bold",14),a.moveDown(.8);var o="";if(e.mesas)for(var i=0;i<e.mesas.length;i++)o=o+" "+e.mesas[i].numero+",";else for(i=0;i<e.mesasPedidoRestaurante.length;i++)o=o+" "+e.mesasPedidoRestaurante[i].mesa.numero+",";a.text("MESAS: "+o,{align:"center"}),a.font("Helvetica",10),a.moveDown(.4),a.text("Cant.  Consumo                P/U           total",{align:"left"}),a.moveDown(.4);var t=a.y;for(i=0;i<e.detallesPedidoRestaurante.length;i++)a.font("Helvetica",9),a.text(e.detallesPedidoRestaurante[i].cantidad,20,t),a.text(e.detallesPedidoRestaurante[i].producto.nombre,30,t,{width:100}),a.text(e.detallesPedidoRestaurante[i].producto.precio_unitario.toFixed(2),140,t),a.text(e.detallesPedidoRestaurante[i].producto.precio_unitario*e.detallesPedidoRestaurante[i].cantidad,180,t),t+=20;a.x=20,a.font("Helvetica",10),a.moveDown(.4),a.text("Total Transacción:                         "+e.total.toFixed(2),{align:"left"}),a.moveDown(2),a.text("Por favor llene sus datos para la emision de factura:",{align:"left"}),a.moveDown(.4),a.text("Razon social:.........................................",{align:"left"}),a.moveDown(.4),a.text("...............................................................",{align:"left"}),a.moveDown(.4),a.text("Nit:.........................................................",{align:"left"}),a.moveDown(2);var r=new Date,n=r.getMinutes();n<10&&(n="0"+n),a.text(" Fecha : "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear()+"  "+r.getHours()+":"+n+"  ",{align:"center"}),a.end(),stream.on("finish",function(){var e=stream.toBlobURL("application/pdf"),a=window.open(e,"_blank","location=no");v(function(){a.print()},500)})},c.obtenerMesasLibres=function(){if(c.mesas){for(var e=[],a=0;a<c.mesas.length;a++)c.mesas[a].estado.nombre_corto==c.diccionario.ESTADO_MESA_DISPONIBLE&&e.push(c.mesas[a]);return e}},c.$on("$routeChangeStart",function(e,a){c.eliminarPopup(c.idModalPanelPedido),c.eliminarPopup(c.idModalSalaEdicion),c.eliminarPopup(c.idModalMesaEdicion),c.eliminarPopup(c.idModalGarzonEdicion),c.eliminarPopup(c.idModalFacturacion),c.eliminarPopup(c.idModalReserva),c.eliminarPopup(c.idModalCambioMesa),c.eliminarPopup(c.idModalUnionMesas),c.eliminarPopup(c.idModalAsignacionGarzon)}),c.inicio()}]),angular.module("agil.controladores").controller("ControladorOperaciones",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","blockUI","ConfiguracionVentaVistaDatos","ClasesTipo","ListaGruposProductoEmpresa","ProductosOperaciones","socket","ListaGruposProductoEmpresa","SolicitudesReposicion","SolicitudesFormulacionProducto","SolicitudReposicion","EliminarSolicitudReposicion","Paginator","ImpresionSolicitudDatos","ListaInventariosProducto","ListaSucursalesUsuario","ListaGruposProductoUsuario","CerrarSolicitud","Solicitud","ProveedoresNit","ListaProductosEmpresaUsuario","$timeout","GuardarPedido","ListaProveedores","ProductosPaginadorSubgrupos","ListaProductosProveedores","ProductosPaginadorAsignados","ActualizarProductosProveedor","ListaSubGruposProductoEmpresa",function(m,a,e,o,i,t,r,s,f,n,c,l,d,u,l,p,g,v,h,b,C,P,_,M,D,E,x,S,A,T,w,I,R,j,O,F){m.usuarioSesion=JSON.parse(s.usuario),convertUrlToBase64Image(m.usuarioSesion.empresa.imagen,function(e){m.usuarioSesion.empresa.imagen=e}),m.idDialogDialogPanelOperaciones="dialog-panel-operaciones",m.idDialogDatos="modal-wizard-venta-edicion",m.idDialogEntregaViveres="dialogEntregaViveres",m.idConfirmacionCierre="dialog-confirmacion-entrega",m.idDialogTotalIngredientes="dialog-total-ingredientes",m.idDialogoListadoPedido="modal-listado-nuevo-pedido",m.idDialogoNuevoPedido="modal-nuevo-pedido",m.idDialogProductosProveedor="dialog-productos-proveedor-configuracion",m.idDialogBusquedaProveedor="dialog-Busqueda-proveedor",m.idDialogProductosAsigandosProveedor="dialog-productos-proveedor-asignados",m.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),A(function(){ejecutarScriptsOperaciones(m.idDialogDialogPanelOperaciones,m.idDialogDatos,m.idDialogEntregaViveres,m.idConfirmacionCierre,m.idDialogTotalIngredientes,m.idDialogoListadoPedido,m.idDialogoNuevoPedido,m.idDialogProductosProveedor,m.idDialogBusquedaProveedor,m.idDialogProductosAsigandosProveedor),m.buscarAplicacion(m.usuarioSesion.aplicacionesUsuario,t.path().substring(1))},500)}),m.$on("$routeChangeStart",function(e,a){m.eliminarPopup(m.idDialogDialogPanelOperaciones),m.eliminarPopup(m.idDialogDatos),m.eliminarPopup(m.idDialogEntregaViveres),m.eliminarPopup(m.idConfirmacionCierre),m.eliminarPopup(m.idDialogTotalIngredientes),m.eliminarPopup(m.idDialogoListadoPedido),m.eliminarPopup(m.idDialogoNuevoPedido),m.eliminarPopup(m.idDialogProductosProveedor),m.eliminarPopup(m.idDialogBusquedaProveedor),m.eliminarPopup(m.idDialogProductosAsigandosProveedor)}),m.inicio=function(){m.imprimir={detalle:!1},m.listaProductosProveedor=[],m.seleccionProductosProveedor={seleccionar_todos:!1},m.productosAsignadosPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},m.configuracionPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},m.detallesPedido=[],m.mostarBusquedaProducto=!1,m.ordenProductos=!0,m.esContado=!0,m.obtenerConfiguracionVentaVista(),m.alreadyCalculated=!1,m.sucursalesUsuario="";for(var e=0;e<m.usuarioSesion.sucursalesUsuario.length;e++)m.sucursalesUsuario=m.sucursalesUsuario+m.usuarioSesion.sucursalesUsuario[e].sucursal.id,e+1!=m.usuarioSesion.sucursalesUsuario.length&&(m.sucursalesUsuario=m.sucursalesUsuario+",");m.obtenerProveedores(),m.obtenerProductos(),m.obtenerProductosAsignados(),m.obtenerPaginador(),m.sucursales=m.obtenerSucursales(),m.obtenerSubGruposProductosEmpresaUsuario()},m.obtenerProveedores=function(){w(m.usuarioSesion.id_empresa).then(function(e){m.proveedores=e.proveedores,m.proveedoresProcesado=e.proveedores}).catch(function(e){m.proveedores=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";m.mostrarMensaje(a)})},m.filtrarProveedores=function(e){void 0!==m.proveedores?m.proveedoresProcesado=a("filter")(m.proveedores,e):m.proveedoresProcesado=[]},m.agregarProductosSeleccionados=function(){0<m.productosProveedorSeleccionados.length?m.productosProveedorSeleccionados.forEach(function(e,a,o){m.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,id_grupo:e.id_grupo,id_subgrupo:e.id_subgrupo},m.agregardetallePedido(m.detallePedido),a===o.length&&m.cerrarModalProductosAsignadosProveedor()}):m.mostrarMensaje("No se seleccionó ningún producto para ser agregado.")},m.establecerProveedor=function(e,a){m.productosAsignadosProveedor=[],void 0===m.pedido&&(m.pedido={}),m.pedido.proveedor=e,void 0!==a&&m.cerrarModalBusquedaProveedor(),m.pedido.por_proveedor&&m.generarPorProveedor()},m.abrirModalProductosProveedor=function(e){m.checkProveedor(e)?(m.buscarProductos(null,m.pedido),m.abrirPopup(m.idDialogProductosProveedor)):m.mostrarMensaje("Seleccione un proveedor para ver su asignación de productos..")},m.generarPorProveedor=function(){if(m.pedido.proveedor)if(m.pedido.por_proveedor)if(0<m.pedido.proveedor.productos.length){m.paginatorProductosAsignados.filter=m.productosAsignadosPorveedor.grupo?m.productosAsignadosPorveedor.grupo:{id:0};R(m.usuarioSesion.id_empresa,m.pedido.proveedor).then(function(e){if(e.hasErr)m.mostrarMensaje(e.mensaje),m.listaProductosProveedor=[];else if(e.productos){var a=e.productos.split(",");m.listaProductosProveedor=a.map(function(e){return parseInt(e)}),j(m.usuarioSesion.id_empresa,m.paginatorProductosAsignados,m.usuarioSesion.id,m.listaProductosProveedor,!0).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.paginatorProductosAsignados.setPages(e.paginas),m.productosAsignadosProveedor=e.productos,m.productosAsignadosProveedor.forEach(function(a){m.listaProductosProveedor.some(function(e){return e===a.id})&&(m.detallePedido={producto:a,precio_unitario:a.precio_unitario,cantidad:1,id_grupo:a.id_grupo,id_subgrupo:a.id_subgrupo},m.agregardetallePedido(m.detallePedido))})),f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})}else m.mostrarMensaje("El proveedor no tiene productos asignados."),m.listaProductosProveedor=[];f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})}else m.mostrarMensaje("El proveedor no tiene productos asignados.");else m.detallePedido={},m.detallesPedido=[];else m.mostrarMensaje("Seleccione un proveedor.")},m.verificarAsignacionProductosProveedor=function(){0<m.listaProductosProveedor.length&&m.listaProductosProveedor.forEach(function(a){m.productosAsignacionProveedor.forEach(function(e){e.id===a&&(e.seleccionado=!0)})})},m.checkProveedor=function(e){return!!m.pedido&&(!!m.pedido.proveedor&&!!m.pedido.proveedor.id)},m.buscarProveedor=function(e){if(""!=e&&null!=e)return x(m.usuario.id_empresa,e)},m.buscarProducto=function(e,a){if(void 0!==m.pedido)return""!=e&&null!=e&&null==a&&m.pedido.almacen?S(m.usuarioSesion.id_empresa,e,m.usuarioSesion.id,m.pedido.almacen):""!=e&&null!=e&&a&&m.pedido.almacen?S(m.usuarioSesion.id_empresa,e,m.usuarioSesion.id,m.pedido.almacen):void m.mostrarMensaje("Seleccione un almacen.");m.mostrarMensaje("Seleccione un almacen.")},m.establecerProducto=function(e,a){m.detallePedido={},e.tipoProducto=null==e.tipoProducto?{id:e["tipoProducto.id"],nombre:e["tipoProducto.nombre"],nombre_corto:e["tipoProducto.nombre_corto"]}:e.tipoProducto;var o=0;0<e.inventarios.length&&e.inventarios.forEach(function(e){o+=e.cantidad}),m.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,inventario_disponible:o}},m.nuevoPedido=function(){m.detallesPedido=[],m.pedido={},m.detallePedido={},m.abrirModalNuevoPedido()},m.generarPedido=function(){m.detallesPedido=[],m.pedido={generado:!0},m.detallePedido={};var e=m.calcularViveresDesdeFiltro(!0);m.detallesPedido=e.map(function(e){return 0<e.producto.inventarios.length&&e.producto.inventarios.forEach(function(e){e.cantidad}),{producto:e.producto,precio_unitario:e.producto.precio_unitario,cantidad:e.cantidad,solicitud:e.solicitud}}),m.abriridDialogoListadoPedido()},m.agregardetallePedido=function(a){null!=a?(m.detallesPedido.some(function(e){return e.producto.id===a.producto.id})?m.detallesPedido.forEach(function(e){e.producto.id===a.producto.id&&(e.cantidad+=a.cantidad)}):m.detallesPedido.push(a),m.detallePedido=void 0):m.mostrarMensaje("Ocurrió un problema, no se puede agregar un valor no definido o nulo.")},m.interceptarTecla=function(e,a,o){13===e.which&&(o?m.enfocar(a):A(function(){$("#"+a).trigger("click")},0))},m.mostrarBusqueda=function(){m.mostarBusquedaProducto?m.mostarBusquedaProducto=!1:m.mostarBusquedaProducto=!0},m.obtenerSubGruposProductosEmpresaUsuario=function(){f.start(),F(m.usuarioSesion.id_empresa,m.usuarioSesion.id).then(function(e){f.stop(),0<e.length?m.subGruposProducto=e:(m.subGruposProducto=[],m.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){m.subGruposProducto=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";m.mostrarMensaje(a),f.stop()})},m.obtenerPaginador=function(){f.start(),m.paginator=b(),m.paginator.column="fecha",m.paginator.direccion="asc",m.filtro={empresa:m.usuarioSesion.id_empresa,rol:m.usuarioSesion.rolesUsuario[0].rol.nombre,id:m.usuarioSesion.id,desde:0,hasta:0,sucursal:0,almacen:0,movimiento:0,estado:0,valuado:0,pagina:1,items_pagina:10,busqueda:""},m.paginator.callBack=m.obtenerSolicitudes,m.paginator.getSearch("",m.filtro,null),f.stop()},m.obtenerSolicitudes=function(){f.start(),m.filtro.busqueda=m.paginator.search,m.filtro.desde=void 0!==m.filtro.fechaInicioTexto&&""!==m.filtro.fechaInicioTexto?m.convertirFecha(m.filtro.fechaInicioTexto):0,m.filtro.hasta=void 0!==m.filtro.fechaFinTexto&&""!==m.filtro.fechaFinTexto?m.convertirFecha(m.filtro.fechaFinTexto):0,m.filtro.movimiento=0,m.filtro.estado=null!==m.filtro.estado&&void 0!==m.filtro.estado.id?m.filtro.estado.id:0,m.paginator.filter=m.filtro,p(m.paginator).then(function(e){m.paginator.setPages(e.paginas),m.solicitudesOperaciones=e.solicitudes,f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})},m.obtenerSucursales=function(){for(var e=[],a=0;a<m.usuarioSesion.sucursalesUsuario.length;a++)e.push(m.usuarioSesion.sucursalesUsuario[a].sucursal);return e},m.obtenerAlmacenes=function(a){if(void 0===a&&(m.filtro.sucursal=void 0,m.almacenes=[]),void 0!==a){m.almacenes=[];var e=$.grep(m.sucursales,function(e){return e.id==a})[0];m.almacenes=e?e.almacenes:[]}},m.eliminar=function(e){m.solicitud=e,h(e).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.recargarItemsTabla(),m.solicitud=void 0),f.stop()}).catch(function(e){var a=(m.solicitud=void 0)!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";m.mostrarMensaje(a),f.stop()}),m.cerrarConfirmacionEliminacion()},m.ver=function(e){m.solicitud=e,m.solicitud.ver=!0,m.solicitud.sucursal=m.solicitud.almacen.sucursal,m.obtenerAlmacenes(m.solicitud.sucursal.id),m.solicitud.almacen=m.solicitud.almacen,m.abrirDialogPanelOperaciones()},m.calcularTotalViveres=function(o,e){if(m.totalViveresSolicitados={},void 0===o)throw new Error("Hubo un problema con la solicitud, no esta definida!");m.solicitud=o,m.totalViveresSolicitados.usuario=o.usuario,m.totalViveresSolicitados.fecha=o.fecha,m.totalViveresSolicitados.sucursal=o.almacen.sucursal,m.totalViveresSolicitados.almacen=o.almacen,m.totalViveresSolicitados.identificador=o.id,m.totalViveresSolicitados.productos=[];var t=[];m.solicitud.solicitudesProductos.map(function(e){if(!1===e.eliminado||void 0===e.eliminado){if(e.productoSolicitado.activar_inventario){var a={estado:o.activo,almacen:o.almacen,cantidad_ideal:e.cantidad,cantidad_real:e.cantidad,id:e.id,id_detalle_solicitud_producto:e.id,id_producto_base:e.productoSolicitado,productoSolicitudBase:e.productoSolicitado,total:e.cantidad,monto:o.monto,solicitud:o.id};m.totalViveresSolicitados.productos.push(a)}0<e.detallesIngredientesProducto.length&&e.detallesIngredientesProducto.map(function(e){if(void 0===e.eliminado||!1===e.eliminado){var a={estado:o.activo,almacen:o.almacen,cantidad_ideal:e.cantidad_ideal,cantidad_real:e.cantidad_real,id:e.id,id_detalle_solicitud_producto:e.id_detalle_solicitud_producto,id_producto_base:e.id_producto_base,productoSolicitudBase:e.productoSolicitudBase,total:0,monto:o.monto,solicitud:o.id};t.push(a)}})}});var r=[];m.solicitud.solicitudesProductos.map(function(e){for(var i=0;i<t.length;)t.forEach(function(e,a,o){a<i&&t[i].id_producto_base===e.id_producto_base&&r.push(a)}),i+=1}),r.forEach(function(e){delete t[e]}),t.map(function(e){if(void 0!==e){var a={estado:o.activo,almacen:o.almacen,cantidad_ideal:0,cantidad_real:0,id:e.id,id_detalle_solicitud_producto:e.id_detalle_solicitud_producto,id_producto_base:e.id_producto_base,productoSolicitudBase:e.productoSolicitudBase,total:0,monto:o.monto,solicitud:o.id};m.totalViveresSolicitados.productos.push(a)}}),m.solicitadoTotalFinalBs=0;if(m.totalViveresSolicitados.productos.map(function(a){a.totalMostrar=0,m.solicitud.solicitudesProductos.map(function(e){e.detallesIngredientesProducto.map(function(e){a.id_producto_base==e.id_producto_base&&(a.cantidad_ideal+=e.cantidad_ideal,a.cantidad_real+=e.cantidad_real,a.totalMostrar+=e.total,a.total+=e.total,a.totalSumar=e.total,a.totalbs=a.totalSumar*e.productoSolicitudBase.precio_unitario,m.solicitadoTotalFinalBs+=a.totalbs)}),a.id_producto_base==e.id_producto&&(a.cantidad_ideal=1,a.cantidad_real=e.cantidad,a.totalMostrar=e.cantidad,a.totalSumar=e.cantidad,a.total=e.cantidad,a.totalbs=a.totalSumar*e.productoSolicitado.precio_unitario,m.solicitadoTotalFinalBs+=a.totalbs)})}),m.alreadyCalculated=!0,void 0!==e)return m.totalViveresSolicitados;void 0!==o?m.abrirDialogTotalIngredientes():m.solicitud=void 0},m.clasificarGrupo=function(e){m.productosProcesados=a("filter")(m.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},m.verFormulacion=function(e){if(void 0!==m.productoSeleccionado&&e.productoSolicitado.id!=m.productoSeleccionado.productoSolicitado.id){var a=m.solicitud.solicitudesProductos.indexOf(e);m.solicitud.solicitudesProductos[a].verFormulacion=void 0,m.productoSeleccionado.verFormulacion=void 0}void 0===e.verFormulacion?e.verFormulacion=!0:e.verFormulacion=void 0,m.productoSeleccionado=e},m.eliminarDetalleVenta=function(e,a){void 0===e.id?m.solicitud.solicitudesProductos.splice(m.solicitud.solicitudesProductos.indexOf(e),1):(e.eliminado=!0,e.cantidad=0,e.detallesIngredientesProducto.map(function(e){e.eliminado=!0}))},m.eliminarIngrediente=function(e){if(void 0===e.id?m.productoSeleccionado.detallesIngredientesProducto.splice(m.productoSeleccionado.detallesIngredientesProducto.indexOf(e),1):e.eliminado=!0,0==m.productoSeleccionado.detallesIngredientesProducto.length)m.eliminarDetalleVenta(m.productoSeleccionado,!0);else{var a=0;m.productoSeleccionado.detallesIngredientesProducto.map(function(e){a+=!0===e.eliminado?1:0}),a==m.productoSeleccionado.detallesIngredientesProducto.length&&m.eliminarDetalleVenta(m.productoSeleccionado)}},m.disminuirDetalleVenta=function(a){1==a.cantidad?m.eliminarDetalleVenta(a,!0):(a.cantidad=a.cantidad-1,a.detallesIngredientesProducto.map(function(e){e.total=a.cantidad*e.cantidad_ideal}))},m.actualizarTotalReal=function(a){a.detallesIngredientesProducto.map(function(e){e.total=a.cantidad*e.cantidad_ideal})},m.obtenerConfiguracionVentaVista=function(){f.start(),n(m.usuarioSesion.id_empresa).then(function(e){m.configuracionVentaVista=e,f.stop()})},m.guardarConfiguracionVentaVista=function(){ConfiguracionVentaVista.update({id_empresa:m.usuarioSesion.id_empresa},m.configuracionVentaVista,function(e){})},m.enfocar=function(e){A(function(){$("#"+e).focus()},0)},m.interceptarTecla=function(e,a,o){13===e.which&&(o?m.enfocar(a):A(function(){$("#"+a).trigger("click")},0))},m.getFecha=function(){return void 0!==m.solicitud?new Date(m.solicitud.fecha):new Date},m.guardarOperacionPanel=function(e,o){f.start();var i=0;if(e){var a=m.calcularTotalViveres(o,!0);o.listaProductosSolicitados=a,o.solicitudesProductos.map(function(e){var a=0;void 0!==e.detallesIngredientesProducto?e.detallesIngredientesProducto.length<1?void 0!==e.eliminado&&!1!==e.eliminado||(a+=e.productoSolicitado.precio_unitario*e.cantidad):void 0!==e.eliminado&&!1!==e.eliminado||e.detallesIngredientesProducto.map(function(e){void 0!==e.eliminado&&!1!==e.eliminado||(a+=e.total*e.productoSolicitudBase.precio_unitario)}):void 0===e.eliminado&&(a+=e.productoSolicitado.precio_unitario*e.cantida),i+=a}),o.monto=i;var t=new Date,r=o.fecha.split("/").reverse();o.fecha=new Date(r[0],r[1]-1,r[2],t.getHours(),t.getMinutes()),o.id_usuario=m.usuarioSesion.id,o.activo=!0,E(o,m.usuarioSesion.id_empresa,o.modificar).then(function(e){e.hasErr?(m.mostrarMensaje(e.mensaje),o.fecha=new Date(o.fecha).toLocaleDateString()):(m.mostrarMensaje(e.mensaje),m.recargarItemsTabla()),f.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";m.mostrarMensaje(a),o.fecha=new Date(o.fecha).toLocaleDateString(),f.stop()})}else m.mostrarMensaje("Complete los campos requeridos"),f.stop()},m.obtenerInventariosProdSolicitud=function(){m.solicitud.solicitudesProductos.map(function(a){P(a.productoSolicitado.id,m.solicitud.almacen.id).then(function(e){a.inventarios=e})})},m.obtenerInventarioTotal=function(o){var e=0;if(P(o.id,m.solicitud.almacen.id).then(function(e){o.inventarios=e;for(var a=0;a<o.inventarios.length;a++)o.inventarios[a].fecha_vencimiento=o.inventarios[a].fecha_vencimiento?new Date(o.inventarios[a].fecha_vencimiento):null,o.inventarios[a].fechaVencimientoTexto=o.inventarios[a].fecha_vencimiento?o.inventarios[a].fecha_vencimiento.getDate()+"/"+(o.inventarios[a].fecha_vencimiento.getMonth()+1)+"/"+o.inventarios[a].fecha_vencimiento.getFullYear():"",o.inventarios[a].detallesMovimiento[0].movimiento.fecha=new Date(o.inventarios[a].detallesMovimiento[0].movimiento.fecha),o.inventarios[a].detallesMovimiento[0].movimiento.fechaTexto=o.inventarios[a].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(o.inventarios[a].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+o.inventarios[a].detallesMovimiento[0].movimiento.fecha.getFullYear()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";return m.mostrarMensaje(a),0}),o.activar_inventario){for(var a=0;a<o.inventarios.length;a++)e+=o.inventarios[a].cantidad;if(void 0!==m.solicitud.solicitudesProductos&&m.solicitud.copia)for(var i=0;i<m.solicitud.solicitudesProductos.length;i++)m.solicitud.solicitudesProductos[i].productoSolicitado.id==o.id&&(e-=m.solicitud.solicitudesProductos[i].cantidad)}else e=5e5;return e},m.cargarProductos=function(){d(m.usuarioSesion.id_empresa,m.solicitud.almacen.id,m.usuarioSesion.id).then(function(e){if(0<e.length){for(var a=0;a<e.length;a++)e[a].activar_inventario&&(e[a].inventario_disponible=m.obtenerInventarioTotal(e[a]));m.productos=e}else m.productos=[];if(angular.isDefined(s.productosProcesados)){m.productosProcesados=e;for(a=0;a<s.productosProcesados.length;a++)for(var o=0;o<m.productosProcesados.length;o++)s.productosProcesados[a].id==m.productosProcesados[o].id&&(m.productosProcesados[o].rankin=s.productosProcesados[a].rankin)}else m.productosProcesados=e;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},m.agregarDetalleVentaPanel=function(a){m.cantidadInventario=0;var o={productoSolicitado:a,precio_unitario:a.precio_unitario,inventario_disponible:m.cantidadInventario,inventarios:a.inventarios,cantidad:1,detallesIngredientesProducto:[]};if(a.activar_inventario){m.cantidadInventario=a.inventario_disponible;var i=0,e=!1;if(void 0===m.solicitud.solicitudesProductos&&(m.solicitud.solicitudesProductos=[]),1<=m.cantidadInventario){for(;i<m.solicitud.solicitudesProductos.length&&!e;)void 0===m.solicitud.solicitudesProductos[i].eliminado&&m.solicitud.solicitudesProductos[i].productoSolicitado.id==a.id&&(m.solicitud.solicitudesProductos[i].cantidad=m.solicitud.solicitudesProductos[i].cantidad+1,m.solicitud.solicitudesProductos[i].eliminado=void 0,m.solicitud.solicitudesProductos[i].detallesIngredientesProducto.map(function(e){e.total=e.cantidad_ideal*m.solicitud.solicitudesProductos[i].cantidad}),e=!0,o=m.solicitud.solicitudesProductos[i]),i++;if(e)a.eliminado=void 0;else{var t=g(a.id),r=[];t.then(function(e){e.productosBase&&e.productosBase.forEach(function(e){ingrediente={cantidad_ideal:parseFloat(e.formulacion),cantidad_real:parseFloat(e.formulacion),total:parseFloat(e.formulacion),id_producto_base:e.productoBase.id,productoSolicitudBase:e.productoBase},r.push(ingrediente)})}),a.activar_inventario?1<=m.cantidadInventario?(o={productoSolicitado:a,precio_unitario:a.precio_unitario,inventario_disponible:m.cantidadInventario,inventarios:a.inventarios,cantidad:1,detallesIngredientesProducto:r},m.solicitud.solicitudesProductos.push(o)):m.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+m.cantidadInventario+"!"):(o={productoSolicitado:a,precio_unitario:a.precio_unitario,inventario_disponible:m.cantidadInventario,inventarios:a.inventarios,cantidad:1,detallesIngredientesProducto:r},m.solicitud.solicitudesProductos.push(o))}}else m.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+m.cantidadInventario+"!")}else{i=0,e=!1;if(m.solicitud.solicitudesProductos)for(;i<m.solicitud.solicitudesProductos.length&&!e;)void 0===m.solicitud.solicitudesProductos[i].eliminado&&m.solicitud.solicitudesProductos[i].productoSolicitado.id==a.id&&(m.solicitud.solicitudesProductos[i].cantidad=m.solicitud.solicitudesProductos[i].cantidad+1,m.solicitud.solicitudesProductos[i].eliminado=void 0,m.solicitud.solicitudesProductos[i].detallesIngredientesProducto.map(function(e){e.total=e.cantidad_ideal*m.solicitud.solicitudesProductos[i].cantidad}),e=!0,o=m.solicitud.solicitudesProductos[i]),i++;else m.solicitud.solicitudesProductos=[];if(e)a.eliminado=void 0;else{t=g(a.id),r=[];t.then(function(e){e.productosBase&&e.productosBase.forEach(function(e){ingrediente={cantidad_ideal:parseFloat(e.formulacion),cantidad_real:parseFloat(e.formulacion),total:parseFloat(e.formulacion),id_producto_base:e.productoBase?e.productoBase.id:null,productoSolicitudBase:e.productoBase},r.push(ingrediente)}),o={productoSolicitado:a,precio_unitario:a.precio_unitario,inventario_disponible:m.cantidadInventario,inventarios:a.inventarios,cantidad:1,detallesIngredientesProducto:r},m.solicitud.solicitudesProductos.push(o)})}}a.rankin+=1;var n=m.productosProcesados.indexOf(a);m.productosProcesados[n]=a,s.productosProcesados=m.productosProcesados},m.filtrarProductos=function(e){m.productosProcesados=a("filter")(m.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},m.confirmarEntrega=function(e){m.solicitudCerrar=e,m.abrirDialogConfirmacionCierre()},m.cerrarSolicitud=function(a){f.start();var e=m.calcularTotalViveres(a,!0);a.listaProductosSolicitados=e,D(a,m.usuarioSesion.id_empresa).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.mostrarMensaje(e.mensaje),m.solicitudCerrar=void 0,a.activo=!1,m.solicitud=void 0,m.cerrarDialogConfirmacionCierre()),f.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";m.mostrarMensaje(a),f.stop()})},m.editar=function(e){m.solicitud=e,m.solicitud.fechaTexto=m.fechaATexto(m.solicitud.fecha),m.solicitud.modificar=!0,m.abrirDialogPanelOperaciones(),m.solicitud.sucursal=m.solicitud.almacen.sucursal,m.solicitud.almacen=m.solicitud.almacen,m.obtenerAlmacenes(m.solicitud.sucursal.id),m.obtenerInventariosProdSolicitud()},m.generarListaGruposSeleccionados=function(e,a){for(var o=0;o<e.length;o++)for(var i=0;i<a.length;i++)e[o].id==a[i].id&&(e[o].selected=a[i].selected);return e},m.obtenerGruposProductoEmpresa=function(){M(m.usuarioSesion.id_empresa,m.usuario.id).then(function(e){if(m.grupos_productos=e,angular.isDefined(s.grupos_productos))m.grupos_productos=m.generarListaGruposSeleccionados(m.grupos_productos,s.grupos_productos);else for(var a=0;a<e.length;a++)m.grupos_productos[a].selected=!0;m.listChecked=[],m.saveCheckList=function(){m.listChecked.splice(0,m.listChecked.length);for(var e=0;e<m.grupos_productos.length;e++)1==m.grupos_productos[e].selected&&m.listChecked.push(m.grupos_productos[e]);s.grupos_productos=m.grupos_productos},m.saveCheckList(),m.allChecked=!1,m.checkedUnchecked=function(){for(var e=0;e<m.grupos_productos.length;e++)m.grupos_productos[e].selected=m.allChecked;m.saveCheckList()}})},angular.isDefined(s.color)?m.color=s.color:(s.color={style:"red-style",stylebutton:"red-style-button"},m.color={style:"red-style",stylebutton:"red-style-button"}),m.cambiarColor=function(e,a){s.color={style:e,stylebutton:a},$("#dialog-panel-operaciones .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-operaciones .widget-main").addClass(e),$("#dialog-panel-operaciones .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-operaciones .widget-main .button-style").addClass(a)},m.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},m.dragged=!1,m.proformaClick=function(e){m.dragged||m.venderProformaDirecto(e),m.dragged=!1},m.startDragging=function(){m.dragged=!0},m.colorearInventarioDisponible=function(e,a){0==e?(m.porcentaje="100",m.color="red"):e>3*a.inventario_minimo+1?(m.porcentaje="100",m.color="green"):e>2*a.inventario_minimo+1?(m.porcentaje="75",m.color="green"):e>1.5*a.inventario_minimo+1?(m.porcentaje="50",m.color="green"):e==a.inventario_minimo+1?(m.porcentaje="38",m.color="yellow"):e==a.inventario_minimo?(m.porcentaje="25",m.color="red"):e<a.inventario_minimo&&0<e&&(m.porcentaje="12",m.color="red")},m.clasificarColumna=function(e){m.columna==e?"asc"==m.direccion?(m.direccion="desc",$("#"+e+"p").removeClass("fa-caret-up"),$("#"+e+"p").addClass("fa-caret-down")):(m.direccion="asc",$("#"+e+"p").removeClass("fa-caret-down"),$("#"+e+"p").addClass("fa-caret-up")):(m.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+e+"p").addClass("fa-caret-up"),$("#"+e+"p").removeClass("fa-sort")),m.columna=e,m.buscarInventarios(m.almacenBusqueda.id,m.paginaActual,m.itemsPorPagina,m.textoBusqueda,m.columna,m.direccion)},m.sinFuncionalidad=function(){m.mostrarMensaje("Sin funcionalidad")},m.filtrarSolicitudesOperaciones=function(e){for(var a in e)void 0===e[a]&&(e[a]=0);m.obtenerSolicitudes()},m.copiar=function(e){e.id=void 0,e.solicitudesProductos=e.solicitudesProductos.map(function(e){return e.id=void 0,e.id_solicitud=void 0,0<e.detallesIngredientesProducto.length&&(e.detallesIngredientesProducto=e.detallesIngredientesProducto.map(function(e){return e.id=void 0,e.id_detalle_solicitud_producto=void 0,e})),e}),m.solicitud=e,m.solicitud.copia=!0,m.solicitud.sucursal=m.solicitud.almacen.sucursal,m.obtenerAlmacenes(m.solicitud.sucursal.id),m.solicitud.almacen=m.solicitud.almacen,m.obtenerInventariosProdSolicitud(),m.abrirDialogPanelOperaciones()},m.fechaATexto=function(e){return fech=new Date(e),e=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},m.abrirDialogPanelOperaciones=function(){void 0!==m.solicitud?void 0===m.solicitud.id?(m.productoSeleccionado=void 0,m.solicitud.fecha=(new Date).toLocaleDateString()):void 0===m.solicitud.copia?(m.solicitud.fecha=new Date(m.solicitud.fecha).toLocaleDateString(),m.solicitud.modificar||(m.solicitud.nueva=!0)):(m.solicitud.id=void 0,m.solicitud.fecha=(new Date).toLocaleDateString(),m.solicitud.activo=!0):(m.solicitud={},m.solicitud.fecha=(new Date).toLocaleDateString(),m.solicitud.activo=!0),m.obtenerGruposProductoEmpresa(),m.abrirPopup(m.idDialogDialogPanelOperaciones)},m.cerrarPopupPanel=function(){void 0!==m.solicitud&&(m.solicitud.copia=void 0,m.solicitud=void 0),m.productoSeleccionado=void 0,m.recargarItemsTabla(),m.productosProcesados=[],m.cerrarPopup(m.idDialogDialogPanelOperaciones)},m.abriridDialogoListadoPedido=function(){m.abrirPopup(m.idDialogoListadoPedido)},m.cerraridDialogoListadoPedido=function(){m.detallesPedido=[],m.pedido={},m.detallePedido={},m.solicitudesPedido=[],m.cerrarPopup(m.idDialogoListadoPedido)},m.verificarPulso=function(e,a){13===e.keyCode&&m.buscarProductos(1)},m.verificarPulsoAsignados=function(e,a){13===e.keyCode&&m.buscarProductosAsignados(1)},m.abrirDialogDatos=function(){m.abrirPopup(m.idDialogDatos)},m.cerrarDialogDatos=function(){m.cerrarPopup(m.idDialogDatos)},m.abrirDialogEntregaViveres=function(){m.abrirPopup(m.idDialogEntregaViveres)},m.cerrarDialogEntregaViveres=function(){m.cerrarPopup(m.idDialogEntregaViveres)},m.abrirDialogConfirmacionCierre=function(){m.abrirPopup(m.idConfirmacionCierre)},m.cerrarDialogConfirmacionCierre=function(){m.cerrarPopup(m.idConfirmacionCierre)},m.abrirDialogTotalIngredientes=function(){m.abrirPopup(m.idDialogTotalIngredientes)},m.cerrarDialogTotalIngredientes=function(){m.alreadyCalculated=!1,m.cerrarPopup(m.idDialogTotalIngredientes)},m.generarPdfSolicitud=function(e){f.start(),m.calcularTotalViveres(e,!0);var a=new PDFDocument({size:[612,792],margin:10,compress:!1}),o=a.pipe(blobStream());(t=(i=new Date).getMinutes())<10&&(t="0"+t),a.font("Helvetica",8);var i,t,r=115,n=0,s=1,c=Math.ceil(m.totalViveresSolicitados.productos.length/29);m.dibujarCabeceraPDFSolicitud(a,s,c);for(var l=0;l<m.totalViveresSolicitados.productos.length&&n<=29;l++)a.font("Helvetica",8),a.text(l+1,65,r),a.text(m.totalViveresSolicitados.productos[l].productoSolicitudBase.codigo,100,r),a.text(m.totalViveresSolicitados.productos[l].productoSolicitudBase.nombre,220,r),a.text(m.totalViveresSolicitados.productos[l].productoSolicitudBase.unidad_medida,400,r),a.text(m.totalViveresSolicitados.productos[l].total.toFixed(2),500,r),r+=20,29<++n&&(a.rect(40,105,540,r-115).stroke(),a.text(s+"/"+c,570,r+15),a.font("Helvetica",6),a.text("RESPONSABLE: "+m.usuarioSesion.nombre_usuario,45,r+10),a.text("SOLICITANTE: "+m.totalViveresSolicitados.usuario.persona.nombre_completo,345,r+10),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,r+10),a.addPage({size:[612,792],margin:10}),r=115,n=0,s+=1,m.dibujarCabeceraPDFSolicitud(a,s,c));a.rect(40,105,540,r-115).stroke(),(t=(i=new Date).getMinutes())<10&&(t="0"+t),a.text(s+"/"+c,570,r+15),a.font("Helvetica",6),a.text("RESPONSABLE: "+m.usuarioSesion.nombre_usuario,45,r+5),a.text("SOLICITANTE: "+m.totalViveresSolicitados.usuario.persona.nombre_completo,345,r+5),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,r+5),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()},m.dibujarCabeceraPDFSolicitud=function(e,a,o){e.font("Helvetica-Bold",12),e.text("CONSUMOS",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("SUCURSAL : ",-40,50,{align:"center"}),e.font("Helvetica",8),e.text(m.totalViveresSolicitados.sucursal.nombre,60,50,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FECHA : ",40,60,{width:40}),e.font("Helvetica",8),e.text(m.fechaATexto(m.totalViveresSolicitados.fecha),75,60,{width:40}),e.font("Helvetica-Bold",14),e.text("N°",380,40,{align:"center"}),e.text(m.totalViveresSolicitados.identificador,440,40,{align:"center"}),e.rect(40,80,540,25).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",65,90),e.text("Código Ítem",100,90),e.text("Producto",220,90),e.text("Unidad medida",380,90),e.text("Cantidad solicitada",480,90)},m.calcularViveresDesdeFiltro=function(i){var t=[];m.totalViveresSolicitados={},m.solicitudesPedido=[],m.solicitudesOperaciones.forEach(function(e,a){if(e.activo||void 0!==i){if(i&&!e.id_pedido){m.solicitudesPedido.push(e.id);o=m.calcularTotalViveres(e,!0);t.push(o)}}else{var o=m.calcularTotalViveres(e,!0);t.push(o)}});var r=[];if(t.forEach(function(o){o.productos.forEach(function(e){var a={almacen:e.almacen,sucursal:e.almacen.sucursal,cantidad:e.cantidad_real,fecha:o.fecha,hora_fecha:o.fecha,usuario:o.usuario,estado:e.estado,producto:e.productoSolicitudBase,costo:e.productoSolicitudBase.inventarios&&e.productoSolicitudBase.inventarios.length?e.productoSolicitudBase.inventarios[0].costo_unitario:0,grupo:e.productoSolicitudBase.grupo,subgrupo:e.productoSolicitudBase.subgrupo,total:(e.productoSolicitudBase.inventarios&&e.productoSolicitudBase.inventarios.length?e.productoSolicitudBase.inventarios[0].costo_unitario:0)*e.cantidad_real,monto:e.monto,solicitud:e.solicitud};r.push(a)})}),i){for(var e=[];0<r.length;){var o=r.pop();if(0===e.length)e.push(o);else{var n,s=!1;e.forEach(function(e,a){e.producto.id!=o.producto.id||s||(s=!0,n=a)}),s&&void 0!==n?(e[n].cantidad+=o.cantidad,e[n].total=e[n].cantidad*e[n].costo):e.push(o)}}return e}return r},m.reporteExcel=function(e){if(f.start(),m.imprimir.detalle){(t=[]).push(["Nro.","Sucursal","Almacén","Hora-fecha","Usuario","Estado","Detalle","Unidad","Grupo","Subgrupo","Cantidad","Costo","Total"]);for(var a=m.calcularViveresDesdeFiltro(),o=[],i=0;i<a.length;i++)(o=[]).push(i+1),o.push(a[i].almacen.sucursal.nombre),o.push(a[i].almacen.nombre),o.push(new Date(a[i].fecha).toLocaleTimeString()+" "+new Date(a[i].fecha).toLocaleDateString()),o.push(a[i].usuario.nombre_usuario),o.push(a[i].estado?"Abierto":"Cerrado"),o.push(a[i].producto.nombre),o.push(a[i].producto.unidad_medida),o.push(a[i].grupo.nombre),o.push(a[i].subgrupo.nombre),o.push(a[i].cantidad),o.push(a[i].costo),o.push(a[i].total.toFixed(2)),t.push(o);f.stop()}else{var t;(t=[]).push(["Nro.","Sucursal","Hora-fecha","Monto","Usuario","Estado"]);for(o=[],i=0;i<m.solicitudesOperaciones.length;i++)(o=[]).push(i+1),o.push(m.solicitudesOperaciones[i].almacen.sucursal.nombre),o.push(new Date(m.solicitudesOperaciones[i].fecha).toLocaleTimeString()+" "+new Date(m.solicitudesOperaciones[i].fecha).toLocaleDateString()),o.push(m.solicitudesOperaciones[i].monto),o.push(m.solicitudesOperaciones[i].usuario.nombre_usuario),o.push(m.solicitudesOperaciones[i].activo?"Abierto":"Cerrado"),t.push(o);f.stop()}if(e)m.reportePdf(t),f.stop();else{var r="SheetJS",n=new Workbook,s=sheet_from_array_of_arrays(t);s["!cols"]=[{wch:5},{wch:18},{wch:18},{wch:12},{wch:15},{wch:15},{wch:12},{wch:25},{wch:12},{wch:12},{wch:12}],s["!rows"]=[{hpx:28,level:3}],n.SheetNames.push(r),n.Sheets[r]=s;var c=XLSX.write(n,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"REPORTE OPERACIONES.xlsx"),f.stop()}},m.reportePdf=function(e){var a=new PDFDocument({size:"letter",margin:10,compress:!1}),o=a.pipe(blobStream());(t=(i=new Date).getMinutes())<10&&(t="0"+t),m.posXforPdf=[],a.font("Helvetica",8);var i,t,r=65,n=115,s=0,c=1,l=Math.ceil(e.length/29);if(m.dibujarCabeceraReportePdf(a,e),m.imprimir.detalle){r=50;for(var d=0;d<e.length&&s<=29;d++){var u=r;if(a.font("Helvetica",8),0<d){for(var p=0;p<e[d].length;p++)a.text(e[d][p],u,n,{width:40},{align:"center"}),u=m.posXforPdf[p];n+=20,s++}29<s&&(a.rect(40,105,540,n-115).stroke(),a.text(c+"/"+l,570,n+15),a.font("Helvetica",6),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,n+10),a.addPage({size:[612,792],margin:10}),n=115,s=0,c+=1,m.dibujarCabeceraPDFSolicitud(a,c,l))}}else for(d=0;d<e.length&&s<=29;d++){u=r;if(a.font("Helvetica",8),0<d){for(p=0;p<e[d].length;p++)a.text(e[d][p],u,n,{width:40}),u+=0==p?30:60;n+=20,s++}29<s&&(a.rect(40,105,540,n-115).stroke(),a.text(c+"/"+l,570,n+15),a.font("Helvetica",6),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,n+10),a.addPage({size:[612,792],margin:10}),n=115,s=0,c+=1,m.dibujarCabeceraPDFSolicitud(a,c,l))}a.rect(40,105,540,650).stroke(),(t=(i=new Date).getMinutes())<10&&(t="0"+t),a.text(c+"/"+l,570,765),a.font("Helvetica",6),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,765),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()},m.dibujarCabeceraReportePdf=function(e,a){if(e.font("Helvetica-Bold",12),e.text("REPORTE OPERACIONES",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FECHA : ",40,60,{width:40}),e.font("Helvetica",8),e.text((new Date).toLocaleDateString(),75,60,{width:40}),e.rect(40,80,540,25).stroke(),e.font("Helvetica-Bold",8),m.imprimir.detalle){px=50;for(var o=0;o<a[0].length;o++)e.text(a[0][o],px,90),0==o?px+=4*a[0][o].length+5:(m.imprimir.detalle,px+=4*a[0][o].length+15),m.posXforPdf.push(px)}else{px=65;for(o=0;o<a[0].length;o++)e.text(a[0][o],px,90),0==o?(px+=20,m.posXforPdf.push(px)):m.imprimir.detalle?px+=40:px+=60}e.font("Helvetica",8)},m.obtenerProductos=function(){m.paginatorProductos=b(),m.paginatorProductos.column="nombre",m.paginatorProductos.filter=m.grupo,m.paginatorProductos.callBack=m.buscarProductos,m.paginatorProductos.getSearch("",null,null)},m.modificarListaProductosProveedor=function(e){var a=m.listaProductosProveedor.indexOf(e.id);0<=a&&!e.seleccionado?m.listaProductosProveedor.splice(a,1):-1==a&&e.seleccionado&&m.listaProductosProveedor.push(e.id)},m.seleccionarTodosParaAsignar=function(){m.seleccionProductosProveedor.seleccionar_todos?m.productosAsignacionProveedor.forEach(function(e){e.seleccionado=!0,m.modificarListaProductosProveedor(e)}):m.productosAsignacionProveedor.forEach(function(e){e.seleccionado=!1,m.modificarListaProductosProveedor(e)})},m.actualizarProductosProveedor=function(){O(m.usuarioSesion.id_empresa,m.listaProductosProveedor,m.pedido.proveedor).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.mostrarMensaje(e.mensaje),m.cerrarModalProductosProveedor())}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})},m.buscarProductos=function(e){f.start(),e&&(m.paginatorProductos.currentPage=e),m.paginatorProductos.filter=m.configuracionPorveedor.grupo?m.configuracionPorveedor.grupo:{id:0},m.paginatorProductos.search=m.configuracionPorveedor.textoBusqueda?m.configuracionPorveedor.textoBusqueda:0,I(m.usuarioSesion.id_empresa,m.paginatorProductos,m.usuarioSesion.id).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.paginatorProductos.setPages(e.paginas),m.productosAsignacionProveedor=e.productos,m.pedido&&m.pedido.proveedor&&R(m.usuarioSesion.id_empresa,m.pedido.proveedor).then(function(e){if(e.hasErr)m.mostrarMensaje(e.mensaje),m.listaProductosProveedor=[];else if(e.productos){var a=e.productos.split(",");m.listaProductosProveedor=a.map(function(e){return parseInt(e)}),m.verificarAsignacionProductosProveedor()}else m.listaProductosProveedor=[];f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)}));f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})},m.obtenerProductosAsignados=function(){m.paginatorProductosAsignados=b(),m.paginatorProductosAsignados.column="nombre",m.paginatorProductosAsignados.filter=m.grupo,m.paginatorProductosAsignados.callBack=m.buscarProductosAsignados,m.paginatorProductosAsignados.getSearch("",null,null)},m.buscarProductosAsignados=function(e,a){(f.start(),e&&(m.paginatorProductosAsignados.currentPage=e),void 0===m.pedido)?(m.pedido={},f.stop()):m.pedido.proveedor?(m.paginatorProductosAsignados.filter=m.productosAsignadosPorveedor.grupo?m.productosAsignadosPorveedor.grupo:{id:0},m.paginatorProductosAsignados.search=m.productosAsignadosPorveedor.textoBusqueda?m.productosAsignadosPorveedor.textoBusqueda:0,R(m.usuarioSesion.id_empresa,m.pedido.proveedor).then(function(e){if(e.hasErr)m.mostrarMensaje(e.mensaje),m.listaProductosProveedor=[];else if(e.productos){var a=e.productos.split(",");m.listaProductosProveedor=a.map(function(e){return parseInt(e)}),j(m.usuarioSesion.id_empresa,m.paginatorProductosAsignados,m.usuarioSesion.id,m.listaProductosProveedor).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.paginatorProductosAsignados.setPages(e.paginas),m.productosAsignadosProveedor=e.productos,m.listaProductosProveedorSeleccionados=[],m.verificarSeleccionProductosProveedor()),f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})}else m.listaProductosProveedor=[];f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})):m.mostrarMensaje("El proveedor no tiene productos asignados.")},m.verificarSeleccionProductosProveedor=function(){0<m.listaProductosProveedorSeleccionados.length&&m.listaProductosProveedorSeleccionados.forEach(function(a){m.productosProveedorSeleccionados.forEach(function(e){e.id===a&&(e.seleccionado=!0)})})},m.filtrarProductosSeleccionadosPorGrupo=function(){if(0<m.detallesPedido.length){var a=[];m.detallesPedido.forEach(function(e){e.id_subgrupo===m.pedido.grupo&&a.push(e)}),0<a.length?m.detallesPedido=a.map(function(e){return e}):m.mostrarMensaje("No existen productos pertenecientes al grupo seleccionado. No se realizaron cambios.")}},m.abrirmodalBusquedaProveedor=function(){m.filtrarProveedores(""),m.abrirPopup(m.idDialogBusquedaProveedor)},m.cerrarModalBusquedaProveedor=function(){m.cerrarPopup(m.idDialogBusquedaProveedor)},m.abrirmodalProductosAsignadosProveedor=function(){void 0===m.pedido&&(m.pedido={por_proveedor:!1}),m.pedido.proveedor?(m.generarPorProveedor(),m.buscarProductosAsignados(),m.abrirPopup(m.idDialogProductosAsigandosProveedor)):m.mostrarMensaje("Seleccione un proveedor.")},m.cerrarModalProductosAsignadosProveedor=function(){m.cerrarPopup(m.idDialogProductosAsigandosProveedor)},m.cerrarModalProductosProveedor=function(){m.productosAsignacionProveedor=[],m.listaProductosProveedor=[],m.cerrarPopup(m.idDialogProductosProveedor)},m.abrirModalNuevoPedido=function(){m.abrirPopup(m.idDialogoNuevoPedido)},m.cerrarModalNuevoPedido=function(){m.detallesPedido=[],m.pedido={},m.detallePedido={},m.solicitudesPedido=[],m.cerrarPopup(m.idDialogoNuevoPedido)},m.eliminarDetallePedido=function(e){e.id?e.eliminar=!0:m.detallesPedido.splice(m.detallesPedido.indexOf(e),1)},m.guardarPedido=function(e,a){if(f.start(),void 0!==e&&0<m.detallesPedido.length){a&&(e.solicitudesIds=m.solicitudesPedido.map(function(e){return e}));var o=new Date,i=e.fecha.split("/").reverse(),t={fecha:new Date(i[0],i[1]-1,i[2],o.getHours(),o.getMinutes()),sucursal:e.sucursal,almacen:e.almacen,proveedor:e.proveedor.id,observacion:e.observacion,grupo:void 0!==e.grupo&&null!==e.grupo?e.grupo:0,detallesPedido:m.detallesPedido,usuario:m.usuarioSesion.id,solicitudesIds:e.generado?m.solicitudesPedido:[]};T(m.usuario.id_empresa,t,m.usuarioSesion.id).then(function(e){f.stop(),e.hasErr?m.mostrarMensaje(e.mensaje):(m.mostrarMensaje(e.mensaje),m.recargarItemsTabla())}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";m.mostrarMensaje(a)})}else 0<m.detallesPedido.length?m.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar!"):m.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar sin lista de productos!"),f.stop()},m.inicio()}]),angular.module("agil.controladores").controller("ControladorPacientes",["$scope","$sce","blockUI","$localStorage","$window","$location","$templateCache","$route","Usuario","Paginator","DatosPacientes","Paciente","$filter","PacientesPaginador","ListaDatosPrerequisito","CrearPrerequisito","Prerequisito","DatosPrerequisitoPaciente","ListaDatosGenero","Vacunas","ltsVacunas","PacienteVacuna","VacunasPaciente","asignacionPacienteVacuna","aplicacionPacienteVacuna","VacunasPacientedosis","CrearMedicoPacienteConsulta","ListaConsultasMedicoPaciente","CrearMedicoPacienteFicha","BuscarFichaPaciente","ListaDatosTiposControl","ActualizarPatologiaPaciente","ListaPrerequisitosEmpresa","ListaPrerequisitosPaciente","ActualizarPrerequisito","CrearLaboratorio","ListaLaboratorios","CrearLaboratorioExamen","ListaLaboratorioExamenes","CrearLaboratorioExamenResultado","LaboratorioExamenListaHistorial","CrearDiagnostico","ListaDiagnosticos","CrearDiagnosticoExamen","ListaDiagnosticoExamenes","DiagnosticoExamenListaHistorial","CrearDiagnosticoExamenResultado","PacientesEmpresa","ListaVacunasEmpresa","FichasTecnicasPacientes","SignosVitalesPacientes","SOAPlistaPacientes","aplicacionVacunasPacientes","obtenerPaciente","Comentario","FieldViewer","PacienteActivo","HistorialFichaMedicoPaciente","ActualizarLaboratorio","ActualizarLaboratorioExamen","ActualizarDiagnostico","ActualizarDiagnosticoExamen","Tipos","EliminarLaboratorio","EliminarLaboratorioExamen","EliminarDiagnosticoExamen","EliminarDiagnostico","Prerequisitos","PrerequisitoPaciente","ListaAlertasPrerequisitosPaciente","PrerequisitosHistorial","ListaAlertasVacunasEmpresa","Vacuna","ClasesTipo","ValidarCodigoCuentaEmpleado","$timeout","ClasesTipoEmpresa","PrerequisitosSave",function(f,e,n,a,o,i,t,r,s,c,l,d,u,p,m,g,v,h,b,C,P,_,M,D,E,x,S,A,T,w,I,R,j,O,F,V,N,H,B,z,L,k,U,y,G,q,Y,W,J,X,K,Z,Q,ee,ae,oe,ie,te,re,ne,se,ce,le,de,ue,pe,me,fe,ge,ve,he,be,Ce,Pe,_e,Me,De,Ee){f.usuario=JSON.parse(a.usuario),f.idModalDialogVacunas="dialog-vacunas",f.idModalDialogConsulta="modal-wizard-consulta",f.idModalwizardContainerConsulta="modal-wizard-container-consulta",f.idModalDialogVacunasConfig="dialog-vacunas-config",f.idModalDialogVacunaEdicion="dialog-vacuna-nueva",f.idModalDialogFechaEntrega="dialog-fecha-entrega",f.IdModalDialogPreRequisitos="modal-preRequisitos",f.IdModalDialogLaboratorio="dialog-laboratorio",f.IdModalDialogGraficoSV="dialog-grafico",f.idModalDialogHistorico="dialog-previewHistorico",f.idModalFichaTecnica="modal-fichaMedica",f.idModalwizardContainerFichaTecnica="modal-wizard-container-ficha",f.IdModalDialogLaboratorioExamen="dialog-nuevo-examen",f.IdModalDialogLaboratorioExamenes="dialog-examenes",f.IdModalDialogLaboratorioExamenesNuevoResultado="dialog-nuevo-resultado",f.IdModalDialogLaboratorioExamenHistoricoPreview="dialog-previewHistorico",f.IdModalDialogLaboratorioExamenHistoricoResultado="dialog-historico-resultado",f.IdEntregaPrerequisito="dialog-entrega-preRequisito",f.idModalDialogPacienteNuevo="dialog-paciente-nuevo",f.idModalDialogPrerequisitoNuevo="dialog-pre-requisito-nuevo",f.idModalwizardContainerPaciente="modal-wizard-paciente-container",f.idModalHistorialPrerequisito="dialog-historico-preRequisito",f.idModalEditarPrerequisito="dialog-editar-preRequisito",f.idModalDialogHistorialVacuna="dialog-historial-vacuna",f.idModalDialogHistorialVacunaGeneral="dialog-historial-vacuna-general",f.idModalDialogDiagnosticos="dialog-diagnosticos",f.idModalDialogDiagnosticoNuevo="dialog-diagnostico-nuevo",f.idModalDialogExamenesDiagnostico="dialog-examenesDiagnostico",f.idModalDialogNuevoExamenDiagnostico="dialog-examenDiagnostico-nuevo",f.idModalDialogHistorialFicha="dialog-historico-ficha",f.idModalDialogCredencial="dialog-credencial",f.idModalDialogPatologias="dialog-patologias",f.idModalDialogComentario="dialog-editar-comentario",f.idModalAlertPrerequisitos="dialog-alertPre-requisitos",f.idModalDiasActivacionPrerequisitos="dialog-diasActivacion-Prerequisitos",f.idModalReprogramarPrerequisitos="dialog-reprogramar-prerequisito",f.idModalAlertVacunas="dialog-alertVacunas",f.idModalDiasActivacionVacunas="dialog-diasActivacion-Vacunas",f.idModalReprogramarVacunas="dialog-reprogramar-vacunas",f.idImagenUsuario="imagen-persona",f.idModalHistorialConsulta="dialog-historial-consulta",f.idModalWizardPacienteVista="dialog-paciente-vista",f.idModalContenedorPacienteVista="modal-wizard-container-paciente-vista",f.idModalEliminarPaciente="dialog-eliminar-paciente",f.IdModalDialogNuevoLaboratorio="dialog-nuevo-laboratorio",f.IdModalDialogDiagnosticoExamenHistoricoResultado="dialog-historico-resultado-diag",f.idModalDialogVerResultadosHistorialLab="dialog-ver-resultados-Examen",f.idModalDialogConfirmacionEntregaAdelantado="dialog-entrega-adelantada-prerequisito",f.idModalConceptoEdicion="dialog-conceptos",f.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),ejecutarScriptsPacientes(f.idModalDialogVacunas,f.idModalDialogConsulta,f.idModalwizardContainerConsulta,f.idModalDialogVacunasConfig,f.idModalDialogVacunaEdicion,f.idModalDialogFechaEntrega,f.IdModalDialogPreRequisitos,f.IdModalDialogLaboratorio,f.IdModalDialogGraficoSV,f.idModalDialogHistorico,f.idModalFichaTecnica,f.idModalwizardContainerFichaTecnica,f.IdModalDialogLaboratorioExamen,f.IdModalDialogLaboratorioExamenes,f.IdModalDialogLaboratorioExamenesNuevoResultado,f.IdModalDialogLaboratorioExamenHistoricoPreview,f.IdModalDialogLaboratorioExamenHistoricoResultado,f.IdEntregaPrerequisito,f.idModalDialogPacienteNuevo,f.idModalDialogPrerequisitoNuevo,f.idModalwizardContainerPaciente,f.idModalHistorialPrerequisito,f.idModalEditarPrerequisito,f.idModalDialogHistorialVacuna,f.idModalDialogHistorialVacunaGeneral,f.idModalDialogDiagnosticos,f.idModalDialogDiagnosticoNuevo,f.idModalDialogExamenesDiagnostico,f.idModalDialogNuevoExamenDiagnostico,f.idModalDialogHistorialFicha,f.idModalDialogCredencial,f.idModalDialogPatologias,f.idModalDialogComentario,f.idModalAlertPrerequisitos,f.idModalDiasActivacionPrerequisitos,f.idModalReprogramarPrerequisitos,f.idModalAlertVacunas,f.idModalDiasActivacionVacunas,f.idModalReprogramarVacunas,f.idImagenUsuario,f.idModalHistorialConsulta,f.idModalWizardPacienteVista,f.idModalContenedorPacienteVista,f.idModalEliminarPaciente,f.IdModalDialogNuevoLaboratorio,f.IdModalDialogDiagnosticoExamenHistoricoResultado,f.idModalDialogVerResultadosHistorialLab,f.idModalDialogConfirmacionEntregaAdelantado,f.idModalConceptoEdicion),f.buscarAplicacion(f.usuario.aplicacionesUsuario,i.path().substring(1)),f.obtenerColumnasAplicacion()}),f.$on("$routeChangeStart",function(e,a){f.eliminarPopup(f.idModalEliminarPaciente),f.eliminarPopup(f.idModalDialogVacunas),f.eliminarPopup(f.idModalDialogConsulta),f.eliminarPopup(f.idModalDialogVacunasConfig),f.eliminarPopup(f.idModalDialogVacunaEdicion),f.eliminarPopup(f.idModalDialogFechaEntrega),f.eliminarPopup(f.IdModalDialogPreRequisitos),f.eliminarPopup(f.IdModalDialogLaboratorio),f.eliminarPopup(f.IdModalDialogGraficoSV),f.eliminarPopup(f.idModalDialogHistorico),f.eliminarPopup(f.idModalFichaTecnica),f.eliminarPopup(f.IdModalDialogLaboratorioExamen),f.eliminarPopup(f.IdModalDialogLaboratorioExamenes),f.eliminarPopup(f.IdModalDialogLaboratorioExamenesNuevoResultado),f.eliminarPopup(f.IdModalDialogLaboratorioExamenHistoricoResultado),f.eliminarPopup(f.IdEntregaPrerequisito),f.eliminarPopup(f.idModalDialogPacienteNuevo),f.eliminarPopup(f.idModalDialogPrerequisitoNuevo),f.eliminarPopup(f.idModalHistorialPrerequisito),f.eliminarPopup(f.idModalEditarPrerequisito),f.eliminarPopup(f.idModalDialogHistorialVacuna),f.eliminarPopup(f.idModalDialogHistorialVacunaGeneral),f.eliminarPopup(f.idModalDialogDiagnosticos),f.eliminarPopup(f.idModalDialogDiagnosticoNuevo),f.eliminarPopup(f.idModalDialogExamenesDiagnostico),f.eliminarPopup(f.idModalDialogNuevoExamenDiagnostico),f.eliminarPopup(f.idModalDialogHistorialFicha),f.eliminarPopup(f.idModalDialogCredencial),f.eliminarPopup(f.idModalDialogPatologias),f.eliminarPopup(f.idModalDialogComentario),f.eliminarPopup(f.idModalAlertPrerequisitos),f.eliminarPopup(f.idModalDiasActivacionPrerequisitos),f.eliminarPopup(f.idModalReprogramarPrerequisitos),f.eliminarPopup(f.idModalAlertVacunas),f.eliminarPopup(f.idModalDiasActivacionVacunas),f.eliminarPopup(f.idModalHistorialConsulta),f.eliminarPopup(f.idModalWizardPacienteVista),f.eliminarPopup(f.IdModalDialogNuevoLaboratorio),f.eliminarPopup(f.IdModalDialogDiagnosticoExamenHistoricoResultado),f.eliminarPopup(f.idModalDialogVerResultadosHistorialLab),f.eliminarPopup(f.idModalReprogramarVacunas),f.eliminarPopup(f.idModalDialogConfirmacionEntregaAdelantado),f.eliminarPopup(f.idModalConceptoEdicion)}),f.inicio=function(){f.obtenerAlertas(),n.start(),f.paginator={pages:[]},f.obtenerPacientes(),f.obtenerVacunas(),f.paciente={vacunas:[],cargos:[]},f.vacunas=[],f.vacuna={vacunaDosis:[]},f.vacunaDosis=[],f.requisitos={preRequisitos:[]},f.ficha={},f.dosis={tiempo:0,numero:0},f.obtenerExpeditos(),f.obtenerGenero(),f.obtenerTipoControl(),f.obtenerCargos(),f.examen={},f.filtroHistorialVacunas=[],f.filtroVacunas={inicio:"",fin:"",opcion:"todas"};var e=new Date;f.filtro.fechaAplicacionVacuna_texto=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear(),n.stop(),f.dosisEdit=!1,f.fechaResultado=f.fechaATexto(new Date)},f.abrirDialogConceptoEdicion=function(e){f.tipo_edicion=e,f.clase={},f.abrirPopup(f.idModalConceptoEdicion)},f.cerrarDialogConceptoEdicion=function(){f.cerrarPopup(f.idModalConceptoEdicion)},f.agregarConceptoEdicion=function(e){e.nombre&&e.nombre_corto&&(-1==f.tipo_edicion.clases.indexOf(e)&&f.tipo_edicion.clases.push(e),f.clase={})},f.modificarConceptoEdicion=function(e){f.clase=e},f.removerConceptoEdicion=function(e){e.eliminado=!0},f.guardarConceptoEdicion=function(a){n.start(),le.update({id_tipo:a.id},a,function(e){Pe(a.nombre_corto).then(function(e){a=e,n.stop(),f.cerrarDialogConceptoEdicion(),f.mostrarMensaje("Guardado Exitosamente!")})})},f.obtenerExpeditos=function(){n.start(),De("RRHH_EXP",f.usuario.id_empresa).then(function(e){f.expeditos=e,n.stop()})},f.obtenerCargos=function(){n.start(),De("RRHH_CARGO",f.usuario.id_empresa).then(function(e){var a=e.clases;f.listaCargos=e,f.llenarCargos(a),n.stop()})},f.seleccionarCargos=function(e){if(0<e.length)for(var a=0;a<f.cargos.length;a++)for(var o=0;o<e.length;o++)f.cargos[a].id==e[o].id_cargo&&(f.cargos[a].ticked=!0)},f.llenarCargos=function(e){f.nuevoRH="",f.cargos=[];for(var a=0;a<e.length;a++){var o={nombre:e[a].nombre,maker:"",ticked:!1,id:e[a].id};f.cargos.push(o)}},f.imcCal=function(e){if(null!=e.talla&&null!=e.peso){if(0<e.talla&&0<e.peso){var a=e.talla/100*(e.talla/100);e.indice_masa=e.peso/a,e.indice_masa=e.indice_masa.toFixed(2)}f.ClasificacionIMC="",f.ColorIMC="",e.indice_masa<16&&(f.ClasificacionIMC="Infrapeso: Delgadez Severa"),16<=e.indice_masa&&e.indice_masa<17&&(f.ClasificacionIMC="Infrapeso: Delgadez moderada"),17<=e.indice_masa&&e.indice_masa<18.49&&(f.ClasificacionIMC="Infrapeso: Delgadez aceptable"),18.5<=e.indice_masa&&e.indice_masa<25&&(f.ClasificacionIMC="Peso Normal"),25<=e.indice_masa&&e.indice_masa<30&&(f.ClasificacionIMC="Sobrepeso"),30<=e.indice_masa&&e.indice_masa<35&&(f.ClasificacionIMC="Obeso: Tipo I"),35<=e.indice_masa&&e.indice_masa<40&&(f.ClasificacionIMC="Obeso: Tipo II"),40<=e.indice_masa&&(f.ClasificacionIMC="Obeso: Tipo III")}},f.obtenerColumnasAplicacion=function(){f.fieldViewer=oe({crear:!0,id_empresa:f.usuario.id_empresa,configuracion:{codigo:{value:"Codigo",show:!0},nombre:{value:"Nombre",show:!0},empresa:{value:"Empresa",show:!0},imagen:{value:"Imagen",show:!0},ci:{value:"CI",show:!0},extension:{value:"Extension",show:!0},grupo_sanguineo:{value:"Grupo Sang.",show:!0},campo:{value:"Campo",show:!0},cargo:{value:"Cargo",show:!0}}},f.aplicacion.aplicacion.id),f.fieldViewer.updateObject()},f.fechaATexto=function(e){return fech=new Date(e),e=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},f.agregarDosisVacuna=function(e){n.start(),null!=e.id||null!=e.id?(indx=f.vacunaDosis.indexOf(e),e.es_dosis=null!=e.es_dosis&&null!=e.es_dosis&&e.es_dosis,e.unico=null!==e.unico&&void 0!==e.unico&&e.unico,e.numero=indx,f.vacunaDosis[indx]=e):(e.es_dosis=null!=e.es_dosis&&null!=e.es_dosis&&e.es_dosis,e.unico=null!==e.unico&&void 0!==e.unico&&e.unico,e.numero=f.vacunaDosis.length+1,f.vacunaDosis.push(e),console.log("añadiendo dosis"),console.log(e)),1<f.vacunaDosis.length&&(e.unico=!1),f.dosis={},n.stop()},f.agregarDosisEditada=function(e){1<f.vacunaDosis.length&&(e.unico=!1),f.vacunaDosis[e.index]=e,f.dosis={},f.dosisEdit=!1},f.eliminarDosis=function(e){if(void 0===e.id)f.vacunaDosis.splice(f.vacunaDosis.indexOf(e),1);else{var a=f.vacunaDosis.indexOf(e);f.vacunaDosis[a].eliminado=!0,f.vacunaDosis[a].eliminar=!0}},f.editarLaDosis=function(e){f.dosis=e,f.dosisEdit=!0},f.asignarVacunas=function(){f.paciente.eliminado?(n.start(),f.vacunas.forEach(function(a){a.asignada=null!==a.asignada&&void 0!==a.asignada&&a.asignada;var o=!1,i={};if(f.paciente.vacunas.forEach(function(e){e.id_vacuna==a.id&&(o=!0,i=e)},this),o)D.update({id:i.id,asignar:a.asignada},i,function(e){M(f.paciente).then(function(e){f.paciente.vacunas=e})},function(e){f.mostrarMensaje("Ocurrio un problema al momento de actualizar la asignación de la vacuna!")});else if(a.asignada){var e=new Date;1<a.vacunaDosis.length&&(a.vacunaDosis[1].es_dosis?e.setTime(e.getTime()+864e5*a.vacunaDosis[1].tiempo):e.setTime(e.getTime()+30*a.vacunaDosis[1].tiempo*864e5)),new D({id_paciente:f.paciente.id,id_vacuna:a.id,siguiente_aplicacion:e}).$save(function(e){M(f.paciente).then(function(e){f.paciente.vacunas=e})},function(e){f.mostrarMensaje("Ocurrio un problema al momento de asignar la vacuna!")})}},this)):f.mostrarMensaje("No se puede asignar vacuna a un paciente inactivo!"),f.cerrarPopUpVacunasConfig(),n.stop()},f.obtenerVacunas=function(){P().then(function(e){f.vacunas=e})},f.limpiarAsignacionVacunas=function(){n.start(),f.vacunas.forEach(function(e){e.asignada=!1},this),n.stop()},f.verificarAsignacionVacunas=function(){n.start(),0<f.paciente.vacunas.length&&f.paciente.vacunas.forEach(function(e){for(var a=0;a<f.vacunas.length;a++)e.id_vacuna!=f.vacunas[a].id||e.eliminado||(f.vacunas[a].asignada=!0)},this),n.stop()},f.evaluarFechaDosisVacuna=function(e){if(n.start(),f.vacuna=e,null!=f.vacuna.pacienteVacunaDosis[0])if(null==f.vacuna.alreadyProyected){if(1==f.vacuna.pacienteVacuna.vacunaDosis.length&&f.vacuna.pacienteVacuna.vacunaDosis[0].unico)return f.vacuna.pacienteVacunaDosis[0].visible=!0,f.vacuna.pacienteVacunaDosis[0].retrasada=!1,f.vacuna.alreadyProyected=!0,f.vacuna.pacienteVacunaDosis[0].fechaCorta=f.fechaATexto(new Date(f.vacuna.pacienteVacunaDosis[0].fecha_aplicacion)),void n.stop();if(1==f.vacuna.pacienteVacuna.vacunaDosis.length&&!f.vacuna.pacienteVacuna.vacunaDosis[0].unico){f.vacuna.pacienteVacunaDosis.forEach(function(e,a,o){if(0==a)e.retrasada=!1,e.visible=!0,e.fechaCorta=f.fechaATexto(new Date(e.fecha_aplicacion));else{var i=new Date(f.vacuna.pacienteVacunaDosis[a-1].fecha_aplicacion).getTime();if(f.vacuna.pacienteVacuna.vacunaDosis[0].es_dosis)var t=new Date((new Date).setTime(i+864e5*f.vacuna.pacienteVacuna.vacunaDosis[0].tiempo));else t=new Date((new Date).setTime(864e5*(i+30*f.vacuna.pacienteVacuna.vacunaDosis[0].tiempo)));t.setHours(12,0,0,0);var r=new Date(e.fecha_aplicacion);r.setHours(12,0,0,0),r.getTime()<=t.getTime()?e.retrasada=!1:e.retrasada=!0,e.visible=!0,e.fechaCorta=f.fechaATexto(new Date(e.fecha_aplicacion))}});var a={retrasada:!1,id_paciente_vacuna:f.vacuna.id_paciente,fecha_aplicacion:new Date(f.vacuna.fecha_siguiente_aplicacion),proyectada:!0,visible:!0,fechaCorta:f.fechaATexto(new Date(f.vacuna.fecha_siguiente_aplicacion)),eliminado:!1};f.vacuna.pacienteVacunaDosis.push(a),f.vacuna.alreadyProyected=!0}if(1<f.vacuna.pacienteVacuna.vacunaDosis.length){for(f.vacuna.pacienteVacunaDosis.forEach(function(e,a,o){if(0==a)e.retrasada=!1,e.visible=!0,e.fechaCorta=f.fechaATexto(new Date(e.fecha_aplicacion));else{var i=new Date(f.vacuna.pacienteVacunaDosis[a-1].fecha_aplicacion).getTime();if(f.vacuna.pacienteVacuna.vacunaDosis[0].es_dosis)var t=new Date((new Date).setTime(i+864e5*f.vacuna.pacienteVacuna.vacunaDosis[a].tiempo));else t=new Date((new Date).setTime(864e5*(i+30*f.vacuna.pacienteVacuna.vacunaDosis[a].tiempo)));t.setHours(12,0,0,0);var r=new Date(e.fecha_aplicacion);r.setHours(12,0,0,0),r.getTime()<=t.getTime()?e.retrasada=!1:e.retrasada=!0,e.visible=!0,e.fechaCorta=f.fechaATexto(new Date(e.fecha_aplicacion))}});f.vacuna.pacienteVacunaDosis.length<f.vacuna.pacienteVacuna.vacunaDosis.length;){a={retrasada:!1,id_paciente_vacuna:f.vacuna.id_paciente,fecha_aplicacion:new Date,proyectada:!0,visible:!0,fechaCorta:f.fechaATexto(new Date),eliminado:!1};f.vacuna.pacienteVacuna.vacunaDosis[f.vacuna.pacienteVacunaDosis.length].es_dosis?a.fecha_aplicacion=new Date((new Date).setTime(new Date(f.vacuna.pacienteVacunaDosis[f.vacuna.pacienteVacunaDosis.length-1].fecha_aplicacion).getTime()+864e5*f.vacuna.pacienteVacuna.vacunaDosis[f.vacuna.pacienteVacunaDosis.length].tiempo)):a.fecha_aplicacion=new Date((new Date).setTime(new Date(f.vacuna.pacienteVacunaDosis[f.vacuna.pacienteVacunaDosis.length-1].fecha_aplicacion).getTime()+30*f.vacuna.pacienteVacuna.vacunaDosis[f.vacuna.pacienteVacunaDosis.length].tiempo*864e5)),a.fechaCorta=f.fechaATexto(a.fecha_aplicacion),f.vacuna.pacienteVacunaDosis.push(a),f.vacuna.alreadyProyected=!0}return void n.stop()}n.stop()}else n.stop();else n.stop()},f.validarDatosVacuna=function(e){return!(0<f.vacunaDosis.length&&""!=e.nombre)},f.editarVacuna=function(e,a){if(n.start(),e){var i=!1;f.vacuna=a,f.vacuna.vacunaDosis=f.vacunaDosis,1<f.vacunaDosis.length&&f.vacunaDosis.forEach(function(e,a,o){e.unico&&(i=!0,e.unico=!1),a==o.length-1&&i&&f.mostrarMensaje("No se puede guardar una dosis única en un conjunto de dosis!")}),a.id||i?i||C.update({id:a.id},a,function(e){f.mostrarMensaje(e.mensaje),n.stop()},function(e){f.mostrarMensaje("Ocurrio un problema al momento de guardar!"),n.stop()}):a.$save(function(e){f.mostrarMensaje(e.mensaje),n.stop()},function(e){f.mostrarMensaje("Ocurrio un problema al momento de guardar!"),n.stop()}),f.vacunaDosis=[],f.cerrarPopUpVacunaNueva()}else f.mostrarMensaje("Complete los campos requeridos!")},f.obtenerPrerequisitos=function(){n.start(),fe().then(function(e){f.preRequisitos=e.prerequisitos,n.stop()})},f.obtenerGenero=function(){n.start(),f.generos=[],b().then(function(e){e.forEach(function(e){f.generos.push(e)},this),n.stop()})},f.obtenerPacientes=function(){n.start(),f.paginator=c(),f.paginator.column="codigo",f.paginator.direccion="asc",f.filtro={empresa:f.usuario.id_empresa,codigo:"",nombres:"",ci:"",campo:"",cargo:"",busquedaEmpresa:"",estado:"",grupo_sanguineo:""},f.paginator.callBack=f.buscarPacientes,f.paginator.getSearch("",f.filtro,null),n.stop()},f.buscarPacientes=function(){n.start(),p(f.paginator).then(function(i){if(f.paginator.setPages(i.paginas),f.dynamicPopoverCargos={templateUrl:"myPopoverTemplate.html"},0<i.pacientes.length)if(0<i.fichas.length)for(var e=0;e<i.fichas.length;e++){var t=i.fichas[e];null!=t?i.pacientes.forEach(function(e,a,o){e.eliminado=0==e.activo,e.ficha=e.id==t.id_empleado?t:e.ficha,a===o.length-1&&(f.pacientes=i.pacientes)}):e===i.fichas.length-1&&i.pacientes.forEach(function(e,a,o){e.eliminado=0==e.activo,a===o.length-1&&(f.pacientes=i.pacientes)})}else i.pacientes.forEach(function(e,a,o){e.eliminado=0==e.activo,a===o.length-1&&(f.pacientes=i.pacientes)});else f.pacientes=i.pacientes;n.stop()})},f.guardarFichaTecnica=function(e,a){e&&("Siguiente"!=$("#siguiente-f").text().trim()&&(a.fecha_elaboracion=new Date(f.convertirFecha(a.fecha_elaboracion)),T(a).then(function(e){f.cerrarPopUpIdModalFichaTecnica(),f.recargarItemsTabla(),f.mostrarMensaje(e.message)})))},f.guardarFichaTecnicaExistente=function(e,a){e?(a.fecha_elaboracion=new Date(f.convertirFecha(a.fecha_elaboracion)),T(a).then(function(e){f.cerrarPopUpIdModalFichaTecnica(),f.recargarItemsTabla(),f.mostrarMensaje(e.message)})):f.mostrarMensaje("Faltan datos!")},f.aplicarVacuna=function(e,a){if(null!=a&&(a.activo=a.eliminado,f.paciente=a),n.start(),!f.paciente.eliminado)return f.mostrarMensaje("No se puede aplicar vacuna a un paciente inactivo!"),void n.stop();var o=new Date;o.setHours(12,0,0,0);var i=null!=e.fechaAplicacionVacuna_texto?new Date(f.convertirFecha(e.fechaAplicacionVacuna_texto)):new Date;i.setHours(12,0,0,0);var t=0,r=[];if(e.pacienteVacunaDosis.forEach(function(e){void 0===e.proyectada&&r.push(new Date(e.fecha_aplicacion))}),0==r.length)e.fecha_ultima_aplicacion=i,1<e.pacienteVacuna.vacunaDosis.length?e.pacienteVacuna.vacunaDosis[1].es_dosis?e.fecha_siguiente_aplicacion=new Date((new Date).setTime(i.getTime()+864e5*e.pacienteVacuna.vacunaDosis[1].tiempo)):e.fecha_siguiente_aplicacion=new Date((new Date).setTime(i.getTime()+30*e.pacienteVacuna.vacunaDosis[1].tiempo*864e5)):e.pacienteVacuna.vacunaDosis[0].es_dosis?e.fecha_siguiente_aplicacion=new Date((new Date).setTime(i.getTime()+864e5*e.pacienteVacuna.vacunaDosis[t].tiempo)):e.fecha_siguiente_aplicacion=new Date((new Date).setTime(i.getTime()+30*e.pacienteVacuna.vacunaDosis[t].tiempo*864e5)),e.fecha_siguiente_aplicacion_texto=f.fechaATexto(e.fecha_siguiente_aplicacion);else{if(i<new Date(Math.max.apply(null,r)))return f.mostrarMensaje("No se puede aplicar en una fecha anterior a la ultima aplicación!"),void n.stop();if(1<e.pacienteVacuna.vacunaDosis.length){if(t=e.pacienteVacunaDosis.length,null==e.pacienteVacuna.vacunaDosis[t])return void f.mostrarMensaje("No se puede aplicar, excede el número de dosis aplicables!");e.fecha_ultima_aplicacion=i,e.pacienteVacuna.vacunaDosis[t].es_dosis?e.fecha_siguiente_aplicacion=new Date((new Date).setTime(i.getTime()+864e5*e.pacienteVacuna.vacunaDosis[t].tiempo)):e.fecha_siguiente_aplicacion=new Date((new Date).setTime(i.getTime()+30*e.pacienteVacuna.vacunaDosis[t].tiempo*864e5)),e.fecha_siguiente_aplicacion_texto=f.fechaATexto(e.fecha_siguiente_aplicacion)}else e.fecha_ultima_aplicacion=i,e.pacienteVacuna.vacunaDosis[0].es_dosis?e.fecha_siguiente_aplicacion=new Date((new Date).setTime(i.getTime()+864e5*e.pacienteVacuna.vacunaDosis[0].tiempo)):e.fecha_siguiente_aplicacion=new Date((new Date).setTime(i.getTime()+30*e.pacienteVacuna.vacunaDosis[0].tiempo*864e5)),e.fecha_siguiente_aplicacion_texto=f.fechaATexto(e.fecha_siguiente_aplicacion)}E.update({id:e.id},e,function(e){M(f.paciente).then(function(e){f.paciente.vacunas=e,f.inicializarFechaAplicacionVacuna(),n.stop()}),f.mostrarMensaje(e.mensaje)},function(e){f.mostrarMensaje("Se produjo un error"),n.stop()}),f.fechaATexto(o)!=f.fechaATexto(i)||(f.mostrarMensaje("La fecha de aplicación y la fecha actual son diferentes, vacuna aplicada de todas formas!"),n.stop()),f.obtenerAlertas()},f.inicializarFechaAplicacionVacuna=function(){f.paciente.vacunas.forEach(function(e,a,o){var i=new Date;e.fechaAplicacionVacuna_texto=i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),a===o.length-1&&f.obtenerAlertas()})},f.button_clicked=!1,f.disableImput=function(e){aplicarDatePickers();var a=0;e.pacienteVacunaDosis.forEach(function(e){e.proyectada||(a+=1)},this),e.button_clicked?(1!=e.pacienteVacuna.vacunaDosis.length||e.pacienteVacuna.vacunaDosis[0].unico?a<e.pacienteVacuna.vacunaDosis.length?f.aplicarVacuna(e):f.mostrarMensaje("No se puede aplicar la vacuna, excede la cantidad de dosis"):f.aplicarVacuna(e),e.button_clicked=!1):e.button_clicked=!0},f.dosisText="Mes(es)",f.textoDosis=function(e){f.dosisText=e?"Día(s)":"Mes(es)"},f.imprimirCredencial=function(){html2canvas(document.getElementsByClassName("PrintCredencial"),{allowTaint:!0,onrendered:function(e){var a=window.open("","Credencial","width=1100,height=1000");a.document.body.appendChild(e),a.focus(),a.print()}})},f.DatosSV=[{type:"line",showInLegend:!0,lineThickness:2,name:"PrecionS",color:"#F08080",dataPoints:[]},{type:"line",showInLegend:!0,lineThickness:2,name:"Pulso",color:"#EC11B0",dataPoints:[]},{type:"line",showInLegend:!0,lineThickness:2,name:"Talla",color:"#11EC2B",dataPoints:[]},{type:"line",showInLegend:!0,lineThickness:2,name:"Temperatura",color:"#48B5DF",dataPoints:[]},{type:"line",showInLegend:!0,lineThickness:2,name:"Frecuencia Respiratoria",color:"#DF488A",dataPoints:[]},{type:"line",showInLegend:!0,lineThickness:2,name:"Frecuencia cardiaca",color:"#CCDF48",dataPoints:[]},{type:"line",showInLegend:!0,lineThickness:2,name:"indice de masa corporal",color:"#48DFD3",dataPoints:[]}],f.selection=[],f.chart=new CanvasJS.Chart("chartContainer",{title:{text:"GRAFICA - SIGNOS VITALES",fontSize:22},legend:{horizontalAlign:"right",verticalAlign:"center",fontSize:14},animationEnabled:!0,exportEnabled:!0,width:1100,axisX:{gridColor:"Silver",tickColor:"silver",valueFormatString:"DD/MM/YY",titleFontSize:8},theme:"theme1",axisY:{gridColor:"Silver",tickColor:"silver"},data:f.selection}),f.chart.render(),f.toggleSelection=function(e){var a=f.selection.map(function(e){return e.name}).indexOf(e.name);-1<a?f.selection.splice(a,1):f.selection.push(e),f.chart.render(),f.chart.destroy()},f.checkAll=function(a){f.selection.length=0,angular.forEach(f.DatosSV,function(e){e.selected=a.target.checked,e.selected?f.selection.push(e):f.selection.splice(0,1),f.chart.render(),f.chart.destroy()})},f.abrirIdModalDialogLaboratorioExamenesNuevoResultado=function(e,a){f.examen={},e&&(f.examen=e),f.examen.soloVista=!!a,f.abrirPopup(f.IdModalDialogLaboratorioExamenesNuevoResultado),f.fechaResultado=f.fechaATexto(new Date)},f.abrirIdModalDialogLaboratorioExamenesHistoricoResultados=function(){filtro={inicio:0,fin:0},f.ObtenerHistorialLaboratorioExamenes(filtro),f.abrirPopup(f.IdModalDialogLaboratorioExamenHistoricoResultado)},f.abrirIdModalDialogDiagnosticoExamenesHistoricoResultados=function(){filtro={inicio:0,fin:0},f.ObtenerHistorialDiagnosticoExamenes(filtro),f.abrirPopup(f.IdModalDialogDiagnosticoExamenHistoricoResultado)},f.abrirIdModalDialogNuevoLaboratorio=function(e,a){f.laboratorio={},e&&(f.laboratorio=e),f.laboratorio.soloVista=!!a,f.abrirPopup(f.IdModalDialogNuevoLaboratorio)},f.abrirIdModalDialogLaboratorioExamenesHistorico=function(){f.abrirPopup(f.IdModalDialogLaboratorioExamenHistoricoPreview)},f.abrirIdModalDialogLaboratorioExamenes=function(e){f.laboratorio=e,f.ObtenerMedicoLaboratorioExamenes(e),f.abrirPopup(f.IdModalDialogLaboratorioExamenes)},f.abrirIdModalFichaTecnica=function(e){f.paciente=e,f.buscarfichaPaciente(e),f.abrirPopup(f.idModalFichaTecnica)},f.buscarfichaPaciente=function(e){n.start(),w(e.id).then(function(e){if(e.ficha){f.ficha=e.ficha;var a=new Date,o=new Date(f.ficha.paciente.persona.fecha_nacimiento),i=new Date(e.ficha.fecha);f.ficha.fecha_elaboracion=i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear();var t=f.diferenciaEntreDiasEnDias(o,a);f.ficha.edad=Math.trunc(t/365),f.ficha.edad,f.mostarGuardarFicha=!0}else{f.mostarGuardarFicha=!1,f.ficha={paciente:e.paciente,pacienteReferencia:{}};a=new Date,o=new Date(f.ficha.paciente.persona.fecha_nacimiento),t=f.diferenciaEntreDiasEnDias(o,a);f.ficha.edad=Math.trunc(t/365)}n.stop()})},f.obtenerTipoControl=function(){n.start(),I().then(function(e){f.tiposControl=e,n.stop()})},f.diferenciaEntreDiasEnDias=function(e,a){var o=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),i=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate());return Math.floor((i-o)/864e5)},f.obtenerDatosPrerequisito=function(e,a){n.start(),null!=a.inicio&&0!=a.inicio&&""!=a.inicio?f.filtro.inicio=a.inicio instanceof Date?a.inicio:new Date(f.convertirFecha(a.inicio)):f.filtro.inicio=0,null!=a.fin&&0!=a.fin&&""!=a.fin?f.filtro.fin=a.fin instanceof Date?a.fin:new Date(f.convertirFecha(a.fin)):f.filtro.fin=0,O(e.id,f.filtro).then(function(e){f.prerequisitosPaciente=e.Prerequisitos,f.prerequisitosPaciente.forEach(function(e){null!=e.fecha_entrega&&(e.entregado=!0)}),console.log(f.prerequisitosPaciente),f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():"",n.stop()},function(e){f.mostrarMensaje("Se produjo un error al obtener datos de prerequisitos"),n.stop()})},f.abrirDialogVerResultadosLab=function(e){f.Hostorialexamenes=e.laboratorioResultados,f.abrirPopup(f.idModalDialogVerResultadosHistorialLab)},f.cerrarDialogVerResultadosLab=function(e){f.cerrarPopup(f.idModalDialogVerResultadosHistorialLab)},f.showPopover=!1,f.popover={title:"Title",message:"Message"},f.abrirIdModalDialogPreRequisitos=function(e){f.paciente=e,f.verificarAsignacionPrerequisitos(),f.abrirPopup(f.IdModalDialogPreRequisitos)},f.abrirDialogHistorico=function(e){f.abrirPopup(f.idModalDialogHistorico)},f.abrirDialogVacunaEditar=function(e){f.vacuna=e,f.vacunaDosis=e.vacunaDosis,f.dosis={},f.dosisEdit=!1,f.abrirPopup(f.idModalDialogVacunaEdicion)},f.abriridModalDialogFechaEntrega=function(){f.abrirPopup(f.idModalDialogFechaEntrega)},f.abrirIdModalGraficoSV=function(e){f.DatosSV.forEach(function(e){e.dataPoints=[]}),f.fechasLabel=[];f.paciente=e;A(f.paciente.id,{inicio:0,fin:0}).then(function(e){for(var a=0;a<e.consultas.length;a++){var o=e.consultas[a],i=new Date(o.fecha),t=o.presion.split("/"),r=i.getDate()+"/"+i.getMonth()+"/"+i.getFullYear();f.fechasLabel.push(r);var n={x:new Date(i.getFullYear(),i.getMonth(),i.getDate()),y:parseInt(t[0])},s={x:new Date(i.getFullYear(),i.getMonth(),i.getDate()),y:parseInt(o.pulso)},c={x:new Date(i.getFullYear(),i.getMonth(),i.getDate()),y:parseInt(o.talla)},l={x:new Date(i.getFullYear(),i.getMonth(),i.getDate()),y:parseInt(o.peso)},d={x:new Date(i.getFullYear(),i.getMonth(),i.getDate()),y:parseInt(o.temperatura)},u={x:new Date(i.getFullYear(),i.getMonth(),i.getDate()),y:parseInt(o.frecuencia_cardiaca)},p={x:new Date(i.getFullYear(),i.getMonth(),i.getDate()),y:parseInt(o.frecuencia_respiratoria)},m={x:new Date(i.getFullYear(),i.getMonth(),i.getDate()),y:parseInt(o.indice_masa_corporal)};f.DatosSV.forEach(function(e){"PrecionS"==e.name&&e.dataPoints.push(n),"Talla"==e.name&&e.dataPoints.push(c),"Pulso"==e.name&&e.dataPoints.push(s),"Peso"==e.name&&e.dataPoints.push(l),"Temperatura"==e.name&&e.dataPoints.push(d),"Frecuencia Respiratoria"==e.name&&e.dataPoints.push(p),"Frecuencia cardiaca"==e.name&&e.dataPoints.push(u),"indice de masa corporal"==e.name&&e.dataPoints.push(m)},this),20}}),f.abrirPopup(f.IdModalDialogGraficoSV)},f.cerrarIdModalGraficoSV=function(){f.cerrarPopup(f.IdModalDialogGraficoSV)},f.abrirDialogNuevoExamen=function(){f.abrirPopup(f.IdModalDialogLaboratorioExamen)},f.abrirIdModalDialogLaboratorio=function(e){f.paciente=e,f.ObtenerMedicoLaboratorios(e),f.abrirPopup(f.IdModalDialogLaboratorio)},f.abriridModalDialogVacunaNueva=function(){f.vacuna=new C({}),f.dosis={},f.dosisEdit=!1,f.abrirPopup(f.idModalDialogVacunaEdicion)},f.abrirDialogVacunasConfig=function(){f.limpiarAsignacionVacunas(),f.verificarAsignacionVacunas(),f.obtenerAlertas(),f.abrirPopup(f.idModalDialogVacunasConfig)},f.abrirDialogVacunas=function(e){f.paciente=e,f.paciente.vacunas=[],f.filtroHistorialVacunas=[],M(f.paciente).then(function(e){f.paciente.vacunas=e,f.paciente.vacunas.forEach(function(e){var a=new Date;e.fechaAplicacionVacuna_texto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),e.button_clicked=!1},this)}),f.limpiarAsignacionVacunas(),f.verificarAsignacionVacunas(),f.obtenerAlertas(),f.abrirPopup(f.idModalDialogVacunas)},f.guardarEntregaPrerequisito=function(e){n.start(),null==e.fecha_entrega_texto||""==e.fecha_entrega_texto?f.mostrarMensaje("Ingrese la fecha de entrega."):(e.fecha_entrega=new Date(f.convertirFecha(e.fecha_entrega_texto)),e.asignado=!0,ge.save(e,function(a){O(f.paciente.id,{inicio:0,fin:0}).then(function(e){f.prerequisitosPaciente=e.Prerequisitos,f.mostrarMensaje(a.mensaje),f.prerequisitosPaciente.forEach(function(e){null!=e.fecha_entrega&&(e.entregado=!0)}),f.cerrarPopUpEntregaPreRequisito(),n.stop()})},function(e){f.mostrarMensaje("Ocurrio un problema al guardar la fecha de entrega  de el prerequisito")}))},f.verificarFechaEntregaPrerequisito=function(e,a){f.preRequisito=e,f.preRequisito.fecha_entrega_texto=f.fechaATexto(new Date),f.paciente=void 0===a?e.pacientePrerequisito:a,console.log(f.preRequisito);var o=new Date(f.preRequisito.fecha_vencimiento).getTime(),i=(new Date).getTime();0<=Math.floor((i-o)/864e5)?f.abrirDialogEntregaPreRequisito(f.preRequisito,f.paciente):f.abrirPopup(f.idModalDialogConfirmacionEntregaAdelantado),f.obtenerAlertas()},f.cerrarConfirmacionEntragaAdelantadaPrerequisito=function(){f.cerrarPopup(f.idModalDialogConfirmacionEntregaAdelantado)},f.abrirDialogEntregaPreRequisito=function(e,a){f.cerrarConfirmacionEntragaAdelantadaPrerequisito(),f.preRequisito=e,f.preRequisito.fecha_entrega_texto=f.fechaATexto(new Date),f.paciente=a,f.abrirPopup(f.IdEntregaPrerequisito)},f.cerrarPopUpEntregaPreRequisito=function(){f.obtenerAlertas(),f.cerrarPopup(f.IdEntregaPrerequisito)},f.abrirDialogPacienteNuevo=function(){f.paciente=new d({persona:{imagen:"img/icon-user-default.png"},id_empresa:f.usuario.id_empresa}),f.abrirPopup(f.idModalDialogPacienteNuevo)},f.cerrarPopupPacienteNuevo=function(){f.cerrarPopup(f.idModalDialogPacienteNuevo)},f.abrirDialogPrerequisitoNuevo=function(){f.NuevoP=new v({puede_modificar_rrhh:!1}),f.abrirPopup(f.idModalDialogPrerequisitoNuevo)},f.abrirDialogPrerequisitoEditar=function(e){f.NuevoP=new v({id:e.id,nombre:e.nombre,observacion:e.observacion,vencimiento_mes:e.vencimiento_mes,dias_activacion:e.dias_activacion,puede_modificar_rrhh:e.puede_modificar_rrhh}),f.abrirPopup(f.idModalDialogPrerequisitoNuevo)},f.cerrarPopupPrerequisitoNuevo=function(){f.obtenerAlertas(),f.cerrarPopup(f.idModalDialogPrerequisitoNuevo)},f.validarCodigoCuentaEmpleado=function(e){""!=e&&Me(function(){f.validar=new _e,f.validar.codigo=e,f.validar.$save(function(e){f.data=e})},1500)},f.abrirDialogHistoricoPreRequisito=function(e,a){var o=0,i=0;f.preRequisito=e,f.paciente=a,he({id_pre:f.preRequisito.preRequisito.id,id_pac:f.paciente.id,inicio:o,fin:i}).then(function(e){f.historialPrerequisitosPaciente=e.historial,n.stop(),f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():""}),f.abrirPopup(f.idModalHistorialPrerequisito)},f.filtrarHistorialPrerequisito=function(a){if(null!=a){var e=null===a.inicio||""===a.inicio||void 0===a.inicio?0:new Date(a.inicio),o=null===a.fin||""===a.fin||void 0===a.fin?0:new Date(a.fin),i=null===a.opcion||void 0===a.opcion?0:a.opcion;a={inicio:e,fin:o,opcion:i}}else a={inicio:0,fin:0};he({id_pre:f.preRequisito.preRequisito.id,id_pac:f.paciente.id,inicio:a.inicio,fin:a.fin}).then(function(e){f.historialPrerequisitosPaciente=e.historial,n.stop(),a.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",a.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():""})},f.cerrarDialogHistoricoPreRequisito=function(){f.cerrarPopup(f.idModalHistorialPrerequisito)},f.actualizarPrerequisito=function(a){n.start(),console.log(a),F(a).then(function(e){a instanceof Array&&f.cerrarPopUpPreRequisitos(),n.stop(),f.mostrarMensaje(e.message)})},f.verificarAsignacionPrerequisitos=function(){n.start(),fe().then(function(e){f.preRequisitos=e.prerequisitos,filtro={inicio:0,fin:0},O(f.paciente.id,filtro).then(function(e){f.prerequisitosPaciente=e.Prerequisitos,f.preRequisitos.forEach(function(a,e,o){f.prerequisitosPaciente.forEach(function(e){e.fecha_vencimiento=f.calcularFechaVencimientoRequisito(e),a.id==e.id_prerequisito&&(a.asignado=!0),null!=e.fecha_entrega&&(e.entregado=!0)}),0==f.prerequisitosPaciente.length&&(a.asignado=!1),e===o.length-1&&n.stop()}),0==f.preRequisitos.length&&n.stop()})})},f.asignarPrerequisito=function(e,a){n.start(),e.pacientePrerequisito={id:a.id},e.preRequisito={id:e.id},e.fecha_inicio=new Date,e.fecha_inicio_texto=f.fechaATexto(e.fecha_inicio),e.fecha_vencimiento=f.calcularFechaVencimientoRequisito(e),e.paraAsignar=!0,ge.save(e,function(e){f.verificarAsignacionPrerequisitos(),f.mostrarMensaje(e.mensaje),n.stop()},function(e){f.mostrarMensaje("Ocurrio un problema al asignar el prerequisito"),n.stop()})},f.diasVencidos=function(e){var a=(new Date).getTime()-e.getTime();return Math.floor(a/864e5)},f.calcularFechaVencimientoRequisito=function(e){var a=void 0===e.vencimiento_mes?e.preRequisito.vencimiento_mes:e.vencimiento_mes,o=(new Date,new Date);if(void 0===e.fecha_inicio_texto)var i=f.fechaATexto(e.fecha_inicio);var t=void 0===e.fecha_inicio_texto?i.split("/"):e.fecha_inicio_texto.split("/"),r=parseInt(t[0]),n=parseInt(t[1]),s=parseInt(t[2]);return o.setFullYear(s,n-1,r),new Date(o.setTime(o.getTime()+30*a*864e5))},f.actualizarPreRequisitoPaciente=function(e){n.start();var a=e;a.fecha_vencimiento=new Date(f.convertirFecha(a.fecha_vencimiento_texto)),a.fecha_inicio=new Date,a.fecha_entrega=null,a.asignado=!0,ge.save(a,function(e){f.mostrarMensaje(e.mensaje),f.cerrarDialogEditarPreRequisito(),f.verificarAsignacionPrerequisitos(),n.stop()},function(e){f.mostrarMensaje("Ocurrio un problema al asignar el prerequisito"),f.cerrarDialogEditarPreRequisito(),n.stop()})},f.saveFormPrerequisito=function(e){(n.start(),null!=e.nombre&&null!=e.vencimiento_mes)?Ee(e).then(function(e){f.mostrarMensaje(e.mensaje),f.cerrarPopupPrerequisitoNuevo(),n.stop(),f.verificarAsignacionPrerequisitos()}).catch(function(e){n.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";f.mostrarMensaje(a)}):(f.mostrarMensaje("Los campos Prerequisito Nombre y vencimiento mes son requeridos."),n.stop())},f.finVerPaciente=function(){"Siguiente"!=$("#siguiente-v").text().trim()&&f.cerrarPopPupVista()},f.sinFuncionalidad=function(e){f.mostrarMensaje("Sin funcionalidad")},f.abrirDialogEditarPreRequisito=function(e){f.preRequisito=e,f.preRequisito.fecha_vencimiento_texto=f.fechaATexto(new Date),f.abrirPopup(f.idModalEditarPrerequisito)},f.cerrarDialogEditarPreRequisito=function(){f.cerrarPopup(f.idModalEditarPrerequisito)},f.verPaciente=function(e){promesaPaciente=ee(e.id),promesaPaciente.then(function(e){f.paciente=e,f.paciente.fecha_nacimiento_texto=f.fechaATexto(f.paciente.persona.fecha_nacimiento)}),f.abrirPopup(f.idModalWizardPacienteVista)},f.cerrarPopPupVista=function(){f.cerrarPopup(f.idModalWizardPacienteVista)},f.modificarPaciente=function(e){promesaPaciente=ee(e.id),promesaPaciente.then(function(e){console.log(e),f.paciente=e,f.paciente.fecha_nacimiento_texto=f.fechaATexto(f.paciente.persona.fecha_nacimiento),f.paciente.persona.imagen=null==e.persona.imagen?"img/icon-user-default.png":e.persona.imagen,console.log(f.paciente.fecha_nacimiento_texto)}),console.log(f.paciente),f.abrirPopup(f.idModalDialogPacienteNuevo)},f.mostrarConfirmacionEliminacion=function(e){e.persona=null==e.persona?{imagen:null==e.imagen?"img/icon-user-default.png":e.imagen}:e.persona.imagen,e.eliminar=!0,f.paciente=e,f.abrirPopup(f.idModalEliminarPaciente)},f.cerrarConfirmacionEliminacion=function(){f.cerrarPopup(f.idModalEliminarPaciente)},f.eliminarPaciente=function(e){n.start(),f.paciente.eliminado=0==e.eliminado,d.update({id_paciente:f.paciente.id},f.paciente,function(e){n.stop(),f.cerrarConfirmacionEliminacion(),f.obtenerPacientes(),f.mostrarMensaje("Eliminado Exitosamente!")},function(e){n.stop(),f.cerrarConfirmacionEliminacion(),f.obtenerPacientes(),f.mostrarMensaje("Ocurrio un problema al eliminar el paciente!"),f.recargarItemsTabla()})},f.cortarFecha=function(e){var a=e.split(" "),o=a[1].split(":"),i=a[0].split("/"),t=parseInt(i[0]),r=parseInt(i[1]),n=parseInt(i[2]),s=new Date,c="AM"==a[2]?parseInt(o[0]):parseInt(o[0])<12?parseInt(o[0])+12:parseInt(o[0]);return s.setFullYear(n,r-1,t),s.setHours(c,o[1]),s},f.guardarConsulta=function(e,a){if("Siguiente"!=$("#siguiente-c").text().trim()&&e.$valid){a.fecha.split(" ");a.fecha=(a.fecha,Date,f.cortarFecha(a.fecha)),a.presion=a.presionAlta+"/"+a.presionBaja,S(a).then(function(e){f.cerrarPopUpConsulta(),f.recargarItemsTabla(),f.mostrarMensaje(e.message)})}},f.guardarDatosConsulta=function(e,a){if(e.$valid){a.fecha.split(" ");a.fecha=(a.fecha,Date,f.cortarFecha(a.fecha)),a.presion=a.presionAlta+"/"+a.presionBaja,S(a).then(function(e){f.cerrarPopUpConsulta(),f.recargarItemsTabla(),f.mostrarMensaje(e.message)})}},f.listarConsultasPaciente=function(e){null!=e.inicio&&(0!=e.inicio||""!=e.inicio)?f.filtro.inicio=e.inicio instanceof Date?e.inicio:new Date(f.convertirFecha(e.inicio)):f.filtro.inicio=0,null!=e.fin&&(0!=e.fin||""!=e.fin)?f.filtro.fin=e.fin instanceof Date?e.fin:new Date(f.convertirFecha(e.fin)):f.filtro.fin=0,A(f.paciente.id,f.filtro).then(function(e){f.listaConsultas=e.consultas,f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():""})},f.changeActivo=function(e){ie.update({id_paciente:e.id},e,function(e){f.mostrarMensaje(e.mensaje)})},f.saveForm=function(e){(f.paciente=e).imagen;"Siguiente"!=$("#siguiente").text().trim()&&(n.start(),e.id?(e.persona.fecha_nacimiento=new Date(f.convertirFecha(e.fecha_nacimiento_texto)),d.update({id_paciente:e.id},e,function(e){n.stop(),f.cerrarPopupPacienteNuevo(),f.obtenerPacientes(),f.mostrarMensaje("Actualizado Exitosamente!"),f.recargarItemsTabla()})):(e.persona.fecha_nacimiento=new Date(f.convertirFecha(e.fecha_nacimiento_texto)),e.$save({id_paciente:0},function(e){n.stop(),f.cerrarPopupPacienteNuevo(),f.obtenerPacientes(),f.mostrarMensaje(e.message),f.recargarItemsTabla()},function(e){n.stop(),f.cerrarPopupPacienteNuevo(),f.obtenerPacientes(),f.mostrarMensaje("Ocurrio un problema al momento de guardar!"),f.recargarItemsTabla()})))},f.saveComment=function(e){ae.update({id_paciente:e.id},e,function(e){f.mostrarMensaje("Comentario actualizado Exitosamente!")},function(e){f.mostrarMensaje("Hubo un problema al guardar su comentario.")}),n.stop(),f.cerrarDialogDialogComentario()},f.filtrarHistorialVacunas=function(e){var o=""===e.inicio||void 0===e.inicio?0:new Date(e.inicio),i=""===e.fin||void 0===e.fin?0:new Date(e.fin),t=""===e.opcion||void 0===e.opcion?0:e.opcion;0!=o&&0!=i?f.filtroHistorialVacunas.forEach(function(e){e.pacienteVacunaDosis.forEach(function(e){var a=new Date(e.fecha_aplicacion);o<=a&&a<=i?(e.visible=!0,0!=t&&("enfec"==t&&(e.visible=null!=e.retrasada&&!(e.retrasada&&!e.proyectada)),"proye"==t&&(e.visible=null!=e.proyectada&&null!=e.proyectada&&!!e.proyectada),"retra"==t&&(e.visible=null!=e.retrasada&&!(!e.retrasada||e.proyectada)),"todas"==t&&(e.visible=!0))):e.visible=!1})}):f.filtroHistorialVacunas.forEach(function(e){e.pacienteVacunaDosis.forEach(function(e){0!=t?f.filtroHistorialVacunas.forEach(function(e){e.pacienteVacunaDosis.forEach(function(e){"enfec"==t&&(e.visible=null!=e.retrasada&&!(e.retrasada&&!e.proyectada)),"proye"==t&&(e.visible=null!=e.proyectada&&null!=e.proyectada&&!!e.proyectada),"retra"==t&&(e.visible=null!=e.retrasada&&!(!e.retrasada||e.proyectada)),"todas"==t&&(e.visible=!0)})}):e.visible=!0})}),0!=o&&0==i?f.filtroHistorialVacunas.forEach(function(e){e.pacienteVacunaDosis.forEach(function(e){var a=new Date(e.fecha_aplicacion);o<=a?(e.visible=!0,0!=t&&("enfec"==t&&(e.visible=null!=e.retrasada&&!(e.retrasada&&!e.proyectada)),"proye"==t&&(e.visible=null!=e.proyectada&&null!=e.proyectada&&!!e.proyectada),"retra"==t&&(e.visible=null!=e.retrasada&&!(!e.retrasada||e.proyectada)),"todas"==t&&(e.visible=!0))):e.visible=!1})}):0==o&&0!=i&&f.filtroHistorialVacunas.forEach(function(e){e.pacienteVacunaDosis.forEach(function(e){new Date(e.fecha_aplicacion)<=i?(e.visible=!0,0!=t&&("enfec"==t&&(e.visible=null!=e.retrasada&&!(e.retrasada&&!e.proyectada)),"proye"==t&&(e.visible=null!=e.proyectada&&null!=e.proyectada&&!!e.proyectada),"retra"==t&&(e.visible=null!=e.retrasada&&!(!e.retrasada||e.proyectada)),"todas"==t&&(e.visible=!0))):e.visible=!1})})},f.limpiarVisibilidadDosis=function(){f.filtroHistorialVacunas.forEach(function(e){e.pacienteVacunaDosis.forEach(function(e){e.visible=!0})})},f.abrirDialogHistorialVacuna=function(e){var a=f.paciente.vacunas.indexOf(e);f.vacuna=f.paciente.vacunas[a],f.evaluarFechaDosisVacuna(f.vacuna),f.filtroHistorialVacunas=[],f.filtroHistorialVacunas.push(f.vacuna),f.limpiarVisibilidadDosis(),f.abrirPopup(f.idModalDialogHistorialVacuna),f.filtroHistorialVacunas.forEach(function(e){e.pacienteVacunaDosis.forEach(function(e){e.visible=!0})})},f.cerrarDialogHistorialVacuna=function(){f.filtroVacunas={inicio:"",fin:"",opcion:"todas"},f.limpiarVisibilidadDosis(),f.cerrarPopup(f.idModalDialogHistorialVacuna)},f.abrirDialogHistorialConsulta=function(){f.listarConsultasPaciente({inicio:0,fin:0}),f.dynamicPopoverCargos={templateUrl:"consultaPopoverTemplate.html"},f.abrirPopup(f.idModalHistorialConsulta)},f.cerrarDialogHistorialConsulta=function(){f.cerrarPopup(f.idModalHistorialConsulta)},f.abrirDialogHistorialVacunaGeneral=function(){f.paciente.vacunas.forEach(function(e,a,o){f.evaluarFechaDosisVacuna(e),a===o.length-1&&(f.filtroHistorialVacunas=f.paciente.vacunas,f.limpiarVisibilidadDosis())},this),f.abrirPopup(f.idModalDialogHistorialVacunaGeneral)},f.cerrarDialogHistorialVacunaGeneral=function(){f.filtroVacunas={inicio:"",fin:"",opcion:"todas"},f.limpiarVisibilidadDosis(),f.filtroHistorialVacunas=[],f.cerrarPopup(f.idModalDialogHistorialVacunaGeneral)},f.abrirDialogDiagnosticos=function(e){f.paciente=e,f.ObtenerMedicoDiagnostico(e),f.abrirPopup(f.idModalDialogDiagnosticos)},f.cerrarDialogDiagnosticos=function(){f.cerrarPopup(f.idModalDialogDiagnosticos)},f.abrirDialogDiagnosticoNuevo=function(e,a){f.diagnostico={},e&&(f.diagnostico=e),f.diagnostico.soloVista=!!a,f.abrirPopup(f.idModalDialogDiagnosticoNuevo)},f.cerrarDialogDiagnosticoNuevo=function(){f.cerrarPopup(f.idModalDialogDiagnosticoNuevo)},f.abrirDialogExamenesDiagnostico=function(e){f.diagnostico=e,f.ObtenerMedicoDiagnosticoExamenes(e),f.abrirPopup(f.idModalDialogExamenesDiagnostico)},f.cerrarDialogExamenesDiagnostico=function(){f.cerrarPopup(f.idModalDialogExamenesDiagnostico)},f.abrirDialogNuevoExamenDiagnostico=function(e,a){f.examen={},e&&(f.examen=e),f.examen.soloVista=!!a,f.abrirPopup(f.idModalDialogNuevoExamenDiagnostico)},f.cerrarDialogNuevoExamenDiagnostico=function(){f.cerrarPopup(f.idModalDialogNuevoExamenDiagnostico)},f.abrirDialogHistorialFicha=function(e){f.ObtenerHistorialFichaMedica({inicio:0,fin:0,tipo_control:0}),f.abrirPopup(f.idModalDialogHistorialFicha)},f.cerrarDialogHistorialFicha=function(){f.cerrarPopup(f.idModalDialogHistorialFicha)},f.abrirDialogDialogCredencial=function(e){f.paciente=e,w(e.id).then(function(e){e.ficha?(f.ficha=e.ficha,f.ficha.enfermedad_cardilogia||(f.ficha.enfermedad_cardilogia2=!0),f.ficha.enfermedad_hipertension||(f.ficha.enfermedad_hipertension2=!0),f.ficha.enfermedad_lumbalgia||(f.ficha.enfermedad_lumbalgia2=!0),f.ficha.enfermedad_diabetes||(f.ficha.enfermedad_diabetes2=!0),f.ficha.enfermedad_epilepsia||(f.ficha.enfermedad_epilepsia2=!0),f.ficha.enfermedad_chagas||(f.ficha.enfermedad_chagas2=!0),f.ficha.enfermedad_hepatitis||(f.ficha.enfermedad_hepatitis2=!0),""==!f.ficha.enfermedad_otros?f.ficha.enfermedad_otros2=!0:f.ficha.enfermedad_otros3=!0,f.ficha.alergia_otros||f.ficha.alergia_conservas||f.ficha.alergia_alimentos||f.ficha.alergia_humo_cigarrillo||f.ficha.alergia_polvo||f.ficha.alergia_quimico||f.ficha.alergia_algun_material||f.ficha.alergia_medicamento||f.ficha.alergia_plantas?f.ficha.alergia=!0:f.ficha.alergia2=!0,f.abrirPopup(f.idModalDialogCredencial)):f.mostrarMensaje("primero debe crear una ficha medica del paciente para poder ver el credencial")})},f.cerrarDialogDialogCredencial=function(){f.cerrarPopup(f.idModalDialogCredencial)},f.abrirDialogDialogPatologias=function(e){f.paciente=e,w(e.id).then(function(e){e.ficha?(f.ficha=e.ficha,f.abrirPopup(f.idModalDialogPatologias)):f.mostrarMensaje("primero debe crear una ficha medica para poder ver las patogias del paciente")})},f.guardarPatoliga=function(){R(f.paciente.id,f.ficha).then(function(e){f.cerrarDialogDialogPatologias(),f.mostrarMensaje(e.message)})},f.cerrarDialogDialogPatologias=function(){f.cerrarPopup(f.idModalDialogPatologias)},f.abrirDialogDialogComentario=function(e){f.paciente=e,f.abrirPopup(f.idModalDialogComentario)},f.cerrarDialogDialogComentario=function(){f.cerrarPopup(f.idModalDialogComentario)},f.abrirDialogDialogAlertPrerequisitos=function(){f.listaAlertasPrerequisitosPaciente({inicio:0,fin:0}),f.abrirPopup(f.idModalAlertPrerequisitos)},f.cerrarDialogDialogAlertPrerequisitos=function(){f.cerrarPopup(f.idModalAlertPrerequisitos)},f.verificarConteoAlertas=function(){var e=0;return null!=f.alertasPrerequisitos&&(e+=f.alertasPrerequisitos),null!=f.alertasVacunas&&(e+=f.alertasVacunas),f.alertasOtros=0,e},f.obtenerAlertas=function(){f.verificarAlertasPrerequisitos(),f.verificarAlertasVacunas(),f.verificarConteoAlertas()},f.verificarAlertasPrerequisitos=function(){var e={inicio:0,fin:0};f.filtro=e,ve(f.usuario.id_empresa,e).then(function(e){f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():"";var a=e.Prerequisitos;f.listaAlertPrerequisitos=[],a.forEach(function(e,a,o){new Date;var i=new Date(e.fecha_vencimiento);e.DiasVence=f.diasVencidos(i),null!=e.fecha_entrega?e.entregado=!0:(e.entregado=!1,e.reprogramado?e.DiasVence<=e.dias_activacion&&e.DiasVence>=-1*e.dias_activacion&&f.listaAlertPrerequisitos.push(e):e.DiasVence<=e.preRequisito.dias_activacion&&e.DiasVence>=-1*e.preRequisito.dias_activacion&&f.listaAlertPrerequisitos.push(e)),a==o.length-1&&(f.alertasPrerequisitos=f.listaAlertPrerequisitos.length)},this)})},f.verificarAlertasVacunas=function(){var e={inicio:0,fin:0};""!==e.vacuna&&void 0!==e.vacuna||(e.vacuna=0),be(f.usuario.id_empresa,e).then(function(e){f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():"",f.listaAlertVacunas=e.Vacunas,f.listaAlertVacunas.forEach(function(e,a,o){new Date(e.fecha_ultima_aplicacion);var i=new Date(e.fecha_siguiente_aplicacion);e.DiasVence=f.diasVencidos(i),console.log(e.DiasVence),a==o.length-1&&(f.alertasVacunas=f.listaAlertVacunas.length)},this)})},f.listaAlertasPrerequisitosPaciente=function(e){null!=(f.filtro=e).inicio&&0!=e.inicio&&""!=e.inicio?f.filtro.inicio=e.inicio instanceof Date?e.inicio:new Date(f.convertirFecha(e.inicio)):f.filtro.inicio=0,null!=e.fin&&0!=e.fin&&""!=e.fin?f.filtro.fin=e.fin instanceof Date?e.fin:new Date(f.convertirFecha(e.fin)):f.filtro.fin=0,ve(f.usuario.id_empresa,f.filtro).then(function(e){f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():"";var a=e.Prerequisitos;f.listaAlertPrerequisitos=[],a.forEach(function(e,a,o){new Date(e.fecha_inicio);var i=new Date(e.fecha_vencimiento);e.DiasVence=f.diasVencidos(i),null!=e.fecha_entrega?e.entregado=!0:(e.entregado=!1,e.DiasVence<=e.preRequisito.dias_activacion&&e.DiasVence>=-1*e.preRequisito.dias_activacion&&f.listaAlertPrerequisitos.push(e)),a==o.length-1&&(f.alertasPrerequisitos=f.listaAlertPrerequisitos.length,f.verificarConteoAlertas())},this)})},f.obtenerListaEmpresaVacunas=function(e){null!=(f.filtro=e).inicio&&null!=e.fin&&(0!=e.inicio||""!=e.inicio)?(f.filtro.inicio=e.inicio instanceof Date?e.inicio:new Date(f.convertirFecha(e.inicio)),f.filtro.fin=e.fin instanceof Date?e.fin:new Date(f.convertirFecha(e.fin))):(f.filtro.inicio=0,f.filtro.fin=0),J(f.usuario.id_empresa,f.filtro).then(function(e){f.listaAlertVacunas=e.Vacunas,f.listaAlertVacunas.forEach(function(e){new Date(e.fecha_ultima_aplicacion);var a=new Date(e.fecha_siguiente_aplicacion);e.DiasVence=f.diasVencidos(a).console.log(e.DiasVence)},this)})},f.obtenerListaAlertasVacunas=function(e){null!=(f.filtro=e).inicio&&0!=e.inicio&&""!=e.inicio?f.filtro.inicio=e.inicio instanceof Date?e.inicio:new Date(f.convertirFecha(e.inicio)):f.filtro.inicio=0,null!=e.fin&&0!=e.fin&&""!=e.fin?f.filtro.fin=e.fin instanceof Date?e.fin:new Date(f.convertirFecha(e.fin)):f.filtro.fin=0,null!=e.vacuna&&null!=e.vacuna&&""!=f.filtro.vacuna||(f.filtro.vacuna=0),be(f.usuario.id_empresa,e).then(function(e){f.listaAlertVacunas=e.Vacunas,f.listaAlertVacunas.forEach(function(e){new Date(e.fecha_ultima_aplicacion);var a=new Date(e.fecha_siguiente_aplicacion);e.DiasVence=f.diasVencidos(a),f.alertasVacunas=f.listaAlertVacunas.length,f.verificarConteoAlertas(),console.log(e.DiasVence)},this),f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():""})},f.setDiasActivacionPrerequisitos=function(e){if(n.start(),void 0===f.preRequisito){var a={setDiasTodos:!0,dias_activacion:e};v.save(a,function(e){f.mostrarMensaje(e.mensaje),f.cerrarDialogDialogDiasActivacionPrerequisitos(),f.obtenerAlertas(),n.stop()})}else f.preRequisito.dias_activacion=e,v.save(f.preRequisito,function(e){f.mostrarMensaje(e.mensaje),f.cerrarDialogDialogDiasActivacionPrerequisitos(),f.obtenerAlertas(),n.stop()})},f.setDiasActivacionVacunas=function(e){if(n.start(),void 0===f.vacuna){var a={setDiasTodos:!0,dias_activacion:e};Ce.update(a,function(e){f.mostrarMensaje(e.mensaje),f.cerrarDialogDiasActivacionVacunas(),f.obtenerAlertas(),n.stop()})}else f.vacuna.dias_activacion=e,Ce.update(f.preRequisito,function(e){f.mostrarMensaje(e.mensaje),f.cerrarDialogDiasActivacionVacunas(),f.obtenerAlertas(),n.stop()})},f.abrirDialogDialogDiasActivacionPrerequisitos=function(e){void 0===e?(f.preRequisito=void 0,f.paciente=void 0):f.preRequisito=e,f.abrirPopup(f.idModalDiasActivacionPrerequisitos)},f.cerrarDialogDialogDiasActivacionPrerequisitos=function(){f.cerrarPopup(f.idModalDiasActivacionPrerequisitos)},f.reprogramarPrerequisitos=function(e){if(n.start(),void 0===f.paciente&&void 0===f.preRequisito){var a={reprogramarTodos:!0,fecha_vencimiento:new Date(e)};ge.save(a,function(e){f.mostrarMensaje(e.mensaje),f.cerrarDialogReprogramarPrerequisitos(),f.obtenerAlertas(),n.stop()})}else f.preRequisito.fecha_vencimiento=new Date(f.convertirFecha(e)),f.preRequisito.asignado=!0,ge.save(f.preRequisito,function(e){f.mostrarMensaje(e.mensaje),f.cerrarDialogReprogramarPrerequisitos(),f.obtenerAlertas(),n.stop()})},f.abrirDialogReprogramarPrerequisitos=function(e){void 0===e?(f.preRequisito=void 0,f.paciente=void 0):f.preRequisito=e,f.abrirPopup(f.idModalReprogramarPrerequisitos)},f.cerrarDialogReprogramarPrerequisitos=function(){f.cerrarPopup(f.idModalReprogramarPrerequisitos)},f.abrirDialogAlertVacunas=function(){f.obtenerListaAlertasVacunas({inicio:0,fin:0}),f.abrirPopup(f.idModalAlertVacunas)},f.cerrarDialogAlertVacunas=function(){f.cerrarPopup(f.idModalAlertVacunas)},f.abrirDialogDiasActivacionVacunas=function(e){f.vacuna=void 0===e?void 0:e,f.abrirPopup(f.idModalDiasActivacionVacunas)},f.cerrarDialogDiasActivacionVacunas=function(){f.cerrarPopup(f.idModalDiasActivacionVacunas)},f.abrirDialogReprogramarVacunas=function(){f.abrirPopup(f.idModalReprogramarVacunas)},f.cerrarDialogReprogramarVacunas=function(){f.cerrarPopup(f.idModalReprogramarVacunas)},f.cerrarIdModalDialogLaboratorioExamenesHistoricoResultados=function(){f.cerrarPopup(f.IdModalDialogLaboratorioExamenHistoricoResultado)},f.cerrarIdModalDialogDiagnosticoExamenesHistoricoResultados=function(){f.cerrarPopup(f.IdModalDialogDiagnosticoExamenHistoricoResultado)},f.cerrarIdModalDialogNuevoLaboratorio=function(){f.cerrarPopup(f.IdModalDialogNuevoLaboratorio)},f.cerrarIdModalDialogLaboratorioExameneHistoricoPreview=function(){f.cerrarPopup(f.IdModalDialogLaboratorioExamenHistoricoPreview)},f.cerrarIdModalDialogLaboratorioExamenesNuevoResultado=function(){f.cerrarPopup(f.IdModalDialogLaboratorioExamenesNuevoResultado)},f.cerrarIdModalDialogLaboratorioExamenes=function(){f.cerrarPopup(f.IdModalDialogLaboratorioExamenes)},f.cerrarPopUpExamenLaboratorio=function(){f.cerrarPopup(f.IdModalDialogLaboratorioExamen)},f.cerrarPopUpVacunaNueva=function(){f.vacunaDosis=[],setTimeout(function(){f.obtenerVacunas(),setTimeout(function(){f.verificarAsignacionVacunas()},1e3)},1e3),f.dosis={},f.dosisEdit=!1,f.cerrarPopup(f.idModalDialogVacunaEdicion)},f.cerrarPopUpVacunasConfig=function(){f.paciente.vacunas=[],M(f.paciente).then(function(e){f.paciente.vacunas=e,f.paciente.vacunas.forEach(function(e){var a=new Date;e.fechaAplicacionVacuna_texto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),e.button_clicked=!1},this)}),f.limpiarAsignacionVacunas(),f.verificarAsignacionVacunas(),f.obtenerAlertas(),f.cerrarPopup(f.idModalDialogVacunasConfig)},f.cerrarPopUpIdModalFichaTecnica=function(){f.cerrarPopup(f.idModalFichaTecnica)},f.cerrarPopUpConsulta=function(){f.cerrarPopup(f.idModalDialogConsulta)},f.cerrarPopUpPreRequisitos=function(){f.obtenerAlertas(),f.cerrarPopup(f.IdModalDialogPreRequisitos)},f.cerrarIdModalDialogLaboratorio=function(){f.cerrarPopup(f.IdModalDialogLaboratorio)},f.cerrarPopPupVacunas=function(){f.filtroHistorialVacunas=[],f.obtenerAlertas(),f.cerrarPopup(f.idModalDialogVacunas)},f.cerrarPopPupVacunasConfig=function(){f.obtenerAlertas(),f.cerrarPopup(f.idModalDialogVacunasConfig)},f.crearNuevaConsulta=function(e){var a=(new Date).getDate()+"/"+((new Date).getMonth()+1)+"/"+(new Date).getFullYear();f.horaConsulta=(new Date).getHours()+":"+(new Date).getMinutes();var o=12<=(new Date).getHours()?"PM":"AM";f.consulta={id_paciente:e.id,fecha:a+" "+f.horaConsulta+" "+o},f.paciente=e;A(f.paciente.id,{inicio:0,fin:0}).then(function(e){f.consultas=e.consultas,f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():""}),f.abrirPopup(f.idModalDialogConsulta)},f.EliminarNuevoLaboratorio=function(e){de(f.paciente.id_empresa,e).then(function(e){f.ObtenerMedicoLaboratorios(f.paciente),f.mostrarMensaje(e.message)})},f.guardarNuevoLaboratorio=function(e){e.$valid&&(f.laboratorio.id?re(f.paciente.id_empresa,f.laboratorio).then(function(e){f.cerrarIdModalDialogNuevoLaboratorio(),f.ObtenerMedicoLaboratorios(f.paciente),f.mostrarMensaje(e.message)}):V(f.paciente.id_empresa,f.laboratorio).then(function(e){f.cerrarIdModalDialogNuevoLaboratorio(),f.ObtenerMedicoLaboratorios(f.paciente),f.mostrarMensaje(e.message)}))},f.ObtenerMedicoLaboratorios=function(e){N(e.id_empresa).then(function(e){f.listaLaboratorios=e})},f.guardarNuevoLaboratorioExamen=function(e){e.$valid&&(f.examen.id?ne(f.laboratorio.id,f.examen).then(function(e){f.cerrarIdModalDialogLaboratorioExamenesNuevoResultado(),f.ObtenerMedicoLaboratorioExamenes(f.laboratorio),f.mostrarMensaje(e.message)}):H(f.laboratorio.id,f.examen).then(function(e){f.cerrarIdModalDialogLaboratorioExamenesNuevoResultado(),f.ObtenerMedicoLaboratorioExamenes(f.laboratorio),f.mostrarMensaje(e.message)}))},f.EliminarNuevoLaboratorioExamen=function(e){ue(f.laboratorio.id,e).then(function(e){f.ObtenerMedicoLaboratorioExamenes(f.laboratorio),f.mostrarMensaje(e.message)})},f.ObtenerMedicoLaboratorioExamenes=function(e){promesa=B(e.id),promesa.then(function(e){f.listaLaboratorioExamenes=e})},f.guardarLaboratorioExamenResultados=function(e,a){if(e.$valid){var o={fecha:new Date(f.convertirFecha(a)),examenes:f.listaLaboratorioExamenes};promesa=z(f.laboratorio.id,f.paciente.id,o),promesa.then(function(e){f.cerrarIdModalDialogLaboratorioExamenes(),f.ObtenerMedicoLaboratorioExamenes(f.laboratorio),f.mostrarMensaje(e.message)})}},f.ObtenerHistorialLaboratorioExamenes=function(e){null!=e.inicio&&(0!=e.inicio||""!=e.inicio)?f.filtro.inicio=e.inicio instanceof Date?e.inicio:new Date(f.convertirFecha(e.inicio)):f.filtro.inicio=0,null!=e.fin&&(0!=e.fin||""!=e.fin)?f.filtro.fin=e.fin instanceof Date?e.fin:new Date(f.convertirFecha(e.fin)):f.filtro.fin=0,promesa=L(f.laboratorio.id,f.paciente.id,f.filtro),promesa.then(function(e){f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():"",f.listaHistorialLaboratorioExamenes=e})},f.ObtenerHistorialFichaMedica=function(e){null!=e.inicio&&(0!=e.inicio||""!=e.inicio)?f.filtro.inicio=e.inicio instanceof Date?e.inicio:new Date(f.convertirFecha(e.inicio)):f.filtro.inicio=0,null!=e.fin&&(0!=e.fin||""!=e.fin)?f.filtro.fin=e.fin instanceof Date?e.fin:new Date(f.convertirFecha(e.fin)):f.filtro.fin=0,null==e.tipo_control&&(e.tipo_control=0),promesa=te(f.paciente.id,e),promesa.then(function(e){f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():"",f.listaHistorialfichaMEdica=e})},f.eliminarDiagnostico=function(e){me(f.paciente.id_empresa,e).then(function(e){f.ObtenerMedicoDiagnostico(f.paciente),f.mostrarMensaje(e.message)})},f.guardarNuevoDiagnostico=function(e){e.$valid&&(f.diagnostico.id?(promesa=se(f.paciente.id_empresa,f.diagnostico),promesa.then(function(e){f.cerrarDialogDiagnosticoNuevo(),f.ObtenerMedicoDiagnostico(f.paciente),f.mostrarMensaje(e.message)})):(promesa=k(f.paciente.id_empresa,f.diagnostico),promesa.then(function(e){f.cerrarDialogDiagnosticoNuevo(),f.ObtenerMedicoDiagnostico(f.paciente),f.mostrarMensaje(e.message)})))},f.ObtenerMedicoDiagnostico=function(e){promesa=U(e.id_empresa),promesa.then(function(e){f.listaDiagnosticos=e})},f.guardarNuevoDiagnosticoExamen=function(e){e.$valid&&(f.examen.id?(promesa=ce(f.diagnostico.id,f.examen),promesa.then(function(e){f.cerrarDialogNuevoExamenDiagnostico(),f.ObtenerMedicoDiagnosticoExamenes(f.diagnostico),f.mostrarMensaje(e.message)})):(promesa=y(f.diagnostico.id,f.examen),promesa.then(function(e){f.cerrarDialogNuevoExamenDiagnostico(),f.ObtenerMedicoDiagnosticoExamenes(f.diagnostico),f.mostrarMensaje(e.message)})))},f.eliminarNuevoDiagnosticoExamen=function(e){pe(f.diagnostico.id,e).then(function(e){f.ObtenerMedicoDiagnosticoExamenes(f.diagnostico),f.mostrarMensaje(e.message)})},f.ObtenerMedicoDiagnosticoExamenes=function(e){promesa=G(e.id),promesa.then(function(e){f.listaDiagnosticosExamenes=e})},f.guardarDiagnosticoExamenResultados=function(e,a){if(e.$valid){var o={fecha:new Date(f.convertirFecha(a)),examenes:f.listaDiagnosticosExamenes};promesa=Y(f.diagnostico.id,f.paciente.id,o),promesa.then(function(e){f.cerrarDialogExamenesDiagnostico(),f.ObtenerMedicoDiagnosticoExamenes(f.diagnostico),f.mostrarMensaje(e.message)})}},f.ObtenerHistorialDiagnosticoExamenes=function(e){null!=e.inicio&&(0!=e.inicio||""!=e.inicio)?f.filtro.inicio=e.inicio instanceof Date?e.inicio:new Date(f.convertirFecha(e.inicio)):f.filtro.inicio=0,null!=e.fin&&(0!=e.fin||""!=e.fin)?f.filtro.fin=e.fin instanceof Date?e.fin:new Date(f.convertirFecha(e.fin)):f.filtro.fin=0,promesa=q(f.diagnostico.id,f.paciente.id,f.filtro),promesa.then(function(e){f.filtro.inicio=f.filtro.inicio instanceof Date?f.filtro.inicio.getDate()+"/"+(f.filtro.inicio.getMonth()+1)+"/"+f.filtro.inicio.getFullYear():"",f.filtro.fin=f.filtro.fin instanceof Date?f.filtro.fin.getDate()+"/"+(f.filtro.fin.getMonth()+1)+"/"+f.filtro.fin.getFullYear():"",f.listaHistorialDiagnosticoExamenes=e})},f.fecha_excel_angular=function(e){var a=new Date(1/1970),o=e-25568;return a.setTime(a.getTime()+864e5*o)},f.subirExcelPacientes=function(e){n.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.apellido_paterno=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.apellido_materno=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.nombres=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.ci=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.extension=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.grupo_sanguineo=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.fecha_nacimiento=null!=r["H"+t]&&""!=r["H"+t]?f.fecha_excel_angular(r["H"+t].v.toString()):null,s.genero=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,s.telefono=null!=r["J"+t]&&""!=r["J"+t]?r["J"+t].v.toString():null,s.telefono2=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,s.telefono_movil=null!=r["L"+t]&&""!=r["L"+t]?r["L"+t].v.toString():null,s.estilo_de_vida=null!=r["M"+t]&&""!=r["M"+t]?r["M"+t].v.toString():null,s.cargo=null!=r["N"+t]&&""!=r["N"+t]?r["N"+t].v.toString():null,s.designacion_empresa=null!=r["O"+t]&&""!=r["O"+t]?r["O"+t].v.toString():null,s.telefono_empresa=null!=r["P"+t]&&""!=r["P"+t]?r["P"+t].v.toString():null,s.campamento=null!=r["Q"+t]&&""!=r["Q"+t]?r["Q"+t].v.toString():null,s.riesgos_procesos_trabajo=null!=r["R"+t]&&""!=r["R"+t]?r["R"+t].v.toString():null,s.ciudad_referencia=null!=r["S"+t]&&""!=r["S"+t]?r["S"+t].v.toString():null,s.zona_referencia=null!=r["T"+t]&&""!=r["T"+t]?r["T"+t].v.toString():null,s.calle_av_referencia=null!=r["U"+t]&&""!=r["U"+t]?r["U"+t].v.toString():null,s.nro_referencia=null!=r["V"+t]&&""!=r["V"+t]?r["V"+t].v.toString():null,s.telefonos_referencia=null!=r["W"+t]&&""!=r["W"+t]?r["W"+t].v.toString():null,s.celular_referencia=null!=r["X"+t]&&""!=r["X"+t]?r["X"+t].v.toString():null,s.nombre_referencia=null!=r["Y"+t]&&""!=r["Y"+t]?r["Y"+t].v.toString():null,s.imagen="img/icon-user-default.png",n.push(s),t++,0,console.log}while(null!=r["A"+t]);f.guardarPacientes(n)},t.readAsBinaryString(o)}},f.guardarPacientes=function(e){new W({pacientes:e,id_empresa:f.usuario.id_empresa}).$save(function(e){f.mostrarMensaje(e.mensaje),f.recargarItemsTabla()}),n.stop()},f.subirExcelFichasTecnicas=function(e){n.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.fecha=null!=r["G"+t]&&""!=r["G"+t]?new Date(f.convertirFecha(r["G"+t].v.toString())):null,s.estilo_vida=null!=r["L"+t]&&""!=r["L"+t]?r["L"+t].v.toString():null,s.empresa=null!=r["M"+t]&&""!=r["M"+t]?r["M"+t].v.toString():null,s.telefono=null!=r["N"+t]&&""!=r["N"+t]?r["N"+t].v.toString():null,s.area_operacion=null!=r["O"+t]&&""!=r["O"+t]?r["O"+t].v.toString():null,s.actividad_laboral=null!=r["P"+t]&&""!=r["P"+t]?r["P"+t].v.toString():null,s.riesgo=null!=r["Q"+t]&&""!=r["Q"+t]?r["Q"+t].v.toString():null,s.ciudad_referencia=null!=r["R"+t]&&""!=r["R"+t]?r["R"+t].v.toString():null,s.zona_referencia=null!=r["S"+t]&&""!=r["S"+t]?r["S"+t].v.toString():null,s.calle_av_referencia=null!=r["T"+t]&&""!=r["T"+t]?r["T"+t].v.toString():null,s.numero_referencia=null!=r["U"+t]&&""!=r["U"+t]?r["U"+t].v.toString():null,s.telefono_referencia=null!=r["V"+t]&&""!=r["V"+t]?r["V"+t].v.toString():null,s.celular_referencia=null!=r["W"+t]&&""!=r["W"+t]?r["W"+t].v.toString():null,s.nombre_referencia=null!=r["X"+t]&&""!=r["X"+t]?r["X"+t].v.toString():null,s.tipo_control=null!=r["Y"+t]&&""!=r["Y"+t]?r["Y"+t].v.toString():null,s.grupo_sanguineo=null!=r["Z"+t]&&""!=r["Z"+t]?r["Z"+t].v.toString():null,s.alergia_humo_cigarrillo=null!=r["AA"+t]&&""!=r["AA"+t]&&"NO"!=r["AA"+t].v.toString(),s.alergia_quimico=null!=r["AB"+t]&&""!=r["AB"+t]&&"NO"!=r["AB"+t].v.toString(),s.alergia_medicamento=null!=r["AC"+t]&&""!=r["AC"+t]&&"NO"!=r["AC"+t].v.toString(),s.alergia_plantas=null!=r["AD"+t]&&""!=r["AD"+t]&&"NO"!=r["AD"+t].v.toString(),s.alergia_polvo=null!=r["AE"+t]&&""!=r["AE"+t]&&"NO"!=r["AE"+t].v.toString(),s.alergia_algun_material=null!=r["AF"+t]&&""!=r["AF"+t]&&"NO"!=r["AF"+t].v.toString(),s.alergia_alimentos=null!=r["AG"+t]&&""!=r["AG"+t]&&"NO"!=r["AG"+t].v.toString(),s.alergia_conservas=null!=r["AH"+t]&&""!=r["AH"+t]&&"NO"!=r["AH"+t].v.toString(),s.alergia_picadura=null!=r["AI"+t]&&""!=r["AI"+t]&&"NO"!=r["AI"+t].v.toString(),s.alergia_otros=null!=r["AJ"+t]&&""!=r["AJ"+t]&&"NO"!=r["AJ"+t].v.toString(),s.alergia_otros_comentario=null!=r["AL"+t]&&""!=r["AL"+t]?r["AL"+t].v.toString():null,s.enfermedad_hipertension=null!=r["AL"+t]&&""!=r["AL"+t]&&"NO"!=r["AL"+t].v.toString(),s.enfermedad_diabetes=null!=r["AM"+t]&&""!=r["AM"+t]&&"NO"!=r["AM"+t].v.toString(),s.enfermedad_epilepsia=null!=r["AN"+t]&&""!=r["AN"+t]&&"NO"!=r["AN"+t].v.toString(),s.enfermedad_asma=null!=r["AO"+t]&&""!=r["AO"+t]&&"NO"!=r["AO"+t].v.toString(),s.enfermedad_cardiologia=null!=r["AP"+t]&&""!=r["AP"+t]&&"NO"!=r["AP"+t].v.toString(),s.enfermedad_digestivas=null!=r["AQ"+t]&&""!=r["AQ"+t]&&"NO"!=r["AQ"+t].v.toString(),s.enfermedad_chagas=null!=r["AR"+t]&&""!=r["AR"+t]&&"NO"!=r["AR"+t].v.toString(),s.enfermedad_hepatitis=null!=r["AS"+t]&&""!=r["AS"+t]&&"NO"!=r["AS"+t].v.toString(),s.enfermedad_lumbalgia=null!=r["AT"+t]&&""!=r["AT"+t]&&"NO"!=r["AT"+t].v.toString(),s.enfermedad_otros=null!=r["AU"+t]&&""!=r["AU"+t]&&"NO"!=r["AU"+t].v.toString(),s.enfermedad_comentario=null!=r["AV"+t]&&""!=r["AV"+t]?r["AV"+t].v.toString():null,s.quirurgico_operado=null!=r["AW"+t]&&""!=r["AW"+t]&&"NO"!=r["AW"+t].v.toString(),s.quirurgico_comentario=null!=r["AX"+t]&&""!=r["AX"+t]?r["AX"+t].v.toString():null,s.es_donante=null!=r["AY"+t]&&""!=r["AY"+t]&&"NO"!=r["AY"+t].v.toString(),s.fecha=new Date(s.fecha),n.push(s),t++,0}while(null!=r["A"+t]);f.guardarfichasTecnicas(n)},t.readAsBinaryString(o)}},f.guardarfichasTecnicas=function(e){new X({fichas:e,id_empresa:f.usuario.id_empresa}).$save(function(e){f.mostrarMensaje(e.mensaje),f.recargarItemsTabla()},function(e){f.mostrarMensaje("Ocurrio un problema al momento de guardar!"),f.recargarItemsTabla()}),n.stop()},f.subirExcelSignosVitales=function(e){n.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.fecha=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.presion=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,s.pulso=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,s.talla=null!=r["J"+t]&&""!=r["J"+t]?Math.round(parseFloat(r["J"+t].v.toString()),4):null,s.peso=null!=r["K"+t]&&""!=r["K"+t]?Math.round(parseFloat(r["K"+t].v.toString()),4):null,s.temperatura=null!=r["L"+t]&&""!=r["L"+t]?Math.round(parseFloat(r["L"+t].v.toString()),3):null,s.frecuencia_respiratoria=null!=r["M"+t]&&""!=r["M"+t]?r["M"+t].v.toString():null,s.fecha=new Date(s.fecha),n.push(s),t++,0}while(null!=r["A"+t]);f.guardarSignosVitales(n)},t.readAsBinaryString(o)}},f.guardarSignosVitales=function(e){new K({signosVitales:e,id_empresa:f.usuario.id_empresa}).$save(function(e){f.mostrarMensaje(e.mensaje),f.recargarItemsTabla()},function(e){f.mostrarMensaje("Ocurrio un problema al momento de guardar!"),f.recargarItemsTabla()}),n.stop()},f.guardarPacientes=function(e){new W({pacientes:e,id_empresa:f.usuario.id_empresa}).$save(function(e){f.mostrarMensaje(e.mensaje),f.recargarItemsTabla()},function(e){f.mostrarMensaje("Ocurrio un problema al momento de guardar!"),f.recargarItemsTabla()}),n.stop()},f.subirExcelSOAP=function(e){n.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.fecha=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.subjetivo=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.objetivo=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,s.analitico=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,s.plan=null!=r["J"+t]&&""!=r["J"+t]?r["J"+t].v.toString():null,s.evolucion=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,s.fecha=new Date(s.fecha),n.push(s),t++,0}while(null!=r["A"+t]);f.guardarSOAPLista(n)},t.readAsBinaryString(o)}},f.guardarSOAPLista=function(e){new Z({SOAPLista:e,id_empresa:f.usuario.id_empresa}).$save(function(e){f.mostrarMensaje(e.mensaje),f.recargarItemsTabla()},function(e){f.mostrarMensaje("Ocurrio un problema al momento de guardar!"),f.recargarItemsTabla()}),n.stop()},f.subirExcelVacunasPacientes=function(e){n.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.nombre_vacuna=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.dosis=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.fecha=null!=r["H"+t]&&""!=r["H"+t]?f.fecha_excel_angular(r["H"+t].v.toString()):null,s.Estado=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);f.guardarAplicacionVacunas(n)},t.readAsBinaryString(o)}},f.guardarAplicacionVacunas=function(e){new Q({pacientes:e,id_empresa:f.usuario.id_empresa}).$save(function(e){f.mostrarMensaje(e.mensaje),f.recargarItemsTabla()},function(e){f.mostrarMensaje("Ocurrio un problema al momento de guardar!"),f.recargarItemsTabla()}),n.stop()},f.inicio()}]),angular.module("agil.controladores").controller("ControladorPantallaCliente",["$scope","$localStorage","$location","$templateCache","$route","blockUI","$timeout","Clases","ProductosPanel","socket",function(i,e,a,o,t,r,n,s,c,l){r.start(),i.usuario=JSON.parse(e.usuario),i.idModalPantallaCliente="dialog-pantalla-cliente",i.idModalPregunta="dialog-pregunta-video",i.idImagenPromocion1="imagen-promocion1",aplicarVisorImagenArchivo(i.idImagenPromocion1),aplicarVisorImagenArchivo("imagen-promocion2"),aplicarVisorImagenArchivo("imagen-promocion3"),i.idModalImagenesPromociones="dialog-imagenes-promociones",i.cargarPromociones=function(){i.imagen1=localStorage.getItem("imagen1"),i.imagen2=localStorage.getItem("imagen2"),i.imagen3=localStorage.getItem("imagen3")},i.saveForm=function(e){e.imagen1&&localStorage.setItem("imagen1",e.imagen1),e.imagen2&&localStorage.setItem("imagen2",e.imagen2),e.imagen3&&localStorage.setItem("imagen3",e.imagen3),i.cerrarAbrirModalImagenesPromociones(),i.mostrarMensaje("Guardado Exitosamente!"),i.cargarPromociones()},i.cargarPromociones(),$("#myCarousel").carousel({interval:4e3}),$("[id^=carousel-selector-]").click(function(){var e=$(this).attr("id"),a=e.substr(e.length-1);a=parseInt(a),$("#myCarousel").carousel(a),$("[id^=carousel-selector-]").removeClass("selected"),$(this).addClass("selected")}),$("#myCarousel").on("slid",function(e){var a=$(".item.active").data("slide-number");a=parseInt(a),$("[id^=carousel-selector-]").removeClass("selected"),$("[id=carousel-selector-"+a+"]").addClass("selected")}),i.inicio=function(){i.configuracionSockets(),i.Math=Math},i.abrirPantallaCliente=function(){i.abrirPopup(i.idModalPregunta)},i.abrirAbrirModalImagenesPromociones=function(){i.abrirPopup(i.idModalImagenesPromociones)},i.cerrarAbrirModalImagenesPromociones=function(){i.cerrarPopup(i.idModalImagenesPromociones)},i.mostrarVideoPantalla=function(e){i.mostrarProductos=!0,e?i.mostrarVideo=!0:(i.mostrarVideo=!1,i.cargarProductos()),i.cerrarPopup(i.idModalPregunta),i.abrirPopup(i.idModalPantallaCliente)},i.configuracionSockets=function(){l.on("mostrarVenta",function(e){for(var a=0,o=!1;a<i.usuario.empresa.sucursales.length&&!o;)i.usuario.empresa.sucursales[a].id==e.sucursal.id&&(o=!0,i.venta=e,i.mostrarProductos=!1),a++}),l.on("mostrarProductos",function(e){for(var a=0,o=!1;a<i.usuario.empresa.sucursales.length&&!o;)i.usuario.empresa.sucursales[a].id==e.id&&(o=!0,i.mostrarProductos=!0),a++})},i.cargarProductos=function(){c(i.usuario.id_empresa,i.usuario.sucursalesUsuario[0].sucursal.almacenes[0].id).then(function(e){for(var a=0;a<e.length;a++)e[a].inventario_disponible=i.obtenerInventarioTotal(e[a]);i.productos=e,i.productosProcesados=e,setTimeout(function(){aplicarSwiper(6,4,!0,2),$("#productos h3").css({color:"white"}),$("#productos label").css({color:"#3596EA"})},500)})},i.obtenerInventarioTotal=function(e){for(var a=0,o=0;o<e.inventarios.length;o++)a+=e.inventarios[o].cantidad;return a},i.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsPantallaCliente(i.idModalPantallaCliente,i.idModalPregunta,i.idModalImagenesPromociones),i.buscarAplicacion(i.usuario.aplicacionesUsuario,a.path().substring(1)),r.stop()}),i.$on("$routeChangeStart",function(e,a){i.eliminarPopup(i.idModalPantallaCliente),i.eliminarPopup(i.idModalPregunta)}),i.inicio()}]).controller("ControladorPantallaDespacho",["$scope","$localStorage","$location","$templateCache","$route","blockUI","$timeout","Clases","VentasNoDespachadasLista","DespachoVenta",function(o,e,a,i,t,r,n,s,c,l){r.start(),o.usuario=JSON.parse(e.usuario),o.idModalPantallaDespacho="dialog-pantalla-despacho",o.inicio=function(){},o.abrirPantallaDespacho=function(){o.abrirPopup(o.idModalPantallaDespacho),o.cargarPedidos()},o.cargarPedidos=function(){c(o.usuario.empresa.sucursales[0].id).then(function(e){o.ventas=e,setTimeout(function(){aplicarSwiper(6,4,!0,2),$("#productos .swiper-slide").addClass("btn-warning"),$("#productos h3").css({color:"white"}),$("#productos label").css({color:"#3596EA"})},500)})},o.emitirSonido=function(e){new Audio("sound/"+e.pedido+".wav").play()},o.despacharVenta=function(e){l.update({id_venta:e.id},e,function(e){o.cargarPedidos(),o.mostrarMensaje(e.mensaje)})},o.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsPantallaDespacho(o.idModalPantallaDespacho),o.buscarAplicacion(o.usuario.aplicacionesUsuario,a.path().substring(1)),r.stop()}),o.$on("$routeChangeStart",function(e,a){o.eliminarPopup(o.idModalPantallaDespacho)}),o.inicio()}]),angular.module("agil.controladores").controller("ControladorPedidos",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","blockUI","ClasesTipo","socket","Paginator","PedidosFiltro","ListaGruposProductoUsuario","ProveedoresNit","ListaProductosEmpresaUsuario","GuardarPedido","ListaProveedores","InventarioPaginador","ProductosPaginador","ListaProductosProveedores","ActualizarProductosProveedor","ListaSubGruposProductoEmpresa","ProductosPaginadorSubgrupos","ProductosPaginadorAsignados",function(m,a,e,o,i,t,r,n,f,s,c,l,d,u,p,g,v,h,b,C,P,_,M,D,E){m.usuarioSesion=JSON.parse(n.usuario),convertUrlToBase64Image(m.usuarioSesion.empresa.imagen,function(e){m.usuarioSesion.empresa.imagen=e}),m.idDialogNuevoPedido="modal-nuevo-pedido",m.idDialogProductosProveedor="dialog-productos-proveedor-configuracion",m.idDialogBusquedaProveedor="dialog-Busqueda-proveedor",m.idDialogProductosAsigandosProveedor="dialog-productos-proveedor-asignados",m.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsPedidos(m.idDialogNuevoPedido,m.idDialogProductosProveedor,m.idDialogBusquedaProveedor,m.idDialogProductosAsigandosProveedor),m.buscarAplicacion(m.usuarioSesion.aplicacionesUsuario,t.path().substring(1))}),m.$on("$routeChangeStart",function(e,a){m.eliminarPopup(m.idDialogListadoPedido),m.eliminarPopup(m.idDialogProductosProveedor),m.eliminarPopup(m.idDialogNuevoPedido),m.eliminarPopup(m.idDialogBusquedaProveedor),m.eliminarPopup(m.idDialogProductosAsigandosProveedor)}),m.inicio=function(){m.imprimir={detalle:!1},m.listaProductosProveedor=[],m.seleccionProductosProveedor={seleccionar_todos:!1},m.seleccionProductosProveedorAsignados={seleccionar_todos:!1},m.productosAsignadosPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},m.configuracionPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},m.detallesPedido=[],m.mostarBusquedaProducto=!1,m.ordenProductos=!0,m.esContado=!0,m.alreadyCalculated=!1,m.sucursalesUsuario="";for(var e=0;e<m.usuarioSesion.sucursalesUsuario.length;e++)m.sucursalesUsuario=m.sucursalesUsuario+m.usuarioSesion.sucursalesUsuario[e].sucursal.id,e+1!=m.usuarioSesion.sucursalesUsuario.length&&(m.sucursalesUsuario=m.sucursalesUsuario+",");m.obtenerProveedores(),m.obtenerProductos(),m.obtenerProductosAsignados(),m.filtro={desde:0,hasta:0,tipo:0,proveedor:0,nit:"",sucursal:0,estado:0,id_usuario:""},m.obtenerPaginador(),m.sucursales=m.obtenerSucursales(),m.obtenerSubGruposProductosEmpresaUsuario()},m.obtenerSubGruposProductosEmpresaUsuario=function(){f.start(),M(m.usuarioSesion.id_empresa,m.usuarioSesion.id).then(function(e){f.stop(),0<e.length?m.subGruposProducto=e:(m.subGruposProducto=[],m.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){m.subGruposProducto=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";m.mostrarMensaje(a),f.stop()})},m.obtenerProveedores=function(){h(m.usuarioSesion.id_empresa).then(function(e){m.proveedores=e.proveedores,m.proveedoresProcesado=e.proveedores}).catch(function(e){m.proveedores=[];var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";m.mostrarMensaje(a)})},m.filtrarProveedores=function(e){void 0!==m.proveedores?m.proveedoresProcesado=a("filter")(m.proveedores,e):m.proveedoresProcesado=[]},m.establecerProveedor=function(e,a){void 0===m.pedido&&(m.pedido={}),m.pedido.proveedor=e,m.productosAsignadosProveedor=[],m.paginatorProductosAsignados.setPages(1),void 0!==a&&m.cerrarModalBusquedaProveedor(),m.pedido.por_proveedor&&m.generarPorProveedor()},m.checkProveedor=function(e){return!!m.pedido&&!!m.pedido.proveedor},m.buscarProveedor=function(e){if(""!=e&&null!=e)return p(m.usuario.id_empresa,e)},m.establecerProducto=function(e,a){m.detallePedido={},e.tipoProducto=null==e.tipoProducto?{id:e["tipoProducto.id"],nombre:e["tipoProducto.nombre"],nombre_corto:e["tipoProducto.nombre_corto"]}:e.tipoProducto;var o=0;0<e.inventarios.length&&e.inventarios.forEach(function(e){o+=e.cantidad}),m.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,inventario_disponible:o}},m.guardarPedido=function(e){if(f.start(),void 0!==e&&0<m.detallesPedido.length){var a=new Date,o=e.fecha.split("/").reverse(),i={fecha:new Date(o[0],o[1]-1,o[2],a.getHours(),a.getMinutes()),sucursal:e.sucursal,almacen:e.almacen,proveedor:e.proveedor.id,observacion:e.observacion,grupo:void 0!==e.grupo&&null!==e.grupo?e.grupo:0,detallesPedido:m.detallesPedido,usuario:m.usuarioSesion.id};v(m.usuario.id_empresa,i,m.usuarioSesion.id).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.mostrarMensaje(e.mensaje),m.recargarItemsTabla()),f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";m.mostrarMensaje(a)})}else 0<m.detallesPedido.length?m.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar!"):m.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar sin lista de productos!"),f.stop()},m.mostrarBusqueda=function(){m.mostarBusquedaProducto?m.mostarBusquedaProducto=!1:m.mostarBusquedaProducto=!0},m.agregardetallePedido=function(a){null!=a?(m.detallesPedido.some(function(e){return e.producto.id===a.producto.id})?m.detallesPedido.forEach(function(e){e.producto.id===a.producto.id&&(e.cantidad+=a.cantidad)}):m.detallesPedido.push(a),m.detallePedido=void 0):m.mostrarMensaje("Ocurrió un problema, no se puede agregar un valor no definido o nulo.")},m.interceptarTecla=function(e,a,o){13===e.which&&(o?m.enfocar(a):$timeout(function(){$("#"+a).trigger("click")},0))},m.filtrarFiltro=function(e,a,o){if(void 0!==o)for(var i in e)0==e[i]&&(e[i]="");else for(var i in e)""!==e[i]&&null!==e[i]&&void 0!==e[i]||(e[i]=0);if(void 0!==a&&a)return e;m.obtenerPedidos()},m.obtenerPaginador=function(){f.start(),m.paginator=l(),m.paginator.column="fecha",m.paginator.direccion="asc",m.paginator.itemPerPage=10,m.paginator.page=1,m.filtro={desde:0,hasta:0,tipo:0,proveedor:0,nit:"",sucursal:0,estado:0,usuario:""},m.paginator.callBack=m.obtenerPedidos,m.paginator.getSearch(""),f.stop()},m.obtenerPedidos=function(){f.start(),m.filtro=m.filtrarFiltro(m.filtro,!0),m.paginator.filter=m.filtro,d(m.usuarioSesion.id_empresa,m.paginator).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.listaPedidos=e.pedidos,m.paginator.setPages(e.paginas)),m.filtro=m.filtrarFiltro(m.filtro,!0,!0),f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";m.mostrarMensaje(a)})},m.obtenerSucursales=function(){for(var e=[],a=0;a<m.usuarioSesion.sucursalesUsuario.length;a++)e.push(m.usuarioSesion.sucursalesUsuario[a].sucursal);return e},m.obtenerAlmacenes=function(a){if(void 0===a&&(m.filtro.sucursal=void 0,m.almacenes=[]),void 0!==a){m.almacenes=[];var e=$.grep(m.sucursales,function(e){return e.id==a})[0];m.almacenes=e?e.almacenes:[]}},m.eliminar=function(o){m.solicitud=o,m.solicitud.solicitudesProductos.map(function(a){ListaInventariosProducto(a.productoSolicitado.id,m.solicitud.almacen.id).then(function(e){a.inventarios=e,a.inventario_disponible_utilizado=a.cantidad,m.solicitud.solicitudesProductos.indexOf(a)==m.solicitud.solicitudesProductos.length-1&&EliminarSolicitudReposicion.save({id_solicitud:o.id},o,function(e){m.mostrarMensaje(e.mensaje),m.recargarItemsTabla(),m.solicitud=void 0,f.stop()},function(e){m.solicitud=void 0,m.mostrarMensaje(err.stack?err.stack:err.message),f.stop()})})}),m.cerrarConfirmacionEliminacion()},m.ver=function(e){},m.interceptarTecla=function(e,a,o){13===e.which&&(o?m.enfocar(a):$timeout(function(){$("#"+a).trigger("click")},0))},m.editar=function(e){},m.sinFuncionalidad=function(){m.mostrarMensaje("Sin funcionalidad")},m.generarPdfSolicitud=function(e){f.start(),m.calcularTotalViveres(e);var a=new PDFDocument({size:[612,792],margin:10,compress:!1}),o=a.pipe(blobStream());(t=(i=new Date).getMinutes())<10&&(t="0"+t),a.font("Helvetica",8);var i,t,r=115,n=0,s=1,c=Math.ceil(m.totalViveresSolicitados.length/29);m.dibujarCabeceraPDFSolicitud(a,s,c);for(var l=0;l<m.totalViveresSolicitados.length&&n<=29;l++)a.font("Helvetica",8),a.text(l+1,65,r),a.text(m.totalViveresSolicitados[l].productoSolicitudBase.codigo,100,r),a.text(m.totalViveresSolicitados[l].productoSolicitudBase.nombre,220,r),a.text(m.totalViveresSolicitados[l].productoSolicitudBase.unidad_medida,400,r),a.text(m.totalViveresSolicitados[l].totalMostrar.toFixed(2),500,r),r+=20,29<++n&&(a.rect(40,105,540,r-115).stroke(),a.text(s+"/"+c,570,r+15),a.font("Helvetica",6),a.text("RESPONSABLE: "+m.usuarioSesion.nombre_usuario,45,r+10),a.text("SOLICITANTE: "+m.totalViveresSolicitados.usuario.persona.nombre_completo,345,r+10),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,r+10),a.addPage({size:[612,792],margin:10}),r=115,n=0,s+=1,m.dibujarCabeceraPDFSolicitud(a,s,c));a.rect(40,105,540,r-115).stroke(),(t=(i=new Date).getMinutes())<10&&(t="0"+t),a.text(s+"/"+c,570,r+15),a.font("Helvetica",6),a.text("RESPONSABLE: "+m.usuarioSesion.nombre_usuario,45,r+5),a.text("SOLICITANTE: "+m.totalViveresSolicitados.usuario.persona.nombre_completo,345,r+5),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,r+5),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()},m.dibujarCabeceraPDFSolicitud=function(e,a,o){e.font("Helvetica-Bold",12),e.text("CONSUMOS",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("SUCURSAL : ",-40,50,{align:"center"}),e.font("Helvetica",8),e.text(m.totalViveresSolicitados.sucursal.nombre,60,50,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FECHA : ",40,60,{width:40}),e.font("Helvetica",8),e.text(m.fechaATexto(m.totalViveresSolicitados.fecha),75,60,{width:40}),e.font("Helvetica-Bold",14),e.text("N°",380,40,{align:"center"}),e.text(m.totalViveresSolicitados.identificador,440,40,{align:"center"}),e.rect(40,80,540,25).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",65,90),e.text("Código Ítem",100,90),e.text("Producto",220,90),e.text("Unidad medida",380,90),e.text("Cantidad solicitada",480,90)},m.calcularViveresDesdeFiltro=function(i){var t=[];m.totalViveresSolicitados={},m.solicitudesPedido=[],m.solicitudesOperaciones.forEach(function(e,a){if(e.activo||void 0!==i){if(i&&!e.id_pedido){m.solicitudesPedido.push(e.id);o=m.calcularTotalViveres(e,!0);t.push(o)}}else{var o=m.calcularTotalViveres(e,!0);t.push(o)}});var r=[];if(t.forEach(function(o){o.productos.forEach(function(e){var a={almacen:e.almacen,sucursal:e.almacen.sucursal,cantidad:e.cantidad_real,fecha:o.fecha,hora_fecha:o.fecha,usuario:o.usuario,estado:e.estado,producto:e.productoSolicitudBase,costo:e.productoSolicitudBase.inventarios&&e.productoSolicitudBase.inventarios.length?e.productoSolicitudBase.inventarios[0].costo_unitario:0,grupo:e.productoSolicitudBase.grupo,subgrupo:e.productoSolicitudBase.subgrupo,total:(e.productoSolicitudBase.inventarios&&e.productoSolicitudBase.inventarios.length?e.productoSolicitudBase.inventarios[0].costo_unitario:0)*e.cantidad_real,monto:e.monto};r.push(a)})}),i){for(var e=[];0<r.length;){var o=r.pop();if(0===e.length)e.push(o);else{var n,s=!1;e.forEach(function(e,a){e.producto.id!=o.producto.id||s||(s=!0,n=a)}),s&&void 0!==n?(e[n].cantidad+=o.cantidad,e[n].total=e[n].cantidad*e[n].costo):e.push(o)}}return e}return r},m.reporteExcel=function(e){if(f.start(),m.imprimir.detalle){(t=[]).push(["Nro.","Sucursal","Almacén","Hora-fecha","Usuario","Estado","Detalle","Unidad","Grupo","Subgrupo","Cantidad","Costo","Total"]);for(var a=m.calcularViveresDesdeFiltro(),o=[],i=0;i<a.length;i++)(o=[]).push(i+1),o.push(a[i].almacen.sucursal.nombre),o.push(a[i].almacen.nombre),o.push(new Date(a[i].fecha).toLocaleTimeString()+" "+new Date(a[i].fecha).toLocaleDateString()),o.push(a[i].usuario.nombre_usuario),o.push(a[i].estado?"Abierto":"Cerrado"),o.push(a[i].producto.nombre),o.push(a[i].producto.unidad_medida),o.push(a[i].grupo.nombre),o.push(a[i].subgrupo.nombre),o.push(a[i].cantidad),o.push(a[i].costo),o.push(a[i].total.toFixed(2)),t.push(o);f.stop()}else{var t;(t=[]).push(["Nro.","Sucursal","proveedor","Hora-fecha","Estado"]);for(o=[],i=0;i<m.listaPedidos.length;i++)(o=[]).push(i+1),o.push(m.listaPedidos[i].sucursal.nombre),o.push(m.listaPedidos[i].proveedor.razon_social),o.push(new Date(m.listaPedidos[i].fecha).toLocaleTimeString()+" "+new Date(m.listaPedidos[i].fecha).toLocaleDateString()),o.push(m.listaPedidos[i].recibido?"Completado":"En espera"),t.push(o);f.stop()}if(e)m.reportePdf(t),f.stop();else{var r=new Workbook,n=sheet_from_array_of_arrays(t);n["!cols"]=[{wch:5},{wch:18},{wch:18},{wch:12},{wch:15},{wch:15},{wch:12},{wch:25},{wch:12},{wch:12},{wch:12}],n["!rows"]=[{hpx:28,level:3}],r.SheetNames.push("SheetJS"),r.Sheets.SheetJS=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"REPORTE OPERACIONES.xlsx"),f.stop()}},m.reportePdf=function(e){var a=new PDFDocument({size:"letter",margin:10,compress:!1}),o=a.pipe(blobStream());(t=(i=new Date).getMinutes())<10&&(t="0"+t),m.posXforPdf=[],a.font("Helvetica",8);var i,t,r=65,n=115,s=0,c=1,l=Math.ceil(e.length/29);if(m.dibujarCabeceraReportePdf(a,e),m.imprimir.detalle){r=50;for(var d=0;d<e.length&&s<=29;d++){var u=r;if(a.font("Helvetica",8),0<d){for(var p=0;p<e[d].length;p++)a.text(e[d][p],u,n,{width:40},{align:"center"}),u=m.posXforPdf[p];n+=20,s++}29<s&&(a.rect(40,105,540,n-115).stroke(),a.text(c+"/"+l,570,n+15),a.font("Helvetica",6),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,n+10),a.addPage({size:[612,792],margin:10}),n=115,s=0,c+=1,m.dibujarCabeceraPDFSolicitud(a,c,l))}}else for(d=0;d<e.length&&s<=29;d++){u=r;if(a.font("Helvetica",8),0<d){for(p=0;p<e[d].length;p++)a.text(e[d][p],u,n,{width:40}),u+=0==p?30:60;n+=20,s++}29<s&&(a.rect(40,105,540,n-115).stroke(),a.text(c+"/"+l,570,n+15),a.font("Helvetica",6),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,n+10),a.addPage({size:[612,792],margin:10}),n=115,s=0,c+=1,m.dibujarCabeceraPDFSolicitud(a,c,l))}a.rect(40,105,540,650).stroke(),(t=(i=new Date).getMinutes())<10&&(t="0"+t),a.text(c+"/"+l,570,765),a.font("Helvetica",6),a.text("IMPRESION : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+" Hr. "+i.getHours()+":"+t,175,765),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),f.stop()},m.dibujarCabeceraReportePdf=function(e,a){if(e.font("Helvetica-Bold",12),e.text("REPORTE OPERACIONES",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FECHA : ",40,60,{width:40}),e.font("Helvetica",8),e.text((new Date).toLocaleDateString(),75,60,{width:40}),e.rect(40,80,540,25).stroke(),e.font("Helvetica-Bold",8),m.imprimir.detalle){px=50;for(var o=0;o<a[0].length;o++)e.text(a[0][o],px,90),0==o?px+=4*a[0][o].length+5:(m.imprimir.detalle,px+=4*a[0][o].length+15),m.posXforPdf.push(px)}else{px=65;for(o=0;o<a[0].length;o++)e.text(a[0][o],px,90),0==o?(px+=20,m.posXforPdf.push(px)):m.imprimir.detalle?px+=40:px+=60}e.font("Helvetica",8)},m.abrirModalProductosProveedor=function(e){m.checkProveedor(e)?(m.buscarProductos(null,m.pedido),m.abrirPopup(m.idDialogProductosProveedor)):m.mostrarMensaje("Seleccione un proveedor para ver su asignación de productos..")},m.seleccionarProductoAsignado=function(a){if(a.seleccionado)m.productosProveedorSeleccionados.some(function(e){return e===a.id})||m.productosProveedorSeleccionados.push(a);else{var e=m.productosProveedorSeleccionados.indexOf(a);0<=e&&!a.seleccionado?m.productosProveedorSeleccionados.splice(e,1):-1==e&&a.seleccionado&&m.productosProveedorSeleccionados.push(a.id)}},m.agregarProductosSeleccionados=function(){0<m.productosProveedorSeleccionados.length?m.productosProveedorSeleccionados.forEach(function(e,a,o){m.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,id_grupo:e.id_grupo,id_subgrupo:e.id_subgrupo},m.agregardetallePedido(m.detallePedido),a===o.length&&m.cerrarModalProductosAsignadosProveedor()}):m.mostrarMensaje("No se seleccionó ningún producto para ser agregado.")},m.eliminarDetallePedido=function(e){m.detallesPedido.splice(m.detallesPedido.indexOf(e),1)},m.generarPorProveedor=function(){if(m.pedido.proveedor)if(m.pedido.por_proveedor)if(0<m.pedido.proveedor.productos.length){m.paginatorProductosAsignados.filter=m.productosAsignadosPorveedor.grupo?m.productosAsignadosPorveedor.grupo:{id:0};P(m.usuarioSesion.id_empresa,m.pedido.proveedor).then(function(e){if(e.hasErr)m.mostrarMensaje(e.mensaje),m.listaProductosProveedor=[];else if(e.productos){var a=e.productos.split(",");m.listaProductosProveedor=a.map(function(e){return parseInt(e)}),E(m.usuarioSesion.id_empresa,m.paginatorProductosAsignados,m.usuarioSesion.id,m.listaProductosProveedor,!0).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.paginatorProductosAsignados.setPages(e.paginas),m.productosAsignadosProveedor=e.productos,m.productosAsignadosProveedor.forEach(function(a){m.listaProductosProveedor.some(function(e){return e===a.id})&&(m.detallePedido={producto:a,precio_unitario:a.precio_unitario,cantidad:1,id_grupo:a.id_grupo,id_subgrupo:a.id_subgrupo},m.agregardetallePedido(m.detallePedido))})),f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})}else m.mostrarMensaje("El proveedor no tiene productos asignados."),m.listaProductosProveedor=[];f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})}else m.mostrarMensaje("El proveedor no tiene productos asignados.");else m.detallePedido={},m.detallesPedido=[];else m.mostrarMensaje("Seleccione un proveedor.")},m.verificarAsignacionProductosProveedor=function(){0<m.listaProductosProveedor.length&&m.listaProductosProveedor.forEach(function(a){m.productosAsignacionProveedor.forEach(function(e){e.id===a&&(e.seleccionado=!0)})})},m.verificarSeleccionProductosProveedor=function(){0<m.listaProductosProveedorSeleccionados.length&&m.listaProductosProveedorSeleccionados.forEach(function(a){m.productosProveedorSeleccionados.forEach(function(e){e.id===a&&(e.seleccionado=!0)})})},m.obtenerProductos=function(){m.paginatorProductos=l(),m.paginatorProductos.column="nombre",m.paginatorProductos.filter=m.grupo,m.paginatorProductos.callBack=m.buscarProductos,m.paginatorProductos.getSearch("",null,null)},m.buscarProducto=function(e,a){if(void 0!==m.pedido)return""!=e&&null!=e&&null==a&&m.pedido.almacen?g(m.usuarioSesion.id_empresa,e,m.usuarioSesion.id,m.pedido.almacen):""!=e&&null!=e&&a&&m.pedido.almacen?g(m.usuarioSesion.id_empresa,e,m.usuarioSesion.id,m.pedido.almacen):void m.mostrarMensaje("Seleccione un almacen.");m.mostrarMensaje("Seleccione un almacen.")},m.filtrarProductosSeleccionadosPorGrupo=function(){if(0<m.detallesPedido.length){var a=[];m.detallesPedido.forEach(function(e){e.id_subgrupo===m.pedido.grupo&&a.push(e)}),0<a.length?m.detallesPedido=a.map(function(e){return e}):m.mostrarMensaje("No existen productos pertenecientes al grupo seleccionado. No se realizaron cambios.")}},m.modificarListaProductosProveedor=function(e){var a=m.listaProductosProveedor.indexOf(e.id);0<=a&&!e.seleccionado?m.listaProductosProveedor.splice(a,1):-1==a&&e.seleccionado&&m.listaProductosProveedor.push(e.id)},m.modificarListaProductosProveedorSeleccionados=function(e){var a=m.listaProductosProveedorSeleccionados.indexOf(e.id);0<=a&&!e.seleccionado?m.listaProductosProveedorSeleccionados.splice(a,1):-1==a&&e.seleccionado&&m.listaProductosProveedorSeleccionados.push(e.id)},m.seleccionarTodosParaAsignar=function(){m.seleccionProductosProveedor.seleccionar_todos?m.productosAsignacionProveedor.forEach(function(e){e.seleccionado=!0,m.modificarListaProductosProveedor(e)}):(m.productosAsignacionProveedor.forEach(function(e){e.seleccionado=!1}),m.modificarListaProductosProveedor(producto))},m.seleccionarTodosAsignados=function(){m.listaProductosProveedorSeleccionados=[],m.seleccionProductosProveedorAsignados.seleccionar_todos?m.productosAsignadosProveedor.forEach(function(e){e.seleccionado=!0,m.productosProveedorSeleccionados.push(e),m.modificarListaProductosProveedorSeleccionados(e)}):m.productosAsignadosProveedor.forEach(function(e){e.seleccionado=!1,m.productosProveedorSeleccionados.push(e),m.modificarListaProductosProveedorSeleccionados(e)})},m.actualizarProductosProveedor=function(){_(m.usuarioSesion.id_empresa,m.listaProductosProveedor,m.pedido.proveedor).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.mostrarMensaje(e.mensaje),m.cerrarModalProductosProveedor())}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})},m.verificarPulso=function(e,a){13===e.keyCode&&m.buscarProductos(1)},m.verificarPulsoAsignados=function(e,a){13===e.keyCode&&m.buscarProductosAsignados(1)},m.buscarProductos=function(e,a){f.start(),e&&(m.paginatorProductos.currentPage=e),m.paginatorProductos.filter=m.configuracionPorveedor.grupo?m.configuracionPorveedor.grupo:{id:0},m.paginatorProductos.search=m.configuracionPorveedor.textoBusqueda?m.configuracionPorveedor.textoBusqueda:0,D(m.usuarioSesion.id_empresa,m.paginatorProductos,m.usuarioSesion.id).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.paginatorProductos.setPages(e.paginas),m.productosAsignacionProveedor=e.productos,m.pedido&&m.pedido.proveedor&&P(m.usuarioSesion.id_empresa,m.pedido.proveedor).then(function(e){if(e.hasErr)m.mostrarMensaje(e.mensaje),m.listaProductosProveedor=[];else if(e.productos){var a=e.productos.split(",");m.listaProductosProveedor=a.map(function(e){return parseInt(e)}),m.verificarAsignacionProductosProveedor()}else m.listaProductosProveedor=[];f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)}));f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})},m.obtenerProductosAsignados=function(){m.paginatorProductosAsignados=l(),m.paginatorProductosAsignados.column="nombre",m.paginatorProductosAsignados.filter=m.grupo,m.paginatorProductosAsignados.callBack=m.buscarProductosAsignados,m.paginatorProductosAsignados.getSearch("",null,null)},m.buscarProductosAsignados=function(e,a){(f.start(),e&&(m.paginatorProductosAsignados.currentPage=e),void 0===m.pedido)?(m.pedido={},f.stop()):m.pedido.proveedor?(m.paginatorProductosAsignados.filter=m.productosAsignadosPorveedor.grupo?m.productosAsignadosPorveedor.grupo:{id:0},m.paginatorProductosAsignados.search=m.productosAsignadosPorveedor.textoBusqueda?m.productosAsignadosPorveedor.textoBusqueda:0,P(m.usuarioSesion.id_empresa,m.pedido.proveedor).then(function(e){if(e.hasErr)m.mostrarMensaje(e.mensaje),m.listaProductosProveedor=[];else if(e.productos){var a=e.productos.split(",");m.listaProductosProveedor=a.map(function(e){return parseInt(e)}),E(m.usuarioSesion.id_empresa,m.paginatorProductosAsignados,m.usuarioSesion.id,m.listaProductosProveedor).then(function(e){e.hasErr?m.mostrarMensaje(e.mensaje):(m.paginatorProductosAsignados.setPages(e.paginas),m.productosAsignadosProveedor=e.productos,m.listaProductosProveedorSeleccionados=[],m.verificarSeleccionProductosProveedor()),f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})}else m.listaProductosProveedor=[];f.stop()}).catch(function(e){f.stop();var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";m.mostrarMensaje(a)})):m.mostrarMensaje("El proveedor no tiene productos asignados.")},m.cerrarModalProductosProveedor=function(){m.productosAsignacionProveedor=[],m.listaProductosProveedor=[],m.cerrarPopup(m.idDialogProductosProveedor)},m.abrirModalNuevoPedido=function(){m.abrirPopup(m.idDialogNuevoPedido)},m.cerrarModalNuevoPedido=function(){m.pedido={},m.detallesPedido={},m.cerrarPopup(m.idDialogNuevoPedido)},m.abrirmodalBusquedaProveedor=function(){m.filtrarProveedores(""),m.abrirPopup(m.idDialogBusquedaProveedor)},m.cerrarModalBusquedaProveedor=function(){m.cerrarPopup(m.idDialogBusquedaProveedor)},m.abrirmodalProductosAsignadosProveedor=function(){void 0===m.pedido&&(m.pedido={por_proveedor:!1}),void 0!==m.productosProveedorSeleccionados&&null!==m.productosProveedorSeleccionados||(m.productosProveedorSeleccionados=[]),m.pedido.proveedor?(m.buscarProductosAsignados(),m.abrirPopup(m.idDialogProductosAsigandosProveedor)):m.mostrarMensaje("Seleccione un proveedor.")},m.cerrarModalProductosAsignadosProveedor=function(e){e&&(m.productosProveedorSeleccionados=[],m.seleccionProductosProveedorAsignados.seleccionar_todos=!1),m.cerrarPopup(m.idDialogProductosAsigandosProveedor)},m.inicio()}]),angular.module("agil.controladores").controller("ControladoresPlanillaRetroactivos",["$scope","$localStorage","$location","$templateCache","$route","blockUI",function(o,e,a,i,t,r){o.$on("$viewContentLoaded",function(){o.idModalNuevoPlanillaRetroactivo="dialog-nueva-planilla-retroactivo",ejecutarScriptsPlanillaRetroActivos(o.idModalNuevoPlanillaRetroactivo)}),o.$on("$routeChangeStart",function(e,a){o.eliminarPopup(o.idModalNuevoPlanillaRetroactivo)}),o.abrirDialogNuevoPlanillaRetroactivo=function(){o.abrirPopup(o.idModalNuevoPlanillaRetroactivo)},o.cerrarDialogNuevoPlanillaRetroactivo=function(){o.cerrarPopup(o.idModalNuevoPlanillaRetroactivo)}}]),angular.module("agil.controladores").controller("controladorPolifuncionalidad",["$scope","$location","$localStorage","$templateCache","$route","blockUI","Paginator","FieldViewer","$timeout","$filter","ClasesTipo","ObtenerTodoPersonal","ObtenerEvaluaciones","GuardarEvaluacionPersonal","ObtenerReportePorMeses","ObtenerReportePorAnio","ObtenerReporteGeneralPorAnio","GuardarConfiguracionCalificacion","ObtenerConfiguracionCalificacion","GuardarConfiguracionDesempenio","ObtenerConfiguracionDesempenio","ActualizarEvaluacionPersonal",function(b,e,a,o,i,C,t,r,n,s,c,l,d,u,P,p,m,f,g,v,h,_){b.usuarioSesion=JSON.parse(a.usuario),b.idModalWizardPolifuncionalEdicion="modal-wizard-polifuncional-edicion",b.idModalContenedorPolifuncionalEdicion="modal-wizard-container-polifuncional-edicion",b.idModalWizardConceptoEdicion2="modal-wizard-polifuncional-ac-edicion",b.idModalContenedorConceptoEdicion2="modal-wizard-container-polifuncional-ac-edicion",b.modalBusquedaPersonal="dialog-Busqueda-personal-polifuncional",b.modalBusquedaCentroCosto="dialog-Busqueda-centro-costo-polifuncional",b.idModalReportes="dialog-reportes-polifuncional",b.reporteGraficoPolifuncional="reporte-grafico-polifuncional",b.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsPolifuncionalidad(b.idModalWizardPolifuncionalEdicion,b.idModalContenedorPolifuncionalEdicion,b.modalBusquedaPersonal,b.idModalWizardConceptoEdicion2,b.idModalContenedorConceptoEdicion2,b.idModalReportes,b.reporteGraficoPolifuncional,b.modalBusquedaCentroCosto),b.buscarAplicacion(b.usuarioSesion.aplicacionesUsuario,e.path().substring(1)),b.obtenerColumnasAplicacion(),C.stop()}),b.$on("$routeChangeStart",function(e,a){b.eliminarPopup(b.idModalWizardPolifuncionalEdicion),b.eliminarPopup(b.idModalWizardConceptoEdicion2),b.eliminarPopup(b.idModalReportes),b.eliminarPopup(b.modalBusquedaPersonal),b.eliminarPopup(b.reporteGraficoPolifuncional),b.eliminarPopup(b.modalBusquedaCentroCosto)}),b.inicio=function(){b.obtenerCargos(),b.obtenerCentroCosto(),b.actualizarListaDesempenio(),b.obtenerConfiguracionnotas(),b.filtrarPersonal("");b.usuarioSesion.empresa.id;b.obtenerPaginador()},b.eliminar=function(e){e.eliminado=!0,e.eliminar=!0,u(b.usuarioSesion.empresa.id,e).then(function(e){e.hasErr?b.mostrarMensaje("Hubo un error no se pudo eliminar: "+e.mensaje):(b.mostrarMensaje(e.mensaje),b.recargarItemsTabla())},function(e){b.mostrarMensaje("No hay respuesta del servidor, se perdió la conexión: "+res.mensaje)})},b.obtenerConfiguracionnotas=function(){g(b.usuarioSesion.empresa.id).then(function(e){for(var a in e.configuracion)e.configuracion[a].encargados?b.encargados=e.configuracion[a]:b.empleados=e.configuracion[a];h(b.usuarioSesion.empresa.id).then(function(e){for(b.parametros=e.parametros;0<e.parametros.length;){var a=e.parametros.pop();b.listaDesempenio.map(function(e){e.nombre==a.nombre&&(e.desde=a.desde,e.hasta=a.hasta)})}})}).catch(function(e){b.mostrarMensaje(e.stack?e.stack:e.message)})},b.editar=function(e,a,o,i){if(b.abrirNuevoEvaluacionPolifuncional(),i&&(b.evaluacion={encargado:e.encargado,anio:{id:e.anio},mes:{id:e.mes},asistencia_capacitacion:e.asistencia_capacitacion,asistencia_reunion:e.asistencia_reunion,documentos_actualizados:e.documentos_actualizados,funciones_puntualidad:e.funciones_puntualidad,higiene_personal:e.higiene_personal,ingreso_campo:e.ingreso_campo,llenado_formularios:e.llenado_formularios,trabajo_equipo:e.trabajo_equipo,nota_total:e.nota_total,id:e.id,id_desempenio:e.id_desempenio,id_empleado:e.id_empleado,personal:{id:e.empleado.id,persona:{nombre_completo:e.empleado.persona.nombre_completo}}},b.evaluacion.ver=!0),a&&(b.evaluacion={encargado:e.encargado,anio:{id:e.anio},mes:{id:e.mes},asistencia_capacitacion:e.asistencia_capacitacion,asistencia_reunion:e.asistencia_reunion,documentos_actualizados:e.documentos_actualizados,funciones_puntualidad:e.funciones_puntualidad,higiene_personal:e.higiene_personal,ingreso_campo:e.ingreso_campo,llenado_formularios:e.llenado_formularios,trabajo_equipo:e.trabajo_equipo,nota_total:e.nota_total,id:e.id,id_desempenio:e.id_desempenio,id_empleado:e.id_empleado,personal:{id:e.empleado.id,persona:{nombre_completo:e.empleado.persona.nombre_completo}}},b.evaluacion.editar=!0),o){b.evaluacion.encargado=e.encargado,b.evaluacion.id_desempenio=e.id_desempenio,b.evaluacion.id_empleado=e.id_empleado,b.evaluacion.personal={id:e.empleado.id,persona:{nombre_completo:e.empleado.persona.nombre_completo}},b.evaluacion.nuevo=!0;$("#siguiente").trigger("click")}},b.obtenerPaginador=function(){C.start(),b.paginator=t(),b.paginator.column="anio",b.paginator.direccion="asc",b.filtro={id_empresa:b.usuarioSesion.empresa.id,mes:0,anio:0,desempenio:0,mas_campo:0,campo:0,cargo:0,estado:0,codigo:0,nombre:0,apellido:0,pagina:1,items_pagina:10},b.paginator.filter=b.filtro,b.paginator.callBack=b.obtenerEvaluaciones,b.paginator.getSearch("",b.filtro,null),b.resetFiltro(),C.stop()};var M="ERROR",D="bg-red";b.listaDesempenio=[{nombre:"Deficiente",desde:0,hasta:25,color:"bg-red"},{nombre:"Insatisfactorio",desde:26,hasta:50,color:"bg-yellow"},{nombre:"Satisfactorio",desde:51,hasta:75,color:"bg-orange-green"},{nombre:"Competente",desde:76,hasta:100,color:"bg-blue"}],b.actualizarListaDesempenio=function(e){if(null==e||null==e)h(b.usuarioSesion.empresa.id).then(function(e){for(;0<e.parametros.length;){var a=e.parametros.pop();b.listaDesempenio.map(function(e){e.nombre==a.nombre&&(e.desde=a.desde,e.hasta=a.hasta,e.id=a.id,e.activo=a.activo)})}}).catch(function(e){b.mostrarMensaje(e.stack?e.stack:e.message)});else for(var a=e.map(function(e){return e});0<a.length;){var o=a.pop();b.listaDesempenio.map(function(e){e.nombre==o.nombre&&(e.desde=o.desde,e.hasta=o.hasta)})}},b.listaEstados=[{id:1,nombre:"Activo"},{id:2,nombre:"Inactivo"}],b.determinarEstado=function(e){return 1==e?b.listaEstados[1].nombre:b.listaEstados[0].nombre},b.determinarDesempenio=function(o){var i=NaN;if(null==o||null==o)return"bg-red";b.listaDesempenio.map(function(e,a){e.id==o&&(i=a)});return NaN!==i?b.listaDesempenio[i].nombre:M},b.determinarColor=function(o){var i=NaN;if(null==o||null==o)return"bg-red";b.listaDesempenio.map(function(e,a){e.id==o&&(i=a)});return NaN!==i?b.listaDesempenio[i].color:D};var E=["asistencia_capacitacion","documentos_actualizados","trabajo_equipo","funciones_puntualidad","higiene_personal","asistencia_reunion","ingreso_campo","llenado_formularios"];b.calcularTotalEvaluacion=function(a){var o=0;E.map(function(e){null!==a[e]&&void 0!==a[e]&&0<=a[e]?(b.opcion[e]?o+=a[e]:a.encargado?(o+=b.encargados[e],a[e]=b.encargados[e]):(o+=b.empleados[e],a[e]=b.empleados[e]),a.nota_total=o):b.opcion[e]?o+=a[e]:a.encargado?(o+=encargados[e],a[e]=b.encargados[e]):(o+=empleados[e],a[e]=b.empleados[e])})},b.filtrarPolifuncionalidad=function(e,a){for(var o in e)""!==e[o]&&null!==e[o]||(e[o]=0);if(void 0!==a)return e;b.obtenerProformas()};var x=!(b.calcularNotaTotalConfiguracion=function(e,a){var o=0,i=0;for(var t in e&&(e.nota_total=0),a&&(a.nota_total=0),e)"createdAt"!==t&&"updatedAt"!==t&&"id_empresa"!==t&&"id"!==t&&"activo"!==t&&"encargados"!==t&&(o+=e[t]);for(var t in a)"createdAt"!==t&&"updatedAt"!==t&&"id_empresa"!==t&&"id"!==t&&"activo"!==t&&"encargados"!==t&&(i+=a[t]);e.nota_total=o,a.nota_total=i}),S=0,A=!1;b.validarDatosEvaluacion=function(e){if(A){var a=0;for(var o in e)e.hasOwnProperty(o)&&(a+=1);return a==E.length||4==a||7==a&&e.nuevo?x?!(S<1)||(S+=1,!1):!(x=!0):a<E.length+4}return null==e||(void 0===e.personal||null==e.personal||(S+=1,!(A=!0)))},b.guardarEvaluacion=function(o){if("Siguiente"!=$("#siguiente").text().trim())if(C.start(),b.listaDesempenio.map(function(e){o.nota_total>=e.desde&&o.nota_total<=e.hasta&&(o.id_desempenio=e.id)}),o.ver)b.cerrarPopPupNuevoPolifuncional(),C.stop();else{if(o.fecha=new Date(o.anio.id,o.mes.id,15,12,0,0),o.editar)var e=_(b.usuarioSesion.empresa.id,o);else e=u(b.usuarioSesion.empresa.id,o);e.then(function(e){b.mostrarMensaje(e.mensaje),b.cerrarPopPupNuevoPolifuncional(),b.recargarItemsTabla(),C.stop()},function(e){var a=void 0!==e.stack?e.stack:e.message;o.editar=void 0,b.mostrarMensaje("Se perdió la conexión."+a),C.stop()})}},b.reportePorMesGrafico=function(e,r){b.abriridModalReportesGrafico();var o=[];e.forEach(function(i,e){if(0!=e){var t=[];i.forEach(function(e,a){if(5<a&&a<=i.length-2){var o={y:"-"!==e?e:0,label:i.length-2!=a?r[a-6]:"TOTAL"};t.push(o),10}});var a={type:"column",interval:0,showInLegend:!0,legendText:(i[1]+" "+i[2]+" "+i[3]+" "+i[4]+" "+i[5]).toUpperCase(),dataPoints:t};o.push(a)}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte polifuncional desde "+r[0]+" hasta "+r[r.length-1]).toUpperCase(),fontSize:32},legend:{horizontalAlign:"center",verticalAlign:"top",fontSize:15},animationEnabled:!0,exportEnabled:!0,width:1100,height:600,axisX:{labelFontSize:18},data:o}).render(),C.stop()},b.reportePorMeses=function(c,l,d,u,p,m){if(C.start(),void 0===c||void 0===l||void 0===d||void 0===u||null===c||null===l||null===d||null===u)return b.mostrarMensaje("Ingrese desde que Mes/Año hasta que Mes/Año desea el reporte."),void C.stop();var f=["N°","Campo","Empleado","C.I.","Estado","Cargo"],g=[];if(void 0===p)var v=[{wch:4},{wch:12},{wch:20},{wch:9},{wch:8},{wch:9}];var h=[];P(c,l,d,u,b.usuarioSesion.empresa.id).then(function(a){if(0==a.reporte.length)return b.mostrarMensaje("No existen datos"),void C.stop();if(a.hasErr)b.mostrarMensaje(a.mensaje);else{a.mesesReporte.map(function(e){f.push(e)}),mesesReporte=a.mesesReporte;for(var o=0;o<a.reporte.length;o++){var i=[];i.push(o+1),i.push(a.reporte[o].campo.nombre),i.push(a.reporte[o].persona.nombre_completo),i.push(a.reporte[o].persona.ci),i.push(b.determinarEstado(a.reporte[o].eliminado)),i.push(0<a.reporte[o].empleadosFichas[a.reporte[o].empleadosFichas.length-1].cargos.length?a.reporte[o].empleadosFichas[a.reporte[o].empleadosFichas.length-1].cargos[0].cargo.nombre:"Sin cargo");var t=0,r=0;mesesReporte.map(function(e){e==(t<=a.reporte[o].evaluaciones.length-1?b.meses[a.reporte[o].evaluaciones[t].mes].nombre.substring(0,3)+"-"+a.reporte[o].evaluaciones[t].anio.toString().substring(4,2):"0")?(i.push(a.reporte[o].evaluaciones[t].nota_total),r+=a.reporte[o].evaluaciones[t].nota_total,t+=1):i.push("-"),0==o&&void 0===p&&v.push({wch:6})}),r/=a.reporte[o].evaluaciones.length,i.push(Math.round(r)),b.listaDesempenio.map(function(e){Math.round(r)>=e.desde&&Math.round(r)<=e.hasta&&i.push(b.determinarDesempenio(e.id))}),0==o&&void 0===p&&v.push({wch:10}),o==a.reporte.length-1&&(f.push("Promedio"),f.push("Desempeño"),void 0===p&&v.push({wch:12})),h.push(i)}if(g.push(f),h.map(function(e){g.push(e)}),p)m?b.reportePorMesGrafico(g,mesesReporte):(C.stop(),b.reportePorMesesPdf(g,c,l,d,u));else{var e=new Workbook,n=sheet_from_array_of_arrays(g);n["!cols"]=v,e.SheetNames.push("SheetJS"),e.Sheets.SheetJS=n;var s=XLSX.write(e,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});b.meses[c.id].nombre.substring(0,3),l.id.toString().substring(4,2),b.meses[d.id].nombre.substring(0,3),u.id.toString().substring(4,2);saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"REPORTE POLIFUNCIONAL POR MESES "+mesesReporte[0]+" : "+mesesReporte[mesesReporte.length-1]+".xlsx"),C.stop()}}}).catch(function(e){var a=void 0!==e.data&&null!==e.data?e.data:e.message;b.mostrarMensaje("Se produjo un error! "+a),C.stop()})},b.reportePorMesesPdf=function(c,l,d,u,p){var m=40,f=120;convertUrlToBase64Image(b.usuario.empresa.imagen,function(e){var a=e,o=c[0].length-8;12==o&&(m=30);var i=new PDFDocument({size:[612,792],margin:10,compress:!1}),t=i.pipe(blobStream());i.image(a,40,30,{fit:[85,85]});for(var r=0;r<=c.length-1;r++){if(c[r].length<=14){0==r&&(i.font("Helvetica-Bold",12),i.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),i.text("DESDE "+l.nombre.toUpperCase()+"-"+d.id+" HASTA "+u.nombre.toUpperCase()+"-"+p.id,50,45,{align:"center"}),i.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"}));for(var n=0;n<c[r].length;n++)0<r?i.font("Helvetica",8):i.font("Helvetica-Bold",8),0==n&&(i.text(c[r][n],m,f,{width:50}),m-=30),0<n&&n<5&&((2==n||1==n||5==n)&&1<=r&&i.font("Helvetica",5),i.text(c[r][n],m,f,{width:50,align:"center"})),4<n&&n<c[r].length-3&&(5==n?i.text(c[r][n].toLowerCase(),m,f,{width:50,align:"center"}):i.text(c[r][n],m,f,{width:50,align:"center"}),m-=10),n>=c[r].length-3&&i.text(c[r][n],m,f,{width:50,align:"center"}),m+=45}if(15<=c[r].length&&c[r].length<=23){0==r&&(i.font("Helvetica-Bold",12),i.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),i.text("DESDE "+l.nombre+"-"+d.id+" HASTA "+u.nombre+"-"+p.id,50,45,{align:"center"}),i.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"}));for(n=0;n<c[r].length;n++)0<r?i.font("Helvetica",6):i.font("Helvetica-Bold",6),0==n&&(i.text(c[r][n],m,f,{width:50}),m-=40),0<n&&n<5&&((2==n||1==n)&&1<=r&&i.font("Helvetica",5),i.text(c[r][n],m,f,{width:45,align:"center"}),m-=5),4<n&&n<c[r].length-3&&(i.text(c[r][n],m,f,{width:45,align:"center"}),m-=15),n>=c[r].length-3&&i.text(c[r][n],m,f,{width:45,align:"center"}),m+=40}if(12<o&&(m=20),12==o&&(m=30),o<12&&10<o&&(m=35),o<=10&&(m=40),700<(f+=25)){i.addPage({size:"letter",margin:10}),i.font("Helvetica-Bold",12),i.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),i.text("DESDE "+l.nombre+"-"+d.id+" HASTA "+u.nombre+"-"+p.id,50,45,{align:"center"}),i.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"});for(var s=0;s<c[0].length;s++)i.font("Helvetica-Bold",8),i.text(c[0][s],m,f-625,{width:50}),0==s&&(m-=20),2==s&&(m+=10),4<s&&s<c[r].length-3&&(m-=10),m+=45;12<o&&(m=20),12==o&&(m=30),o<12&&10<o&&(m=35),o<=10&&(m=40),f=120}}12<o&&setTimeout(function(){b.$apply(function(){b.mostrarMensaje("ADVERTENCIA: El rango de fechas excede el tamaño máximo de impresion.")})},1e3),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},b.reportePromediosGeneralGrafico=function(e,a,o,i){b.abriridModalReportesGrafico();b.graficoType="column",i&&(b.graficoType=i);var t=[];e.map(function(e,a){if(0!=a){var o={y:e[9],label:e[0]};t.push(o),10}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte promedio general campo "+o+" gestión "+a.id).toUpperCase(),fontSize:32},animationEnabled:!0,exportEnabled:!0,width:1100,axisX:{title:"Promedio total mensual"},data:[{type:"column",dataPoints:t}]}).render(),C.stop()},b.reportePromediosGeneralExcel=function(n,s,c,l){if(C.start(),null==n||null==s)return b.mostrarMensaje("Ingrese el Campo y el Año del cual desea el reporte."),void C.stop();var d=[];d.push(["","Asistencia Capacitación","Documentos Actualizados","Trabajo en equipo","Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo","Higiene personal","Puntualidad a la asistencia de reunión de 5 minutos en campo","Cumplimiento de ingreso a campo","Aplicación y llenado correcto de los formularios del SIG","TOTAL","DESEMPEÑO"]),m(n.id,s,b.usuarioSesion.empresa.id).then(function(a){if(0==a.reporte.length)return b.mostrarMensaje("No existen datos"),void C.stop();for(var o=0;o<a.reporte.length;o++){var i=[];i.push(b.meses[a.reporte[o].mes].nombre),i.push(a.reporte[o].asistencia_capacitacion),i.push(a.reporte[o].documentos_actualizados),i.push(a.reporte[o].trabajo_equipo),i.push(a.reporte[o].funciones_puntualidad),i.push(a.reporte[o].higiene_personal),i.push(a.reporte[o].asistencia_reunion),i.push(a.reporte[o].ingreso_campo),i.push(a.reporte[o].llenado_formularios),i.push(a.reporte[o].total),b.listaDesempenio.map(function(e){a.reporte[o].total>=e.desde&&a.reporte[o].total<=e.hasta&&i.push(b.determinarDesempenio(e.id))}),d.push(i)}if(c)l?(C.stop(),b.reportePromediosGeneralGrafico(d,n,s.nombre)):(C.stop(),b.reportePromediosGeneralPdf(d,n,s.nombre));else{var e=new Workbook,t=sheet_from_array_of_arrays(d);t["!cols"]=[{wch:12},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],t["!rows"]=[{hpx:28,level:3}],e.SheetNames.push("SheetJS"),e.Sheets.SheetJS=t;var r=XLSX.write(e,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"REPORTE POLIFUNCIONAL CAMPO "+s.nombre+" : "+anio.id+".xlsx"),C.stop()}}).catch(function(e){var a=void 0!==e.data&&null!==e.data?e.data:null!==e.message&&void 0!==e.message?e.message:void 0!==e.stack&&null!==e.stack?e.stack:"Se perdió la conexión al servidor.";b.mostrarMensaje("Se produjo un error! "+a),C.stop()})},b.reportePromediosGeneralPdf=function(n,s,c){var l=15,d=180,u=20;convertUrlToBase64Image(b.usuario.empresa.imagen,function(e){var a=e,o=(n[0].length,new PDFDocument({size:[792,612],margin:10,compress:!1})),i=o.pipe(blobStream());o.image(a,40,40,{fit:[85,85]});for(var t=0;t<=n.length-1;t++){0==t&&(o.font("Helvetica-Bold",12),o.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),o.text("GESTIÓN "+s.id,50,55,{align:"center"}),o.text(" "+c.toUpperCase()+" ",50,70,{align:"center"}));for(var r=0;r<n[t].length;r++)0<r?0==t?(o.font("Helvetica-Bold",7),r>=n[t].length-2?(o.text(n[t][r],l-u,d-40,{width:70,align:"center"}),u+=20):o.text(n[t][r],l,d-40,{width:70,align:"center"})):(o.font("Helvetica",8),r>=n[t].length-2?(r==n[t].length-1?o.text(n[t][r],l-u,d,{width:70,align:"center"}):o.text(n[t][r].toFixed(2),l-u,d,{width:70,align:"center"}),u+=20):(o.text(n[t][r].toFixed(2),l,d,{width:70,align:"center"}),u=20)):(o.font("Helvetica-Bold",8),o.text(n[t][r],l,d,{width:70,align:"center"})),l+=70;700<(d+=l=25)&&(o.addPage({size:"letter",margin:10}),d=120)}o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},b.reportePromediosCampoGrafico=function(r,e){b.abriridModalReportesGrafico();var n=[];r.map(function(e,a){if(0!=a){var i=10,t=[];e.map(function(e,a){if(0!=a&&a<=9){var o={x:i,y:e,label:r[0][a]};t.push(o),i+=10}});var o={type:"column",showInLegend:!0,legendText:e[0].toUpperCase(),dataPoints:t};n.push(o)}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte anual por campos gestión "+e.id).toUpperCase(),fontSize:32},legend:{horizontalAlign:"center",verticalAlign:"top",fontSize:15},animationEnabled:!0,exportEnabled:!0,width:1100,height:600,axisX:{labelFontSize:18},data:n}).render(),C.stop()},b.reportePromediosCampoExcel=function(n,s,c){if(C.start(),null==n)return C.stop(),void b.mostrarMensaje("Ingrese el Año del cual desea el reporte.");var l=[];l.push([" ","Asistencia Capacitación","Documentos Actualizados","Trabajo en equipo","Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo","Higiene personal","Puntualidad a la asistencia de reunión de 5 minutos en campo","Cumplimiento de ingreso a campo","Aplicación y llenado correcto de los formularios del SIG","TOTAL","DESEMPEÑO"]),p(n.id,b.usuarioSesion.empresa.id).then(function(a){for(var o=[],i=0;i<a.reporte.length;i++)(o=[]).push(null!==a.reporte[i].campo&&null!=a.reporte[i].campo?a.reporte[i].campo.nombre:""),o.push(a.reporte[i].asistencia_capacitacion),o.push(a.reporte[i].documentos_actualizados),o.push(a.reporte[i].trabajo_equipo),o.push(a.reporte[i].funciones_puntualidad),o.push(a.reporte[i].higiene_personal),o.push(a.reporte[i].asistencia_reunion),o.push(a.reporte[i].ingreso_campo),o.push(a.reporte[i].llenado_formularios),o.push(a.reporte[i].total),b.listaDesempenio.map(function(e){a.reporte[i].total>=e.desde&&a.reporte[i].total<=e.hasta&&o.push(b.determinarDesempenio(e.id))}),l.push(o);if(s)c?(C.stop(),b.reportePromediosCampoGrafico(l,n)):(C.stop(),b.reportePromediosCampoPdf(l,n));else{var e=new Workbook,t=sheet_from_array_of_arrays(l);t["!cols"]=[{wch:12},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],t["!rows"]=[{hpx:28,level:3}],e.SheetNames.push("SheetJS"),e.Sheets.SheetJS=t;var r=XLSX.write(e,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"REPORTE ANUAL POLIFUNCIONAL POR CAMPOS "+n.id+".xlsx"),C.stop()}})},b.reportePromediosCampoPdf=function(c,l){var d=20,u=180,p=20;convertUrlToBase64Image(b.usuario.empresa.imagen,function(e){var a=e,o=(c[0].length,1),i=new PDFDocument({size:[792,612],margin:10,compress:!1}),t=i.pipe(blobStream());i.image(a,40,40,{fit:[85,85]});for(var r=0;r<=c.length-1;r++){0==r&&(i.font("Helvetica-Bold",12),i.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),i.text("GESTIÓN "+l.id,50,55,{align:"center"}),i.font("Helvetica",12),i.text(o,730,585,{width:70,align:"center"}));for(var n=0;n<c[r].length;n++)0<n?0==r?(i.font("Helvetica-Bold",7),n>=c[r].length-2?(i.text(c[r][n],d-p,u-40,{width:70,align:"center"}),p+=20):i.text(c[r][n],d,u-40,{width:70,align:"center"})):(i.font("Helvetica",8),n>=c[r].length-2?(n==c[r].length-2?i.text(c[r][n].toFixed(2),d-p,u,{width:70,align:"center"}):n==c[r].length-1?i.text(c[r][n],d-p,u,{width:70,align:"center"}):i.text(c[r][n].toFixed(2),d-p,u,{width:70,align:"center"}),p+=20):(i.text(c[r][n].toFixed(2),d,u,{width:70,align:"center"}),p=20)):(i.font("Helvetica-Bold",8),i.text(c[r][n],d,u,{width:70,align:"center"})),d+=70;if(d=25,1,580<(u+=15)){i.addPage({size:[792,612],margin:10}),o+=1,i.font("Helvetica",12),i.text(o,730,u,{width:70,align:"center"}),i.font("Helvetica-Bold",12),i.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),i.text("GESTIÓN "+l.id,50,55,{align:"center"}),p=20,u=120,i.font("Helvetica-Bold",7);for(var s=0;s<c[0].length;s++)s>=c[0].length-2?(i.text(c[0][s],d-p,u-40,{width:70,align:"center"}),p+=20):i.text(c[0][s],d,u-40,{width:70,align:"center"}),d+=70;d=25}}i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},b.obtenerEvaluaciones=function(){C.start(),b.filtro=b.filtrarFiltroPolifuncionalidad(b.filtro,!0),b.paginator.filter=b.filtro,d(b.paginator).then(function(e){b.evaluaciones=e.evaluaciones.rows,b.paginator.setPages(e.paginas),void 0!==e.mensaje&&b.mostrarMensaje(e.mensaje),C.stop()}).catch(function(e){n(function(){b.$apply(function(){b.mostrarMensaje(e.data)})},500),C.stop()})},b.resetFiltro=function(){b.filtro={id_empresa:b.usuarioSesion.empresa.id,mes:"",anio:"",desempenio:"",mas_campo:"",campo:"",cargo:"",estado:"",codigo:"",nombre:"",apellido:"",pagina:1,items_pagina:10}},b.filtrarFiltroPolifuncionalidad=function(e,a){if(void 0!==a){for(var o in e)null===e[o]||void 0===e[o]?e[o]=0:0!=e[o]&&"0"!=e[o]||"codigo"!=o&&"nombre"!=o&&"apellido"!=o||(e[o]="");return e}b.obtenerEvaluaciones()},b.obtenerColumnasAplicacion=function(){C.start(),b.fieldViewer=r({crear:!0,id_empresa:b.usuarioSesion.empresa.id,configuracion:{anio:{value:"Año",show:!0},mes:{value:"Mes",show:!0},estado:{value:"Estado",show:!0},codigo:{value:"Código",show:!0},nombre:{value:"Nombre completo",show:!0},campo:{value:"Campo",show:!0},cargo:{value:"Cargo",show:!0},asis_capacitacion:{value:"Asistencia Capacitación",show:!0},doc_actualizados:{value:"Documentos Actualizados",show:!0},trab_equipo:{value:"Trabajo en equipo",show:!0},funciones_puntualidad:{value:"Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo",show:!0},higiene:{value:"Higiene personal",show:!0},puntualidad_asistencia_campo:{value:"Puntualidad a la asistencia de reunión de 5 minutos en campo",show:!0},ingreso_campo:{value:"Cumplimiento de ingreso a campo",show:!0},llenado_correcto_sig:{value:"Aplicación y llenado correcto de los formularios del SIG",show:!0},nota_total:{value:"Nota total",show:!0}}},b.aplicacion.aplicacion.id),b.fieldViewer.updateObject(),C.stop()},b.obtenerCargos=function(){C.start(),c("RRHH_CARGO").then(function(e){b.cargos=e.clases,C.stop()},function(e){b.mostrarMensaje("Se perdió la conexión."),C.stop()})},b.obtenerCentroCosto=function(){C.start(),c("CENCOS").then(function(e){b.centrosCostos=e.clases,C.stop()},function(e){b.mostrarMensaje("Se perdió la conexión."),C.stop()})},b.buscarPersonal=function(e){if(""!=e&&null!=e)return s("filter")(b.todoPersonal,e)},b.filtrarPersonal=function(e){void 0!==b.todoPersonal?b.personalProcesado=s("filter")(b.todoPersonal,e):l(b.usuarioSesion.empresa.id).then(function(e){b.todoPersonal=e.personal,b.personalProcesado=e.personal,void 0!==e.mensaje&&b.mostrarMensaje(e.mensaje)},function(e){b.mostrarMensaje("Se perdió la conexión.")})},b.filtrarCentroCosto=function(e){void 0!==b.centrosDeCostosProcesado?b.centrosDeCostosProcesado=s("filter")(b.centrosDeCostos,e):b.centrosDeCostosProcesado=b.centrosDeCostos},b.establecerPersonal=function(e,a){void 0===b.evaluacion&&(b.evaluacion={});var o={id:e.id,persona:{nombre_completo:e.persona.nombre_completo}};b.evaluacion.personal=o,void 0!==a&&b.cerrarmodalBusquedaPersonal()},b.establecercentroCosto=function(e,a){void 0===b.reporte&&(b.reporte={}),b.reporte.campoXanio=e,void 0!==a&&b.cerrarmodalBusquedaCentroCosto()},b.abriridModalReportes=function(){b.abrirPopup(b.idModalReportes)},b.cerraridModalReportes=function(){b.cerrarPopup(b.idModalReportes)},b.abriridModalReportesGrafico=function(){b.abrirPopup(b.reporteGraficoPolifuncional)},b.cerraridModalReportesGrafico=function(){b.cerrarPopup(b.reporteGraficoPolifuncional)},b.abrirNuevoEvaluacionPolifuncional=function(){null==b.evaluacion&&(b.evaluacion={},b.evaluacion.mes={id:(new Date).getMonth()},b.evaluacion.anio={id:(new Date).getFullYear()},b.evaluacion.encargado=!1,null==b.opcion&&(b.opcion={},E.forEach(function(e){b.opcion[e]=!0})),E.forEach(function(e){b.evaluacion[e]=0}),b.evaluacion.nota_total=0),b.abrirPopup(b.idModalWizardPolifuncionalEdicion)},b.cerrarPopPupNuevoPolifuncional=function(){b.evaluacion={},b.evaluacion=void 0,b.recargarItemsTabla(),b.cerrarPopup(b.idModalWizardPolifuncionalEdicion)},b.abrirmodalParametrosPolifuncionalidad=function(){b.abrirPopup(b.idModalWizardConceptoEdicion2)},b.cerrarmodalParametrosPolifuncionalidad=function(){b.cerrarPopup(b.idModalWizardConceptoEdicion2)},b.abrirmodalBusquedaPersonal=function(){b.filtrarPersonal(""),b.abrirPopup(b.modalBusquedaPersonal)},b.cerrarmodalBusquedaPersonal=function(){b.cerrarPopup(b.modalBusquedaPersonal)},b.abrirmodalBusquedaCentroCosto=function(){b.filtrarCentroCosto(""),b.abrirPopup(b.modalBusquedaCentroCosto)},b.cerrarmodalBusquedaCentroCosto=function(){b.cerrarPopup(b.modalBusquedaCentroCosto)},b.comprobarConfiguracion=function(){if(b.empleados){var e=0;for(var a in b.empleados)b.empleados.hasOwnProperty(a)&&(e+=1)}if(b.encargados){var o=0;for(var a in b.encargados)b.encargados.hasOwnProperty(a)&&(o+=1)}return!(7<e&&7<o)},b.guardarConfiguracionEvaluacion=function(e,a,o){if("Siguiente"!=$("#siguiente-conf").text().trim()){C.start(),o.encargados=!1;a.encargados=!0;var i=[o,a];f(b.usuarioSesion.empresa.id,i).then(function(e){if(e.hasErr){e.mensaje;b.mostrarMensaje("Hubo un error. "+e.mensaje)}},function(e){b.mostrarMensaje("No hubo respuesta del servidor, se perdió la conexión.")}),v(b.usuarioSesion.empresa.id,b.listaDesempenio).then(function(e){e.hasErr?b.mostrarMensaje("Hubo uno o mas errores. "+rrores+" "+e.mensaje):b.mostrarMensaje(e.mensaje),C.stop(),b.recargarItemsTabla()}),b.cerrarmodalParametrosPolifuncionalidad()}},b.inicio()}]),angular.module("agil.controladores").controller("ControladorProductos",["$scope","$timeout","$filter","$window","$localStorage","$location","$templateCache","$route","blockUI","Producto","Productos","ProductosPaginador","ProductosEmpresa","ClasesTipo","Clases","ProductoKardex","ProductosEmpresaCreacion","DatoCodigoSiguienteProductoEmpresa","ListaProductosEmpresa","Paginator","ListaCuentasComprobanteContabilidad","DatosProducto","CatalogoProductos","ListaGruposProductoEmpresa","Tipos","ClasesTipoEmpresa","FieldViewer","ListaSubGruposProductoEmpresa","ListaGruposProductoUsuario","ReporteProductosKardex","GuardarProductosFormulacion",function(p,e,a,o,i,t,r,n,m,l,s,c,d,u,f,g,v,h,b,C,P,_,M,D,E,x,S,A,T,w,I){m.start(),p.idModalWizardProductoKardex="modal-wizard-producto-kardex",p.idModalWizardProductoEdicion="modal-wizard-producto-edicion",p.idModalWizardProductoVista="modal-wizard-producto-vista",p.idModalEliminarProducto="dialog-eliminar-producto",p.idModalContenedorProductoEdicion="modal-wizard-container-producto-edicion",p.idModalContenedorProductoVista="modal-wizard-container-producto-vista",p.idModalContenedorProductoKardex="modal-wizard-container-producto-kardex",p.idImagenProducto="imagen-producto",p.idModalReporteProductosKardex="dialog-reporte-productos-kardex",p.idModalConceptoEdicion="dialog-conceptos",p.usuario=JSON.parse(i.usuario),p.inicio=function(){p.obtenerTipoProducto(),p.obtenerProductos(),p.obtenerSucursales(),p.obtenerGruposProductosEmpresaUsuario(),p.obtenerSubGruposProductosEmpresa(),p.obtenerTiposPrecio(),p.usarValuado=!0},p.obtenerColumnasAplicacion=function(){p.fieldViewer=S({crear:!0,id_empresa:p.usuario.id_empresa,configuracion:{publicado_panel:{value:"¿Publicado Panel?",show:!0},inventario_activado:{value:"¿Inventario Activado?",show:!0},codigo:{value:"Código",show:!0},nombre:{value:"Nombre",show:!0},imagen:{value:"Imagen",show:!0},unidad_medida:{value:"Unidad de Medida",show:!0},precio_unitario:{value:"Precio Unitario",show:!0},inventario_minimo:{value:"Inventario Mínimo",show:!0},descripcion_uno:{value:"Descripcion",show:!0},carac_esp_uno:{value:"Carac. Esp. 1",show:!0},carac_esp_dos:{value:"Carac. Esp. 2",show:!0},grupo:{value:"Grupo",show:!0},subgrupo:{value:"Subgrupo",show:!0},tipo_producto:{value:"Tipo Producto",show:!0}}},p.aplicacion.aplicacion.id),p.fieldViewer.updateObject()},p.obtenerGruposProductosEmpresaUsuario=function(){m.start(),T(p.usuario.id_empresa,p.usuario.id).then(function(e){m.stop(),0<e.length?p.gruposProducto=e:(p.gruposProducto=[],p.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){p.gruposProducto=[]})},p.reporteProductosKardex=function(e){m.start(),null==e.grupo&&(e.grupo=0),w(p.usuario.id_empresa,e).then(function(e){if(0==e.length)p.mostrarMensaje("No existen datos"),m.stop();else for(var a=0;a<e.length;a++)if(e[a]=p.generarKardexProductoReporte(e[a]),a===e.length-1){var o=[];o.push(["Código","Nombre","Unidad Medida","Saldo Fisico","Saldo Valuado"]);for(a=0;a<e.length;a++){var i=[];i.push(e[a].codigo),i.push(e[a].nombre),i.push(e[a].unidad_medida),i.push(e[a].detallesMovimiento[e[a].detallesMovimiento.length-1].saldoFisico),i.push(e[a].detallesMovimiento[e[a].detallesMovimiento.length-1].saldoV),o.push(i)}var t=new Workbook,r=sheet_from_array_of_arrays(o);r["!cols"]=[{wch:15},{wch:20},{wch:15},{wch:15}],t.SheetNames.push("SheetJS"),t.Sheets.SheetJS=r;var n=XLSX.write(t,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),"Catálogo productos.xlsx"),m.stop()}})},p.generarKardexProductoReporte=function(e){var a=e;p.Math=Math,a.detallesMovimiento.sort(function(e,a){return e.id-a.id});for(var o=0;o<a.detallesMovimiento.length;o++)a.detallesMovimiento[o].costo_unitario=Math.round(.87*a.detallesMovimiento[o].costo_unitario*100)/100,0==o&&"SALDO ANTERIOR"==a.detallesMovimiento[o].tipo?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].saldoFisico,a.detallesMovimiento[o].saldoValuado=a.detallesMovimiento[o].saldoValuado,a.detallesMovimiento[o].costo_unitario=Math.round(100*a.detallesMovimiento[o].costo_unitario/87*100)/100):0==o&&a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING&&a.detallesMovimiento[o].movimiento.clase.nombre_corto==p.diccionario.ING_INV_INICIAL?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].saldoFisico*a.detallesMovimiento[o].costo_unitario*100)/100,a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre):0==o&&a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].saldoFisico*a.detallesMovimiento[o].costo_unitario*100)/100,a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre):0==o&&a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_EGR?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].saldoFisico*a.detallesMovimiento[o].costo_unitario*100)/100,a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre):a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico+a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado+a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100,a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre):a.detallesMovimiento[o].movimiento.venta?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico-a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado-a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100,a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre+" Nro. "+a.detallesMovimiento[o].movimiento.venta.factura):(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico-a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado-a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100,a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre),a.detallesMovimiento[o].saldoV=a.detallesMovimiento[o].saldoValuado.toFixed(2);return a},p.obtenerSubGruposProductosEmpresa=function(){A(p.usuario.id_empresa).then(function(e){p.subgruposProducto=e})},p.activoFijoAplicarDatePicker=function(){p.producto.activo_fijo&&e(function(){aplicarDatePickers()},400)},p.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsProducto(p.idModalWizardProductoEdicion,p.idModalWizardProductoVista,p.idModalWizardProductoKardex,p.idModalEliminarProducto,p.idModalContenedorProductoEdicion,p.idModalContenedorProductoVista,p.idModalContenedorProductoKardex,p.idImagenProducto,p.idModalReporteProductosKardex,p.idModalConceptoEdicion),p.buscarAplicacion(p.usuario.aplicacionesUsuario,t.path().substring(1)),p.obtenerColumnasAplicacion(),m.stop()}),p.crearNuevoProducto=function(){p.tipoDePrecio={eliminado:!1},p.steps=[{cabeza:"cabeza-datos-producto",cuerpo:"cuerpo-datos-producto"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"},{cabeza:"cabeza-tipo-producto",cuerpo:"cuerpo-tipo-producto"}],h(p.usuario.id_empresa).then(function(e){p.ultimo_codigo="FC"+e.ultimo_codigo,p.producto=new l({tiposPrecio:[],productosBase:[],id_empresa:p.usuario.id_empresa,imagen:"./img/icon-producto-default.png"}),p.usuario.empresa.usar_consumos||(p.producto.tipoProducto=$.grep(p.tipoProductos,function(e){return e.nombre_corto==p.diccionario.TIPO_PRODUCTO_BASE})[0]),p.producto.codigo="FC"+(e.ultimo_codigo+1),p.productoBaseSeleccion={},p.abrirPopup(p.idModalWizardProductoEdicion)})},p.verProducto=function(e){_(e.id).then(function(e){p.producto=e,p.producto.publicar_panel=1==p.producto.publicar_panel,p.producto.activar_inventario=1==p.producto.activar_inventario;for(var a=p.producto.totalBase=0;a<p.producto.productosBase.length;a++)p.producto.totalBase=p.producto.totalBase+p.producto.productosBase[a].productoBase.precio_unitario*p.producto.productosBase[a].formulacion;p.productoBaseSeleccion={},p.producto.almacenErp&&(p.producto.sucursal_erp=p.producto.almacenErp.sucursal,p.obtenerAlmacenes(p.producto.sucursal_erp.id)),p.abrirPopup(p.idModalWizardProductoVista)})},p.cerrarPopPupVista=function(){p.cerrarPopup(p.idModalWizardProductoVista)},p.cerrarPopPupEdicion=function(){p.cerrarPopup(p.idModalWizardProductoEdicion)},p.cerrarPopPupKardex=function(){p.obtenerProductos(),p.cerrarPopup(p.idModalWizardProductoKardex),p.search.inventario.lote=""},p.abrirModalReporteProductosKardex=function(){p.imp={},p.abrirPopup(p.idModalReporteProductosKardex)},p.cerrarModalReporteProductosKardex=function(){p.imp={},p.cerrarPopup(p.idModalReporteProductosKardex)},p.kardexProducto=function(e){p.producto=e,p.kardexproduto=null,p.filtro={},p.imp={},p.imp.sucursal=1==p.sucursales.length?p.sucursales[0]:null,p.imp.sucursal&&(p.obtenerAlmacenes(p.imp.sucursal.id),p.imp.almacen=1==p.almacenes.length?p.almacenes[0]:null),$("#modal-wizard-producto-kardex").dialog({closeOnEscape:!1}),p.abrirPopup(p.idModalWizardProductoKardex)},p.obtenerDetallesEmpresa=function(e,a,o,i,t){p.paginator=C(),p.paginator.column="razon_social",p.paginator.direccion="asc",p.filtroDetallesProducto={id_producto:e,id_almacen:a,fecha_inicio:o,fecha_fin:i,lote:t},p.paginator.callBack=p.filtroProductoKardex,p.paginator.getSearch("",p.filtroDetallesProducto,null)},p.buscarKardexProducto=function(e,a,o){m.start();var i=""==o.fechaInicioTexto||null==o.fechaInicioTexto?0:new Date(p.convertirFecha(o.fechaInicioTexto)),t=""==o.fechaFinTexto||null==o.fechaFinTexto?0:new Date(p.convertirFecha(o.fechaFinTexto)),r=""==o.lote||null==o.lote?0:o.lote;if(p.idProducto=e,p.idAlmacen=a.id,p.kardexproduto=null,0!=i){var n=g(e,a.id,0,i,r);n.then(function(e){var a=p.obtenerSaldo(e);(n=g(p.idProducto,p.idAlmacen,i,t,r)).then(function(e){0!=a&&e.unshift(a),p.generarKardexProducto(e),m.stop()})})}else p.obtenerDetallesEmpresa(p.idProducto,p.idAlmacen,i,t,r)},p.filtroProductoKardex=function(){g(p.paginator).then(function(e){p.generarKardexProducto(e.kardex),p.paginator.setPages(e.paginas),m.stop()})},p.generarKardexProducto=function(e){var a=p.producto;a.detallesMovimiento=e,p.Math=Math;for(var o=0;o<a.detallesMovimiento.length;o++)a.detallesMovimiento[o].movimiento?(a.detallesMovimiento[o].costo_unitario=Math.round(.87*a.detallesMovimiento[o].costo_unitario*100)/100,0==o&&"SALDO ANTERIOR"==a.detallesMovimiento[o].tipo?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].saldoFisico,a.detallesMovimiento[o].saldoValuado=a.detallesMovimiento[o].saldoValuado,a.detallesMovimiento[o].costo_unitario=Math.round(100*a.detallesMovimiento[o].costo_unitario/87*100)/100):0==o&&a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING&&a.detallesMovimiento[o].movimiento.clase.nombre_corto==p.diccionario.ING_INV_INICIAL?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].saldoFisico*a.detallesMovimiento[o].costo_unitario*100)/100,null!=a.detallesMovimiento[o].movimiento.compra?a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre+" Nro. "+a.detallesMovimiento[o].movimiento.compra.factura:a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre,null!=a.detallesMovimiento[o].inventario?a.detallesMovimiento[o].lote=a.detallesMovimiento[o].inventario.lote:a.detallesMovimiento[o].lote=""):0==o&&a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].saldoFisico*a.detallesMovimiento[o].costo_unitario*100)/100,null!=a.detallesMovimiento[o].movimiento.compra?a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre+" Nro. "+a.detallesMovimiento[o].movimiento.compra.factura:a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre,null!=a.detallesMovimiento[o].inventario?a.detallesMovimiento[o].lote=a.detallesMovimiento[o].inventario.lote:a.detallesMovimiento[o].lote=""):a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING?(0<o?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico+a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado+a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100):(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario*100)/100),a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre,null!=a.detallesMovimiento[o].inventario?a.detallesMovimiento[o].lote=a.detallesMovimiento[o].inventario.lote:a.detallesMovimiento[o].lote=""):a.detallesMovimiento[o].movimiento.venta?(0<o?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico-a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado-a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100):(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario*100)/100),a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre+" Nro. "+a.detallesMovimiento[o].movimiento.venta.factura):(0<o?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico-a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado-a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100):(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario*100)/100),a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre),a.detallesMovimiento[o].saldoV=a.detallesMovimiento[o].saldoValuado.toFixed(2)):console.log(a.detallesMovimiento[o]);p.kardexproduto=a},p.verificarLote=function(e,a){""==e.lote&&p.buscarKardexProducto(p.producto.id,a,e)},p.obtenerSaldo=function(e){var a={};a.detallesMovimiento=e;for(var o=0;o<a.detallesMovimiento.length;o++)a.detallesMovimiento[o].costo_unitario=Math.round(.87*a.detallesMovimiento[o].costo_unitario*100)/100,0==o&&a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING&&a.detallesMovimiento[o].movimiento.clase.nombre_corto==p.diccionario.ING_INV_INICIAL?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].saldoFisico*a.detallesMovimiento[o].costo_unitario*100)/100,a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre):0==o&&a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].saldoFisico*a.detallesMovimiento[o].costo_unitario*100)/100,a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre):a.detallesMovimiento[o].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING?(0<o?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico+a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado+a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100):(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario*100)/100),a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre):a.detallesMovimiento[o].movimiento.venta?(0<o?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico-a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado-a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100):(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario*100)/100),a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre+" Nro. "+a.detallesMovimiento[o].movimiento.venta.factura):(0<o?(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o-1].saldoFisico-a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(100*(a.detallesMovimiento[o-1].saldoValuado-a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario))/100):(a.detallesMovimiento[o].saldoFisico=a.detallesMovimiento[o].cantidad,a.detallesMovimiento[o].saldoValuado=Math.round(a.detallesMovimiento[o].cantidad*a.detallesMovimiento[o].costo_unitario*100)/100),a.detallesMovimiento[o].tipo=a.detallesMovimiento[o].movimiento.clase.nombre),a.detallesMovimiento[o].saldoV=a.detallesMovimiento[o].saldoValuado.toFixed(2);return 0<a.detallesMovimiento.length?(a.detallesMovimiento[a.detallesMovimiento.length-1].tipo="SALDO ANTERIOR",a.detallesMovimiento[a.detallesMovimiento.length-1].movimiento.compra=null,a.detallesMovimiento[a.detallesMovimiento.length-1].movimiento.venta=null,a.detallesMovimiento[a.detallesMovimiento.length-1]):0},p.generarPdfKardexProducto=function(e,a){m.start();var o=e.detallesMovimiento,i=new PDFDocument({size:"letter",margin:10}),t=i.pipe(blobStream()),r=0,n=0,s=200,c=0,l=1,d=Math.ceil(o.length/17);p.dibujarCabeceraPDFKardexProducto(i,1,d,e,a);for(var u=0;u<o.length&&c<=17;u++)i.rect(30,s-10,555,30).stroke(),o[u].movimiento.fecha=new Date(o[u].movimiento.fecha),i.text(o[u].movimiento.fecha.getDate()+"/"+(o[u].movimiento.fecha.getMonth()+1)+"/"+o[u].movimiento.fecha.getFullYear(),40,s-2),0==u?(i.text(o[u].tipo,90,s-2),i.text(o[u].costo_unitario,210,s-2,{width:50,align:"right"}),i.text(o[u].cantidad,265,s-2,{width:50,align:"right"}),r+=o[u].cantidad,i.text(o[u].saldoFisico,360,s-2,{width:50,align:"right"}),a&&(i.text(Math.round(o[u].cantidad*o[u].costo_unitario*100)/100,420,s-2,{width:50,align:"right"}),dsaldoValuado=n+r*o[u].costo_unitario,i.text(o[u].saldoV,510,s-2,{width:50,align:"right"}))):(i.text(o[u].tipo,90,s-6),o[u].movimiento.tipo.nombre_corto==p.diccionario.MOV_ING?(o[u].movimiento.compra&&i.text(o[u].movimiento.compra.proveedor.razon_social,90,s+2,{width:150}),i.text(o[u].costo_unitario,210,s-2,{width:50,align:"right"}),i.text(o[u].cantidad,265,s-2,{width:50,align:"right"}),r+=o[u].cantidad,i.text(o[u].saldoFisico,360,s-2,{width:50,align:"right"}),a&&(i.text(Math.round(o[u].cantidad*o[u].costo_unitario*100)/100,420,s-2,{width:50,align:"right"}),n+=r*o[u].costo_unitario,i.text(o[u].saldoV,510,s-2,{width:50,align:"right"}))):(o[u].movimiento.venta.cliente&&i.text(o[u].movimiento.venta.cliente.razon_social,90,s+2,{width:150}),i.text(o[u].costo_unitario,210,s-2,{width:50,align:"right"}),i.text(o[u].cantidad,310,s-2,{width:50,align:"right"}),r-=o[u].cantidad,i.text(o[u].saldoFisico,360,s-2,{width:50,align:"right"}),a&&(i.text(o[u].total,460,s-2,{width:50,align:"right"}),n=Math.round(100*(n+r*o[u].costo_unitario))/100,i.text(o[u].saldoV,510,s-2,{width:50,align:"right"})))),s+=30,17==++c&&(i.addPage({margin:0,bufferPages:!0}),s=200,c=0,l+=1,p.dibujarCabeceraPDFKardexProducto(i,l,d,e,a),i.font("Helvetica",8));i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),m.stop()},p.usarValuadoKardex=function(){p.usarValuado=!p.usarValuado},p.dibujarCabeceraPDFKardexProducto=function(e,a,o,i,t){e.font("Helvetica-Bold",8),e.text(p.usuario.empresa.razon_social,30,15);var r=new Date,n=r.getMinutes();n<10&&(n="0"+n),1==t?(e.font("Helvetica-Bold",10),e.text(i.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,30,25,{align:"left"}),e.text("KARDEX PRODUCTO",0,65,{align:"center"}),e.font("Helvetica",10),e.text(i.detallesMovimiento[0].movimiento.almacen.sucursal.direccion,30,35,{align:"left"}),e.text("TELF.: "+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono1+"-"+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono2+"-"+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono3,30,45,{align:"left"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"}),e.rect(30,90,555,70).stroke(),e.font("Helvetica-Bold",8),e.text("Producto : ",45,100),e.text("Descripcion : ",45,120),e.text("Unidad de Medida : ",45,140),e.font("Helvetica",7),e.text("Sucursal : "+i.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,475,100),e.text("Almacen : "+i.detallesMovimiento[0].movimiento.almacen.nombre,475,110),e.font("Helvetica-Bold",11).fillColor("red"),e.text("Codigo : "+i.codigo,475,120),e.font("Helvetica",8).fillColor("black"),e.text(i.nombre,120,100),e.text(i.descripcion,120,120),e.text(i.unidad_medida,120,140),e.rect(30,160,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,170),e.text("Detalle",100,170,{width:50}),e.text("c/u",250,170,{width:60}),e.rect(275,160,150,30).stroke(),e.text("Fisico",340,165,{width:50}),e.text("Valuado",485,165,{width:50}),e.rect(275,160,150,15).stroke(),e.text("Ingreso",290,180,{width:50}),e.text("Salida",340,180,{width:50}),e.text("Saldo",390,180,{width:50}),e.rect(425,160,160,15).stroke(),e.text("Ingreso",440,180,{width:50}),e.text("salida",490,180,{width:50}),e.text("Saldo",540,180,{width:50})):(e.font("Helvetica-Bold",10),e.text(i.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,30,25,{align:"left"}),e.text("KARDEX PRODUCTO",0,65,{align:"center"}),e.font("Helvetica",10),e.text(i.detallesMovimiento[0].movimiento.almacen.sucursal.direccion,30,35,{align:"left"}),e.text("TELF.: "+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono1+"-"+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono2+"-"+i.detallesMovimiento[0].movimiento.almacen.sucursal.telefono3,30,45,{align:"left"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"}),e.rect(30,90,555,70).stroke(),e.font("Helvetica-Bold",8),e.text("Producto : ",45,100),e.text("Descripcion : ",45,120),e.text("Unidad de Medida : ",45,140),e.font("Helvetica",7),e.text("Sucursal : "+i.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,475,100),e.text("Almacen : "+i.detallesMovimiento[0].movimiento.almacen.nombre,475,110),e.font("Helvetica-Bold",11).fillColor("red"),e.text("Codigo : "+i.codigo,475,120),e.font("Helvetica",8).fillColor("black"),e.text(i.nombre,120,100),e.text(i.descripcion,120,120),e.text(i.unidad_medida,120,140),e.rect(30,160,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,170),e.text("Detalle",100,170,{width:50}),e.text("c/u",250,170,{width:60}),e.rect(275,160,150,30).stroke(),e.text("Fisico",340,165,{width:50}),e.rect(275,160,150,15).stroke(),e.text("Ingreso",290,180,{width:50}),e.text("Salida",340,180,{width:50}),e.text("Saldo",390,180,{width:50})),e.font("Helvetica",7),e.text("usuario : "+p.usuario.nombre_usuario,475,740),e.text("fecha : "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear()+"  "+r.getHours()+":"+n,475,750)},p.generarExcelKardexProducto=function(e,a){e.detallesMovimiento;m.start();var o=[];o.push(["Codigo","Producto","Fecha","Detalle","Ingreso","Salida","Lote","Fecha Vencimiento"]);for(var i=0;i<e.detallesMovimiento.length;i++){var t=[];if(t.push(e.codigo),t.push(e.nombre),e.detallesMovimiento[i].movimiento.fecha){var r=new Date(e.detallesMovimiento[i].movimiento.fecha);t.push(r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear())}else t.push(" ");e.detallesMovimiento[i].movimiento.venta?e.detallesMovimiento[i].movimiento.venta.cliente?t.push(e.detallesMovimiento[i].tipo+" "+e.detallesMovimiento[i].movimiento.venta.cliente.razon_social):t.push(e.detallesMovimiento[i].tipo):e.detallesMovimiento[i].movimiento.venta?t.push(" "):t.push(e.detallesMovimiento[i].tipo),7!=e.detallesMovimiento[i].movimiento.id_tipo&&e.detallesMovimiento[i].cantidad?t.push(e.detallesMovimiento[i].cantidad):t.push(" "),6!=e.detallesMovimiento[i].movimiento.id_tipo&&e.detallesMovimiento[i].cantidad?t.push(e.detallesMovimiento[i].cantidad):t.push(" "),null!=e.detallesMovimiento[i].inventario?(t.push(e.detallesMovimiento[i].inventario.lote),t.push(e.detallesMovimiento[i].inventario.fecha_vencimiento)):(t.push(e.detallesMovimiento[i].lote),t.push(" ")),o.push(t)}var n=new Workbook,s=sheet_from_array_of_arrays(o);n.SheetNames.push("SheetJS"),n.Sheets.SheetJS=s;var c=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"REPORTE-USUARIOS.xlsx"),m.stop()},p.modificarProducto=function(e){p.steps=[{cabeza:"cabeza-datos-producto",cuerpo:"cuerpo-datos-producto"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"},{cabeza:"cabeza-tipo-producto",cuerpo:"cuerpo-tipo-producto"}],_(e.id).then(function(e){p.producto=e,p.producto.publicar_panel=1==p.producto.publicar_panel,p.producto.activar_inventario=1==p.producto.activar_inventario;for(var a=p.producto.totalBase=0;a<p.producto.productosBase.length;a++)p.producto.totalBase=p.producto.totalBase+p.producto.productosBase[a].productoBase.precio_unitario*p.producto.productosBase[a].formulacion;p.productoBaseSeleccion={},p.producto.almacenErp&&(p.producto.sucursal_erp=p.producto.almacenErp.sucursal,p.obtenerAlmacenes(p.producto.sucursal_erp.id)),p.abrirPopup(p.idModalWizardProductoEdicion)})},p.mostrarConfirmacionEliminacion=function(e){p.producto=new l(e),p.abrirPopup(p.idModalEliminarProducto),console.log(e)},p.cerrarConfirmacionEliminacion=function(){p.cerrarPopup(p.idModalEliminarProducto)},p.eliminarProducto=function(e){m.start(),p.cerrarConfirmacionEliminacion(),e.$delete().then(function(e){console.log(e),p.mostrarMensaje(e.message)}),p.recargarItemsTabla(),m.stop()},p.obtenerSucursales=function(){for(var e=[],a=0;a<p.usuario.sucursalesUsuario.length;a++)e.push(p.usuario.sucursalesUsuario[a].sucursal);p.sucursales=e},p.obtenerAlmacenes=function(a){p.almacenes=[];var e=$.grep(p.sucursales,function(e){return e.id==a})[0];p.almacenes=e.almacenes},p.establecerAlmacen=function(e){p.id_almacen=e},p.saveForm=function(e,a){e&&("Siguiente"!=$("#siguiente").text().trim()&&p.guardarProducto(a,!0))},p.establecerProductoBase=function(e){p.productoBase={id:e.id,nombre:e.nombre,formulacion:0,unidad_medida:e.unidad_medida}},p.actualizarProducto=function(a){_(a.id).then(function(e){e.publicar_panel=a.publicar_panel,e.activar_inventario=a.activar_inventario,p.guardarProducto(e,!1)})},p.guardarProducto=function(e,s){m.start();var c=e.imagen;e.usuario=p.usuario.id,e.id?l.update({idProducto:e.id},e,function(e){if(null==e.signedRequest)m.stop(),p.cerrarPopPupEdicion(),p.mostrarMensaje("Actualizado Exitosamente!"),s&&p.recargarItemsTabla();else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(m.stop(),p.cerrarPopPupEdicion(),p.mostrarMensaje("Actualizado Exitosamente!"),s&&p.recargarItemsTabla()):alert("Could not upload file."))};for(var o=atob(c.split(",")[1]),i=[],t=0;t<o.length;t++)i.push(o.charCodeAt(t));var r=new Blob([new Uint8Array(i)],{type:"image/jpeg"}),n=new File([r],e.image_name,{type:"image/jpeg"});console.log(n),a.send(n)}}):e.$save(function(e){if(null==e.signedRequest)m.stop(),p.producto=new l({}),p.cerrarPopPupEdicion(),p.mostrarMensaje("Guardado Exitosamente!"),s&&p.recargarItemsTabla();else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(m.stop(),p.producto=new l({}),p.cerrarPopPupEdicion(),p.mostrarMensaje("Guardado Exitosamente!"),s&&p.recargarItemsTabla()):alert("Could not upload file."))};for(var o=atob(c.split(",")[1]),i=[],t=0;t<o.length;t++)i.push(o.charCodeAt(t));var r=new Blob([new Uint8Array(i)],{type:"image/jpeg"}),n=new File([r],e.image_name,{type:"image/jpeg"});a.send(n)}},function(e){m.stop(),p.cerrarPopPupEdicion(),p.mostrarMensaje("Ocurrio un problema al momento de guardar!"),s&&p.recargarItemsTabla()})},p.obtenerTipoProducto=function(){m.start(),u("TPS").then(function(e){p.tipoProductos=e.clases,m.stop()})},p.eliminarDetalleProductosBase=function(e){e.eliminado=!0,p.producto.totalBase=p.producto.totalBase-e.productoBase.precio_unitario*e.formulacion},p.agregarDetalleProductosBase=function(e,a){a.formulacion=e.formulacion,console.log(a),p.producto.productosBase.push({productoBase:a,formulacion:e.formulacion}),p.productoBase={},p.productoBaseSeleccion={};for(var o=p.producto.totalBase=0;o<p.producto.productosBase.length;o++)p.producto.totalBase=p.producto.totalBase+p.producto.productosBase[o].productoBase.precio_unitario*p.producto.productosBase[o].formulacion,console.log(p.producto.totalBase);console.log(p.producto.productosBase)},p.obtenerProductos=function(){p.paginator=C(),p.paginator.column="nombre",p.paginator.filter=p.grupo,p.paginator.callBack=p.buscarProductos,p.paginator.getSearch("",null,null)},p.buscarProducto=function(e){if(""!=e&&null!=e)return b(p.usuario.id_empresa,e)},p.buscarProductos=function(){m.start(),p.paginator.filter=void 0!==p.grupo?p.grupo:{id:0},c(p.usuario.id_empresa,p.paginator,p.usuario.id).then(function(e){if(e.hasErr)p.mostrarMensaje(e.mensaje);else{p.paginator.setPages(e.paginas),p.productos=e.productos;for(var a=0;a<p.productos.length;a++)p.productos[a].publicar_panel=1==p.productos[a].publicar_panel,p.productos[a].activar_inventario=1==p.productos[a].activar_inventario}m.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";p.mostrarMensaje(a),m.stop()})},p.descargarCatalogo=function(n){if(m.start(),n)var s=["N°","Campo","Empleado","C.I.","Estado","Cargo"],c=[];else{s=["Código","Nombre","Unidad Medida","Precio Unitario","Descripcion","Inventario Mínimo","Grupo","Sub-grupo","Caracteristica Especial-1","Caracteristica Especial-2","Código de Fabrica","Comisión (%)","Alerta","Descuento","Descuento Elección"];var l=[{wch:10},{wch:20},{wch:15},{wch:15},{wch:25},{wch:15},{wch:7},{wch:9},{wch:20},{wch:20},{wch:15},{wch:10},{wch:8},{wch:10},{wch:15}];c=[]}var d=[];M(p.usuario.id_empresa,void 0!==p.grupo?p.grupo:{id:0},p.usuario.id).then(function(e){if(0==e.catalogo.length)return p.mostrarMensaje("No existen datos"),void m.stop();if(e.hasErr)p.mostrarMensaje(e.mensaje);else{for(var a=0;a<e.catalogo.length;a++){if(n)var o=[];else o=[];o.push(e.catalogo[a].codigo),o.push(e.catalogo[a].nombre),o.push(e.catalogo[a].unidad_medida),o.push(e.catalogo[a].precio_unitario),o.push(e.catalogo[a].descripcion),o.push(e.catalogo[a].inventario_minimo),o.push(null!==e.catalogo[a].grupo&&void 0!==e.catalogo[a].grupo?e.catalogo[a].grupo.nombre:"Sin grupo"),o.push(null!==e.catalogo[a].subgrupo&&void 0!==e.catalogo[a].subgrupo?e.catalogo[a].subgrupo.nombre:"Sin subgrupo"),o.push(e.catalogo[a].caracteristica_especial1),o.push(e.catalogo[a].caracteristica_especial2),o.push(e.catalogo[a].codigo_fabrica),o.push(e.catalogo[a].comision),o.push(e.catalogo[a].alerta),o.push(e.catalogo[a].descuento),o.push(e.catalogo[a].descuento_fijo),d.push(o)}if(c.push(s),d.map(function(e){c.push(e)}),n)grafico?p.reportePorMesGrafico(c,mesesReporte):(m.stop(),p.reportePorMesesPdf(c,fromMonth,fromYear,untilMonth,untilYear));else{var i=new Workbook,t=sheet_from_array_of_arrays(c);t["!cols"]=l,i.SheetNames.push("SheetJS"),i.Sheets.SheetJS=t;var r=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"Catálogo productos.xlsx"),m.stop()}}}).catch(function(e){var a=void 0!==e.data&&null!==e.data?e.data+(void 0!==e.stack&&null!==e.stack?" "+e.stack:""):void 0!==e.message&&null!==e.message?e.message:"ERROR";p.mostrarMensaje("Se produjo un error! "+a),m.stop()})},p.subirExcelProductos=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){m.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.nombre=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.unidad_medida=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.precio_unitario=null!=r["D"+t]&&""!=r["D"+t]?parseFloat(r["D"+t].v.toString()):null,s.descripcion=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.inventario_minimo=null!=r["F"+t]&&""!=r["F"+t]?parseInt(r["F"+t].v.toString()):null,s.grupo=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.subgrupo=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,s.caracteristica_especial1=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,s.caracteristica_especial2=null!=r["J"+t]&&""!=r["J"+t]?r["J"+t].v.toString():null,s.codigo_fabrica=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,s.comision=null!=r["L"+t]&&""!=r["L"+t]?parseFloat(r["L"+t].v.toString()):null,s.alerta=null!=r["M"+t]&&""!=r["M"+t]?parseFloat(r["M"+t].v.toString()):null,s.descuento=null!=r["N"+t]&&""!=r["N"+t]?parseFloat(r["N"+t].v.toString()):null,s.descuento_fijo=null!=r["O"+t]&&""!=r["N"+t]?1==parseInt(r["O"+t].v.toString()):null,s.marca=null!=r["P"+t]&&""!=r["P"+t]?r["P"+t].v.toString():null,s.tipo_producto=null!=r["Q"+t]&&""!=r["Q"+t]?r["Q"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);p.guardarProductos(n),m.stop()},t.readAsBinaryString(o)}},p.guardarProductos=function(e){new v({productos:e,id_empresa:p.usuario.id_empresa}).$save(function(e){m.stop(),p.mostrarMensaje("Guardado Exitosamente!"),p.recargarItemsTabla()},function(e){m.stop(),p.mostrarMensaje("Ocurrio un problema al momento de guardar!"),p.recargarItemsTabla()})},p.subirExcelFormulacionProductos=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){m.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo_final=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.nombre_final=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.nombre_base=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.codigo_base=null!=r["D"+t]&&""!=r["D"+t]?parseFloat(r["D"+t].v.toString()):null,s.formulacion=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);p.guardarFormulacionProductos(n),m.stop()},t.readAsBinaryString(o)}},p.guardarFormulacionProductos=function(e){I(p.usuario.id_empresa,e).then(function(e){e.hasErr?p.mostrarMensaje(e.mensajes):e.mensajes?p.mostrarMensaje(e.mensaje+e.mensajes):p.mostrarMensaje(e.mensaje),m.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";p.mostrarMensaje(a),m.stop()})},p.buscarCuenta=function(e){if(""!=e&&null!=e)return P(p.usuario.id_empresa,e)},p.abrirDialogConceptoEdicion=function(e){p.tipo_edicion=e,p.clase={},p.abrirPopup(p.idModalConceptoEdicion)},p.cerrarDialogConceptoEdicion=function(){p.cerrarPopup(p.idModalConceptoEdicion)},p.agregarConceptoEdicion=function(e){e.nombre&&e.nombre_corto&&(-1==p.tipo_edicion.clases.indexOf(e)&&p.tipo_edicion.clases.push(e),p.clase={})},p.modificarConceptoEdicion=function(e){p.clase=e},p.removerConceptoEdicion=function(e){e.eliminado=!0},p.guardarConceptoEdicion=function(a){m.start(),E.update({id_tipo:a.id},a,function(e){u(a.nombre_corto).then(function(e){a=e,m.stop(),p.cerrarDialogConceptoEdicion(),p.mostrarMensaje("Guardado Exitosamente!")})})},p.obtenerTiposPrecio=function(){m.start(),x("T_PAGO_PRODUCTO",p.usuario.id_empresa).then(function(e){p.tiposPrecios=e,m.stop()})},p.agregarTipoPrecio=function(e,a){e.tipoPrecio&&e.precio_unitario?(a.tipoprecio.$invalid=!1,a.PrecioProductoTipo.$invalid=!1,e.edit||p.producto.tiposPrecio.push(e),p.tipoDePrecio={eliminado:!1}):(a.tipoprecio.$invalid=!0,a.PrecioProductoTipo.$invalid=!0)},p.editarTipoPrecioProducto=function(e){p.tipoDePrecio=e,p.tipoDePrecio.edit=!0},p.eliminarTipoPrecioProducto=function(e,a){e.id?e.eliminado=!0:p.producto.tiposPrecio.splice(a,1)},p.$on("$routeChangeStart",function(e,a){p.eliminarPopup(p.idModalWizardProductoEdicion),p.eliminarPopup(p.idModalWizardProductoVista),p.eliminarPopup(p.idModalEliminarProducto),p.eliminarPopup(p.idModalWizardProductoKardex),p.eliminarPopup(p.idModalReporteProductosKardex),p.eliminarPopup(p.idModalConceptoEdicion)}),p.inicio()}]),angular.module("agil.controladores").controller("controladorProformas",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","Paginator","$timeout","blockUI","ClasesTipo","socket","ObtenerCambioMoneda","ClientesNit","FiltroProformas","ActividadServicio","ActividadesEmpresa","ServiciosEmpresa","ProformaInfo","Clientes","fechasProforma","ListaSucursalesActividadesDosificacionEmpresa","DosificacionesDisponibles","ListaSucursalesUsuario","ListaHistorialActividad","ImprimirSalida","ConfiguracionesFacturasProformas","ProformasFacturadas","ActualizarProforma","GuardarProformas","ProformaEliminar","GuardarActividadesEmpresa","obtenerAsignacionCentroCosto","GuardarAsignacionCentroCosto",function(u,a,e,o,i,t,r,n,s,c,p,l,d,m,f,g,v,h,b,C,P,_,M,D,E,x,S,A,T,w,I,R,j,O,F){u.usuario=JSON.parse(n.usuario),u.modalConfiguracionActividadesServicios="modalConfiguracionActividadesServicios",u.wizardConfiguracionActividadesServicios="modal-wizard-panel-container",u.modalConfiguracionActividades="modalConfiguracionActividades",u.wizardConfiguracionActividades="modal-wizard-panel-container-actividad",u.dialogProformaEdicion="proforma-edicion",u.dialogClientesProforma="dialog-cliente-proforma",u.dialogmodalFechas="modalFechas",u.dialogBusquedaServicio="dialog-Busqueda-servicio-proforma",u.dialogDosificacionesDisponibles="dialog-dosificaciones-disponibles",u.confirmarDosificacion="dialog-dosificar-actividad",u.asignacionCentroCostoCliente="modalEmpresaCentroCosto",u.dialogClienteEmpresa="dialog-cliente-empresa",u.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsProformas(u.modalConfiguracionActividadesServicios,u.wizardConfiguracionActividadesServicios,u.dialogProformaEdicion,u.dialogClientesProforma,u.modalConfiguracionActividades,u.wizardConfiguracionActividades,u.dialogmodalFechas,u.dialogBusquedaServicio,u.dialogDosificacionesDisponibles,u.confirmarDosificacion,u.asignacionCentroCostoCliente,u.dialogClienteEmpresa),u.buscarAplicacion(u.usuario.aplicacionesUsuario,t.path().substring(1))}),u.$on("$routeChangeStart",function(e,a){u.eliminarPopup(u.modalConfiguracionActividadesServicios),u.eliminarPopup(u.dialogProformaEdicion),u.eliminarPopup(u.modalConfiguracionActividades),u.eliminarPopup(u.dialogClientesProforma),u.eliminarPopup(u.dialogmodalFechas),u.eliminarPopup(u.dialogBusquedaServicio),u.eliminarPopup(u.dialogDosificacionesDisponibles),u.eliminarPopup(u.confirmarDosificacion),u.eliminarPopup(u.asignacionCentroCostoCliente),u.eliminarPopup(u.dialogClienteEmpresa)}),u.abrirdialogClienteEmpresa=function(){u.abrirPopup(u.dialogClienteEmpresa)},u.cerrardialogClienteEmpresa=function(){u.cerrarPopup(u.dialogClienteEmpresa)},u.calcularTotalProformas=function(){u.totalProformas=0;var a=new Date;u.totalProformasDolar=0,m(new Date).then(function(e){for(var a=u.totalProformas=0;a<u.proformas.length;a++)u.proformas[a].eliminado||(u.totalProformas+=u.proformas[a].totalImporteBs,u.totalProformasDolar=u.totalProformas/e.monedaCambio.dolar)},function(e){u.mostrarMensaje("Hubo un problema al recuperar el cambio de dolar para "+a.toLocaleDateString)})},u.obtenerHistorialActividad=function(e){void 0!==e.id&&x(e.actividad.id,e.id_sucursal).then(function(e){u.historialActividad=e.historial})},u.verificarDetallesProformas=function(){if(0<u.detallesProformas.length){var a=0;return u.detallesProformas.forEach(function(e){e.eliminado&&(a+=1)}),a!==u.detallesProformas.length}return!u.proforma.ver&&!!u.proforma.cliente},u.verificarBloqueoServicios=function(){return void 0!==u.proformaFechas?void 0!==u.proformaFechas.ver:u.proforma.editar?u.verificarDetallesProformas():!u.proforma.nueva},u.eliminar=function(a){p.start(),R(a).then(function(e){e.hasErr||(a.eliminado=!0,u.calcularTotalProformas()),u.mostrarMensaje(e.mensaje),p.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a),p.stop()})},u.editar=function(a,i){if(a.fecha_factura){var e=new Date(a.fecha_factura);if(null!==a.fecha_factura&&void 0!==a.fecha_factura&&"[object Date]"===Object.prototype.toString.call(e)){if(isNaN(e.getTime()))return void u.mostrarMensaje("Hay un problema con la fecha de la factura. Se bloqueará la edición de esta proforma.");if(!i)return void u.mostrarMensaje("Esta proforma no se puede editar, ya fué facturada.")}}p.start();var o=new Date(a.fecha_proforma);m(o).then(function(e){e.monedaCambio?(u.moneda=e.monedaCambio,void 0!==u.detalleProforma&&u.calcularImporte()):(u.moneda={ufv:"--",dolar:"--"},u.mostrarMensaje("La fecha "+u.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema.")),C(a.id,a.actividadEconomica.id).then(function(e){if(u.proforma=e.proforma,u.proforma.editar=!0,u.proforma.sucursal=e.proforma.sucursal,u.obtenerActividadesSucursal(u.proforma.sucursal.id),u.proforma.actividadEconomica=e.proforma.actividadEconomica,u.obtenerServiciosActividadEmpresaPrincipal(u.proforma.actividadEconomica),void 0!==i&&(u.proforma.ver=!0),void 0!==e.mensaje)u.mostrarMensaje(e.mensaje);else{u.proforma.fecha_proforma=u.fechaATexto(new Date(u.proforma.fecha_proforma));var a=new Date(u.convertirFecha(u.proforma.fecha_proforma));u.obtenerCambioMonedaProforma(a);var o=u.moneda.dolar;u.proforma.periodo_mes={id:u.proforma.periodo_mes},u.proforma.periodo_anio={id:u.proforma.periodo_anio},u.obtenercentroCostosClienteEmpresa(u.proforma.cliente),u.detallesProformas=u.proforma.detallesProformas,u.detallesProformas.map(function(e,a){u.detalleProforma=e,u.calcularImporte(),u.detalleProforma=void 0}),u.proforma.totalImporteSus=u.proforma.totalImporteBs/o,u.proforma.importeLiteral=ConvertirALiteral(u.proforma.totalImporteBs.toFixed(2))}p.stop()}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})}),u.detalleProforma=void 0,u.abrirdialogProformaEdicion(u.proforma)},u.ver=function(e){u.proforma=e,u.proforma.ver=!0,u.editar(u.proforma,!0)},u.mostarMensajeConfirmacionEliminacionActividad=function(e){u.abrirPopupConfirmacionEliminacion(u.eliminarDetalleActividadEmpresa,e)},u.imprimirFactura=function(e){if(null!=e.fecha_factura){p.start();var i=[];T(u.usuario.id_empresa,e.factura).then(function(e){i=e.datosProformas;var o={};A(u.usuario.id_empresa).then(function(a){l("MOVEGR").then(function(e){e.clases.forEach(function(e){"FACTURACIÓN"==e.nombre&&"FACT"==e.nombre_corto&&(o=e)}),l("TIPA").then(function(e){u.tiposPago=e.clases,u.facturaProformas={},u.facturaProformas.configuracion=a.configuracion,u.facturaProformas.movimiento=o,u.facturaProformas.cliente=i[0].cliente,u.facturaProformas.autorizacion=i[0].autorizacion,u.facturaProformas.factura=i[0].factura,u.facturaProformas.codigo_control=i[0].codigo_control,u.facturaProformas.fecha=new Date(i[0].fecha_factura),u.facturaProformas.fecha_limite_emision=new Date(i[0].fecha_limite_emision),u.facturaProformas.actividad=i[0].actividadEconomica,u.facturaProformas.sucursal=i[0].sucursal,u.facturaProformas.detallesVenta=[],u.facturaProformas.detalle="",u.facturaProformas.totalImporteBs=i[0].totalImporteBs,u.facturaProformas.importe=i[0].importe,u.facturaProformas.fecha_factura=new Date(i[0].fecha_factura).toLocaleDateString(),u.facturaProformas.fechaTexto=new Date(u.facturaProformas.fecha).toLocaleDateString(),u.facturaProformas.periodo_mes=i[0].mes,u.facturaProformas.periodo_anio=i[0].anio,u.facturaProformas.datosProformas=i,u.facturaProformas.descripcion="",u.facturaProformas.movimiento=o,u.facturaProformas.id_movimiento=u.facturaProformas.movimiento.id,u.facturaProformas.id_tipo_pago=u.tiposPago[0].id,u.facturaProformas.tipoPago=u.tiposPago[1],u.obtenerTipoEgreso(u.facturaProformas.movimiento),u.esContado=!1,u.facturaProformas.usar_servicios=!0,u.facturaProformas.id_usuario=u.usuario.id,u.facturaProformas.fecha=i[0].fecha,u.facturaProformas.id_empresa=u.usuario.id_empresa,u.facturaProformas.datosProformas.forEach(function(o,i){u.facturaProformas.descripcion+=o.detalle+". ",u.facturaProformas.importe=0,u.facturaProformas.total=0;var e=m(o.fecha_proforma),a={ufv:"--",dolar:"--"};e.then(function(e){e.monedaCambio&&(a={ufv:e.monedaCambio.ufv,dolar:e.monedaCambio.dolar}),o.tc=a,o.detallesProformas.map(function(e,a){u.facturaProformas.importe+=e.precio_unitario*e.cantidad,u.facturaProformas.detallesVenta.push(e),u.facturaProformas.total=u.facturaProformas.importe,u.facturaProformas.importeLiteral=ConvertirALiteral(u.facturaProformas.importe.toFixed(2)),u.facturaProformas.numero_literal=u.facturaProformas.importeLiteral,e.tc=o.tc,e.total=e.importe*e.cantidad,a===o.detallesProformas.length-1&&(i==u.facturaProformas.datosProformas.length-1&&(u.checkResourceImg(u.usuario.empresa.imagen,u.usuario.empresa.imageLoaded)?convertUrlToBase64Image(u.usuario.empresa.imagen,function(e){0<e.length&&"error"!==e?(u.usuario.empresa.imagen=e,u.usuario.empresa.imageLoaded=!0,S("FACT",u.facturaProformas,!1,u.usuario)):convertUrlToBase64Image("img/agilsoftware.png",function(e){u.mostrarMensaje("No se encuentra la imagen de la empresa. Se usara la imagen del software."),u.usuario.empresa.imagen=e,u.usuario.empresa.imageLoaded=!0,S("FACT",u.facturaProformas,!1,u.usuario)})}):(u.mostrarMensaje("Existe un problema con la imagen, no se incluira en la impresión."),c(function(){S("FACT",u.facturaProformas,!1,u.usuario)},1500))),u.dolarActual=u.obtenerCambioDolarActual())})}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})}),p.stop()}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a),p.stop()})}else u.mostrarMensaje("La proforma aún no ha sido facturada.")},u.eliminarDetalleActividadEmpresa=function(e){void 0!==e.id?e.eliminado=!0:u.actividadesSucursal.splice(u.actividadesSucursal.indexOf(e),1),u.cerrarConfirmacionEliminacion()},u.getFecha=function(){return void 0!==u.proforma?new Date(u.proforma.fecha):new Date},u.editarServicio=function(e){e.editado=!0,u.nActividad.actividadEconomica.actividad=e.actividad,u.nActividad.servicio=e},u.modificarProformaPrecioUnitarioServicio=function(e){void 0===e.editarPrecio?e.editarPrecio=!0:e.editarPrecio=void 0},u.actualizarPeriodo=function(e){var a=new Date(u.convertirFecha(e));u.obtenerCambioMonedaProforma(a),u.proforma.periodo_mes.id=a.getMonth(),u.proforma.periodo_anio.id=a.getFullYear()},u.buscarCliente=function(e){if(""!=e&&null!=e)return f(u.usuario.id_empresa,e)},u.establecerCliente=function(e){!u.proforma.ver&&u.verificarDetallesProformas()?(u.proforma.cliente=e,u.obtenercentroCostosClienteEmpresa(e),u.enfocar("proformaDetalle")):u.mostrarMensaje("No se permite.")},u.enfocar=function(e){c(function(){$("#"+e).focus()},0)},u.inicio=function(){u.listaCentroCostosClienteEmpresa=[],u.actividadesSucursal=[],u.nActividad={},u.proforma={},u.configuracionActividadServicio=[],u.servicios=[],u.detalleProforma={},u.detallesProformas=[],u.obtenerClientes(),u.obtenerActividadesEmpresa(u.usuario.empresa.id),u.filtro={empresa:u.usuario.empresa.id,mes:0,anio:0,sucursal:0,actividadEconomica:0,servicio:0,monto:0,razon:0,usuario:"",pagina:1,items_pagina:10,busqueda:0,numero:0},u.meses=[{id:0,nombre:"Enero"},{id:1,nombre:"Febrero"},{id:2,nombre:"Marzo"},{id:3,nombre:"Abril"},{id:4,nombre:"Mayo"},{id:5,nombre:"Junio"},{id:6,nombre:"Julio"},{id:7,nombre:"Agosto"},{id:8,nombre:"Septiembre"},{id:9,nombre:"Octubre"},{id:10,nombre:"Noviembre"},{id:11,nombre:"Diciembre"}],u.proformas=[],u.sucursalesUsuario="";for(var e=0;e<u.usuario.sucursalesUsuario.length;e++)u.sucursalesUsuario=u.sucursalesUsuario+u.usuario.sucursalesUsuario[e].sucursal.id,e+1!=u.usuario.sucursalesUsuario.length&&(u.sucursalesUsuario=u.sucursalesUsuario+",");u.obtenerPaginador(),u.obtenerCentroCosto()},u.verificarFechaRecepcion=function(e){return null==e},u.verificarFechaProformaOk=function(e){return null==e},u.verificarFechaFactura=function(e){return null==e},u.actualizarFechas=function(e){p.start(),void 0!==e&&(e.fecha_recepcion=e.fecha_recepcion instanceof Date?e.fecha_recepcion:null===e.fecha_recepcion?null:new Date(u.convertirFecha(e.fecha_recepcion)),e.fecha_proforma_ok=e.fecha_proforma_ok instanceof Date?e.fecha_proforma_ok:null===e.fecha_proforma_ok?null:new Date(u.convertirFecha(e.fecha_proforma_ok)),e.fecha_factura=e.fecha_factura instanceof Date?e.fecha_factura:null===e.fecha_factura?null:new Date(u.convertirFecha(e.fecha_factura)),e.fecha_cobro=e.fecha_cobro instanceof Date?e.fecha_cobro:null===e.fecha_cobro?null:new Date(u.convertirFecha(e.fecha_cobro)),_.save({id:e.id},e,function(e){u.proforma=void 0,u.mostrarMensaje(e.mensaje),u.cerrardialogmodalFechas(),u.recargarItemsTabla(),p.stop()},function(e){u.mostrarMensaje(void 0===e.message?e.stack:e.message),p.stop()}))},u.sinFuncionalidad=function(){u.mostrarMensaje("Sin funcionalidad")},u.agregardetalleProforma=function(e){void 0!==e.id_servicio&&(u.proforma.totalImporteBs=0,u.proforma.totalImporteSus=0,e.editar?(u.detallesProformas[u.detallesProformas.indexOf(e)]=e,u.detalleProforma.editar=void 0):u.detallesProformas.push(e),u.detalleProforma={},u.detallesProformas.forEach(function(e){e.eliminado||(u.proforma.totalImporteBs+=e.importe,u.proforma.totalImporteSus+=e.importeSus)}),u.proforma.importeLiteral=ConvertirALiteral(u.proforma.totalImporteBs.toFixed(2)),u.modificarProformaPrecioUnitarioServicio(e)),u.enfocar("id_servicioProforma")},u.obtenerCambioMonedaProforma=function(e){m(e).then(function(e){e.monedaCambio?(u.moneda=e.monedaCambio,void 0!==u.detalleProforma&&u.calcularImporte()):(u.moneda={ufv:"--",dolar:"--"},u.mostrarMensaje("La fecha "+u.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema."))})},u.obtenerCentroCosto=function(){l("CENCOS").then(function(e){u.centroCostos=e.clases.sort(function(e,a){return e.nombre>a.nombre?1:e.nombre<a.nombre?-1:0})})},u.obtenerActividadesSucursal=function(a){var e=$.grep(u.sucursales,function(e){return e.id==a})[0];u.actividadesDosificaciones=e.actividadesDosificaciones,u.actividadesSucursal=[],u.actividadesDosificaciones.map(function(e){e.dosificacion&&(e.expirado||e.dosificacion.expirado?u.dosificacionesExpiradas=!0:u.actividadesSucursal.push(e.actividad))})},u.obtenerActividadesGral=function(){u.actividades=[],l("ACTCOM").then(function(e){u.actividades=e.clases.sort()})},u.obtenerPaginador=function(){p.start(),u.paginator=s(),u.paginator.column="fecha",u.paginator.direccion="asc",u.filtro={empresa:u.usuario.empresa.id,mes:0,anio:0,sucursal:0,actividadEconomica:0,servicio:0,monto:0,razon:0,usuario:0,numero:0},u.paginator.filter=u.filtro,u.paginator.callBack=u.obtenerProformas,u.paginator.getSearch("",u.filtro,null),u.filtro={empresa:u.usuario.empresa.id,mes:"",anio:"",sucursal:"",actividadEconomica:"",servicio:"",monto:"",razon:"",usuario:"",numero:""},p.stop()},u.guardarConfiguracionActividadServicios=function(e){if("Siguiente"!=$("#siguiente").text().trim()){p.start(),u.nActividad={};var o=[],a=e.map(function(e,a){if(void 0===e.id||e.eliminado||void 0!==e.editado)return e;o.push(a)});if(o.reverse().forEach(function(e){a.splice(e,1)}),0<a.length)GuardarActividadServicio(u.usuario.empresa.id,0,a).then(function(e){u.mostrarMensaje(e.mensaje),u.obtenerSucursales(),p.stop(),u.cerrarConfiguracionActividadesServicios()}).catch(function(e){u.mostrarMensaje(void 0===e.message?e.stack:e.message),p.stop(),u.cerrarConfiguracionActividadesServicios()});else p.stop(),u.cerrarConfiguracionActividadesServicios()}},u.buscarservicio=function(e){if(""!=e&&null!=e){if(0<u.configuracionActividadServicio.length)return a("filter")(u.configuracionActividadServicio,e);void 0!==u.proforma&&void 0!==u.proforma.actividadEconomica&&u.mostrarMensaje('No hay servicios en la actividad seleccionada: "'+u.proforma.actividadEconomica.nombre+'"')}},u.establecerservicio=function(e,a){var o=Object.assign({},e);u.detalleProforma&&u.detalleProforma.servicio?(u.detalleProforma.id_servicio=o.id,u.detalleProforma.servicio=o,u.detalleProforma.precio_unitario=o.precio,u.detalleProforma.actividad_id=o.actividad.id,u.detalleProforma.actividad=o.actividad):u.detalleProforma={id_servicio:o.id,cantidad:1,servicio:o,precio_unitario:o.precio,actividad_id:o.actividad.id,actividad:o.actividad},u.detalleProforma.importe=u.detalleProforma.precio_unitario*u.detalleProforma.cantidad,void 0!==u.moneda&&null!==u.moneda.dolar&&"--"!==u.moneda.dolar&&(u.detalleProforma.precioSus=u.detalleProforma.precio_unitario/u.moneda.dolar,u.detalleProforma.importeSus=u.detalleProforma.precio_unitario/u.moneda.dolar*u.detalleProforma.cantidad),u.enfocar("cantidad"),void 0!==a&&u.cerrarBusquedaServiciosProforma()},u.calcularImporte=function(e){void 0===e?(u.detalleProforma.importe=u.detalleProforma.precio_unitario*u.detalleProforma.cantidad,void 0!==u.moneda&&null!==u.moneda.dolar&&"--"!==u.moneda.dolar&&(u.detalleProforma.precioSus=u.detalleProforma.precio_unitario/u.moneda.dolar,u.detalleProforma.importeSus=u.detalleProforma.precio_unitario/u.moneda.dolar*u.detalleProforma.cantidad)):(u.detalleProforma.importeSus=u.detalleProforma.precioSus*u.detalleProforma.cantidad,void 0!==u.moneda&&null!==u.moneda.dolar&&"--"!==u.moneda.dolar&&(u.detalleProforma.precio_unitario=u.detalleProforma.precioSus*u.moneda.dolar,u.detalleProforma.importe=u.detalleProforma.precioSus*u.moneda.dolar*u.detalleProforma.cantidad))},u.agregarDetalleActividadServicio=function(a){if(null!=a){var e=!1;if(void 0!==a.actividadEconomica&&null!==a.actividadEconomica||(e=!0),void 0===a.servicio&&null===a.servicio?e=!0:void 0===a.servicio.codigo||void 0===a.servicio.nombre||void 0===a.servicio.precio?e=!0:""!==a.servicio.codigo&&""!==a.servicio.nombre&&""!==a.servicio.precio||(e=!0),void 0!==a.actividadEconomica.dosificacion&&null!==a.actividadEconomica.dosificacion||(e=!0,errDos=!0),e)errDos?u.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar."):u.mostrarMensaje("Revise los datos e intente nuevamente.");else{var o=u.buscarservicio(a.servicio.nombre);if(void 0!==o)if(o.length<1)if(a.actividadEconomica.dosificacion,void 0!==a.actividadEconomica.dosificacion.id&&null!==a.actividadEconomica.dosificacion.id){var i={id:a.id,actividad:a.actividadEconomica.actividad,codigo:a.servicio.codigo,nombre:a.servicio.nombre,precio:a.servicio.precio};u.configuracionActividadServicio.push(i),u.nActividad.servicio=void 0}else u.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.");else if(void 0===a.servicio.id){var t=!1;if(o.map(function(e){e.nombre===a.servicio.nombre&&(t=!0,u.mostrarMensaje("El servicio ya fue asignado a esta actividad")),e.codigo===a.servicio.codigo&&(t=!0,u.mostrarMensaje("El codigo del servicio ya esta en uso o listo para ser asignado."))}),!t)if(void 0!==a.actividadEconomica.dosificacion.id&&null!==a.actividadEconomica.dosificacion.id){i={id:a.id,actividad:a.actividadEconomica.actividad,codigo:a.servicio.codigo,nombre:a.servicio.nombre,precio:a.servicio.precio};u.configuracionActividadServicio.push(i),u.nActividad.servicio=void 0}else u.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.")}else u.nActividad.servicio=void 0;else if(void 0!==a.actividadEconomica.dosificacion.id&&null!==a.actividadEconomica.dosificacion.id){i={id:a.id,actividad:a.actividadEconomica.actividad,codigo:a.servicio.codigo,nombre:a.servicio.nombre,precio:a.servicio.precio};u.configuracionActividadServicio.push(i),u.nActividad.servicio=void 0}else u.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.")}}},u.interceptarTecla=function(e,a,o){13===e.which&&(o?u.proforma.cliente?u.detalleProforma.servicio?u.enfocar(a):u.abrirBusquedaServiciosProforma(u.proforma.actividadEconomica):u.abrirdialogClientesProforma():c(function(){$("#"+a).trigger("click")},0))},u.filtrarClientes=function(e){u.clientesProcesados=a("filter")(u.clientes,e)},u.filtrarServicios=function(e){u.filser?u.serviciosProcesados=a("filter")(u.filser,e):u.serviciosProcesados=a("filter")(u.configuracionActividadServicio,e)},u.guardarConfiguracionActividadEconomicas=function(){if(p.start(),0<u.actividadesDosificaciones.length){var o=[],a=u.actividadesDosificaciones.map(function(e,a){if((void 0===e.id||e.eliminado||null==e.id_dosificacion&&(null==e.dosificacion||null==e.dosificacion)||e.editar)&&0==e.expirado)return e;o.push(a)});if(o.reverse().forEach(function(e){a.splice(e,1)}),0<a.length)j(u.usuario.empresa.id,a).then(function(e){void 0===e.hasErr?(u.obtenerSucursales(),u.mostrarMensaje(e.mensaje),u.actividadesDosificaciones=[],h(u.usuario.empresa.id).then(function(e){u.actividadesEmpresa=e.actividades,void 0!==e.mensaje&&u.mostrarMensaje(e.mensaje),p.stop(),u.cerrarConfiguracionActividades()}).catch(function(e){u.mostrarMensaje(void 0===e.message?e.stack:e.message),p.stop(),u.cerrarConfiguracionActividades()})):(u.mostrarMensaje(e.mensaje),p.stop())}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a),p.stop()});else p.stop(),u.cerrarConfiguracionActividades()}else p.stop(),u.mostrarMensaje("Ingrese al menos 1 actividad para guardar.")},u.editarDetalleProforma=function(e){e.editar=!0,u.detalleProforma=e},u.obtenerServiciosActividadEmpresaPrincipal=function(e,a){(u.detalleProforma={},null!=e)?void 0!==e.id&&b(u.usuario.empresa.id,e.id).then(function(e){void 0!==a?u.filser=e.servicios:u.configuracionActividadServicio=e.servicios,u.serviciosProcesados=e.servicios,void 0!==e.mensaje&&u.mostrarMensaje(e.mensaje)}).catch(function(e){proforma.fecha_proforma=u.fechaATexto(proforma.fecha_proforma),p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)}):u.serviciosProcesados=[]},u.showInActivities=function(e){return!(e.expirado||e.eliminado||e.dosificacion.expirado)},u.obtenerSucursales=function(){p.start(),E(u.usuario.id).then(function(e){u.sucursales=e.sucursales.map(function(e){return e.sucursal}),p.stop()}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})},u.dosificarSucursalActividad=function(){if(u.cerrarconfirmarDosificacion(),0<u.actividadesDosificaciones.length){for(var e=!1,a=!1,o=0;0==a;)void 0!==u.actividadesDosificaciones[o].dosificacion&&null!==u.actividadesDosificaciones[o].dosificacion&&u.actividadesDosificaciones[o].dosificacion.id==u.paraDosificar.id&&(a=e=!0),o<u.actividadesDosificaciones.length-1?o+=1:a=!0;e?u.mostrarMensaje("Hubo un problema, la dosificacion esta en lista para ser asignada!"):(u.actividadADosificar.dosificacionAnterior=void 0!==u.actividadADosificar.dosificacion||null!==u.actividadADosificar.dosificacion?u.actividadADosificar.dosificacion:null,u.actividadesDosificaciones[u.actividadesDosificaciones.indexOf(u.actividadADosificar)].dosificacion=u.paraDosificar,u.actividadADosificar.editar=!0,u.actividadADosificar=void 0,u.cerrardialogDosificacionesDisponibles())}},u.agregarDetalleActividadEmpresa=function(e,a){if(void 0!==a.id)if(0<u.actividadesDosificaciones.length){for(var o=!1,i=!1,t=0;0==i;)u.actividadesDosificaciones[t].actividad.nombre!==a.nombre||u.actividadesDosificaciones[t].expirado?t>=u.actividadesDosificaciones.length-1?i=!0:t+=1:i=o=!0;if(o)u.mostrarMensaje('La actividad "'+a.nombre+'" ya esta en la lista de esta sucursal "'+e.nombre+'".');else{var r={actividad:a,sucursal:e,expirado:!1};u.actividadesDosificaciones.push(r)}}else{r={actividad:a,sucursal:e,expirado:!1};u.actividadesDosificaciones.push(r)}},u.obtenerDosificaciones=function(){D(u.usuario.id_empresa).then(function(e){u.dosificaciones=e}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})},u.abrirBusquedaServiciosProforma=function(){u.abrirPopup(u.dialogBusquedaServicio)},u.cerrarBusquedaServiciosProforma=function(){u.cerrarPopup(u.dialogBusquedaServicio)},u.abrirconfirmarDosificacion=function(e){u.paraDosificar=e,u.abrirPopup(u.confirmarDosificacion)},u.cerrarconfirmarDosificacion=function(){u.cerrarPopup(u.confirmarDosificacion)},u.abrirdialogDosificacionesDisponibles=function(e){u.obtenerDosificaciones(),u.actividadADosificar=e,u.abrirPopup(u.dialogDosificacionesDisponibles)},u.cerrardialogDosificacionesDisponibles=function(){u.dosificaciones=void 0,u.actividadADosificar=void 0,u.cerrarPopup(u.dialogDosificacionesDisponibles)},u.eliminarDetalleProforma=function(e){void 0!==e.id?e.eliminado=!0:u.detallesProformas.splice(u.detallesProformas.indexOf(e),1),u.recalcularImportesProforma()},u.recalcularImportesProforma=function(){var a=0;u.detallesProformas.map(function(e){e.eliminado||(a+=e.precio_unitario*e.cantidad,e.importe=e.precio_unitario*e.cantidad)}),u.proforma.totalImporteBs=a,u.proforma.totalImporteSus=6.96*a,u.proforma.importeLiteral=ConvertirALiteral(u.proforma.totalImporteBs.toFixed(2))},u.eliminarDetalleConfiguracion=function(e){void 0!==e.id?e.eliminado=!0:u.configuracionActividadServicio.splice(u.configuracionActividadServicio.indexOf(e),1),u.cerrarConfirmacionEliminacion()},u.buscarCliente=function(e){if(""!=e&&null!=e)return f(u.usuario.id_empresa,e)},u.seleccionarcliente=function(e){if(u.proforma.ver||u.verificarDetallesProformas())u.mostrarMensaje("No se permite.");else{var a=Object.assign({},e);u.proforma.cliente=a,u.obtenercentroCostosClienteEmpresa(e),u.cerrardialogClientesProforma()}},u.obtenerClientes=function(){P(u.usuario.id_empresa).then(function(e){u.clientes=e,u.clientesProcesados=e}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})},u.filtrarProformasOperaciones=function(e,a,o,i){if(void 0!==o)for(var t in e)0==e[t]&&(e[t]="");else for(var t in e)""!==e[t]&&null!==e[t]||(e[t]=0);if(void 0!==a&&a)return e;u.obtenerProformas(!0)},u.obtenerProformas=function(e,a){p.start(),u.filtro=u.filtrarProformasOperaciones(u.filtro,!0),u.paginator.filter=u.filtro,e&&(u.paginator.currentPage=1),g(u.paginator).then(function(e){u.proformas=e.proformas.map(function(e){return e.eliminado?e.color="red":e.color="",e}),u.paginator.setPages(e.count),void 0!==e.mensaje&&u.mostrarMensaje(e.mensaje),u.filtro=u.filtrarProformasOperaciones(u.filtro,!0,!0),c(function(){u.$apply(function(){u.totalProformas=0,u.totalProformasDolar=0,u.calcularTotalProformas()})},1e3),p.stop()}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})},u.guardarProforma=function(e,o){if(p.start(),e&&0<u.detallesProformas.length){if(u.detallesProformas.some(function(e){return e.editar}))return u.mostrarMensaje("No ha finalizado la edición de un detalle. No se puede guardar."),void p.stop();if(void 0!==o.id){var a=0;if(u.detallesProformas.forEach(function(e){e.eliminado&&(a+=1)}),a===u.detallesProformas.length)return u.mostrarMensaje("Se requiere al menos un dellate."),void p.stop();o.detallesProformas=u.detallesProformas,o.usuarioProforma=u.usuario,o.id_empresa=u.usuario.empresa.id,o.fecha_proforma=new Date(u.convertirFecha(o.fecha_proforma)),o.movimiento="PFR",w(o.id,o).then(function(e){u.mostrarMensaje(e.mensaje),void 0===e.hasErr?(u.cerrardialogProformaEdicion(),u.recargarItemsTabla()):u.proforma=e.proforma,p.stop()}).catch(function(e){p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})}else{o.id_empresa=u.usuario.empresa.id,o.detallesProformas=u.detallesProformas,o.usuarioProforma=u.usuario,o.fecha_proforma=new Date(u.convertirFecha(o.fecha_proforma)),I(u.usuario.empresa.id,u.usuario.id,o).then(function(e){u.mostrarMensaje(e.mensaje),void 0===e.hasErr?(u.cerrardialogProformaEdicion(),u.recargarItemsTabla()):o.fecha_proforma=u.fechaATexto(o.fecha_proforma),p.stop()}).catch(function(e){o.fecha_proforma=u.fechaATexto(o.fecha_proforma),p.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})}}else u.mostrarMensaje("Falta algún dato requerido. Por favor revise el formulario."),p.stop()},u.fechaATexto=function(e){return fech=new Date(e),e=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},u.abrirdialogProformaEdicion=function(e){void 0!==e?u.detalleProforma=void 0:(u.proforma.nueva=!0,u.proforma.sucursal=u.sucursales[0],u.proforma.fecha_proforma=(new Date).toLocaleDateString(),u.proforma.periodo_mes={id:(new Date).getMonth()},u.proforma.periodo_anio={id:(new Date).getFullYear()},u.obtenerCambioMonedaProforma(new Date),u.detalleProforma=void 0,u.obtenerActividadesSucursal(u.proforma.sucursal.id)),u.detalleProforma={},u.abrirPopup(u.dialogProformaEdicion)},u.cerrardialogProformaEdicion=function(){u.proforma.ver=void 0,u.detallesProformas=[],u.proforma={},u.configuracionActividadServicio=[],u.actividadesSucursal=[],u.listaCentroCostosClienteEmpresaPro=[],u.cerrarPopup(u.dialogProformaEdicion)},u.abrirConfiguracionActividadesServicios=function(){u.obtenerSucursales(),u.obtenerActividadesEmpresa(u.usuario.empresa.id),u.abrirPopup(u.modalConfiguracionActividadesServicios)},u.abrirdialogClientesProforma=function(){u.abrirPopup(u.dialogClientesProforma)},u.cerrardialogClientesProforma=function(){u.cerrarPopup(u.dialogClientesProforma)},u.obtenerActividadesEmpresa=function(e){M(e).then(function(e){u.actividadesEmpresaSinRepeticion=[],u.actividadesEmpresa=e.actividades,u.actividadesEmpresa.map(function(o){0==u.actividadesEmpresaSinRepeticion.length&&u.actividadesEmpresaSinRepeticion.push(o),u.actividadesEmpresaSinRepeticion.some(function(e,a){return e.actividad.id===o.actividad.id})||u.actividadesEmpresaSinRepeticion.push(o)})},function(e){u.mostrarMensaje(void 0!==e.stack?e.stack:e.message)})},u.obtenerActividadesDosificadasEmpresa=function(e){M(e).then(function(e){u.actividadesDosificadosEmpresa=e.actividades},function(e){u.mostrarMensaje(void 0!==e.stack?e.stack:e.message)})},u.abrirConfiguracionActividades=function(){u.obtenerSucursales(),u.obtenerActividadesGral(),u.obtenerActividadesEmpresa(u.usuario.empresa.id),u.abrirPopup(u.modalConfiguracionActividades)},u.cerrarConfiguracionActividades=function(){u.sucursalActividades=void 0,u.actividadEconomicaEmpresa=void 0,u.actividadesSucursal=[],u.obtenerActividadesEmpresa(u.usuario.empresa.id),u.recargarItemsTabla(),u.cerrarPopup(u.modalConfiguracionActividades)},u.abrirdialogmodalFechas=function(e,a){if(u.proformaFechas=e,u.abrirPopup(u.dialogmodalFechas),null!==u.proformaFechas.fecha_recepcion){var o=new Date(u.proformaFechas.fecha_recepcion).toLocaleDateString();u.proformaFechas.fecha_recepcion="Invalid Date"===o?new Date(u.convertirFecha(u.proformaFechas.fecha_recepcion)).toLocaleDateString():o}if(null!==u.proformaFechas.fecha_factura){o=new Date(u.proformaFechas.fecha_factura).toLocaleDateString();u.proformaFechas.fecha_factura="Invalid Date"===o?new Date(u.convertirFecha(u.proformaFechas.fecha_factura)).toLocaleDateString():o}if(null!==u.proformaFechas.fecha_proforma_ok){o=new Date(u.proformaFechas.fecha_proforma_ok).toLocaleDateString();u.proformaFechas.fecha_proforma_ok="Invalid Date"===o?new Date(u.convertirFecha(u.proformaFechas.fecha_proforma_ok)).toLocaleDateString():o}null!==u.proformaFechas.fecha_cobro&&(u.proformaFechas.fecha_cobro="Invalid Date"===o?new Date(u.convertirFecha(u.proformaFechas.fecha_cobro)).toLocaleDateString():o)},u.cerrardialogmodalFechas=function(){u.proformaFechas=void 0,u.recargarItemsTabla(),u.cerrarPopup(u.dialogmodalFechas)},u.cerrarConfiguracionActividadesServicios=function(){u.nActividad={},u.configuracionActividadServicio=[],u.recargarItemsTabla(),u.cerrarPopup(u.modalConfiguracionActividadesServicios)},u.abrirConfiguracionCentrosCostos=function(e){null!=e&&(u.centroCostosClienteEmpresa||(u.centroCostosClienteEmpresa={}),u.centroCostosClienteEmpresa.empresa=e,u.centroCostosClienteEmpresa.desdeProforma=!0,u.obtenercentroCostosClienteEmpresa(e)),u.abrirPopup(u.asignacionCentroCostoCliente)},u.cerrarConfiguracionCentrosCostos=function(){u.listaCentroCostosClienteEmpresa=[],u.centroCostosClienteEmpresa={},u.cerrarPopup(u.asignacionCentroCostoCliente)},u.agregarDetalleCentroCostosCliente=function(a){if(u.listaCentroCostosClienteEmpresa.some(function(e){return e.id==a.centroCosto.id}))u.mostrarMensaje("El centro ya fué asigando. No se puede duplicar.");else{var e=Object.assign({},a.centroCosto);e.nuevo=!0,u.listaCentroCostosClienteEmpresa.push(e)}},u.eliminarAsignacionCentroCosto=function(e){u.listaCentroCostosClienteEmpresa[u.listaCentroCostosClienteEmpresa.indexOf(e)].eliminado=!0},u.guardarAsignacionCentroCostos=function(e,a){if("Siguiente"!=$("#siguiente").text().trim()){var o=[];u.listaCentroCostosClienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado)&&o.push(e)}),F(e.id,o).then(function(e){u.mostrarMensaje(e.mensaje),e.hasErr||(u.centroCostosClienteEmpresa.desdeProforma&&o.forEach(function(e){if(e.nuevo&&!e.eliminado&&u.listaCentroCostosClienteEmpresaPro.push(e),e.eliminado){var a=u.listaCentroCostosClienteEmpresaPro.indexOf(e);-1<a&&u.listaCentroCostosClienteEmpresaPro.splice(a,1)}}),u.cerrarConfiguracionCentrosCostos())}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})}},u.obtenercentroCostosClienteEmpresa=function(e){u.listaCentroCostosClienteEmpresa=[],u.listaCentroCostosClienteEmpresaPro=[],O(e.id).then(function(e){e.hasErr?u.mostrarMensaje(e.mensaje):(u.listaCentroCostosClienteEmpresa=e.centros.map(function(e){return e.centroCosto}),u.listaCentroCostosClienteEmpresaPro=Object.assign([],u.listaCentroCostosClienteEmpresa))}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a)})},u.showInHist=function(e,a){return!(e.id_actividad!=a.id_actividad||!e.expirado)},u.PopoverConfiguracionActividad={templateUrl:"PopoverConfiguracionActividad.html",title:"Menu",isOpen:!1},u.PopoverConfiguracionLlenarTabla={templateUrl:"PopoverConfiguracionLlenarTabla.html",title:"Empresas",isOpen:!1},u.PopoverConfiguracionActividadhistorial={templateUrl:"PopoverConfiguracionActividadhistorial.html",title:"Historial dosificacion actividad",isOpen:!1},u.impresiones={templateUrl:"impresiones.html",title:"Opcion de impresion",isOpen:!1},u.imprimir=function(e,o){p.start(),C(e.id,e.actividadEconomica.id).then(function(e){if(u.proforma=e.proforma,void 0!==e.mensaje||null==e.proforma||null==e.proforma)null!=e.proforma&&null!=e.proforma||null!=e.mensaje?u.mostrarMensaje(e.mensaje):u.mostrarMensaje("No se encuentra la información requerida");else{u.proforma.fecha_proforma=u.fechaATexto(new Date(u.proforma.fecha_proforma));var a=new Date(u.convertirFecha(u.proforma.fecha_proforma));m(a).then(function(e){e.monedaCambio?(u.moneda=e.monedaCambio,void 0!==u.detalleProforma&&u.calcularImporte()):(u.moneda={ufv:"--",dolar:"--"},u.mostrarMensaje("La fecha "+u.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema.")),convertUrlToBase64Image(u.usuario.empresa.imagen,function(e){if(0<e.length&&"error"!==e){var a=e;0==o&&u.imprimirSinDetalle(u.proforma,a),1==o&&u.imprimirConDetalle(u.proforma,a),2==o&&u.imprimirMixto(u.proforma,a)}else convertUrlToBase64Image("img/agilsoftware.png",function(e){if(0<e.length&&"error"!==e){u.mostrarMensaje("No se encuentra la imagen de la empresa. Se usara la imagen del software.");var a=e;0==o&&u.imprimirSinDetalle(u.proforma,a),1==o&&u.imprimirConDetalle(u.proforma,a),2==o&&u.imprimirMixto(u.proforma,a)}else convertUrlToBase64Image("img/agilsoftware.png",function(e){u.mostrarMensaje("No se encuentra la imagen de la empresa ni la imagen alternativa. No se imprimira la la imagen.");var a=e;0==o&&u.imprimirSinDetalle(u.proforma,a),1==o&&u.imprimirConDetalle(u.proforma,a),2==o&&u.imprimirMixto(u.proforma,a)})})}),p.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a),p.stop()})}}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";u.mostrarMensaje(a),p.stop()})},u.imprimirMixto=function(e,a){u.proforma=e;var o=new PDFDocument({size:"letter",margin:10,compress:!1}),i=o.pipe(blobStream());new Date;o.font("Helvetica",8);var t=245,r=0,n=1,s=Math.ceil(1/29);u.dibujarCabeceraPDFImpresion(o,n,s,u.proforma,a);for(var c=0,l=0;l<=u.proforma.detallesProformas.length&&r<=29;l++){if(o.font("Helvetica",8),0==l){o.text(u.proforma.detalle,150,t-2,{width:260});var d=null!==u.proforma.detalle?u.proforma.detalle.length:0;c=20*Math.ceil(d/260)}else o.text(u.proforma.detallesProformas[l-1].cantidad,70,t-2),o.text(u.proforma.detallesProformas[l-1].servicio.nombre,150,t-2,{width:260}),o.text(u.number_format(u.proforma.detallesProformas[l-1].precio_unitario,2),440,t-2),o.text(u.number_format(u.proforma.detallesProformas[l-1].importe,2),510,t-2);t=t+20+c,1===l?u.proforma.importe:0,1===l?u.proforma.cantidad:0,c=0,(29<++r||700<t)&&(o.addPage({size:[612,792],margin:10}),t=245,r=0,n+=1,u.dibujarCabeceraPDFImpresion(o,n,s,u.proforma,a))}o.rect(40,705,540,15).stroke(),o.rect(40,725,540,15).stroke(),u.proforma.importeLiteral=ConvertirALiteral(u.proforma.totalImporteBs.toFixed(2)),o.text("Son : "+u.proforma.importeLiteral,58,710),o.text(u.number_format(u.proforma.totalImporteBs,2),510,710),o.rect(41,725,538,14).fill("silver","#000").fill("black"),o.text("Son : "+u.number_format(u.proforma.totalImporteBs/u.moneda.dolar,2)+"  Dólares x "+u.moneda.dolar,58,730),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),p.stop()},u.imprimirConDetalle=function(e,a){u.proforma=e;var o=new PDFDocument({size:"letter",margin:10,compress:!1}),i=o.pipe(blobStream());new Date;o.font("Helvetica",8);var t=245,r=0,n=1,s=Math.ceil(1/29);u.dibujarCabeceraPDFImpresion(o,n,s,u.proforma,a);for(var c=0,l=0;l<u.proforma.detallesProformas.length&&r<=29;l++)o.font("Helvetica",8),o.text(u.proforma.detallesProformas[l].cantidad,70,t-2),o.text(u.proforma.detallesProformas[l].servicio.nombre,150,t-2,{width:260}),o.text(u.number_format(u.proforma.detallesProformas[l].precio_unitario,2),440,t-2),o.text(u.number_format(u.proforma.detallesProformas[l].importe,2),510,t-2),260<u.proforma.detallesProformas[l].servicio.nombre.length&&(c=10*Math.ceil(u.proforma.detallesProformas[l].servicio.nombre.length/260)),t=t+20+c,1===l?u.proforma.importe:0,1===l?u.proforma.cantidad:0,c=0,(29<++r||700<t)&&(o.addPage({size:[612,792],margin:10}),t=245,r=0,n+=1,u.dibujarCabeceraPDFImpresion(o,n,s,u.proforma,a));o.rect(40,705,540,15).stroke(),o.rect(40,725,540,15).stroke(),u.proforma.importeLiteral=ConvertirALiteral(u.proforma.totalImporteBs.toFixed(2)),o.text("Son : "+u.proforma.importeLiteral,58,710),o.text(u.number_format(u.proforma.totalImporteBs,2),510,710),o.rect(41,725,538,14).fill("silver","#000").fill("black"),o.text("Son : "+u.number_format(u.proforma.totalImporteBs/u.moneda.dolar,2)+"  Dólares x "+u.moneda.dolar,58,730),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),p.stop()},u.imprimirSinDetalle=function(e,a){u.proforma=e;var o=new PDFDocument({size:"letter",margin:10,compress:!1}),i=o.pipe(blobStream());new Date;o.font("Helvetica",8);var t=245,r=Math.ceil(1/29);u.dibujarCabeceraPDFImpresion(o,1,r,u.proforma,a),o.font("Helvetica",8);u.proforma.detallesProformas.map(function(e){e.cantidad}),o.text(1,70,t-2),o.text(u.proforma.detalle,150,t-2,{width:260}),extraDetalle=20*Math.ceil(u.proforma.detalle.length/260),o.text(u.number_format(u.proforma.totalImporteBs,2),440,t-2),o.text(u.number_format(u.proforma.totalImporteBs,2),510,t-2),t=t+20+extraDetalle,u.proforma.importeLiteral=ConvertirALiteral(u.proforma.totalImporteBs.toFixed(2)),o.rect(40,705,540,15).stroke(),o.rect(40,725,540,15).stroke(),o.text("Son : "+u.proforma.importeLiteral,58,710),o.text(u.number_format(u.proforma.totalImporteBs,2),510,710),o.rect(41,725,538,14).fill("silver","#000").fill("black"),o.text("Son : "+u.number_format(u.proforma.totalImporteBs/u.moneda.dolar,2)+"  Dólares x "+u.moneda.dolar,58,730),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),p.stop()},u.dibujarCabeceraPDFImpresion=function(e,a,o,i,t){var r=(new Date).getDate()+"/"+((new Date).getMonth()+1)+"/"+(new Date).getFullYear();e.rect(40,210,540,25).fillAndStroke("silver","#000"),e.font("Helvetica-Bold",12).fill("black"),e.text("PROFORMA",0,130,{align:"center"}),e.font("Helvetica-Bold",8),e.font("Helvetica",8),e.font("Helvetica-Bold",8),e.font("Helvetica",8),t&&e.image(t,40,30,{fit:[100,100]}),e.text(u.usuario.empresa.telefono1,80,110),e.text(u.usuario.empresa.direccion+" Santa Cruz",40,120,{width:90}),e.text("Santa Cruz,     ",65,165,{lineBreak:!1}).font("Helvetica-Bold",10).text(r.split("/")[0],{lineBreak:!1}).font("Helvetica",10).text("   de   ",{lineBreak:!1}).font("Helvetica-Bold",10).text(u.meses[new Date(u.convertirFecha(r)).getMonth()].nombre,{lineBreak:!1}).font("Helvetica",10).text("   de   ",{lineBreak:!1}).font("Helvetica-Bold",10).text(r.split("/")[2]),e.font("Helvetica-Bold",8),e.font("Helvetica",8),e.font("Helvetica-Bold",14),e.text("N°",380,60,{align:"center"}),e.text(i.correlativo,510,60),e.rect(40,210,540,25).stroke().fill("silver"),e.rect(0,0,0,0).stroke().fill("black"),e.font("Helvetica-Bold",8),e.text("CANTIDAD",55,220),e.text("DETALLE",200,220),e.text("P.UNIT",440,220),e.text("IMPORTE BS",510,220),e.text("Señor (es):",50,193),e.text("CI/NIT:",440,195),e.text("Teléfono:",40,110),e.font("Helvetica",8),e.text(i.cliente.razon_social,100,193),e.text(i.cliente.nit,500,195),e.rect(40,160,540,20).stroke(),e.rect(40,185,540,20).stroke(),e.rect(40,210,540,490).stroke(),e.rect(120,210,0,490).stroke(),e.rect(430,210,0,490).stroke(),e.rect(490,210,0,490).stroke(),e.text("Nota: La aprobación de la proforma deberá realizarse dentro de los próximos 7 días a partir de la fecha de recepción",0,750,{align:"center"})},u.inicio()}]),angular.module("agil.controladores").controller("ControladorProveedores",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","Proveedor","Proveedores","Empresas","ProveedoresEmpresa","ProveedoresPaginador","EliminarProveedor",function(d,e,a,o,i,t,u,c,n,s,l,p,m){u.start(),d.usuario=JSON.parse(a.usuario),d.inicio=function(){d.obtenerEmpresas(),d.obtenerProveedores(),d.buscarTodosProveedores()},d.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptsProveedor("modal-wizard-proveedor","modal-wizard-proveedor-vista","dialog-eliminar-proveedor","modal-wizard-container-proveedor-edicion","modal-wizard-container-proveedor-vista"),d.buscarAplicacion(d.usuario.aplicacionesUsuario,o.path().substring(1)),u.stop()}),d.crearNuevoProveedor=function(){var e=JSON.parse(a.usuario);d.proveedor=new c({id_empresa:e.id_empresa}),d.abrirPopup("modal-wizard-proveedor")},d.verProveedor=function(e){(d.proveedor=e).fecha1=new Date(e.fecha1),e.fecha2=new Date(e.fecha2),d.proveedor.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear(),d.proveedor.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear(),d.abrirPopup("modal-wizard-proveedor-vista")},d.cerrarPopPupVista=function(){d.cerrarPopup("modal-wizard-proveedor-vista")},d.cerrarPopPupNuevoProveedor=function(){d.cerrarPopup("modal-wizard-proveedor")},d.modificarProveedor=function(e){(d.proveedor=e).fecha1&&(e.fecha1=new Date(e.fecha1),d.proveedor.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear()),e.fecha2&&(e.fecha2=new Date(e.fecha2),d.proveedor.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear()),d.abrirPopup("modal-wizard-proveedor")},d.mostrarConfirmacionEliminacion=function(e){d.proveedor=new c(e),d.abrirPopup("dialog-eliminar-proveedor")},d.cerrarConfirmacionEliminacion=function(){d.cerrarPopup("dialog-eliminar-proveedor")},d.eliminarProveedor=function(e){u.start(),d.cerrarConfirmacionEliminacion(),m(e.id).then(function(e){d.mostrarMensaje(e.mensaje)}),d.recargarItemsTabla(),u.stop()},d.saveForm=function(t){if("Siguiente"!=$("#siguiente").text().trim()){u.start();var e=document.getElementById("doc-nit").files[0],a=document.getElementById("doc-funda").files[0],o=document.getElementById("doc-licencia").files[0],i=document.getElementById("doc-ci").files[0],n=document.getElementById("doc-seguro-social").files[0],s=[];[e,a,o,i,n].forEach(function(e,a,o){e&&s.push(e),a==o.length-1&&(0<s.length?s.forEach(function(a,o,i){r=new FileReader,a?(r.onloadend=function(e){a.nombre=a.name,a.data=e.target.result,o===i.length-1&&(t.fecha1=null,t.fechatexto1&&(t.fecha1=new Date(d.convertirFecha(t.fechatexto1))),t.fecha2=null,t.fechatexto2&&(t.fecha2=new Date(d.convertirFecha(t.fechatexto2))),t.id?c.update({idProveedor:t.id},t,function(e){u.stop(),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Actualizado Exitosamente!"),d.recargarItemsTabla()}):t.$save(function(e){u.stop(),d.proveedor=new c({}),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Guardado Exitosamente!"),d.recargarItemsTabla()},function(e){u.stop(),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()}))},r.readAsBinaryString(a)):o===i.length-1&&(t.fecha1=null,t.fechatexto1&&(t.fecha1=new Date(d.convertirFecha(t.fechatexto1))),t.fecha2=null,t.fechatexto2&&(t.fecha2=new Date(d.convertirFecha(t.fechatexto2))),t.id?c.update({idProveedor:t.id},t,function(e){u.stop(),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Actualizado Exitosamente!"),d.recargarItemsTabla()}):t.$save(function(e){u.stop(),d.proveedor=new c({}),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Guardado Exitosamente!"),d.recargarItemsTabla()},function(e){u.stop(),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()}))}):(t.fecha1=null,t.fechatexto1&&(t.fecha1=new Date(d.convertirFecha(t.fechatexto1))),t.fecha2=null,t.fechatexto2&&(t.fecha2=new Date(d.convertirFecha(t.fechatexto2))),t.id?c.update({idProveedor:t.id},t,function(e){u.stop(),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Actualizado Exitosamente!"),d.recargarItemsTabla()}):t.$save(function(e){u.stop(),d.proveedor=new c({}),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Guardado Exitosamente!"),d.recargarItemsTabla()},function(e){u.stop(),d.cerrarPopPupNuevoProveedor(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()})))})}},d.obtenerEmpresas=function(){u.start(),s().then(function(e){d.empresas=e,u.stop()})},d.obtenerProveedores=function(){d.abs=e.Math.abs,d.itemsPorPagina=10,d.buscarProveedores(1,d.itemsPorPagina,"")},d.verificarPulso=function(e,a){13===e.keyCode&&d.buscarProveedores(1,d.itemsPorPagina,a)},d.buscarProveedores=function(e,a,o){u.start(),d.itemsPorPagina=a,""==o||null==o?o=0:d.textoBusqueda=o,d.paginaActual=e,p(d.usuario.id_empresa,e,a,o).then(function(e){d.paginas=[];for(var a=1;a<=e.paginas;a++)d.paginas.push(a);d.proveedores=e.proveedores,u.stop()})},d.buscarTodosProveedores=function(){n(d.usuario.id_empresa).then(function(e){d.TodoProveedores=e}),u.stop()},d.reporteExcel=function(){var e=d.TodoProveedores;u.start();var a=[];a.push(["Codigo","Razón Social","Nit","Direccion","Telefono1","Telefono2","Contacto","Ubicacion Geo.","Rubro","Categoria","Fecha Imp.1","Fecha Imp.2","Texto1","Texto2"]);for(var o=0;o<e.length;o++)columns=[],columns.push(e[o].codigo),columns.push(e[o].razon_social),columns.push(e[o].nit),columns.push(e[o].direccion),columns.push(e[o].telefono1),columns.push(e[o].telefono2),columns.push(e[o].contacto),e[o].ubicacion_geografica?columns.push(e[o].ubicacion_geografica):columns.push(" "),columns.push(e[o].rubro),e[o].categoria?columns.push(e[o].categoria):columns.push(" "),e[o].fecha1?columns.push(new Date(e[o].fecha1)):columns.push(" "),e[o].fecha2?columns.push(new Date(e[o].fecha2)):columns.push(" "),e[o].texto1?columns.push(e[o].texto1):columns.push(" "),e[o].texto2?columns.push(e[o].texto2):columns.push(" "),a.push(columns);var i=new Workbook,t=sheet_from_array_of_arrays(a);i.SheetNames.push("SheetJS"),i.Sheets.SheetJS=t;var r=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"REPORTE-USUARIOS.xlsx"),u.stop()},d.dibujarCabeceraPDFProveedores=function(e,a,o,i){var t=(new Date).toLocaleDateString();e.fontSize(23).text("REPORTE DE PROVEEDORES",0,80,{align:"center"}),e.rect(133,100,335,0).stroke(),e.font("Helvetica-Bold",10),e.text("Fecha: ",30,140),e.font("Helvetica",10).text(t,63,140),e.font("Helvetica-Bold",10).text("N°",30,160),e.font("Helvetica-Bold",10).text("Código",52,160),e.font("Helvetica-Bold",10).text("Razón Social",100,160),e.font("Helvetica-Bold",10).text("Nit",230,160),e.font("Helvetica-Bold",10).text("Direccion",300,160),e.font("Helvetica-Bold",10).text("Telefono",390,160),e.font("Helvetica-Bold",10).text("Rubro",470,160),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"})},d.reportePdf=function(){var e=d.TodoProveedores;u.start();var a=new PDFDocument({size:"letter",margin:10}),o=a.pipe(blobStream()),i=200,t=0,r=1,n=Math.ceil(e.length/15);d.dibujarCabeceraPDFProveedores(a,1,n,e),a.font("Helvetica",8);for(var s=e.length-1,c=0;c<s&&t<=15;c++){var l=c+1;a.font("Helvetica",9).text(l,30,i),e[c].codigo?a.font("Helvetica",9).text(e[c].codigo,52,i):a.font("Helvetica",9).text("null",52,i),e[c].razon_social?a.font("Helvetica",9).text(e[c].razon_social,100,i,{width:130}):a.font("Helvetica",9).text("null",100,i),e[c].nit?a.font("Helvetica",9).text(e[c].nit,230,i):a.font("Helvetica",9).text("null",230,i),e[c].direccion?(a.font("Helvetica",9).text(e[c].direccion,300,i,{width:80}),console.log(e[c].direccion.length)):a.font("Helvetica",9).text("null",300,i),e[c].telefono1?a.font("Helvetica",9).text(e[c].telefono1,390,i):a.font("Helvetica",9).text("null",390,i),e[c].rubro?a.font("Helvetica",9).text(e[c].rubro,470,i):a.font("Helvetica",9).text("null",470,i),i+=33,15==++t&&(a.addPage({margin:0,bufferPages:!0}),i=200,t=0,r+=1,d.dibujarCabeceraPDFProveedores(a,r,n,e),a.font("Helvetica",8))}a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),u.stop()},d.subirExcelProveedores=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){u.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.razon_social=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.nit=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.direccion=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.telefono1=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.telefono2=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.telefono3=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.contacto=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,s.ubicacion_geografica=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,s.rubro=null!=r["J"+t]&&""!=r["J"+t]?r["J"+t].v.toString():null,s.categoria=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,s.fecha1=null!=r["L"+t]&&""!=r["L"+t]?new Date(d.convertirFecha(r["L"+t].v.toString())):null,s.fecha2=null!=r["M"+t]&&""!=r["M"+t]?new Date(d.convertirFecha(r["M"+t].v.toString())):null,s.texto1=null!=r["N"+t]&&""!=r["N"+t]?r["N"+t].v.toString():null,s.texto2=null!=r["O"+t]&&""!=r["O"+t]?r["O"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);d.guardarProveedores(n),u.stop()},t.readAsBinaryString(o)}},d.guardarProveedores=function(e){new l({proveedores:e,id_empresa:d.usuario.id_empresa}).$save(function(e){u.stop(),d.mostrarMensaje("Guardado Exitosamente!"),d.recargarItemsTabla()},function(e){u.stop(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!"),d.recargarItemsTabla()})},d.$on("$routeChangeStart",function(e,a){d.eliminarPopup("modal-wizard-proveedor"),d.eliminarPopup("modal-wizard-proveedor-vista"),d.eliminarPopup("dialog-eliminar-proveedor")}),d.inicio()}]),angular.module("agil.controladores").controller("ControladoresRCIVA",["$scope","$localStorage","$location","$templateCache","$route","blockUI","RecursosHumanosEmpleados","RecursosHumanosEmpleadosHorasExtras","ClasesTipo","Parametros","ObtenerCambioMoneda","RecursosHumanosPlanillaRCIVA","RRHHlistaPlanillaRCIVA","ListaRRHHPlanillaRCIVA",function(B,e,a,o,i,z,t,r,n,s,c,l,d,u){function p(e,a){return Number(Math.round(e+"e"+a)+"e-"+a)}B.$on("$viewContentLoaded",function(){B.idModalNuevoPlanillaRCIVA="dialog-nueva-planilla-rc-iva",B.idModalFormulario110="dialog-formulario-110",B.idModalFormularioGeneral110="dialog-formulario-general-110",B.idModalArchivosTXT="dialog-archivos-txt",B.idModalEditarPlanillaRCIVA="dialog-editar-planilla-rc-iva",ejecutarScriptsPlanillaRCIVA(B.idModalNuevoPlanillaRCIVA,B.idModalFormulario110,B.idModalFormularioGeneral110,B.idModalArchivosTXT,B.idModalEditarPlanillaRCIVA)}),B.$on("$routeChangeStart",function(e,a){B.eliminarPopup(B.idModalNuevoPlanillaRCIVA,B.idModalFormulario110,B.idModalFormularioGeneral110,B.idModalArchivosTXT,B.idModalEditarPlanillaRCIVA)}),B.usuario=JSON.parse(e.usuario),B.fechaATexto=function(e){return fech=new Date(e),e=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},B.obtenerGestiones=function(){z.start(),n("GTN").then(function(e){B.gestiones=e.clases,z.stop()})},B.obtenerGestiones(),B.obtenerPlanillaRcIva=function(e){console.log("la cabezeraaa ",e),u(B.usuario.id_empresa,e.gestion,e.mes).then(function(e){console.log("la cabezeraaa ",e),B.planillasRcIva=e.planillas,B.sumarTotalesPlanillaRcIva(B.planillasRcIva)})},B.sumarTotalesPlanillaRcIva=function(e){if(B.sumaNetoImponible=0,B.sumaDosSmn=0,B.sumaDiferencia=0,B.sumaRcIva=0,B.sumaDosSmn13=0,B.sumaF110=0,B.sumaRcIvaFisico=0,B.sumaSaldoDependiente=0,B.sumaSaldoAnterior=0,B.sumaActualizacion=0,B.sumaSaldoActualizado=0,B.sumaSaldoTotal=0,B.sumaSaldoUtilizado=0,B.sumaRcIvaMes=0,B.sumaNuevoSaldo=0,null!=e)for(var a=0;a<e.length;a++)B.sumaNetoImponible=B.sumaNetoImponible+e[a].neto_imponible,B.sumaDosSmn=B.sumaDosSmn+e[a].dos_smn,B.sumaDiferencia=B.sumaDiferencia+e[a].diferencia,B.sumaRcIva=B.sumaRcIva+e[a].rc_iva,B.sumaDosSmn13=B.sumaDosSmn13+e[a].dos_smn13,B.sumaF110=B.sumaF110+e[a].f110,B.sumaRcIvaFisico=B.sumaRcIvaFisico+e[a].rc_iva_fisico,B.sumaSaldoDependiente=p(B.sumaSaldoDependiente+e[a].saldo_dependiente,2),B.sumaSaldoAnterior=p(B.sumaSaldoAnterior+e[a].saldo_anterior,2),B.sumaActualizacion=p(B.sumaActualizacion+e[a].actualizacion,2),B.sumaSaldoActualizado=p(B.sumaSaldoActualizado+e[a].saldo_actualizado,2),B.sumaSaldoTotal=p(B.sumaSaldoTotal+e[a].saldo_total,2),B.sumaSaldoUtilizado=p(B.sumaSaldoUtilizado+e[a].saldo_utilizado,2),B.sumaRcIvaMes=p(B.sumaRcIvaMes+e[a].rc_iva_mes,2),B.sumaNuevoSaldo=p(B.sumaNuevoSaldo+e[a].nuevo_saldo,2);B.planillaRcIva.sumaNetoImponible=B.sumaNetoImponible,B.planillaRcIva.sumaRcIva=B.sumaRcIva,B.planillaRcIva.sumaDosSmn=B.sumaDosSmn,B.planillaRcIva.sumaDiferencia=B.sumaDiferencia,B.planillaRcIva.sumaDosSmn13=B.sumaDosSmn13,B.planillaRcIva.sumaF110=B.sumaF110,B.planillaRcIva.sumaRcIvaFisico=B.sumaRcIvaFisico,B.planillaRcIva.sumaSaldoDependiente=B.sumaSaldoDependiente,B.planillaRcIva.sumaSaldoAnterior=B.sumaSaldoAnterior,B.planillaRcIva.sumaActualizacion=B.sumaActualizacion,B.planillaRcIva.sumaSaldoActualizado=B.sumaSaldoActualizado,B.planillaRcIva.sumaSaldoTotal=B.sumaSaldoTotal,B.planillaRcIva.sumaSaldoUtilizado=B.sumaSaldoUtilizado,B.planillaRcIva.sumaRcIvaMes=B.sumaRcIvaMes,B.planillaRcIva.sumaNuevoSaldo=B.sumaNuevoSaldo},B.EditarRciva=function(e){console.log("llego a editar ",e),B.planillaEdit=e,B.abrirPopup(B.idModalEditarPlanillaRCIVA)},B.cerrarDialogEditarPlanillaRCIVA=function(){B.cerrarPopup(B.idModalEditarPlanillaRCIVA)},B.nuevaPlanillaRcIva=function(){B.planilla=new l({id_empresa:B.usuario.id_empresa}),B.sumarTotales(B.planilla)},B.abrirDialogNuevoPlanillaRCIVA=function(){B.nuevaPlanillaRcIva(),B.abrirPopup(B.idModalNuevoPlanillaRCIVA)},B.cerrarDialogNuevoPlanillaRCIVA=function(){B.cerrarPopup(B.idModalNuevoPlanillaRCIVA)},B.generarPdfPLanillaRCIVA=function(H){z.start(),u(B.usuario.id_empresa,H.gestion,H.mes).then(function(e){var a=e.planillas,o=new PDFDocument({compress:!1,margin:10,size:"A4",layout:"landscape"}),i=o.pipe(blobStream());B.dibujarCabeceraPDFPlanillaRCIVA(o,B.usuario,H,1),o.font("Helvetica",8);for(var t=150,r=0,n=1,s=0,c=0,l=0,d=0,u=0,p=0,m=0,f=0,g=0,v=0,h=0,b=0,C=0,P=0,_=0,M=0,D=0,E=0,x=0,S=0,A=0,T=0,w=0,I=0,R=0,j=0,O=0,F=0,V=0,N=0;N<a.length&&r<=12;N++)o.rect(40,t-10,760,30).stroke(),o.text(N+1,45,t),o.text(a[N].anio,60,t),o.text(a[N].mes.split("-")[1],90,t),o.text(a[N].neto_imponible,140,t),o.text(a[N].dos_smn,190,t),o.text(a[N].diferencia,230,t),o.text(a[N].rc_iva,283,t),o.text(a[N].dos_smn13,325,t),o.text(a[N].f110,365,t),o.text(a[N].rc_iva_fisico,400,t),o.text(a[N].saldo_dependiente,440,t),o.text(a[N].saldo_anterior,490,t),o.text(a[N].actualizacion,530,t),o.text(a[N].saldo_actualizado,580,t),o.text(a[N].saldo_total,625,t),o.text(a[N].saldo_utilizado,665,t),o.text(a[N].rc_iva_mes,705,t),o.text(a[N].nuevo_saldo,740,t),t+=30,x+=a[N].neto_imponible,D+=a[N].dos_smn,E+=a[N].diferencia,c+=a[N].rc_iva,S+=a[N].dos_smn13,A+=a[N].f110,T+=a[N].rc_iva_fisico,w+=a[N].saldo_dependiente,M+=a[N].saldo_anterior,I+=a[N].actualizacion,R+=a[N].saldo_actualizado,j+=a[N].saldo_total,O+=a[N].saldo_utilizado,F+=a[N].rc_iva_mes,V+=a[N].nuevo_saldo,s+=a[N].neto_imponible,l+=a[N].dos_smn,d+=a[N].diferencia,u+=a[N].dos_smn13,p+=a[N].f110,m+=a[N].rc_iva_fisico,f+=a[N].saldo_dependiente,g+=a[N].saldo_anterior,v+=a[N].actualizacion,h+=a[N].saldo_actualizado,b+=a[N].saldo_total,C+=a[N].saldo_utilizado,P+=a[N].rc_iva_mes,_+=a[N].nuevo_saldo,12!=++r&&N+1!=a.length||(o.font("Helvetica-Bold",8),o.text("SUBTOTALES",75,t),o.text(Math.round(100*x)/100,140,t),o.text(Math.round(100*D)/100,190,t),o.text(Math.round(100*E)/100,230,t),o.text(Math.round(100*c)/100,283,t),o.text(Math.round(100*S)/100,325,t),o.text(Math.round(100*A)/100,365,t),o.text(Math.round(100*T)/100,400,t),o.text(Math.round(100*w)/100,440,t),o.text(Math.round(100*M)/100,490,t),o.text(Math.round(100*I)/100,530,t),o.text(Math.round(100*R)/100,580,t),o.text(Math.round(100*j)/100,625,t),o.text(Math.round(100*O)/100,665,t),o.text(Math.round(100*F)/100,705,t),o.text(Math.round(100*V)/100,740,t),o.rect(40,t-10,760,30).stroke(),o.font("Helvetica",8),N+1==a.length?(o.font("Helvetica-Bold",8),o.text("TOTALES",75,t+30),o.text(Math.round(100*s)/100,140,t+30),o.text(Math.round(100*l)/100,190,t+30),o.text(Math.round(100*d)/100,230,t+30),o.text(Math.round(100*c)/100,283,t+30),o.text(Math.round(100*u)/100,325,t+30),o.text(Math.round(100*p)/100,365,t+30),o.text(Math.round(100*m)/100,400,t+30),o.text(Math.round(100*f)/100,440,t+30),o.text(Math.round(100*g)/100,490,t+30),o.text(Math.round(100*v)/100,530,t+30),o.text(Math.round(100*h)/100,580,t+30),o.text(Math.round(100*b)/100,625,t+30),o.text(Math.round(100*C)/100,665,t+30),o.text(Math.round(100*P)/100,705,t+30),o.text(Math.round(100*_)/100,740,t+30),o.rect(40,t-10+30,760,30).stroke()):(o.addPage({margin:0,bufferPages:!0,layout:"landscape"}),t=170,r=0,n+=1,B.dibujarCabeceraPDFLibroVentas(o,e,reporte,n)),o.font("Helvetica",8));o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),z.stop()})},B.dibujarCabeceraPDFPlanillaRCIVA=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("PLANILLAS RC-IVA",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FOLIO "+i,760,25),e.rect(40,60,760,40).stroke(),e.text("PERIÓDO FISCAL : ",65,70),e.text("NOMBRE O RAZÓN SOCIAL : ",65,85),e.text("NIT : ",440,85),e.font("Helvetica",8),e.text("AÑO "+o.gestion,140,70);var t=o.mes.split("-")[1];"TODOS"==o.mes&&(t=o.mes),e.text("MES "+t,200,70),e.text(a.empresa.razon_social,195,85),e.text(a.empresa.nit,460,85),e.rect(40,100,760,40).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",45,110),e.text("Año",60,110,{width:20}),e.text("Mes",90,110,{width:50}),e.text("Neto Imponible",140,110,{width:50}),e.text("2 SMN",190,110,{width:35}),e.text("Diferencia",230,110,{width:50}),e.text("RC-IVA 13%",280,110,{width:35}),e.text("13% de 2 SMN",325,110,{width:35}),e.text("F-110",365,110,{width:35}),e.text("RC-IVA Fisco",400,110,{width:42}),e.text("Saldo Dependiente",440,110,{width:42}),e.text("Saldo Anterior",490,110,{width:40}),e.text("Actualización",530,110,{width:37}),e.text("Saldo Actualizado",580,110,{width:35}),e.text("Saldo Total",625,110,{width:35}),e.text("Saldo Utilizado",665,110,{width:35}),e.text("RC-IVA Mes",705,110,{width:35}),e.text("Saldo Nuevo",740,110)},B.generarExcelPlanillaRcIva=function(e){z.start(),u(B.usuario.id_empresa,e.gestion,e.mes).then(function(e){for(var a=e.planillas,o=[["N°","Año","Mes","Neto Imponible","2 SMN","Diferencia","RC-IVA 13%","13% de 2 SMN","F-110","RC-IVA Fisco","Saldo Dependiente","Saldo Anterior","Actualización","Saldo Actualizado","Saldo Total","Saldo Utilizado","RC-IVA Mes","Saldo Nuevo"]],i=0,t=0,r=0,n=0,s=0,c=0,l=0,d=0,u=0,p=0,m=0,f=0,g=0,v=0,h=0;h<a.length;h++){var b=[];b.push(h+1),b.push(a[h].anio),b.push(a[h].mes.split("-")[1]),b.push(a[h].neto_imponible),b.push(a[h].dos_smn),b.push(a[h].diferencia),b.push(a[h].rc_iva),b.push(a[h].dos_smn13),b.push(a[h].f110),b.push(a[h].rc_iva_fisico),b.push(a[h].saldo_dependiente),b.push(a[h].saldo_anterior),b.push(a[h].actualizacion),b.push(a[h].saldo_actualizado),b.push(a[h].saldo_total),b.push(a[h].saldo_utilizado),b.push(a[h].rc_iva_mes),b.push(a[h].nuevo_saldo),i+=a[h].neto_imponible,t+=a[h].dos_smn,r+=a[h].diferencia,n+=a[h].dos_smn13,s+=a[h].f110,c+=a[h].rc_iva_fisico,l+=a[h].saldo_dependiente,d+=a[h].saldo_anterior,u+=a[h].actualizacion,p+=a[h].saldo_actualizado,m+=a[h].saldo_total,f+=a[h].saldo_utilizado,g+=a[h].rc_iva_mes,v+=a[h].nuevo_saldo,o.push(b),h+1==a.length&&((b=[]).push(""),b.push(""),b.push("TOTALES"),b.push(Math.round(100*i)/100),b.push(Math.round(100*t)/100),b.push(Math.round(100*r)/100),b.push(Math.round(0)/100),b.push(Math.round(100*n)/100),b.push(Math.round(100*s)/100),b.push(Math.round(100*c)/100),b.push(Math.round(100*l)/100),b.push(Math.round(100*d)/100),b.push(Math.round(100*u)/100),b.push(Math.round(100*p)/100),b.push(Math.round(100*m)/100),b.push(Math.round(100*f)/100),b.push(Math.round(100*g)/100),b.push(Math.round(100*v)/100),o.push(b))}var C=new Workbook,P=sheet_from_array_of_arrays(o);C.SheetNames.push("SheetJS"),C.Sheets.SheetJS=P;var _=XLSX.write(C,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(_)],{type:"application/octet-stream"}),"PLANILLA-RCIVA.xlsx"),z.stop()})},B.filtrarSueldos=function(s){console.log("cabezera",s);var e=new Date(s.gestion,parseInt(s.mes)-1,0),a=new Date(s.gestion,parseInt(s.mes),0);console.log("fechaUFVAnterior ===========",e),console.log("fechaUFVActual ===========",a),Promise.all([c(a),c(e),d(B.usuario.id_empresa,s.gestion,s.mes)]).then(function(e){console.log("del mel planillaaaaaaaaaaaasss ",e[2].planillas.length),B.ufvActual=null==e[0].monedaCambio?0:e[0].monedaCambio.ufv,console.log("$scope.ufvActual ==== ",B.ufvActual),B.ufvAnterior=null==e[1].monedaCambio?0:e[1].monedaCambio.ufv;if(0==e[2].planillas.length)if(0<B.ufvActual&&0<B.ufvAnterior){var a=t(B.usuario.id_empresa);a.then(function(e){s.RecursosHumanosEmpleados=e.empleados,s.RecursosHumanosEmpleados.forEach(function(n){(a=r(n.id_ficha,s.gestion,s.mes.split("-")[0],n.id)).then(function(e){var a,o;n.sueldoBasico=n.haber_basico,B.antiguedad=(a=n.fecha_inicio,o=+new Date(a),~~((Date.now()-o)/315576e5)),B.bonoFrontera=0,B.otrosBonos=0,n.horasExtras=e.totalHoras,n.totalHorasExtras=p(n.sueldoBasico/30/8*n.horasExtras*2,2),n.recargoNocturno=p(n.sueldoBasico/30/8*n.horasExtras*1.5,2),n.bonoAntiguedad=B.calcularBonoAntiguedad(B.antiguedad),n.bonoFrontera=B.bonoFrontera,n.otrosBonos=B.otrosBonos,n.totalGanado=n.sueldoBasico+n.totalHorasExtras+n.recargoNocturno+n.bonoAntiguedad+n.bonoFrontera+n.otrosBonos,n.afp=p(12.71*n.totalGanado/100,2),n.montoDeclarado=0,n.muneroFacturas=0,n.ivaCF=0,n.netoImponible=p(n.totalGanado-n.afp,2),n.dos_SMN=2*B.parametros.salario_minimo,n.diferencia=0,n.netoImponible>n.dos_SMN&&(n.diferencia=p(n.netoImponible-n.dos_SMN,2)),n.rcIva13=p(.13*n.diferencia,2),n.dos_SMN13=2*B.parametros.salario_minimo*.13,n.f110=n.ivaCF;var i=n.rcIva13-n.dos_SMN13,t=i-n.f110;(n.rcIvaFisco=0)<=t&&(n.rcIvaFisco=p(t,2)),n.saldoDependiente=0<=t?0:p(n.f110-i,2),null==n.nuevo_saldo&&(n.nuevo_saldo=0),n.saldoAnterior=n.nuevo_saldo,n.actualizacion=p(n.saldoAnterior/B.ufvAnterior*B.ufvActual-n.saldoAnterior,2),n.saldoActualizado=n.saldoAnterior+n.actualizacion,n.saldoTotal=p(n.saldoDependiente+n.saldoActualizado,2);var r=n.rcIvaFisco-n.saldoActualizado;n.saldoUtilizado=0<r?p(n.rcIvaFisco-r,2):n.rcIvaFisco,n.rcIvaMes=0,n.rcIvaFisco>n.saldoTotal&&(n.rcIvaMes=p(n.rcIvaFisco-n.saldoTotal,2)),0<n.rcIvaMes?n.saldoNuevo=0:n.saldoNuevo=n.saldoTotal-n.rcIvaFisco,B.sumarTotales(s)})})})}else B.$apply(function(){B.message="Falta las UFVs para poder crear nuevas planillas",B.mostrarMensaje(B.message)});else B.$apply(function(){B.message="Ya se creo planilla para este periodo '"+s.mes.split("-")[1]+"-"+s.gestion+"'",B.mostrarMensaje(B.message)});z.stop()})},B.calcularRCIVA=function(){var e=13*B.sueldo.montoDeclarado/100;B.valido=!1,e!=B.sueldo.ivaCF&&(B.mensage="ddfsfsdfsdf",B.valido=!0),B.sueldo.f110=B.sueldo.ivaCF;var a=B.sueldo.rcIva13-B.sueldo.dos_SMN13,o=a-B.sueldo.f110;(B.sueldo.rcIvaFisco=0)<=o&&(B.sueldo.rcIvaFisco=p(o,2)),B.sueldo.saldoDependiente=0<=o?0:p(B.sueldo.f110-a,2),B.sueldo.saldoAnterior=10,B.sueldo.actualizacion=p(B.sueldo.saldoAnterior/B.ufvAnterior*B.ufvActual-B.sueldo.saldoAnterior,2),B.sueldo.saldoActualizado=B.sueldo.saldoAnterior+B.sueldo.actualizacion,B.sueldo.saldoTotal=p(B.sueldo.saldoDependiente+B.sueldo.saldoActualizado,2);var i=B.sueldo.rcIvaFisco-B.sueldo.saldoActualizado;B.sueldo.saldoUtilizado=0<i?p(B.sueldo.rcIvaFisco-i,2):B.sueldo.rcIvaFisco,B.sueldo.rcIvaMes=0,B.sueldo.rcIvaFisco>B.sueldo.saldoTotal&&(B.sueldo.rcIvaMes=p(B.sueldo.rcIvaFisco-B.sueldo.saldoTotal,2)),0<B.sueldo.rcIvaMes?B.sueldo.saldoNuevo=0:B.sueldo.saldoNuevo=B.sueldo.saldoTotal-B.sueldo.rcIvaFisco},B.calcularRCIVA2=function(e,a){e.f110=a.ivaCF;var o=e.rcIva13-e.dos_SMN13,i=o-e.f110;(e.rcIvaFisco=0)<=i&&(e.rcIvaFisco=p(i,2)),e.saldoDependiente=0<=i?0:p(e.f110-o,2),e.saldoAnterior=10,e.actualizacion=p(e.saldoAnterior/B.ufvAnterior*B.ufvActual-e.saldoAnterior,2),e.saldoActualizado=e.saldoAnterior+e.actualizacion,e.saldoTotal=p(e.saldoDependiente+e.saldoActualizado,2);var t=e.rcIvaFisco-e.saldoActualizado;e.saldoUtilizado=0<t?p(e.rcIvaFisco-t,2):e.rcIvaFisco,e.rcIvaMes=0,e.rcIvaFisco>e.saldoTotal&&(e.rcIvaMes=p(e.rcIvaFisco-e.saldoTotal,2)),0<e.rcIvaMes?e.saldoNuevo=0:e.saldoNuevo=e.saldoTotal-e.rcIvaFisco},B.sumarTotales=function(e){B.netoImponible=0,B.sumaDos_SMN=0,B.sumaDiferencia=0,B.sumarcIva13=0,B.sumaDos_SMN13=0,B.sumaF110=0,B.sumaRcIvaFisco=0,B.sumaSaldoDependiente=0,B.sumaSaldoAnterior=0,B.sumaActualizacion=0,B.sumaSaldoActualizado=0,B.sumaSaldoTotal=0,B.sumaSaldoUtilizado=0,B.sumaRcIvaMes=0;var a=B.sumaSaldoNuevo=0;if(null!=e.RecursosHumanosEmpleados)for(var o=0;o<e.RecursosHumanosEmpleados.length;o++)a+=1,B.netoImponible=B.netoImponible+e.RecursosHumanosEmpleados[o].netoImponible,B.sumaDos_SMN=B.sumaDos_SMN+e.RecursosHumanosEmpleados[o].dos_SMN,B.sumaDiferencia=B.sumaDiferencia+e.RecursosHumanosEmpleados[o].diferencia,B.sumarcIva13=B.sumarcIva13+e.RecursosHumanosEmpleados[o].rcIva13,B.sumaDos_SMN13=B.sumaDos_SMN13+e.RecursosHumanosEmpleados[o].dos_SMN13,B.sumaF110=B.sumaF110+e.RecursosHumanosEmpleados[o].f110,B.sumaRcIvaFisco=B.sumaRcIvaFisco+e.RecursosHumanosEmpleados[o].rcIvaFisco,B.sumaSaldoDependiente=p(B.sumaSaldoDependiente+e.RecursosHumanosEmpleados[o].saldoDependiente,2),B.sumaSaldoAnterior=p(B.sumaSaldoAnterior+e.RecursosHumanosEmpleados[o].saldoAnterior,2),B.sumaActualizacion=p(B.sumaActualizacion+e.RecursosHumanosEmpleados[o].actualizacion,2),B.sumaSaldoActualizado=p(B.sumaSaldoActualizado+e.RecursosHumanosEmpleados[o].saldoActualizado,2),B.sumaSaldoTotal=p(B.sumaSaldoTotal+e.RecursosHumanosEmpleados[o].saldoTotal,2),B.sumaSaldoUtilizado=p(B.sumaSaldoUtilizado+e.RecursosHumanosEmpleados[o].saldoUtilizado,2),B.sumaRcIvaMes=p(B.sumaRcIvaMes+e.RecursosHumanosEmpleados[o].rcIvaMes,2),B.sumaSaldoNuevo=p(B.sumaSaldoNuevo+e.RecursosHumanosEmpleados[o].saldoNuevo,2);e.totalEmpleados=a,e.netoImponible=B.netoImponible,e.sumaDos_SMN=B.sumaDos_SMN,e.sumaDiferencia=B.sumaDiferencia,e.sumarcIva13=B.sumarcIva13,e.sumaDos_SMN13=B.sumaDos_SMN13,e.sumaF110=B.sumaF110,e.sumaRcIvaFisco=B.sumaRcIvaFisco,e.sumaSaldoDependiente=B.sumaSaldoDependiente,e.sumaSaldoAnterior=B.sumaSaldoAnterior,e.sumaActualizacion=B.sumaActualizacion,e.sumaSaldoActualizado=B.sumaSaldoActualizado,e.sumaSaldoTotal=B.sumaSaldoTotal,e.sumaSaldoUtilizado=B.sumaSaldoUtilizado,e.sumaRcIvaMes=B.sumaRcIvaMes,e.sumaSaldoNuevo=B.sumaSaldoNuevo},B.obtenerParametros=function(e){z.start(),null==e&&(e=0),s(e).then(function(e){B.parametros=e,z.stop()})},B.calcularBonoAntiguedad=function(e){return 0<=e&&e<=2?3*B.parametros.salario_base_antiguedad*B.parametros.antiguedad_cero_dos/100:2<e&&e<=5?3*B.parametros.salario_base_antiguedad*B.parametros.antiguedad_dos_cinco/100:5<e&&e<=8?3*B.parametros.salario_base_antiguedad*B.parametros.antiguedad_cinco_ocho/100:8<e&&e<=11?3*B.parametros.salario_base_antiguedad*B.parametros.antiguedad_ocho_once/100:11<e&&e<=15?3*B.parametros.salario_base_antiguedad*B.parametros.antiguedad_once_quince/100:15<e&&e<=20?3*B.parametros.salario_base_antiguedad*B.parametros.antiguedad_quice_veinte/100:20<e&&e<=25?3*B.parametros.salario_base_antiguedad*B.parametros.antiguedad_veinte_veinticinco/100:25<e?3*B.parametros.salario_base_antiguedad*B.parametros.antiguedad_mas_veinticinco/100:void 0},B.calculoR=function(){B.sueldo.f110=B.sueldo.ivaCF},B.modificarFormulario110=function(e){B.empleado=angular.extend(B.empleado,e),B.sumarTotales(B.planilla),B.cerrarDialogFormulario110(),console.log("el empleadofff ===== ",e)},B.EmpleadosSeleccionados=[],B.checkEmpleado=function(e,a,o){var i=B.EmpleadosSeleccionados.indexOf(a);console.log("idx ===========",i),B.selectAll=!1,0<=i&&!o&&B.EmpleadosSeleccionados.splice(i,1),i<0&&!o&&B.EmpleadosSeleccionados.splice(e,1),i<0&&o&&B.EmpleadosSeleccionados.push(a),console.log("los seleccionadossssss ===== ",B.EmpleadosSeleccionados)},B.checkAll=function(e,a){B.EmpleadosSeleccionados=a?angular.copy(e):[],angular.forEach(e,function(e){e.checked=a})},B.abrirDialogFormulario110=function(e){B.empleado=e,B.sueldo=angular.copy(e),console.log("$scope.sueldo ==== ",B.sueldo),B.abrirPopup(B.idModalFormulario110)},B.generarExcelFormulario110=function(e){var a=[["CODIGO","NOMBRE COMPLETO","MONTO DECLARADO","IVA CF","NUMERO DE FACTURAS"]];if(e)for(var o=0;o<e.RecursosHumanosEmpleados.length;o++){var i=[];i.push(e.RecursosHumanosEmpleados[o].codigo),i.push(e.RecursosHumanosEmpleados[o].nombre_completo),i.push(0),i.push(0),i.push(0),a.push(i)}var t=new Workbook,r=sheet_from_array_of_arrays(a);r["!cols"]=[{wch:12},{wch:25},{wch:17},{wch:10},{wch:20}],t.SheetNames.push("SheetJS"),t.Sheets.SheetJS=r;var n=XLSX.write(t,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),"datos_formulario11o.xlsx"),z.stop()},B.subirExcelFormulario110=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){z.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i];B.selectEdit=function(e){var a=function(e){for(var a=0;a<B.planilla.RecursosHumanosEmpleados.length;a++)if(B.planilla.RecursosHumanosEmpleados[a].codigo==e)return a;return-1}(e.codigo);B.planilla.RecursosHumanosEmpleados[a].ivaCF=e.ivaCF,B.planilla.RecursosHumanosEmpleados[a].montoDeclarado=e.montoDeclarado,B.planilla.RecursosHumanosEmpleados[a].muneroFacturas=e.muneroFacturas,B.calcularRCIVA2(B.planilla.RecursosHumanosEmpleados[a],e)};do{var n={};n.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,n.nombre_completo=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,n.montoDeclarado=null!=r["C"+t]&&""!=r["C"+t]?Number(r["C"+t].v):null,n.ivaCF=null!=r["D"+t]&&""!=r["D"+t]?Number(r["D"+t].v):null,n.muneroFacturas=null!=r["E"+t]&&""!=r["E"+t]?Number(r["E"+t].v):null,B.selectEdit(n),t++,0}while(null!=r["A"+t]);B.sumarTotales(B.planilla),B.cerrarDialogFormularioGeneral110(),z.stop()},t.readAsBinaryString(o)}},B.cerrarDialogFormulario110=function(){B.cerrarPopup(B.idModalFormulario110)},B.abrirDialogFormularioGeneral110=function(){B.abrirPopup(B.idModalFormularioGeneral110)},B.modificarFormularioGeneral110=function(e){B.selectEdit=function(e){var a=function(e){for(var a=0;a<B.planilla.RecursosHumanosEmpleados.length;a++)if(B.planilla.RecursosHumanosEmpleados[a].id==e)return a;return-1}(e.id);console.log("index empleado",a),B.planilla.RecursosHumanosEmpleados[a].ivaCF=e.ivaCF,B.planilla.RecursosHumanosEmpleados[a].montoDeclarado=e.montoDeclarado,B.planilla.RecursosHumanosEmpleados[a].muneroFacturas=e.muneroFacturas,B.calcularRCIVA2(B.planilla.RecursosHumanosEmpleados[a],e)},e.forEach(function(e){B.selectEdit(e)}),console.log("empleado generalllllllll ====== ",B.planilla.RecursosHumanosEmpleados),B.sumarTotales(B.planilla),B.cerrarDialogFormularioGeneral110()},B.generar=function(e){e.$save(function(e){B.nuevaPlanillaRcIva(),z.stop(),B.mostrarMensaje("Planilla registrada exitosamente!")},function(e){z.stop(),console.log("fallo ",e)}),console.log("los datos  de planilla rc ivaaa ",e)},B.cerrarDialogFormularioGeneral110=function(){B.cerrarPopup(B.idModalFormularioGeneral110)},B.abrirDialogArchivosTXT=function(){B.abrirPopup(B.idModalArchivosTXT)},B.cerrarDialogArchivosTXT=function(){B.cerrarPopup(B.idModalArchivosTXT)},B.obtenerParametros(B.usuario.id_empresa)}]),angular.module("agil.controladores").controller("ControladorRecursosHumanos",["$scope","$sce","$localStorage","$location","$templateCache","$route","blockUI","ListaDatosGenero","NuevoRecursoHumano","RecursosHumanosPaginador","Paginator","FieldViewer","EmpleadoEmpresa","obtenerEmpleadoRh","UsuarioRecursosHUmanosActivo","Prerequisito","ListaDatosPrerequisito","Prerequisitos","ListaPrerequisitosPaciente","ActualizarPrerequisito","UsuarioRecursosHumanosFicha","ClasesTipo","Clases","Paises","CrearEmpleadoFicha","EliminarOtroSeguroRh","EliminarFamiliarRh","PrerequisitoPaciente","PrerequisitosHistorial","UsuarioRhHistorialFicha","ObtenerEmpleadoHojaVida","GuardarEmpleadoHojaVida","CrearPrestamo","ObtenerListaPrestamo","CrearRolTurno","CrearPagoPrestamo","VerificarUsuarioEmpresa","EditarPrestamo","ListaEmpleadosRrhh","CrearHorasExtra","HistorialHorasExtra","ListaRolTurnos","ValidarCodigoCuentaEmpleado","$timeout","DatosCapacidadesImpresion","NuevoAnticipoEmpleado","ListaAnticiposEmpleado","CrearNuevosAnticiposEmpleados","ActualizarAnticipoEmpleado","NuevaAusenciaEmpleado","HistorialEmpleadoAusencias","HistorialEmpresaEmpleadosAusencias","NuevaVacacionEmpleado","HistorialEmpleadoVacaciones","HistorialEmpresaVacaciones","NuevoFeriado","ListaFeriados","GuardarClasesAusencias","Tipos","ListaBancos","ConfiguracionesVacacion","HistorialGestionesVacacion","GuardarTr3","ListaTr3Empresa","GuardarHistorialVacacion","CrearBeneficioSocial","ListaBeneficiosEmpleado","GuardarBitacoraFicha","VerBitacoraFicha","ObtenerFiniquitoEmpleado","ClasesTipoEmpresa","GuardarConfiguracionRopaCargo","ListaConfiguracionRopaCargo","DatosReporteConfiguracionRopa","FichasEmpleadoEmpresa","ListaCargosEmpleado","ListaRopaTrabajoProductos","GuardarDotacionRopa","ListaDotacionRopa","EliminarDotacionRopa","ListaDotacionRopaEmpresa","ActualizarDotacionRopa","FamiliaresEmpleadoEmpresa","ListaRolTurnosEmpresa","ClasesEmpresa","ListaChoferesViaje","GuardarViajeRrhh","ListaViajeRrhh","ListaRolTurnosCalendario","ViajeRrhhLista","BeneficioEmpresa","GuardarConductoresEmpresa","ListaHijosEmpleadosEmpresa","GuardarImportacionFichaEmpleados","GuardarImportacionRolTurnoEmpleados","PrerequisitosSave",function(S,l,e,a,o,i,E,t,r,n,s,c,d,p,u,m,f,g,v,h,b,C,P,_,M,D,x,A,T,w,I,R,j,O,F,V,N,H,B,z,L,k,U,y,G,q,Y,W,J,X,K,Z,Q,ee,ae,oe,ie,te,re,ne,se,ce,le,de,ue,pe,me,fe,ge,ve,he,be,Ce,Pe,_e,Me,De,Ee,xe,Se,Ae,Te,we,Ie,Re,je,Oe,Fe,Ve,Ne,He,Be,ze,Le,ke,$e){S.usuario=JSON.parse(e.usuario),S.idModalPrerequisitos="dialog-pre-requisitos",S.idModalEmpleado="dialog-empleado",S.idModalwizardContainerEmpleado="modal-wizard-empleado-container",S.idModalDepartamentoEstado="dialog-departamento-estado",S.idModalProvincia="dialog-provincia",S.idModalLocalidad="dialog-localidad",S.idImputContrato="id-contrato",S.idModalHojaVida="modal-hoja-vida",S.idModalwizardContainerHojaVida="modal-wizard-hoja-vida-container",S.idModalNuevoFamiliar="dialog-nuevo-familiar",S.idModalHistorialContrato="dialog-historial-contrato",S.idModalBeneficiosSociales="modal-beneficios-sociales",S.idModalDetalleVacaciones="dialog-detalle-vacaciones",S.idModalBitacoraFicha="dialog-bitacora-ficha",S.idModalAnticipoExtraordinario="dialog-anticipo-extraordinario",S.idModalNuevoPrestamo="dialog-nuevo-prestamo",S.idModalAusenciasVacaciones="dialog-ausencias-vacaciones",S.idTabAusenciasVacaciones="tab-ausencias-vacaciones",S.idModalTipoBaja="dialog-tipo-baja",S.idModalFeriados="dialog-feriados",S.idModalHitorialVacaciones="dialog-historial-vacaciones",S.idModalCompensacion="dialog-compesacion",S.idModalHistorialAusencias="dialog-historial-ausencias",S.idModalHistorialAusenciaMedica="dialog-historial-ausencia-medica",S.idModalTipoAusencia="dialog-tipo-ausencia",S.idModalRolTurnos="dialog-rol-turnos",S.idModalHistorialTurnos="dialog-historial-turnos",S.idModalHorasExtras="dialog-horas-extras",S.idModalHistorialHorasExtras="dialog-historial-horas-extras",S.idModalAnticipoRegular="dialog-anticipo-regular",S.idModalPrestamosPersonal="dialog-prestamos-personal",S.idModalAdvertencia="dialog-advertencia",S.idModalPretamosNuevoTodos="dialog-nuevo-prestamo-todos",S.idModalReporteHijos="dialog-reporte-hijos",S.idModalReporteVeneficios="dialog-reporte-beneficios-sociales",S.idModalPagoPrestamo="dialog-pago-prestamo",S.idModalReporteVacaciones="dialog-reporte-vacaciones",S.idModalReporteBajasMedicas="dialog-reporte-bajas-medicas",S.idModalReporteRolTurnos="dialog-reporte-rol-turnos",S.idModalReporteTurnosDetallado="dialog-reporte-turnos-detallado",S.idModalViajes="dialog-viajes",S.idModalVisita="dialog-visita",S.idModalVisitaSalida="dialog-visita-salida",S.idModalVehiculosViaje="dialog-vehiculos-viaje",S.idModalConductoresViaje="dialog-conductores-viaje",S.idModalHistorialViajes="dialog-historial-viajes",S.idModalReporteAusencias="dialog-reporte-ausencias",S.idModalCertificado="dialog-certificado",S.idModalRhNuevo="dialog-rh-nuevo",S.idModalWizardRhNuevo="modal-wizard-rh-container",S.idImagenUsuario="imagen-persona",S.idEliminarUsuarioRh="dialog-eliminar-usuarioRh",S.idEliminarSeguroEmpleado="dialog-eliminar-seguro",S.idEliminarFamiliarEmpleado="dialog-eliminar-familiar",S.idModalWizardRhVista="dialog-rh-vista",S.idModalContenedorRhVista="modal-wizard-container-rh-vista",S.idModalDialogPrerequisitoNuevo="dialog-pre-requisito-nuevo",S.idModalHistorialPrerequisito="dialog-historico-preRequisito",S.idModalEditarPrerequisito="dialog-editar-preRequisito",S.idModalDialogConfirmacionEntregaAdelantado="dialog-entrega-adelantada-prerequisito",S.IdEntregaPrerequisito="dialog-entrega-preRequisito",S.IdModalVerificarCuenta="modal-verificar-cuenta",S.IdModalVerificarCuentaRrhh="modal-verificar-cuenta-Rrhh",S.idModalImpresionHojaVida="dialog-impresion-hoja-vida",S.idModalNuevoAnticipoRegularTodos="dialog-nuevo-anticipo-regular-todos",S.idModalTr3BancoMsc="modal-tr3-banco-msc",S.idModalTr3BancoUnion="modal-tr3-banco-union",S.idModalHistorialTr3="modal-historial-tr3",S.idModalConfirmarDesabilitacion="modal-confirmar-desabilitacion",S.idModalReingresoEmpleado="modal-reingreso-empleado",S.idModalHistorialBeneficios="dialog-historial-beneficio_social",S.idModalConfiguracionRopaDeTrabajo="dialog-configuracion-ropa-trabajo",S.idModalReporteRopaDeTrabajo="dialog-reporte-ropa-trabajo",S.idmodalWizardContainerConfiguracionRopaTrabajo="modal-wizard-container-configuracion-ropa-trabajo",S.idModalRopaTrabajo="dialog-ropa-trabajo",S.idModalNuevaRopaTrabajo="dialog-nueva-ropa-trabajo",S.idModalItemsNuevaRopaTrabajo="dialog-items-nueva-ropa-trabajo",S.idModalEliminarRopaTrabajo="dialog-eliminar-ropa-trabajo",S.idModalConceptoEdicion="dialog-conceptos",S.idModalDesabilitarPasajero="dialog-motivo-desabilitar-viajero",S.idModalCerrarRolDeTurno="modal-cerrar-rol-de-turno",S.idModalHistorialGestionesVacaciones="dialog-historial-gestiones-vacaciones",S.idModalTipoImportacionRol="dialog-tipo-importacion-rol",S.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsRecursosHumanos(S.idModalPrerequisitos,S.idModalEmpleado,S.idModalwizardContainerEmpleado,S.idModalDepartamentoEstado,S.idModalProvincia,S.idModalLocalidad,S.idImputContrato,S.idModalHojaVida,S.idModalwizardContainerHojaVida,S.idModalNuevoFamiliar,S.idModalHistorialContrato,S.idModalBeneficiosSociales,S.idModalDetalleVacaciones,S.idModalBitacoraFicha,S.idModalAnticipoExtraordinario,S.idModalNuevoPrestamo,S.idModalAusenciasVacaciones,S.idTabAusenciasVacaciones,S.idModalTipoBaja,S.idModalFeriados,S.idModalHitorialVacaciones,S.idModalCompensacion,S.idModalHistorialAusencias,S.idModalHistorialAusenciaMedica,S.idModalTipoAusencia,S.idModalRolTurnos,S.idModalHistorialTurnos,S.idModalHorasExtras,S.idModalHistorialHorasExtras,S.idModalAnticipoRegular,S.idModalPrestamosPersonal,S.idModalAdvertencia,S.idModalPretamosNuevoTodos,S.idModalReporteHijos,S.idModalReporteVeneficios,S.idModalPagoPrestamo,S.idModalReporteVacaciones,S.idModalReporteBajasMedicas,S.idModalReporteRolTurnos,S.idModalReporteTurnosDetallado,S.idModalViajes,S.idModalVisita,S.idModalVehiculosViaje,S.idModalHistorialViajes,S.idModalReporteAusencias,S.idModalCertificado,S.idModalRhNuevo,S.idModalWizardRhNuevo,S.idImagenUsuario,S.idEliminarUsuarioRh,S.idModalWizardRhVista,S.idModalContenedorRhVista,S.idModalDialogPrerequisitoNuevo,S.idEliminarSeguroEmpleado,S.idEliminarFamiliarEmpleado,S.idModalHistorialPrerequisito,S.idModalEditarPrerequisito,S.idModalDialogConfirmacionEntregaAdelantado,S.IdEntregaPrerequisito,S.IdModalVerificarCuenta,S.idModalImpresionHojaVida,S.idModalNuevoAnticipoRegularTodos,S.idModalTr3BancoMsc,S.idModalTr3BancoUnion,S.idModalHistorialTr3,S.IdModalVerificarCuentaRrhh,S.idModalConfirmarDesabilitacion,S.idModalReingresoEmpleado,S.idModalHistorialBeneficios,S.idModalConfiguracionRopaDeTrabajo,S.idModalReporteRopaDeTrabajo,S.idmodalWizardContainerConfiguracionRopaTrabajo,S.idModalRopaTrabajo,S.idModalNuevaRopaTrabajo,S.idModalItemsNuevaRopaTrabajo,S.idModalEliminarRopaTrabajo,S.idModalConceptoEdicion,S.idModalVisitaSalida,S.idModalDesabilitarPasajero,S.idModalCerrarRolDeTurno,S.idModalConductoresViaje,S.idModalHistorialGestionesVacaciones,S.idModalTipoImportacionRol),S.buscarAplicacion(S.usuario.aplicacionesUsuario,a.path().substring(1)),S.obtenerColumnasAplicacion(),E.stop()}),S.$on("$routeChangeStart",function(e,a){S.eliminarPopup(S.idModalEmpleado),S.eliminarPopup(S.idModalDepartamentoEstado),S.eliminarPopup(S.idModalProvincia),S.eliminarPopup(S.idModalLocalidad),S.eliminarPopup(S.idModalHojaVida),S.eliminarPopup(S.idModalNuevoFamiliar),S.eliminarPopup(S.idModalHistorialContrato),S.eliminarPopup(S.idModalBeneficiosSociales),S.eliminarPopup(S.idModalDetalleVacaciones),S.eliminarPopup(S.idModalBitacoraFicha),S.eliminarPopup(S.idModalAnticipoExtraordinario),S.eliminarPopup(S.idModalNuevoPrestamo),S.eliminarPopup(S.idModalAusenciasVacaciones),S.eliminarPopup(S.idModalTipoBaja),S.eliminarPopup(S.idModalFeriados),S.eliminarPopup(S.idModalHitorialVacaciones),S.eliminarPopup(S.idModalCompensacion),S.eliminarPopup(S.idModalHistorialAusencias),S.eliminarPopup(S.idModalHistorialAusenciaMedica),S.eliminarPopup(S.idModalTipoAusencia),S.eliminarPopup(S.idModalRolTurnos),S.eliminarPopup(S.idModalHistorialTurnos),S.eliminarPopup(S.idModalHorasExtras),S.eliminarPopup(S.idModalHistorialHorasExtras),S.eliminarPopup(S.idModalAnticipoRegular),S.eliminarPopup(S.idModalPrestamosPersonal),S.eliminarPopup(S.idModalAdvertencia),S.eliminarPopup(S.idModalPretamosNuevoTodos),S.eliminarPopup(S.idModalReporteHijos),S.eliminarPopup(S.idModalReporteVeneficios),S.eliminarPopup(S.idModalPagoPrestamo),S.eliminarPopup(S.idModalReporteVacaciones),S.eliminarPopup(S.idModalReporteBajasMedicas),S.eliminarPopup(S.idModalReporteRolTurnos),S.eliminarPopup(S.idModalReporteTurnosDetallado),S.eliminarPopup(S.idModalViajes),S.eliminarPopup(S.idModalVisita),S.eliminarPopup(S.idModalVehiculosViaje),S.eliminarPopup(S.idModalHistorialViajes),S.eliminarPopup(S.idModalReporteAusencias),S.eliminarPopup(S.idModalCertificado),S.eliminarPopup(S.idModalPrerequisitos),S.eliminarPopup(S.idModalRhNuevo),S.eliminarPopup(S.idModalWizardRhVista),S.eliminarPopup(S.idModalDialogPrerequisitoNuevo),S.eliminarPopup(S.idEliminarFamiliarEmpleado),S.eliminarPopup(S.idEliminarSeguroEmpleado),S.eliminarPopup(S.idModalHistorialPrerequisito),S.eliminarPopup(S.idModalEditarPrerequisito),S.eliminarPopup(S.idModalDialogConfirmacionEntregaAdelantado),S.eliminarPopup(S.IdEntregaPrerequisito),S.eliminarPopup(S.IdModalVerificarCuenta),S.eliminarPopup(S.idModalImpresionHojaVida),S.eliminarPopup(S.idModalNuevoAnticipoRegularTodos),S.eliminarPopup(S.idEliminarUsuarioRh),S.eliminarPopup(S.idModalTr3BancoMsc),S.eliminarPopup(S.idModalTr3BancoUnion),S.eliminarPopup(S.idModalHistorialTr3),S.eliminarPopup(S.IdModalVerificarCuentaRrhh),S.eliminarPopup(S.idModalConfirmarDesabilitacion),S.eliminarPopup(S.idModalReingresoEmpleado),S.eliminarPopup(S.idModalHistorialBeneficios),S.eliminarPopup(S.idModalConfiguracionRopaDeTrabajo),S.eliminarPopup(S.idModalReporteRopaDeTrabajo),S.eliminarPopup(S.idModalRopaTrabajo),S.eliminarPopup(S.idModalNuevaRopaTrabajo),S.eliminarPopup(S.idModalItemsNuevaRopaTrabajo),S.eliminarPopup(S.idModalEliminarRopaTrabajo),S.eliminarPopup(S.idModalConceptoEdicion),S.eliminarPopup(S.idModalVisitaSalida),S.eliminarPopup(S.idModalDesabilitarPasajero),S.eliminarPopup(S.idModalCerrarRolDeTurno),S.eliminarPopup(S.idModalConductoresViaje),S.eliminarPopup(S.idModalHistorialGestionesVacaciones)}),S.inicio=function(){S.localStorageSpace(),S.listYearsAnticipo=S.obtenerAnios(2017),S.obtenerGenero(),S.obtenerRecursosHumanos(),S.recuperarDatosTipo(),S.empleadosSeleccionados=[],S.listaBancos(),S.obtenerConfiguracionVacaciones(),S.obtenerTiposOtrosingresosYDeduccion(),S.obtenerMotivosRetiro(),S.buscarRopaTrabajo(),S.obtenerCuentasBancos(),S.buscarDepartamentoFiniquito(),S.obtenerGestiones(),S.obtenerChoferesViaje(),S.dynamicPopoverRopaTrabajo={templateUrl:"myPopoverRopaTrabajo.html"}},S.abrirDialogConceptoEdicion=function(e){S.tipo_edicion=e,S.clase={},S.abrirPopup(S.idModalConceptoEdicion)},S.cerrarDialogConceptoEdicion=function(){S.cerrarPopup(S.idModalConceptoEdicion)},S.abrirDialogCerrarRolDeTurno=function(){S.abrirPopup(S.idModalCerrarRolDeTurno)},S.cerrarDialogCerrarRolDeTurno=function(){S.cerrarPopup(S.idModalCerrarRolDeTurno)},S.abrirDialogConductoresViaje=function(){S.conductor={},S.abrirPopup(S.idModalConductoresViaje)},S.cerrarDialogConductoresViaje=function(){S.cerrarPopup(S.idModalConductoresViaje)},S.abrirDialogTipoImportacionRol=function(e){S.rolesTurno=e,S.tipoImportacionRol=!0,S.abrirPopup(S.idModalTipoImportacionRol)},S.cerrarDialogTipoImportacionRol=function(){S.cerrarPopup(S.idModalTipoImportacionRol)},S.abrirDialogHistorialGestionesVacaciones=function(){S.conductor={};S.obtenerHistorialEmpresaVacacionGestion({}),S.abrirPopup(S.idModalHistorialGestionesVacaciones)},S.cerrarDialogHistorialGestionesVacaciones=function(){S.cerrarPopup(S.idModalHistorialGestionesVacaciones)},S.obtenerColumnasAplicacion=function(){S.fieldViewer=c({crear:!0,id_empresa:S.usuario.id_empresa,configuracion:{codigo:{value:"Codigo",show:!0},nombre:{value:"Nombre",show:!0},empresa:{value:"Empresa",show:!0},imagen:{value:"Imagen",show:!0},ci:{value:"CI",show:!0},extension:{value:"Extension",show:!0},tipo_contrato:{value:"Tipo Contrato",show:!0},campo:{value:"Campo",show:!0},cargo:{value:"Cargo",show:!0}}},S.aplicacion.aplicacion.id),S.fieldViewer.updateObject()},S.abrirModalHistorialTr3=function(e,a){S.tipoBanco=a,de(S.usuario.id_empresa,e.nombre).then(function(e){S.historialTr3=e,S.abrirPopup(S.idModalHistorialTr3)}).catch(function(e){var a=void 0!==e.data&&null!==e.data?e.data:e.message;S.mostrarMensaje("Se produjo un error! > "+a),E.stop()})},S.abrirModalBeneficioSicial=function(){S.abrirPopup(S.idModalHistorialBeneficios)},S.obtenerbeneficiosSociales=function(i){S.quienqueniosDisponibles=!0,me(S.empleado.id_ficha).then(function(e){S.listabeneficios=e,S.quinqueniosRealizados=S.listabeneficios.length;var a=5*S.quinqueniosRealizados,o=i.anios-a;S.añosRestantes=o,S.quienquenioRestante=Math.trunc(o/5),S.beneficio.tipo_beneficio||(0==S.quienquenioRestante?(S.quienquenioRestanteDisabled=!0,S.mostrarMensaje("No cuenta con mas quinquenios disponibles")):S.quienquenioRestanteDisabled=!1)})},S.cerrarModalBeneficioSicial=function(){S.cerrarPopup(S.idModalHistorialBeneficios)},S.cerrarModalHistorialTr3=function(){S.cerrarPopup(S.idModalHistorialTr3)},S.abrirModalConfiguracionRopaDeTrabajo=function(){S.listaRopasDeTrabajo=[],S.ropaTrabajo={},S.cargo="",S.abrirPopup(S.idModalConfiguracionRopaDeTrabajo)},S.cerrarModalConfiguracionRopaDeTrabajo=function(){S.cerrarPopup(S.idModalConfiguracionRopaDeTrabajo)},S.abrirModalReporteRopaDeTrabajo=function(e){S.abrirPopup(S.idModalReporteRopaDeTrabajo)},S.cerrarModalReporteRopaDeTrabajo=function(){S.cerrarPopup(S.idModalReporteRopaDeTrabajo)},S.abrirModalDesabilitarPasajero=function(e){"HABILITADO"==(S.empleado=e).estado.nombre?S.abrirPopup(S.idModalDesabilitarPasajero):e.habilitado=!1},S.cerrarModalDesabilitarPasajero=function(){S.cerrarPopup(S.idModalDesabilitarPasajero)},S.abrirModalRopaTrabajo=function(e){S.filtroropa={},e.activo&&(S.empleado=e,S.dynamicPopoverCargosRopaTrabajo={templateUrl:"myPopoverCargosRopa.html"},S.dynamicPopoverRopasRopaTrabajo={templateUrl:"myPopoverRopasRopa.html"},S.ObtenerDotacionesRopa(e),S.abrirPopup(S.idModalRopaTrabajo))},S.cerrarModalRopaTrabajo=function(){S.cerrarPopup(S.idModalRopaTrabajo)},S.abrirModalNuevaRopaTrabajo=function(e,a,o,i){if(S.filtroropa.inicio="",S.filtroropa.fin="",S.empleado=e,a?S.actualizarDotacion=!0:(S.actualizarDotacion=!1,S.verinformacionDOtacion=!1),null!=o?(S.verinformacionDOtacion=!0,S.indexInfo=o,console.log(S.listaDotaciones[S.indexInfo].ropas),S.visible=!1):null!=i&&(S.indexInfo=i,S.visible=!0,S.verinformacionDOtacion=!1),0<S.listaDotaciones.length){var t=new Date;if(new Date(S.listaDotaciones[S.listaDotaciones.length-1].fecha_vencimiento).getTime()>t.getTime()){S.obtenerCargosEmpleado(a,o,!1);S.dotacionRopa=S.listaDotaciones[S.listaDotaciones.length-1],S.sucursales.forEach(function(e,a,o){0==e.numero&&(S.dotacionRopa.sucursal=e),a===o.length-1&&S.obtenerAlmacenes(S.dotacionRopa.sucursal.id)}),S.dotacionRopa.almacen=S.listaDotaciones[S.listaDotaciones.length-1].almacen,S.dotacionRopa.almacen?S.editAlmacen=!0:S.editAlmacen=!1,S.abrirPopup(S.idModalNuevaRopaTrabajo)}else S.editAlmacen=!1,S.dotacionRopa={id_usuario:S.usuario.id},S.sucursales.forEach(function(e,a,o){0==e.numero&&(S.dotacionRopa.sucursal=e),a===o.length-1&&S.obtenerAlmacenes(S.dotacionRopa.sucursal.id)}),S.obtenerCargosEmpleado(a,o,!0),S.abrirPopup(S.idModalNuevaRopaTrabajo)}else S.editAlmacen=!1,S.empleado=e,S.dotacionRopa={id_usuario:S.usuario.id},S.sucursales.forEach(function(e,a,o){0==e.numero&&(S.dotacionRopa.sucursal=e),a===o.length-1&&S.obtenerAlmacenes(S.dotacionRopa.sucursal.id)}),S.obtenerCargosEmpleado(a,o,!1),S.abrirPopup(S.idModalNuevaRopaTrabajo)},S.cerrarModalNuevaRopaTrabajo=function(){S.ObtenerDotacionesRopa(S.empleado),S.cerrarPopup(S.idModalNuevaRopaTrabajo)},S.abrirModalItemsNuevaRopaTrabajo=function(){console.log(S.dotacionRopa.dotacionItems),S.obtenerListaRopaTrabajoProductos(),S.abrirPopup(S.idModalItemsNuevaRopaTrabajo)},S.cerrarModalItemsNuevaRopaTrabajo=function(){S.cerrarPopup(S.idModalItemsNuevaRopaTrabajo)},S.abrirModalTr3BancoMsc=function(){S.abrirPopup(S.idModalTr3BancoMsc)},S.cerrarModalTr3BancoMsc=function(){S.cerrarPopup(S.idModalTr3BancoMsc)},S.abrirModalTr3BancoUnion=function(){S.abrirPopup(S.idModalTr3BancoUnion)},S.cerrarModalTr3BancoUnion=function(){S.cerrarPopup(S.idModalTr3BancoUnion)},S.abrirModalbanco=function(e){S.tr3={anticipos:S.anticiposTr3,tipo:""},"Banco Mercantil Santa Cruz"==(S.datosBanco=e).nombre&&(S.tr3.tipo="MSC",S.abrirModalTr3BancoMsc()),"Banco Unión"==e.nombre&&(S.tr3.tipo="BU",S.abrirModalTr3BancoUnion())},S.abrirModalImprimirHojaVida=function(){S.filtroCap={inicio:"",fin:"",capacidadInterna:""},S.abrirPopup(S.idModalImpresionHojaVida)},S.cerrarModalImprimirHojaVida=function(){S.cerrarPopup(S.idModalImpresionHojaVida)},S.abrirDialogEditarPreRequisito=function(e){S.prerequisito=e,S.prerequisito.fecha_vencimiento_texto=S.fechaATexto(new Date),S.abrirPopup(S.idModalEditarPrerequisito)},S.cerrarDialogEditarPreRequisito=function(){S.cerrarPopup(S.idModalEditarPrerequisito)},S.abrirDialogPrerequisitoNuevo=function(){S.NuevoP=new m({puede_modificar_rrhh:!1}),S.abrirPopup(S.idModalDialogPrerequisitoNuevo)},S.cerrarDialogPrerequisitoNuevo=function(){S.cerrarPopup(S.idModalDialogPrerequisitoNuevo)},S.abrirDialogHistoricoPreRequisito=function(e,a){var o=0,i=0;S.preRequisito=e,S.paciente=a,T({id_pre:S.preRequisito.preRequisito.id,id_pac:S.paciente.id,inicio:o,fin:i}).then(function(e){S.historialPrerequisitosPaciente=e.historial,E.stop(),S.filtro.inicio=S.filtro.inicio instanceof Date?S.filtro.inicio.getDate()+"/"+(S.filtro.inicio.getMonth()+1)+"/"+S.filtro.inicio.getFullYear():"",S.filtro.fin=S.filtro.fin instanceof Date?S.filtro.fin.getDate()+"/"+(S.filtro.fin.getMonth()+1)+"/"+S.filtro.fin.getFullYear():""}),S.abrirPopup(S.idModalHistorialPrerequisito)},S.guardarEntregaPrerequisito=function(e){E.start(),null==e.fecha_entrega_texto||""==e.fecha_entrega_texto?S.mostrarMensaje("Ingrese la fecha de entrega."):(e.fecha_entrega=new Date(S.convertirFecha(e.fecha_entrega_texto)),e.asignado=!0,A.save(e,function(a){v(S.paciente.id,{inicio:0,fin:0}).then(function(e){S.prerequisitosPaciente=e.Prerequisitos,S.mostrarMensaje(a.mensaje),S.prerequisitosPaciente.forEach(function(e){null!=e.fecha_entrega&&(e.entregado=!0)}),S.cerrarPopUpEntregaPreRequisito(),E.stop()})},function(e){S.mostrarMensaje("Ocurrio un problema al guardar la fecha de entrega  de el prerequisito")}))},S.verificarFechaEntregaPrerequisito=function(e,a){S.preRequisito=e,S.preRequisito.fecha_entrega_texto=S.fechaATexto(new Date),S.paciente=void 0===a?e.pacientePrerequisito:a;var o=new Date(S.preRequisito.fecha_vencimiento).getTime(),i=(new Date).getTime();0<=Math.floor((i-o)/864e5)?S.abrirDialogEntregaPreRequisito(S.preRequisito,S.empleado):S.abrirPopup(S.idModalDialogConfirmacionEntregaAdelantado)},S.abrirDialogEntregaPreRequisito=function(e,a){S.cerrarConfirmacionEntragaAdelantadaPrerequisito(),S.preRequisito=e,S.preRequisito.fecha_entrega_texto=S.fechaATexto(new Date),S.paciente=a,S.abrirPopup(S.IdEntregaPrerequisito)},S.cerrarPopUpEntregaPreRequisito=function(){S.cerrarPopup(S.IdEntregaPrerequisito)},S.cerrarConfirmacionEntragaAdelantadaPrerequisito=function(){S.cerrarPopup(S.idModalDialogConfirmacionEntregaAdelantado)},S.filtrarHistorialPrerequisito=function(a){if(null!=a){var e=null===a.inicio||""===a.inicio||void 0===a.inicio?0:new Date(a.inicio),o=null===a.fin||""===a.fin||void 0===a.fin?0:new Date(a.fin),i=null===a.opcion||void 0===a.opcion?0:a.opcion;a={inicio:e,fin:o,opcion:i}}else a={inicio:0,fin:0};T({id_pre:S.preRequisito.preRequisito.id,id_pac:S.paciente.id,inicio:a.inicio,fin:a.fin}).then(function(e){S.historialPrerequisitosPaciente=e.historial,E.stop(),a.inicio=S.filtro.inicio instanceof Date?S.filtro.inicio.getDate()+"/"+(S.filtro.inicio.getMonth()+1)+"/"+S.filtro.inicio.getFullYear():"",a.fin=S.filtro.fin instanceof Date?S.filtro.fin.getDate()+"/"+(S.filtro.fin.getMonth()+1)+"/"+S.filtro.fin.getFullYear():""})},S.cerrarDialogHistoricoPreRequisito=function(){S.cerrarPopup(S.idModalHistorialPrerequisito)},S.abrirDialogVerEmpleado=function(e){promesaPaciente=p(e.id),promesaPaciente.then(function(e){null!=e.clase&&(e.medicoPaciente.tipo_contrato=e.clase),S.paciente=e.medicoPaciente,S.paciente.fecha_nacimiento_texto=S.fechaATexto(S.paciente.persona.fecha_nacimiento),S.seleccionarCargos(paciente.cargos),S.paciente.ver=!0}),S.abrirPopup(S.idModalWizardRhVista)},S.cerrarDialogVerEmpleado=function(){S.cerrarPopup(S.idModalWizardRhVista)},S.abrirDialogRhNuevo=function(){S.steps=[{cabeza:"cabeza-nuevo-datos-personales",cuerpo:"cuerpo-nuevo-datos-personales"},{cabeza:"cabeza-nuevo-datos-comple",cuerpo:"cuerpo-nuevo-datos-comple"},{cabeza:"cabeza-nuevo-datos-laborales",cuerpo:"cuerpo-nuevo-datos-laborales"}],S.nuevoRH=new r({persona:{imagen:"img/icon-user-default.png"},id_empresa:S.usuario.id_empresa,es_empleado:!0,activoCopiaCodigo:!0}),S.abrirPopup(S.idModalRhNuevo)},S.cerrarDialogRhNuevo=function(){S.cerrarPopup(S.idModalRhNuevo)},S.cerrarDialogEliminarUsuarioRh=function(){S.cerrarPopup(S.idEliminarUsuarioRh)},S.abrirDialogEliminarUsuarioRh=function(e){(S.empleado=e).activo&&S.abrirPopup(S.idEliminarUsuarioRh)},S.cerrarDialogEliminarSeguroEmpleado=function(){S.cerrarPopup(S.idEliminarSeguroEmpleado)},S.abrirDialogEliminarSeguroEmpleado=function(e,a){S.otroSeguro=e,S.otroSeguro.index=a,S.abrirPopup(S.idEliminarSeguroEmpleado)},S.cerrarDialogEliminarFamiliarEmpleado=function(){S.cerrarPopup(S.idEliminarFamiliarEmpleado)},S.abrirDialogEliminarFamiliarEmpleado=function(e,a){S.familiar=e,S.familiar.index=a,S.abrirPopup(S.idEliminarFamiliarEmpleado)},S.abrirIdModalDialogPreRequisitos=function(e){e.activo&&(S.empleado=e,S.verificarAsignacionPrerequisitos(),S.abrirPopup(S.idModalPrerequisitos))},S.cerrarIdModalDialogPreRequisitos=function(){S.cerrarPopup(S.idModalPrerequisitos)},S.abrirDialogEmpleado=function(e,a){null==S.primeroGuardarParaCerrar&&(S.primeroGuardarParaCerrar=!1),S.steps=[{cabeza:"stepDatosPersonales",cuerpo:"datos-personales"},{cabeza:"stepDatosLaborales",cuerpo:"ficha-datos-laborales"},{cabeza:"stepdatosAfiliacion",cuerpo:"ficha-seguros"},{cabeza:"stepDatosFamiliares",cuerpo:"ficha-familia"}],S.obtenerDatosFichaUsuario(e,a),(S.empleado=e).activo?S.nopuedoModificarFicha=!1:S.nopuedoModificarFicha=!0,S.abrirPopup(S.idModalEmpleado)},S.cerrarDialogEmpleado=function(e){0==S.primeroGuardarParaCerrar?(S.departamentos=[],S.provincias=[],S.localidades=[],S.obtenerCargos(),S.obtenerDiscapacidades(),S.cerrarPopup(S.idModalEmpleado)):S.mostrarMensaje("guardar nuevo reingreso para salir!")},S.abrirDialogDepartamentoEstado=function(){S.clase={pais:S.ficha.empleado.persona.pais},C("DEP").then(function(e){S.tipo_edicion2=e,S.abrirPopup(S.idModalDepartamentoEstado)})},S.cerrarDialogDepartamentoEstado=function(){S.cerrarPopup(S.idModalDepartamentoEstado)},S.abrirDialogProvincia=function(){S.clase={departamento:S.ficha.empleado.persona.ciudad},C("MUN").then(function(e){S.tipo_edicion2=e,S.abrirPopup(S.idModalProvincia)})},S.cerrarDialogProvincia=function(){S.cerrarPopup(S.idModalProvincia)},S.abrirDialogLocalidad=function(){S.clase={provincia:S.ficha.empleado.persona.provincia},C("LOC").then(function(e){S.tipo_edicion2=e,S.abrirPopup(S.idModalLocalidad)})},S.cerrarDialogLocalidad=function(){S.cerrarPopup(S.idModalLocalidad)},S.fechacontratos=[{name:"10/01/2000 - 01/01/2002"},{name:"10/01/2000 - 01/01/2002"},{name:"10/01/2000 - 01/01/2002"}],S.localLang={selectAll:"Marcar todo",selectNone:"No marcar ninguno",reset:"Deshacer todo",search:"Escriba aquí para busc$scope.idModalGradoar...",nothingSelected:"No se ha seleccionado nada"},S.abrirDialogHojaVida=function(e){S.empleado=e,S.empleado.activo=!e.eliminado,S.empleado.persona||(S.empleado.persona={nombre_completo:""},S.empleado.persona.nombre_completo=e.nombre_completo),I(e.id).then(function(e){e.hojaVida?(0<e.hojaVida.capacidades.length&&e.hojaVida.capacidades.forEach(function(e,a,o){e.fechaTexto=S.fechaATexto(e.fecha)}),0<e.hojaVida.logros.length&&e.hojaVida.logros.forEach(function(e,a,o){e.fechaTexto=S.fechaATexto(e.fecha)}),0<e.hojaVida.experienciasLaborales.length&&e.hojaVida.experienciasLaborales.forEach(function(e,a,o){e.fecha_inicioTexto=S.fechaATexto(e.fecha_inicio),e.fecha_finTexto=S.fechaATexto(e.fecha_fin)}),S.hojaVida=e.hojaVida):S.hojaVida={capacidades:[],logros:[],formacionesAcademicas:[],experienciasLaborales:[]}}),S.formacionAcademica={edit:!1,eliminado:!1},S.capacidad={edit:!1,eliminado:!1},S.logros={edit:!1,eliminado:!1},S.experienciaLaboral={edit:!1,eliminado:!1},S.abrirPopup(S.idModalHojaVida)},S.cerrarDialogHojaVida=function(){S.cerrarPopup(S.idModalHojaVida)},S.abrirDialogNuevoFamiliar=function(){S.abrirPopup(S.idModalNuevoFamiliar)},S.cerrarDialogNuevoFamiliar=function(){S.familiar&&(S.familiar={edit:!1}),S.cerrarPopup(S.idModalNuevoFamiliar)},S.abrirDialogHistorialContrato=function(){S.obtenerHistorialContratos(S.empleado),S.abrirPopup(S.idModalHistorialContrato)},S.cerrarDialogHistorialContrato=function(){S.cerrarPopup(S.idModalHistorialContrato)},S.abrirDialogBeneficiosSociales=function(e,a){if((S.empleado=e).fecha_inicio){if(a){S.beneficio=a;var o=null,i=new Date;S.beneficio.fecha_elaboracion=S.beneficio.fecha_elaboracion?S.fechaATexto(S.beneficio.fecha_elaboracion):S.fechaATexto(new Date),S.beneficio.fecha_asistensia&&(S.beneficio.fecha_asistensia=S.fechaATexto(S.beneficio.fecha_asistensia)),S.beneficio.fecha_ingreso=S.beneficio.fecha_ingreso?S.fechaATexto(S.beneficio.fecha_ingreso):S.fechaATexto(e.fecha_inicio),S.beneficio.fecha_retiro&&(S.beneficio.fecha_retiro=S.fechaATexto(S.beneficio.fecha_retiro));var t=!1;e.fecha_expiracion&&(o=S.fechaATexto(e.fecha_expiracion),i=new Date(e.fecha_expiracion),t=!0),a.cuenta&&(a.tipo_pago=!0),a.mes_uno=S.meses[a.mes_uno],a.mes_dos=S.meses[a.mes_dos],a.mes_tres=S.meses[a.mes_tres],a.totalAguinaldo=S.CalcularAguinaldoNavidad2(a);var r=new Date(e.fecha_inicio);S.tiempoTrabajado=duration(r,i);var n=S.fechaATexto(new Date);S.obtenerbeneficiosSociales(S.tiempoTrabajado),S.deduccion={},S.ingreso={},S.vacacion={sabado:!1,inicio_tipo:!1,fin_tipo:!1,aniosDisponibles:0,historial:null},S.beneficio.anios=0,S.beneficio.meses=0,S.beneficio.dias=0,S.beneficio.ingresos=[],S.beneficio.deducciones=[],S.beneficio.promedio=(S.beneficio.primer_mes+S.beneficio.segundo_mes+S.beneficio.tercer_mes)/3,S.beneficio.deduccionEingresos.forEach(function(e,a,o){"OTRING"==e.tipo.nombre_corto?S.beneficio.ingresos.push(e):S.beneficio.deducciones.push(e),a===o.length-1&&S.calcularDesaucio(S.beneficio,!0)})}else{o=null,i=new Date,t=!1;e.fecha_expiracion&&(o=S.fechaATexto(e.fecha_expiracion),i=new Date(e.fecha_expiracion),t=!0);r=new Date(e.fecha_inicio);S.tiempoTrabajado=duration(r,i);n=S.fechaATexto(new Date);S.beneficio={fecha_elaboracion:n,tipo_beneficio:t,anios:0,meses:0,dias:0,fecha_elaboracion:S.fechaATexto(new Date),fecha_ingreso:S.fechaATexto(e.fecha_inicio),fecha_retiro:o,ingresos:[],deducciones:[]},S.obtenerbeneficiosSociales(S.tiempoTrabajado),S.deduccion={},S.ingreso={},S.vacacion={sabado:!1,inicio_tipo:!1,fin_tipo:!1,aniosDisponibles:0,historial:null}}S.abrirPopup(S.idModalBeneficiosSociales)}else y(function(){S.$apply(function(){S.mostrarMensaje("No cuenta con ficha actualmente, crear ficha empleado!")})},200)},S.verVacaciones=function(){S.verVacacion=!S.verVacacion},S.abrirDialogBeneficiosSociales2=function(n,a){S.verVacacion=!1,ve(n.id_ficha).then(function(e){e.beneficio?e.beneficio.fecha_ingreso&&1!=a?S.abrirModalVerificarCuenta(n,"finiquito"):(S.obtenerHistorialGestionesVacacion(n,!1,!0),S.abrirDialogBeneficiosSociales(n,e.beneficio)):ce(n.id_ficha).then(function(a){var e=new Date;if(0<a.length)if(a[a.length-1].gestion<e.getFullYear()){var o=a[a.length-1].anio+1,i=0,t=e.getFullYear();o<=5?i=S.configuracionesVacacion[0].dias:o<=10?i=S.configuracionesVacacion[1].dias:10<o&&(i=S.configuracionesVacacion[2].dias);var r={gestion:t,anio:o,aplicadas:i,tomadas:0};ue(n.id_ficha,r).then(function(e){S.obtenerHistorialGestionesVacacion(n,!1,!0),S.abrirDialogBeneficiosSociales(n,a.beneficio)})}else S.obtenerHistorialGestionesVacacion(n,!1,!0),S.abrirDialogBeneficiosSociales(n,a.beneficio);else S.mostrarMensaje("No cuenta con ficha del empleado actualizada, actualizar ficha empleado")})})},S.cerrarDialogBeneficiosSociales=function(){S.cerrarPopup(S.idModalBeneficiosSociales)},S.abrirDialogDetalleVacaciones=function(){S.abrirPopup(S.idModalDetalleVacaciones)},S.cerrarDialogDetalleVacaciones=function(){S.cerrarPopup(S.idModalDetalleVacaciones)},S.abrirDialogBitacoraFicha=function(){ge(S.ficha.id).then(function(e){S.bitacoraCambios=e,S.abrirPopup(S.idModalBitacoraFicha)})},S.cerrarDialogBitacoraFicha=function(){S.cerrarPopup(S.idModalBitacoraFicha)},S.abrirDialogAnticipoExtraordinario=function(e){e.activo&&((S.empleado=e).haber_basico?(S.obtenerAnticiposExtra(e),S.abrirPopup(S.idModalAnticipoExtraordinario)):y(function(){S.$apply(function(){S.mostrarMensaje("No cuenta con haber basico actualizar ficha empleado!")})},200))},S.obtenerAnticiposExtra=function(e){var a=(new Date).getMonth();S.mesActual=a;var o=String((new Date).getFullYear());new Date;S.listaAnticipos=[],S.filtroAnticipo={mes:{id:a},gestion:o};var i=new Date,t={inicio:new Date(i.getFullYear(),i.getMonth(),1),fin:new Date(i.getFullYear(),i.getMonth()+1,0),nombre:"ORDI",id_empresa:0};S.anticipo_ordinaroOextra=0,S.obtenerListaAnticipos(t,e.id)},S.cerrarDialogAnticipoExtraordinario=function(){S.cerrarPopup(S.idModalAnticipoExtraordinario)},S.abrirDialogNuevoPrestamo=function(e){e.activo&&(S.empleado=e,S.prestamo={},e.haber_basico?S.abrirPopup(S.idModalNuevoPrestamo):y(function(){S.$apply(function(){S.mostrarMensaje("No cuenta con haber basico actualizar ficha empleado!")})},200))},S.cerrarDialogNuevoPrestamo=function(){S.cerrarPopup(S.idModalNuevoPrestamo)},S.abrirDialogAusenciasVacaciones=function(e){S.empleado=e,S.ausencia={primera_baja:!1},S.otraAusencia={},S.vacacion={sabado:!1,inicio_tipo:!1,fin_tipo:!1,aniosDisponibles:0,historial:null},S.feriados=[],S.listaFeriado(),S.obtenerHistorialGestionesVacacion(e,!0)},S.abriirmodelAusenciasVacas=function(n){n.activo&&(n.fecha_inicio?ce(n.id_ficha).then(function(e){var a=new Date;if(e[e.length-1].gestion<a.getFullYear()){var o=e[e.length-1].anio+1,i=0,t=a.getFullYear();o<=5?i=S.configuracionesVacacion[0].dias:o<=10?i=S.configuracionesVacacion[1].dias:10<o&&(i=S.configuracionesVacacion[2].dias);var r={gestion:t,anio:o,aplicadas:i,tomadas:0};ue(n.id_ficha,r).then(function(e){S.abrirDialogAusenciasVacaciones(n)})}else S.abrirDialogAusenciasVacaciones(n)}):y(function(){S.$apply(function(){S.mostrarMensaje("No cuenta con ficha actualmente, crear ficha empleado!")})},200))},S.cerrarDialogAusenciasVacaciones=function(){S.cerrarPopup(S.idModalAusenciasVacaciones)},S.abrirDialogTipoBaja=function(e){S.clase={},e.ausencias?S.tiposAusencia=e.ausencias:S.tipoAusencia=[],S.abrirPopup(S.idModalTipoBaja)},S.cerrarDialogTipoBaja=function(){S.cerrarPopup(S.idModalTipoBaja)},S.GuardarFeriadosCalendario=function(){var e=S.calendar.fullCalendar("clientEvents"),i=[];0<e.length?e.forEach(function(e,a,o){if(null==e.id){e={start:e.start._d,end:e.end._d};i.push(e)}a===o.length-1&&oe(S.usuario.id_empresa,i,S.feriadosEliminados).then(function(e){S.listaFeriado(),S.feriadosEliminados=[],S.cerrarDialogFeriados(),S.mostrarMensaje(e.mensaje)})}):oe(S.usuario.id_empresa,i,S.feriadosEliminados).then(function(e){S.listaFeriado(),S.feriadosEliminados=[],S.cerrarDialogFeriados(),S.mostrarMensaje(e.mensaje)})},S.agregarFeriado=function(e,a,o){S.calendar.fullCalendar("renderEvent",{title:"Feriado",start:e,end:a,allDay:o,className:"label-info"},!0),S.calendar.fullCalendar("unselect")},S.obtenerFechasCalendarioFeriado=function(){$("#calendar").fullCalendar("removeEvents");var t=[];S.FeriadosCalendario.forEach(function(e,a,o){var i={id:e.id,title:"Feriado",start:e.fecha_inicio,end:e.fecha_fin,className:"label-info"};t.push(i),a===o.length-1&&S.addEvents(t)},this)},S.listaFeriado=function(){S.ListaDiasFeriado=[],promesa=ie(S.usuario.id_empresa),promesa.then(function(e){e.forEach(function(e,a,o){var i=getDates(new Date(e.fecha_inicio),new Date(e.fecha_fin));S.ListaDiasFeriado.push.apply(S.ListaDiasFeriado,i)}),S.FeriadosCalendario=e})},S.addEvents=function(e){S.calendar.fullCalendar("addEventSource",e)},S.calendar=$("#calendar").fullCalendar({buttonHtml:{prev:'<i class="ace-icon fa fa-chevron-left"></i>',next:'<i class="ace-icon fa fa-chevron-right"></i>'},height:400,header:{left:"prev,next today",center:"title",right:"month,agendaWeek, agendaDay"},events:[],monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],monthNamesShort:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],dayNames:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],dayNamesShort:["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"],buttonText:{today:"hoy",month:"mes",week:"semana",day:"día",list:"lista"},editable:!0,selectable:!0,select:function(i,t,r){var e=S.calendar.fullCalendar("clientEvents"),n=!0;0<e.length?e.forEach(function(e,a,o){S.fechaATexto(e.start._d)==S.fechaATexto(i._d)&&(n=!1),a===o.length-1&&n&&S.agregarFeriado(i,t,r)}):S.agregarFeriado(i,t,r)},eventClick:function(a,e,o){if(null!=a.id){var i={id:a.id};S.feriadosEliminados.push(i),S.calendar.fullCalendar("removeEvents",function(e){return e._id==a._id})}else S.calendar.fullCalendar("removeEvents",function(e){return e._id==a._id})}}),S.abrirDialogFeriados=function(){S.abrirPopup(S.idModalFeriados),S.feriadosEliminados=[],$("#calendar").fullCalendar("render"),S.obtenerFechasCalendarioFeriado()},S.cerrarDialogFeriados=function(){S.cerrarPopup(S.idModalFeriados)},S.abrirDialogHitorialVacaciones=function(){S.obtenerHistorialEmpleadVacacion({}),S.abrirPopup(S.idModalHitorialVacaciones)},S.cerrarDialogHitorialVacaciones=function(){S.cerrarPopup(S.idModalHitorialVacaciones)};var Ue=new Date,ye=(Ue.getDate(),Ue.getMonth()),Ge=Ue.getFullYear();S.selectionday=[],S.totalHoras=moment("00:00","HH:mm"),S.calendarCompensacion=$("#calendar-compensacion").fullCalendar({buttonHtml:{prev:'<i class="ace-icon fa fa-chevron-left"></i>',next:'<i class="ace-icon fa fa-chevron-right"></i>'},height:400,defaultView:"agendaWeek",allDaySlot:!1,header:{left:"prev,next today",center:"title",right:"month,agendaWeek, agendaDay"},events:[{title:"Feriado",start:new Date(Ge,ye,1),className:"label-important"}],monthNames:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],monthNamesShort:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],dayNames:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],dayNamesShort:["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"],buttonText:{today:"hoy",month:"mes",week:"semana",day:"día",list:"lista"},editable:!0,selectable:!0,select:function(e,a){S.horas=moment.utc(moment(a,"DD/MM/YYYY HH:mm:ss").diff(moment(e,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm:ss"),S.Event=S.calendarCompensacion.fullCalendar("renderEvent",{start:e,end:a,className:"label-info"},!0),S.selectionday.push({_id:S.Event[0]._id,fecha_real:e,fecha:e.format("DD-MM-YYYY"),hora_inicio:e.format("HH:mm:ss"),hora_fin:a.format("HH:mm:ss"),total:S.horas}),S.sumarTotalHoras(),S.$apply(),S.calendarCompensacion.fullCalendar("unselect")},eventResize:function(e,a,o){var i=e.end,t=e.start,r=e._id;S.horas=moment.utc(moment(i,"DD/MM/YYYY HH:mm:ss").diff(moment(t,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm"),function(e,a){for(var o=0;o<S.selectionday.length;o++)if(S.selectionday[o]._id==e){S.selectionday[o].hora_fin=a,S.selectionday[o].total=S.horas;break}}(r,i.format("HH:mm")),S.sumarTotalHoras(),S.$apply()},eventDrop:function(e,a,o){var i=e.start,t=e.end;S.horas=moment.utc(moment(t,"DD/MM/YYYY HH:mm:ss").diff(moment(i,"DD/MM/YYYY HH:mm:ss"))).format("HH:mm"),function(e,a,o){for(var i=0;i<S.selectionday.length;i++)if(S.selectionday[i]._id==e){S.selectionday[i].fecha=a.format("DD-MM-YYYY"),S.selectionday[i].hora_inicio=a.format("HH:mm"),S.selectionday[i].hora_fin=o.format("HH:mm"),S.selectionday[i].total=S.horas;break}}(e._id,i,t),S.sumarTotalHoras(),S.$apply()},eventClick:function(a,e,o){var i='<div class="modal fade modal-delete">\t\t\t  <div class="modal-dialog">\t\t\t   <div class="modal-content">\t\t\t\t <div class="modal-body">\t\t\t\t   <button type="button" class="close" data-dismiss="modal" style="margin-top:-10px;">&times;</button>\t\t\t\t   <form class="no-margin">\t\t\t\t\t  <label> Eliminar '+a.title+' &nbsp;</label>\t\t\t\t   </form>\t\t\t\t </div>\t\t\t\t <div class="modal-footer">\t\t\t\t\t<button type="button" class="btn btn-sm btn-danger" data-action="delete"><i class="ace-icon fa fa-trash-o"></i>Eliminar</button>\t\t\t\t\t<button type="button" class="btn btn-sm" data-dismiss="modal"><i class="ace-icon fa fa-times"></i> Cancel</button>\t\t\t\t </div>\t\t\t  </div>\t\t\t </div>\t\t\t</div>';(i=$(i).appendTo("body")).find("button[data-action=delete]").on("click",function(){S.calendarCompensacion.fullCalendar("removeEvents",function(e){return e._id==a._id}),S.selectionday.splice(a._id,1),S.$apply(),i.modal("hide")}),i.modal("show").on("hidden",function(){i.remove()})}}),S.sumarTotalHoras=function(){for(var e="",a=0,o=0,i=0;i<S.selectionday.length;i++){var t=S.selectionday[i].total.split(":")[1],r=S.selectionday[i].total.split(":")[0];a+=parseInt(r),60<=(o+=parseInt(t))&&(o-=60,a+=1),e=String("0"+a).slice(-2)+":"+String("0"+o).slice(-2)+":00"}S.SumaTotalHoras=e},S.abrirDialogCompensacion=function(){S.abrirPopup(S.idModalCompensacion),$("#calendar-compensacion").fullCalendar("render")},S.cerrarDialogCompensacion=function(){S.cerrarPopup(S.idModalCompensacion)},S.abrirDialogHistorialAusencias=function(){S.filtroOtrasAusencias={},S.obtenerHistorialEmpleadoOtrasAusencias({inicio:0,fin:0,tipo_ausencia:0}),S.abrirPopup(S.idModalHistorialAusencias)},S.cerrarDialogHistorialAusencias=function(){S.cerrarPopup(S.idModalHistorialAusencias)},S.abrirDialogHistorialAusenciaMedica=function(){S.filtroAusencias={},S.obtenerHistorialEmpleadoAusenciasMedicas({inicio:0,fin:0,tipo_ausencia:0}),S.abrirPopup(S.idModalHistorialAusenciaMedica)},S.cerrarDialogHistorialAusenciaMedica=function(){S.cerrarPopup(S.idModalHistorialAusenciaMedica)},S.abrirDialogTipoAusencia=function(e){S.tiposOtras=e.ausencias,S.clase={},S.abrirPopup(S.idModalTipoAusencia)},S.cerrarDialogTipoAusencia=function(){S.cerrarPopup(S.idModalTipoAusencia)},S.abrirDialogRolTurnos=function(i){if(i.activo)if(S.obtenerlistaRolTurno(i.id_ficha),i.fecha_inicio){S.empleado=i;var t={};S.centrosDeCostos.forEach(function(e,a,o){e.nombre==i.campamento&&(t=e),a===o.length-1&&(S.rolTurno={campo:t,tipo:!1,fecha_fin:"",dias_trabajo:null,dias_descanso:null,grupo:"",id_ficha:null},S.abrirPopup(S.idModalRolTurnos))})}else y(function(){S.$apply(function(){S.mostrarMensaje("No cuenta con ficha actualmente, crear ficha empleado!")})},200)},S.cerrarDialogRolTurnos=function(){S.cerrarPopup(S.idModalRolTurnos)},S.abrirDialogHistorialTurnos=function(e){S.obtenerlistaRolTurno(e.id_ficha),S.abrirPopup(S.idModalHistorialTurnos)},S.cerrarDialogHistorialTurnos=function(){S.cerrarPopup(S.idModalHistorialTurnos)},S.abrirDialogHorasExtras=function(e){if(e.activo)if(e.fecha_inicio){S.empleado=e;var a=new Date;S.horaExtra={fecha:S.fechaATexto(a)},S.abrirPopup(S.idModalHorasExtras)}else y(function(){S.$apply(function(){S.mostrarMensaje("No cuenta con ficha actualmente, crear ficha empleado!")})},200)},S.cerrarDialogHorasExtras=function(){S.cerrarPopup(S.idModalHorasExtras)},S.abrirDialogHistorialHorasExtras=function(){S.obtenerHistorialHorasExtra({inicio:"",fin:""}),S.abrirPopup(S.idModalHistorialHorasExtras)},S.cerrarDialogHistorialHorasExtras=function(){S.cerrarPopup(S.idModalHistorialHorasExtras)},S.abrirDialogAnticipoRegular=function(){S.obteneranticiposOrdi(),S.dynamicPopovertr3={templateUrl:"myPopoverTr3.html"},S.obtenerDepartamentos(),S.abrirPopup(S.idModalAnticipoRegular)},S.obteneranticiposOrdi=function(){var r=(new Date).getMonth(),n=String((new Date).getFullYear());new Date;S.listaAnticipos=[],S.meses.forEach(function(e,a,o){if(e.id==r&&(r=e),a===o.length-1){S.filtroAnticipo={mes:r,gestion:n};var i=new Date,t={inicio:new Date(i.getFullYear(),i.getMonth(),1),fin:new Date(i.getFullYear(),i.getMonth()+1,0),nombre:"EXTRAORDI",id_empresa:S.usuario.id_empresa};S.anticipo_extraordinaro=0,S.obtenerListaAnticiposOrdi(t,0)}})},S.cerrarDialogAnticipoRegular=function(){S.listaAnticipos2=[],S.cerrarPopup(S.idModalAnticipoRegular)},S.abrirDialogPrestamosPersonal=function(){S.obtenerPrestamos(),S.abrirPopup(S.idModalPrestamosPersonal)},S.optenerListaPrestamos=function(){O(S.paginator).then(function(t){S.paginator.setPages(t.paginas),0<t.prestamos.length?t.prestamos.forEach(function(e,a,o){var i=S.fechaATexto(e.fecha_inicial);e.fecha_vence=editar_fecha(i,e.plazo,"m","/"),e.saldo=e.monto,e.pago=0,S.prestamos={total_montos:0,pagos_acuenta:0,saldo:0},a===o.length-1&&t.prestamos.forEach(function(e,a,o){0<e.prestamoPagos.length?(e.prestamoPagos[e.prestamoPagos.length-1].saldo_anterior==e.total&&(e.pagadoTotal=!0),e.pagadoTotal=!1,S.prestamos.total_montos+=e.monto,S.prestamos.pagos_acuenta+=e.prestamoPagos[e.prestamoPagos.length-1].a_cuenta_anterior,S.prestamos.saldo+=e.total-e.prestamoPagos[e.prestamoPagos.length-1].a_cuenta_anterior):(e.pagadoTotal=!1,S.prestamos.total_montos+=e.monto,S.prestamos.pagos_acuenta+=0,S.prestamos.saldo+=e.total),a===o.length-1&&(S.listaPrestamos=t.prestamos)}),e.montoEdit=!1}):(S.listaPrestamos={},S.prestamos={})})},S.copiarCodigodeCi=function(e){e.activoCopiaCodigo?e.codigo=e.persona.ci:e.codigo=""},S.obtenerPrestamos=function(){E.start(),S.paginator=s(),S.paginator.column="id",S.paginator.direccion="asc",S.filtro={empresa:S.usuario.id_empresa,plazo:"",inicio:"",fin:"",nombre:"",apellido:"",cuentas_liquidas:!1},S.paginator.callBack=S.optenerListaPrestamos,S.paginator.getSearch("",S.filtro,null),E.stop()},S.borrarFechas=function(e){e.fin="",e.inicio="",S.paginator.getSearch("",S.filtro,null)},S.cerrarDialogPrestamosPersonal=function(){S.cerrarPopup(S.idModalPrestamosPersonal)},S.abrirDialogNuevoAnticipoRegularTodos=function(){S.listaAnticipos2=[],S.cerrarDialogAdvertencia(),S.obtenerListaEmpleados(),S.abrirPopup(S.idModalNuevoAnticipoRegularTodos)},S.cerrarDialogNuevoAnticipoRegularTodos=function(){S.cerrarPopup(S.idModalNuevoAnticipoRegularTodos)},S.abrirDialogAdvertencia=function(e){S.abrirModalAdvertencia=e,S.abrirPopup(S.idModalAdvertencia)},S.abrirDialogAdvertenciaPrestamo=function(){S.mensajeAdvertencia={texto1:"Los prestamos y las condiciones se realizarán para todos los trabajadores seleccionados.",texto2:"Para prestamos personalizados use la opción directamente en la fila del empleado."},S.abrirDialogAdvertencia(S.abrirDialogPretamosNuevoTodos)},S.abrirDialogAdvertenciaAnticipo=function(){S.anticipo={tipo:!1,tope:null,monto:null},S.mensajeAdvertencia={texto1:"Los anticipos y las condiciones se realizarán para todos los trabajadores seleccionados.",texto2:"Para anticipos personalizados use la opción directamente en la fila del empleado."},S.abrirDialogAdvertencia(S.abrirDialogNuevoAnticipoRegularTodos)},S.cerrarDialogAdvertencia=function(){S.cerrarPopup(S.idModalAdvertencia)},S.abrirDialogPretamosNuevoTodos=function(){S.cerrarDialogAdvertencia(),S.obtenerListaEmpleados(),S.abrirPopup(S.idModalPretamosNuevoTodos)},S.cerrarDialogPretamosNuevoTodos=function(){S.cerrarPopup(S.idModalPretamosNuevoTodos)},S.abrirDialogReporteHijos=function(){S.abrirPopup(S.idModalReporteHijos)},S.cerrarDialogReporteHijos=function(){S.cerrarPopup(S.idModalReporteHijos)},S.abrirDialogReporteVeneficios=function(){S.obtenerbeneficiosSocialesEmpresa(),S.empleado=void 0,S.abrirPopup(S.idModalReporteVeneficios)},S.cerrarDialogReporteVeneficios=function(){S.obtenerRecursosHumanos(),S.cerrarPopup(S.idModalReporteVeneficios)},S.abrirDialogPagoPrestamo=function(e){S.prestamo=e;var a=new Date;0<S.prestamo.prestamoPagos.length&&(e.saldo=S.prestamo.prestamoPagos[e.prestamoPagos.length-1].saldo_anterior,e.total=e.monto*e.interes_pactado/100+e.monto);var o=new Date(S.convertirFecha(e.fecha_vence)),i=moment(a).format("YYYY-MM-DD HH:mm:ss"),t=moment(o).format("YYYY-MM-DD HH:mm:ss"),r=moment(i,"YYYY-MM-DD HH:mm:ss"),n=moment(t,"YYYY-MM-DD HH:mm:ss");S.prestamo.plazo_restante=Math.round(n.diff(r,"months",!0)),S.abrirPopup(S.idModalPagoPrestamo)},S.cerrarDialogPagoPrestamo=function(){S.cerrarPopup(S.idModalPagoPrestamo)},S.abrirDialogReporteVacaciones=function(){S.filtroVacacion={},S.obtenerHistorialEmpresaVacacion(S.filtroVacacion),S.abrirPopup(S.idModalReporteVacaciones)},S.cerrarDialogReporteVacaciones=function(){S.cerrarPopup(S.idModalReporteVacaciones)},S.abrirDialogReporteBajasMedicas=function(){S.filtroAusencias={},S.obtenerHistorialEmpresaAusenciasMedicas({inicio:0,fin:0,tipo_ausencia:0}),S.abrirPopup(S.idModalReporteBajasMedicas)},S.cerrarDialogReporteBajasMedicas=function(){S.cerrarPopup(S.idModalReporteBajasMedicas)},S.abrirDialogReporteRolTurnos=function(){S.paginator=s(),S.paginator.column="id",S.paginator.direccion="asc",S.filtroRol={empresa:S.usuario.id_empresa,inicio:"",fin:"",grupo:"",campo:""},S.paginator.callBack=S.obtenerlistaRolTurnoEmpresa,S.paginator.getSearch("",S.filtroRol,null),S.abrirPopup(S.idModalReporteRolTurnos)},S.cerrarDialogReporteRolTurnos=function(){S.cerrarPopup(S.idModalReporteRolTurnos)},S.abrirDialogReporteTurnosDetallado=function(){S.obtenerlistaRolTurnoCal(),S.abrirPopup(S.idModalReporteTurnosDetallado)},S.cambiarFecha=function(e){},S.formatofecha=function(e){var a=e.split("/");return a[2]+"/"+a[1]+"/"+a[0]},S.cerrarDialogReporteTurnosDetallado=function(){S.obtenerRecursosHumanos(),S.cerrarPopup(S.idModalReporteTurnosDetallado)},S.abrirDialogViajes=function(){S.viaje={empleadosEntrada:[],empleadosSalida:[]},S.obtenerlistaRolTurno(0),S.obtenerChoferesViaje(),S.abrirPopup(S.idModalViajes)},S.cerrarDialogViajes=function(){S.cerrarPopup(S.idModalViajes)},S.abrirDialogVisita=function(){S.visita={persona:{nombres:"",apellido_paterno:"",apellido_materno:"",ci:null,expedido:null},visita:!0,estado:{}};for(var e=0;e<S.tiposPasajerosViaje.length;e++){var a=S.tiposPasajerosViaje[e];"VISITA"==a.nombre&&(S.visita.estado=a)}S.abrirPopup(S.idModalVisita)},S.cerrarDialogVisita=function(){S.cerrarPopup(S.idModalVisita)},S.abrirDialogVisitaSalida=function(){S.visita={persona:{nombres:"",apellido_paterno:"",apellido_materno:"",ci:null,expedido:null},visita:!0,estado:{}};for(var e=0;e<S.tiposPasajerosViaje.length;e++){var a=S.tiposPasajerosViaje[e];"VISITA"==a.nombre&&(S.visita.estado=a)}S.abrirPopup(S.idModalVisitaSalida)},S.cerrarDialogVisitaSalida=function(){S.cerrarPopup(S.idModalVisitaSalida)},S.eliminarPopup,S.agregarvisitaEntrada=function(i){S.tiposViaje.clases.forEach(function(e,a,o){"INGRESO"==e.nombre&&(i.tipoViaje=e),a==o.length-1&&(i.persona.nombre_completo=i.persona.nombres,""!=i.persona.apellido_paterno&&(i.persona.nombre_completo+=" "+i.persona.nombre_completo),""!=i.persona.apellido_materno&&(i.persona.nombre_completo+=" "+i.persona.apellido_materno),i.habilitado=!0,i.esVisita=!0,S.viaje.empleadosEntrada.push(i))}),scope.cerrarDialogVisita()},S.agregarvisitaSalida=function(i){S.tiposViaje.clases.forEach(function(e,a,o){"SALIDA"==e.nombre&&(i.tipoViaje=e),a==o.length-1&&(i.persona.nombre_completo=i.persona.nombres,""!=i.persona.apellido_paterno&&(i.persona.nombre_completo+=" "+i.persona.nombre_completo),""!=i.persona.apellido_materno&&(i.persona.nombre_completo+=" "+i.persona.apellido_materno),i.habilitado=!0,i.esVisita=!0,S.viaje.empleadosSalida.push(i))}),S.cerrarDialogVisitaSalida()},S.abrirDialogVehiculosViaje=function(e){S.clase={habilitado:!0},S.tipo_edicion=e,S.abrirPopup(S.idModalVehiculosViaje)},S.agregarVehiculo=function(e){e.nombre=e.vehiculo+"-"+e.placa,e.nombre&&e.nombre_corto&&(-1==S.tipo_edicion.clases.indexOf(e)&&S.tipo_edicion.clases.push(e),S.clase={habilitado:!0})},S.cerrarDialogVehiculosViaje=function(){S.cerrarPopup(S.idModalVehiculosViaje)},S.abrirDialogHistorialViajes=function(){S.obtenerViajesPasajeros(),S.VerViajes=!1,S.abrirPopup(S.idModalHistorialViajes)},S.verBusesViaje=function(){S.obtenerViajes(),S.VerViajes=!0,setTimeout(function(){aplicarDatePickers()},400)},S.verPasajerosViajes=function(){S.obtenerViajesPasajeros(),S.VerViajes=!1,setTimeout(function(){aplicarDatePickers()},400)},S.cerrarDialogHistorialViajes=function(){S.obtenerRecursosHumanos(),S.cerrarPopup(S.idModalHistorialViajes)},S.abrirDialogReporteAusencias=function(){S.filtroOtrasAusencias={},S.obtenerHistorialEmpresaOtrasAusencias({inicio:0,fin:0,tipo_ausencia:0}),S.abrirPopup(S.idModalReporteAusencias)},S.cerrarDialogReporteAusencias=function(){S.cerrarPopup(S.idModalReporteAusencias)},S.abrirDialogCertificado=function(){S.abrirPopup(S.idModalCertificado)},S.cerrarDialogCertificado=function(){S.cerrarPopup(S.idModalCertificado)},S.button_clicked=!1,S.disableImput=function(e){S.button_clicked=!e},S.obtenerGenero=function(){E.start(),S.generos=[],t().then(function(e){e.forEach(function(e){S.generos.push(e)},this),E.stop()})},S.abrirDialogPrerequisitoEditar=function(e){S.NuevoP=new m({id:e.id,nombre:e.nombre,observacion:e.observacion,vencimiento_mes:e.vencimiento_mes,dias_activacion:e.dias_activacion,puede_modificar_rrhh:e.puede_modificar_rrhh}),S.abrirPopup(S.idModalDialogPrerequisitoNuevo)},S.cerrarPopupPrerequisitoNuevo=function(){S.obtenerAlertas(),S.cerrarPopup(S.idModalDialogPrerequisitoNuevo)},S.saveForm=function(){S.nuevoRH.imagen;S.nuevoRH.fechaFicha=new Date,"Siguiente"!=$("#siguiente").text().trim()&&(E.start(),S.nuevoRH.id?(S.nuevoRH.persona.fecha_nacimiento=new Date(S.convertirFecha(S.nuevoRH.persona.fecha_nacimiento)),r.update({id_usuario:S.nuevoRH.id},S.nuevoRH,function(e){E.stop(),S.cerrarDialogRhNuevo(),S.mostrarMensaje("Actualizado Exitosamente!"),S.recargarItemsTabla()})):(S.nuevoRH.persona.fecha_nacimiento=new Date(S.convertirFecha(S.nuevoRH.persona.fecha_nacimiento)),S.nuevoRH.$save({id_usuario:0},function(e){E.stop(),S.cerrarDialogRhNuevo(),S.mostrarMensaje("Guardado Exitosamente!"),S.recargarItemsTabla()},function(e){E.stop(),S.cerrarDialogRhNuevo(),S.mostrarMensaje("Ocurrio un problema al momento de guardar!"),S.recargarItemsTabla()})))},S.obtenerRecursosHumanos=function(){E.start(),S.paginator=s(),S.paginator.column="id",S.paginator.direccion="asc",S.dynamicPopoverCargos={templateUrl:"myPopoverTemplate.html"},S.filtro={empresa:S.usuario.id_empresa,codigo:"",nombres:"",ci:"",campo:"",cargo:"",busquedaEmpresa:"",estado:"",grupo_sanguineo:""},S.paginator.callBack=S.buscarRecursosHumanos,S.paginator.getSearch("",S.filtro,null),E.stop()},S.buscarRecursosHumanos=function(a,e,o,i){E.start(),n(S.paginator).then(function(e){S.paginator.setPages(e.paginas),S.RecursosHumanosEmpleados=e.pacientes,S.RecursosHumanosEmpleados.forEach(function(e){e.activo=0==e.activo}),a&&o&&S.RecursosHumanosEmpleados.forEach(function(e,a,o){0==i?(e.select=!1,S.empleadosSeleccionados=[]):(e.select=!0,S.empleadosSeleccionados.push(e))}),E.stop()})},S.subirExcelPacientes=function(e){E.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={personaReferencia:{}};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.apellido_paterno=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.apellido_materno=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.nombres=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.segundo_nombre=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.ci=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.extension=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.contrato=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,s.fecha_nacimiento=null!=r["I"+t]&&""!=r["I"+t]?S.fecha_excel_angular(r["I"+t].v.toString()):null,s.genero=null!=r["J"+t]&&""!=r["J"+t]?r["J"+t].v.toString():null,s.telefono=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,s.telefono2=null!=r["L"+t]&&""!=r["L"+t]?r["L"+t].v.toString():null,s.telefono_movil=null!=r["M"+t]&&""!=r["M"+t]?r["M"+t].v.toString():null,s.estilo_de_vida=null!=r["N"+t]&&""!=r["N"+t]?r["N"+t].v.toString():null,s.cargo=null!=r["O"+t]&&""!=r["O"+t]?r["O"+t].v.toString():null,s.designacion_empresa=null!=r["P"+t]&&""!=r["P"+t]?r["P"+t].v.toString():null,s.telefono_empresa=null!=r["Q"+t]&&""!=r["Q"+t]?r["Q"+t].v.toString():null,s.campamento=null!=r["R"+t]&&""!=r["R"+t]?r["R"+t].v.toString():null,s.riesgos_procesos_trabajo=null!=r["S"+t]&&""!=r["S"+t]?r["S"+t].v.toString():null,s.personaReferencia.ciudad_referencia=null!=r["T"+t]&&""!=r["T"+t]?r["T"+t].v.toString():null,s.personaReferencia.zona_referencia=null!=r["U"+t]&&""!=r["U"+t]?r["U"+t].v.toString():null,s.personaReferencia.calle_av_referencia=null!=r["V"+t]&&""!=r["V"+t]?r["V"+t].v.toString():null,s.personaReferencia.nro_referencia=null!=r["W"+t]&&""!=r["W"+t]?r["W"+t].v.toString():null,s.personaReferencia.telefonos_referencia=null!=r["X"+t]&&""!=r["X"+t]?r["X"+t].v.toString():null,s.personaReferencia.celular_referencia=null!=r["Y"+t]&&""!=r["Y"+t]?r["Y"+t].v.toString():null,s.personaReferencia.nombre_referencia=null!=r["Z"+t]&&""!=r["Z"+t]?r["Z"+t].v.toString():null,s.fecha_inicio=null!=r["AA"+t]&&""!=r["AA"+t]?S.fecha_excel_angular(r["AA"+t].v.toString()):null,s.haber_basico=null!=r["AB"+t]&&""!=r["AB"+t]?parseFloat(r["AB"+t].v.toString()):null,s.matricula_seguro=null!=r["AC"+t]&&""!=r["AC"+t]?r["AC"+t].v.toString():null,s.seguro_salud=null!=r["AD"+t]&&""!=r["AD"+t]?r["AD"+t].v.toString():null,s.estadoTexto=null!=r["AE"+t]&&""!=r["AE"+t]?r["AE"+t].v.toString():null,s.estado="Activo"!==s.estadoTexto,s.fecha_expiracion=null!=r["AF"+t]&&""!=r["AF"+t]?S.fecha_excel_angular(r["AF"+t].v.toString()):null,s.imagen="img/icon-user-default.png",s.es_empleado=!0;var c=new Date(s.fecha_inicio);s.historialVacacion=[];var l=c.getFullYear();S.obtenerAnios(l).forEach(function(e,a,o){var i=a+1,t=null;i<=5?t=S.configuracionesVacacion[0].dias:i<=10?t=S.configuracionesVacacion[1].dias:10<i&&(t=S.configuracionesVacacion[2].dias);var r={gestion:e,anio:a+1,aplicadas:t,tomadas:0};s.historialVacacion.push(r)}),n.push(s),t++,0}while(null!=r["A"+t]);S.GuardarEmpleadosRh(n)},t.readAsBinaryString(o)}},S.subirExcelFichaEmpleados=function(e){E.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],g=[];do{var n={seguros:[]};n.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,n.apellido_paterno=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,n.apellido_materno=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,n.nombres=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,n.segundo_nombre=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,n.estado_civil=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,n.nacionalidad=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,n.departamento=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,n.provincia=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,n.localidad=null!=r["J"+t]&&""!=r["J"+t]?S.fecha_excel_angular(r["J"+t].v.toString()):null,n.tipo_personal=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,n.carga_horario=null!=r["L"+t]&&""!=r["L"+t]?r["L"+t].v.toString():null,n.area=null!=r["M"+t]&&""!=r["M"+t]?r["M"+t].v.toString():null,n.ubicacion=null!=r["N"+t]&&""!=r["N"+t]?r["N"+t].v.toString():null,n.lugar_seguro=null!=r["O"+t]&&""!=r["O"+t]?r["O"+t].v.toString():null,n.nua_cua=null!=r["P"+t]&&""!=r["P"+t]?r["P"+t].v.toString():null,n.afp_aporte=null!=r["Q"+t]&&""!=r["Q"+t]?r["Q"+t].v.toString():null,n.lugar_afp=null!=r["R"+t]&&""!=r["R"+t]?r["R"+t].v.toString():null,n.seguro1=null!=r["S"+t]&&""!=r["S"+t]?r["S"+t].v.toString():null,n.monto1=null!=r["T"+t]&&""!=r["T"+t]?parseFloat(r["T"+t].v.toString()):null,n.observacion1=null!=r["U"+t]&&""!=r["U"+t]?r["U"+t].v.toString():null,n.seguro2=null!=r["V"+t]&&""!=r["V"+t]?r["V"+t].v.toString():null,n.monto2=null!=r["W"+t]&&""!=r["W"+t]?parseFloat(r["W"+t].v.toString()):null,n.observacion2=null!=r["X"+t]&&""!=r["X"+t]?r["X"+t].v.toString():null,g.push(n),t++,0}while(null!=r["A"+t]);var v=[],h=[],b=[],C=[],P=[],_=[],M=[],D=[],E=[],x=[];g.forEach(function(e,a,o){var i=!1;if(0<v.length){for(var t=0;t<v.length;t++){var r=v[t];null!=e.afp_aporte&&r==e.afp_aporte&&(i=!0)}i||v.push(e.afp_aporte)}else v.push(e.afp_aporte);var n=!1;if(0<h.length){for(t=0;t<h.length;t++){r=h[t];null!=e.lugar_afp&&r==e.lugar_afp&&(n=!0)}n||h.push(e.lugar_afp)}else h.push(e.lugar_afp);var s=!1;if(0<b.length){for(t=0;t<b.length;t++){r=b[t];null!=e.lugar_seguro&&r==e.lugar_seguro&&(s=!0)}s||b.push(e.lugar_seguro)}else b.push(e.lugar_seguro);var c=!1;if(0<C.length){for(t=0;t<C.length;t++){r=C[t];null!=e.tipo_personal&&r==e.tipo_personal&&(c=!0)}c||C.push(e.tipo_personal)}else C.push(e.tipo_personal);var l=!1;if(0<P.length){for(t=0;t<P.length;t++){r=P[t];null!=e.carga_horario&&r==e.carga_horario&&(l=!0)}l||P.push(e.carga_horario)}else P.push(e.carga_horario);var d=!1;if(0<_.length){for(t=0;t<_.length;t++){r=_[t];null!=e.area&&r==e.area&&(d=!0)}d||_.push(e.area)}else _.push(e.area);var u=!1;if(0<M.length){for(t=0;t<M.length;t++){r=M[t];null!=e.ubicacion&&r==e.ubicacion&&(u=!0)}u||M.push(e.ubicacion)}else M.push(e.ubicacion);var p=!1;if(0<D.length){for(t=0;t<D.length;t++){r=D[t];null!=e.estado_civil&&r==e.estado_civil&&(p=!0)}p||D.push(e.estado_civil)}else D.push(e.estado_civil);var m=!1;if(0<E.length){for(t=0;t<E.length;t++){r=E[t];null!=e.seguro1&&r==e.seguro1&&(m=!0)}m||E.push(e.seguro1)}else E.push(e.seguro1);var f=!1;if(0<x.length){for(t=0;t<x.length;t++){r=x[t];null!=e.seguro2&&r==e.seguro2&&(f=!0)}f||x.push(e.seguro2)}else x.push(e.seguro2);a===o.length-1&&S.guardarFichasEmpleados(g,v,h,b,C,P,_,M,D,E,x)})},t.readAsBinaryString(o)}},S.guardarFichasEmpleados=function(e,a,o,i,t,r,n,s,c,l,d){Le(e,S.usuario.id_empresa,a,o,i,t,r,n,s,c,l,d).then(function(e){S.recargarItemsTabla(),S.mostrarMensaje(e.mensaje),E.stop()})},S.subirExcelRTurnoEmpleados=function(e){E.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.tipo=null!=r["F"+t]&&""!=r["F"+t]?"Fijo"==r["F"+t].v.toString():null,s.campo=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.fecha_inicio=null!=r["H"+t]&&""!=r["H"+t]?S.fecha_excel_angular(r["H"+t].v.toString()):null,s.fecha_fin=null!=r["I"+t]&&""!=r["I"+t]?S.fecha_excel_angular(r["I"+t].v.toString()):null,s.grupo=null!=r["J"+t]&&""!=r["J"+t]?r["J"+t].v.toString():null,s.dias_trabajo=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,s.dias_descanso=null!=r["L"+t]&&""!=r["L"+t]?r["L"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);S.guardarRolTurnoEmpleados(n,S.tipoImportacionRol)},t.readAsBinaryString(o)}},S.actualizarImportacionRoles=function(){S.tipoImportacionRol=!0},S.importarNuevosRoles=function(){S.tipoImportacionRol=!1},S.guardarRolTurnoEmpleados=function(e,a){ke(e,S.usuario.id_empresa,a).then(function(e){S.mostrarMensaje(e.mensaje),S.cerrarDialogTipoImportacionRol(),E.stop()})},S.subirExcelFichaEmpleadoFamiliares=function(e){E.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigoEmpleado=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.genero=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.nombres=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.apellido_paterno=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.apellido_materno=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.fecha_nacimiento=null!=r["G"+t]&&""!=r["G"+t]?new Date(S.fecha_excel_angular(r["G"+t].v.toString())):null,s.relacion=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,s.referencia=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);S.GuardarFichasEmpleadosFamiliares(n)},t.readAsBinaryString(o)}},S.GuardarFichasEmpleadosFamiliares=function(t){var r=[];t.forEach(function(e,a,o){if(0<r.length){bandera=!0;for(var i=0;i<r.length;i++){r[i]===e.relacion&&(bandera=!1)}bandera&&r.push(e.relacion)}else r.push(e.relacion);a===o.length-1&&new we({id_empresa:S.usuario.id_empresa,familiares:t,relaciones:r}).$save(function(e){S.mostrarMensaje(e.mensaje),S.recargarItemsTabla(),E.stop()})})},S.subirExcelFicha=function(e){E.start();var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.banco=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.numero_cuenta=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);S.GuardarFichasEmpleadosRh(n)},t.readAsBinaryString(o)}},S.GuardarEmpleadosRh=function(e){new d({pacientes:e,id_empresa:S.usuario.id_empresa}).$save(function(e){S.mostrarMensaje(e.mensaje),S.recargarItemsTabla(),E.stop()})},S.GuardarFichasEmpleadosRh=function(r){var n=[];r.forEach(function(e,a,o){var i=!1;if(0<n.length){for(var t=0;t<n.length;t++){n[t]==e.banco&&(i=!0)}i||n.push(e.banco)}else n.push(e.banco);a===o.length-1&&new _e({pacientes:r,id_empresa:S.usuario.id_empresa,bancos:n}).$save(function(e){S.mostrarMensaje(e.mensaje),S.recargarItemsTabla(),E.stop()})})},S.modificarEmpleado=function(e){S.steps=[{cabeza:"cabeza-nuevo-datos-personales",cuerpo:"cuerpo-nuevo-datos-personales"},{cabeza:"cabeza-nuevo-datos-comple",cuerpo:"cuerpo-nuevo-datos-comple"},{cabeza:"cabeza-nuevo-datos-laborales",cuerpo:"cuerpo-nuevo-datos-laborales"}],promesaPaciente=p(e.id),promesaPaciente.then(function(e){null!=e.clase&&(e.medicoPaciente.tipo_contrato=e.clase),S.nuevoRH=e.medicoPaciente,S.nuevoRH.persona.fecha_nacimiento=S.fechaATexto(S.nuevoRH.persona.fecha_nacimiento),S.seleccionarCargos(S.nuevoRH.empleadosFichas[S.nuevoRH.empleadosFichas.length-1].cargos)}),S.abrirPopup(S.idModalRhNuevo)},S.validarCodigoCuentaEmpleado=function(e){""!=e&&y(function(){S.validar=new U,S.validar.codigo=e,S.validar.$save({id_empresa:S.usuario.id_empresa},function(e){S.data=e})},1500)},S.eliminarFamiliarRh=function(){x(S.familiar).then(function(e){S.ficha.empleado.familiares.splice(S.familiar.index,1),S.familiar=null,S.cerrarDialogEliminarFamiliarEmpleado(),S.mostrarMensaje(e.mensaje)})},S.eliminarOtroSeguroRh=function(a){D(a).then(function(e){S.ficha.otrosSeguros.splice(a.index,1),S.otroSeguro=null,S.cerrarDialogEliminarSeguroEmpleado(),S.mostrarMensaje(e.mensaje)})},S.finVerEmpleado=function(){"Siguiente"!=$("#siguiente-v").text().trim()&&S.cerrarDialogVerEmpleado()},S.obtenerDatosFichaUsuario=function(e,n){b(e.id).then(function(e){if(e.ficha){S.ficha=e.ficha,S.ficha.editDatosLaborales=!1,S.ficha.fecha_inicio?S.ficha.fecha_inicio2=S.fechaATexto(S.ficha.fecha_inicio):S.ficha.editDatosLaborales=!0,S.ficha.fecha_fin&&(S.ficha.fecha_fin2=S.fechaATexto(S.ficha.fecha_fin)),S.ficha.cargo=[],S.ficha.fecha_jubilacion=new Date(S.ficha.fecha_jubilacion),S.ficha.empleado.fecha_vence_documento=new Date(S.ficha.empleado.fecha_vence_documento),S.ficha.fecha_jubilacion=S.fechaATexto(S.ficha.fecha_jubilacion),S.ficha.empleado.fecha_vence_documento=S.fechaATexto(S.ficha.empleado.fecha_vence_documento),S.buscarDepartamento(e.ficha.empleado.persona.pais),S.buscarMunicipios(e.ficha.empleado.persona.ciudad),S.buscarLocalidad(e.ficha.empleado.persona.provincia);var a=new Date,o=new Date(S.ficha.empleado.persona.fecha_nacimiento);S.ficha.nac_anio=o.getFullYear(),S.ficha.nac_dia=o.getDate();var i=o.getMonth();if(S.meses.forEach(function(e,a,o){e.id==i&&(S.ficha.nac_mes=e,S.getDaysInMonth(S.ficha.nac_mes.id,S.ficha.nac_anio))}),S.ficha.fecha)var t=new Date(S.ficha.fecha);else t=new Date;S.ficha.fecha_elaboracion=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear();var r=S.diferenciaEntreDiasEnDias(o,a);S.ficha.edad=Math.trunc(r/365),S.ficha.empleado.familiares.forEach(function(e,a,o){var i=new Date,t=new Date(e.persona.fecha_nacimiento),r=S.diferenciaEntreDiasEnDias(t,i);e.edad=Math.trunc(r/365),e.eliminado=!1}),S.ficha.otrosSeguros.forEach(function(e,a,o){e.eliminado=!1}),S.seleccionarCargos(S.ficha.cargos),S.seleccionarDiscapacidades(S.ficha.discapacidades),n&&setTimeout(function(){S.ficha.editDatosLaborales=!0,S.ficha.fecha_inicio2=S.fechaATexto(new Date),$("#siguiente-f").click()},200)}E.stop()})},S.seleccionarCargos=function(e){for(var a=0;a<S.cargos.length;a++)for(var o=0;o<e.length;o++)S.cargos[a].id==e[o].id_cargo&&(S.cargos[a].ticked=!0)},S.llenarCargos=function(e){S.cargos=[];for(var a=0;a<e.length;a++){var o={nombre:e[a].nombre,maker:"",ticked:!1,id:e[a].id};S.cargos.push(o)}},S.seleccionarDiscapacidades=function(e){for(var a=0;a<S.discapacidades.length;a++)for(var o=0;o<e.length;o++)S.discapacidades[a].id==e[o].id_discapacidad&&(S.discapacidades[a].ticked=!0)},S.llenarDiscapacidades=function(e){S.discapacidades=[];for(var a=0;a<e.length;a++){var o={nombre:e[a].nombre,maker:"",ticked:!1,id:e[a].id};S.discapacidades.push(o)}},S.diferenciaEntreDiasEnDias=function(e,a){var o=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),i=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate());return Math.floor((i-o)/864e5)},S.obtenerDatosPrerequisito=function(e,a){E.start(),null!=a.inicio&&0!=a.inicio&&""!=a.inicio?S.filtro.inicio=a.inicio instanceof Date?a.inicio:new Date(S.convertirFecha(a.inicio)):S.filtro.inicio=0,null!=a.fin&&0!=a.fin&&""!=a.fin?S.filtro.fin=a.fin instanceof Date?a.fin:new Date(S.convertirFecha(a.fin)):S.filtro.fin=0,v(e.id,S.filtro).then(function(e){S.prerequisitosPaciente=e.Prerequisitos,S.prerequisitosPaciente.forEach(function(e){null!=e.fecha_entrega&&(e.entregado=!0)}),S.filtro.inicio=S.filtro.inicio instanceof Date?S.filtro.inicio.getDate()+"/"+(S.filtro.inicio.getMonth()+1)+"/"+S.filtro.inicio.getFullYear():"",S.filtro.fin=S.filtro.fin instanceof Date?S.filtro.fin.getDate()+"/"+(S.filtro.fin.getMonth()+1)+"/"+S.filtro.fin.getFullYear():"",E.stop()},function(e){S.mostrarMensaje("Se produjo un error al obtener datos de prerequisitos"),E.stop()})},S.saveFormPrerequisito=function(e){(E.start(),null!=e.nombre&&null!=e.vencimiento_mes)?$e(e).then(function(e){S.mostrarMensaje(e.mensaje),S.cerrarPopupPrerequisitoNuevo(),E.stop(),S.verificarAsignacionPrerequisitos()}).catch(function(e){E.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";S.mostrarMensaje(a)}):(S.mostrarMensaje("Los campos Prerequisito Nombre y vencimiento mes son requeridos."),E.stop())},S.verificarAsignacionPrerequisitos=function(){E.start(),g().then(function(e){S.preRequisitos=e.prerequisitos,filtro={inicio:0,fin:0},v(S.empleado.id,filtro).then(function(e){S.prerequisitosPaciente=e.Prerequisitos,S.preRequisitos.forEach(function(a,e,o){S.prerequisitosPaciente.forEach(function(e){a.id==e.id_prerequisito&&(a.asignado=!0),null!=e.fecha_entrega&&(e.entregado=!0)}),0==S.prerequisitosPaciente.length&&(a.asignado=!1),e==o.length-1&&E.stop()}),0==S.preRequisitos.length&&E.stop()})})},S.diasVencidosPrerequisito=function(e){var a=(new Date).getTime()-e.getTime();return Math.floor(a/864e5)},S.calcularFechaVencimientoRequisito=function(e){var a=void 0===e.vencimiento_mes?e.preRequisito.vencimiento_mes:e.vencimiento_mes,o=(new Date,new Date);if(void 0===e.fecha_inicio_texto)var i=S.fechaATexto(e.fecha_inicio);var t=void 0===e.fecha_inicio_texto?i.split("/"):e.fecha_inicio_texto.split("/"),r=parseInt(t[0]),n=parseInt(t[1]),s=parseInt(t[2]);return o.setFullYear(s,n-1,r),new Date(o.setTime(o.getTime()+30*a*864e5))},S.actualizarPreRequisitoPaciente=function(e){E.start();var a=e;a.fecha_vencimiento=new Date(S.convertirFecha(a.fecha_vencimiento_texto)),a.fecha_inicio=new Date,a.fecha_entrega=null,a.asignado=!0,A.save(a,function(e){S.mostrarMensaje(e.mensaje),S.cerrarDialogEditarPreRequisito(),S.verificarAsignacionPrerequisitos(),E.stop()},function(e){S.mostrarMensaje("Ocurrio un problema al asignar el prerequisito"),S.cerrarDialogEditarPreRequisito(),E.stop()})},S.asignarPrerequisito=function(e,a){E.start(),e.pacientePrerequisito={id:a.id},e.preRequisito={id:e.id},e.fecha_inicio=new Date,e.fecha_inicio_texto=S.fechaATexto(e.fecha_inicio),e.fecha_vencimiento=S.calcularFechaVencimientoRequisito(e),e.paraAsignar=!0,A.save(e,function(e){S.verificarAsignacionPrerequisitos(),S.mostrarMensaje(e.mensaje),E.stop()},function(e){S.mostrarMensaje("Ocurrio un problema al asignar el prerequisito"),E.stop()})},S.obtenerPrerequisito=function(){E.start(),f().then(function(e){S.prerequisitos=e,E.stop()})},S.agregarSeguro=function(e){e.eliminado=!1,S.ficha.otrosSeguros.push(e),S.seguro={edit:!1}},S.calcularEdad=function(e){var a=new Date;if(e.nac_mes&&e.nac_anio&&e.nac_dia){var o=e.nac_anio,i=parseInt(e.nac_mes.id),t=parseInt(e.nac_dia),r=new Date;r.setFullYear(o,i,t);var n=S.diferenciaEntreDiasEnDias(r,a);e.edad=Math.trunc(n/365)}},S.eliminarSeguro=function(e,a){e.id?e.eliminado=!0:S.ficha.otrosSeguros.splice(a,1)},S.editarSeguro=function(e,a){S.seguro=e,S.seguro.edit=!0,S.seguro.index=a},S.agregarFamiliar=function(e){e.eliminado=!1,parseInt(e.nac_mes.id)<10&&(e.nac_mes.id="0"+e.nac_mes.id),e.persona.fecha_nacimiento=new Date(e.nac_anio,parseInt(e.nac_mes.id),parseInt(e.nac_dia)),S.ficha.empleado.familiares.push(e),S.familiar={edit:!1}},S.eliminarFamiliar=function(e,a){e.id?e.eliminado=!0:S.ficha.empleado.familiares.splice(a,1)},S.editarFamiliar=function(e,a){S.familiar=e;var o=new Date(e.persona.fecha_nacimiento);S.familiar.nac_anio=o.getFullYear(),S.familiar.nac_dia=o.getDate();var i=o.getMonth();S.meses.forEach(function(e,a,o){e.id==i&&(S.familiar.nac_mes=e)}),S.familiar.edit=!0,S.familiar.index=a,S.abrirDialogNuevoFamiliar()},S.guardarSeguroEditado=function(e){S.ficha.otrosSeguros[e.index]=e,S.seguro={edit:!1}},S.guardarFamiliarEditado=function(e){S.ficha.empleado.familiares[e.index].persona.fecha_nacimiento=new Date(e.nac_anio,parseInt(e.nac_mes.id),parseInt(e.nac_dia)),S.ficha.empleado.familiares[e.index]=e,S.familiar={edit:!1},S.cerrarDialogNuevoFamiliar()},S.recuperarDatosTipo=function(){S.obtenerExpeditos(),S.obtenerTipoExpeditos(),S.obtenerEstadoCivil(),S.obtenerNacionalidades(),S.obtenerTiposContratos(),S.obtenerTiposPersonales(),S.obtenerCargasHorarios(),S.obtenerAreas(),S.obtenerUbicacion(),S.obtenerSegurosSalud(),S.obtenerLugarSegurosSalud(),S.obtenerAporteSeguroLargoPlazo(),S.obtenerTipoOtrosSeguros(),S.obtenerFamiliaRelacion(),S.obtenerBancos(),S.obtenerMeses(),S.listYears=S.obtenerAnios(1930),S.obtenerCargos(),S.obtenerDiscapacidades(),S.obtenerGrados(),S.obtenerTitulos(),S.obtenerInstituciones(),S.obtenerCapacidadesIE(),S.obtenerLogrosIE(),S.obtenertiposAusenciaMedica(),S.obtenerTiposOtrasAusencias(),S.obtenerTiposBaja(),S.obtenerEstadoDotacion(),S.obtenerCumplimientoDotacion(),S.obtenerPeriodosDotacion(),S.obtenerGruposRol(),S.obtenerVehiculosViaje(),S.obtenerTipoViajeDetalle(),S.obtenerTiposEstadosPasajeros(),S.obtenerTipoLicenciaVehiculo()},S.obtenerTiposEstadosPasajeros=function(){E.start(),he("RRHH_EPVIA",S.usuario.id_empresa).then(function(e){S.tiposPasajerosViaje=e.clases,E.stop()})},S.obtenerGruposRol=function(){E.start(),he("RRHH_GROL",S.usuario.id_empresa).then(function(e){S.gruposRol=e,E.stop()})},S.obtenerTipoLicenciaVehiculo=function(){E.start(),he("RRHH_TLVVIA",S.usuario.id_empresa).then(function(e){S.TiposLicenciasVehiculo=e,E.stop()})},S.obtenerVehiculosViaje=function(){E.start(),he("RRHH_VVIA",S.usuario.id_empresa).then(function(e){S.vehiculosViaje=e,E.stop()})},S.obtenerTipoViajeDetalle=function(){E.start(),he("RRHH_TVIA",S.usuario.id_empresa).then(function(e){S.tiposViaje=e,E.stop()})},S.obtenerGrados=function(){E.start(),he("RRHH_GRA",S.usuario.id_empresa).then(function(e){S.grados=e,E.stop()})},S.obtenerTitulos=function(){E.start(),he("RRHH_TITL",S.usuario.id_empresa).then(function(e){S.titulos=e,E.stop()})},S.obtenerInstituciones=function(){E.start(),he("RRHH_INST",S.usuario.id_empresa).then(function(e){S.instituciones=e,E.stop()})},S.obtenerCapacidadesIE=function(){E.start(),he("RRHH_TCIE",S.usuario.id_empresa).then(function(e){S.capacidadesIE=e,E.stop()})},S.obtenerLogrosIE=function(){E.start(),he("RRHH_TLIE",S.usuario.id_empresa).then(function(e){S.logrosIE=e,E.stop()})},S.obtenerHistorialContratos=function(e){E.start(),w(e.id).then(function(e){S.historialFichaEmpleado=e,S.llenarHistoricoCertificado(e),E.stop()})},S.obtenerCargos=function(){E.start(),he("RRHH_CARGO",S.usuario.id_empresa).then(function(e){var a=e.clases;S.listaCargos=e,S.llenarCargos(a),E.stop()})},S.obtenerDiscapacidades=function(){E.start(),he("RRHH_DISC",S.usuario.id_empresa).then(function(e){var a=e.clases;S.llenarDiscapacidades(a),E.stop()})},S.obtenerExpeditos=function(){E.start(),he("RRHH_EXP",S.usuario.id_empresa).then(function(e){S.tipoExpedido=e,E.stop()})},S.obtenerTipoExpeditos=function(){E.start(),he("RRHH_TEXP",S.usuario.id_empresa).then(function(e){S.tipoDocumento=e,E.stop()})},S.obtenerEstadoCivil=function(){E.start(),he("RRHH_EC",S.usuario.id_empresa).then(function(e){S.estadosCiviles=e,E.stop()})},S.obtenerNacionalidades=function(){E.start(),C("NAC").then(function(e){S.nacionalidades=e,E.stop()})},S.obtenerDepartamentos=function(){E.start();_("-BOL").then(function(e){S.departamentosBanco=e,E.stop()})},S.buscarDepartamento=function(e){if(e){var a="-"+e.nombre_corto;_(a).then(function(e){0===(S.departamentos=e).length&&(S.provincias=[],S.localidades=[])})}},S.buscarDepartamentoFiniquito=function(){_("-BOL").then(function(e){S.departamentosFiniquito=e})},S.buscarRopaTrabajo=function(){Re("ROPA DE TRABAJO-G",S.usuario.id_empresa).then(function(e){S.ropasDeTrabajo=e})},S.buscarMunicipios=function(e){if(e){var a=(e.id+"-"+e.nombre_corto).split("-")[1];_(a+"M").then(function(e){0===(S.provincias=e).length&&(S.localidades=[])})}},S.buscarLocalidad=function(e){if(e){var a=e.nombre_corto.split("-")[1];_((a="-"+a)+"L").then(function(e){S.localidades=e})}},S.AgregarDepartamento=function(t){if(t.edit){var r=!0;S.clase={pais:t.pais},S.departamentos.forEach(function(e,a,o){var i=e.nombre_corto.split("-")[0];e.id!=t.id&&i==t.nombre_corto2&&(r=!1),a===o.length-1&&(r?(t.nombre_corto=t.nombre_corto2+"-"+t.pais.nombre_corto,S.clase={pais:t.pais}):S.mostrarMensaje("El nombre corto tiene que ser unico por departamento"))})}else{r=!0;0<S.departamentos.length?S.departamentos.forEach(function(e,a,o){e.nombre_corto.split("-")[0]==t.nombre_corto2&&(r=!1),a===o.length-1&&(r?(t.nombre_corto=t.nombre_corto2+"-"+t.pais.nombre_corto,S.departamentos.push(t),S.clase={pais:t.pais}):S.mostrarMensaje("El nombre corto tiene que ser unico por departamento"))}):(t.nombre_corto=t.nombre_corto2+"-"+t.pais.nombre_corto,S.departamentos.push(t),S.clase={pais:t.pais})}},S.AgregarProvincia=function(r){if(r.edit){var n=!0;S.provincias.forEach(function(e,a,o){var i=e.nombre_corto.split("-")[1];if(e.id!=r.id&&i==r.nombre_corto2&&(n=!1),a===o.length-1)if(n){var t=r.departamento.nombre_corto.split("-")[0];r.nombre_corto=t+"M-"+r.nombre_corto2}else S.mostrarMensaje("El nombre corto tiene que ser unico por provincia")}),S.clase={departamento:r.departamento}}else{n=!0;if(0<S.provincias.length)S.provincias.forEach(function(e,a,o){if(e.nombre_corto.split("-")[1]==r.nombre_corto2&&(n=!1),a===o.length-1)if(n){var i=r.departamento.nombre_corto.split("-")[0];r.nombre_corto=i+"M-"+r.nombre_corto2,S.provincias.push(r),S.clase={departamento:r.departamento}}else S.mostrarMensaje("El nombre corto tiene que ser unico por provincia")});else{var e=r.departamento.nombre_corto.split("-")[0];r.nombre_corto=e+"M-"+r.nombre_corto2,S.provincias.push(r),S.clase={departamento:r.departamento}}}},S.AgregarLocalidad=function(n){if(n.edit){var s=!0;S.localidades.forEach(function(e,a,o){var i=e.nombre_corto.split("-")[0],t=n.nombre_corto2;if(e.id!=n.id&&i==t&&(s=!1),a===o.length-1)if(s){var r=n.provincia.nombre_corto.split("-")[1];n.nombre_corto=n.nombre_corto2+"-"+r+"L"}else S.mostrarMensaje("El nombre corto tiene que ser unico por localidad")}),S.clase={provincia:n.provincia}}else{s=!0;if(0<S.localidades.length)S.localidades.forEach(function(e,a,o){if(e.nombre_corto.split("-")[0]==n.nombre_corto2&&(s=!1),a===o.length-1)if(s){var i=n.provincia.nombre_corto.split("-")[1];n.nombre_corto=n.nombre_corto2+"-"+i+"L",S.localidades.push(n),S.clase={provincia:n.provincia}}else S.mostrarMensaje("El nombre corto tiene que ser unico por localidad")});else{var e=n.provincia.nombre_corto.split("-")[1];n.nombre_corto=n.nombre_corto2+"-"+e+"L",S.localidades.push(n),S.clase={provincia:n.provincia}}}},S.guardarConceptoEdicionRrhh=function(e,a){E.start(),S.tipo_edicion2.clases=e;var o=S.tipo_edicion2;re.update({id_tipo:o.id},o,function(e){C(o.nombre_corto).then(function(e){o=e,S.tipo_edicion2={},E.stop(),S.buscarDepartamento(a.pais),S.buscarMunicipios(a.departamento),S.buscarLocalidad(a.provincia),S.cerrarDialogDepartamentoEstado(),S.cerrarDialogProvincia(),S.cerrarDialogLocalidad(),S.mostrarMensaje("Guardado Exitosamente!")})})},S.editarLocalidad=function(e,a){var o=a.provincia,i=e.nombre_corto.split("-")[0];S.clase=e,S.clase.provincia=o,S.clase.nombre_corto2=i,S.clase.edit=!0},S.editarProvincia=function(e,a){var o=a.departamento,i=e.nombre_corto.split("-")[1];S.clase=e,S.clase.departamento=o,S.clase.nombre_corto2=i,S.clase.edit=!0},S.editarDepartamento=function(e,a){var o=a.pais,i=e.nombre_corto.split("-")[0];S.clase=e,S.clase.pais=o,S.clase.nombre_corto2=i,S.clase.edit=!0},S.cancelarEdicionLocalidad=function(e){S.clase={provincia:e.provincia}},S.cancelarEdicionProvincia=function(e){S.clase={departamento:e.departamento}},S.cancelarEdicionDepartamento=function(e){S.clase={pais:e.pais}},S.obtenerTiposContratos=function(){E.start(),he("RRHH_TC",S.usuario.id_empresa).then(function(e){S.tiposContratos=e,E.stop()})},S.obtenerTiposPersonales=function(){E.start(),he("RRHH_TP",S.usuario.id_empresa).then(function(e){S.tiposPersonales=e,E.stop()})},S.obtenerCargasHorarios=function(){E.start(),he("RRHH_CH",S.usuario.id_empresa).then(function(e){S.cargasHorarios=e,E.stop()})},S.obtenerAreas=function(){E.start(),he("RRHH_AREA",S.usuario.id_empresa).then(function(e){S.listaAreas=e,E.stop()})},S.obtenerUbicacion=function(){E.start(),he("RRHH_UBI",S.usuario.id_empresa).then(function(e){S.ubicaciones=e,E.stop()})},S.obtenerSegurosSalud=function(){E.start(),he("RRHH_SS",S.usuario.id_empresa).then(function(e){S.segurosSalud=e,E.stop()})},S.obtenerLugarSegurosSalud=function(){E.start(),he("RRHH_LSS",S.usuario.id_empresa).then(function(e){S.LugaresSegurosSalud=e,E.stop()})},S.obtenerAporteSeguroLargoPlazo=function(){E.start(),he("RRHH_ASLP",S.usuario.id_empresa).then(function(e){S.aportesSeguroLargoPlazo=e,E.stop()})},S.obtenerTipoOtrosSeguros=function(){E.start(),he("RRHH_OST",S.usuario.id_empresa).then(function(e){S.OtrosSegurosTipos=e,E.stop()})},S.obtenerBancos=function(){E.start(),he("RRHH_BAN",S.usuario.id_empresa).then(function(e){S.bancosHdv=e,E.stop()})},S.obtenerFamiliaRelacion=function(){E.start(),he("RRHH_REL",S.usuario.id_empresa).then(function(e){S.relaciones=e,E.stop()})},S.obtenerAnios=function(e){var a=(new Date).getFullYear(),o=[];for(e=e||1930;e<=a;)o.push(e++);return o},S.getDaysInMonth=function(e,a){for(var o=new Date(a,e+1,0).getDate(),i=[],t=1;t<=o;t++)i.push(t),t==o&&(S.listaDias=i)},S.guardarFichaTecnica=function(e,n,a){if(0==S.nopuedoModificarFicha){S.ficha.quienModifico=S.usuario.id;var o=S.fechaATexto(n.fecha_inicio);if(n.historialVacacion=[],o!=n.fecha_inicio2){var i=n.fecha_inicio2,t=new Date(S.convertirFecha(i)).getFullYear();S.obtenerAnios(t).forEach(function(e,a,o){var i=a+1,t=null;i<=5?t=S.configuracionesVacacion[0].dias:i<=10?t=S.configuracionesVacacion[1].dias:10<i&&(t=S.configuracionesVacacion[2].dias);var r={gestion:e,anio:a+1,aplicadas:t,tomadas:0};n.historialVacacion.push(r)})}if(a){S.primeroGuardarParaCerrar=!1,n.empleado.persona.fecha_nacimiento=new Date(n.nac_anio,parseInt(n.nac_mes.id),parseInt(n.nac_dia)),n.fecha_elaboracion&&(n.fecha_elaboracion=new Date(S.convertirFecha(n.fecha_elaboracion))),n.fecha_inicio2&&(n.fecha_inicio2=new Date(S.convertirFecha(n.fecha_inicio2))),n.fecha_fin2&&(n.fecha_fin2=new Date(S.convertirFecha(n.fecha_fin2))),n.fecha_jubilacion&&(n.fecha_jubilacion=new Date(S.convertirFecha(n.fecha_jubilacion))),n.empleado.fecha_vence_documento&&(n.empleado.fecha_vence_documento=new Date(S.convertirFecha(n.empleado.fecha_vence_documento)));var r=document.getElementById("id-contrato").files[0],s=new FileReader;if(r)s.onloadend=function(e){n.contrato2={name:"",data:null},n.contrato2.name=n.contrato[0].name,n.contrato2.data=e.target.result,M(n).then(function(e){S.cerrarDialogEmpleado(),S.recargarItemsTabla(),S.mostrarMensaje(e.message)})},s.readAsBinaryString(r);else M(n).then(function(a){if(fecha1=S.fechaATexto(a.fichaActual.fecha_inicio),fecha2=S.fechaATexto(a.fichaAnterior.fecha_inicio),fecha1==fecha2){var e=[],o={},i=0,t=Object.keys(a.fichaActual).length;for(var r in a.fichaActual){var n=r.substr(0,3);if("id_"!=n&&"updatedAt"!=r&&"createdAt"!=r&&"id"!=r&&"nombre_corto"!=r)if(a.fichaActual[r]instanceof Object){if(a.fichaActual[r]instanceof Array){console.log("comparar arreglos");var s=!1,c="",l="",d=a.fichaActual[r];a.fichaActual[r].forEach(function(e){"cargos"==r&&(c+=e.cargo.nombre+", "),"discapacidades"==r&&(c+=e.discapacidad.nombre+", "),"otrosSeguros"==r&&(c+=e.tipoSeguro.nombre+", ")});var u=a.fichaAnterior[r];a.fichaAnterior[r].forEach(function(e){"cargos"==r&&(l+=e.cargo.nombre+", "),"discapacidades"==r&&(l+=e.discapacidad.nombre+", "),"otrosSeguros"==r&&(c+=e.tipoSeguro.nombre+", ")}),s=d.includes(u),u.length!=d.length&&(s=!0),s&&(o={id_ficha:a.fichaActual.id,campo:r,valor_anterior:l,valor_actual:c,fecha:new Date},e.push(o))}else for(var p in a.fichaActual[r])if("id_"!=(n=p.substr(0,3))&&"updatedAt"!=p&&"createdAt"!=p&&"id"!=p&&"nombre_corto"!=p)if(a.fichaActual[r][p]instanceof Object)for(var m in a.fichaActual[r][p])"id_"!=(n=m.substr(0,3))&&"updatedAt"!=m&&"createdAt"!=m&&"id"!=m&&"nombre_corto"!=m&&(a.fichaActual[r][p][m]instanceof Object?console.log("aqui otro forin"):a.fichaAnterior[r][p]?a.fichaActual[r][p][m]!=a.fichaAnterior[r][p][m]&&(o={id_ficha:a.fichaActual.id,campo:r+"."+p+"."+m,valor_anterior:a.fichaAnterior[r][p][m],valor_actual:a.fichaActual[r][p][m],fecha:new Date},e.push(o)):a.fichaActual[r][p][m]&&(o={id_ficha:a.fichaActual.id,campo:r+"."+p+"."+m,valor_anterior:"",valor_actual:a.fichaActual[r][p][m],fecha:new Date},e.push(o)));else a.fichaAnterior[r]?a.fichaActual[r][p]!=a.fichaAnterior[r][p]&&(o={id_ficha:a.fichaActual.id,campo:r+"."+p,valor_anterior:a.fichaAnterior[r][p],valor_actual:a.fichaActual[r][p],fecha:new Date},e.push(o)):a.fichaActual[r][p]&&(o={id_ficha:a.fichaActual.id,campo:r+"."+p,valor_anterior:"",valor_actual:a.fichaActual[r][p],fecha:new Date},e.push(o))}else a.fichaActual[r]!=a.fichaAnterior[r]&&(o={id_ficha:a.fichaActual.id,campo:r,valor_anterior:a.fichaAnterior[r],valor_actual:a.fichaActual[r],fecha:new Date},e.push(o));if(++i===t-1)if(0<e.length)fe(S.usuario.id,e).then(function(e){S.cerrarDialogEmpleado(),S.recargarItemsTabla(),S.mostrarMensaje(a.message)});else S.primeroGuardarParaCerrar=!1,S.cerrarDialogEmpleado(),S.recargarItemsTabla(),S.mostrarMensaje(a.message)}}else S.primeroGuardarParaCerrar=!1,S.cerrarDialogEmpleado(),S.recargarItemsTabla(),S.mostrarMensaje(a.message)})}else{if("Siguiente"!=$("#siguiente-f").text().trim())n.empleado.persona.fecha_nacimiento=new Date(n.nac_anio,parseInt(n.nac_mes.id),parseInt(n.nac_dia)),n.fecha_elaboracion&&(n.fecha_elaboracion=new Date(S.convertirFecha(n.fecha_elaboracion))),n.fecha_inicio2&&(n.fecha_inicio2=new Date(S.convertirFecha(n.fecha_inicio2))),n.fecha_fin2&&(n.fecha_fin2=new Date(S.convertirFecha(n.fecha_fin2))),n.fecha_jubilacion&&(n.fecha_jubilacion=new Date(S.convertirFecha(n.fecha_jubilacion))),n.empleado.fecha_vence_documento&&(n.empleado.fecha_vence_documento=new Date(S.convertirFecha(n.empleado.fecha_vence_documento))),M(n).then(function(a){if(S.primeroGuardarParaCerrar=!1,fecha1=S.fechaATexto(a.fichaActual.fecha_inicio),fecha2=S.fechaATexto(a.fichaAnterior.fecha_inicio),fecha1==fecha2){var e=[],o={},i=0,t=Object.keys(a.fichaActual).length;for(var r in a.fichaActual){var n=r.substr(0,3);if("id_"!=n&&"updatedAt"!=r&&"createdAt"!=r&&"id"!=r&&"nombre_corto"!=r)if(a.fichaActual[r]instanceof Object){if(a.fichaActual[r]instanceof Array){console.log("comparar arreglos");var s=!1,c="",l="",d=a.fichaActual[r];a.fichaActual[r].forEach(function(e){"cargos"==r&&(c+=e.cargo.nombre+", "),"discapacidades"==r&&(c+=e.discapacidad.nombre+", "),"otrosSeguros"==r&&(c+=e.tipoSeguro.nombre+", ")});var u=a.fichaAnterior[r];a.fichaAnterior[r].forEach(function(e){"cargos"==r&&(l+=e.cargo.nombre+", "),"discapacidades"==r&&(l+=e.discapacidad.nombre+", "),"otrosSeguros"==r&&(c+=e.tipoSeguro.nombre+", ")}),s=d.includes(u),u.length!=d.length&&(s=!0),s&&(o={id_ficha:a.fichaActual.id,campo:r,valor_anterior:l,valor_actual:c,fecha:new Date},e.push(o))}else for(var p in a.fichaActual[r])if("id_"!=(n=p.substr(0,3))&&"updatedAt"!=p&&"createdAt"!=p&&"id"!=p&&"nombre_corto"!=p)if(a.fichaActual[r][p]instanceof Object)for(var m in a.fichaActual[r][p])"id_"!=(n=m.substr(0,3))&&"updatedAt"!=m&&"createdAt"!=m&&"id"!=m&&"nombre_corto"!=m&&(a.fichaActual[r][p][m]instanceof Object?console.log("aqui otro forin"):a.fichaAnterior[r][p]?a.fichaActual[r][p][m]!=a.fichaAnterior[r][p][m]&&(o={id_ficha:a.fichaActual.id,campo:r+"."+p+"."+m,valor_anterior:a.fichaAnterior[r][p][m],valor_actual:a.fichaActual[r][p][m],fecha:new Date},e.push(o)):a.fichaActual[r][p][m]&&(o={id_ficha:a.fichaActual.id,campo:r+"."+p+"."+m,valor_anterior:"",valor_actual:a.fichaActual[r][p][m],fecha:new Date},e.push(o)));else a.fichaAnterior[r]?a.fichaActual[r][p]!=a.fichaAnterior[r][p]&&(o={id_ficha:a.fichaActual.id,campo:r+"."+p,valor_anterior:a.fichaAnterior[r][p],valor_actual:a.fichaActual[r][p],fecha:new Date},e.push(o)):a.fichaActual[r][p]&&(o={id_ficha:a.fichaActual.id,campo:r+"."+p,valor_anterior:"",valor_actual:a.fichaActual[r][p],fecha:new Date},e.push(o))}else a.fichaActual[r]!=a.fichaAnterior[r]&&(o={id_ficha:a.fichaActual.id,campo:r,valor_anterior:a.fichaAnterior[r],valor_actual:a.fichaActual[r],fecha:new Date},e.push(o));if(++i===t-1)if(0<e.length)fe(S.usuario.id,e).then(function(e){S.cerrarDialogEmpleado(),S.recargarItemsTabla(),S.mostrarMensaje(a.message)});else S.cerrarDialogEmpleado(),S.recargarItemsTabla(),S.mostrarMensaje(a.message)}}else S.primeroGuardarParaCerrar=!1,S.cerrarDialogEmpleado(),S.recargarItemsTabla(),S.mostrarMensaje(a.message)})}}else{"Siguiente"!=$("#siguiente-f").text().trim()&&S.cerrarDialogEmpleado()}},S.actualizarPrerequisito=function(e){h(e).then(function(e){S.cerrarDialogInicioPreRequisitos(),S.mostrarMensaje(e.message)})},S.completarCamposLaboral=function(a){"OBRA"==a.tipoContrato.nombre&&(S.tiposPersonales.clases.forEach(function(e){"CAMPO"==e.nombre&&(a.tipoPersonal=e)}),a.area={},a.ubicacion={}),"INDEFINIDO"==a.tipoContrato.nombre&&(S.tiposPersonales.clases.forEach(function(e){"OFICINA"==e.nombre&&(a.tipoPersonal=e)}),S.listaAreas.clases.forEach(function(e){"ESS-SCZ"==e.nombre&&(a.area=e)}),S.ubicaciones.clases.forEach(function(e){"ESS-SCZ"==e.nombre&&(a.ubicacion=e)}))},S.agregarFormacionAcademica=function(e){S.hojaVida.formacionesAcademicas.push(e),S.formacionAcademica={edit:!1,eliminado:!1}},S.guardarFormacionAcademicaEditada=function(e){S.formacionAcademica={edit:!1,eliminado:!1}},S.editarFomracionAcademica=function(e,a){S.formacionAcademica=e,S.formacionAcademica.edit=!0},S.eliminarFomracionAcademica=function(e){e.eliminado=!0},S.agregarExperienciaLaboral=function(e){e.fecha_inicio=new Date(convertirFecha(e.fecha_inicio)),e.fecha_fin=new Date(convertirFecha(e.fecha_fin)),e.fecha_inicioTexto=S.fechaATexto(e.fecha_inicio),e.fecha_finTexto=S.fechaATexto(e.fecha_fin),S.hojaVida.experienciasLaborales.push(e),S.experienciaLaboral={edit:!1,eliminado:!1}},S.guardarExperienciaLaboralEditada=function(e){e.fecha_inicio=new Date(convertirFecha(e.fecha_inicio)),e.fecha_fin=new Date(convertirFecha(e.fecha_fin)),e.fecha_inicioTexto=S.fechaATexto(e.fecha_inicio),e.fecha_finTexto=S.fechaATexto(e.fecha_fin),S.experienciaLaboral={edit:!1,eliminado:!1}},S.editarExperienciaLaboral=function(e){e.fecha_inicio=S.fechaATexto(e.fecha_inicio),e.fecha_fin=S.fechaATexto(e.fecha_fin),S.experienciaLaboral=e,S.experienciaLaboral.edit=!0},S.eliminarExperienciaLaboral=function(e){e.eliminado=!0},S.agregarCapacidadHojaVida=function(e){e.fecha=new Date(convertirFecha(e.fecha)),e.fechaTexto=S.fechaATexto(e.fecha),S.hojaVida.capacidades.push(e),S.capacidad={edit:!1,eliminado:!1}},S.guardarCapacidadHojaVidaEditada=function(e){e.fecha=new Date(convertirFecha(e.fecha)),e.fechaTexto=S.fechaATexto(e.fecha),S.capacidad={edit:!1,eliminado:!1}},S.editarCapacidadHojaVida=function(e){e.fecha=S.fechaATexto(e.fecha),S.capacidad=e,S.capacidad.edit=!0},S.eliminarCapacidadHojaVida=function(e){e.eliminado=!0},S.agregarLogroHojaVida=function(e){e.fecha=new Date(convertirFecha(e.fecha)),e.fechaTexto=S.fechaATexto(e.fecha),S.hojaVida.logros.push(e),S.logro={edit:!1,eliminado:!1}},S.guardarLogroHojaVidaEditada=function(e){e.fecha=new Date(convertirFecha(e.fecha)),e.fechaTexto=S.fechaATexto(e.fecha),S.logro={edit:!1,eliminado:!1}},S.editarLogroHojaVida=function(e){e.fecha=S.fechaATexto(e.fecha),S.logro=e,S.logro.edit=!0},S.eliminarLogroHojaVida=function(e){e.eliminado=!0},S.GuardarHojaDeVida=function(){"Siguiente"!=$("#siguiente-s").text().trim()&&(S.empleado.activo?R(S.empleado.id,S.hojaVida).then(function(e){S.cerrarDialogHojaVida(),S.mostrarMensaje(e.mensaje),S.recargarItemsTabla()}):($("#formacion-academica").click(),S.cerrarDialogHojaVida()))},S.GuardarHojaDeVidaDirecto=function(){R(S.empleado.id,S.hojaVida).then(function(e){S.cerrarDialogHojaVida(),S.mostrarMensaje(e.mensaje),S.recargarItemsTabla()})},S.imprimirHojaVida=function(e){var o;e.capacidadInterna?((o=e).tipo="INTER",o.inicio&&o.fin?(o.inicio=new Date(convertirFecha(o.inicio)),o.fin=new Date(convertirFecha(o.fin))):(o.inicio=0,o.fin=0),G(o,S.hojaVida.id).then(function(e){S.capacidades=e.capacidades,convertUrlToBase64Image(S.empleado.imagen,function(e){var a=e;S.generarPdfHojaVida(a),o.inicio="",o.fin=""})})):((o=e).tipo="EXT",o.inicio=0,o.fin=0,G(o,S.hojaVida.id).then(function(e){S.capacidades=e.capacidades,convertUrlToBase64Image(S.empleado.imagen,function(e){var a=e;S.generarPdfHojaVida(a),o.inicio="",o.fin=""})}))},S.generarPdfHojaVida=function(u){E.start(),totalpaginastamaño=S.hojaVida.experienciasLaborales.length+S.hojaVida.formacionesAcademicas.length+S.capacidades.length,promesaPaciente=p(S.empleado.id),promesaPaciente.then(function(e){null!=e.clase&&(e.medicoPaciente.tipo_contrato=e.clase),S.empleado2=e.medicoPaciente;var a=new PDFDocument({compress:!1,size:[612,792],margin:10}),o=a.pipe(blobStream()),i=205,t=1,r=Math.ceil(totalpaginastamaño/20);S.dibujarCabeceraPDFHojaVida(a,1,r,u),a.font("Helvetica",7);for(var n=0;n<S.hojaVida.formacionesAcademicas.length;n++){if(formacion=S.hojaVida.formacionesAcademicas[n],a.text(formacion.anio_obtencion,80,i),a.text(formacion.institucion.nombre,170,i,{width:100}),a.text(formacion.grado.nombre,305,i,{width:100}),a.text(formacion.titulo.nombre,405,i,{width:100}),20<formacion.institucion.nombre.length||20<formacion.grado.nombre.length||20<formacion.titulo.nombre.length)rowinstituto=formacion.institucion.nombre.length/20,rowgrado=formacion.grado.nombre.length/20,rowtitulo=formacion.titulo.nombre.length/20,arregloTamaño=[Math.floor(rowinstituto),Math.floor(rowgrado),Math.floor(rowtitulo)],i+=10*Math.max.apply(null,arregloTamaño);0,725<=(i+=20)&&(a.addPage({margin:0,bufferPages:!0}),i=90,0,a.rect(25,i-20,550,15).fill("silver","#000"),a.font("Helvetica-Bold",8).fill("black"),a.text("GRADO DE INSTRUCCIONES",35,i),a.font("Helvetica-Bold",8),a.text("AÑO DE OBTENCIÓN",45,i),a.text("INSTITUCIÓN",170,i),a.text("GRADO",305,i),a.text("CARRERA",405,i),t+=1,a.text("PÁGINA "+t+" DE "+r,0,750,{align:"center"}),a.font("Helvetica",7))}for(var s=0;s<S.capacidades.length;s++){var c=S.capacidades[s];if(0==s&&(i+=15,a.rect(25,i-20,550,15).fill("silver","#000"),a.font("Helvetica-Bold",8).fill("black"),a.text("CURSO,CAPACIDADES Y SEMINARIOS",35,i-15),a.font("Helvetica-Bold",8),a.text("FECHA",45,i),a.text("INSTITUCIÓN",170,i),a.text("GRADO",305,i),a.text("CARRERA",405,i),i+=20),a.font("Helvetica",8),c.fechaTexto=S.fechaATexto(c.fecha),a.text(c.fechaTexto,40,i,{width:100}),a.text(c.curso,170,i,{width:100}),a.text(c.institucion,305,i,{width:80}),a.text(c.certificado,405,i,{width:100}),20<c.curso.length||17<c.institucion.length||20<c.certificado.length)rowcurso=c.curso.length/20,rowinstituto=c.institucion.length/17,rowcertificado=c.certificado.length/20,arregloTamaño=[Math.floor(rowcurso),Math.floor(rowinstituto),Math.floor(rowcertificado)],i+=10*Math.max.apply(null,arregloTamaño);0,725<=(i+=20)&&(a.addPage({margin:0,bufferPages:!0}),i=90,0,a.rect(25,i-20,550,15).fill("silver","#000"),a.font("Helvetica-Bold",8).fill("black"),a.text("CURSO,CAPACIDADES Y SEMINARIOS",35,i-15),a.font("Helvetica-Bold",8),a.text("FECHA",45,i),a.text("INSTITUCIÓN",170,i),a.text("GRADO",305,i),a.text("CARRERA",405,i),i+=20,t+=1,a.text("PÁGINA "+t+" DE "+r,0,750,{align:"center"}),a.font("Helvetica",7))}for(var l=0;l<S.hojaVida.experienciasLaborales.length;l++){var d=S.hojaVida.experienciasLaborales[l];if(0==l&&(i+=15,a.rect(25,i-20,550,15).fill("silver","#000"),a.font("Helvetica-Bold",8).fill("black"),a.text("EXPERIENCIA LABORAL",35,i-15),a.font("Helvetica-Bold",8),a.text("DESDE",45,i),a.text("HASTA",120,i),a.text("EMPRESA",205,i),a.text("CARGO",305,i),a.text("REFERENCIA",385,i),a.text("TELEFONO",485,i),i+=20),a.font("Helvetica",8),a.text(d.fecha_inicioTexto,40,i,{width:100}),a.text(d.fecha_finTexto,115,i,{width:100}),a.text(d.empresa,205,i,{width:80}),a.text(d.cargo,305,i,{width:60}),a.text(d.contacto,385,i,{width:100}),a.text(d.telefono,485,i,{width:100}),17<d.empresa.length||13<d.cargo.length||20<d.contacto.length)rowempresa=d.empresa.length/17,rowcargo=d.cargo.length/13,rowcontacto=d.contacto.length/20,arregloTamaño=[Math.floor(rowempresa),Math.floor(rowcargo),Math.floor(rowcontacto)],i+=10*Math.max.apply(null,arregloTamaño);0,725<=(i+=20)&&(i+=20,a.addPage({margin:0,bufferPages:!0}),i=90,0,a.rect(25,i-20,550,15).fill("silver","#000"),a.font("Helvetica-Bold",8).fill("black"),a.text("EXPERIENCIA LABORAL",35,i-15),a.font("Helvetica-Bold",8),a.text("DESDE",45,i),a.text("HASTA",120,i),a.text("EMPRESA",205,i),a.text("CARGO",305,i),a.text("REFERENCIA",385,i),a.text("TELEFONO",485,i),i+=20,t+=1,a.text("PÁGINA "+t+" DE "+r,0,750,{align:"center"}),a.font("Helvetica",7))}a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),E.stop()})},S.dibujarCabeceraPDFHojaVida=function(e,a,o,i){e.font("Helvetica-Bold",12),e.rect(25,30,550,20).fill("silver","#000"),e.font("Helvetica-Bold",12).fill("black"),e.text("HOJA DE VIDA",0,35,{align:"center"}),e.image(i,400,70,{width:80,height:80}),e.font("Helvetica-Bold",10),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,750,{align:"center"}),e.font("Helvetica-Bold",8),e.text("NOMBRE Y APELLIDO:",45,60),e.text("NACIONALIDAD:",45,70),e.text("LUGAR DE NACIMIENTOS:",45,80),e.text("RESIDENCIA ACTUAL:",45,90),e.text("DIRECCION:",45,100),e.text("CI:",45,110),e.text("ESTADO CIVIL:",45,120),e.text("TELEFONO:",45,130),e.text("CELULAR:",45,140),e.text("E-MAIL:",45,150),e.font("Helvetica",8),e.text(S.empleado2.persona.nombre_completo,170,60),e.text(S.empleado2.persona.pais_nacimiento,170,70),e.text(S.empleado2.persona.ciudad_nacimiento+" / "+S.empleado2.persona.provincia_nacimiento+" / "+S.empleado2.persona.localidad_nacimiento,170,80),e.text("",170,90),e.text(S.empleado2.persona.direccion_zona,170,100),e.text(S.empleado2.persona.ci,170,110),e.text(S.empleado2.persona.estado_civil,170,120),e.text(S.empleado2.persona.telefono,170,130),e.text(S.empleado2.persona.telefono_movil,170,140),e.text(S.empleado2.persona.correo_electronico,170,150),e.rect(25,165,550,15).fill("silver","#000"),e.font("Helvetica-Bold",8).fill("black"),e.text("GRADO DE INSTRUCCIONES",35,170),e.font("Helvetica-Bold",8),e.text("AÑO DE OBTENCIÓN",45,185),e.text("INSTITUCIÓN",170,185),e.text("GRADO",305,185),e.text("CARRERA",405,185)},S.llenarHistoricoCertificado=function(e){S.historialContratos=[];for(var a=0;a<e.length;a++){var o="",i=S.fechaATexto(e[a].fecha_inicio);if(null!=e[a].fecha_fin)o=S.fechaATexto(e[a].fecha_fin);var t={nombre:i+"-"+o,maker:"",ticked:!1,id:e[a].id};S.historialContratos.push(t)}},S.generarPdfCertificado=function(e){var a=new PDFDocument({size:[612,792],margins:{top:10,bottom:10,left:20,right:20}}),o=a.pipe(blobStream());0==e.tipo?S.dibujarPdfCertificadoHojaVida(a,e):S.dibujarPdfCertificadoPrestamo(a,e),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},S.dibujarPdfCertificadoHojaVida=function(e,a){var o=new Date,i="",t="",r=o.getMonth();S.meses.forEach(function(e){e.id==r&&(i=e.nombre)}),S.ficha.cargo.forEach(function(e){t=""==t?e.nombre:t+", "+e.nombre}),e.font("Times-Roman",12),e.text("Santa Cruz, "+o.getDate()+" de "+i+" de "+o.getFullYear(),0,75,{align:"center"}),e.font("Times-Roman",24),e.text("CERTIFICADO DE TRABAJO",0,150,{align:"center"}),e.font("Times-Roman",13);var n="EMSERSO SA., certifica que "+S.ficha.empleado.persona.nombre_completo+" con CI."+S.ficha.empleado.persona.ci+" "+S.ficha.empleado.extension.nombre+", trabajó (a) como "+t+", durante los siguientes periodos:";e.text(n,100,230,{width:412,align:"left",indent:0,columns:1,height:300,ellipsis:!0});for(var s=250,c=0;c<a.historialContratos.length;c++){var l=a.historialContratos[c].nombre.split("-");e.text("Desde el "+l[0]+" al "+l[1],100,s,{width:412,align:"left",indent:0,columns:1,height:300,ellipsis:!0}),s+=20}e.text("Es cuanto certifico para los fines que convengan al interesado.",100,s+20,{align:"left"}),e.text("Lic. Rosangela Velasques S.",100,695),e.text("JEFA DE RECURSOS HUMANOS",100,715)},S.dibujarPdfCertificadoPrestamo=function(e,a){var o=new Date,i="",t="",r="",n=o.getMonth();S.meses.forEach(function(e){e.id==n&&(i=e.nombre)}),S.ficha.cargo.forEach(function(e){t=""==t?e.nombre:t+", "+e.nombre});for(var s=0;s<a.historialContratos.length;s++){var c=a.historialContratos[s].nombre.split("-"),l=c[0].split("/"),d=c[1].split("/");fechaIni=new Date(l[0],l[1],l[2]);var u=new Date(d[0],d[1],d[2]),p=fechaIni.getMonth(),m=u.getMonth();S.meses.forEach(function(e){e.id==p&&(p=e.nombre)}),S.meses.forEach(function(e){e.id==m&&(m=e.nombre),""==c[1]&&(m="")}),r=""==r?""!=m?"el "+fechaIni.getDate()+" de "+p+" de "+fechaIni.getFullYear()+" al "+u.getDate()+" de "+m+" de "+u.getFullYear():"el "+fechaIni.getDate()+" de "+p+" de "+fechaIni.getFullYear()+".":""!=m?r+",  renovando contrato con la empresa a partir del "+fechaIni.getDate()+" de "+p+" de "+fechaIni.getFullYear()+" al "+u.getDate()+" de "+m+" de "+u.getFullYear():r+",  renovando contrato con la empresa a partir del "+fechaIni.getDate()+" de "+p+" de "+fechaIni.getFullYear(),s===a.historialContratos.length-1&&(r=r+". Percibiendo un sueldo aproximado mensual de Bs."+S.ficha.haber_basico+".- ("+S.ficha.haber_basico_literal+")")}e.font("Times-Roman",12),e.text("Santa Cruz, "+o.getDate()+" de "+i+" de "+o.getFullYear(),0,75,{align:"center"}),e.font("Times-Roman",24),e.text("CERTIFICADO DE TRABAJO",0,150,{align:"center"}),e.font("Times-Roman",13);var f="EMSERSO SA., certifica que "+S.ficha.empleado.persona.nombre_completo+" con CI."+S.ficha.empleado.persona.ci+" "+S.ficha.empleado.extension.nombre+", trabaja en nuestra empresa como "+t+" desde "+r;e.text(f,100,230,{width:412,align:"justify",indent:0,columns:1,lineGap:10,wordSpacing:1,height:300,ellipsis:!0}),e.moveDown(2),e.text("Es cuanto certifico para los fines que convengan al interesado.",{align:"left"}),e.text("Lic. Rosangela Velasques S.",100,695),e.text("JEFA DE RECURSOS HUMANOS",100,715)},S.calcularCuota=function(e){var a=e.monto/e.plazo,o=a*e.interes_pactado/100;e.cuota=a+o,e.cuota2=S.number_format(e.cuota,2);for(var i=0,t=e.plazo;i++,(t-=12)<=12&&t,12<t;);12<e.plazo?e.tiempo_plazo_literal=i+" año y "+(e.plazo-12*i)+" meses":e.tiempo_plazo_literal=e.plazo+" meses"},S.GuardarPrestamo=function(a){a.id_usuario=S.usuario.id,a.fecha_inicial=new Date(S.convertirFecha(a.fecha_inicial)),a.total=a.monto*a.interes_pactado/100+a.monto,j(S.empleado.id,a).then(function(e){S.imprimirPrestamo(a),S.cerrarDialogNuevoPrestamo(),S.prestamo={},S.mostrarMensaje(e.mensaje)})},S.GuardarMultiplesPrestamos=function(e){e.id_usuario=S.usuario.id,e.fecha_inicial=S.convertirFecha(e.fecha_inicial),e.total=e.monto*e.interes_pactado/100+e.monto,j(0,e).then(function(e){S.cerrarDialogPretamosNuevoTodos(),S.optenerListaPrestamos(),S.mostrarMensaje(e.mensaje),S.prestamo={}})},S.imprimirPrestamo=function(e){var a=new PDFDocument({size:[792,612],margins:{top:10,bottom:10,left:20,right:20}}),o=a.pipe(blobStream());a.rect(40,90,712,432).stroke(),a.rect(635,125,100,30).stroke(),a.font("Helvetica-Bold",16),a.text("Nro. 11111",640,133),a.font("Helvetica-Bold",14),a.text(S.usuario.empresa.razon_social,65,95),a.text("Santa Cruz- Bolivia",55,110),a.text("NIT: ",55,125),a.font("Helvetica",14),a.text(S.usuario.empresa.nit+".",80,125),a.font("Helvetica-Bold",14),a.text("PRESTAMO AL PERSONAL",0,135,{align:"center"}),a.font("Helvetica-Bold",14),a.text("Empleado ",55,175),a.text("Monto otorgado ",55,200),a.text("Interés Pactado ",55,225),a.text("Fecha des desembolso ",55,250),a.text("Plazo ",55,275),a.text("Monto Mensual ",55,300),a.text("Observaciones ",55,325),a.text("Sueldo Básico ",55,350),a.font("Helvetica",14),a.text(S.empleado.nombre_completo,220,175),a.text(S.number_format(e.monto,2),220,200),a.text(e.interes_pactado+"%",220,225);var i=S.fechaATexto(e.fecha_inicial);a.text(i,220,250),a.text(e.plazo,220,275),a.text(e.cuota2,220,300),a.text(e.observacion,220,325),a.text(S.number_format(S.empleado.haber_basico,2),220,350),a.font("Helvetica-Bold",14),a.text("Recibí Conforme ",55,500),a.text("Responsable de Área ",225,500),a.text("Encargado RRHH ",425,500),a.text("Contabilidad ",605,500),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},S.GuardarPagoPrestamo=function(e){if(0<e.prestamoPagos.length){var a=e.monto_pagado+e.prestamoPagos[e.prestamoPagos.length-1].a_cuenta_anterior,o=(e.total-a)/e.plazo_restante;e.cuota2=o}else{o=(e.total-e.monto_pagado)/e.plazo_restante;e.cuota2=o}e.pagoFecha=new Date,V(S.usuario.id,S.prestamo.id,e).then(function(e){S.cerrarDialogPagoPrestamo(),S.optenerListaPrestamos(),S.prestamo={},S.mostrarMensaje(e.mensaje)})},S.abrirModalVerificarCuenta=function(e,a){S.dato=e,S.tipoDatosPermiso=a,S.abrirPopup(S.IdModalVerificarCuenta)},S.cerrarModalVerificarCuenta=function(){S.cerrarPopup(S.IdModalVerificarCuenta)},S.EditarMontoPrestamo=function(i){i.montoEdit=!1,i.total=i.monto*i.interes_pactado/100+i.monto;var e=i.monto/i.plazo,a=e*i.interes_pactado/100;(i.cuota=e+a,0<i.prestamoPagos.length)?i.prestamoPagos.forEach(function(e,a,o){(e.saldo_anterior=i.total-e.a_cuenta_anterior,a===o.length-1)&&H(i).then(function(e){S.mostrarMensaje(e.mensaje)})}):H(i).then(function(e){S.mostrarMensaje(e.mensaje)})},S.CancelarEditMontoPrestamo=function(e){S.optenerListaPrestamos()},S.verificarCuentaAdmin=function(e){N.save({id_empresa:S.usuario.id_empresa},e,function(e){e.type?(S.mostrarMensaje(e.message),"anticipo"==S.tipoDatosPermiso&&(S.dato.montoEdit?S.dato.montoEdit=!1:S.dato.montoEdit=!0),"datosLaborales"==S.tipoDatosPermiso&&(S.dato.editDatosLaborales?S.dato.editDatosLaborales=!1:S.dato.editDatosLaborales=!0),"finiquito"==S.tipoDatosPermiso&&(S.cuenta={},S.abrirDialogBeneficiosSociales2(S.dato,!0)),"dotacion"==S.tipoDatosPermiso&&(S.cuenta={},S.abrirDialogEliminarRopaTrabajo()),"rolturnoEmpleado"==S.tipoDatosPermiso&&(S.cuenta={},S.editarRoldeTurno(S.dato)),"cerrarRolturnoEmpleado"==S.tipoDatosPermiso&&(S.cuenta={},S.abrirDialogCerrarRolDeTurno()),S.cerrarModalVerificarCuenta()):S.mostrarMensaje(e.message)})},S.obtenerListaEmpleados=function(){B(S.usuario.id_empresa).then(function(i){i.empleados.forEach(function(e,a,o){e.ficha=e.empleadosFichas[0],a===o.length-1&&S.llenarEmpleados(i.empleados)})})},S.llenarEmpleados=function(e){S.todosLosEmpleados=[];for(var a=0;a<e.length;a++){var o={nombre:e[a].persona.nombre_completo,persona:e[a].persona,ficha:e[a].ficha,maker:"",ticked:!1,id:e[a].id};S.todosLosEmpleados.push(o),a===e.length-1&&S.seleccionarEmpleados(S.empleadosSeleccionados)}},S.seleccionarEmpleados=function(e){for(var a=0;a<S.todosLosEmpleados.length;a++)for(var o=0;o<e.length;o++)e[a].select&&(S.todosLosEmpleados[a].ticked=!0)},S.GuardarRolTurno=function(a){a.fecha_inicio=new Date(S.convertirFecha(a.fecha_inicio)),a.fecha_fin&&(a.fecha_fin=new Date(S.convertirFecha(a.fecha_fin))),a.id_ficha=S.empleado.id_ficha,F(S.empleado.id,a).then(function(e){a={},S.cerrarDialogRolTurnos(),S.mostrarMensaje(e.mensaje)})},S.GuardarCierreRolTurno=function(e){e.fecha_fin=new Date(S.convertirFecha(e.fecha_fin)),F(S.empleado.id,e).then(function(e){S.cerrarDialogCerrarRolDeTurno(),S.mostrarMensaje(e.mensaje)})},S.calcularDatosRolTurno=function(i){var t=!0;if(0<S.empleadosRolTurnoE.length){var r="";contFijos=0,S.empleadosRolTurnoE.forEach(function(e,a,o){1==e.tipo&&(contFijos++,t=!1,e.fecha_fin?(t=!0,r=S.fechaATexto(sumaFecha(1,e.fecha_fin))):r=S.fechaATexto(sumaFecha(e.dias_trabajado,e.fecha_inicio))),a===o.length-1&&(t?i.tipo?(i.fecha_fin="",i.dias_trabajado=14,i.dias_descanso=7):(i.dias_trabajado=7,i.dias_descanso=0):1<contFijos?(i.tipo=!1,S.mostrarMensaje("ya cuenta con dos roles de turno fijos, las asignaciones de fechas estan copadas!. Para asignar otro rol de turno fijo debe dar de baja 1")):i.tipo&&(i.blokearDatos=!0,i.dias_trabajado=7,i.dias_descanso=14,S.mostrarMensaje("ya cuenta con un rol turno fijo,se genero otro con la configuracion fija!"),i.fecha_inicio=r))})}else i.tipo?(i.fecha_fin="",i.dias_trabajado=14,i.dias_descanso=7):(i.dias_trabajado=7,i.dias_descanso=0)},S.editarRoldeTurno=function(e){e.fecha_inicio=S.fechaATexto(e.fecha_inicio),e.fecha_fin&&(e.fecha_fin=S.fechaATexto(e.fecha_fin)),S.cerrarDialogHistorialTurnos(),S.rolTurno=e},S.obtenerlistaRolTurno=function(e){E.start(),k(S.usuario.id_empresa,e).then(function(e){S.empleadosRolTurnoE=e.rolesTurno,S.fechaInicioCalendario=S.fechaATexto(new Date(e.fechaInicio)),E.stop()})},S.obtenerlistaRolTurnoCal=function(){S.paginator=s(),S.paginator.column="id",S.paginator.direccion="asc",S.paginator.itemsPerPage=10,S.filtroRolCal={empresa:S.usuario.id_empresa,inicio:"",fin:"",grupo:"",nombre:"",campo:""},S.paginator.callBack=S.listaRolTurnoCal,S.paginator.getSearch("",S.filtroRolCal,null)},S.listaRolTurnoCal=function(){E.start(),Ve(S.paginator).then(function(e){S.paginator.setPages(e.paginas),S.empleadosRolTurno=e.rolesTurno,S.fechaInicioCalendario=S.fechaATexto(new Date(e.fechaInicio));var a=new Date,o=new Date(a.getFullYear(),12,0).getDate(),i="",t="",r="",n="",s="";S.filtroRolCal.inicio2&&(i=S.filtroRolCal.inicio2),S.filtroRolCal.fin2&&(n=S.filtroRolCal.fin2),S.filtroRolCal.grupo&&(t=S.filtroRolCal.grupo),S.filtroRolCal.nombre&&(r=S.filtroRolCal.nombre),S.filtroRolCal.campo&&(s=S.filtroRolCal.campo),S.filtroRolCal={campo:s,nombre:r,grupo:t,empresa:S.usuario.id_empresa,fin2:n,inicio2:i,inicio:S.fechaInicioCalendario,fin:o+"/12/"+a.getFullYear()},S.realizarCalendarioTrabajo(S.filtroRolCal),E.stop()})},S.obtenerlistaRolTurnoEmpresa=function(){Ie(S.paginator).then(function(e){S.paginator.setPages(e.paginas),S.listaRolTurnoFiltro=e.rolesTurno})},S.guardarHorasExtra=function(e){e.fecha=new Date(S.convertirFecha(e.fecha)),e.hora_inicio2=S.fechaATiempo(e.hora_inicio),e.hora_fin2=S.fechaATiempo(e.hora_fin),e.id_ficha=S.empleado.id_ficha,z(S.empleado.id,e).then(function(e){S.cerrarDialogHorasExtras(),S.horaExtra={},S.mostrarMensaje(e.mensaje)})},S.calcularTiempoHorasExtra=function(e){if(e.hora_inicio instanceof Date&&e.hora_fin instanceof Date){var a=e.hora_inicio.getHours(),o=e.hora_fin.getHours(),i=e.hora_inicio.getMinutes(),t=e.hora_fin.getMinutes();if(a<o){var r=moment(e.hora_inicio).format("YYYY-MM-DD HH:mm:ss"),n=moment(e.hora_fin).format("YYYY-MM-DD HH:mm:ss"),s=moment(r,"YYYY-MM-DD HH:mm:ss"),c=moment(n,"YYYY-MM-DD HH:mm:ss").diff(s,"s");e.tiempo=S.caluclarDiferencia(c)}else if(a==o&&i<t){r=moment(e.hora_inicio).format("YYYY-MM-DD HH:mm:ss"),n=moment(e.hora_fin).format("YYYY-MM-DD HH:mm:ss"),s=moment(r,"YYYY-MM-DD HH:mm:ss"),c=moment(n,"YYYY-MM-DD HH:mm:ss").diff(s,"s");e.tiempo=S.caluclarDiferencia(c)}else e.tiempo=""}},S.fechaATiempo=function(e){var a=e.getHours(),o=e.getMinutes(),i=e.getSeconds();return(a=a<10?"0"+a:a)+":"+(o=o<10?"0"+o:o)+":"+(i=i<10?"0"+i:i)},S.caluclarDiferencia=function(e){var a=Math.floor(e/3600),o=Math.floor(e%3600/60),i=e%60;return a+":"+(o=o<10?"0"+o:o)+":"+(i=i<10?"0"+i:i)},S.obtenerHistorialHorasExtra=function(e){var a={};a.inicio=10==e.inicio.length?new Date(S.convertirFecha(e.inicio)):0,a.fin=10==e.fin.length?new Date(S.convertirFecha(e.fin)):0,L(S.empleado.id_ficha,a).then(function(e){S.ListaHorasExtraEmpleado=e,0<S.ListaHorasExtraEmpleado.length?S.sumarTotalHorasExtra():S.SumaTotalHorasExtra="00:00"})},S.sumarTotalHorasExtra=function(){for(var e="",a=0,o=0,i=0;i<S.ListaHorasExtraEmpleado.length;i++){var t=S.ListaHorasExtraEmpleado[i].tiempo.split(":")[1],r=S.ListaHorasExtraEmpleado[i].tiempo.split(":")[0];a+=parseInt(r),60<=(o+=parseInt(t))&&(o-=60,a+=1),e=String("0"+a).slice(-3)+":"+String("0"+o).slice(-2)}S.SumaTotalHorasExtra=e},S.GuardarAnticipos=function(e){var a=e.slice(-1).pop();a.montoExtraoridnario=a.total-a.anticipo_ordinaro,a.textoClase="EXTRAORDI",a.fecha=(new Date).getTime(),q(S.empleado.id,a).then(function(e){a={},S.cerrarDialogAnticipoExtraordinario(),S.mostrarMensaje(e.mensaje)})},S.GuardarAnticiposEmpleados=function(e){var i={};i.anticipos=e,i.textoClase="ORDI",i.fecha=(new Date).getTime(),i.anticipos.forEach(function(a,e,o){(a.montoordinario=a.monto+a.anticipo_ordinaro,e===o.length-1)&&W(i).then(function(e){a={},S.listaAnticipos2=[],S.cerrarDialogAnticipoRegular(),S.mostrarMensaje(e.mensaje)})})},S.buscarAnticiposExtraoridnario=function(e){S.anticipo_extraordinaro=0;var a=new Date(e.gestion,e.mes.id,1),o={inicio:new Date(a.getFullYear(),a.getMonth(),1),fin:new Date(a.getFullYear(),a.getMonth()+1,0),nombre:"ORDI",id_empresa:0};S.obtenerListaAnticipos(o,S.empleado.id)},S.buscarAnticiposOridnario=function(e){if(null!=e.gestion){S.anticipo_extraordinaro=0;var a=new Date(e.gestion,e.mes.id,1),o={inicio:new Date(a.getFullYear(),a.getMonth(),1),fin:new Date(a.getFullYear(),a.getMonth()+1,0),nombre:"EXTRAORDI",id_empresa:S.usuario.id_empresa};S.obtenerListaAnticiposOrdi(o,0)}},S.obtenerListaAnticipos=function(s,e){S.anticipo_ordinaroOextra=0;var a=Y(s,e);S.arregloid=[],a.then(function(n){0<n.anticipos.length?(n.anticipos.ordinarios=[],n.anticipos.extraordinarios=[],n.anticipos.forEach(function(e,a,o){if(e.empleado.ficha=e.empleado.empleadosFichas[e.empleado.empleadosFichas.length-1],e.total2=0,e.tipoAnticipo.nombre_corto!=s.nombre?n.anticipos.ordinarios.push(e):(S.anticipo_ordinaroOextra+=e.monto,n.anticipos.extraordinarios.push(e)),a===o.length-1)for(var i=0;i<n.anticipos.ordinarios.length;i++){var t=n.anticipos.ordinarios[i];if(0<n.anticipos.extraordinarios.length)for(var r=0;r<n.anticipos.extraordinarios.length;r++){(e=n.anticipos.extraordinarios[r]).id_empleado==t.id_empleado?(t.anticipo_ordinaro?t.anticipo_ordinaro+=e.monto:t.anticipo_ordinaro=e.monto,t.saldo_salario=t.salario_basico-t.total,t.montoEdit=!1):(t.anticipo_ordinaro=0,t.saldo_salario=t.salario_basico-t.total)}else t.anticipo_ordinaro=0,t.saldo_salario=t.salario_basico-t.total;i===n.anticipos.ordinarios.length-1&&(S.listaAnticipos=n.anticipos.ordinarios)}})):S.listaAnticipos=[]})},S.obtenerListaAnticiposOrdi=function(s,e){S.anticipo_ordinaroOextra=0,S.listaAnticipos=[];var a=Y(s,e);S.arregloid=[],a.then(function(n){0<n.anticipos.length?(n.anticipos.ordinarios=[],n.anticipos.extraordinarios=[],n.anticipos.forEach(function(e,a,o){if(e.empleado.ficha=e.empleado.empleadosFichas[e.empleado.empleadosFichas.length-1],e.total2=0,e.anticipo_extraordinaro=0,e.saldo_salario=e.salario_basico-e.total,e.tipoAnticipo.nombre_corto!=s.nombre?n.anticipos.ordinarios.push(e):n.anticipos.extraordinarios.push(e),a===o.length-1){null==S.anticiposDatos&&(S.anticiposDatos={ordinarios:n.anticipos.ordinarios,extraordinarios:n.anticipos.extraordinarios});for(var i=0;i<n.anticipos.ordinarios.length;i++){for(var t=n.anticipos.ordinarios[i],r=0;r<n.anticipos.extraordinarios.length;r++){(e=n.anticipos.extraordinarios[r]).id_empleado==t.id_empleado?(t.anticipo_extraordinaro?t.anticipo_extraordinaro+=e.monto:t.anticipo_extraordinaro=e.monto,t.saldo_salario=t.salario_basico-t.total,t.montoEdit=!1):(t.anticipo_ordinaro?t.anticipo_ordinaro+=e.monto:t.anticipo_ordinaro=e.monto,t.anticipo_extraordinaro=0,t.saldo_salario=t.salario_basico-t.total)}i===n.anticipos.ordinarios.length-1&&(S.listaAnticipos=n.anticipos.ordinarios)}}})):S.listaAnticipos=[]})},S.EliminarAnticipo=function(e){S.listaAnticipos2.splice(e,1)},S.AgregarAnticipoOrdinario=function(n){var s=n.monto,c=0,l=null;c=n.tope?n.tope:null,n.empleados.forEach(function(e,a,o){if(n.tipo&&(s=e.ficha.haber_basico*n.monto/100,l=n.monto),s=parseFloat(s.toFixed(2)),0==S.listaAnticipos2.length)var i={fecha:new Date,empleado:e,monto:s,anticipo_extraordinaro:null,total:null,salario_basico:e.ficha.haber_basico,saldo_salario:e.haber_basico,tope:c,tipo_porcentual:n.tipo,porcentaje:l};else(i={fecha:new Date,empleado:e,monto:s,anticipo_extraordinaro:null,total:null,salario_basico:e.ficha.haber_basico,saldo_salario:null,tope:c,tipo_porcentual:n.tipo,porcentaje:l}).saldo_salario=i.salario_basico-i.total;if(i.anticipo_extraordinaro=0,i.anticipo_ordinaro=0,S.anticiposDatos){if(0<S.anticiposDatos.ordinarios.length)for(var t=0;t<S.anticiposDatos.ordinarios.length;t++){var r=S.anticiposDatos.ordinarios[t];i.empleado.id==r.id_empleado&&(i.anticipo_ordinaro+=r.monto)}if(0<S.anticiposDatos.extraordinarios.length)for(t=0;t<S.anticiposDatos.extraordinarios.length;t++){r=S.anticiposDatos.extraordinarios[t];i.empleado.id==r.id_empleado&&(i.anticipo_extraordinaro+=r.monto)}}else i.anticipo_ordinaro=0,i.anticipo_extraordinaro=0;i.total=i.anticipo_extraordinaro+i.anticipo_ordinaro+i.monto,i.total2=i.anticipo_extraordinaro+i.anticipo_ordinaro+i.monto,i.saldo_salario=i.salario_basico-i.total,i.saldo_salario2=i.salario_basico-i.total,S.listaAnticipos2.push(i),a===o.length-1&&(S.cerrarDialogNuevoAnticipoRegularTodos(),S.anticipo={})})},S.AgregarAnticipoExtraordinario=function(){if(0==S.listaAnticipos.length){var e={fecha:new Date,monto:null,total2:S.anticipo_ordinaroOextra,anticipo_ordinaro:S.anticipo_ordinaroOextra,total:S.anticipo_ordinaroOextra,salario_basico:S.empleado.haber_basico,saldo_salario:S.empleado.haber_basico,empleado:S.empleado};S.listaAnticipos.push(e)}else{if(S.listaAnticipos[S.listaAnticipos.length-1].id)(e={fecha:new Date,monto:null,anticipo_ordinaro:S.anticipo_ordinaroOextra,total:S.listaAnticipos[S.listaAnticipos.length-1].total,salario_basico:S.empleado.haber_basico,saldo_salario:null,empleado:S.empleado}).saldo_salario=e.salario_basico-e.total,S.listaAnticipos.push(e);else S.mostrarMensaje("cuenta con 1 anticipo sin guardar!")}},S.sumarMontoPrestamoNuevo=function(e,a){1<S.listaAnticipos.length?e.monto?0<a&&S.listaAnticipos[a-1].empleado.id==S.listaAnticipos[a].empleado.id?e.total=S.listaAnticipos[a-1].total+e.monto:e.anticipo_ordinaro?e.total=e.monto+e.anticipo_ordinaro:e.total=e.monto+e.anticipo_extraordinaro:e.anticipo_ordinaro?e.total=e.anticipo_ordinaro:e.total=e.anticipo_extraordinaro:(e.total2=e.anticipo_ordinaro,e.monto?e.total=e.total2+e.monto:e.anticipo_ordinaro?e.total=e.anticipo_ordinaro:e.total=e.anticipo_extraordinaro),e.saldo_salario=e.salario_basico-e.total},S.sumarMontoPrestamoNuevo2=function(e){e.total=e.anticipo_extraordinaro+e.monto+e.anticipo_ordinaro,e.saldo_salario=e.salario_basico-e.total},S.ActualizarAnticipo=function(a){a.montoExtraoridnario=a.total-a.anticipo_ordinaro,J(a.id_empleado,a).then(function(e){a.montoEdit=!1,S.cerrarDialogAnticipoExtraordinario(),S.mostrarMensaje(e.mensaje)})},S.ActualizarAnticipoOrdi=function(a){if(a.anticipo_ordinaro=0,S.anticiposDatos&&0<S.anticiposDatos.ordinarios.length)for(var e=0;e<S.anticiposDatos.ordinarios.length;e++){var o=S.anticiposDatos.ordinarios[e];a.empleado.id==o.id_empleado&&a.id!=o.id&&(a.anticipo_ordinaro+=o.monto)}a.montoExtraoridnario=a.total-a.anticipo_extraordinaro,J(a.id_empleado,a).then(function(e){a.montoEdit=!1,S.cerrarDialogAnticipoExtraordinario(),S.mostrarMensaje(e.mensaje)})},S.cancelarEdicionAnticipo=function(){S.obtenerAnticiposExtra(S.empleado)},S.cancelarEdicionAnticipo=function(){S.obteneranticiposOrdi()},S.imprimirAnticipoRegular=function(e,a){var o=new PDFDocument({compress:!1,size:"letter",margin:10}),i=o.pipe(blobStream()),t=205,r=0,n=1,s=Math.ceil(e.length/18);S.DibujarCabeceraPDFAnticipoRegular(o,n,s,e,a),o.font("Helvetica",10);for(var c=0;c<e.length&&r<=18;c++)anticipo=e[c],o.text(c+1,45,t),o.text(anticipo.empleado.codigo,80,t,{width:70}),o.text(anticipo.empleado.persona.nombre_completo,200,t,{width:100}),o.text(anticipo.monto,320,t,{width:100}),o.text(anticipo.empleado.ficha.banco.nombre,400,t,{width:100}),o.text(".......... ",500,t+2,{width:100}),t+=30,18==++r&&(o.addPage({margin:0,bufferPages:!0}),t=205,r=0,n+=1,S.DibujarCabeceraPDFAnticipoRegular(o,n,s,e,a),o.font("Helvetica",10));o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),E.stop()},S.DibujarCabeceraPDFAnticipoRegular=function(t,r,n,e,s){var c=0,l=0,d=!1,u=0,p=!1,m=!1,f=0,g=0,v="",h="";e.forEach(function(e,a,o){if(0==a?(c=e.tope,l=e.tipo_porcentual,g=e.porcentaje,v=S.fechaATexto(e.fecha)):(e.tope!=c&&(d=!0),e.tipo_porcentual!=l&&(p=!0),S.fechaATexto(e.fecha)!=v&&(m=!0)),a===o.length-1){f=p?"Diferentes tipos":l=l?"Porcentual "+g+"%":"Monto",h=m?"Diferentes fechas":v,u=null==(u=d?"Diferentes Topes":c)?"Sin restricción":u,t.font("Helvetica-Bold",14),t.text("LISTA DE ANTICIPOS",0,45,{align:"center"}),t.font("Helvetica-Bold",12),t.text("PERIODO : ",45,100),t.text("FECHA DE CREACIÓN : ",45,120),t.text("USUARIO : ",45,140),t.text("TIPO DE ANTICIPO : ",45,160),t.text("TOPE: ",345,160),t.font("Helvetica",12),h instanceof Date&&(h=S.fechaATexto(h)),t.fillColor("blue"),t.text(h,185,120),t.text(S.usuario.persona.nombre_completo,115,140),t.text(s.mes.nombre+" "+s.gestion,115,100),t.text(f,175,160),t.text(u,385,160),t.fillColor("black"),t.font("Helvetica-Bold",12),t.text("Nro.",45,180),width=t.widthOfString("Nro."),height=t.currentLineHeight(),t.underline(45,181,width,height),t.text("Cod. Emp.",80,180),width=t.widthOfString("Cod. Emp."),height=t.currentLineHeight(),t.underline(80,181,width,height),t.text("Nombre",200,180),width=t.widthOfString("Nombre"),height=t.currentLineHeight(),t.underline(200,181,width,height),t.text("Monto",320,180),width=t.widthOfString("Monto"),height=t.currentLineHeight(),t.underline(320,181,width,height),t.text("Mod. ",400,180),width=t.widthOfString("Mod"),height=t.currentLineHeight(),t.underline(400,181,width,height),t.text("Firma. ",500,180),width=t.widthOfString("Firma"),height=t.currentLineHeight(),t.underline(500,181,width,height),t.font("Helvetica",8);var i=new Date;t.text("USUARIO: "+S.usuario.persona.nombre_completo+" fecha "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+"Hrs."+i.getHours()+":"+i.getMinutes(),15,765),t.text("PÁGINA "+r+" DE "+n,0,740,{align:"center"})}})},S.listaBancos=function(){S.anticiposSeleccionados=[],S.anticiposTr3=[];var e=ne(S.usuario.id_empresa);S.arregloBancosUnion="",S.arregloBancosMsc="";e.then(function(t){S.datosBancos=t,S.bancos=[],t.forEach(function(e,a,o){e.cuentas=[],0==a&&S.bancos.push(e);for(var r=!1,i=0;i<S.bancos.length;i++){S.bancos[i].nombre==e.nombre&&(r=!0),i===S.bancos.length-1&&0==r&&S.bancos.push(e)}a===o.length-1&&t.forEach(function(e,a,o){for(var i=0;i<S.bancos.length;i++){var t=S.bancos[i];t.nombre==e.nombre&&(r=!0,t.cuentas.push(e),i=S.bancos.length)}})})})},S.imprimirTr3=function(r,n){for(var e=new Date(r.fecha),s=e.getMonth(),c=e.getDate(),l="",a=0;a<S.meses.length;a++){var o=S.meses[a];s==o.id&&(l=o.nombre)}s=s<10?"0"+s:s,c=c<10?"0"+c:c,anio=e.getFullYear();var d=[],u=0;r.historialtr3.forEach(function(e,a,o){if(u+=e.anticipo.monto,d.push(e.anticipo),a===o.length-1){var i={anticipos:d,tipo:n,tr3Encontrado:r,total:u};if("MSC"==n)var t=i.tr3Encontrado.planilla+""+c+(s+1)+anio+i.tr3Encontrado.numero_planilla+".tr3";else t="SUELDO"+l+anio+"BUNION.tr3";S.descargarArchivo(S.generarTexto(i),t)}})},S.imprimirCartaTr3=function(r,n){for(var s=[],c=0,e=new Date(r.fecha),l=e.getMonth()+1,d=e.getDate(),a=0;a<S.meses.length;a++){var o=S.meses[a];l==o.id&&o.nombre}l=l<10?"0"+l:l,d=d<10?"0"+d:d,anio=e.getFullYear(),r.historialtr3.forEach(function(e,a,o){if(c=e.anticipo.monto,s.push(e.anticipo),a===o.length-1){var i={anticipos:s,tipo:n,tr3Encontrado:r,total:c};if("MSC"==n)var t=i.tr3Encontrado.planilla+""+d+l+anio+i.tr3Encontrado.numero_planilla+".txt";else t=i.tr3Encontrado.planilla+""+d+l+anio+i.tr3Encontrado.numero_planilla+".txt";S.descargarArchivo(S.generarTextoCarta(i),t)}})},S.guardarTr3Empleado=function(d){d.fecha=new Date;var i=[];0<d.anticipos.length&&d.anticipos.forEach(function(e,a,o){(bandera=!1,S.datosBanco.nombre.toUpperCase()==e.empleado.empleadosFichas[e.empleado.empleadosFichas.length-1].banco.nombre&&(bandera=!0),bandera&&i.push(e),a===o.length-1)&&(d.anticipos=i,le(d,S.usuario.id_empresa).then(function(e){for(var a=new Date(e.tr3Encontrado.fecha),o=a.getMonth()+1,i=a.getMonth(),t=a.getDate(),r="",n=0;n<S.meses.length;n++){var s=S.meses[n];i==s.id&&(r=s.nombre)}if(o=o<10?"0"+o:o,t=t<10?"0"+t:t,anio=a.getFullYear(),S.cerrarModalTr3BancoMsc(),S.cerrarModalTr3BancoUnion(),S.buscarAnticiposOridnario(S.filtroAnticipo),"MSC"==d.tipo)var c=e.tr3Encontrado.planilla+""+t+o+anio+e.tr3Encontrado.numero_planilla+".tr3",l=e.tr3Encontrado.planilla+""+t+o+anio+e.tr3Encontrado.numero_planilla+".txt";else c="SUELDO"+r+anio+"BUNION.tr3",l=e.tr3Encontrado.planilla+""+t+o+anio+".txt";S.descargarArchivo(S.generarTexto(e),c),S.descargarArchivo(S.generarTextoCarta(e),l),S.mostrarMensaje(e.mensaje)}))})},S.descargarArchivo=function(e,i){var a=new FileReader;a.onload=function(e){var a=document.createElement("a");a.href=e.target.result,a.target="_blank",a.download=i||"archivo.dat";var o=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});a.dispatchEvent(o),(window.URL||window.webkitURL).revokeObjectURL(a.href)},a.readAsDataURL(e)},S.generarTextoCarta=function(e){for(var a=new Date(e.tr3Encontrado.fecha),o=a.getMonth()+1,i=a.getDate(),t="",r=0;r<S.meses.length;r++){var n=S.meses[r];o-1===n.id&&(t=n.nombre)}o=o<10?"0"+o:o,i=i<10?"0"+i:i,anio=a.getFullYear();var s=ConvertirALiteral(e.total.toFixed(2)),c=[];if("MSC"==e.tipo){var l="\r\n\r\n"+e.tr3Encontrado.departamento.nombre+" "+i+" de "+t+" del "+anio+"\r\nNro Cite: ESS-P-29/18\r\n\r\n\r\nSeñores \r\n"+e.tr3Encontrado.cuenta.nombre+"\r\nCiudad\r\n\r\nRef.: Orden de Pago\r\n\r\nDe nuestra consideración:\r\n\r\nMediante la presente y según contrato suscrito con el Banco Mercantil Santa Cruz S.A.,\r\nautorizamos a ustedes realizar el débito por el valor total de Bs. "+e.total+"\r\n("+s+")\r\ncorrespondiente a la cancelación de la planilla de pago(s), de acuerdo al siguiente detalle:\r\n\r\n* Cuenta de débito Nro:                 "+e.tr3Encontrado.cuenta.numero+"\r\n* Cuenta Pago de Planilla:              "+e.tr3Encontrado.planilla+"\r\n* Nombre del archivo:                   "+e.tr3Encontrado.planilla+i+o+anio+e.tr3Encontrado.numero_planilla+".tr3\r\n* Código de control:                     87fd35e019787f9612a4ffb9fc2cb415\r\n* Nombre / Número de planilla:  "+e.tr3Encontrado.nombre_planilla+"\r\n* Monto total de débito:                 Bs "+e.total+"\r\n\r\nLos datos apuntados anteriormente y el detalle de pagos, se encuentran en el archivo \r\n"+e.tr3Encontrado.planilla+i+o+anio+e.tr3Encontrado.numero_planilla+".tr3, adjunto a la presente carta.\r\n\r\n Si, a los efectos de la presente, fuera necesario realizar compra venta de moneda nacional\r\no extranjera,  también  autorizamos e instruimos  realizar las operaciones  necesarias  para\r\ncumplir  con  lo  instruido,  de  tal  manera  que se realicen  los abonos  en  la moneda  que\r\ncorresponda a cada cuenta beneficiaria.\r\nde "+t+" Debo informar lo siguiente:\r\nEl origen de los fondos corresponde al "+e.tr3Encontrado.origen_fondos+".\r\nEl Destino de los Fondos, "+e.tr3Encontrado.destino_fondos+".\r\n\r\nAgradecemos su gentil atención a esta solicitud.\r\n\r\nAtentamente\r\n\r\n\r\n\r\n"+e.tr3Encontrado.firma_uno+"                                 "+e.tr3Encontrado.firma_tres+"\r\n"+e.tr3Encontrado.firma_dos+"                                             "+e.tr3Encontrado.firma_cuatro+"\r\n\r\n\r\nAdj. Lo citado";return c.push(l),new Blob(c,{type:"text/plain"})}if("BU"==e.tipo){l="\r\n\r\nSanta Cruz "+i+" de "+t+" de "+anio+"\r\nESS-P-30/18\r\nSeñores:\r\nBANCO UNION  S.A.\r\nAtn.:"+e.tr3Encontrado.dirigido_para+"\r\n"+e.tr3Encontrado.cargo+"\r\nPresente.-\r\n\r\n\t\t\t\tRef.: Autorización para Abono de  Sueldos "+t+" "+anio+"\r\n\r\nMediante la presente solicitamos debiten de nuestra cuenta corriente No."+e.tr3Encontrado.cuenta.numero+"\r\nel importe total de Bs."+e.total+"("+s+")\r\n, y el concepto de comisiones debitar de nuestra cuenta.\r\n\r\nSe ha realizado la verificación de nuestro extracto de cuenta  No."+e.tr3Encontrado.cuenta.numero+", tenemos saldo suficiente lo cual cubre el importe requerido.\r\n\r\nEnviamos planilla detallada adjunta.\r\n\r\nde "+t+" Debo informar lo siguiente:\r\n\r\n"+e.tr3Encontrado.origen_fondos+"\r\n"+e.tr3Encontrado.destino_fondos+".\r\n\r\nAgradeciendo de antemano su pronta respuesta vía mail, saludo a Usted cordialmente.\r\n\r\nAtentamente,\r\n\r\n\r\n\r\n\r\n\r\n\t\t"+e.tr3Encontrado.firma_uno+"\t\t\t\t"+e.tr3Encontrado.firma_tres+"\r\n\t"+e.tr3Encontrado.firma_dos+"\t\t\t\t\t\t"+e.tr3Encontrado.firma_cuatro+"\r\n";return c.push(l),new Blob(c,{type:"text/plain"})}},S.generarTexto=function(i){var t=[];if("MSC"==i.tipo){i.tr3Encontrado.nombre_archivo;var e=S.fechaATexto(i.tr3Encontrado.fecha);if(i.tr3Encontrado.historialtr3)var r=S.fechaATexto(i.tr3Encontrado.historialtr3[0].anticipo.fecha);else r=S.fechaATexto(i.anticipos[0].fecha);var n=i.tr3Encontrado.planilla+"|"+i.tr3Encontrado.cuenta.numero+"|0|"+i.tr3Encontrado.nombre_planilla+"|"+r+"|"+e+"|"+i.total+"|"+i.tr3Encontrado.numero_planilla+"\r\n";return i.anticipos.forEach(function(e,a,o){e.empleado.empleadosFichas&&(e.empleado.ficha=e.empleado.empleadosFichas[0]),r=S.fechaATexto(e.fecha),n+=a+1+"|"+e.empleado.persona.nombre_completo+"|"+e.empleado.ficha.numero_cuenta+"|"+r+"|"+i.tr3Encontrado.numero_planilla+"|"+e.monto+"|||"+i.tr3Encontrado.nombre_archivo+"\r\n",a===o.length-1&&t.push(n)}),new Blob(t,{type:"text/plain"})}if("BU"==i.tipo){for(var a=(r=new Date(i.tr3Encontrado.fecha)).getMonth()+1,o=r.getMonth(),s=r.getDate(),c="",l=0;l<S.meses.length;l++){var d=S.meses[l];o==d.id&&(c=d.nombre)}a=a<10?"0"+a:a,s=s<10?"0"+s:s;n="SUELDOS  "+c+"  "+r.getFullYear()+"      "+i.tr3Encontrado.planilla+s+a+r.getFullYear()+"\r\n";return n+=i.tr3Encontrado.cuenta.numero+""+i.total+"\r\n",i.anticipos.forEach(function(e,a,o){e.empleado.empleadosFichas&&(e.empleado.ficha=e.empleado.empleadosFichas[0]),r=S.fechaATexto(e.fecha),n+=e.empleado.ficha.numero_cuenta+""+e.monto+"\r\n",a===o.length-1&&t.push(n)}),new Blob(t,{type:"text/plain"})}},S.selecionarAnticipos=function(e,a,o){e&&(0==e.select?(S.anticiposSeleccionados.splice(S.anticiposSeleccionados.indexOf(e)),0==e.entregado&&S.anticiposTr3.splice(S.anticiposTr3.indexOf(e))):(S.anticiposSeleccionados.push(e),0==e.entregado&&S.anticiposTr3.push(e),console.log(S.empleadosSeleccionados))),1==o?(S.anticiposSeleccionados=[],a&&a.forEach(function(e,a,o){e.select=!0,S.anticiposSeleccionados.push(e),0==e.entregado&&S.anticiposTr3.push(e)})):0==o&&(a.forEach(function(e,a,o){e.select=!1}),S.anticiposSeleccionados=[],S.anticiposTr3=[])},S.obtenertiposAusenciaMedica=function(){S.tiposAusenciasMedicas=[],E.start(),he("RRHH_AUSMED",S.usuario.id_empresa).then(function(e){S.tiposAusenciasMedicas=e,E.stop()})},S.obtenerTiposOtrasAusencias=function(){S.tiposOtrasAusencias=[],E.start(),he("RRHH_OTRAUS",S.usuario.id_empresa).then(function(e){S.tiposOtrasAusencias=e,E.stop()})},S.CalcularDiferenciaDias=function(e,a){if(a){if(e.fecha_inicio&&e.fecha_fin){var o=new Date(S.convertirFecha(e.fecha_inicio)),i=new Date(S.convertirFecha(e.fecha_fin));o.setMinutes(e.fecha_inicio_hora.getMinutes()),o.setHours(e.fecha_inicio_hora.getHours()),i.setMinutes(e.fecha_fin_hora.getMinutes()),i.setHours(e.fecha_fin_hora.getHours());var t=moment('"'+o.getFullYear()+"-"+o.getMonth()+"-"+o.getDate()+" "+o.getHours()+":"+o.getMinutes()+":00","YYYY-MM-DD HH:mm:ss"),r=moment('"'+i.getFullYear()+"-"+i.getMonth()+"-"+i.getDate()+" "+i.getHours()+":"+i.getMinutes()+":00","YYYY-MM-DD HH:mm:ss");r.diff(t,"d");e.horas=convertirSegundosATiempo(r.diff(t,"s"))}}else if(e.fecha_inicio&&e.fecha_fin){o=new Date(S.convertirFecha(e.fecha_inicio)),i=new Date(S.convertirFecha(e.fecha_fin));var n=S.diferenciaEntreDiasEnDias(o,i);0==n&&(n=1)}e.primera_baja?(e.dias=n-e.tipo.dias_descuento,e.dias_reales=n):e.dias=n},S.crearNuevaAusencia=function(e,a){if(1==a){var o=parseInt(S.SumaTotalHoras.split(":")[1]),i=parseInt(S.SumaTotalHoras.split(":")[0]),t=parseInt(e.horas.split(":")[1]),r=parseInt(e.horas.split(":")[0]);i<r?(e.fecha_inicio=new Date(S.convertirFecha(e.fecha_inicio)),e.fecha_fin=new Date(S.convertirFecha(e.fecha_fin)),e.fecha_inicio.setMinutes(e.fecha_inicio_hora.getMinutes()),e.fecha_inicio.setHours(e.fecha_inicio_hora.getHours()),e.fecha_fin.setMinutes(e.fecha_fin_hora.getMinutes()),e.fecha_fin.setHours(e.fecha_fin_hora.getHours()),e.compensaciones=S.selectionday,S.guardarAusencia(S.empleado.id_ficha,e)):i==r&&o<=t?(e.fecha_inicio=new Date(S.convertirFecha(e.fecha_inicio)),e.fecha_fin=new Date(S.convertirFecha(e.fecha_fin)),e.fecha_inicio.setMinutes(e.fecha_inicio_hora.getMinutes()),e.fecha_inicio.setHours(e.fecha_inicio_hora.getHours()),e.fecha_fin.setMinutes(e.fecha_fin_hora.getMinutes()),e.fecha_fin.setHours(e.fecha_fin_hora.getHours()),e.compensaciones=S.selectionday,S.guardarAusencia(S.empleado.id_ficha,e)):S.mostrarMensaje("La suma del total de horas compensacion es mayor al total de horas de la ausencia!")}else e.fecha_inicio=new Date(S.convertirFecha(e.fecha_inicio)),e.fecha_fin=new Date(S.convertirFecha(e.fecha_fin)),S.guardarAusencia(S.empleado.id_ficha,e)},S.guardarAusencia=function(e,a){X(e,a).then(function(e){S.ausencia={},S.cerrarDialogAusenciasVacaciones(),S.selectionday=[],S.SumaTotalHoras="",S.calendarCompensacion.fullCalendar("removeEvents"),S.mostrarMensaje(e.mensaje)})},S.obtenerHistorialEmpleadoAusenciasMedicas=function(e){S.historialEmpleadoAusencias=[],null!=e.tipo_ausencia&&null!=e.tipo_ausencia||(e.tipo_ausencia=0);var a={inicio:0,fin:0,tipo_ausencia:e.tipo_ausencia};e&&e.inicio&&(a.inicio=new Date(S.convertirFecha(e.inicio)),a.fin=new Date(S.convertirFecha(e.fin))),K(S.empleado.id_ficha,a,"RRHH_AUSMED").then(function(i){i.forEach(function(e,a,o){e.primera_baja?e.baja="Si":e.baja="No",a===o.length-1&&(S.historialEmpleadoAusencias=i)})})},S.obtenerHistorialEmpleadoOtrasAusencias=function(e){null!=e.tipo_ausencia&&null!=e.tipo_ausencia||(e.tipo_ausencia=0);var a={inicio:0,fin:0,tipo_ausencia:e.tipo_ausencia};e.inicio&&(a.inicio=new Date(S.convertirFecha(e.inicio)),a.fin=new Date(S.convertirFecha(e.fin))),K(S.empleado.id_ficha,a,"RRHH_OTRAUS").then(function(e){S.historialEmpleadoOtrasAusencias=e})},S.obtenerHistorialEmpresaAusenciasMedicas=function(e){null!=e.tipo_ausencia&&null!=e.tipo_ausencia||(e.tipo_ausencia=0);var a={inicio:0,fin:0,tipo_ausencia:e.tipo_ausencia};e.inicio&&(a.inicio=new Date(S.convertirFecha(e.inicio)),a.fin=new Date(S.convertirFecha(e.fin))),Z(S.usuario.id_empresa,a,"RRHH_AUSMED").then(function(e){S.historialEmpresaAusencias=e})},S.obtenerHistorialEmpresaOtrasAusencias=function(e){null!=e.tipo_ausencia&&null!=e.tipo_ausencia||(e.tipo_ausencia=0);var a={inicio:0,fin:0,tipo_ausencia:e.tipo_ausencia};e.inicio&&(a.inicio=new Date(S.convertirFecha(e.inicio)),a.fin=new Date(S.convertirFecha(e.fin))),Z(S.usuario.id_empresa,a,"RRHH_OTRAUS").then(function(e){S.historialEmpresaOtrasAusencias=e})},S.agregarTipoAusencia=function(e,a){1==e.edit?S.guardarModificado(e):a.push(e)},S.ModificarTipoAusencia=function(e){S.clase={},e.edit=!0,S.clase=e},S.guardarModificado=function(e){e.edit=!1,S.clase={}},S.guardarClasesAusencias=function(e,a){te(e,a).then(function(e){S.cerrarDialogTipoBaja(),S.cerrarDialogTipoAusencia(),S.obtenertiposAusenciaMedica(),S.obtenerTiposOtrasAusencias(),S.mostrarMensaje(e.mensaje)})},S.obtenerConfiguracionVacaciones=function(){se().then(function(e){S.configuracionesVacacion=e})},S.obtenerHistorialGestionesVacacion=function(n,s,c){ce(n.id_ficha).then(function(e){S.historialGestionesVacacion=e;var a=new Date;n.fecha_Retiro_beneficio&&(a=new Date(n.fecha_Retiro_beneficio));var o=new Date(n.fecha_inicio),i=S.diferenciaEntreDiasEnDias(o,a),t=Math.round(i/365);if(S.vacacion.aniosDisponibles=t,S.vacacion.historial=S.historialGestionesVacacion,S.diasDisponibles=0,S.historialGestionesVacacion.forEach(function(e,a,o){e.anio<=t&&(S.diasDisponibles+=e.aplicadas-e.tomadas)}),365<i?(S.usarVacacion=!0,s&&S.abrirPopup(S.idModalAusenciasVacaciones)):(S.usarVacacion=!1,s&&(S.abrirPopup(S.idModalAusenciasVacaciones),setTimeout(function(){S.$apply(function(){S.mostrarMensaje("El empleado no cuenta con la antiguedad para asignar vacaciones")})},2e3))),c){var r=new Date(S.empleado.fecha_expiracion).getFullYear();S.beneficio.totalV=0,S.historialGestionesVacacion.forEach(function(e,a,o){if(e.gestion<r)e.tomadas<e.aplicadas&&(S.beneficio.totalV+=e.aplicadas-e.tomadas,S.beneficio.anios++);else if(e.gestion==r){S.beneficio.meses=S.tiempoTrabajado.meses,S.beneficio.dias=S.tiempoTrabajado.dias;var i=S.beneficio.meses*(e.aplicadas-e.tomadas)/12;S.beneficio.totalV+=i;var t=S.beneficio.dias*(e.aplicadas-e.tomadas)/365;S.beneficio.totalV+=t,0==S.beneficio.meses?(S.beneficio.anios++,e.gestion<=r&&e.tomadas<e.aplicadas&&(S.beneficio.totalV+=e.aplicadas-e.tomadas)):S.beneficio.anios--,S.beneficio.totalV=Math.round(S.beneficio.totalV)}})}})},S.agregarConceptoEdicion=function(e){e.nombre&&e.nombre_corto&&(-1==S.tipo_edicion.clases.indexOf(e)&&S.tipo_edicion.clases.push(e),S.clase={})},S.agregarConductor=function(e){e.habilitado=!0,S.choferesViaje.push(e),S.conductor={}},S.editarConductor=function(e){S.conductor=e},S.filtrarConductor=function(e){S.tipoConductor=e?{id_empleado:e}:{}},S.guardarConductores=function(){Be(S.usuario.id_empresa,S.choferesViaje).then(function(e){S.mostrarMensaje(e.mensaje),S.obtenerChoferesViaje(),S.cerrarDialogConductoresViaje()})},S.modificarConceptoEdicion=function(e){S.clase=e},S.modificarConceptoEdicionVehiculo=function(e){var a=e.nombre.split("-");e.vehiculo=a[0],e.placa=a[1],S.clase=e},S.removerConceptoEdicion=function(e){e.eliminado=!0},S.guardarConceptoEdicion=function(a){E.start(),re.update({id_tipo:a.id},a,function(e){C(a.nombre_corto).then(function(e){a=e,E.stop(),S.cerrarDialogConceptoEdicion(),S.mostrarMensaje("Guardado Exitosamente!")})})},S.guardarConceptoEdicionVehiculo=function(a){E.start(),re.update({id_tipo:a.id},a,function(e){C(a.nombre_corto).then(function(e){a=e,E.stop(),S.cerrarDialogVehiculosViaje(),S.mostrarMensaje("Guardado Exitosamente!")})})},S.CalcularDiferenciaDiasVacacion=function(t){t.dias=0,t.dias_descuento=0,t.domingos=0,t.sabados=0;var e=t.fecha_inicio,a=t.fecha_fin;if(e&&(e=new Date(S.convertirFecha(e))),a&&(a=new Date(S.convertirFecha(a))),e&&a){if(9<=t.fecha_inicio.length&&9<=t.fecha_fin.length)var o=getDates(e,a);o.forEach(function(e,a,o){var i;t.sabado?(0==(i=new Date(e)).getDay()&&(t.domingos+=1),-1!=S.ListaDiasFeriado.indexOf(e)&&(t.dias_descuento+=1),a===o.length-1&&S.CalcularDiferenciaDiasV(t)):(0==(i=new Date(e)).getDay()&&(t.domingos+=1),6==i.getDay()&&(t.sabados+=1),-1!=S.ListaDiasFeriado.indexOf(e)&&(t.dias_descuento+=1),a===o.length-1&&S.CalcularDiferenciaDiasV(t))})}},S.CalcularDiferenciaDiasV=function(e){if(e.fecha_inicio&&e.fecha_fin){var a=new Date(S.convertirFecha(e.fecha_inicio)),o=new Date(S.convertirFecha(e.fecha_fin)),i=S.diferenciaEntreDiasEnDias(a,o);0==i&&(i=1),e.dias=i+1-(e.dias_descuento+e.domingos+e.sabados),e.inicio_tipo||e.fin_tipo?e.inicio_tipo&&!e.fin_tipo?e.dias=e.dias-.5:!e.inicio_tipo&&e.fin_tipo?e.dias=e.dias-.5:e.inicio_tipo&&e.fin_tipo&&(e.dias=e.dias):e.dias=e.dias-1;var t=(new Date).setTime(new Date(S.convertirFecha(e.fecha_fin)).getTime()+864e5);e.fecha_Retorno=e.fin_tipo?S.fechaATexto(t):e.fecha_fin,e.dias_reales=i+1}},S.crearNuevaVacacion=function(a){a.dias<=S.diasDisponibles?(a.fecha_inicio=new Date(S.convertirFecha(a.fecha_inicio)),a.fecha_fin=new Date(S.convertirFecha(a.fecha_fin)),Q(S.empleado.id_ficha,a).then(function(e){S.imprimirReciboVacacion(a,S.empleado.nombre_completo,S.empleado.fecha_inicio,e.gestiones,e.restantes),S.cerrarDialogAusenciasVacaciones(),S.mostrarMensaje(e.mensaje)})):S.mostrarMensaje("El empleado solo cuenta con "+S.diasDisponibles+" dias disponbles para asignar vacaciones")},S.obtenerHistorialEmpleadVacacion=function(e){var a={inicio:0,fin:0};e.inicio&&(a.inicio=new Date(S.convertirFecha(e.inicio)),a.fin=new Date(S.convertirFecha(e.fin))),ee(S.empleado.id_ficha,a).then(function(e){S.historialEmpleadoVacaciones=e})},S.obtenerHistorialEmpresaVacacion=function(e){var a={inicio:0,fin:0,estado:2};e.inicio&&(a.inicio=new Date(S.convertirFecha(e.inicio)),a.fin=new Date(S.convertirFecha(e.fin))),e.estado&&(a.estado=e.estado),ae(S.usuario.id_empresa,a).then(function(r){r.forEach(function(e,a,o){for(var i=e.diasRestantes=0;i<e.ficha.historialVacaciones.length;i++){var t=e.ficha.historialVacaciones[i];e.diasRestantes+=t.aplicadas-t.tomadas}a===o.length-1&&(S.historialEmpresaVacaciones=r)})})},S.selecionarEmpleados=function(e,a,o){o?(S.paginator.itemsPerPage="0",S.empleadosSeleccionados=[]):S.paginator.itemsPerPage="10",a?S.buscarRecursosHumanos(!0,e,a,o):0==e.select?(e.select=!1,S.empleadosSeleccionados.splice(S.empleadosSeleccionados.indexOf(e))):(e.select=!0,S.empleadosSeleccionados.push(e),console.log(S.empleadosSeleccionados))},S.generarExcelEmpleados=function(e,a){for(var o=[["N°","ACTIVO","CODIGO","NOMBRE COMPLETO","EMPLEADO","CI","EXTENCÓN","TIPO CONTRATO","CAMPO","CARGO"]],i=[],t=0;t<e.length;t++){var r=[];r.push(t+1),r.push(e[t].eliminado),r.push(e[t].codigo),r.push(e[t].nombre_completo),r.push(e[t].designacion_empresa),r.push(e[t].ci),r.push(e[t].extension),r.push(e[t].tipoContrato),r.push(e[t].campo);var n=e[t].cargos;i.push(t),r.push(n),o.push(r)}var s=new Workbook,c=sheet_from_array_of_arrays(o);s.SheetNames.push("SheetJS"),s.Sheets.SheetJS=c;var l=XLSX.write(s,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"EMPLEADO RRHH.xlsx"),E.stop()},S.obtenerGestiones=function(){E.start(),C("GTN").then(function(e){S.gestiones=e.clases,E.stop()})},S.abrirModalVerificarCuentaRrhh=function(e){S.empleado=e,S.abrirPopup(S.IdModalVerificarCuentaRrhh)},S.cerrarModalVerificarCuentaRrhh=function(e){e&&(S.empleado.activo=1!=S.empleado.activo),S.cerrarPopup(S.IdModalVerificarCuentaRrhh)},S.abrirModalVerificacion=function(e){1==e.activo?(S.funcionCerrar=S.cerrarModalReingresoEmpleado,S.funcionArealizar=S.ActivarCuentaRrhh,S.abrirModalVerificarCuentaRrhh(e)):(S.funcionCerrar=S.cerrarMensajeConfirmacion,S.funcionArealizar=S.verificarCuentaAdminRrhh,S.abrirModalVerificarCuentaRrhh(e),setTimeout(function(){aplicarDatePickers()},300))},S.abrirMensajeConfirmacion=function(e){S.cuenta=e,S.abrirPopup(S.idModalConfirmarDesabilitacion)},S.abrirModalReingresoEmpleado=function(){S.abrirPopup(S.idModalReingresoEmpleado)},S.cerrarModalReingresoEmpleado=function(e){e&&(S.empleado.activo=1!=S.empleado.activo),S.cerrarPopup(S.idModalReingresoEmpleado),S.empleado.tipoReincorporacion&&"NREING"==S.empleado.tipoReincorporacion.nombre_corto&&S.abrirDialogEmpleado(S.empleado)},S.cerrarMensajeConfirmacion=function(e){e&&(S.empleado.activo=1!=S.empleado.activo),S.cerrarPopup(S.idModalConfirmarDesabilitacion)},S.verificarCuentaAdminRrhh=function(a){N.save({id_empresa:S.usuario.id_empresa},a,function(e){e.type?(a.fecha?S.empleado.nueva_fecha_expiracion=new Date(S.convertirFecha(S.cuenta.fecha)):S.empleado.nueva_fecha_expiracion=null,S.empleado.motivo_retiro=S.cuenta.motivo_retiro,S.abrirMensajeConfirmacion(a),S.cerrarModalVerificarCuentaRrhh()):S.mostrarMensaje(e.message)})},S.ActivarCuentaRrhh=function(a){N.save({id_empresa:S.usuario.id_empresa},a,function(e){e.type?(S.empleado.nueva_fecha_expiracion=null,S.abrirModalReingresoEmpleado(a),S.cerrarModalVerificarCuentaRrhh()):S.mostrarMensaje(e.message)})},S.changeActivoEmpleado=function(a){a.activo=0==a.activo,u(a).then(function(e){S.funcionCerrar(),S.cuenta={},S.mostrarMensaje(e.mensaje),a.tipoReincorporacion?(a.activo=0==a.activo,"NREING"==a.tipoReincorporacion.nombre_corto?(S.primeroGuardarParaCerrar=!0,S.obtenerRecursosHumanos(),S.abrirDialogEmpleado(a,!0)):S.obtenerRecursosHumanos()):S.obtenerRecursosHumanos()})},S.EliminarUsuarioRh=function(e){e.activo&&(e.activo=!1,S.abrirModalVerificacion(e))},S.obtenerTiposBaja=function(){E.start(),he("RRHH_TPRE",S.usuario.id_empresa).then(function(e){S.tiposBajas=e,E.stop()})},S.obtenerTiposOtrosingresosYDeduccion=function(){E.start(),he("RRHH_TPDOI",S.usuario.id_empresa).then(function(e){S.tiposOtrosingresosYDeduccion=e,S.tiposOtrosingresosYDeduccion.clases.forEach(function(e,a,o){"OTRING"==e.nombre_corto?S.tipoOtrosIngresos=e:S.tipoDeducciones=e}),E.stop()})},S.obtenerMotivosRetiro=function(){E.start(),he("RRHH_TPMR",S.usuario.id_empresa).then(function(e){S.tipoMotivo=e,E.stop()})},S.agregarOtroIngreso=function(e){e.tipo=S.tipoOtrosIngresos,S.beneficio.ingresos.push(e),S.ingreso={motivo:"",monto:""},S.sumartotalOtrosIngresos(S.beneficio)},S.eliminarOtroIngreso=function(e,a){a.id?(a.eliminado=!0,a.motivo=""):(S.beneficio.ingresos.splice(e,1),S.sumartotalOtrosIngresos(S.beneficio))},S.agregarDeduccion=function(e){e.tipo=S.tipoDeducciones,S.beneficio.deducciones.push(e),S.deduccion={motivo:"",monto:""},S.sumarTotalDeducciones(S.beneficio)},S.sumarTotalDeducciones=function(i){i.total_deducciones=0,i.deducciones.forEach(function(e,a,o){i.total_deducciones+=e.monto})},S.eliminarDeduccion=function(e,a){a.id?(a.eliminado=!0,a.motivo=""):(S.beneficio.deducciones.splice(e,1),S.sumarTotalDeducciones(S.beneficio))},S.guardarBeneficioSocial=function(a){a.fecha_elaboracion=new Date(S.convertirFecha(a.fecha_elaboracion)),a.fecha_asistensia=new Date(S.convertirFecha(a.fecha_asistensia)),a.fecha_ingreso=new Date(S.convertirFecha(a.fecha_ingreso)),a.fecha_retiro?a.fecha_retiro=new Date(S.convertirFecha(a.fecha_retiro)):a.fecha_retiro=new Date,pe(a,S.empleado.id_ficha).then(function(e){S.imprimirFiniquito(a,!1),S.mostrarMensaje(e.mensaje),S.cerrarDialogBeneficiosSociales()}).catch(function(e){var a=void 0!==e.data&&null!==e.data?e.data:e.message;S.mostrarMensaje("Se produjo un error! > "+a),E.stop()})},S.seleccionarMesesFiniquito=function(e){10==e.mes_uno.id?(e.mes_dos=S.meses[11],e.mes_tres=S.meses[0]):11==e.mes_uno.id?(e.mes_dos=S.meses[0],e.mes_tres=S.meses[1]):(e.mes_dos=S.meses[e.mes_uno.id+1],e.mes_tres=S.meses[e.mes_uno.id+2])},S.agregarQuinquenioAdelantado=function(i){var t=0;if(i.quinquenio_adelantado){var r={monto:t=i.quinquenio_adelantado,motivo:"Quinquenio Adelantado",tipo:S.tipoDeducciones};if(0<i.deducciones.length){var n=!1;i.deducciones.forEach(function(e,a,o){"Quinquenio Adelantado"==e.motivo&&(e.monto=t,n=!0),a===o.length-1&&(n||i.deducciones.push(r),S.sumarTotalDeducciones(i))})}else i.deducciones.push(r)}else i.deducciones.forEach(function(e,a,o){n=!1,"Quinquenio Adelantado"==e.motivo&&(i.deducciones.splice(a,1),S.sumarTotalDeducciones(i))})},S.CalcularAguinaldoNavidad2=function(e){var a=new Date(S.convertirFecha(e.fecha_retiro)),o=new Date(S.convertirFecha(e.fecha_retiro)).getMonth()+1,i=new Date(S.convertirFecha(e.fecha_retiro)).getDate();i===new Date(a.getFullYear(),a.getMonth()+1,0).getDate()?(e.diasAguinaldo=0,e.mesesAguinaldo=o):(e.mesesAguinaldo=o-1,e.diasAguinaldo=i);var t=e.promedio/12,r=t/30;return t*e.mesesAguinaldo+r*e.diasAguinaldo},S.obtenerCuentasBancos=function(){E.start(),ne(S.usuario.id_empresa).then(function(e){S.cuentasBancos=e,E.stop()})},S.calcularPromedioFiniquito=function(r){if(r.promedio=(r.primer_mes+r.segundo_mes+r.tercer_mes)/3,r.tipo_beneficio)if(isNaN(r.promedio)){var n=[];r.ingresos.forEach(function(e,a,o){if("Vacacion"==e.motivo&&n.push(a),"indemnizacion años"==e.motivo&&n.push(a),"indemnizacion meses"==e.motivo&&n.push(a),"indemnizacion dias"==e.motivo&&n.push(a),"Desahucio"==e.motivo&&n.push(a),a===o.length-1)for(var i=n.length-1;0<=i;i--){var t=n[i];r.ingresos.splice(t,1),S.sumartotalOtrosIngresos(r)}})}else{r.desahucio&&S.calcularDesaucio(r,!1),r.totalAguinaldo=S.CalcularAguinaldoNavidad2(r);var i=S.añosRestantes*r.promedio,t=r.promedio/12*S.tiempoTrabajado.meses,s=r.promedio/365*S.tiempoTrabajado.dias,c={monto:i,motivo:"indemnizacion años",tipo:S.tipoOtrosIngresos},l={monto:t,motivo:"indemnizacion meses",tipo:S.tipoOtrosIngresos},d={monto:s,motivo:"indemnizacion dias",tipo:S.tipoOtrosIngresos},u={monto:r.promedio/30*r.totalV,motivo:"Vacacion",tipo:S.tipoOtrosIngresos},p={monto:r.totalAguinaldo,motivo:"Aguinaldo de navidad",tipo:S.tipoOtrosIngresos};if(0<r.ingresos.length){var m=!1,f=!1,g=!1,v=!1,h=!1;r.ingresos.forEach(function(e,a,o){"indemnizacion años"==e.motivo&&(e.monto=i,m=!0),"indemnizacion meses"==e.motivo&&(e.monto=t,f=!0),"indemnizacion dias"==e.motivo&&(e.monto=s,g=!0),"Vacacion"==e.motivo&&(e.monto=r.promedio/30*r.totalV,v=!0),"Aguinaldo de navidad"==e.motivo&&(e.monto=r.totalAguinaldo,h=!0),a===o.length-1&&(m||r.ingresos.push(c),f||r.ingresos.push(l),g||r.ingresos.push(d),v||r.ingresos.push(u),h||r.ingresos.push(p),S.sumartotalOtrosIngresos(r))})}else r.ingresos.push(c),r.ingresos.push(l),r.ingresos.push(d),r.ingresos.push(u),r.ingresos.push(p),S.sumartotalOtrosIngresos(r)}},S.sumartotalOtrosIngresos=function(i){i.total_ingresos=0,i.ingresos.forEach(function(e,a,o){i.total_ingresos+=e.monto})},S.calcularTotalQuiquenio=function(e){e.total_quinquenio=e.promedio*(5*e.numero_quinquenio),e.total_por_quinquenio=e.total_quinquenio/e.numero_quinquenio},S.calcularDesaucio=function(i,e){if(isNaN(i.promedio))i.ingresos.forEach(function(e,a,o){"Desahucio"==e.motivo&&(i.ingresos.splice(a,1),S.sumartotalOtrosIngresos(i))});else if(i.desahucio){if(i.total_desahucio=3*i.promedio,i.total_desahucio=parseFloat(i.total_desahucio.toFixed(2)),i.tipo_beneficio){var t={monto:i.total_desahucio,motivo:"Desahucio",tipo:S.tipoOtrosIngresos};if(!e)if(0<i.ingresos.length){var r=!1;i.ingresos.forEach(function(e,a,o){"Desahucio"==e.motivo&&(e.monto=i.total_desahucio,r=!0),a===o.length-1&&(r||(i.ingresos.push(t),S.sumartotalOtrosIngresos(i)))})}else i.ingresos.push(t),S.sumartotalOtrosIngresos(i)}}else{r=!1;var n=0;i.ingresos.forEach(function(e,a,o){"Desahucio"==e.motivo&&(r=!0,n=a),a===o.length-1&&r&&(i.ingresos.splice(n,1),S.sumartotalOtrosIngresos(i))})}},S.listaRopaTrabajoPorCargo=function(e){Ce(e).then(function(e){S.listaRopasDeTrabajo=e})},S.GuardarlistaRopaTrabajoPorCargo=function(e){"Siguiente"!=$("#siguiente-ca").text().trim()&&be(S.listaRopasDeTrabajo,e).then(function(e){S.mostrarMensaje(e.mensaje),S.cerrarModalConfiguracionRopaDeTrabajo(),S.listaRopasDeTrabajo=[],S.recargarItemsTabla()})},S.agregarRopaTrabajo=function(i){var t=!0;i.edit?(i.edit=!1,S.ropaTrabajo={}):0<S.listaRopasDeTrabajo.length?S.listaRopasDeTrabajo.forEach(function(e,a,o){i.ropaTrabajo.nombre==e.ropaTrabajo.nombre&&(t=!1,1==e.eliminado&&(e.eliminado=!1)),a===o.length-1&&t&&(S.listaRopasDeTrabajo.push(i),S.ropaTrabajo={})}):(S.listaRopasDeTrabajo.push(i),S.ropaTrabajo={})},S.editarRopaTrabajo=function(e){S.ropaTrabajo=e,S.ropaTrabajo.edit=!0},S.eliminarRopaTrabajo=function(e){e.eliminado=!0},S.generarPdfRopaTrabajo=function(){Pe(S.usuario.id_empresa).then(function(u){var p=[];u.forEach(function(e,a,o){var i={nombre:e.cargo.nombre,detalle:[]};if(0<p.length)for(var t=!0,r=0;r<p.length;r++){i={nombre:e.cargo.nombre,detalle:[]},p[r].nombre==e.cargo.nombre&&(t=!1),r===p.length-1&&t&&p.push(i)}else p.push(i);a===o.length-1&&u.forEach(function(e,a,o){for(var i=0;i<p.length;i++){var t=p[i];t.nombre==e.cargo.nombre&&t.detalle.push(e)}a===o.length-1&&convertUrlToBase64Image(S.usuario.empresa.imagen,function(e){var a=e,o=new PDFDocument({compress:!1,size:"letter",margin:10}),i=o.pipe(blobStream()),t=100,r=0,n=1,s=Math.ceil((2*p.length+u.length)/25);S.DibujarCabeceraPDFConfigRopa(o,n,s,p,a),o.font("Helvetica",10);for(var c=0;c<p.length&&r<=25;c++){ropaTrabajo=p[c],o.text(c+1,45,t),o.text(ropaTrabajo.nombre,80,t),t+=30,25==++r&&(o.addPage({margin:0,bufferPages:!0}),t=100,r=0,n+=1,S.DibujarCabeceraPDFConfigRopa(o,n,s,p,a),o.font("Helvetica",10)),o.font("Helvetica-Bold",10),o.text("ROPA",80,t),o.text("CANTIDAD",250,t,{width:70}),o.font("Helvetica",10),t+=30,25==++r&&(o.addPage({margin:0,bufferPages:!0}),t=100,r=0,n+=1,S.DibujarCabeceraPDFConfigRopa(o,n,s,p,a),o.font("Helvetica",10));for(var l=0;l<ropaTrabajo.detalle.length;l++){var d=ropaTrabajo.detalle[l];o.text(d.ropaTrabajo.nombre,80,t),o.text(d.cantidad,250,t,{width:70}),t+=30,25==++r&&(o.addPage({margin:0,bufferPages:!0}),t=100,r=0,n+=1,S.DibujarCabeceraPDFConfigRopa(o,n,s,p,a),o.font("Helvetica",10))}25==++r&&(o.addPage({margin:0,bufferPages:!0}),t=100,r=0,n+=1,S.DibujarCabeceraPDFConfigRopa(o,n,s,p,a),o.font("Helvetica",10))}o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),E.stop()})})})})},S.DibujarCabeceraPDFConfigRopa=function(e,a,o,i,t){e.font("Helvetica-Bold",14),e.text("ROPA DE TRABAJO - POR CARGOS",0,20,{align:"center"}),e.image(t,30,10,{fit:[80,80]}),e.rect(0,65,620,0).stroke(),e.rect(130,40,500,0).stroke(),e.rect(130,0,0,65).stroke(),e.rect(460,0,0,65).stroke(),e.font("Helvetica-Bold",8),e.text("Revicion:",480,20),e.text("Fecha de aprobación:",480,45),e.text("Código .",0,45,{align:"center"}),e.font("Helvetica",8);var r=new Date;e.text("Usuario: "+S.usuario.persona.nombre_completo+"      Fecha :  "+S.fechaATexto(r)+"   Hrs. "+r.getHours()+":"+r.getMinutes(),15,765),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"})},S.generarExcelRopaTrabajo=function(){Pe(S.usuario.id_empresa).then(function(e){for(var a=[["N°","CARGO","ROPA","CANTIDAD"]],o=0;o<e.length;o++){var i=[];i.push(o+1),i.push(e[o].cargo.nombre),i.push(e[o].ropaTrabajo.nombre),i.push(e[o].cantidad),a.push(i)}var t=new Workbook,r=sheet_from_array_of_arrays(a);t.SheetNames.push("SheetJS"),t.Sheets.SheetJS=r;var n=XLSX.write(t,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),"REPORTES CONFIGURACION ROPA DE TRABAJO.xlsx"),E.stop()})},S.obtenerCargosRopaTrabajo=function(){E.start(),he("RRHH_CARGO",S.usuario.id_empresa).then(function(e){var a=e.clases;S.listaCargos=e,S.llenarCargos(a),E.stop()})},S.obtenerCargosEmpleado=function(c,r,l){Me(S.empleado.id_ficha).then(function(i){S.cargosEmpleado=i;var n=[];i.forEach(function(e,a,o){e.cargo.ConfiguracionesCargo.forEach(function(e,a,o){var i={nombre:e.cargo.nombre,detalle:[]};if(0<n.length)for(var t=!0,r=0;r<n.length;r++){i={nombre:e.cargo.nombre,detalle:[]},n[r].nombre==e.cargo.nombre&&(t=!1),r===n.length-1&&t&&n.push(i)}else n.push(i);o.length}),a===o.length-1&&i.forEach(function(e,a,o){e.cargo.ConfiguracionesCargo.forEach(function(e,a,o){for(var i=0;i<n.length;i++){var t=n[i];t.nombre==e.cargo.nombre&&t.detalle.push(e)}}),a===o.length-1&&(S.dotacionItems=[],i.forEach(function(e,a,o){if(e.cargo.ConfiguracionesCargo.forEach(function(e,a,o){if(0<S.dotacionItems.length)for(var i=!0,t=0;t<S.dotacionItems.length;t++){S.dotacionItems[t].ropaTrabajo.nombre==e.ropaTrabajo.nombre&&(i=!1),t===S.dotacionItems.length-1&&i&&(e.editable=!0,e.modificable=!0,e.entregado=!1,S.dotacionItems.push(e))}else e.editable=!0,e.modificable=!0,e.entregado=!1,S.dotacionItems.push(e)}),a===o.length-1){var s=[];if(c){i=S.listaDotaciones.length-1;null!=r&&(i=r),S.dotacionRopa.dotacionItems=S.listaDotaciones[i].dotacionItems;t=new Date;S.dotacionRopa.fecha=S.fechaATexto(t),S.dotacionRopa.fecha_vencimiento=S.fechaATexto(S.dotacionRopa.fecha_vencimiento)}else{if(0<S.listaDotaciones.length&&!l){var n=[],i=S.listaDotaciones.length-1;r&&(i=r),console.log(S.listaDotaciones[i].dotacionItems.length),console.log(S.dotacionItems.length),S.listaDotaciones[i].dotacionItems.forEach(function(e,a,o){for(var i=!1,t=0;t<S.dotacionItems.length;t++){var r=S.dotacionItems[t];r.id_cargo==e.id_cargo&&r.id_ropa_trabajo==e.id_ropa_trabajo?(r.producto=e.producto,r.cantidad=e.cantidad,r.entregado=e.entregado,r.entregado&&(r.modificable=!1),c&&(r.modificable=!0),n.push(e.id)):i=!0}i&&s.push(e),a===o.length-1&&n.forEach(function(e,a,o){for(var i=0;i<s.length;i++){var t=s[i];t.id==e?s.splice(i,1):t.editable=!1}if(a===o.length-1){var n=[];S.dotacionItems.forEach(function(e,a,o){for(var i=0;i<s.length;i++){var t=s[i];e.id_ropa_trabajo==t.id_ropa_trabajo&&(e.producto=t.producto,e.cantidad=t.cantidad,e.entregado=t.entregado,n.push(t.id))}if(a===o.length-1)if(0<n.length)n.forEach(function(e,a,o){for(var i=0;i<s.length;i++){var t=s[i];t.id==e?s.splice(i,1):t.editable=!1}if(a===o.length-1){S.dotacionItemsDetalle=S.dotacionItems.concat(s),S.dotacionRopa.dotacionItems=S.dotacionItemsDetalle;var r=new Date;S.dotacionRopa.fecha=S.fechaATexto(r),S.dotacionRopa.fecha_vencimiento=S.fechaATexto(S.dotacionRopa.fecha_vencimiento)}});else{S.dotacionItemsDetalle=S.dotacionItems.concat(s),S.dotacionRopa.dotacionItems=S.dotacionItemsDetalle;var r=new Date;S.dotacionRopa.fecha=S.fechaATexto(r),S.dotacionRopa.fecha_vencimiento=S.fechaATexto(S.dotacionRopa.fecha_vencimiento)}})}})})}else{S.dotacionRopa.dotacionItems=S.dotacionItems;var t=new Date;S.dotacionRopa.fecha=S.fechaATexto(t)}}}}))})})})},S.obtenerEstadoDotacion=function(){E.start(),he("RRHH_EDRT",S.usuario.id_empresa).then(function(e){S.estadoDotacion=e,E.stop()})},S.obtenerCumplimientoDotacion=function(){E.start(),he("RRHH_CDRT",S.usuario.id_empresa).then(function(e){S.cumplimientoDotacion=e,E.stop()})},S.obtenerPeriodosDotacion=function(){E.start(),he("RRHH_PDR",S.usuario.id_empresa).then(function(e){S.periodoDotacion=e,E.stop()})},S.obtenerListaRopaTrabajoProductos=function(){E.start();var i="";S.dotacionRopa.dotacionItems.forEach(function(e,a,o){a===o.length-1?(i+=e.id_ropa_trabajo,De(i).then(function(e){S.productosRopaTrabajo=e,S.dotacionRopa.dotacionItems.forEach(function(e){e.producto&&S.calularInventarioItem(e)}),E.stop()})):i+=e.id_ropa_trabajo+","})},S.calularInventarioItem=function(i){(i.cantidad_disponible=0)<i.producto.inventarios.length&&i.producto.inventarios.forEach(function(e,a,o){i.cantidad_disponible+=e.cantidad})},S.seleccionarItem=function(e){e.editable?e.modificable&&(e.entregado?e.entregado=!e.entregado:e.entregado=!0):e.anterior||(e.entregado?e.entregado=!e.entregado:e.entregado=!0)},S.guardarDotacionRopa=function(a){(E.start(),S.actualizarDotacion)?(a.fecha=new Date(S.convertirFecha(a.fecha)),a.fecha_vencimiento=new Date(S.convertirFecha(a.fecha_vencimiento)),Te(S.empleado.id,a).then(function(e){S.mostrarMensaje(e.mensaje),S.obtenerRecursosHumanos(),S.ObtenerDotacionesRopa(S.empleado),a.numero=e.numero,S.imprimirRopaTrabajo(a),S.cerrarModalNuevaRopaTrabajo(),E.stop()}),E.stop()):(a.fecha=new Date(S.convertirFecha(a.fecha)),a.fecha_vencimiento=new Date(S.convertirFecha(a.fecha_vencimiento)),Ee(S.empleado.id,a).then(function(e){S.mostrarMensaje(e.mensaje),S.ObtenerDotacionesRopa(S.empleado),a.numero=e.numero,S.imprimirRopaTrabajo(a),S.cerrarModalNuevaRopaTrabajo(),E.stop()}))},S.ObtenerDotacionesRopa=function(e,a,i){var o={inicio:0,fin:0};a&&null!=a.inicio&&(o.inicio=a.inicio,o.fin=a.fin),xe(e.id,o).then(function(o){0<o.length?o.forEach(function(r,e,a){r.cargos=[],r.ropas=[],r.dotacionItems.forEach(function(e,a,o){if(0<r.cargos.length){for(var i=!0,t=0;t<r.cargos.length;t++){r.cargos[t].nombre==e.cargo.nombre&&(i=!1)}i&&r.cargos.push(e.cargo)}else r.cargos.push(e.cargo);if(0<r.ropas.length){for(i=!0,t=0;t<r.ropas.length;t++){r.ropas[t].nombre==e.ropaTrabajo.nombre&&(i=!1)}i&&r.ropas.push(e.ropaTrabajo)}else r.ropas.push(e.ropaTrabajo)}),e===a.length-1&&(S.listaDotaciones=o,i&&S.abrirModalNuevaRopaTrabajo(S.empleado,!1))}):(S.listaDotaciones=o,i&&S.abrirModalNuevaRopaTrabajo(S.empleado,!1)),E.stop()})},S.abrirDialogEliminarRopaTrabajo=function(){S.abrirPopup(S.idModalEliminarRopaTrabajo)},S.cerrarDialogEliminarRopaTrabajo=function(){S.dato={},S.cerrarPopup(S.idModalEliminarRopaTrabajo)},S.eliminarRopaTrabajoEmpleado=function(e){Se(e).then(function(e){S.mostrarMensaje(e.mensaje),S.ObtenerDotacionesRopa(S.empleado),S.cerrarDialogEliminarRopaTrabajo()})},S.imprimirRopaTrabajo=function(e){var a=new PDFDocument({compress:!1,size:"letter",margin:10}),o=a.pipe(blobStream()),i=215,t=0,r=1,n=Math.ceil(e.dotacionItems.length/18);S.DibujarCabeceraPDFRopaTrabajo(a,r,n,e),a.font("Helvetica",10);for(var s=0;s<e.dotacionItems.length&&t<=18;s++){if(item=e.dotacionItems[s],item.entregado)!item.anterior&&(a.text(item.producto.codigo,45,i,{width:70}),codigo,a.text(item.ropaTrabajo.nombre,175,i,{width:70}),a.text(item.producto.unidad_medida,345,i,{width:100}),a.text(item.cantidad,485,i,{width:100}),i+=30,t++);18==t&&(a.addPage({margin:0,bufferPages:!0}),i=215,t=0,r+=1,S.DibujarCabeceraPDFAnticipoRegular(a,r,n,e))}a.font("Helvetica",10);var c=new Date;i<400?i=335:i+=30,a.rect(85,i-5,85,0).dash(5,{space:10}).stroke(),a.rect(300,i-5,85,0).dash(5,{space:10}).stroke(),a.rect(455,i-5,85,0).dash(5,{space:10}).stroke(),a.text("encargado Área",85,i),a.text("Supervisor",315,i),a.text("Recibó conforme",455,i),i+=30,a.text("USUARIO: "+S.usuario.persona.nombre_completo+" FECHA:"+S.fechaATexto(c),15,i),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),E.stop()},S.DibujarCabeceraPDFRopaTrabajo=function(i,e,a,o){i.font("Helvetica-Bold",12),i.text("DOTACIÓN ROPA DE TRABAJO",0,45,{align:"center"}),i.font("Helvetica",10),i.text("Nro. "+o.numero,0,65,{align:"center"}),i.text(S.fechaATexto(new Date(o.fecha)),0,85,{align:"center"}),i.font("Helvetica-Bold",10),i.text("Empleado: ",45,100),i.text("Cargo: ",400,100),i.text("Campamento: ",45,120),i.text("Periodo: ",45,140),i.text("Estado: ",400,140),i.text("Retrasado",45,160),i.rect(35,175,535,0).dash(5,{space:10}).stroke(),i.rect(35,200,535,0).dash(5,{space:10}).stroke(),i.text("Código",45,185,{width:70}),i.text("Descripcion",175,185,{width:70}),i.text("Unidad",345,185,{width:70}),i.text("Cant",485,185,{width:70}),i.font("Helvetica",10),i.text(S.empleado.nombre_completo,100,100),i.text(o.periodo.nombre,100,140),S.empleado.campamento&&i.text(S.empleado.campamento,120,120),i.text(o.estado.nombre,440,140);var t="";o.cargos?o.cargos.forEach(function(e,a,o){a===o.length-1?(t+=e.nombre,i.text(t,440,100)):t+=e.nombre+", "}):S.cargosEmpleado.forEach(function(e,a,o){a===o.length-1?(t+=e.cargo.nombre,i.text(t,440,100)):t+=e.nombre+", "})},S.generarReporteRopaTrabajo=function(e,a){"pdf"==e?S.generarpdfRopaTrabajoEmpleados(a):S.generarExcelRopaTrabajoEmpleados(a)},S.generarExcelRopaTrabajoEmpleados=function(c){c.inicio?(c.inicio=new Date(S.convertirFecha(c.inicio)),c.fin=new Date(S.convertirFecha(c.fin))):(c.inicio=0,c.fin=0),Ae(S.usuario.id_empresa,c).then(function(e){0==c.inicio&&(c.inicio="",c.fin="");for(var a=1,o=[["N°","Asignado a:","Codigo de Artículo","Descripción","unidad","cantidad","PU","TOTAL","N° de Documento","Fecha de Entrega"]],i=0;i<e.length;i++)if(e[i].dotacionRopa.empleado.id_campo==c.campo){var t=[];t.push(a++),t.push(e[i].dotacionRopa.empleado.persona.nombre_completo),t.push(e[i].producto.codigo),t.push(e[i].producto.nombre),t.push(e[i].producto.unidad_medida),t.push(e[i].cantidad),t.push(e[i].producto.precio_unitario),t.push(e[i].producto.precio_unitario*e[i].cantidad),t.push(e[i].dotacionRopa.numero),t.push(new Date(e[i].dotacionRopa.fecha)),o.push(t)}var r=new Workbook,n=sheet_from_array_of_arrays(o);r.SheetNames.push("SheetJS"),r.Sheets.SheetJS=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"REPORTES CONFIGURACION ROPA DE TRABAJO.xlsx"),E.stop()})},S.generarpdfRopaTrabajoEmpleados=function(d){d.inicio?(d.inicio=new Date(S.convertirFecha(d.inicio)),d.fin=new Date(S.convertirFecha(d.fin))):(d.inicio=0,d.fin=0),Ae(S.usuario.id_empresa,d).then(function(l){arregloNombres=[],l.forEach(function(e,a,o){if(0==a)arregloNombres.push(e.dotacionRopa.empleado.persona.nombre_completo);else{for(var i=!1,t=0;t<arregloNombres.length;t++){arregloNombres[t]===e.dotacionRopa.empleado.persona.nombre_completo&&(i=!0)}i||arregloNombres.push(e.dotacionRopa.empleado.persona.nombre_completo)}a===o.length-1&&convertUrlToBase64Image(S.usuario.empresa.imagen,function(e){var a=e;0==d.inicio&&(d.inicio="",d.fin="");var o=new PDFDocument({compress:!1,size:"letter",margin:10}),i=o.pipe(blobStream()),t=110,r=0,n=1,s=Math.ceil((l.length+arregloNombres.length)/20);S.DibujarCabeceraPDFRopaTrabajoEmpleados(o,n,s,l,a),o.font("Helvetica",10);for(var c=0;c<l.length&&r<=20;c++)item=l[c],0==c&&(o.font("Helvetica-Bold",10),o.text("Asignado a:",45,t),o.font("Helvetica",10),o.text(item.dotacionRopa.empleado.persona.nombre_completo,105,t),t+=30,o.rect(30,t-15,550,0).stroke(),o.rect(30,t-15,0,30).stroke(),o.rect(580,t-15,0,30).stroke(),r++),0<c&&(item.dotacionRopa.empleado.persona.nombre_completo===l[c-1].dotacionRopa.empleado.persona.nombre_completo?(o.rect(30,t-15,0,30).stroke(),o.rect(580,t-15,0,30).stroke()):(o.rect(30,t-15,550,0).stroke(),o.font("Helvetica-Bold",10),o.text("Asignado a:",45,t),o.font("Helvetica",10),o.text(item.dotacionRopa.empleado.persona.nombre_completo,105,t),t+=30,o.rect(30,t-15,550,0).stroke(),o.rect(30,t-15,0,30).stroke(),o.rect(580,t-15,0,30).stroke(),r++)),o.text(c+1,35,t),o.text(item.producto.codigo,85,t),o.text(item.producto.nombre,145,t),o.text(item.producto.unidad_medida,245,t),o.text(item.cantidad,295,t),o.text(item.producto.precio_unitario,345,t),o.text(item.producto.precio_unitario*item.cantidad,400,t),o.text(item.dotacionRopa.numero,480,t),o.text(S.fechaATexto(new Date(item.dotacionRopa.fecha)),500,t),t+=30,20==++r&&(o.rect(30,t-15,550,0).stroke(),o.addPage({margin:0,bufferPages:!0}),t=110,r=0,n+=1,S.DibujarCabeceraPDFRopaTrabajoEmpleados(o,n,s,l,a),l[c+1].dotacionRopa.empleado.persona.nombre_completo===l[c].dotacionRopa.empleado.persona.nombre_completo&&(o.rect(30,t-15,550,0).stroke(),o.font("Helvetica-Bold",10),o.text("Asignado a:",45,t),o.font("Helvetica",10),o.text(item.dotacionRopa.empleado.persona.nombre_completo,105,t),t+=30,o.rect(30,t-15,550,0).stroke(),o.rect(30,t-15,0,30).stroke(),o.rect(580,t-15,0,30).stroke(),r++));o.rect(30,t-15,550,0).stroke(),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),E.stop()})})})},S.DibujarCabeceraPDFRopaTrabajoEmpleados=function(e,a,o,i,t){e.font("Helvetica-Bold",12),e.text("DOTACION DE ROPA E IMPLEMENTOS DE TRABAJO",0,50,{align:"center"}),e.image(t,40,40,{fit:[80,80]}),e.rect(30,35,550,0).stroke(),e.rect(30,95,550,0).stroke(),e.rect(130,70,450,0).stroke(),e.rect(130,35,0,60).stroke(),e.rect(460,35,0,60).stroke(),e.rect(30,35,0,60).stroke(),e.rect(580,35,0,60).stroke(),e.font("Helvetica-Bold",8),e.text("Revicion:",470,50),e.text("Fecha de aprobación:",470,75),e.text("Código .",0,75,{align:"center"}),e.font("Helvetica",8);var r=new Date;e.text("Usuario: "+S.usuario.persona.nombre_completo+"      Fecha :  "+S.fechaATexto(r)+"   Hrs. "+r.getHours()+":"+r.getMinutes(),15,765),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"})},S.imprimirFiniquito=function(_,M,D){if(D){S.vacacion={},S.beneficio=_,S.empleado=_.ficha.empleado,S.empleado.id_ficha=_.ficha.id,S.empleado.haber_basico=_.ficha.haber_basico,S.empleado.fecha_inicio=_.ficha.fecha_inicio,S.empleado.fecha_Retiro_beneficio=new Date(_.fecha_retiro),S.empleado.nombre_completo=_.ficha.empleado.persona.nombre_completo,S.empleado.estado=_.ficha.empleado.persona.estadoCivil.nombre,S.empleado.direccion=_.ficha.empleado.persona.direccion_zona,S.empleado.fecha_nacimiento=_.ficha.empleado.persona.fecha_nacimiento,S.empleado.ci=_.ficha.empleado.persona.ci,S.empleado.extension=_.ficha.empleado.extension.nombre,S.obtenerHistorialGestionesVacacion(S.empleado,!1,!0);var e=new Date;_.fecha_retiro&&(e=new Date(_.fecha_retiro));var a=new Date(_.fecha_ingreso);S.tiempoTrabajado=duration(a,e),_.mes_uno=S.meses[_.mes_uno],_.mes_dos=S.meses[_.mes_dos],_.mes_tres=S.meses[_.mes_tres],_.fecha_retiro&&(_.fecha_retiro=S.fechaATexto(_.fecha_retiro),_.totalAguinaldo=S.CalcularAguinaldoNavidad2(_)),_.ingresos=[],_.deducciones=[],_.deduccionEingresos.forEach(function(e,a,o){"OTRING"==e.tipo.nombre_corto?_.ingresos.push(e):_.deducciones.push(e),a===o.length-1&&S.calcularDesaucio(_,!0)})}convertUrlToBase64Image("./img/finiquito.png",function(P){convertUrlToBase64Image("./img/finiquito2.png",function(e){var a=P,o=e,i=new PDFDocument({compress:!1,size:[612,936],margin:10}),t=198,r=i.pipe(blobStream());if(M){var n=new Date;_.fecha_retiro&&(n=new Date(_.fecha_retiro));var s=new Date(_.fecha_ingreso);S.tiempoTrabajado=duration(s,n),_.mes_uno=S.meses[_.mes_uno],_.mes_dos=S.meses[_.mes_dos],_.mes_tres=S.meses[_.mes_tres]}i.image(a,30,30,{fit:[572,876]}),i.font("Helvetica",10),i.fillColor("#4183C4"),t=50<S.usuario.empresa.razon_social.length?182:187,i.text(S.usuario.empresa.razon_social,280,t,{width:250}),t=29<S.usuario.empresa.direccion.length?206:211,i.text("Servicios",230,t,{width:170}),i.text(S.usuario.empresa.direccion,387,t,{width:170}),t=29<S.usuario.empresa.direccion.length?231:236,i.text(S.empleado.nombre_completo,280,t,{width:250}),S.empleado.direccion&&(t=24<S.empleado.direccion.length?255:260,i.text(S.empleado.direccion,453,t,{width:250})),i.text(S.empleado.estado,160,260,{width:250}),i.text(S.empleado.cargos.split(",")[0],220,280,{width:250});n=new Date;var c=new Date(S.empleado.fecha_nacimiento),l=S.diferenciaEntreDiasEnDias(c,n);l=Math.trunc(l/365),i.text(l+" años",325,260,{width:250}),i.text(S.empleado.ci+" "+S.empleado.extension,130,298,{width:250}),i.text(S.fechaATexto(_.fecha_ingreso),325,298,{width:250});var d=(new Date).getMonth(),u=(new Date).getFullYear();if(_.fecha_retiro&&(d=new Date(_.fecha_retiro).getMonth(),u=new Date(_.fecha_retiro).getFullYear(),_.tipo_beneficio&&i.text(S.fechaATexto(_.fecha_retiro),490,298,{width:250})),_.motivo?(t=18<_.motivo.nombre.length?315:320,i.text(_.motivo.nombre,178,t,{width:120})):i.text("QUINQUENIO",180,320,{width:250}),i.text(S.number_format(_.promedio,2),490,320,{width:250}),_.tipo_beneficio?(i.text(S.tiempoTrabajado.anios,195,343,{width:250}),i.text(S.tiempoTrabajado.meses,290,343,{width:250}),i.text(S.tiempoTrabajado.dias,400,343,{width:250})):i.text(5*_.numero_quinquenio,195,343,{width:250}),_.mes_uno.id>_.mes_tres.id)var p=u-1;else p=u;if(_.mes_dos.id>_.mes_tres.id)var m=u-1;else m=u;if(i.text(_.mes_uno.nombre.toUpperCase()+" "+p,210,403),i.text(_.mes_dos.nombre.toUpperCase()+" "+m,300,403),i.text(_.mes_tres.nombre.toUpperCase()+" "+u,390,403),i.text(S.number_format(_.primer_mes,2),225,421),i.text(S.number_format(_.segundo_mes,2),315,421),i.text(S.number_format(_.tercer_mes,2),405,421),i.text(S.number_format(_.promedio,2),500,421),i.text(S.number_format(_.promedio,2),500,551),_.tipo_beneficio){for(var f=0,g="",v=0,h=0;h<_.ingresos.length;h++){"Desahucio"===(b=_.ingresos[h]).motivo?i.text(S.number_format(_.total_desahucio,2),503,580):"indemnizacion años"===b.motivo?(_.numero_quinquenio=null!=_.numero_quinquenio?_.numero_quinquenio:0,i.text(S.tiempoTrabajado.anios-5*_.numero_quinquenio,325,600),i.text(S.number_format(b.monto,2),435,600),v+=b.monto):"indemnizacion meses"===b.motivo?(i.text(S.tiempoTrabajado.meses,325,620),i.text(S.number_format(b.monto,2),435,620),v+=b.monto):"indemnizacion dias"===b.motivo?(i.text(S.tiempoTrabajado.dias,325,638),i.text(S.number_format(b.monto,2),435,638),v+=b.monto,i.text(S.number_format(v,2),503,638)):"Vacacion"===b.motivo?(i.text(_.totalV,415,672),i.text(S.number_format(b.monto,2),503,672)):"Aguinaldo de navidad"===b.motivo?(i.text(_.mesesAguinaldo,325,654),i.text(_.diasAguinaldo,415,654),i.text(S.number_format(b.monto,2),503,654)):(f+=b.monto,g+=b.motivo+", "),h===_.ingresos.length-1&&(72<g.length?(g=g.substring(0,72),g+="..."):i.text(g,110,603),i.text(S.number_format(f,2),503,709))}if(i.text(S.number_format(_.total_ingresos,2),503,745),0<_.deducciones.length){t=777;for(h=0;h<_.deducciones.length;h++){var b=_.deducciones[h];i.text(S.number_format(b.monto,2),365,t),i.text(b.motivo,155,t),t+=18,_.total_ingresos=_.total_ingresos-b.monto,h===_.deducciones.length-1&&i.text(S.number_format(_.total_ingresos,2),503,885)}}else i.text(S.number_format(_.total_ingresos,2),503,885)}else i.text(S.number_format(5*_.numero_quinquenio,0),325,600),i.text(S.number_format(_.promedio,2),435,600),i.text(S.number_format(_.total_quinquenio,2),503,600),i.text(S.number_format(_.total_quinquenio,2),503,745),i.text(S.number_format(_.total_quinquenio,2),503,885);i.addPage({margin:0,size:[612,936],bufferPages:!0}),i.image(o,30,30,{fit:[572,876]}),i.font("Helvetica",10),i.fillColor("#4183C4"),i.text(S.empleado.nombre_completo,70,130),i.text(S.empleado.ci+" "+S.empleado.extension,215,148),_.tipo_beneficio?(i.text("                                                                         "+ConvertirALiteral(_.total_ingresos.toFixed(2)),50,73,{width:470,lineGap:8}),i.text("Bs. "+S.number_format(_.total_ingresos,2),220,167)):(i.text("                                                                         "+ConvertirALiteral(_.total_quinquenio.toFixed(2)),50,73,{width:470,lineGap:8}),i.text("Bs. "+S.number_format(_.total_quinquenio,2),220,167)),null==_.cuenta?i.text("X",215,53):(i.text("X",315,53),i.text(_.cuenta.numero,500,53)),i.text(S.usuario.empresa.departamento.nombre,155,240);var C=(new Date).getDate();i.text(C,255,240),i.text(S.meses[d].nombre.toUpperCase(),330,240);u=(new Date).getFullYear();i.text(u.toString().substr(-2),515,240),i.text(S.empleado.nombre_completo.toUpperCase(),65,325,{width:250,align:"center"}),i.text(_.empleado_cargo_impresion.toUpperCase(),320,325,{width:250,align:"center"}),i.fillColor("#000000"),i.text(_.cargo_imprecion.toUpperCase(),400,335),i.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),D&&S.paginator.getSearch(S.paginator.search,S.filtroBeneficioEmpresa,null),E.stop()})})};S.obtenerChoferesViaje=function(){je(S.usuario.id_empresa).then(function(e){S.choferesViaje=e})},S.CargarEmpleadosViaje=function(g){var v=0;S.tiposViaje.clases.forEach(function(e,a,o){"INGRESO"==e.nombre&&(v=e),a==o.length-1&&(S.viaje.empleadosEntrada=[],S.empleadosRolTurnoE.forEach(function(i,e,a){for(var o=0;o<S.tiposPasajerosViaje.length;o++){if("HABILITADO"==(p=S.tiposPasajerosViaje[o]).nombre&&(i.estado=p),o===S.tiposPasajerosViaje.length-1){i.habilitado=!0,i.tipoViaje=v,i.id_ficha=i.empleadosFichas[i.empleadosFichas.length-1].id;for(var t=0;t<i.empleadosFichas[i.empleadosFichas.length-1].rolesTurno.length;t++)for(var r=i.empleadosFichas[i.empleadosFichas.length-1].rolesTurno[t],n=S.fechaATexto(r.fecha_inicio),s=new Date(S.convertirFecha(n)),c=new Date(S.convertirFecha(g));s.getTime()<=c.getTime();){if(s.getTime()===c.getTime()){if(0<i.empleadosFichas[i.empleadosFichas.length-1].ausencias.length)for(var l=0;l<i.empleadosFichas[i.empleadosFichas.length-1].ausencias.length;l++){(m=i.empleadosFichas[i.empleadosFichas.length-1].ausencias[l]).fechas=getDates(new Date(m.fecha_inicio),new Date(m.fecha_fin));for(var d=0;d<m.fechas.length;d++){var u=new Date(S.convertirFecha(S.formatofecha(m.fechas[d])));if(c.getTime()===u.getTime()){for(o=0;o<S.tiposPasajerosViaje.length;o++){var p=S.tiposPasajerosViaje[o];m.horas?"OTRA AUSENCIA"==p.nombre&&(i.estado=p):"AUSENCIA MEDICA"==p.nombre&&(i.estado=p)}i.habilitado=!1}}}if(0<i.empleadosFichas[i.empleadosFichas.length-1].vacaciones.length)for(l=0;l<i.empleadosFichas[i.empleadosFichas.length-1].vacaciones.length;l++){var m;(m=i.empleadosFichas[i.empleadosFichas.length-1].vacaciones[l]).fechas=getDates(new Date(m.fecha_inicio),new Date(m.fecha_fin));for(d=0;d<m.fechas.length;d++){u=new Date(S.convertirFecha(S.formatofecha(m.fechas[d])));if(c.getTime()===u.getTime()){for(o=0;o<S.tiposPasajerosViaje.length;o++){"VACACION"==(p=S.tiposPasajerosViaje[o]).nombre&&(i.estado=p)}i.habilitado=!1}}}if(i.eliminado){for(o=0;o<S.tiposPasajerosViaje.length;o++){"INHABILITADO"==(p=S.tiposPasajerosViaje[o]).nombre&&(i.estado=p)}i.habilitado=!1}i.campo=i.empleadosFichas[i.empleadosFichas.length-1].rolesTurno[0].campo;var f=!1;S.viaje.destinos.forEach(function(e,a,o){r.campo.id==e.id&&(f=!0),a===o.length-1&&1==f&&(i.campo=Object.assign({},r.campo),r.fecha_fin?new Date(S.convertirFecha(g)).getTime()<new Date(r.fecha_fin).getTime()&&S.viaje.empleadosEntrada.push(Object.assign({},i)):S.viaje.empleadosEntrada.push(Object.assign({},i)))})}n=S.fechaATexto(S.sumaFecha(r.dias_trabajado+r.dias_descanso,S.convertirFecha(n))),s=new Date(S.convertirFecha(n))}}}e===a.length-1&&console.log(S.viaje.empleadosEntrada)}))})},S.localStorageSpace=function(){var e="";for(var a in console.log("Current local storage: "),window.localStorage)window.localStorage.hasOwnProperty(a)&&(e+=window.localStorage[a],console.log(a+" = "+(16*window.localStorage[a].length/8192).toFixed(2)+" KB"));console.log(e?"\nTotal space used: "+(16*e.length/8192).toFixed(2)+" KB":"Empty (0 KB)"),console.log(e?"Approx. space remaining: "+(5120-(16*e.length/8192).toFixed(2))+" KB":"5 MB")},S.CargarEmpleadosViajeSalida=function(v){S.viaje.empleadosSalida=[];var h=0;S.tiposViaje.clases.forEach(function(e,a,o){"SALIDA"==e.nombre&&(h=e),a==o.length-1&&S.empleadosRolTurnoE.forEach(function(i,e,a){for(var o=0;o<S.tiposPasajerosViaje.length;o++){"HABILITADO"==(g=S.tiposPasajerosViaje[o]).nombre&&(i.estado=g)}i.tipoViaje=h,i.id_ficha=i.empleadosFichas[i.empleadosFichas.length-1].id;for(var t=0;t<i.empleadosFichas[i.empleadosFichas.length-1].rolesTurno.length;t++)for(var r=i.empleadosFichas[i.empleadosFichas.length-1].rolesTurno[t],n=S.fechaATexto(r.fecha_inicio),s=new Date(S.convertirFecha(n)),c=new Date(S.convertirFecha(v)),l=0;s.getTime()<=c.getTime();){if(s.getTime()===c.getTime()){if(0<i.empleadosFichas[i.empleadosFichas.length-1].ausencias.length)for(var d=0;d<i.empleadosFichas[i.empleadosFichas.length-1].ausencias.length;d++){(m=i.empleadosFichas[i.empleadosFichas.length-1].ausencias[d]).fechas=getDates(new Date(m.fecha_inicio),new Date(m.fecha_fin));for(var u=0;u<m.fechas.length;u++){var p=new Date(S.convertirFecha(S.formatofecha(m.fechas[u])));if(c.getTime()===p.getTime()){for(o=0;o<S.tiposPasajerosViaje.length;o++){"AUSENCIA"==(g=S.tiposPasajerosViaje[o]).nombre&&(i.estado=g)}i.habilitado=!1}}}if(0<i.empleadosFichas[i.empleadosFichas.length-1].vacaciones.length)for(d=0;d<i.empleadosFichas[i.empleadosFichas.length-1].vacaciones.length;d++){var m;(m=i.empleadosFichas[i.empleadosFichas.length-1].vacaciones[d]).fechas=getDates(new Date(m.fecha_inicio),new Date(m.fecha_fin));for(u=0;u<m.fechas.length;u++){p=new Date(S.convertirFecha(S.formatofecha(m.fechas[u])));if(c.getTime()===p.getTime()){for(o=0;o<S.tiposPasajerosViaje.length;o++){"VACACION"==(g=S.tiposPasajerosViaje[o]).nombre&&(i.estado=g)}i.habilitado=!1}}}i.campo=i.empleadosFichas[i.empleadosFichas.length-1].rolesTurno[0].campo;var f=!1;if(i.eliminado){for(o=0;o<S.tiposPasajerosViaje.length;o++){var g;"INHABILITADO"==(g=S.tiposPasajerosViaje[o]).nombre&&(i.estado=g)}i.habilitado=!1}S.viaje.destinos.forEach(function(e,a,o){i.campo.id==e.id&&(f=!0),a===o.length-1&&1==f&&S.viaje.empleadosSalida.push(Object.assign({},i))})}n=0==l?S.fechaATexto(S.sumaFecha(r.dias_trabajado,S.convertirFecha(n))):S.fechaATexto(S.sumaFecha(r.dias_trabajado+r.dias_descanso,S.convertirFecha(n))),s=new Date(S.convertirFecha(n)),l++}e===a.length-1&&console.log(S.viaje.empleadosSalida)})})},S.CopiarEmpleadosViaje=function(){S.viaje.empleadosSalida=[],S.viaje.empleadosSalida=S.viaje.empleadosEntrada.map(function(e){return Object.assign({},e)}),S.viaje.empleadosSalida.forEach(function(e,a,o){for(var i=0;i<S.tiposViaje.clases.length;i++){var t=S.tiposViaje.clases[i];"SALIDA"==t.nombre&&(e.tipoViaje=t)}})},S.cambiarEstadoPasajero=function(e){e.activo=0==e.eliminado,e.fecha_inicio=e.empleadosFichas[e.empleadosFichas.length-1].fecha_inicio,e.nombre_completo=e.persona.nombre_completo,S.cerrarModalDesabilitarPasajero(),S.abriirmodelAusenciasVacas(e),"OTRA AUSENCIA"==e.estado.nombre&&$("#otra-ausencia").click(),"AUSENCIA MEDICA"==e.estado.nombre&&$("#ausencia-medica").click(),"VACACION"==e.estado.nombre&&$("vacacion").click()},S.realizarCalendarioTrabajo=function(i){var t=[];if(i){if(i.inicio)for(var e=new Date(S.convertirFecha(i.inicio)).getFullYear(),a=new Date(S.convertirFecha(i.fin)).getFullYear();e<=a;)t.push(e),e++}else t.push((new Date).getFullYear());S.diasAnio=S.CalendarioRolTurnos(t,i),S.diasAnioPieTrabajos=S.CalendarioRolTurnos(t,i),S.diasAnioPieAusencias=S.CalendarioRolTurnos(t,i),S.diasAnioPieVacaciones=S.CalendarioRolTurnos(t,i),S.empleadosRolTurno.forEach(function(e,a,o){e.diasAnio=S.CalendarioRolTurnos(t,i),a==o.length-1&&S.empleadosRolTurno.forEach(function(e,a,o){var i=e,t="";i.fecha_fin&&(t=S.fechaATexto(i.fecha_fin));for(var r=!1,n=1,s=0;s<e.diasAnio.length;s++){var c=e.diasAnio[s];c.fecha==S.fechaATexto(i.fecha_inicio)?r=!0:new Date(S.convertirFecha(c.fecha)).getFullYear()>new Date(i.fecha_inicio).getFullYear()&&new Date(S.convertirFecha(c.fecha)).getDate()>=new Date(i.fecha_inicio).getDate()&&(r=!0),r&&(n<=i.dias_trabajado?(i.fecha_fin&&t==c.fecha&&(s=e.diasAnio.length),c.texto="T",n++):n<=i.dias_trabajado+i.dias_descanso&&(i.fecha_fin&&t==c.fecha&&(s=e.diasAnio.length),c.texto="D",n===i.dias_trabajado+i.dias_descanso&&(n=0),n++))}a==o.length-1&&S.empleadosRolTurno.forEach(function(e,a,o){for(var i=0;i<e.ficha.ausencias.length;i++){var t=e.ficha.ausencias[i];t.fechas=getDates(new Date(t.fecha_inicio),new Date(t.fecha_fin))}a==o.length-1&&S.empleadosRolTurno.forEach(function(e,a,o){for(var i=0;i<e.ficha.ausencias.length;i++)for(var t=e.ficha.ausencias[i],r=0;r<t.fechas.length;r++)for(var n=t.fechas[r],s=0;s<e.diasAnio.length;s++){var c=e.diasAnio[s];n==S.formatofecha(c.fecha)&&(c.mensaje=l.trustAsHtml(t.tipoAusencia.tipo.nombre+"<br> motivo:"+t.tipoAusencia.nombre),"D"==c.texto?t.horas?c.texto+="OA":c.texto+="BD":"T"==c.texto&&(t.horas?c.texto+="OA":c.texto+="BM"))}a==o.length-1&&S.empleadosRolTurno.forEach(function(e,a,o){for(var i=0;i<e.ficha.vacaciones.length;i++){var t=e.ficha.vacaciones[i];t.fechas=getDates(new Date(t.fecha_inicio),new Date(t.fecha_fin))}a==o.length-1&&S.empleadosRolTurno.forEach(function(e,a,o){for(var i=0;i<e.ficha.vacaciones.length;i++)for(var t=e.ficha.vacaciones[i],r=0;r<t.fechas.length;r++)for(var n=t.fechas[r],s=0;s<e.diasAnio.length;s++){var c=e.diasAnio[s];n==S.formatofecha(c.fecha)&&(c.mensaje=l.trustAsHtml("vacacion del <br>"+S.fechaATexto(t.fecha_inicio)+" al "+S.fechaATexto(t.fecha_fin)),c.texto,c.texto+="V")}a===o.length-1&&(S.diasAnioPieTrabajos.forEach(function(e,a,o){e.texto=parseInt(0);for(var i=0;i<S.empleadosRolTurno.length;i++)for(var t=S.empleadosRolTurno[i],r=0;r<t.diasAnio.length;r++){var n=t.diasAnio[r];e.fecha==n.fecha&&"T"==n.texto&&(e.texto+=1)}}),S.diasAnioPieAusencias.forEach(function(e,a,o){e.texto=parseInt(0);for(var i=0;i<S.empleadosRolTurno.length;i++)for(var t=S.empleadosRolTurno[i],r=0;r<t.diasAnio.length;r++){var n=t.diasAnio[r];e.fecha==n.fecha&&("A"!=n.texto&&"TBM"!=n.texto&&"DBD"!=n.texto||(e.texto+=1))}}),S.diasAnioPieVacaciones.forEach(function(e,a,o){e.texto=parseInt(0);for(var i=0;i<S.empleadosRolTurno.length;i++)for(var t=S.empleadosRolTurno[i],r=0;r<t.diasAnio.length;r++){var n=t.diasAnio[r];e.fecha==n.fecha&&("V"!=n.texto&&"TV"!=n.texto&&"DV"!=n.texto||(e.texto+=1))}o.length}))})})})})})})},S.CalendarioRolTurnos=function(e,d){S.mesesRolTurno=[];var u=[];if(d&&d.inicio){var p=new Date(S.convertirFecha(d.inicio)).getMonth(),m=new Date(S.convertirFecha(d.fin)).getMonth(),f=new Date(S.convertirFecha(d.inicio)).getDate(),g=new Date(S.convertirFecha(d.fin)).getDate();if(d.inicio2&&(p=new Date(S.convertirFecha(d.inicio2)).getMonth(),f=new Date(S.convertirFecha(d.inicio2)).getDate()),d.fin2)m=new Date(S.convertirFecha(d.fin2)).getMonth(),g=new Date(S.convertirFecha(d.fin2)).getDate()}for(var a=0;a<e.length;a++){var v=e[a];Object.assign([],S.meses).forEach(function(e,a,o){var i=Object.assign({},e);if(i.dias=[],i.anio=v,d&&d.inicio?i.id>p-1&&i.id<=m?i.visible=!0:i.visible=!1:i.visible=!0,S.mesesRolTurno.push(i),a===o.length-1)for(var t=1;t<366;t++){var r=S.fechaPorDia(v,t),n=(e=r.getMonth(),r.getDate()),s=(r.getDay(),{id:t,dia:n,visible:!0,texto:"",fecha:S.fechaATexto(r),mes:S.mesesRolTurno[e]});e==p?f<=n||(s.visible=!1):e==m&&(n<=g||(s.visible=!1)),u.push(s);for(var c=0;c<S.mesesRolTurno.length;c++){var l=S.mesesRolTurno[c];l.anio==v&&l.id==e&&(l.id==p?f<=n&&l.dias.push(n):l.id==m?n<=g&&l.dias.push(n):l.dias.push(n))}}})}return u},S.guardarViaje=function(a){a.fecha=new Date,a.fecha_ingreso=new Date(S.convertirFecha(a.fecha_ingreso)),a.fecha_salida&&(a.fecha_salida=new Date(S.convertirFecha(a.fecha_salida))),Oe(a,S.usuario.id_empresa).then(function(e){S.cerrarDialogViajes(),S.imprimirReporteViaje(a),S.mostrarMensaje(e.mensaje)})},S.listaViajesPasajero=function(){0!=S.paginator.filter.inicio&&(S.paginator.filter.inicio=new Date(S.convertirFecha(S.paginator.filter.inicio)),S.paginator.filter.fin=new Date(S.convertirFecha(S.paginator.filter.fin))),Fe(S.paginator).then(function(e){0!=S.paginator.filter.inicio&&(S.paginator.filter.inicio=S.fechaATexto(S.paginator.filter.inicio),S.paginator.filter.fin=S.fechaATexto(S.paginator.filter.fin)),S.paginator.setPages(e.paginas),S.viajesEmpresa=e.viajes})},S.listaViajes=function(){0!=S.paginator.filter.inicio&&(S.paginator.filter.inicio=new Date(S.convertirFecha(S.paginator.filter.inicio)),S.paginator.filter.fin=new Date(S.convertirFecha(S.paginator.filter.fin))),Ne(S.paginator).then(function(e){0!=S.paginator.filter.inicio&&(S.paginator.filter.inicio=S.fechaATexto(S.paginator.filter.inicio),S.paginator.filter.fin=S.fechaATexto(S.paginator.filter.fin)),S.paginator.setPages(e.paginas),S.viajesEmpresa=e.viajes})},S.obtenerViajesPasajeros=function(){S.paginator=s(),S.paginator.column="id",S.paginator.direccion="asc",S.filtroViaje={empresa:S.usuario.id_empresa,inicio:"",fin:"",tipoPasajero:"",destino:"",vehiculo:"",conductor:"",tipoViaje:""},S.paginator.callBack=S.listaViajesPasajero,S.paginator.getSearch("",S.filtroViaje,null)},S.obtenerViajes=function(){S.paginator=s(),S.paginator.column="id",S.paginator.direccion="asc",S.filtroViaje={empresa:S.usuario.id_empresa,inicio:"",fin:"",destino:"",vehiculo:"",conductor:"",relevo:""},S.paginator.callBack=S.listaViajes,S.paginator.getSearch("",S.filtroViaje,null)},S.imprimirDesteHistorialReporteVIaje=function(i){i.empleadosEntrada=[],i.empleadosSalida=[];var t=[],r=Object.assign([],i.destinos);i.destinos.forEach(function(e,a,o){t.push(e.destino),a===o.length-1&&(i.destinos=t,i.viajeDetalles.forEach(function(e,a,o){e.persona=e.ficha.empleado.persona,"INGRESO"==e.tipoViaje.nombre?i.empleadosEntrada.push(e):i.empleadosSalida.push(e),a===o.length-1&&(S.imprimirReporteViaje(i),i.destinos=r)}))})},S.imprimirReporteViaje=function(i){if(0<i.empleadosEntrada.length){for(var e=[],a=i.destinos.map(function(e){return Object.assign({},e)}),t=i.empleadosEntrada,r=" (Ingreso)";destinos2=a.slice(0,6),e.push(destinos2),6<(a=a.slice(6,a.length)).length-1;);0<a.length&&e.push(a),e.forEach(function(e,a,o){S.generarPdfViaje(i,t,e,r)})}if(0<i.empleadosSalida.length){for(e=[],a=i.destinos.map(function(e){return Object.assign({},e)}),t=i.empleadosSalida,r=" (Salida)";destinos2=a.slice(0,6),e.push(destinos2),6<(a=a.slice(6,a.length)).length-1;);0<a.length&&e.push(a),e.forEach(function(e,a,o){S.generarPdfViaje(i,t,e,r)})}},S.generarPdfViaje=function(l,d,u,p){u.forEach(function(e,a,o){e.y=215,a===o.length-1&&convertUrlToBase64Image(S.usuario.empresa.imagen,function(e){var a=e,o=new PDFDocument({compress:!1,size:"letter",margin:10}),i=o.pipe(blobStream());S.dibujarCabeceraPDFViaje(o,l,1,a,u,p),o.font("Helvetica",5),itemsPorPagina=12,items=0,pagina=1;for(var t=0;t<d.length;t++)for(var r=35,n=d[t],s=0;s<u.length;s++){var c=u[s];u.length,n.campo.id===c.id&&(o.text(n.persona.nombre_completo,r,c.y,{width:91,align:"center"}),c.y+=10),r+=91}o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})})},S.dibujarCabeceraPDFViaje=function(i,e,a,o,t,r){i.font("Helvetica-Bold",12),i.text("LISTA DE PASAJEROS",0,50,{align:"center"}),i.image(o,40,40,{fit:[80,80]}),i.rect(30,35,550,0).stroke(),i.rect(30,95,550,0).stroke(),i.rect(130,70,450,0).stroke(),i.rect(130,35,0,60).stroke(),i.rect(440,35,0,60).stroke(),i.rect(30,35,0,60).stroke(),i.rect(580,35,0,60).stroke(),i.font("Helvetica",10),i.text("Revición:",450,50),i.text("Fecha de aprobación:",450,72),i.text("Código .",0,75,{align:"center"}),i.font("Helvetica-Bold",10),i.rect(30,105,550,0).stroke(),i.text("Conductor 1:",35,110),i.text("licencia 1:",345,110),i.rect(30,120,550,0).stroke(),i.text("Conductor 2:",35,125),i.text("licencia 2:",345,125),i.rect(30,135,550,0).stroke(),i.text("Vehículo:",35,140),i.text("Placa:",345,140),i.rect(30,150,550,0).stroke(),i.text("Fecha:",35,160),i.font("Helvetica",10),i.text(e.conductor.nombre,135,110),i.text(e.relevo.nombre,135,125);var n=e.vehiculo.nombre.split("-");i.text(n[0],135,140),i.text(e.conductor.licencia+" "+e.conductor.tipoLicencia.nombre,415,110),i.text(e.relevo.licencia+" "+e.relevo.tipoLicencia.nombre,415,125),i.text(n[1],415,140),i.text(S.fechaATexto(e.fecha)+r,135,160),i.rect(30,105,0,45).stroke(),i.rect(115,105,0,45).stroke(),i.rect(340,105,0,45).stroke(),i.rect(410,105,0,45).stroke(),i.rect(580,105,0,45).stroke(),i.rect(30,170,550,590).stroke(),i.rect(30,190,550,0).stroke(),i.font("Helvetica-Bold",8),i.text("Campamentos",0,177,{align:"center"});var s=125,c=30,l=125;t.forEach(function(e,a,o){i.rect(s,190,0,570).stroke(),0==a?(i.text(e.nombre,c,195,{width:91,align:"center"}),i.rect(c,212,95,0).stroke()):(i.text(e.nombre,s-91,195,{width:91,align:"center"}),i.rect(l,212,91,0).stroke(),l+=91),s+=91,c+=95})},S.obtenerbeneficiosSocialesEmpresa=function(){S.paginator=s(),S.paginator.column="id",S.paginator.direccion="asc",S.filtroBeneficioEmpresa={empresa:S.usuario.id_empresa,inicio:"",fin:"",motivo:"",tipo:0},S.paginator.callBack=S.listaBeneficiosEmpresa,S.paginator.getSearch("",S.filtroBeneficioEmpresa,null)},S.listaBeneficiosEmpresa=function(){0!=S.paginator.filter.inicio&&(S.paginator.filter.inicio=new Date(S.convertirFecha(S.paginator.filter.inicio)),S.paginator.filter.fin=new Date(S.convertirFecha(S.paginator.filter.fin))),He(S.paginator).then(function(e){0!=S.paginator.filter.inicio&&(S.paginator.filter.inicio=S.fechaATexto(S.paginator.filter.inicio),S.paginator.filter.fin=S.fechaATexto(S.paginator.filter.fin)),S.paginator.setPages(e.paginas),S.beneficiosEmpresa=e.beneficios})},S.imprimirReciboVacacion=function(l,d,u,p,m){convertUrlToBase64Image(S.usuario.empresa.imagen,function(e){var a=new PDFDocument({compress:!1,size:"letter",margin:10}),o=a.pipe(blobStream()),i=new Date(l.createdAt),t=30,r=new Date;S.dibujarCabeceraPDFImpresionVacacion(a,l,e,t,d),a.font("Helvetica",10),a.text(S.fechaATexto(l.createdAt),80,t+80),a.text(d,90,t+110),a.text(S.fechaATexto(u),410,t+110);var n="";if(l.detalleDescuentosVacacionHistorial){for(var s=0;s<l.detalleDescuentosVacacionHistorial.length;s++){n=(c=l.detalleDescuentosVacacionHistorial[s]).historialVacacion.gestion+"-"+(c.historialVacacion.gestion+1)}0<l.detalleDescuentosVacacionHistorial.length&&a.text(l.detalleDescuentosVacacionHistorial[l.detalleDescuentosVacacionHistorial.length-1].historialVacacion.aplicadas-l.detalleDescuentosVacacionHistorial[l.detalleDescuentosVacacionHistorial.length-1].historialVacacion.tomadas+" días de la Gestion "+l.detalleDescuentosVacacionHistorial[l.detalleDescuentosVacacionHistorial.length-1].historialVacacion.gestion+"-"+(l.detalleDescuentosVacacionHistorial[l.detalleDescuentosVacacionHistorial.length-1].historialVacacion.gestion+1),430,t+140)}else a.text(m,430,t+140);null!=p?a.text(p,100,t+140):a.text(n,100,t+140),a.text(l.inicio_tipo?S.fechaATexto(l.fecha_inicio)+" (dia)":S.fechaATexto(l.fecha_inicio)+" (medio dia)",60,t+170),a.text(l.fin_tipo?S.fechaATexto(l.fecha_fin)+" (dia)":S.fechaATexto(l.fecha_fin)+" (medio dia)",370,t+170),a.text(l.dias+" días",70,t+200),a.text(l.domingos,305,t+200),null!=l.feriados?a.text(l.feriados,410,t+200):a.text(l.dias_descuento,410,t+200),a.text(l.observacion,40,t+260),a.font("Helvetica",5),a.text("EMISIÓN: "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),200,375),a.text("IMPRESIÓN: "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),260,375),a.text("USUARIO: "+S.usuario.persona.nombre_completo,40,375),a.font("Helvetica",8),a.rect(3,400,600,0).dash(1,{space:5}).stroke(),t=430,S.dibujarCabeceraPDFImpresionVacacion(a,l,e,430,d),a.font("Helvetica",10),a.text(S.fechaATexto(r),80,t+80),a.text(d,90,t+110),a.text(S.fechaATexto(u),410,t+110);n="";if(l.detalleDescuentosVacacionHistorial){for(s=0;s<l.detalleDescuentosVacacionHistorial.length;s++){var c;n=(c=l.detalleDescuentosVacacionHistorial[s]).historialVacacion.gestion+"-"+(c.historialVacacion.gestion+1)}0<l.detalleDescuentosVacacionHistorial.length&&a.text(l.detalleDescuentosVacacionHistorial[l.detalleDescuentosVacacionHistorial.length-1].historialVacacion.aplicadas-l.detalleDescuentosVacacionHistorial[l.detalleDescuentosVacacionHistorial.length-1].historialVacacion.tomadas+" días de la Gestion "+l.detalleDescuentosVacacionHistorial[l.detalleDescuentosVacacionHistorial.length-1].historialVacacion.gestion+"-"+(l.detalleDescuentosVacacionHistorial[l.detalleDescuentosVacacionHistorial.length-1].historialVacacion.gestion+1),430,t+140)}else a.text(m,430,t+140);null!=p?a.text(p,100,t+140):a.text(n,100,t+140),a.text(l.inicio_tipo?S.fechaATexto(l.fecha_inicio)+" (dia)":S.fechaATexto(l.fecha_inicio)+" (medio dia)",60,t+170),a.text(l.fin_tipo?S.fechaATexto(l.fecha_fin)+" (dia)":S.fechaATexto(l.fecha_fin)+" (medio dia)",370,t+170),a.text(l.dias+" días",70,t+200),a.text(l.domingos,305,t+200),null!=l.feriados?a.text(l.feriados,410,t+200):a.text(l.dias_descuento,410,t+200),a.text(l.observacion,40,t+260),a.font("Helvetica",5),a.text("EMISIÓN: "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),200,775),a.text("IMPRESIÓN: "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),260,775),a.text("USUARIO: "+S.usuario.persona.nombre_completo,40,775),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},S.dibujarCabeceraPDFImpresionVacacion=function(e,a,o,i,t){e.font("Helvetica-Bold",16),e.text("BOLETA DE PERMISO",0,i,{align:"center"}),e.text("VACACIONES",0,i+30,{align:"center"}),e.rect(0,i+65,630,0).dash(0,{space:0}).stroke(),e.image(o,40,i-20,{fit:[80,80]}),e.font("Helvetica-Bold",10),e.text("Fecha:",40,i+80),e.text("Nombre:",40,i+110),e.text("F. Ingreso:",350,i+110),e.text("Gestiones:",40,i+140),e.text("Días restantes:",350,i+140),e.text("del:",40,i+170),e.text("Al:",350,i+170),e.text("Total:",40,i+200),e.text("OBSERVACIÓN",40,i+230),e.text("Domingos:",240,i+200),e.text("Feriados:",350,i+200),e.font("Helvetica",10),e.text(t,40,i+320),e.text("EMPLEADO",100,i+330),e.text("JEFE DE AREA",280,i+320),e.text("JEFE DE R.R.H.H.",440,i+320)},S.fechaPorDia=function(e,a){var o=new Date(e,0);return new Date(o.setDate(a))},S.generarPdfEstadoVacacionEmpresa=function(e,a){E.start();var o=new PDFDocument({size:"letter",margin:10}),i=o.pipe(blobStream()),t=120,r=0,n=Math.ceil(e.length/28);S.dibujarCabeceraPDFVacacionEmpresa(o,1,n,e,a),o.font("Helvetica",8);for(var s=0;s<e.length&&r<=28;s++){var c=e[s];o.text(c.ficha.empleado.persona.nombre_completo,45,t),o.text(S.fechaATexto(c.fecha_inicio),220,t,{width:50}),o.text(S.fechaATexto(c.fecha_fin),290,t,{width:60}),o.text(c.dias,370,t,{width:50}),o.text(c.observacion,420,t,{width:200}),t+=20,28==++r&&(o.addPage({margin:0,bufferPages:!0}),t=120,r=0,1,S.dibujarCabeceraPDFVacacionEmpresa(o,1,n,e,a),o.font("Helvetica",8))}o.font("Helvetica",5);var l=new Date,d=l.getMinutes();d<10&&(d="0"+d);new Date;o.text("IMPRESIÓN: "+S.fechaATexto(l)+" Hr. "+l.getHours()+":"+d,180,775),o.text("USUARIO: "+S.usuario.persona.nombre_completo,40,775),o.font("Helvetica-Bold",8),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),E.stop()},S.generarPdfHistorialVacacionEmpresa=function(e,a){E.start();var o=new PDFDocument({size:"letter",margin:10}),i=o.pipe(blobStream()),t=120,r=0,n=Math.ceil(e.length/28);S.dibujarCabeceraPDFHistorialVacacionEmpresa(o,1,n,e,a),o.font("Helvetica",8);for(var s=0;s<e.length;s++){var c=e[s];if(!c.ficha.fecha_expiracion){for(var l=0;l<c.ficha.historialVacaciones.length&&r<=28;l++){var d=c.ficha.historialVacaciones[l];o.text(c.ficha.empleado.persona.nombre_completo,45,t),o.text(d.aplicadas,250,t,{width:50}),o.text(d.tomadas,350,t,{width:60}),o.text(d.aplicadas-d.tomadas,450,t,{width:50}),t+=20,r++}28==r&&(o.addPage({margin:0,bufferPages:!0}),t=120,r=0,1,S.dibujarCabeceraPDFHistorialVacacionEmpresa(o,1,n,e,a),o.font("Helvetica",8))}}o.font("Helvetica",5);var u=new Date,p=u.getMinutes();p<10&&(p="0"+p);new Date;o.text("IMPRESIÓN: "+S.fechaATexto(u)+" Hr. "+u.getHours()+":"+p,180,775),o.text("USUARIO: "+S.usuario.persona.nombre_completo,40,775),o.font("Helvetica-Bold",8),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),E.stop()},S.generarExcelEstadoVacacionEmpresa=function(e){for(var a=[["","","REPORTE DE VACACIONES"],["Nombre","Desde","Hasta","Días","Observacion","Sabado","Gestión","Dias Rest.","Estado","Fecha Baja"]],o=0;o<e.length;o++){var i=[],t=e[o];if(!t.ficha.fecha_expiracion){i.push(t.ficha.empleado.persona.nombre_completo),i.push(new Date(t.fecha_inicio)),i.push(new Date(t.fecha_fin)),i.push(t.dias),i.push(t.observacion),i.push(t.sabado?"Si":"No");for(var r="",n=0;n<t.detalleDescuentosVacacionHistorial.length;n++){0<n&&(r+=", ");var s=t.detalleDescuentosVacacionHistorial[n],c=s.historialVacacion.gestion+1;r+=s.historialVacacion.gestion+"-"+c}i.push(r),i.push(t.diasRestantes),i.push(t.ficha.empleado.eliminado?"Incantivo":"Activo"),i.push(new Date(t.ficha.fecha_expiracion)),a.push(i)}}var l=new Workbook,d=sheet_from_array_of_arrays(a);l.SheetNames.push("SheetJS"),l.Sheets.SheetJS=d;var u=XLSX.write(l,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(u)],{type:"application/octet-stream"}),"REPORTE-VACACIONES.xlsx"),E.stop()},S.generarExcelHistorialVacacionEmpresa=function(e){for(var a=[["Nombre","Cargo","Campo","Gestión","Aplicadas","Todamas","Restantes"]],o=0;o<e.length;o++)for(var i=[],t=e[o],r=0;r<t.ficha.historialVacaciones.length;r++){i=[];var n=t.ficha.historialVacaciones[r];i.push(t.ficha.empleado.persona.nombre_completo);for(var s="",c=0;c<t.ficha.cargos.length;c++){0<c&&(s+=", "),s+=t.ficha.cargos[c].cargo.nombre}i.push(s),i.push(t.ficha.empleado.campo.nombre);var l=n.gestion+1,d=n.gestion+"-"+l;i.push(d),i.push(n.aplicadas),i.push(n.tomadas),i.push(n.aplicadas-n.tomadas),a.push(i)}var u=new Workbook,p=sheet_from_array_of_arrays(a);u.SheetNames.push("SheetJS"),u.Sheets.SheetJS=p;var m=XLSX.write(u,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(m)],{type:"application/octet-stream"}),"REPORTE-VACACIONES-RESTANTES.xlsx"),E.stop()},S.dibujarCabeceraPDFVacacionEmpresa=function(e,a,o,i,t){e.font("Helvetica-Bold",12),e.text("REPORTE DE VACACIONES",0,25,{align:"center"}),t?(e.text(S.empleado.nombre_completo,0,45,{align:"center"}),e.text("PERIODO: TODOS",0,65,{align:"center"})):e.text("PERIODO: TODOS",0,45,{align:"center"}),e.font("Helvetica-Bold",8),e.text("NOMBRE",45,90),e.text("DESDE",220,90),e.text("HASTA",290,90),e.text("DÍAS",370,90),e.text("OBSERVACIÓN",420,90),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"})},S.dibujarCabeceraPDFHistorialVacacionEmpresa=function(e,a,o,i,t){e.font("Helvetica-Bold",12),e.text("REPORTE DE VACACIONES RESTANTES",0,25,{align:"center"}),t?(e.text(S.empleado.nombre_completo,0,45,{align:"center"}),e.text("PERIODO: TODOS",0,65,{align:"center"})):e.text("PERIODO: TODOS",0,45,{align:"center"}),e.font("Helvetica-Bold",8),e.text("EMPLEADO",45,90),e.text("APLICADAS",250,90),e.text("TOMADAS",350,90),e.text("RESTANTES",450,90),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"})},S.AgregarProrreteo=function(e){if(1==e)for(var a=(new Date).getFullYear(),o=(new Date).getMonth(),i=0;i<S.historialEmpresaVacacionesGestion.length;i++)for(var t=S.historialEmpresaVacacionesGestion[i],r=0;r<t.ficha.historialVacaciones.length;r++){var n=t.ficha.historialVacaciones[r];n.gestion==a&&(n.aplicadas=Math.round(n.aplicadas*o/12))}else{S.obtenerHistorialEmpresaVacacionGestion({})}},S.obtenerHistorialEmpresaVacacionGestion=function(e){var a={inicio:0,fin:0,estado:2};e.inicio&&(a.inicio=new Date(S.convertirFecha(e.inicio)),a.fin=new Date(S.convertirFecha(e.fin))),e.estado&&(a.estado=e.estado),ae(S.usuario.id_empresa,a).then(function(r){r.forEach(function(e,a,o){for(var i=e.diasRestantes=0;i<e.ficha.historialVacaciones.length;i++){var t=e.ficha.historialVacaciones[i];e.diasRestantes+=t.aplicadas-t.tomadas}a===o.length-1&&(S.historialEmpresaVacacionesGestion=r)})})},S.ReporteDehijos=function(s,c,l){ze(S.usuario.id_empresa).then(function(t){var r=new Date,n=[];t.forEach(function(e,a,o){console.log("falta funcionalidad"),fechaNacimiento=new Date(e.persona.fecha_nacimiento);var i=S.diferenciaEntreDiasEnDias(fechaNacimiento,r);e.edad=Math.trunc(i/365),a===o.length-1&&t.forEach(function(e,a,o){l?e.edad>=s&&e.edad<=c&&n.push(e):0==e.empleado.eliminado&&e.edad>=s&&e.edad<=c&&n.push(e),a===o.length-1&&S.generarReproteHijos(n)})}),console.log(t)})},S.generarReproteHijos=function(e){for(var a=[["CODIGO","EMPLEADO","L_APORTE","DEPARTAMENTO","PROVINCIA","LOCALIDAD","RECIDENCIA","CAMPO","ESTADO","NOMBRES","APELLIDO PATERNO","APELLIDO MATERNO","FECHA_NAC","SEXO","EDAD","AFILIADO","RELACION"]],o=[],i=0;i<e.length;i++){var t=[];t.push(e[i].empleado.codigo),t.push(e[i].empleado.persona.nombre_completo),t.push(e[i].empleado.empleadosFichas[e[i].empleado.empleadosFichas.length-1].aporteSeguroLargoPlazo.nombre),t.push(e[i].empleado.persona.ciudad?e[i].empleado.persona.ciudad.nombre:""),t.push(e[i].empleado.persona.provincia?e[i].empleado.persona.provincia.nombre:""),t.push(e[i].empleado.persona.localidad?e[i].empleado.persona.localidad.nombre:""),t.push(e[i].empleado.persona.direccion_numero),t.push(e[i].empleado.campo.nombre),t.push(""),t.push(e[i].persona.nombres),t.push(e[i].persona.apellido_paterno),t.push(e[i].persona.apellido_materno),t.push(new Date(e[i].persona.fecha_nacimiento)),t.push(e[i].persona.genero.nombre),t.push(e[i].edad),t.push(null!=e[i].afiliado&&e[i].afiliado?"si":"no"),t.push(e[i].relacion.nombre),o.push(i),a.push(t)}var r=new Workbook,n=sheet_from_array_of_arrays(a);r.SheetNames.push("SheetJS"),r.Sheets.SheetJS=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"EMPLEADO RRHH.xlsx"),E.stop()},S.inicio()}]),angular.module("agil.controladores").controller("ControladorEstadoCuentasProveedores",["$scope","$localStorage","$location","$templateCache","$route","blockUI","$timeout","uiGmapGoogleMapApi","$cordovaGeolocation","ReportEstadoCuentasProveedoresDatos","InventariosCosto",function(l,e,a,o,i,d,t,r,n,s,c){d.start(),l.usuario=JSON.parse(e.usuario),l.inicio=function(){l.proveedores=s.show({id_empresa:l.usuario.id_empresa}),setTimeout(function(){ejecutarScriptsTabla("tabla-estadoCuentaProveedores",10)},2e3),r.then(function(e){l.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},l.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE}})},l.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsProveedor("modal-wizard-proveedor","modal-wizard-proveedor-vista","dialog-eliminar-proveedor","modal-wizard-container-proveedor-edicion","modal-wizard-container-proveedor-vista"),l.buscarAplicacion(l.usuario.aplicacionesUsuario,a.path().substring(1)),d.stop()}),l.generarPdfEstadoCuentasProveedor=function(e){d.start();var a=new PDFDocument({size:"letter",margin:10}),o=a.pipe(blobStream()),i=0,t=120,r=0,n=1,s=Math.ceil(e.compras.length/33);l.dibujarCabeceraPDFEstadoCuentasProveedor(a,1,s,e),a.font("Helvetica",8);for(var c=0;c<e.compras.length&&r<=33;c++)a.rect(30,t-10,555,20).stroke(),e.compras[c].fecha=new Date(e.compras[c].fecha),a.text(e.compras[c].fecha.getDate()+"/"+(e.compras[c].fecha.getMonth()+1)+"/"+e.compras[c].fecha.getFullYear(),45,t),a.text(e.compras[c].id_movimiento,170,t,{width:45,align:"right"}),null==e.compras[c].factura?a.text("PROFORMA",240,t):a.text("Factura nro. "+e.compras[c].factura,240,t),a.text(e.compras[c].saldo,445,t,{width:50,align:"right"}),i+=e.compras[c].saldo,a.text(i,500,t,{width:50,align:"right"}),t+=20,33==++r&&(a.addPage({margin:0,bufferPages:!0}),t=120,r=0,n+=1,l.dibujarCabeceraPDFEstadoCuentasProveedor(a,n,s,Proveedor),a.font("Helvetica",8));a.rect(30,t-10,555,20).stroke(),a.font("Helvetica-Bold",8),a.text("Total General",350,t),a.text(i,446,t,{width:50,align:"right"}),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),d.stop()},l.generarExcelEstadoCuentasProveedor=function(e){for(var a=[["","","ESTADO CUENTAS PROVEEDOR"],["Deudor :"+e.razon_social],["Fecha","N Recibo","Descripción","monto","total","total General"]],o=0,i=0;i<e.compras.length;i++){var t=[];o+=e.compras[i].saldo,e.compras[i].fecha=new Date(e.compras[i].fecha),t.push(e.compras[i].fecha.getDate()+"/"+(e.compras[i].fecha.getMonth()+1)+"/"+e.compras[i].fecha.getFullYear()),t.push(e.compras[i].id_movimiento),null==e.compras[i].factura?t.push("PROFORMA"):t.push("factura : "+e.compras[i].factura),t.push(e.compras[i].saldo),t.push(o),t.push(o),a.push(t)}var r=new Workbook,n=sheet_from_array_of_arrays(a);r.SheetNames.push("SheetJS"),r.Sheets.SheetJS=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"REPORTE-ESTADO-CUENTA-PROVEEDOR.xlsx"),d.stop()},l.dibujarCabeceraPDFEstadoCuentasProveedor=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("ESTADO DE CUENTAS",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"}),e.rect(30,50,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Acreedor : ",45,60),e.font("Helvetica",8),e.text(i.razon_social,140,60),e.rect(30,80,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,90),e.text("Nro. Recibo",170,90,{width:50}),e.text("Descripción",240,90,{width:60}),e.text("Monto",470,90,{width:50}),e.text("Total",530,90,{width:50}),e.font("Helvetica",8)},l.inicio()}]).controller("ControladorEstadoCuentasClientes",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","$timeout","Paginator","uiGmapGoogleMapApi","$cordovaGeolocation","ReportEstadoCuentasClientesDatos","InventariosCosto","ReporteClientesPaginador",function(p,e,a,o,i,t,m,r,n,s,c,l,d,u){m.start(),p.idModalTablaEstadoCuenta="tabla-estado-cuenta",p.usuario=JSON.parse(a.usuario),p.inicio=function(){p.obtenerClientes(),s.then(function(e){p.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},p.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE}})},p.$on("$viewContentLoaded",function(){ejecutarScriptsCliente(p.idModalTablaEstadoCuenta),m.stop()}),p.obtenerClientes=function(){p.paginator=n(),p.paginator.column="codigo",p.paginator.callBack=p.obtenerLista,p.filtro={empresa:p.usuario.id_empresa,cuentas_liquidadas:0},p.paginator.getSearch("",p.filtro,null)},p.obtenerLista=function(){m.start(),u(p.paginator).then(function(e){p.paginator.setPages(e.paginas),p.clientes=e.clientes,m.stop()})},p.generarExcelEstadoCuentasClientesSeleccionados=function(e){for(var a=[],o=0;o<e.length;o++)(a=a.concat(p.generarExcelCliente(e[o],0))).push([]);var i=new Workbook,t=sheet_from_array_of_arrays(a);i.SheetNames.push("SheetJS"),i.Sheets.SheetJS=t;var r=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"REPORTE-ESTADO-CUENTA-CLIENTES.xlsx"),m.stop()},p.generarExcelCliente=function(e,a){for(var o=[["","","ESTADO CUENTAS CLIENTE"],["Deudor :"+e.razon_social],["Fecha","N Recibo","Descripción","monto","total","total General"]],i=0,t=0;t<e.ventas.length;t++){var r=[];if(i+=e.ventas[t].saldo,e.ventas[t].fecha=new Date(e.ventas[t].fecha),r.push(e.ventas[t].fecha.getDate()+"/"+(e.ventas[t].fecha.getMonth()+1)+"/"+e.ventas[t].fecha.getFullYear()),r.push(e.ventas[t].id_movimiento),"FACT"!=e.ventas[t].movimiento.clase.nombre_corto?r.push("PROFORMA :"+e.ventas[t].factura):r.push("Factura : "+e.ventas[t].factura),r.push(e.ventas[t].saldo),r.push(i),r.push(i),o.push(r),0!=a&&0!=e.ventas[t].pagosVenta.length)for(var n=0;n<e.ventas[t].pagosVenta.length;n++){var s=[];date=new Date(e.ventas[t].pagosVenta[n].createdAt),s.push(""),s.push(date.getDate()+"/"+(date.getMonth()+1)+"/"+date.getFullYear()),s.push(e.ventas[t].pagosVenta[n].numero_documento),s.push("Pago a/c Factura nro.  "+e.ventas[t].factura+"("+e.ventas[t].pagosVenta[n].total+" -)"),s.push(e.ventas[t].pagosVenta[n].total),o.push(s)}}return o},p.verificarPulso=function(e,a){13===e.keyCode&&p.buscarClientes(1,p.itemsPorPagina,a)},p.generarPdfEstadoCuentasCliente=function(e,a){m.start();var o=new PDFDocument({size:"letter",margin:10}),i=o.pipe(blobStream()),t=0,r=120,n=0,s=1,c=Math.ceil(e.ventas.length/33);p.dibujarCabeceraPDFEstadoCuentasCliente(o,1,c,e),o.font("Helvetica",8);for(var l=0;l<e.ventas.length&&n<=33;l++){if(o.rect(30,r-10,555,20).stroke(),e.ventas[l].fecha=new Date(e.ventas[l].fecha),o.text(e.ventas[l].fecha.getDate()+"/"+(e.ventas[l].fecha.getMonth()+1)+"/"+e.ventas[l].fecha.getFullYear(),45,r),o.text(e.ventas[l].id_movimiento,170,r,{width:45,align:"right"}),"FACT"!=e.ventas[l].movimiento.clase.nombre_corto?o.text("PROFORMA nro. "+e.ventas[l].factura+"  (Bs. "+e.ventas[l].total+")",240,r):o.text("Factura nro. "+e.ventas[l].factura+" (Bs. "+e.ventas[l].total+")",240,r),o.text(e.ventas[l].saldo,475,r,{width:50,align:"right"}),o.text(e.ventas[l].fecha_vencimiento.getDate()+"/"+(e.ventas[l].fecha_vencimiento.getMonth()+1)+"/"+e.ventas[l].fecha_vencimiento.getFullYear(),425,r,{width:50,align:"right"}),t+=e.ventas[l].saldo,o.text(t,530,r,{width:50,align:"right"}),0!=a&&0!=e.ventas[l].pagosVenta.length)for(var d=0;d<e.ventas[l].pagosVenta.length;d++)r+=20,o.rect(30,r-10,0,20).stroke(),o.rect(585,r-10,0,20).stroke(),date=new Date(e.ventas[l].pagosVenta[d].createdAt),o.text(date.getDate()+"/"+(date.getMonth()+1)+"/"+date.getFullYear(),100,r,{width:50,align:"right"}),o.text(e.ventas[l].pagosVenta[d].numero_documento,170,r,{width:50,align:"right"}),"FACT"!=e.ventas[l].movimiento.clase.nombre_corto?o.text("Pago a/c Proforma nro.  "+e.ventas[l].factura+" ("+e.ventas[l].pagosVenta[d].total+" -)  (Bs. "+e.ventas[l].pagosVenta[d].monto_pagado+")",240,r):o.text("Pago a/c Factura nro.  "+e.ventas[l].factura+" ("+e.ventas[l].pagosVenta[d].total+" -)  (Bs. "+e.ventas[l].pagosVenta[d].monto_pagado+")",240,r),o.text(e.ventas[l].pagosVenta[d].total,475,r,{width:50,align:"right"});r+=20,33==++n&&(o.addPage({margin:0,bufferPages:!0}),r=120,n=0,s+=1,p.dibujarCabeceraPDFEstadoCuentasCliente(o,s,c,e),o.font("Helvetica",8))}o.rect(30,r-10,555,20).stroke(),o.font("Helvetica-Bold",8),o.text("Total General",380,r),o.text(t,475,r,{width:50,align:"right"});var u=new Date;o.font("Helvetica",6),o.text("EMISIÓN: "+u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear(),180,r+15),o.text("IMPRESIÓN: "+u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear(),240,r+15),o.text("USUARIO: "+p.usuario.persona.nombre_completo,35,r+15),c<s||o.text(s+" de "+c,560,r+15),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),m.stop()},p.generarExcelEstadoCuentasCliente=function(e,a){var o=p.generarExcelCliente(e,a),i=new Workbook,t=sheet_from_array_of_arrays(o);i.SheetNames.push("SheetJS"),i.Sheets.SheetJS=t;var r=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"REPORTE-ESTADO-CUENTA-CLIENTES.xlsx"),m.stop()},p.click=function(){setTimeout(function(){angular.element(document.getElementsByClassName("verDetallePago")).triggerHandler("click")},0)},p.dibujarCabeceraPDFEstadoCuentasCliente=function(e,a,o,i){e.font("Helvetica-Bold",8),e.text(p.usuario.empresa.razon_social,35,10),e.font("Helvetica",8),e.text(p.usuario.empresa.direccion,35,20);var t=(null!=p.usuario.empresa.telefono1?p.usuario.empresa.telefono1:"")+(null!=p.usuario.empresa.telefono2?"-"+p.usuario.empresa.telefono2:"")+(null!=p.usuario.empresa.telefono3?"-"+p.usuario.empresa.telefono3:"");e.text("TELF. :"+t,35,30),e.text("COCHABAMBA - BOLIVIA ",35,40),e.font("Helvetica",8),e.font("Helvetica-Bold",12),e.text("ESTADO DE CUENTAS",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,740,{align:"center"}),e.rect(30,50,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Deudor : ",45,60),e.font("Helvetica",8),e.text(i.razon_social,140,60),e.rect(30,80,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,90),e.text("Nro. Recibo",170,90,{width:50}),e.text("Descripción",240,90,{width:60}),e.text("F.Venc",440,90,{width:50}),e.text("Saldo",500,90,{width:50}),e.text("Total",560,90,{width:50}),e.font("Helvetica",8)},p.abrirEstadoCuentaCliente=function(e){for(var a=p.totalPagado=0;a<e.ventas.length;a++){var o=new Date(e.ventas[a].fecha);e.ventas[a].totalgeneral=0,e.ventas[a].totalPago=0,e.ventas[a].totalgeneral=0==a?e.ventas[a].totalgeneral+e.ventas[a].saldo:e.ventas[a-1].totalgeneral+e.ventas[a].saldo;for(var i=0;i<e.ventas[a].pagosVenta.length;i++)e.ventas[a].pagosVenta[i].total=e.ventas[a].pagosVenta[i].saldo_anterior-e.ventas[a].pagosVenta[i].monto_pagado,e.ventas[a].totalPago=e.ventas[a].totalPago+e.ventas[a].pagosVenta[i].monto_pagado;e.ventas[a].fecha_vencimiento=p.sumaFecha(e.ventas[a].dias_credito,o)}a=e.ventas.length-1;p.totalgeneral=0,p.totalgeneral=e.ventas[a].totalgeneral,p.clienteVentas=e,p.abrirPopup(p.idModalTablaEstadoCuenta)},p.verDetallePagos=function(e){"none"==$("#"+e.id_movimiento).css("display")?$("#"+e.id_movimiento).css("display",""):$("#"+e.id_movimiento).css("display","none")},p.cerrarEstadoCuentaCliente=function(){p.cerrarPopup(p.idModalTablaEstadoCuenta)},p.abrirPopup=function(e){abrirPopup(e)},p.cerrarPopup=function(e){ocultarPopup(e)},p.eliminarPopup=function(e){eliminarPopup(e)},p.imprimirRecibo=function(e,a){m.start();var o=new PDFDocument({size:[227,353],margin:10}),i=o.pipe(blobStream());o.moveDown(2),o.font("Helvetica-Bold",8),o.text(p.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),o.moveDown(.4),o.font("Helvetica",7),o.text(a.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),o.moveDown(.4),o.text(a.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),o.moveDown(.4);var t=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");o.text("TELF.: "+t,{align:"center"}),o.moveDown(.4),o.text("COCHABAMBA - BOLIVIA",{align:"center"}),o.moveDown(.5),o.font("Helvetica-Bold",8),o.text("RECIBO",{align:"center"}),o.font("Helvetica",7),o.moveDown(.4),o.text("------------------------------------",{align:"center"}),o.moveDown(.4),o.text(e.numero_documento,{align:"center"}),o.moveDown(.4),o.moveDown(.4),o.text("------------------------------------",{align:"center"}),o.moveDown(.4),o.moveDown(.6);var r=new Date;o.text("FECHA : "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),{align:"left"}),o.moveDown(.4),o.text("He recibido de : "+p.clienteVentas.razon_social,{align:"left"}),o.moveDown(.4),o.text("---------------------------------------------------------------------------------",{align:"center"}),o.moveDown(.2),o.text("CONCEPTO",{align:"left"}),o.moveDown(.2),o.text("---------------------------------------------------------------------------------",{align:"center"}),o.moveDown(.4),a.fecha=new Date(a.fecha),o.text("Fecha: "+a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear(),15,210);var n=a.movimiento.clase.nombre_corto==p.diccionario.EGRE_FACTURACION?"Factura nro. "+a.factura:"Proforma nro. "+a.factura;o.text(n,105,210,{width:100}),o.text("Saldo Bs "+e.saldo_anterior+".-",105,220,{width:100}),o.text("Bs "+e.monto_pagado+".-",170,210,{width:100}),o.text("--------------",10,230,{align:"right"}),o.moveDown(.3),o.text("TOTAL Bs.              "+e.monto_pagado,{align:"right"}),o.moveDown(.4),o.moveDown(.4),o.moveDown(.6),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.text("-------------------------                       -------------------------",{align:"center"}),o.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),m.stop()},p.$on("$routeChangeStart",function(e,a){p.eliminarPopup(p.idModalTablaEstadoCuenta)}),p.inicio()}]).controller("ControladorLibroVentas",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","ReporteLibroVentasDatos",function(x,e,a,o,i,S,t,n){x.usuario=JSON.parse(e.usuario),x.inicio=function(){x.obtenerGestiones(),x.obtenerMovimientosEgreso()},x.obtenerGestiones=function(){S.start(),t("GTN").then(function(e){x.gestiones=e.clases,S.stop()})},x.obtenerMovimientosEgreso=function(){S.start(),t("MOVEGR").then(function(e){x.movimientosEgreso=e.clases,S.stop()})},x.generarTXTLibroVentas=function(r){S.start(),n(x.usuario.id_empresa,r.gestion,r.mes.split("-")[0]).then(function(e){for(var a=e.ventas,o="",i=0;i<a.length;i++)a[i].fecha=new Date(a[i].fecha),o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=(o=o+a[i].fecha.getDate()+"/"+(a[i].fecha.getMonth()+1)+"/"+a[i].fecha.getFullYear()+"|")+a[i].factura+"|")+a[i].autorizacion+"|")+(a[i].activa?"V":"A")+"|")+a[i].cliente.nit+"|")+a[i].cliente.razon_social+"|")+a[i].importe+"|")+0+"|")+0+"|")+0+"|")+a[i].importe+"|")+0+"|")+a[i].total+"|")+Math.round(.13*a[i].total*100)/100+"|",o+=a[i].codigo_control,o+="\n";var t=new Blob([o.replace(/\n/g,"\r\n")],{type:"text/plain"});saveAs(t,"ventas_"+r.mes.split("-")[0]+r.gestion+"_"+e.empresa.nit+".txt"),S.stop()})},x.generarExcelLibroVentas=function(e){S.start(),n(x.usuario.id_empresa,e.gestion,e.mes.split("-")[0]).then(function(e){for(var a=e.ventas,o=[["N°","FECHA DE LA FACTURA","N° DE LA FACTURA","N° DE AUTORIZACION","ESTADO","NIT/CI CLIENTE","NOMBRE O RAZON SOCIAL","IMPORTE TOTAL DE LA VENTA","IMPORTE ICE/IEHD/TASAS","EXPORTACIONES Y OPERACIONES EXENTAS","VENTAS GRAVADAS A TASA CERO","SUBTOTAL","DESCUENTOS, BONIFICACIONES Y REBAJAS OBTENIDAS","IMPORTE BASE PARA DEBITO FISCAL","DEBITO FISCAL","CODIGO DE CONTROL"]],i=0,t=0,r=0,n=0,s=0,c=0,l=0,d=0,u=0;u<a.length;u++){var p=[];a[u].fecha=new Date(a[u].fecha),p.push(u+1),p.push(a[u].fecha.getDate()+"/"+(a[u].fecha.getMonth()+1)+"/"+a[u].fecha.getFullYear()),p.push(a[u].factura),p.push(a[u].autorizacion?a[u].autorizacion:""),p.push(a[u].activa?"V":"A"),p.push(a[u].cliente.nit),p.push(a[u].cliente.razon_social),p.push(a[u].importe),p.push(0),p.push(0),p.push(0),p.push(a[u].importe),p.push(0),p.push(a[u].total),p.push(Math.round(.13*a[u].total*100)/100),p.push(a[u].codigo_control?a[u].codigo_control:""),i+=a[u].importe,n=r=t=0,s+=a[u].importe,c+=0,l+=a[u].total,d+=Math.round(.13*a[u].total*100)/100,o.push(p),u+1==a.length&&((p=[]).push(""),p.push(""),p.push(""),p.push(""),p.push(""),p.push(""),p.push("TOTALES"),p.push(Math.round(100*i)/100),p.push(Math.round(100*t)/100),p.push(Math.round(100*r)/100),p.push(Math.round(100*n)/100),p.push(Math.round(100*s)/100),p.push(Math.round(100*c)/100),p.push(Math.round(100*l)/100),p.push(Math.round(100*d)/100),o.push(p))}var m=new Workbook,f=sheet_from_array_of_arrays(o);m.SheetNames.push("SheetJS"),m.Sheets.SheetJS=f;var g=XLSX.write(m,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(g)],{type:"application/octet-stream"}),"LIBRO-VENTAS.xlsx"),S.stop()})},x.generarPdfLibroVentas=function(E){S.start(),n(x.usuario.id_empresa,E.gestion,E.mes.split("-")[0],E.movimiento).then(function(e){var a=e.ventas,o=new PDFDocument({compress:!1,margin:10,layout:"landscape"}),i=o.pipe(blobStream());x.dibujarCabeceraPDFLibroVentas(o,e,E,1),o.font("Helvetica",8);for(var t=170,r=0,n=1,s=0,c=0,l=0,d=0,u=0,p=0,m=0,f=0,g=0,v=0,h=0,b=0,C=0,P=0,_=0,M=0,D=0;D<a.length&&r<=12;D++)o.rect(40,t-10,720,30).stroke(),a[D].fecha=new Date(a[D].fecha),o.text(D+1,45,t),o.text(a[D].fecha.getDate()+"/"+(a[D].fecha.getMonth()+1)+"/"+a[D].fecha.getFullYear(),65,t),o.text(a[D].factura,110,t),o.text(a[D].autorizacion,145,t),o.text(a[D].activa?"V":"A",210,t),o.text(a[D].cliente.nit,235,t),o.text(a[D].cliente.razon_social,283,t-6,{width:100}),o.text(a[D].importe,385,t),o.text(0,430,t),o.text(0,465,t),o.text(0,507,t),o.text(a[D].importe,540,t),o.text(0,580,t),o.text(a[D].total,615,t),o.text(Math.round(.13*a[D].total*100)/100,650,t),o.text(a[D].codigo_control,685,t),t+=30,g+=a[D].importe,b=h=v=0,C+=a[D].importe,P+=0,_+=a[D].total,M+=Math.round(.13*a[D].total*100)/100,s+=a[D].importe,d=l=c=0,u+=a[D].importe,p+=0,m+=a[D].total,f+=Math.round(.13*a[D].total*100)/100,12!=++r&&D+1!=a.length||(o.font("Helvetica-Bold",8),o.text("SUBTOTALES",283,t),o.text(Math.round(100*g)/100,385,t),o.text(Math.round(100*v)/100,430,t),o.text(Math.round(100*h)/100,465,t),o.text(Math.round(100*b)/100,507,t),o.text(Math.round(100*C)/100,540,t),o.text(Math.round(100*P)/100,580,t),o.text(Math.round(100*_)/100,615,t),o.text(Math.round(100*M)/100,650,t),o.rect(40,t-10,720,30).stroke(),o.font("Helvetica",8),g=0,M=_=P=C=sumaSubImporteNo=0,D+1==a.length?(o.font("Helvetica-Bold",8),o.text("TOTALES",283,t+30),o.text(Math.round(100*s)/100,385,t+30),o.text(Math.round(100*c)/100,430,t+30),o.text(Math.round(100*l)/100,465,t+30),o.text(Math.round(100*d)/100,507,t+30),o.text(Math.round(100*u)/100,540,t+30),o.text(Math.round(100*p)/100,580,t+30),o.text(Math.round(100*m)/100,615,t+30),o.text(Math.round(100*f)/100,650,t+30),o.rect(40,t-10+30,720,30).stroke()):(o.addPage({margin:0,bufferPages:!0,layout:"landscape"}),t=170,r=0,n+=1,x.dibujarCabeceraPDFLibroVentas(o,e,E,n)),o.font("Helvetica",8));o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),S.stop()})},x.dibujarCabeceraPDFLibroVentas=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("LIBRO DE VENTAS IVA ESTÁNDAR",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FOLIO "+i,720,25),e.rect(40,60,720,40).stroke(),e.text("PERIÓDO FISCAL : ",65,70),e.text("NOMBRE O RAZÓN SOCIAL : ",65,85),e.text("NIT : ",440,85),e.font("Helvetica",8),e.text("AÑO "+o.gestion,140,70),e.text("MES "+o.mes.split("-")[1],200,70),e.text(a.empresa.razon_social,195,85),e.text(a.empresa.nit,460,85),e.rect(40,100,720,60).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",45,110),e.text("Fecha de la Factura",65,110,{width:40}),e.text("Nº de la Factura",110,110,{width:50}),e.text("Nº de Autorización",145,110,{width:50}),e.text("Estado",205,110,{width:35}),e.text("NIT / CI Cliente",235,110,{width:50}),e.text("Nombre o Razón Social",280,110),e.text("Importe Total de la Venta",385,110,{width:35}),e.text("Importe ICE IE HD/T",425,110,{width:35}),e.text("Exp. y Op. exentas",460,110,{width:42}),e.text("Ventas grabadas a Tasa Cero",502,110,{width:42}),e.text("Subtotal",540,110,{width:40}),e.text("Desc., Bonif. y Rebajas",575,110,{width:42}),e.text("Importe Base para Débito Fiscal",615,110,{width:35}),e.text("Débito Fiscal I.V.A.",650,110,{width:35}),e.text("Código de Control",685,110)},x.inicio()}]).controller("ControladorLibroCompras",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","ReporteLibroComprasDatos",function(D,e,a,o,i,E,t,r){D.usuario=JSON.parse(e.usuario),D.inicio=function(){D.obtenerGestiones()},D.obtenerGestiones=function(){E.start(),t("GTN").then(function(e){D.gestiones=e.clases,E.stop()})},D.generarTXTLibroCompras=function(n){E.start(),r(D.usuario.id_empresa,n.gestion,n.mes.split("-")[0]).then(function(e){for(var a=e.compras,o="",i=1,t=0;t<a.length;t++){if(a[t].movimiento.clase.nombre!==D.diccionario.MOVING_POR_COMPRA_SIN_FACTURA&&a[t].movimiento.clase.nombre!==D.diccionario.MOVING_POR_RETENCION_BIENES)a[t].fecha=new Date(a[t].fecha),o=(o=(o=(o=(o=(o+="1|")+i+"|")+(a[t].fecha.getDate()<10?"0"+a[t].fecha.getDate():a[t].fecha.getDate())+"/"+(a[t].fecha.getMonth()+1<10?"0"+(a[t].fecha.getMonth()+1):a[t].fecha.getMonth()+1)+"/"+a[t].fecha.getFullYear()+"|")+a[t].proveedor.nit+"|")+a[t].proveedor.razon_social+"|")+a[t].factura+"|",o=(o=(o=(o=(o=(o=(o=(o=(o+="0|")+a[t].autorizacion+"|")+a[t].importe+"|")+0+"|")+a[t].importe+"|")+(a[t].descuento-a[t].recargo+a[t].ice+a[t].excento)+"|")+a[t].total+"|")+Math.round(.13*a[t].total*100)/100+"|")+a[t].codigo_control+"|",o+="1\n",i++}var r=new Blob([o.replace(/\n/g,"\r\n")],{type:"text/plain"});saveAs(r,"compras_"+n.mes.split("-")[0]+n.gestion+"_"+e.empresa.nit+".txt"),E.stop()})},D.generarExcelLibroCompras=function(e){E.start(),r(D.usuario.id_empresa,e.gestion,e.mes.split("-")[0]).then(function(e){for(var a=e.compras,o=[["N°","FECHA DE LA FACTURA O DUI","NIT PROVEEDOR","NOMBRE Y APELLIDOS/RAZON SOCIAL","N° DE LA FACTURA","N° DE DUI","N° DE AUTORIZACION","IMPORTE TOTAL DE LA COMPRA","IMPORTE NO SUJETO A CREDITO FISCAL","SUBTOTAL","DESCUENTOS, BONIFICACIONES Y REBAJAS OBTENIDAS","IMPORTE BASE PARA CREDITO FISCAL","CREDITO FISCAL","CODIGO DE CONTROL","TIPO DE COMPRA"]],i=0,t=0,r=0,n=0,s=0,c=0,l=1,d=0;d<a.length;d++){var u=[];if(a[d].movimiento.clase.nombre!==D.diccionario.MOVING_POR_COMPRA_SIN_FACTURA&&a[d].movimiento.clase.nombre!==D.diccionario.MOVING_POR_RETENCION_BIENES){a[d].fecha=new Date(a[d].fecha),u.push(l),u.push(a[d].fecha.getDate()+"/"+(a[d].fecha.getMonth()+1)+"/"+a[d].fecha.getFullYear()),u.push(a[d].proveedor.nit),u.push(a[d].proveedor.razon_social),u.push(a[d].factura),u.push(0),u.push(a[d].autorizacion),u.push(a[d].importe),u.push(0),u.push(a[d].importe);var p=a[d].descuento-a[d].recargo+a[d].ice+a[d].excento;u.push(p),u.push(a[d].total),u.push(Math.round(.13*a[d].total*100)/100),u.push(a[d].codigo_control),u.push(1),i+=a[d].importe,t=0,r+=a[d].importe,n+=p,s+=a[d].total,c+=Math.round(.13*a[d].total*100)/100,o.push(u),d+1==a.length&&((u=[]).push(""),u.push(""),u.push(""),u.push(""),u.push(""),u.push(""),u.push("TOTALES"),u.push(Math.round(100*i)/100),u.push(Math.round(100*t)/100),u.push(Math.round(100*r)/100),u.push(Math.round(100*n)/100),u.push(Math.round(100*s)/100),u.push(Math.round(100*c)/100),o.push(u)),l++}}var m=new Workbook,f=sheet_from_array_of_arrays(o);m.SheetNames.push("SheetJS"),m.Sheets.SheetJS=f;var g=XLSX.write(m,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(g)],{type:"application/octet-stream"}),"LIBRO-COMPRAS.xlsx"),E.stop()})},D.generarPdfLibroCompras=function(M){E.start(),r(D.usuario.id_empresa,M.gestion,M.mes.split("-")[0]).then(function(e){var a=e.compras,o=new PDFDocument({margin:10,layout:"landscape"}),i=o.pipe(blobStream());D.dibujarCabeceraPDFLibroCompras(o,e,M,1),o.font("Helvetica",8);for(var t=1,r=170,n=0,s=1,c=0,l=0,d=0,u=0,p=0,m=0,f=0,g=0,v=0,h=0,b=0,C=0,P=0;P<a.length&&n<=12;P++)if(a[P].movimiento.clase.nombre!==D.diccionario.MOVING_POR_COMPRA_SIN_FACTURA&&a[P].movimiento.clase.nombre!==D.diccionario.MOVING_POR_RETENCION_BIENES){o.rect(40,r-10,720,30).stroke(),a[P].fecha=new Date(a[P].fecha),o.text(t,45,r),o.text(a[P].fecha.getDate()+"/"+(a[P].fecha.getMonth()+1)+"/"+a[P].fecha.getFullYear(),65,r),o.text(a[P].proveedor.nit,110,r),o.text(a[P].proveedor.razon_social,165,r-6,{width:100}),o.text(a[P].factura,275,r),o.text(0,320,r),o.text(a[P].autorizacion,335,r),o.text(a[P].importe,410,r),o.text(0,450,r),o.text(a[P].importe,480,r);var _=a[P].descuento-a[P].recargo+a[P].ice+a[P].excento;o.text(_,520,r),o.text(a[P].total,565,r),o.text(Math.round(.13*a[P].total*100)/100,605,r),o.text(a[P].codigo_control,640,r),o.text(1,740,r),r+=30,f+=a[P].importe,g=0,v+=a[P].importe,h+=_,b+=a[P].total,C+=Math.round(.13*a[P].total*100)/100,c+=a[P].importe,l=0,d+=a[P].importe,u+=_,p+=a[P].total,m+=Math.round(.13*a[P].total*100)/100,12!=++n&&P+1!=a.length||(o.font("Helvetica-Bold",8),o.text("SUBTOTALES",320,r),o.text(Math.round(100*f)/100,400,r),o.text(Math.round(100*g)/100,450,r),o.text(Math.round(100*v)/100,480,r),o.text(Math.round(100*h)/100,520,r),o.text(Math.round(100*b)/100,565,r),o.text(Math.round(100*C)/100,605,r),o.rect(40,r-10,720,30).stroke(),o.font("Helvetica",8),C=b=h=v=g=f=0,P+1==a.length?(o.font("Helvetica-Bold",8),o.text("TOTALES",320,r+30),o.text(Math.round(100*c)/100,400,r+30),o.text(Math.round(100*l)/100,450,r+30),o.text(Math.round(100*d)/100,480,r+30),o.text(Math.round(100*u)/100,520,r+30),o.text(Math.round(100*p)/100,565,r+30),o.text(Math.round(100*m)/100,605,r+30),o.rect(40,r-10+30,720,30).stroke()):(o.addPage({margin:0,bufferPages:!0,layout:"landscape"}),r=170,n=0,s+=1,D.dibujarCabeceraPDFLibroCompras(o,e,M,s)),o.font("Helvetica",8)),t++}o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),E.stop()})},D.dibujarCabeceraPDFLibroCompras=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("LIBRO DE COMPRAS IVA ESTÁNDAR",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FOLIO "+i,720,25),e.rect(40,60,720,40).stroke(),e.text("PERIÓDO FISCAL : ",65,70),e.text("NOMBRE O RAZÓN SOCIAL : ",65,85),e.text("NIT : ",440,85),e.font("Helvetica",8),e.text("AÑO "+o.gestion,140,70),e.text("MES "+o.mes.split("-")[1],200,70),e.text(a.empresa.razon_social,195,85),e.text(a.empresa.nit,460,85),e.rect(40,100,720,60).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",45,110),e.text("Fecha de la Factura o DUI",65,110,{width:40}),e.text("NIT Proveedor",110,110,{width:50}),e.text("Nombre o Razón Social",165,110),e.text("Nº de la Factura",275,110,{width:50}),e.text("Nº de DUI",320,110,{width:30}),e.text("Nº de Autorización",345,110,{width:50}),e.text("Importe Total de la Compra",400,110,{width:35}),e.text("Importe No Sujeto a Crédito Fiscal",440,110,{width:35}),e.text("Subtotal",480,110),e.text("Descuentos, Bonificaciones y Rebajas",520,110,{width:40}),e.text("Importe Base para Crédito Fiscal",565,110,{width:35}),e.text("Crédito Fiscal I.V.A.",605,110,{width:35}),e.text("Código de Control",640,110),e.text("Tipo de Compra",720,110,{width:35})},D.inicio()}]).controller("ControladorReporteAlmacenes",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","InventariosCosto","InventarioPaginadorAlmacen","InventarioReporteAlmacen",function(p,e,a,o,i,t,m,r,s,f){p.usuario=JSON.parse(a.usuario),p.inicio=function(){p.sucursales=p.obtenerSucursales(),p.reporte={},p.itemsPorPagina=10,p.paginaActual=1,p.columna="cantidad",p.direccion="asc",p.textoBusqueda="",p.reporte.sucursal=1==p.sucursales.length?p.sucursales[0]:null,1==p.sucursales.length&&(p.obtenerAlmacenes(p.sucursales[0].id),p.reporte.almacen=1==p.almacenes.length?p.almacenes[0]:null)},p.obtenerAlmacenes=function(a){if(p.almacenes=[],null!=a){var e=$.grep(p.sucursales,function(e){return e.id==a})[0];p.almacenes=p.almacenes.concat(e.almacenes),p.reporte.almacen=1==p.almacenes.length?p.almacenes[0]:null}p.obtenerInventarios()},p.obtenerSucursales=function(){for(var e=[],a=0;a<p.usuario.sucursalesUsuario.length;a++)e.push(p.usuario.sucursalesUsuario[a].sucursal);return e},p.establecerAlmacenBusqueda=function(e){p.almacenBusqueda=e.almacen,p.sucursalBusqueda=e.sucursal,p.obtenerInventarios()},p.obtenerInventarios=function(){p.abs=e.Math.abs,void 0!==p.reporte.sucursal&&null!==p.reporte.sucursal?(p.sucursalBusqueda=p.reporte.sucursal,void 0!==p.reporte.almacen&&p.reporte.almacen?(p.almacenBusqueda=p.reporte.almacen,p.buscarInventarios(p.sucursalBusqueda.id,p.almacenBusqueda.id,p.paginaActual,p.itemsPorPagina,p.textoBusqueda,p.columna,p.direccion)):p.buscarInventarios(p.sucursalBusqueda.id,0,p.paginaActual,p.itemsPorPagina,p.textoBusqueda,p.columna,p.direccion)):(1==p.sucursales.length&&(p.reporte.sucursal=1==p.sucursales.length?p.sucursales[0]:null,1==p.sucursales.length&&(p.obtenerAlmacenes(p.sucursales[0].id),p.reporte.almacen=2==p.almacenes.length?p.almacenes[1]:null)),p.buscarInventarios(p.sucursalBusqueda.id,p.almacenBusqueda.id,p.paginaActual,p.itemsPorPagina,p.textoBusqueda,p.columna,p.direccion))},p.clasificarColumna=function(e){p.columna==e?"asc"==p.direccion?(p.direccion="desc",$("#"+e).removeClass("fa-caret-up"),$("#"+e).addClass("fa-caret-down")):(p.direccion="asc",$("#"+e).removeClass("fa-caret-down"),$("#"+e).addClass("fa-caret-up")):(p.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+e).addClass("fa-caret-up"),$("#"+e).removeClass("fa-sort")),p.columna=e,void 0!==p.reporte.sucursal?(void 0!==p.reporte.almacen?p.almacenBusqueda=p.reporte.almacen:p.almacenBusqueda={id:0},p.buscarInventarios(p.reporte.sucursal.id,p.almacenBusqueda.id,p.paginaActual,p.itemsPorPagina,p.textoBusqueda,p.columna,p.direccion)):p.reporte.sucursal},p.buscarInventarios=function(e,a,o,i,t,r,n){m.start(),p.itemsPorPagina="TODOS"!==i?i:0,null!=e&&null!=e||(e=0),null!=a&&null!=a||(a=0),""==t||null==t?t=0:p.textoBusqueda=t,"todos"==i&&(i=p.inventarios.length*p.inventarios.paginas),p.paginaActual=o!=p.paginaActual?o:1,s(p.usuario.id_empresa,e,a,p.paginaActual,i,t,r,n,p.usuario.id).then(function(e){var a=e.inventario;p.paginas=[];for(var o=1;o<=e.paginas;o++)p.paginas.push(o);p.inventarios=a,p.inventarios.paginas=e.paginas,m.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:" Error desconocido al buscar inventarios en reportes almacen,";p.mostrarMensaje("ERROR. "+a),m.stop()})},p.generarPdfAlmacenes=function(e){if(m.start(),e.solo_pagina_actual){var a=p.inventarios,o=new PDFDocument({margin:10,compress:!1}),i=o.pipe(blobStream()),t=0,r=90,n=0,s=1,c=Math.ceil(a.length/33);p.dibujarCabeceraPDFAlmacenes(o,1,c),o.font("Helvetica",7);for(var l=0;l<a.length&&n<=33;l++){var d,u;if(o.rect(30,r-10,555,20).stroke(),o.text(a[l].codigo,35,r),o.text(a[l].cantidad,110,r),o.text(a[l].unidad_medida,160,r),p.usuario.empresa.usar_vencimientos?(35<a[l].nombre.length?o.text(a[l].nombre,210,r-6,{width:170}):o.text(a[l].nombre,210,r,{width:170}),a[l].fecha_vencimiento=new Date(a[l].fecha_vencimiento),o.text(a[l].fecha_vencimiento.getDate()+"/"+(a[l].fecha_vencimiento.getMonth()+1)+"/"+a[l].fecha_vencimiento.getFullYear(),380,r),o.text(null==a[l].lote?"No definido.":a[l].lote,430,r)):o.text(a[l].nombre,210,r),o.text(a[l].costo_unitario.toFixed(2),470,r),o.text(a[l].costo_total.toFixed(2),530,r),r+=20,n++,t+=a[l].costo_total,33==n)(u=(d=new Date).getMinutes())<10&&(u="0"+u),o.text("USUARIO: "+p.usuario.nombre_usuario,45,r),o.text("EMISIÓN : "+d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+" Hr. "+d.getHours()+":"+u,450,r),o.addPage({margin:0,bufferPages:!0}),r=90,n=0,s+=1,p.dibujarCabeceraPDFAlmacenes(o,s,c),o.font("Helvetica",7)}o.rect(30,r-10,555,20).stroke(),o.font("Helvetica-Bold",8),o.text("Total General",400,r),o.text(Math.round(100*t)/100,530,r),(u=(d=new Date).getMinutes())<10&&(u="0"+u),o.font("Helvetica",7),o.text("USUARIO: "+p.usuario.nombre_usuario,45,r+20),o.text("EMISIÓN : "+d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+" Hr. "+d.getHours()+":"+u,450,r+20),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})}else{f(p.usuario.id_empresa,e.sucursal.id,null!==e.almacen&&void 0!==e.almacen&&0!==e.almacen?e.almacen.id:0,p.usuario.id).then(function(e){var a=e.inventario,o=new PDFDocument({margin:10,compress:!1}),i=o.pipe(blobStream()),t=0,r=90,n=0,s=1,c=Math.ceil(a.length/33);p.dibujarCabeceraPDFAlmacenes(o,1,c),o.font("Helvetica",7);for(var l=0;l<a.length&&n<=33;l++){var d,u;if(o.rect(30,r-10,555,20).stroke(),o.text(a[l].codigo,35,r),o.text(a[l].cantidad,110,r),o.text(a[l].unidad_medida,160,r),p.usuario.empresa.usar_vencimientos?(35<a[l].nombre.length?o.text(a[l].nombre,210,r-6,{width:170}):o.text(a[l].nombre,210,r,{width:170}),a[l].fecha_vencimiento=new Date(a[l].fecha_vencimiento),o.text(a[l].fecha_vencimiento.getDate()+"/"+(a[l].fecha_vencimiento.getMonth()+1)+"/"+a[l].fecha_vencimiento.getFullYear(),380,r),o.text(null==a[l].lote?"No definido.":a[l].lote,430,r)):o.text(a[l].nombre,210,r),o.text(a[l].costo_unitario.toFixed(2),470,r),o.text(a[l].costo_total.toFixed(2),530,r),r+=20,n++,t+=a[l].costo_total,33==n)(u=(d=new Date).getMinutes())<10&&(u="0"+u),o.text("USUARIO: "+p.usuario.nombre_usuario,45,r),o.text("EMISIÓN : "+d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+" Hr. "+d.getHours()+":"+u,450,r),o.addPage({margin:0,bufferPages:!0}),r=90,n=0,s+=1,p.dibujarCabeceraPDFAlmacenes(o,s,c),o.font("Helvetica",7)}o.rect(30,r-10,555,20).stroke(),o.font("Helvetica-Bold",8),o.text("Total General",400,r),o.text(Math.round(100*t)/100,530,r),(u=(d=new Date).getMinutes())<10&&(u="0"+u),o.font("Helvetica",7),o.text("USUARIO: "+p.usuario.nombre_usuario,45,r+20),o.text("EMISIÓN : "+d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+" Hr. "+d.getHours()+":"+u,450,r+20),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})}m.stop()},p.generarExcelAlmacenes=function(e){if(m.start(),e.solo_pagina_actual){for(var a=p.inventarios,o=[["Código","Nombre","Unidad de Medida","Precio Unitario","Descripción","Inventario Mínimo","Grupo","Sub-Grupo","Carac. Esp. 1","Carac. Esp. 2","Codigo de fabrica","Cant.","Costo Unitario","Total General","Fecha Vencimiento","Lote","Sucursal","Almacen"]],i=0;i<a.length;i++){a[i].fecha_vencimiento=a[i].fecha_vencimiento?new Date(a[i].fecha_vencimiento):null;var t=[];t.push(a[i].codigo),t.push(a[i].nombre),t.push(a[i].unidad_medida),t.push(a[i].precio_unitario),t.push(a[i].descripcion),t.push(a[i].inventario_minimo),t.push(a[i].grupo),t.push(a[i].subgrupo),t.push(a[i].caracteristica_especial1),t.push(a[i].caracteristica_especial2),t.push(a[i].codigo_fabrica),t.push(a[i].cantidad),t.push(a[i].costo_unitario),t.push(a[i].costo_total),t.push(a[i].fecha_vencimiento),t.push(a[i].lote),t.push(a[i].nombre_sucursal),t.push(a[i].nombre_almacen),o.push(t)}var r=new Workbook,n=sheet_from_array_of_arrays(o);r.SheetNames.push("SheetJS"),r.Sheets.SheetJS=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"REPORTE-ALMACENES.xlsx")}else{f(p.usuario.id_empresa,e.sucursal.id,e.almacen&&null!==e.almacen&&0!==e.almacen?e.almacen.id:0,p.usuario.id).then(function(e){for(var a=e.inventario,o=[["Código","Nombre","Unidad de Medida","Precio Unitario","Descripción","Inventario Mínimo","Grupo","Sub-Grupo","Carac. Esp. 1","Carac. Esp. 2","Codigo de fabrica","Cant.","Costo Unitario","Total General","Fecha Vencimiento","Lote","Sucursal","Almacen"]],i=0;i<a.length;i++){a[i].fecha_vencimiento=a[i].fecha_vencimiento?new Date(a[i].fecha_vencimiento):null;var t=[];t.push(a[i].codigo),t.push(a[i].nombre),t.push(a[i].unidad_medida),t.push(a[i].precio_unitario),t.push(a[i].descripcion),t.push(a[i].inventario_minimo),t.push(a[i].grupo),t.push(a[i].subgrupo),t.push(a[i].caracteristica_especial1),t.push(a[i].caracteristica_especial2),t.push(a[i].codigo_fabrica),t.push(a[i].cantidad),t.push(a[i].costo_unitario),t.push(a[i].costo_total),t.push(a[i].fecha_vencimiento),t.push(a[i].lote),t.push(a[i].nombre_sucursal),t.push(a[i].nombre_almacen),o.push(t)}var r=new Workbook,n=sheet_from_array_of_arrays(o);r.SheetNames.push("SheetJS"),r.Sheets.SheetJS=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"REPORTE-ALMACENES.xlsx")})}m.stop()},p.dibujarCabeceraPDFAlmacenes=function(e,a,o){e.font("Helvetica-Bold",12),e.text("REPORTE ALMACENES",0,25,{align:"center"}),e.font("Helvetica-Bold",10),e.text("SUCURSAL:"+p.reporte.sucursal.nombre+" - ALMACEN:"+(null!==p.reporte.almacen&&void 0!==p.reporte.almacen&&0!==p.reporte.almacen?p.reporte.almacen.nombre:"TODOS LOS ALMACENES"),0,38,{align:"center"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,750,{align:"center"}),e.rect(30,50,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Código",45,60),e.text("Cant.",110,60,{width:50}),e.text("Unid.",160,60,{width:50}),e.text("Descripción",210,60,{width:170}),p.usuario.empresa.usar_vencimientos&&(e.text("Venc.",380,60),e.text("Lote",430,60)),e.text("Costo Unitario",470,60,{width:50}),e.text("Total General",530,60,{width:50})},p.inicio()}]).controller("ControladorVentasMensuales",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","ReporteVentasMensualesDatos",function(u,e,a,o,i,p,t,r){u.usuario=JSON.parse(e.usuario),u.inicio=function(){u.obtenerGestiones(),u.sucursales=u.obtenerSucursales(),u.reporte={},u.reporte.sucursal=1==u.sucursales.length?u.sucursales[0]:null,ejecutarScriptsVentasMensuales()},u.obtenerSucursales=function(){var e=[];1<u.usuario.sucursalesUsuario.length&&e.push({id:0,nombre:"TODOS"});for(var a=0;a<u.usuario.sucursalesUsuario.length;a++)e.push(u.usuario.sucursalesUsuario[a].sucursal);return e},u.obtenerGestiones=function(){p.start(),t("GTN").then(function(e){u.gestiones=e.clases,p.stop()})},u.generarExcelVentasMensuales=function(e){p.start(),inicio=new Date(u.convertirFecha(e.fechaInicioTexto)),fin=new Date(u.convertirFecha(e.fechaFinTexto)),r(u.usuario.id_empresa,e.sucursal.id,inicio,fin).then(function(e){var a=JSON.parse(e.detallesVenta);console.log("ventasssss ===== ",a);var o=[["FECHA DE LA FACTURA","N° DE LA FACTURA","N° DE AUTORIZACION","NIT/CI CLIENTE","NOMBRE O RAZON SOCIAL","UBICACION CLIENTE","CODIGO","DETALLE","UNIDAD","GRUPO","CANTIDAD","PU","TOTAL","IMPORTE ICE/IEHD/TASAS","EXPORTACIONES Y OPERACIONES EXENTAS","VENTAS GRAVADAS A TASA CERO","SUBTOTAL","DESCUENTOS, BONIFICACIONES Y REBAJAS OBTENIDAS","IMPORTE BASE PARA DEBITO FISCAL","DEBITO FISCAL","SUCURSAL","USUARIO","TIPO DE PAGO"]];u.usuario.empresa.usar_vencimientos&&(o[0].push("FECHA VENCIMIENTO"),o[0].push("LOTE")),o[0].push("VENDEDOR");for(var i=0;i<a.length;i++){var t=[];a[i].venta.fecha=new Date(a[i].venta.fecha),t.push(a[i].venta.fecha),t.push(a[i].venta.factura),t.push(a[i].venta.autorizacion),t.push(a[i].venta.cliente.nit),t.push(a[i].venta.cliente.razon_social),t.push(a[i].venta.cliente.ubicacion_geografica),t.push(a[i].producto.codigo),t.push(a[i].producto.nombre),t.push(a[i].producto.unidad_medida),a[i].producto.grupo?t.push(a[i].producto.grupo.nombre):t.push(""),t.push(a[i].cantidad),t.push(a[i].precio_unitario),t.push(a[i].importe),t.push(a[i].ice),t.push(0),t.push(0),t.push(a[i].importe-a[i].ice);var r=a[i].importe-a[i].ice-a[i].excento+a[i].recargo;t.push(r),t.push(a[i].total),t.push(Math.round(.13*a[i].total*100)/100),t.push(a[i].venta.almacen.sucursal.nombre),t.push(a[i].venta.usuario.nombre_usuario),t.push(a[i].venta.tipoPago.nombre),u.usuario.empresa.usar_vencimientos&&(a[i].inventario?(a[i].inventario.fecha_vencimiento=new Date(a[i].inventario.fecha_vencimiento),t.push(a[i].inventario.fecha_vencimiento),t.push(a[i].inventario.lote)):null!=a[i].lote?(a[i].fecha_vencimiento=new Date(a[i].fecha_vencimiento),t.push(a[i].fecha_vencimiento),t.push(a[i].lote)):(t.push(""),t.push(""))),t.push(a[i].venta.vendedor?a[i].venta.vendedor.persona.nombre_completo:""),o.push(t)}var n=new Workbook,s=sheet_from_array_of_arrays(o);n.SheetNames.push("SheetJS"),n.Sheets.SheetJS=s;var c=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"VENTAS-MENSUALES.xlsx"),p.stop()})},u.generarPdfVentasMensuales=function(d){p.start(),inicio=new Date(u.convertirFecha(d.fechaInicioTexto)),fin=new Date(u.convertirFecha(d.fechaFinTexto)),r(u.usuario.id_empresa,d.sucursal.id,inicio,fin).then(function(e){var a=JSON.parse(e.detallesVenta),o=new PDFDocument({compress:!1,margin:10}),i=o.pipe(blobStream());o.font("Helvetica",8);var t=150,r=0,n=1;u.dibujarCabeceraPDFVentasMensuales(o,e,d,n);for(var s=0;s<a.length&&r<=15;s++)o.rect(40,t-10,540,40).stroke(),o.font("Helvetica",8),a[s].venta.fecha=new Date(a[s].venta.fecha),o.text(a[s].venta.fecha.getDate()+"/"+(a[s].venta.fecha.getMonth()+1)+"/"+a[s].venta.fecha.getFullYear().toString().substr(-2),45,t),o.text(a[s].venta.factura?a[s].venta.factura:"",80,t),o.font("Helvetica",7),o.text(a[s].venta.cliente.razon_social,115,t-2,{width:80}),o.text(a[s].producto.nombre,205,t-2,{width:80}),o.font("Helvetica",8),o.text(a[s].cantidad,300,t,{width:50}),o.text(a[s].producto.unidad_medida,330,t,{width:50}),u.usuario.empresa.usar_vencimientos&&a[s].inventario&&(a[s].inventario.fecha_vencimiento=new Date(a[s].inventario.fecha_vencimiento),o.text(a[s].inventario.fecha_vencimiento.getDate()+"/"+(a[s].inventario.fecha_vencimiento.getMonth()+1)+"/"+a[s].inventario.fecha_vencimiento.getFullYear().toString().substr(-2),385,t),o.text(a[s].inventario.lote,435,t)),o.text(a[s].descuento,475,t),o.text(a[s].recargo,505,t),o.text(a[s].total,535,t),t+=40,15!=++r&&s+1!=a.length||s+1==a.length||(o.addPage({margin:0,bufferPages:!0}),t=150,r=0,n+=1,u.dibujarCabeceraPDFVentasMensuales(o,e,d,n),o.font("Helvetica",8));var c=new Date,l=c.getMinutes();l<10&&(l="0"+l),o.text("USUARIO: "+u.usuario.nombre_usuario,45,t),o.text("IMPRESION : "+c.getDate()+"/"+(c.getMonth()+1)+"/"+c.getFullYear()+" Hr. "+c.getHours()+":"+l,175,t),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),p.stop()})},u.dibujarCabeceraPDFVentasMensuales=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("REPORTE DE VENTAS",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+o.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+o.fechaFinTexto,70,40,{align:"center"}),e.text("FOLIO "+i,550,25),e.rect(40,60,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("NOMBRE O RAZÓN SOCIAL : ",65,75),e.text("NIT : ",440,75),e.font("Helvetica",8),e.text(a.empresa.razon_social,195,75),e.text(a.empresa.nit,460,75),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,110,{width:40}),e.text("Nº De Nota",80,110,{width:30}),e.text("Cliente",115,110),e.text("Producto",205,110),e.text("Cant.",290,110),e.text("Unidad",330,110),e.text("Fecha Venc",385,110,{width:30}),e.text("Lote",435,110,{width:35}),e.text("Desc.",470,110),e.text("Rec.",500,110),e.text("Total",535,110)},u.inicio()}]).controller("ControladorEstadoResultadosNoContable",["$scope","$localStorage","$location","$templateCache","$route","blockUI","GastosVariosLista","ReporteEstadoResultadosNoContableDatos",function(x,e,a,o,i,S,t,r){x.usuario=JSON.parse(e.usuario),x.idModalGastos="dialog-gastos",x.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsEstadoResultadosNoContable(x.idModalGastos),x.buscarAplicacion(x.usuario.aplicacionesUsuario,a.path().substring(1)),S.stop()}),x.abrirPopupGastos=function(){x.gasto=null,x.abrirPopup(x.idModalGastos)},x.cerrarPopupGastos=function(){x.cerrarPopup(x.idModalGastos)},x.inicio=function(){},x.generarEstadoResultadosNoContable=function(E,e,a){x.cerrarPopupGastos(),S.start(),e=new Date(x.convertirFecha(e)),a=new Date(x.convertirFecha(a));var o=r(x.usuario.id_empresa,e,a);o.then(function(D){(o=t(x.usuario.id_empresa,e,a)).then(function(e){for(var a=0,o=0,i=0,t=0,r=0,n=0,s=0,c=0,l=0,d=0,u=0;u<D.length;u++)if(D[u].movimiento){if(D[u].movimiento.clase.nombre_corto==x.diccionario.EGRE_FACTURACION||D[u].movimiento.clase.nombre_corto==x.diccionario.EGRE_PROFORMA){D[u].movimiento.clase.nombre_corto==x.diccionario.EGRE_FACTURACION?(l+=.87*D[u].total,a+=.87*D[u].total,null!=D[u].tipoPago&&(D[u].tipoPago.nombre==x.diccionario.TIPO_PAGO_CREDITO?(i+=.87*D[u].total,r+=.87*D[u].total):D[u].tipoPago.nombre==x.diccionario.TIPO_PAGO_CONTADO&&(t+=.87*D[u].total,c+=.87*D[u].total))):(l+=D[u].total,a+=D[u].total,null!=D[u].tipoPago&&(D[u].tipoPago.nombre==x.diccionario.TIPO_PAGO_CREDITO?(i+=D[u].total,r+=D[u].total):D[u].tipoPago.nombre==x.diccionario.TIPO_PAGO_CONTADO&&(t+=D[u].total,c+=D[u].total)));for(var p=0;p<D[u].movimiento.detallesMovimiento.length;p++)d+=D[u].movimiento.detallesMovimiento[p].total}}else l+=.87*D[u].total,o+=.87*D[u].total,null!=D[u].tipoPago&&(D[u].tipoPago.nombre==x.diccionario.TIPO_PAGO_CREDITO?(i+=.87*D[u].total,s+=.87*D[u].total):D[u].tipoPago.nombre==x.diccionario.TIPO_PAGO_CONTADO&&(t+=.87*D[u].total,n+=.87*D[u].total));l=Math.round(100*l)/100,d=Math.round(100*d)/100,a=Math.round(100*a)/100,o=Math.round(100*o)/100,r=Math.round(100*r)/100,n=Math.round(100*n)/100,s=Math.round(100*s)/100,c=Math.round(100*c)/100;var m=Math.round(100*(l-d))/100,f=0;for(u=0;u<e.length;u++)for(p=0;p<e[u].detallesCompra.length;p++)f+=e[u].detallesCompra[p].total;var g=m-(f=Math.round(100*(f-.13*f))/100+E),v=new PDFDocument({margin:10}),h=v.pipe(blobStream()),b=x.filtro.fechaInicioTexto,C=x.filtro.fechaFinTexto;v.font("Helvetica-Bold",16),v.text("ESTADO DE RESULTADOS NO CONTABLE",0,60,{align:"center"}),v.font("Helvetica-Bold",10),v.text("Desde "+b+" al "+C,0,80,{align:"center"}),v.font("Helvetica-Bold",8),v.text("VENTAS",100,100),v.text(l,300,100),v.font("Helvetica",8),v.text("PRODUCTO",100,110),v.text(a,170,110),v.text("SERVICIO",100,120),v.text(o,170,120),v.font("Helvetica-Bold",8),v.text("COSTO DE VENTAS",100,200),v.text(d,300,200),v.text("UTILIDAD BRUTA EN VENTAS",100,250),v.text(m,300,250),v.text("GASTOS",100,300),v.text(f,300,300),v.font("Helvetica-Bold",8),v.text("VENTAS CONTADO",150,130),v.text(Math.round(100*t)/100,250,130),v.font("Helvetica",8),v.text("PRODUCTOS",150,140),v.text(c,250,140),v.text("SERVICIOS",150,150),v.text(n,250,150),v.font("Helvetica-Bold",8),v.text("VENTAS CREDITO",150,160),v.text(Math.round(100*i)/100,250,160),v.font("Helvetica",8),v.text("PRODUCTOS",150,170),v.text(r,250,170),v.text("SERVICIOS",150,180),v.text(s,250,180),v.font("Helvetica-Bold",8);var P=330,_=0;for(u=0;u<e.length;u++){v.text(e[u].nombre,130,P);for(p=_=0;p<e[u].detallesCompra.length;p++)_+=e[u].detallesCompra[p].total;v.text(Math.round(100*(_-.13*_))/100,280,P),P+=25}v.text("OTROS GASTOS",130,P),v.text(E,280,P),v.font("Helvetica-Bold",8);var M=0<=g?"UTILIDAD DEL PERIODO":"PÉRDIDA DEL PERIODO";v.text(M,100,P+25),v.text(g,300,P+25),v.end(),h.on("finish",function(){var e=h.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),S.stop()})})},x.generarExcelAlmacenes=function(){S.start(),InventariosCosto(x.usuario.id_empresa).then(function(e){for(var a=[["Código","Cant.","Unid.","Descripción","Costo Unitario","Total General"]],o=0;o<e.length;o++){var i=[];i.push(e[o].producto.codigo),i.push(e[o].cantidad),i.push(e[o].producto.unidad_medida),i.push(e[o].producto.nombre),i.push(e[o].costo_unitario),i.push(e[o].costo_total),a.push(i)}var t=new Workbook,r=sheet_from_array_of_arrays(a);t.SheetNames.push("SheetJS"),t.Sheets.SheetJS=r;var n=XLSX.write(t,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),"REPORTE-ALMACENES.xlsx"),S.stop()})},x.dibujarCabeceraPDFAlmacenes=function(e,a,o){e.font("Helvetica-Bold",12),e.text("REPORTE ALMACENES",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+a+" DE "+o,0,750,{align:"center"}),e.rect(30,50,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Código",45,60),e.text("Cant.",110,60,{width:50}),e.text("Unid.",160,60,{width:50}),e.text("Descripción",210,60,{width:300}),e.text("Costo Unitario",470,60,{width:50}),e.text("Total General",530,60,{width:50})},x.inicio()}]).controller("ControladorComprasMensuales",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","ReporteComprasMensualesDatos",function(u,e,a,o,i,p,t,r){u.usuario=JSON.parse(e.usuario),u.inicio=function(){u.obtenerGestiones(),u.sucursales=u.obtenerSucursales(),u.reporte={},u.reporte.sucursal=1==u.sucursales.length?u.sucursales[0]:null,ejecutarScriptsVentasMensuales()},u.obtenerSucursales=function(){var e=[];1<u.usuario.sucursalesUsuario.length&&e.push({id:0,nombre:"TODOS"});for(var a=0;a<u.usuario.sucursalesUsuario.length;a++)e.push(u.usuario.sucursalesUsuario[a].sucursal);return e},u.obtenerGestiones=function(){p.start(),t("GTN").then(function(e){u.gestiones=e.clases,p.stop()})},u.generarExcelComprasMensuales=function(e){p.start(),inicio=new Date(u.convertirFecha(e.fechaInicioTexto)),fin=new Date(u.convertirFecha(e.fechaFinTexto)),r(u.usuario.id_empresa,e.sucursal.id,inicio,fin).then(function(e){for(var a=e.detallesCompra,o=[["FECHA DE LA FACTURA","N° DE LA FACTURA","N° DE AUTORIZACION","NIT/CI CLIENTE","NOMBRE O RAZON SOCIAL","CODIGO","DETALLE","UNIDAD","GRUPO","CANTIDAD","PU","TOTAL","IMPORTE ICE/IEHD/TASAS","EXENTOS","SUBTOTAL","DESCUENTOS, BONIFICACIONES Y REBAJAS OBTENIDAS","IMPORTE BASE PARA DEBITO FISCAL","CREDITO FISCAL","FECHA DE VENCIMIENTO","LOTE","SUCURSAL","USUARIO","CENTRO DE COSTOS"]],i=0;i<a.length;i++){var t=[];a[i].compra.fecha=new Date(a[i].compra.fecha),t.push(a[i].compra.fecha),t.push(a[i].compra.factura),t.push(a[i].compra.autorizacion),t.push(a[i].compra.proveedor.nit),t.push(a[i].compra.proveedor.razon_social),t.push(a[i].producto.codigo),t.push(a[i].producto.nombre),t.push(a[i].producto.unidad_medida),a[i].producto.grupo?t.push(a[i].producto.grupo.nombre):t.push(""),t.push(a[i].cantidad),t.push(a[i].costo_unitario),t.push(a[i].importe),t.push(a[i].ice),t.push(a[i].excento),t.push(a[i].importe-a[i].ice);var r=a[i].importe-a[i].ice-a[i].excento+a[i].recargo;t.push(r),t.push(a[i].total),t.push(Math.round(.13*a[i].total*100)/100),a[i].inventario?(t.push(new Date(a[i].inventario.fecha_vencimiento)),t.push(a[i].inventario.lote)):(t.push(""),t.push("")),console.log(i),t.push(a[i].compra.almacen.sucursal?a[i].compra.almacen.sucursal.nombre:""),t.push(u.usuario.nombre_usuario),t.push(a[i].centroCosto.nombre_corto),o.push(t)}var n=new Workbook,s=sheet_from_array_of_arrays(o);n.SheetNames.push("SheetJS"),n.Sheets.SheetJS=s;var c=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"COMPRAS-MENSUALES.xlsx"),p.stop()})},u.generarPdfComprasMensuales=function(d){p.start(),inicio=new Date(u.convertirFecha(d.fechaInicioTexto)),fin=new Date(u.convertirFecha(d.fechaFinTexto)),r(u.usuario.id_empresa,d.sucursal.id,inicio,fin).then(function(e){var a=e.detallesCompra,o=new PDFDocument({margin:10}),i=o.pipe(blobStream());o.font("Helvetica",8);var t=150,r=0,n=1;u.dibujarCabeceraPDFcomprasMensuales(o,e,d,n);for(var s=0;s<a.length&&r<=15;s++)o.rect(40,t-10,540,40).stroke(),a[s].compra.fecha=new Date(a[s].compra.fecha),o.text(a[s].compra.fecha.getDate()+"/"+(a[s].compra.fecha.getMonth()+1)+"/"+a[s].compra.fecha.getFullYear(),45,t),o.text(a[s].compra.factura?a[s].compra.factura:"",90,t),o.text(a[s].compra.proveedor?a[s].compra.proveedor.razon_social:"",135,t-6,{width:80}),console.log(s),o.text(a[s].producto?a[s].producto.nombre:a[s].servicio?a[s].servicio.nombre:"",225,t-6,{width:80}),o.text(a[s].producto?a[s].producto.unidad_medida:"",300,t,{width:50}),a[s].inventario&&(a[s].inventario.fecha_vencimiento=new Date(a[s].inventario.fecha_vencimiento),o.text(a[s].inventario.fecha_vencimiento.getDate()+"/"+(a[s].inventario.fecha_vencimiento.getMonth()+1)+"/"+a[s].inventario.fecha_vencimiento.getFullYear(),345,t),o.text(a[s].inventario.lote,405,t)),o.text(a[s].descuento,445,t),o.text(a[s].recargo,495,t),o.text(a[s].total,535,t),t+=40,15!=++r&&s+1!=a.length||s+1==a.length||(o.addPage({margin:0,bufferPages:!0}),t=150,r=0,n+=1,u.dibujarCabeceraPDFcomprasMensuales(o,e,d,n),o.font("Helvetica",8));var c=new Date,l=c.getMinutes();l<10&&(l="0"+l),o.text("USUARIO: "+u.usuario.nombre_usuario,45,t),o.text("IMPRESION : "+c.getDate()+"/"+(c.getMonth()+1)+"/"+c.getFullYear()+" Hr. "+c.getHours()+":"+l,175,t),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),p.stop()})},u.dibujarCabeceraPDFcomprasMensuales=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("REPORTE DE COMPRAS",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+o.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+o.fechaFinTexto,70,40,{align:"center"}),e.text("FOLIO "+i,550,25),e.rect(40,60,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("NOMBRE O RAZÓN SOCIAL : ",65,75),e.text("NIT : ",440,75),e.font("Helvetica",8),e.text(a.empresa.razon_social,195,75),e.text(a.empresa.nit,460,75),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,110,{width:40}),e.text("Nº De Nota",80,110),e.text("Proveedor",135,110),e.text("Producto",225,110),e.text("Unidad",300,110),e.text("Fecha Venc",345,110),e.text("Lote",405,110,{width:35}),e.text("Descuento",440,110),e.text("Recargo",490,110),e.text("Total",535,110),e.font("Helvetica",8)},u.inicio()}]),angular.module("agil.controladores").controller("ControladorRutas",["$scope","$localStorage","$location","$templateCache","$route","blockUI","$timeout","Clases","Clientes","Rutas","Ruta","uiGmapGoogleMapApi","$cordovaGeolocation","ClasesTipo","ClientesEmpresa",function(c,o,e,a,i,l,t,r,n,s,d,u,p,m,f){l.start(),c.usuario=JSON.parse(o.usuario),c.inicio=function(){c.obtenerDias(),c.obtenerClientes(),c.obtenerDepartamentos(),c.obtenerMunicipios(),setTimeout(function(){ejecutarScriptsTabla("tabla-rutas",10)},2e3)},c.obtenerClientes=function(){l.start(),n(c.usuario.id_empresa).then(function(e){c.clientes=e,l.stop()})},c.obtenerRutas=function(){l.start(),s(c.usuario.id_empresa).then(function(e){for(var a=0;a<e.length;a++){e[a].segmentos=JSON.parse(e[a].segmentos);for(var o=0;o<e[a].dias.length;o++)e[a].dias[o]=e[a].dias[o].id_dia;for(var i=0;i<e[a].clientes.length;i++)e[a].clientes[i]=e[a].clientes[i].id_cliente}c.rutas=e,l.stop()})},c.obtenerDepartamentos=function(){l.start(),m("DEP").then(function(e){c.departamentos=e.clases,l.stop()})},c.obtenerMunicipios=function(){l.start(),m("MUN").then(function(e){c.municipios=e.clases,l.stop()})},c.buscarMunicipios=function(e){r(e.nombre_corto+"M").then(function(e){c.municipios=e})},c.obtenerDias=function(){l.start(),m("DIAS").then(function(e){c.dias=e.clases,c.obtenerRutas(),l.stop()})},c.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsRuta("modal-wizard-ruta","modal-wizard-ruta-vista","dialog-eliminar-ruta","modal-wizard-container-ruta-edicion","modal-wizard-container-ruta-vista"),c.buscarAplicacion(c.usuario.aplicacionesUsuario,e.path().substring(1)),l.stop()}),c.abrirPopupRuta=function(a){c.formas=[],c.mostrarMap=!1,c.ruta=a,u.then(function(e){c.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},c.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},c.generarMarcadores(c.ruta),c.dibujarRuta(a)}),c.abrirPopup("modal-wizard-ruta")},c.eliminarLineas=function(){c.polylines=[],c.ruta.segmentos=[];for(var e=0;e<c.formas.length;e++)c.formas[e].setMap(null)},c.dibujarRuta=function(e){if(c.polylines=[],0<e.segmentos.length)for(var a=0;a<e.segmentos.length;a++){for(var o=[],i=0;i<e.segmentos[a].length;i++)o.push({latitude:e.segmentos[a][i].lat,longitude:e.segmentos[a][i].lng});c.polylines.push({id:a+1,path:o,stroke:{color:"#69AA46",weight:3},editable:!0,draggable:!0,geodesic:!0,visible:!0})}c.drawingManagerOptions={drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.POLYLINE]},polylineOptions:{strokeColor:"#69AA46",strokeWeight:5}},c.markersAndCircleFlag=!0,c.drawingManagerControl={},c.drawingManagerEvents={polylinecomplete:function(e,a,o,i){for(var t=i[0],r=t.getPath(),n=[],s=0;s<r.getArray().length;s++)n.push(r.getArray()[s].toJSON());c.ruta.segmentos.push(n),c.formas.push(t)}}},c.seleccionarMarcador=function(e,a,o){"blue"==o.options.icon.strokeColor?(o.options.icon={path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"red",scale:3},c.ruta.clientes.splice(c.ruta.clientes.indexOf(o.id),1)):(o.options.icon={path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"blue",scale:3},c.ruta.clientes.push(o.id))},c.generarMarcadores=function(e){var a=function(e,a,o,i,t,r,n){null==o&&(o="id");var s={latitude:i,longitude:t,title:"m"+e,options:r};return s[o]=n,s};c.markers=[];for(var o,i=[],t=0;t<c.clientes.length;t++){var r=0<$.grep(e.clientes,function(e){return e==c.clientes[t].id}).length?"blue":"red";o={labelContent:c.clientes[t].razon_social,labelAnchor:"8 35",labelClass:"marker-label",icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:r,scale:3}},i.push(a(t+1,c.map.bounds,null,c.clientes[t].latitud,c.clientes[t].longitud,o,c.clientes[t].id))}c.markers=i},c.mostrarMapa=function(){c.mostrarMap=!0,t(function(){c.$apply(function(){google.maps.event.trigger(c.map,"resize")})},2e3)},c.crearNuevaRuta=function(){var e=JSON.parse(o.usuario),a=new d({id_empresa:e.id_empresa,clientes:[],segmentos:[]});c.abrirPopupRuta(a)},c.verRuta=function(a){c.formas=[],c.mostrarMap=!1,c.ruta=a,u.then(function(e){c.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},c.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},c.generarMarcadores(c.ruta),c.dibujarRuta(a)}),c.abrirPopup("modal-wizard-ruta-vista")},c.cerrarPopPupVista=function(){c.cerrarPopup("modal-wizard-ruta-vista")},c.cerrarPopPupNuevaRuta=function(){c.cerrarPopup("modal-wizard-ruta")},c.modificarRuta=function(e){c.abrirPopupRuta(e)},c.mostrarConfirmacionEliminacion=function(e){c.ruta=new d(e),c.abrirPopup("dialog-eliminar-ruta")},c.cerrarConfirmacionEliminacion=function(){c.cerrarPopup("dialog-eliminar-ruta")},c.eliminarRuta=function(e){l.start(),c.cerrarConfirmacionEliminacion(),e.$delete(),c.mostrarMensaje("Eliminado exitosamente!"),c.recargarItemsTabla(),l.stop()},c.saveForm=function(e){"Siguiente"!=$("#siguiente").text().trim()&&(l.start(),e.segmentos=JSON.stringify(e.segmentos),e.id?d.update({idRuta:e.id},e,function(e){l.stop(),c.cerrarPopPupNuevaRuta(),c.mostrarMensaje(e.mensaje),c.recargarItemsTabla()}):e.$save(function(e){l.stop(),c.ruta=new d({}),c.cerrarPopPupNuevaRuta(),c.mostrarMensaje("¡Ruta creada con código "+e.id+"!"),c.recargarItemsTabla()},function(e){l.stop(),c.cerrarPopPupNuevaRuta(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!"),c.recargarItemsTabla()}))},c.subirExcelRutas=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){l.start();var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=o.Sheets[i],n=[];do{var s={};s.codigo=null!=r["A"+t]&&""!=r["A"+t]?r["A"+t].v.toString():null,s.razon_social=null!=r["B"+t]&&""!=r["B"+t]?r["B"+t].v.toString():null,s.nit=null!=r["C"+t]&&""!=r["C"+t]?r["C"+t].v.toString():null,s.direccion=null!=r["D"+t]&&""!=r["D"+t]?r["D"+t].v.toString():null,s.telefono1=null!=r["E"+t]&&""!=r["E"+t]?r["E"+t].v.toString():null,s.telefono2=null!=r["F"+t]&&""!=r["F"+t]?r["F"+t].v.toString():null,s.telefono3=null!=r["G"+t]&&""!=r["G"+t]?r["G"+t].v.toString():null,s.contacto=null!=r["H"+t]&&""!=r["H"+t]?r["H"+t].v.toString():null,s.ubicacion_geografica=null!=r["I"+t]&&""!=r["I"+t]?r["I"+t].v.toString():null,s.rubro=null!=r["J"+t]&&""!=r["J"+t]?r["J"+t].v.toString():null,s.categoria=null!=r["K"+t]&&""!=r["K"+t]?r["K"+t].v.toString():null,s.fecha1=null!=r["L"+t]&&""!=r["L"+t]?new Date(c.convertirFecha(r["L"+t].v.toString())):null,s.fecha2=null!=r["M"+t]&&""!=r["M"+t]?new Date(c.convertirFecha(r["M"+t].v.toString())):null,s.texto1=null!=r["N"+t]&&""!=r["N"+t]?r["N"+t].v.toString():null,s.texto2=null!=r["O"+t]&&""!=r["O"+t]?r["O"+t].v.toString():null,s.ruta1=null!=r["P"+t]&&""!=r["P"+t]?r["P"+t].v.toString():null,s.ruta2=null!=r["Q"+t]&&""!=r["Q"+t]?r["Q"+t].v.toString():null,s.ruta3=null!=r["R"+t]&&""!=r["R"+t]?r["R"+t].v.toString():null,n.push(s),t++,0}while(null!=r["A"+t]);c.guardarClientes(n),l.stop()},t.readAsBinaryString(o)}},c.guardarClientes=function(e){new f({clientes:e,id_empresa:c.usuario.id_empresa}).$save(function(e){l.stop(),c.mostrarMensaje(e.mensaje),c.recargarItemsTabla()},function(e){l.stop(),c.mostrarMensaje("Ocurrio un problema al momento de guardar!"),c.recargarItemsTabla()})},c.$on("$routeChangeStart",function(e,a){c.eliminarPopup("modal-wizard-ruta"),c.eliminarPopup("modal-wizard-ruta-vista"),c.eliminarPopup("dialog-eliminar-ruta")}),c.inicio()}]),angular.module("agil.controladores").controller("ControladorSeguimientoApp",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","UsuariosRutasLista","Rutas","uiGmapGoogleMapApi","UsuarioRutasSeguimiento","UsuarioRutaReporteDatos","UsuarioRutaGraficoDatos","UsuariosComisionesReporte","CierreCajaRutaUsuarioDatos",function(m,e,a,o,i,t,f,r,n,s,c,l,d,u,g){f.start(),m.usuario=JSON.parse(a.usuario),m.idModalSeguimientoVentas="dialog-seguimiento-ventas",m.idModalFiltroExcel="dialog-filtro-excel",m.idModalFiltroGraficos="dialog-filtro-graficos",m.idModalUsuarioComision="dialog-usuario-comision",m.inicio=function(){m.obtenerUsuariosRutas(),m.obtenerRutas()},m.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),setTimeout(function(){ejecutarScriptsSeguimiento(m.idModalSeguimientoVentas,m.idModalFiltroExcel,m.idModalFiltroGraficos,m.idModalUsuarioComision)},1e3),m.buscarAplicacion(m.usuario.aplicacionesUsuario,o.path().substring(1)),f.stop()}),m.obtenerUsuariosRutas=function(){var e=new Date,a=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear();m.filtrarRutasUsuarios(a,a,0,0)},m.obtenerRutas=function(){f.start(),n(m.usuario.id_empresa).then(function(e){m.rutas=e,f.stop()})},m.filtrarRutasUsuarios=function(e,a,o,i){f.start(),o=null==o||null==o?0:o,i=""==i||null==i?0:i;e=new Date(m.convertirFecha(e)),a=new Date(m.convertirFecha(a));r(m.usuario.id_empresa,e,a,i,o).then(function(e){m.usuariosRutas=e,f.stop()})},m.abrirSeguimientoVentas=function(e,a){f.start();var o=m.obtenerDiaActual();0<$.grep(a.dias,function(e){return e.dia.nombre_corto==o}).length?c(e,o).then(function(a){m.mostrarMap=!0,s.then(function(e){m.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}},window:{marker:{},show:!1,closeClick:function(){this.show=!1},options:{}},markersEvents:{click:function(e,a,o,arguments){m.map.window.model=o,m.map.window.show=!0}}},m.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},m.generarMarcadores(a[0].ruta.clientes),a[0].ruta.segmentos=JSON.parse(a[0].ruta.segmentos),m.dibujarRuta(a[0].ruta)}),m.abrirPopup(m.idModalSeguimientoVentas),f.stop()}):(m.mostrarMensaje("¡No existe ventas en el dia para esta Ruta y Usuario!"),f.stop())},m.generarMarcadores=function(e){var a=function(e,a,o,i,t,r,n,s,c,l,d){null==o&&(o="id");var u={latitude:i,longitude:t,title:d,options:r,razonSocial:s,ventas:c,detallesVentaNoConsolidadas:l,show:!1};return u[o]=n,u};m.markers=[];for(var o,i=[],t=0;t<e.length;t++){var r,n="",s="";0<e[t].cliente.ventas.length?(n=m.renderizarHtmlVentas(e[t].cliente.ventas[0]),0<e[t].cliente.ventas[0].detallesVentaNoConsolidadas.length?(s=m.renderizarHtmlVentasNoConsolidadas(e[t].cliente.ventas[0].detallesVentaNoConsolidadas),r="yellow"):r="green"):0<e[t].cliente.detallesVentaNoConsolidadas.length?(s=m.renderizarHtmlVentasNoConsolidadas(e[t].cliente.detallesVentaNoConsolidadas),r="red"):(n="¡Aún no se visito!",r="black"),o={labelContent:e[t].cliente.razon_social,labelAnchor:"8 35",labelClass:"marker-label",icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:r,scale:3}};var c=n+s;i.push(a(0,m.map.bounds,null,e[t].cliente.latitud,e[t].cliente.longitud,o,e[t].cliente.id,e[t].cliente.razon_social,e[t].cliente.ventas,e[t].cliente.detallesVentaNoConsolidadas,c))}m.markers=i},m.renderizarHtmlVentas=function(e){for(var a="",o=0;o<e.detallesVenta.length;o++)a=a+"<tr><td>"+(o+1)+"</td>\t\t\t\t\t<td>"+e.detallesVenta[o].cantidad+"</td>\t\t\t\t\t<td>"+e.detallesVenta[o].producto.nombre+"</td>\t\t\t\t\t<td>"+e.detallesVenta[o].total+"</td></tr>";return'<h3>Venta</h3><table class="table table-striped table-bordered table-hover" ng-if="modelo.detallesVenta.length>0"> \t\t\t<thead>\t\t\t\t<tr>\t\t\t\t\t<th>\t\t\t\t\t\t<label>#</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Cantidad</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Producto</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Precio (Bs)</label>\t\t\t\t\t</th>\t\t\t\t</tr>\t\t\t</thead>\t\t\t<tbody>'+a+("</tr>\t\t\t\t<tr>\t\t\t\t\t<td>\t\t\t\t\t</td>\t\t\t\t\t<td>\t\t\t\t\t</td>\t\t\t\t\t<td>\t\t\t\t\t\t<b>TOTALES</b>\t\t\t\t\t</td>\t\t\t\t\t<td>"+e.total+"</td>\t\t\t\t</tr>\t\t\t</tbody>\t\t</table>")},m.renderizarHtmlVentasNoConsolidadas=function(e){for(var a="",o=0;o<e.length;o++)a=a+"<tr><td>"+(o+1)+"</td>\t\t\t\t\t<td>"+e[o].cantidad+"</td>\t\t\t\t\t<td>"+e[o].producto.nombre+"</td>\t\t\t\t\t<td>"+e[o].total+"</td></tr>";return'<h3>Venta No Consolidada</h3>\t\t<table class="table table-striped table-bordered table-hover">\t\t\t<thead>\t\t\t\t<tr>\t\t\t\t\t<th>\t\t\t\t\t\t<label>#</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Cantidad</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Producto</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Precio (Bs)</label>\t\t\t\t\t</th>\t\t\t\t</tr>\t\t\t</thead>\t\t\t<tbody>'+a+"</tr>\t\t\t</tbody>\t\t</table>"},m.dibujarRuta=function(e){if(m.polylines=[],0<e.segmentos.length)for(var a=0;a<e.segmentos.length;a++){for(var o=[],i=0;i<e.segmentos[a].length;i++)o.push({latitude:e.segmentos[a][i].lat,longitude:e.segmentos[a][i].lng});m.polylines.push({id:a+1,path:o,stroke:{color:"#69AA46",weight:3},editable:!0,draggable:!0,geodesic:!0,visible:!0})}m.drawingManagerOptions={drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.POLYLINE]},polylineOptions:{strokeColor:"#69AA46",strokeWeight:5}},m.markersAndCircleFlag=!0,m.drawingManagerControl={},m.drawingManagerEvents={polylinecomplete:function(e,a,o,i){for(var t=i[0],r=t.getPath(),n=[],s=0;s<r.getArray().length;s++)n.push(r.getArray()[s].toJSON());m.ruta.segmentos.push(n),m.formas.push(t)}}},m.seleccionarMarcador=function(e,a,o){o.show=!o.show},m.cerrarSeguimientoVenta=function(){m.mostrarMap=!1,m.cerrarPopup(m.idModalSeguimientoVentas)},m.abrirPopupFiltroExcel=function(e,a){var o=new Date;m.reporte={bandera:3,id_usuario:e.id,usuario:e,ruta:a,id_ruta:a.id,mes:"1",gestion:"2017"},m.reporte.fechaTextoInicio=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),m.reporte.fechaTextoFin=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),m.abrirPopup(m.idModalFiltroExcel)},m.cerrarPopupFiltroExcel=function(){m.cerrarPopup(m.idModalFiltroExcel)},m.buscarDetallesVenta=function(s){if(f.start(),s.tipo){var e=new Date;e.setDate(1),e.setMonth(parseInt(s.mes)-1),e.setFullYear(parseInt(s.gestion)),s.inicio=e;var a=new Date;a.setDate(new Date(parseInt(s.gestion),parseInt(s.mes),0).getDate()),a.setMonth(parseInt(s.mes)-1),a.setFullYear(parseInt(s.gestion)),s.fin=a}else s.inicio=new Date(m.convertirFecha(s.fechaTextoInicio)),s.fin=new Date(m.convertirFecha(s.fechaTextoFin));l(s.id_usuario,s.inicio,s.fin,s.bandera,s.id_ruta).then(function(e){for(var a=[["","","REPORTE VENDEDOR RUTA"],["Vendedor : ",s.usuario.persona.nombres,"Ruta : ",s.ruta.nombre],["Nro.","Fecha","Cliente","Producto","Cantidad","P. U.","Total","Comision","Total Comision","Tipo de Venta","Dias"]],o=0;o<e.length;o++){var i=[];i.push((o+1).toString()),1==s.bandera?(e[o].fecha=new Date(e[o].fecha),i.push(e[o].fecha.getDate()+"/"+(e[o].fecha.getMonth()+1)+"/"+e[o].fecha.getFullYear()),i.push(e[o].cliente.razon_social),i.push("ROJO"),i.push("ROJO"),i.push("ROJO"),i.push("ROJO"),i.push("ROJO"),i.push("ROJO"),i.push("ROJO"),i.push("ROJO")):(e[o].venta.fecha=new Date(e[o].venta.fecha),i.push(e[o].venta.fecha.getDate()+"/"+(e[o].venta.fecha.getMonth()+1)+"/"+e[o].venta.fecha.getFullYear()),i.push(e[o].venta.cliente.razon_social),i.push(e[o].producto.nombre),i.push(e[o].cantidad),i.push(e[o].precio_unitario),i.push(e[o].total),i.push(e[o].producto.comision),i.push(e[o].cantidad*e[o].producto.comision),i.push(e[o].venta.tipoPago.nombre),e[o].venta.dias_credito&&i.push(e[o].venta.dias_credito)),a.push(i)}var t=new Workbook,r=sheet_from_array_of_arrays(a);t.SheetNames.push("SheetJS"),t.Sheets.SheetJS=r;var n=XLSX.write(t,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),"REPORTE-RUTA-USUARIO.xlsx"),f.stop()})},m.abrirPopupFiltroGraficos=function(e,a){var o=new Date;m.reporte={bandera:3,id_usuario:e.id,usuario:e,ruta:a,id_ruta:a.id,mes:"1",gestion:"2017"},m.reporte.fechaTextoInicio=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),m.reporte.fechaTextoFin=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),m.abrirPopup(m.idModalFiltroGraficos)},m.buscarGraficos=function(r){if(f.start(),r.tipo){var e=new Date;e.setDate(1),e.setMonth(parseInt(r.mes)-1),e.setFullYear(parseInt(r.gestion)),r.inicio=e;var a=new Date;a.setDate(new Date(parseInt(r.gestion),parseInt(r.mes),0).getDate()),a.setMonth(parseInt(r.mes)-1),a.setFullYear(parseInt(r.gestion)),r.fin=a}else r.inicio=new Date(m.convertirFecha(r.fechaTextoInicio)),r.fin=new Date(m.convertirFecha(r.fechaTextoFin));d(r.id_usuario,r.inicio,r.fin,r.id_ruta).then(function(a){if(r.tipo){m.labels=[],m.data=[];for(var e=0,o=0;o<a.length;o++){a[o].fecha=new Date(a[o].fecha);var i=$.grep(a,function(e){return e.fecha=new Date(e.fecha),e.fecha.getDate()==a[o].fecha.getDate()&&e.fecha.getMonth()==a[o].fecha.getMonth()&&e.fecha.getFullYear()==a[o].fecha.getFullYear()});a=$.grep(a,function(e){return e.fecha=new Date(e.fecha),!(e.fecha.getDate()==a[o].fecha.getDate()&&e.fecha.getMonth()==a[o].fecha.getMonth()&&e.fecha.getFullYear()==a[o].fecha.getFullYear())}),o=-1;for(var t=e=0;t<i.length;t++)e+=i[t].total;m.labels.push(i[0].fecha.getDate()+"/"+(i[0].fecha.getMonth()+1)+"/"+i[0].fecha.getFullYear()),m.data.push(e)}m.series=["Series A"]}else{m.labels=[],m.data=[];for(e=0,o=0;o<a.length;o++){a[o].fecha=new Date(a[o].fecha);i=$.grep(a,function(e){return e.fecha=new Date(e.fecha),e.fecha.getMonth()==a[o].fecha.getMonth()&&e.fecha.getFullYear()==a[o].fecha.getFullYear()});a=$.grep(a,function(e){return e.fecha=new Date(e.fecha),!(e.fecha.getMonth()==a[o].fecha.getMonth()&&e.fecha.getFullYear()==a[o].fecha.getFullYear())}),o=-1;for(t=e=0;t<i.length;t++)e+=i[t].total;m.labels.push(i[0].fecha.getMonth()+1),m.data.push(e)}m.series=["Series A"]}f.stop()})},m.cerrarPopupFiltroGraficos=function(){m.cerrarPopup(m.idModalFiltroGraficos)},m.cerrarPopupUsuarioComision=function(){m.cerrarPopup(m.idModalUsuarioComision)},m.verComisionesVendedores=function(e,a){f.start(),m.abrirPopup(m.idModalUsuarioComision),e=new Date(m.convertirFecha(e)),a=new Date(m.convertirFecha(a)),u(m.usuario.id_empresa,e,a).then(function(e){m.labels=[],m.data=[];for(var a=0;a<e.length;a++){m.labels.push(e[a].persona.nombre_completo);for(var o=0,i=0;i<e[a].ventas.length;i++)for(var t=0;t<e[a].ventas[i].detallesVenta.length;t++)e[a].comision_activa?o+=e[a].comision_general:o+=e[a].ventas[i].detallesVenta[t].producto.comisionesVendedores[0].comision;m.data.push(o)}m.series=["Series A"],f.stop()})},m.cerrarCajaUsuarioRuta=function(c,e){f.start();var a=m.obtenerDiaActual(),o=$.grep(e.dias,function(e){return e.dia.nombre_corto==a}),l=100,d=1;if(0<o.length){var u=new PDFDocument({size:[612,792],margin:0}),p=u.pipe(blobStream());u.font("Helvetica-Bold",15),u.text("CIERRE DE CAJA",55,50),u.font("Helvetica-Bold",8),g(c.id,a).then(function(e){u.text("VENTAS",75,80),u.text("No.",100,100),u.text("Fecha",150,100),u.text("Cliente",200,100),u.text("Total",350,100),u.text("Comision",400,100),u.text("T. Comision",450,100),u.text("Tipo Venta",500,100),u.font("Helvetica",8);for(var a=0,o=0,i=0,t=0;t<e[0].ruta.clientes.length;t++)for(var r=0;r<e[0].ruta.clientes[t].cliente.ventas.length;r++){e[0].ruta.clientes[t].cliente.ventas[r].fecha=new Date(e[0].ruta.clientes[t].cliente.ventas[r].fecha),u.text("No. "+d,100,l+20),u.text(e[0].ruta.clientes[t].cliente.ventas[r].fecha.getDate()+"/"+(e[0].ruta.clientes[t].cliente.ventas[r].fecha.getMonth()+1)+"/"+e[0].ruta.clientes[t].cliente.ventas[r].fecha.getFullYear(),150,l+20),u.text(e[0].ruta.clientes[t].cliente.razon_social,200,l+20);var n=e[0].ruta.clientes[t].cliente.ventas[r].tipoPago.nombre==m.diccionario.TIPO_PAGO_CREDITO?e[0].ruta.clientes[t].cliente.ventas[r].a_cuenta:e[0].ruta.clientes[t].cliente.ventas[r].total;u.text(n,350,l+20),a+=n,c.comision_activa&&(u.text(c.comision_general+"%",400,l+20),u.text(e[0].ruta.clientes[t].cliente.ventas[r].total*c.comision_general/100,450,l+20),o+=e[0].ruta.clientes[t].cliente.ventas[r].total*c.comision_general/100),u.text(e[0].ruta.clientes[t].cliente.ventas[r].tipoPago.nombre,500,l+20),l+=20,d++}u.font("Helvetica-Bold",8),u.text("Totales",200,l+20),u.text(a,350,l+20),u.text(o,450,l+20),l+=20,u.text("COBROS",75,l+20),l+=20,u.text("No.",100,l+20),u.text("Fecha",150,l+20),u.text("Cliente",200,l+20),u.text("Total",350,l+20),u.text("Pago",400,l+20),u.font("Helvetica",8),l+=20,d=1;for(t=0;t<e[0].usuario.pagos.length;t++){e[0].usuario.pagos[t].createdAt=new Date(e[0].usuario.pagos[t].createdAt),u.text("No. "+d,100,l+20),u.text(e[0].usuario.pagos[t].createdAt.getDate()+"/"+(e[0].usuario.pagos[t].createdAt.getMonth()+1)+"/"+e[0].usuario.pagos[t].createdAt.getFullYear(),150,l+20),u.text(e[0].usuario.pagos[t].venta.cliente.razon_social,200,l+20),u.text(e[0].usuario.pagos[t].monto_pagado,350,l+20),i+=e[0].usuario.pagos[t].monto_pagado;var s=e[0].usuario.pagos[t].saldo_anterior==e[0].usuario.pagos[t].monto_pagado?"Total":"A/C";u.text(s,400,l+20),l+=20,d++}u.font("Helvetica-Bold",8),u.text("Totales",200,l+20),u.text(i,350,l+20),u.text("RESUMEN",200,l+40),u.text("Ventas",200,l+50),u.text("Cobros",200,l+60),u.text(a,280,l+50),u.text(i,280,l+60),u.text("Total a entregar",200,l+70),u.text(a+i,280,l+70),l+=40,u.text("---------------------------------------------                       ---------------------------------------------                       ---------------------------------------------",0,l+100,{align:"center"}),u.text("ENTREGUE CONFORME                                               RECIBI CONFORME                                               VoBo                         ",0,l+130,{align:"center"}),u.text("NOMBRE                                                        NOMBRE                                                       NOMBRE                         ",0,l+145,{align:"center"}),u.text("CI                                                              CI                                                              CI                           ",0,l+160,{align:"center"}),f.stop(),u.end(),p.on("finish",function(){var e=p.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})}else m.mostrarMensaje("¡No existe ventas en el dia para esta Ruta y Usuario!"),f.stop()},m.$on("$routeChangeStart",function(e,a){m.eliminarPopup(m.idModalSeguimientoVentas),m.eliminarPopup(m.idModalFiltroExcel),m.eliminarPopup(m.idModalFiltroGraficos),m.eliminarPopup(m.idModalUsuarioComision)}),m.inicio()}]),angular.module("agil.controladores").controller("ControladorSucursales",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Sucursal","Sucursales","SucursalesEmpresa","ClasesTipo","Clases","DosificacionesDisponibles","Sucursalupdate",function(r,a,e,o,i,t,n,s,c,l,d,u,p){t.start(),r.idModalWizardSucursalCorrelativoEdicion="modal-wizard-sucursal-correlativo-edicion",r.idModalWizardSucursalEdicion="modal-wizard-sucursal-edicion",r.idModalWizardSucursalVista="modal-wizard-sucursal-vista",r.idModalEliminarSucursal="dialog-eliminar-sucursal",r.idModalContenedorSucursalEdicion="modal-wizard-container-sucursal-edicion",r.idModalContenedorSucursalVista="modal-wizard-container-sucursal-vista",r.usuario=JSON.parse(a.usuario),r.inicio=function(){r.obtenerSucursales(),r.obtenerDepartamentos(),r.obtenerActividades(),r.obtenerDosificaciones(),r.obtenerTamanosPapelFactura(),setTimeout(function(){ejecutarScriptsTabla("tabla-sucursales",8)},2e3)},r.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsSucursal(r.idModalWizardSucursalEdicion,r.idModalWizardSucursalVista,r.idModalEliminarSucursal,r.idModalContenedorSucursalEdicion,r.idModalContenedorSucursalVista,r.idModalWizardSucursalCorrelativoEdicion),r.buscarAplicacion(r.usuario.aplicacionesUsuario,e.path().substring(1)),t.stop()}),r.obtenerTamanosPapelFactura=function(){t.start(),l("TAMPAPFACT").then(function(e){r.tamanosPapelFactura=e.clases,t.stop()})},r.obtenerSucursales=function(){t.start(),s(r.usuario.id_empresa).then(function(e){r.sucursales=e,console.log(e),t.stop()})},r.obtenerDepartamentos=function(){l("DEP").then(function(e){r.departamentos=e.clases})},r.obtenerActividades=function(){l("ACTCOM").then(function(e){r.actividades=e.clases})},r.obtenerDosificaciones=function(){u(r.usuario.id_empresa).then(function(e){r.dosificaciones=e})},r.buscarMunicipios=function(e){var a=e.split("-")[1];d(a+"M").then(function(e){r.municipios=e})},r.crearNuevaSucursal=function(){var e=JSON.parse(a.usuario);r.sucursal=new n({id_empresa:e.id_empresa,almacenes:[],actividadesDosificaciones:[]}),r.abrirPopup(r.idModalWizardSucursalEdicion)},r.verSucursal=function(e){(r.sucursal=e).departamento&&r.buscarMunicipios(e.id_departamento+"-"+e.departamento.nombre_corto),r.abrirPopup(r.idModalWizardSucursalVista)},r.cerrarPopPupVista=function(){r.cerrarPopup(r.idModalWizardSucursalVista)},r.cerrarPopPupEdicion=function(){r.cerrarPopup(r.idModalWizardSucursalEdicion)},r.cerrarPopPupEdicionCorrelativo=function(){r.cerrarPopup(r.idModalWizardSucursalCorrelativoEdicion)},r.modificarSucursal=function(e){r.sucursal=e,console.log(e),e.departamento&&r.buscarMunicipios(e.id_departamento+"-"+e.departamento.nombre_corto),r.abrirPopup(r.idModalWizardSucursalEdicion)},r.mostrarConfirmacionEliminacion=function(e){r.sucursal=new n(e),r.abrirPopup(r.idModalEliminarSucursal)},r.cerrarConfirmacionEliminacion=function(){r.cerrarPopup(r.idModalEliminarSucursal)},r.eliminarSucursal=function(e){t.start(),r.cerrarConfirmacionEliminacion(),e.$delete(),r.mostrarMensaje("Eliminado exitosamente!"),r.recargarItemsTabla(),t.stop()},r.modificarCorrelativos=function(e){r.sucursal=e,r.abrirPopup(r.idModalWizardSucursalCorrelativoEdicion)},r.guardarCorrelativos=function(e){console.log(e),p.update({idSucursal:e.id},e,function(e){t.stop(),r.cerrarPopPupEdicionCorrelativo(),r.mostrarMensaje("Actualizado Exitosamente!"),r.recargarItemsTabla()})},r.saveForm=function(e){"Siguiente"!=$("#siguiente").text().trim()&&(t.start(),"string"==typeof e.id_departamento&&(e.id_departamento=e.id_departamento.split("-")[0]),e.id?(e.municipio&&(e.id_municipio=e.municipio.id),n.update({idSucursal:e.id},e,function(e){t.stop(),r.recargarItemsTabla(),r.cerrarPopPupEdicion(),r.mostrarMensaje("Actualizado Exitosamente!")})):(e.fecha_reinicio_correlativo=new Date,e.fecha_reinicio_correlativo.setDate(1),e.municipio&&(e.id_municipio=e.municipio.id),e.$save(function(e){t.stop(),r.sucursal=new n({}),r.cerrarPopPupEdicion(),r.recargarItemsTabla(),r.mostrarMensaje("Guardado Exitosamente!")},function(e){t.stop(),r.cerrarPopPupEdicion(),r.recargarItemsTabla(),r.mostrarMensaje("Ocurrio un problema al momento de guardar!")})))},r.agregarAlmacen=function(e){e.edit=!1,e.nombre&&e.numero&&e.direccion&&(-1==r.sucursal.almacenes.indexOf(e)&&r.sucursal.almacenes.push(e),r.almacen={})},r.modificarAlmacen=function(e){e.edit=!0,r.almacen=e},r.removerAlmacen=function(e){e.eliminado=!0},r.agregarActividadDosificacion=function(i){var t=!1;0<r.sucursal.actividadesDosificaciones.length?r.sucursal.actividadesDosificaciones.forEach(function(e,a,o){i.dosificacion.expirado;0==i.dosificacion.expirado&&(t=!1,e.id_dosificacion!=i.dosificacion.id&&e.id_actividad!=i.actividad.id||(t=!0)),a===o.length-1&&0==t&&i.actividad&&i.dosificacion&&(i.id||(i.id_actividad=i.actividad.id,i.id_dosificacion=i.dosificacion.id,i.expirado=!1,r.sucursal.actividadesDosificaciones.push(i)),r.actividadDosificacion={})}):i.actividad&&i.dosificacion&&(i.id||(i.id_actividad=i.actividad.id,i.id_dosificacion=i.dosificacion.id,r.sucursal.actividadesDosificaciones.push(i)),r.actividadDosificacion={})},r.removerActividadDosificacion=function(e){e.eliminado=!0},r.$on("$routeChangeStart",function(e,a){r.eliminarPopup(r.idModalWizardSucursalEdicion),r.eliminarPopup(r.idModalWizardSucursalCorrelativoEdicion),r.eliminarPopup(r.idModalWizardSucursalVista),r.eliminarPopup(r.idModalEliminarSucursal)}),r.inicio()}]),angular.module("agil.controladores").controller("controladorTransacciones",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ObtenerTodoPersonal","TransaccionBancoPaginador","$timeout","Paginator","ListaBancos","ClasesTipo","TransaccionIngresoBanco","FieldViewer","TransaccionEgresoBanco","TransaccionSeguimientoBanco","TransaccionSeguimientoEstado","TransaccionRevisionEstado","SaldoCuenta","SaldoDisponibleCuenta","SaldoProformas",function(c,e,a,o,i,l,t,r,n,s,d,u,p,m,f,g,v,h,b,C,P){c.modalNuevoIngreso="modal-wizard-nuevo-ingreso",c.modalNuevoEgreso="modal-wizard-nuevo-egreso",c.modalSeguimiento="modal-wizard-seguimiento",c.modalRevision="modal-wizard-revision",c.modalVencimientoCreditos="tabla-vencimiento-creditos-transaciones",c.modalVerIngreso="modal-wizard-ver-ingreso",c.modalVerEgreso="modal-wizard-ver-egreso",c.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsTransacciones(c.modalNuevoIngreso,c.modalNuevoEgreso,c.modalSeguimiento,c.modalRevision,c.modalVencimientoCreditos,c.modalVerIngreso,c.modalVerEgreso),c.buscarAplicacion(c.usuario.aplicacionesUsuario,a.path().substring(1)),c.obtenerColumnasAplicacion()}),c.$on("$routeChangeStart",function(e,a){c.eliminarPopup(c.modalNuevoIngreso),c.eliminarPopup(c.modalNuevoEgreso),c.eliminarPopup(c.modalSeguimiento),c.eliminarPopup(c.modalRevision),c.eliminarPopup(c.modalVencimientoCreditos)}),c.inicio=function(){var e=new Date;c.filtro={empresa:c.usuario.empresa.id,desde:e.setDate(e.getDate()-7),hasta:(new Date).toLocaleDateString(),cuenta:0,nombre:0,concepto:0,ref_doc:0,tipo_doc:0,estado:0},c.filtro.desde=new Date(c.filtro.desde).toLocaleDateString(),c.obtenerCuentas(),c.obtenerConceptosTransaccion(),c.obtenerTiposDocumentos(),c.obtenerEstadosTransaccion(),n(function(){c.obtenerVencimientos()},5e3),c.fondosDisponibles=0,c.ingresosEnTransito=0,c.egresosEnTransito=0,c.saldoInicial=0,c.saldoFinal=0,c.saldoPignorado=0,c.fecha_hoy=(new Date).toLocaleDateString(),t(c.usuario.id_empresa).then(function(e){c.empleados=e.personal,c.obtenerTransacciones()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";c.mostrarMensaje(a)})},c.obtenerConceptosTransaccion=function(){l.start(),u("CONTRAN").then(function(e){c.conceptosTransaccion=e.clases,c.conceptosTransaccion.forEach(function(e){"CTRANS"===e.nombre_corto&&(c.TRAN_COBRO=e),"PTRANS"===e.nombre_corto&&(c.TRAN_PAGO=e),"SAL_INICIAL"==e.nombre_corto&&(c.SALDO_INICIAL=e)}),l.stop()})},c.obtenerVencimientos=function(){c.vencimientosCobros=[],c.verificarVencimientosCreditos(c.usuario.id_empresa),P(c.usuario.id_empresa).then(function(e){var o=[];e.hasErr?c.mostrarMensaje(e.mensaje):(e.proformas.forEach(function(e){var a={id:e.id,factura:e.factura,total:e.monto,cliente:{razon_social:e.razon_social},a_cuenta:e.a_cuenta,saldo:e.saldo,es_proforma:!0};o.push(a)}),Array.prototype.push.apply(c.vencimientosCobros,o)),Array.prototype.push.apply(c.vencimientosCobros,c.vencimientosCreditos)}).catch(function(e){}),console.log(c.vencimientosCobros)},c.obtenerTiposDocumentos=function(){l.start(),u("TDC").then(function(e){c.tiposDocumentos=e.clases,l.stop()})},c.obtenerSaldoInicial=function(){c.saldoInicial=0,b(c.usuario.id_empresa,c.cuentaSeleccionada.id,c.filtro.desde,c.filtro.hasta).then(function(e){void 0!==e.cuenta?c.saldoInicial=e.cuenta[0].saldo:c.mostrarMensaje("La cuenta Nro. "+c.cuentaSeleccionada.numero+" de "+c.cuentaSeleccionada.nombre+" no cuenta con un ingreso de apertura")}).catch(function(e){var a=void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";c.mostrarMensaje(a)})},c.showSelecccionCliente=function(e){return null==e||(void 0===e.concepto||null===e.concepto||(void 0!==e.concepto.id?e.concepto.id!==c.SALDO_INICIAL.id:e.concepto!==c.SALDO_INICIAL.id))},c.obtenerEstadosTransaccion=function(){l.start(),u("ESTRANS").then(function(e){c.estadosTransaccion=e.clases,e.clases.map(function(e){"CONFIRMADO"==e.nombre_corto&&(c.CONFIRMADO=e),"EN_TRANSITO"==e.nombre_corto&&(c.EN_TRANSITO=e)}),l.stop()})},c.seleccionarCuenta=function(a){c.cuentaSeleccionada=void 0,c.bancos.forEach(function(e){e.id===a.id&&(c.cuentaSeleccionada=e,c.filtro.cuenta=c.cuentaSeleccionada)})},c.obtenerCuentas=function(){d(c.usuario.id_empresa).then(function(e){c.bancos=e,c.cuentaSeleccionada=c.bancos[0],c.filtro.cuenta=c.cuentaSeleccionada})},c.calcularIngresosTransito=function(){c.ingresosEnTransito=0,c.transacciones.forEach(function(e){null!==e.haber&&e.id_estado===c.EN_TRANSITO.id&&(c.ingresosEnTransito+=e.haber)})},c.calcularEgresosTransito=function(){c.egresosEnTransito=0,c.transacciones.forEach(function(e){null!==e.debe&&e.id_estado===c.EN_TRANSITO.id&&(c.egresosEnTransito+=e.debe)})},c.calcularFondosDisponibles=function(){c.fondosDisponibles=0,C(c.usuario.id_empresa,c.cuentaSeleccionada.id,0,0).then(function(e){e.hasErr&&c.mostrarMensaje(e.mensaje),c.fondosDisponibles=e.saldo,c.calcularIngresosTransito(),c.calcularEgresosTransito(),c.calcularSaldoPignorado(),c.calcularSaldoFinal(),b(c.usuario.id_empresa,c.cuentaSeleccionada.id,c.filtro.desde,c.filtro.hasta).then(function(e){c.saldoInicial=e.cuenta[0].saldo})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(a),l.stop()})},c.calcularSaldoFinal=function(){c.saldoFinal=c.fondosDisponibles+c.ingresosEnTransito-c.egresosEnTransito},c.calcularSaldoPignorado=function(){c.saldoPignorado=0,c.transacciones.forEach(function(e){null!==e.debe&&e.id_estado===c.EN_TRANSITO.id&&(c.saldoPignorado-=e.debe),null!==e.haber&&e.id_estado===c.EN_TRANSITO.id&&(c.saldoPignorado+=e.haber)})},c.obtenerColumnasAplicacion=function(){l.start(),c.fieldViewer=m({crear:!0,id_empresa:c.usuario.id_empresa,configuracion:{numero:{value:"N°",show:!0},fecha:{value:"Fecha",show:!0},banco:{value:"Banco",show:!0},detalle:{value:"Detalle",show:!0},nombre:{value:"Nombre completo",show:!0},concepto:{value:"Concepto",show:!0},observaciones:{value:"Observaciones",show:!0},ref_doc:{value:"Ref./Doc.",show:!0},tipo_doc:{value:"tipo Documento",show:!0},debe:{value:"Debe",show:!0},haber:{value:"Haber",show:!0},saldo:{value:"Saldo",show:!0},estado:{value:"estado",show:!0}}},c.aplicacion.aplicacion.id),c.fieldViewer.updateObject(),l.stop()},c.obtenerSaldoCuenta=function(){var e=b(c.usuario.id_empresa,c.filtro.cuenta,new Date),a=!1;e.then(function(e){a=!0,c.saldoInicial=e.transaccion.saldo}),n(function(){a?l.stop():(l.stop(),c.mostrarMensaje("La respuesta esta tardando mas de lo normal"))},5e3)},c.filtrarTransacciones=function(e,a,o){if(void 0!==o)for(var i in e)0==e[i]&&(e[i]="");else for(var i in e)""!==e[i]&&null!==e[i]&&void 0!==e[i]||(e[i]=0);if(void 0!==a&&a)return e;c.buscarTransacciones()},c.obtenerTransacciones=function(){c.paginator=s(),c.paginator.column="fecha",c.paginator.direccion="asc",c.paginator.callBack=c.buscarTransacciones,c.paginator.getSearch("")},c.buscarTransacciones=function(){l.start(),0===c.filtro.cuenta&&(c.filtro.cuenta=c.cuentaSeleccionada),c.filtro=c.filtrarTransacciones(c.filtro,!0),c.paginator.filter=c.filtro,r(c.usuario.id_empresa,c.paginator).then(function(e){e.hasErr?c.mostrarMensaje(e.mensaje):(c.transacciones=e.transacciones,c.transacciones.forEach(function(e){c.verificarSeguimiento(e)}),c.paginator.setPages(e.paginas),c.calcularFondosDisponibles(),c.obtenerSaldoInicial(),c.obtenerVencimientos()),l.stop()}),c.filtro=c.filtrarTransacciones(c.filtro,!0,!0)},c.usuario=JSON.parse(e.usuario),c.crearNuevoIngreso=function(){c.abrirModalNuevoIngreso()},c.crearNuevoEgreso=function(){c.abrirModalNuevoEgreso()},c.seguimiento=function(e){c.transaccion=e,c.abrirModalSeguimiento()},c.guardarSeguimiento=function(a){if(l.start(),null!==a.seguimientos[0].id_entregado){if(a.seguimientos[0].id_entregado!==a.seguimientos[0].entregado_por.id)return c.mostrarMensaje("No se permiten cambios!"),void l.stop();if(null===a.seguimientos[0].id_devuelto||a.seguimientos[0].proveedor)null!==a.seguimientos[0].fecha_devolucion||a.seguimientos[0].proveedor||0===a.seguimientos[0].devuelto_a||void 0===a.seguimientos[0].devuelto_a||null===a.seguimientos[0].devuelto_a||(a.seguimientos[0].fecha_devolucion=new Date,a.seguimientos[0].id_devuelto=a.seguimientos[0].devuelto_a.id);else if(a.seguimientos[0].id_devuelto!==a.seguimientos[0].devuelto_a.id)return c.mostrarMensaje("No se permiten cambios!"),void l.stop()}else null===a.seguimientos[0].fecha_entrega&&(a.seguimientos[0].fecha_entrega=new Date,a.seguimientos[0].id_entregado=a.seguimientos[0].entregado_por.id);g(c.usuario.id_empresa,a.seguimientos[0],c.usuario.id).then(function(e){e.hasErr?c.mostrarMensaje(e.mensaje):(c.mostrarMensaje(e.mensaje),c.cerrarModalSeguimiento(),c.verificarSeguimiento(a)),l.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(a),l.stop()})},c.verificarSeguimiento=function(e){0<e.seguimientos.length&&(null!==e.seguimientos[0].entregado_por||null!==e.seguimientos[0].devuelto_a||e.seguimientos[0].proveedor||(e.seguimientos[0].black=!0,e.seguimientos[0].yellow=void 0,e.seguimientos[0].green=void 0),null===e.seguimientos[0].entregado_por||null!==e.seguimientos[0].devuelto_a||e.seguimientos[0].proveedor||(e.seguimientos[0].black=void 0,e.seguimientos[0].yellow=!0,e.seguimientos[0].green=void 0),null===e.seguimientos[0].entregado_por||null===e.seguimientos[0].devuelto_a||e.seguimientos[0].proveedor||(e.seguimientos[0].black=void 0,e.seguimientos[0].yellow=void 0,e.seguimientos[0].green=!0),null===e.seguimientos[0].entregado_por&&null===e.seguimientos[0].devuelto_a&&e.seguimientos[0].proveedor&&(e.seguimientos[0].black=!0,e.seguimientos[0].yellow=void 0,e.seguimientos[0].green=void 0),null!==e.seguimientos[0].entregado_por&&null===e.seguimientos[0].devuelto_a&&e.seguimientos[0].proveedor&&(e.seguimientos[0].black=void 0,e.seguimientos[0].yellow=void 0,e.seguimientos[0].green=!0))},c.calcularSaldo=function(){},c.verificarConcepto=function(e){c.SALDO_INICIAL.id===e.concepto&&(e.venta=void 0,e.detalle="Ingreso apertura.")},c.guardarRevision=function(){l.start(),c.transaccion.cerrado=!0,h(c.usuario.id_empresa,c.usuario.id,c.transaccion.id).then(function(e){l.stop(),c.mostrarMensaje(e.mensaje),c.cerrarModalRevision()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(a),l.stop()})},c.guardarIngreso=function(o){l.start(),o.fecha=new Date(c.convertirFecha(o.fecha)),p(c.usuario.id_empresa,o,c.usuario.id).then(function(e){if(e.hasErr)o.fecha=new Date(o.fecha).toLocaleDateString(),c.mostrarMensaje(e.mensaje);else{if(c.mostrarMensaje(e.mensaje),o.venta.saldo-=o.haber,o.venta.es_proforma){if(o.concepto!==c.SALDO_INICIAL.id){var a={pago:ConvertirALiteral(o.haber.toFixed(2))};c.imprimirReciboVencimientoCreditoProforma(a,e.venta,o.haber)}}else if(o.concepto!==c.SALDO_INICIAL.id){a={pago:ConvertirALiteral(o.haber.toFixed(2))};c.imprimirReciboVencimientoCredito(a,e.venta,o.haber,!0)}c.verificarVencimientosCreditos(c.usuario.id_empresa),c.filtrarTransacciones(c.filtro),c.cerrarModalNuevoIngreso(),c.obtenerVencimientos()}l.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(a),o.fecha=new Date(o.fecha).toLocaleDateString(),l.stop()})},c.guardarEgreso=function(o){l.start(),o.fecha=new Date(c.convertirFecha(o.fecha)),f(c.usuario.id_empresa,o,c.usuario.id).then(function(e){e.hasErr?(c.mostrarMensaje(e.mensaje),o.fecha=o.fecha.toLocaleDateString()):(c.mostrarMensaje(e.mensaje),c.verificarVencimientosDeudas(c.usuario.id_empresa),c.filtrarTransacciones(c.filtro),c.cerrarModalNuevoEgreso()),l.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";c.mostrarMensaje(a),o.fecha=o.fecha.toLocaleDateString(),l.stop()})},c.imprimirReciboVencimientoCreditoProforma=function(e,a,o){l.start();var i=new PDFDocument({size:[227,353],margin:10}),t=i.pipe(blobStream());i.moveDown(2),i.font("Helvetica-Bold",8),i.text(c.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),i.moveDown(.4),i.font("Helvetica",7),i.text(a.sucursal.nombre.toUpperCase(),{align:"center"}),i.moveDown(.4),i.text(a.sucursal.direccion.toUpperCase(),{align:"center"}),i.moveDown(.4);var r=(null!=a.sucursal.telefono1?a.sucursal.telefono1:"")+(null!=a.sucursal.telefono2?"-"+a.sucursal.telefono2:"")+(null!=a.sucursal.telefono3?"-"+a.sucursal.telefono3:"");i.text("TELF.: "+r,{align:"center"}),i.moveDown(.4),i.text("COCHABAMBA - BOLIVIA",{align:"center"}),i.moveDown(.5),i.font("Helvetica-Bold",8),i.text("RECIBO",{align:"center"}),i.font("Helvetica",7),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.text(a.sucursal.nota_recibo_correlativo,{align:"center"}),i.moveDown(.4),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.moveDown(.6);var n=new Date;i.text("FECHA : "+n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear(),{align:"left"}),i.moveDown(.4),i.text("He recibido de : "+a.cliente.razon_social,{align:"left"}),i.moveDown(.4),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.2),i.text("                                        CONCEPTO                                   ",{align:"left"}),i.moveDown(.2),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.4),a.fecha=new Date(a.fecha),i.text("Fecha: "+a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear(),15,210);var s=a.factura;i.text(s,105,210,{width:100}),i.text("Saldo Bs "+(a.saldo-o)+".-",105,220,{width:100}),i.text("Bs "+o+".-",170,210,{width:100}),i.text("--------------",10,230,{align:"right"}),i.moveDown(.3),i.text("TOTAL Bs.              "+o.toFixed(2),{align:"right"}),i.moveDown(.4),i.moveDown(.4),i.text("SON: "+e.pago,{align:"left"}),i.moveDown(.6),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.text("-------------------------                       -------------------------",{align:"center"}),i.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),l.stop()},c.estadoConfirmado=function(o){l.start();var i=!0;if(null!==o.seguimientos[0].id_entregado&&(null!==o.seguimientos[0].id_devuelto&&!o.seguimientos[0].proveedor||null===o.seguimientos[0].id_devuelto&&o.seguimientos[0].proveedor)){if(c.estadosTransaccion.map(function(e,a){"CONFIRMADO"==e.nombre&&(o.estado=e,i=!1)}),i)return l.stop(),void c.mostrarMensaje("Hubo un error al confirmar el estado");v(c.usuario.id_empresa,o.estado.id,c.usuario.id,o.id).then(function(e){e.hasErr||(o.estado.confirmado=!0,c.filtrarTransacciones(c.filtro)),c.mostrarMensaje(e.mensaje),l.stop()}).catch(function(e){l.stop();var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";c.mostrarMensaje(a)})}else l.stop(),c.mostrarMensaje("No se puede confirmar el estado de la transacción, no existe información de seguimiento o esta inclompleta.")},c.abrirModalNuevoIngreso=function(){c.verificarVencimientosCreditos(c.usuario.id_empresa),c.ingreso={},c.ingreso.fecha=(new Date).toLocaleDateString(),c.abrirPopup(c.modalNuevoIngreso)},c.abrirModalVerIngreso=function(e){c.ingreso=e,c.ingreso.fecha=new Date(c.ingreso.fecha).toLocaleDateString(),c.abrirPopup(c.modalVerIngreso)},c.cerrarModalNuevoIngreso=function(){c.ingreso=void 0,c.cerrarPopup(c.modalNuevoIngreso)},c.cerrarModalVerIngreso=function(){c.ingreso=void 0,c.cerrarPopup(c.modalVerIngreso)},c.abrirModalNuevoEgreso=function(){c.egreso={},c.egreso.fecha=(new Date).toLocaleDateString(),c.abrirPopup(c.modalNuevoEgreso)},c.cerrarModalNuevoEgreso=function(){c.egreso=void 0,c.cerrarPopup(c.modalNuevoEgreso)},c.abrirModalVerEgreso=function(e){c.egreso=e,c.egreso.fecha=(new Date).toLocaleDateString(),c.abrirPopup(c.modalVerEgreso)},c.cerrarModalVerEgreso=function(){c.egreso=void 0,c.cerrarPopup(c.modalVerEgreso)},c.abrirModalSeguimiento=function(){c.abrirPopup(c.modalSeguimiento)},c.cerrarModalSeguimiento=function(){c.transaccion=void 0,c.cerrarPopup(c.modalSeguimiento)},c.obtenerSaldoDiaAnterior=function(){new Date;obtenerSaldoCuenta(c.usuario.id_empresa).then(function(e){e.hasErr&&c.mostrarMensaje(e.mensaje)})},c.abrirModalRevision=function(i){var e=u("ESTRANS"),t=!0;e.then(function(o){o.clases.map(function(e,a){i.id_estado==e.id&&"CONFIRMADO"===e.nombre&&(t=!1),a===o.clases.length-1&&(t?c.mostrarMensaje("La transaccion no se puede cerrar, aún no ha sido confirmada."):(c.transaccion=i,c.abrirPopup(c.modalRevision)))})}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";c.mostrarMensaje(a)})},c.cerrarModalRevision=function(){c.transaccion=void 0,c.cerrarPopup(c.modalRevision)},c.abrirModalVencimientoCreditos=function(){c.abrirPopup(c.modalVencimientoCreditos)},c.establecerConceptoIngreso=function(e){e.detalle="Cobro Factura N° "+e.venta.factura,e.factura=e.venta.factura,e.haber=e.venta.saldo},c.establecerConceptoEgreso=function(e){e.detalle="Pago Factura N° "+e.compra.factura,e.factura=e.compra.factura,e.debe=e.compra.saldo},c.cerrarModalVencimientoCreditos=function(){c.transaccion=void 0,c.cerrarPopup(c.modalVencimientoCreditos)},c.inicio()}]),angular.module("agil.controladores").controller("ControladorVehiculos",["$scope","blockUI","$localStorage","$location","$templateCache","$route","$timeout","Diccionario","ClasesTipo","$window","Paginator","VehiculosPaginador","FieldViewer","ListaMantenimientoVehiculo","ClasesTipo","ListaMantenimientoEncargado","ProductosPanel","ListaProductosEmpresa","ListaInventariosProducto","GuardarNuevaOrdendeTrabajo","ActualizarOrdendeTrabajo","DatosFechasVehiculos","ObtenerDatosVehiculo",function(s,i,t,e,a,o,r,n,c,l,d,u,p,m,c,f,g,v,h,b,C,P,_){s.usuario=JSON.parse(t.usuario),s.modalNuevoMantenimiento="dialog-iniciar-mantenimiento",s.modalReportarIncidente="modal-reportar-incidente",s.modalCheckListDiario="modal-checklist-diario",s.modalCheckListMensual="modal-checklist-mensual",s.modalEditarHistorico="dialog-editar-historico",s.modalOTEdicionCorrectivo="dialog-edicion-correctivo",s.modalMantenimientoCorrectivo="dialog-mantenimiento-correctivo",s.modalBusquedaProducto="dialog-busqueda-producto",s.modalBusquedaEncargado="dialog-busqueda-encargado",s.modalLogin="dialog-login",s.modalNuevoMantenimientoMaquinaria="dialog-iniciar-mantenimiento-maquinaria",s.modalCheckListMensualMaquinaria="modal-checklist-mensual-maquinaria",s.modalEditarItemList="dialog-editar-item-list",s.modalProxMantenimientoMaquinaria="dialog-prox-mantenimiento-maquinaria",s.modalProxMantenimientoVehiculo="dialog-prox-mantenimiento-vehiculo",s.modalCalendar="dialog-calendar",s.modalFichaVehiculo="dialog-ficha-vehiculo",s.modalEditarCheckList="modal-editar-checklist",s.modalBuscarMaquinaria="dialog-buscar-maquinaria",s.modalReportarIncidenteMaquinaria="modal-reportar-incidente-maquinaria",s.idModalInicioMantenimiento="dialog-iniciar-mantenimiento",s.idModalOTNuevo="dialog-ot-nuevo",s.idModalFacturaServicioExterno="dialog-factura-servicioExterno",s.idModaRepuestosOT="panel-repuestos-ot",s.idModalwizardContainerOTNuevo="modal-wizard-ot-nuevo-container",s.idModalEventoCalendario="dialog-evento-calendario",s.idModalEditarEventoCalendario="dialog-editar-evento-calendario",console.log(e.path()),s.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsVehiculos(s.modalNuevoMantenimiento,s.modalReportarIncidente,s.modalCheckListDiario,s.modalCheckListMensual,s.modalEditarHistorico,s.modalOTEdicionCorrectivo,s.modalMantenimientoCorrectivo,s.modalBusquedaProducto,s.modalBusquedaEncargado,s.modalLogin,s.modalNuevoMantenimientoMaquinaria,s.modalCheckListMensualMaquinaria,s.modalEditarItemList,s.modalProxMantenimientoMaquinaria,s.modalProxMantenimientoVehiculo,s.modalCalendar,s.modalFichaVehiculo,s.modalEditarCheckList,s.modalBuscarMaquinaria,s.modalReportarIncidenteMaquinaria,s.idModalInicioMantenimiento,s.idModalOTNuevo,s.idModalwizardContainerOTNuevo,s.idModalFacturaServicioExterno,s.idModaRepuestosOT,s.idModalEventoCalendario,s.idModalEditarEventoCalendario),s.buscarAplicacion(s.usuario.aplicacionesUsuario,e.path().substring(1)),s.obtenerColumnasAplicacion()}),s.$on("$routeChangeStart",function(e,a){s.eliminarPopup(s.modalNuevoMantenimiento),s.eliminarPopup(s.modalReportarIncidente),s.eliminarPopup(s.modalCheckListDiario),s.eliminarPopup(s.modalCheckListMensual),s.eliminarPopup(s.modalEditarHistorico),s.eliminarPopup(s.modalMantenimientoCorrectivo),s.eliminarPopup(s.modalOTEdicionCorrectivo),s.eliminarPopup(s.modalBusquedaProducto),s.eliminarPopup(s.modalBusquedaEncargado),s.eliminarPopup(s.modalLogin),s.eliminarPopup(s.modalNuevoMantenimientoMaquinaria),s.eliminarPopup(s.modalCheckListMensualMaquinaria),s.eliminarPopup(s.modalEditarItemList),s.eliminarPopup(s.modalProxMantenimientoMaquinaria),s.eliminarPopup(s.modalProxMantenimientoVehiculo),s.eliminarPopup(s.modalCalendar),s.eliminarPopup(s.modalFichaVehiculo),s.eliminarPopup(s.modalEditarCheckList),s.eliminarPopup(s.modalBuscarMaquinaria),s.eliminarPopup(s.modalReportarIncidenteMaquinaria),s.eliminarPopup(s.idModalOTNuevo),s.eliminarPopup(s.idModalEventoCalendario),s.eliminarPopup(s.idModalEditarEventoCalendario),s.eliminarPopup(s.idModaRepuestosOT)}),s.inicio=function(){s.ObteneVehiculos(),s.obtenerTiposMantenimiento(),s.obtenerTiposSistemasOrdenTrabajo(),s.obtenerTiposPrioridad(),s.obtenerTiposEspecialidad(),s.aplicarCalendario(),s.sucursales=s.obtenerSucursales()},s.abrirReportarIncidenteMaquinaria=function(){abrirPopup(s.modalReportarIncidenteMaquinaria)},s.abrirEventoCalendario=function(){abrirPopup(s.idModalEventoCalendario)},s.abrirEditarEventoCalendario=function(){abrirPopup(s.idModalEditarEventoCalendario)},s.abrirBuscarMaquinaria=function(){abrirPopup(s.modalBuscarMaquinaria)},s.abrirEditarCheckList=function(){abrirPopup(s.modalEditarCheckList)},s.abrirFichaVehiculo=function(){abrirPopup(s.modalFichaVehiculo)},s.abrirOTCalendar=function(){s.calendario={id_empresa:s.usuario.id_empresa,correctivo:!1,preventivo:!1,rutina:!1,entrega:!1},abrirPopup(s.modalCalendar)},s.abrirProxMantenimientoVehiculos=function(){abrirPopup(s.modalProxMantenimientoVehiculo)},s.abrirProxMantenimientoMaquinaria=function(){abrirPopup(s.modalProxMantenimientoMaquinaria)},s.abrirEditarItemList=function(){abrirPopup(s.modalEditarItemList)},s.abrirCheckListMensualMaquinaria=function(){abrirPopup(s.modalCheckListMensualMaquinaria)},s.abrirNuevoMantenimientoMaquinaria=function(){abrirPopup(s.modalNuevoMantenimientoMaquinaria)},s.abrirModalLogin=function(){abrirPopup(s.modalLogin)},s.abrirBusquedaEncargado=function(){abrirPopup(s.modalBusquedaEncargado)},s.abrirBusquedaProducto=function(){abrirPopup(s.modalBusquedaProducto)},s.abrirMantenimientoCorrectivo=function(){abrirPopup(s.modalMantenimientoCorrectivo)},s.abrirOTEdicionCorrectivo=function(a){promesa=_(s.usuario.id_empresa,a.id),promesa.then(function(e){s.editOt=!0,s.vehiculo=e.mantenimiento,s.vehiculo.fecha_hora_inicio=moment(a.fecha_hora_inicio).format("MM/DD/YYYY h:mm A"),s.vehiculo.fecha_hora_fin=moment(a.fecha_hora_inicio).format("MM/DD/YYYY h:mm A"),s.vehiculo.fecha_hora_aviso=moment(a.fecha_hora_inicio).format("MM/DD/YYYY h:mm A"),s.vehiculo.manosDeObra.forEach(function(e){e.horas=24*s.diferenciaEntreDiasEnDias(new Date(e.fecha_inicio),new Date(e.fecha_fin))},this),console.log(s.vehiculo),abrirPopup(s.modalOTEdicionCorrectivo)})},s.abrirEditarHistorico=function(){abrirPopup(s.modalEditarHistorico)},s.abrirCheckListMensual=function(){abrirPopup(s.modalCheckListMensual)},s.abrirCheckListDiario=function(){abrirPopup(s.modalCheckListDiario)},s.abrirReportarIncidente=function(){abrirPopup(s.modalReportarIncidente)},s.abrirNuevoMantenimiento=function(){abrirPopup(s.modalNuevoMantenimiento)},s.abrirPopup=function(e){abrirPopup(e)},s.cerrarPopup=function(e){ocultarPopup(e)},s.cerrarEventoCalendario=function(){s.cerrarPopup(s.idModalEventoCalendario)},s.cerrarEditarEventoCalendario=function(){s.cerrarPopup(s.idModalEditarEventoCalendario)},s.cerrarReportarIncidenteMaquinaria=function(){s.cerrarPopup(s.modalReportarIncidenteMaquinaria)},s.cerrarBuscarMaquinaria=function(){s.cerrarPopup(s.modalBuscarMaquinaria)},s.cerrarEditarCheckList=function(){s.cerrarPopup(s.modalEditarCheckList)},s.cerrarFichaVehiculo=function(){s.cerrarPopup(s.modalFichaVehiculo)},s.cerrarOTCalendar=function(){s.cerrarPopup(s.modalCalendar)},s.cerrarProxMantenimientoVehiculos=function(){s.cerrarPopup(s.modalProxMantenimientoVehiculo)},s.cerrarProxMantenimientoMaquinaria=function(){s.cerrarPopup(s.modalProxMantenimientoMaquinaria)},s.cerrarEditarItemList=function(){s.cerrarPopup(s.modalEditarItemList)},s.cerrarCheckListMensualMaquinaria=function(){s.cerrarPopup(s.modalCheckListMensualMaquinaria)},s.cerrarNuevoMantenimientoMaquinaria=function(){s.cerrarPopup(s.modalNuevoMantenimientoMaquinaria)},s.cerrarModalLogin=function(){s.cerrarPopup(s.modalLogin)},s.cerrarBusquedaEncargado=function(){s.cerrarPopup(s.modalBusquedaEncargado)},s.cerrarBusquedaProducto=function(){s.cerrarPopup(s.modalBusquedaProducto)},s.cerrarMantenimientoCorrectivo=function(){s.cerrarPopup(s.modalMantenimientoCorrectivo)},s.cerrarOTEdicionCorrectivo=function(){s.editOt=!1,s.cerrarPopup(s.modalOTEdicionCorrectivo)},s.cerrarEditarHistorico=function(){s.cerrarPopup(s.modalEditarHistorico)},s.cerrarCheckListMensual=function(){s.cerrarPopup(s.modalCheckListMensual)},s.cerrarCheckListDiario=function(){s.cerrarPopup(s.modalCheckListDiario)},s.cerrarReportarIncidente=function(){s.cerrarPopup(s.modalReportarIncidente)},s.cerrarNuevoMantenimiento=function(){s.cerrarPopup(s.modalNuevoMantenimiento)},s.eliminarPopup=function(e){eliminarPopup(e)},s.enfocar=function(e){r(function(){$("#"+e).focus()},0)},s.abrirDialogInicioMantenimiento=function(){s.nuevoOt={tipo_mantenimiento:"",ordenTrabajoManoObra:[],servicioExterno:[]},s.abrirPopup(s.idModalInicioMantenimiento)},s.cerrarPopUpInicioMantenimiento=function(){s.cerrarPopup(s.idModalInicioMantenimiento)},s.abrirDialogOTnuevo=function(e){e&&(s.ordenTrabajoManoObra={edit:!1},console.log(s.ordenTrabajoManoObra),s.cerrarPopUpInicioMantenimiento(),s.abrirPopup(s.idModalOTNuevo))},s.cerrarOTnuevo=function(){s.cerrarPopup(s.idModalOTNuevo)},s.abrirDialogFacturaServicioExterno=function(){s.abrirPopup(s.idModalFacturaServicioExterno)},s.cerrarDialogFacturaServicioExterno=function(){s.cerrarPopup(s.idModalFacturaServicioExterno)},s.abrirDialogRepuestosOT=function(){s.venta={detallesVenta:[]},s.abrirPopup(s.idModaRepuestosOT)},s.cerrarDialogRepuestosOT=function(){s.cerrarPopup(s.idModaRepuestosOT)},s.interceptarTecla=function(e,a,o){13===e.which&&(o?s.enfocar(a):r(function(){$("#"+a).trigger("click")},0))},s.obtenerListaVehiculos=function(){if(i.start(),0!=s.paginator.filter.inicio&&null!=s.paginator.filter.inicio){var a=s.paginator.filter.inicio,o=s.paginator.filter.fin;s.paginator.filter.inicio=new Date(s.convertirFecha(s.paginator.filter.inicio)),s.paginator.filter.fin=new Date(s.convertirFecha(s.paginator.filter.fin))}else s.paginator.filter.inicio=0,s.paginator.filter.fin=0;var e=u(s.paginator);s.totalImporte=0,e.then(function(e){s.paginator.setPages(e.paginas),s.vehiculos=e.vehiculos,s.filtro={empresa:s.usuario.id_empresa,inicio:"",fin:"",tipo_activo:"",placa:"",marca:"",modelo:"",anio:"",tipo_mantenimiento:"",numero_ot:"",estado_ot:"",campamento:""},s.paginator.filter.inicio=a,s.paginator.filter.fin=o,i.stop()})},s.ObteneVehiculos=function(){s.paginator=d(),s.paginator.column="diagnostico",s.paginator.callBack=s.obtenerListaVehiculos,s.filtro={empresa:s.usuario.id_empresa,inicio:"",fin:"",tipo_activo:"",placa:"",marca:"",modelo:"",anio:"",tipo_mantenimiento:"",numero_ot:"",estado_ot:"",campamento:""},null!=s.filtro.inicio&&s.paginator.getSearch("",s.filtro)},s.obtenerColumnasAplicacion=function(){s.fieldViewer=p({crear:!0,id_empresa:s.usuario.id_empresa,configuracion:{cod_usuario:{value:"Cod-Usuario",show:!0},fecha:{value:"Fecha.",show:!0},anio:{value:"año",show:!0},imagen:{value:"Imagen",show:!0},ot:{value:"OT",show:!0},estado_OT:{value:"Estado-OT",show:!0},Tipo_de_activo:{value:"Tipo-de-activo",show:!0},km:{value:"Km",show:!0},usuario:{value:"Usuario",show:!0},marca:{value:"Marca",show:!0},modelo:{value:"Modelo",show:!0},mantenimiento:{value:"Manteniminto",show:!0},campamento:{value:"Campamento",show:!0}}},s.aplicacion.aplicacion.id),s.fieldViewer.updateObject()},s.establecervehiculo=function(e){s.nuevoOt.vehiculo=e},s.establecerEncargado=function(e){s.ordenTrabajoManoObra.encargado=e},s.buscarVehiculos=function(e){if(""!=e&&null!=e)return m(s.usuario.id_empresa,e)},s.buscarEncargado=function(e){if(""!=e&&null!=e)return f(s.usuario.id_empresa,e)},s.buscarProducto=function(e){if(""!=e&&null!=e)return v(s.usuario.id_empresa,e)},s.establecerProducto=function(i){i.tipoProducto=null==i.tipoProducto?{id:i["tipoProducto.id"],nombre:i["tipoProducto.nombre"],nombre_corto:i["tipoProducto.nombre_corto"]}:i.tipoProducto,s.editar_precio=!1,h(i.id,s.venta.almacen.id).then(function(e){i.inventarios=e;for(var a=0;a<i.inventarios.length;a++)i.inventarios[a].fecha_vencimiento=i.inventarios[a].fecha_vencimiento?new Date(i.inventarios[a].fecha_vencimiento):null,i.inventarios[a].fechaVencimientoTexto=i.inventarios[a].fecha_vencimiento?i.inventarios[a].fecha_vencimiento.getDate()+"/"+(i.inventarios[a].fecha_vencimiento.getMonth()+1)+"/"+i.inventarios[a].fecha_vencimiento.getFullYear():"",i.inventarios[a].detallesMovimiento[0].movimiento.fecha=new Date(i.inventarios[a].detallesMovimiento[0].movimiento.fecha),i.inventarios[a].detallesMovimiento[0].movimiento.fechaTexto=i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+i.inventarios[a].detallesMovimiento[0].movimiento.fecha.getFullYear();s.inventariosDisponibleProducto=[],s.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),s.inventariosDisponibleProducto=s.inventariosDisponibleProducto.concat(i.inventarios);var o=s.obtenerInventarioTotal(i);s.detalleVenta={producto:i,precio_unitario:i.precio_unitario,inventarioProducto:s.inventariosDisponibleProducto[0],inventario_disponible:o,costos:i.activar_inventario?i.inventarios:[],cantidad:1,descuento:i.descuento,recargo:0,ice:0,excento:0,tipo_descuento:0<i.descuento,tipo_recargo:!1},s.colorearInventarioDisponible(o,i),s.calcularImporte(),s.cerrarPopup(s.idModalInventario),s.enfocar("cantidad")})},s.obtenerInventarioTotalPorFechaVencimiento=function(e){for(var a=e.inventarioProducto.cantidad,o=0;o<s.venta.detallesVenta.length;o++)s.venta.detallesVenta[o].producto.id==e.producto.id&&s.venta.detallesVenta[o].costos[0].id==e.inventarioProducto.id&&(a-=s.venta.detallesVenta[o].cantidad);return a},s.sumarTotal=function(){for(var e=0,a=0;a<s.venta.detallesVenta.length;a++)e+=s.venta.detallesVenta[a].total;s.venta.total=Math.round(1e3*e)/1e3},s.calcularSaldo=function(){s.venta.saldo=s.venta.total-s.venta.a_cuenta},s.calcularCambio=function(){s.esContado?(s.venta.cambio=Math.round(100*(s.venta.pagado-s.venta.total))/100,s.pagoMinimo=s.venta.total):(s.venta.cambio=0,s.pagoMinimo=0)},s.GuardarDetalleMateriales=function(e){s.editOt?e.forEach(function(e){s.vehiculo.materiales.push(e)},this):(s.nuevoOt.materiales=e,s.nuevoOt.totalMaterial=s.venta.total),s.cerrarDialogRepuestosOT()},s.eliminarDetalleVenta=function(e){s.venta.detallesVenta.splice(s.venta.detallesVenta.indexOf(e),1),s.sumarTotal(),s.sumarTotalImporte(),s.calcularSaldo(),s.calcularCambio()},s.sumarTotalImporte=function(){for(var e=0,a=0;a<s.venta.detallesVenta.length;a++)e+=s.venta.detallesVenta[a].importe;s.venta.importe=Math.round(1e3*e)/1e3},s.agregarDetalleVenta=function(e){if(e.producto.activar_inventario)if(1<e.costos.length)for(var a=e.cantidad,o=0,i=JSON.parse(JSON.stringify(e));o<e.costos.length&&0<a;){e.inventarioProducto=e.costos[o];var t=s.obtenerInventarioTotalPorFechaVencimiento(e);if(0<t){var r,n=JSON.parse(JSON.stringify(i));0<o&&(n.descuento=0,n.recargo=0,n.ice=0,n.excento=0),t<a?a-=r=t:(r=a,a=0),(s.detalleVenta=n).cantidad=r,n.fecha_vencimiento=e.costos[o].fecha_vencimiento,n.lote=e.costos[o].lote,n.costos=[],n.costos.push(e.costos[o]),n.inventario=e.costos[o],s.calcularImporte(),s.venta.detallesVenta.push(n)}o++}else e.fecha_vencimiento=e.costos[0].fecha_vencimiento,e.lote=e.costos[0].lote,e.inventario=e.costos[0],s.venta.detallesVenta.push(e);else s.venta.detallesVenta.push(e);s.inventariosDisponibleProducto=[],s.sumarTotal(),s.sumarTotalImporte(),s.calcularSaldo(),s.calcularCambio(),s.detalleVenta={producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},s.enfocar("id_producto")},s.calcularImporte=function(){var e,a;s.detalleVenta.importe=Math.round(s.detalleVenta.cantidad*s.detalleVenta.precio_unitario*1e3)/1e3,e=s.detalleVenta.tipo_descuento?s.detalleVenta.importe*(s.detalleVenta.descuento/100):s.detalleVenta.descuento,a=s.detalleVenta.tipo_recargo?s.detalleVenta.importe*(s.detalleVenta.recargo/100):s.detalleVenta.recargo,s.detalleVenta.total=Math.round(1e3*(s.detalleVenta.importe-e+a-s.detalleVenta.ice-s.detalleVenta.excento))/1e3},s.colorearInventarioDisponible=function(e,a){0==e?(s.porcentaje="100",s.color="red"):e>3*a.inventario_minimo+1?(s.porcentaje="100",s.color="green"):e>2*a.inventario_minimo+1?(s.porcentaje="75",s.color="green"):e>1.5*a.inventario_minimo+1?(s.porcentaje="50",s.color="green"):e==a.inventario_minimo+1?(s.porcentaje="38",s.color="yellow"):e==a.inventario_minimo?(s.porcentaje="25",s.color="red"):e<a.inventario_minimo&&0<e&&(s.porcentaje="12",s.color="red")},s.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario){for(var o=0;o<e.inventarios.length;o++)a+=e.inventarios[o].cantidad;for(var i=0;i<s.venta.detallesVenta.length;i++)s.venta.detallesVenta[i].producto.id==e.id&&(a-=s.venta.detallesVenta[i].cantidad)}else a=5e5;return a},s.obtenerTiposMantenimiento=function(){i.start(),c("MTM").then(function(e){s.tiposMantenimiento=e.clases,i.stop()})},s.obtenerTiposSistemasOrdenTrabajo=function(){i.start(),c("SOT").then(function(e){s.tiposSistemas=e.clases,i.stop()})},s.obtenerTiposPrioridad=function(){i.start(),c("TPM").then(function(e){s.tiposPrioridad=e.clases,i.stop()})},s.obtenerTiposEspecialidad=function(){i.start(),c("TEM").then(function(e){s.tiposEspecialidad=e.clases,i.stop()})},s.obtenerSucursales=function(){for(var e=[],a=0;a<s.usuario.sucursalesUsuario.length;a++)e.push(s.usuario.sucursalesUsuario[a].sucursal);return e},s.obtenerAlmacenesActividades=function(e){s.obtenerAlmacenes(e),s.obtenerActividades(e)},s.obtenerAlmacenes=function(a){s.almacenes=[];var e=$.grep(s.sucursales,function(e){return e.id==a})[0];s.almacenes=e.almacenes,s.venta.almacen=1==s.almacenes.length?s.almacenes[0]:null,s.venta.almacen&&s.cargarProductos()},s.obtenerActividades=function(a){s.actividades=[];var e=$.grep(s.sucursales,function(e){return e.id==a})[0];s.actividadesDosificaciones=e.actividadesDosificaciones,s.actividades=[];for(var o=0;o<s.actividadesDosificaciones.length;o++)s.actividades.push(s.actividadesDosificaciones[o].actividad);s.venta.actividad=1==s.actividades.length?s.actividades[0]:null},s.cargarProductos=function(){g(s.usuario.id_empresa,s.venta.almacen.id).then(function(e){for(var a=0;a<e.length;a++)e[a].activar_inventario&&(e[a].inventario_disponible=s.obtenerInventarioTotal(e[a]));if(s.productos=e,angular.isDefined(t.productosProcesados)){s.productosProcesados=e;for(a=0;a<t.productosProcesados.length;a++)for(var o=0;o<s.productosProcesados.length;o++)t.productosProcesados[a].id==s.productosProcesados[o].id&&(s.productosProcesados[o].rankin=t.productosProcesados[a].rankin)}else s.productosProcesados=e;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},s.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario){for(var o=0;o<e.inventarios.length;o++)a+=e.inventarios[o].cantidad;for(var i=0;i<s.venta.detallesVenta.length;i++)s.venta.detallesVenta[i].producto.id==e.id&&(a-=s.venta.detallesVenta[i].cantidad)}else a=5e5;return a},s.diferenciaEntreDiasEnDias=function(e,a){var o=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),i=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate());return Math.floor((i-o)/864e5)},s.agregarManoDeObra=function(e){e.horas=24*s.diferenciaEntreDiasEnDias(new Date(e.fecha_inicio),new Date(e.fecha_fin)),e.eliminado=!1,s.nuevoOt.ordenTrabajoManoObra.push(e),s.ordenTrabajoManoObra={edit:!1}},s.agregarManoDeObraVehiculo=function(e){e.horas=24*s.diferenciaEntreDiasEnDias(new Date(e.fecha_inicio),new Date(e.fecha_fin)),e.eliminado=!1,s.vehiculo.manosDeObra.push(e),s.ordenTrabajoManoObra={edit:!1}},s.agregarServicioExterno=function(e){e.eliminado=!1,s.nuevoOt.servicioExterno.push(e),s.servicioExterno={}},s.agregarServicioExternoVehiculo=function(e){e.eliminado=!1,s.vehiculo.serviciosExternos.push(e),s.servicioExterno={}},s.eliminarProductoVehiculo=function(e){s.vehiculo.materiales.splice(s.vehiculo.materiales.indexOf(e),1)},s.eliminarManoDeObra=function(e){s.nuevoOt.ordenTrabajoManoObra.splice(s.nuevoOt.ordenTrabajoManoObra.indexOf(e),1)},s.eliminarManoDeObraVehiculo=function(e){s.vehiculo.manosDeObra.splice(s.vehiculo.manosDeObra.indexOf(e),1)},s.eliminarServicioExterno=function(e){s.nuevoOt.servicioExterno.splice(s.nuevoOt.ordenTrabajoManoObra.indexOf(e),1)},s.eliminarServicioExternoVehiculo=function(e){s.vehiculo.serviciosExternos.splice(s.vehiculo.serviciosExternos.indexOf(e),1)},s.saveFormNuevoOt=function(){var e=$("#siguiente").text().trim();console.log(s.paciente),"Siguiente"!=e&&(promesa=b(s.nuevoOt),promesa.then(function(e){s.cerrarOTnuevo(),s.mostrarMensaje(e.message),s.recargarItemsTabla()}))},s.GuardarOtActializado=function(){promesa=C(s.vehiculo),promesa.then(function(e){s.cerrarOTEdicionCorrectivo(),s.mostrarMensaje(e.message),s.recargarItemsTabla()})},s.editarManoObra=function(e,a){s.ordenTrabajoManoObra=e,s.ordenTrabajoManoObra.especialidad=e.especialidad,s.ordenTrabajoManoObra.fecha_inicio=moment(e.fecha_inicio).format("MM/DD/YYYY h:mm A"),s.ordenTrabajoManoObra.fecha_fin=moment(e.fecha_fin).format("MM/DD/YYYY h:mm A"),s.ordenTrabajoManoObra.edit=!0,s.ordenTrabajoManoObra.index=a,console.log(s.ordenTrabajoManoObra)},s.guardarManoObraEditada=function(e){s.nuevoOt.ordenTrabajoManoObra[e.index]=e,s.ordenTrabajoManoObra={edit:!1}},s.guardarManoObraEditadaVehiculo=function(e){s.vehiculo.manosDeObra[e.index]=e,s.vehiculo.manosDeObra[e.index].horas=24*s.diferenciaEntreDiasEnDias(new Date(s.vehiculo.manosDeObra[e.index].fecha_inicio),new Date(s.vehiculo.manosDeObra[e.index].fecha_fin)),s.ordenTrabajoManoObra={edit:!1}},s.editarServicioExterno=function(e,a){s.servicioExterno=e,s.servicioExterno.fecha_inicio=moment(s.servicioExterno.fecha_inicio).format("MM/DD/YYYY h:mm A"),s.servicioExterno.fecha_fin=moment(s.servicioExterno.fecha_fin).format("MM/DD/YYYY h:mm A"),s.servicioExterno.edit=!0,s.servicioExterno.index=a},s.guardarServicioExternoEditado=function(e){s.nuevoOt.servicioExterno[e.index]=e,s.servicioExterno={edit:!1}},s.obtenerFechasCalendario=function(){promesa=P(s.calendario),promesa.then(function(e){s.FechasCalendario=e,console.log(e)})},s.obtenerFechasCalendarioS=function(e){$("#calendar").fullCalendar("removeEvents"),promesa=P(e),promesa.then(function(e){s.FechasCalendario=e,console.log(e);var t=[];e.forEach(function(e,a,o){var i={id:e.id,title:e.observacion,start:e.fecha_hora_inicio,end:e.fecha_hora_fin};t.push(i),a===o.length-1&&s.cal(t)},this)})},s.EditEventoCalendario=function(){console.log(s.evento),s.calendar.fullCalendar("updateEvent",s.evento),s.cerrarEditarEventoCalendario()},s.DeleteEventoCalendario=function(){s.calendar.fullCalendar("removeEvents",function(e){return e._id==s.evento._id}),s.cerrarEditarEventoCalendario()},s.cal=function(e){s.calendar.fullCalendar("addEventSource",e)},s.GuardarEventoCalendario=function(e){e&&(s.calendar.fullCalendar("renderEvent",s.evento,!0),s.evento={title:null,start:null,end:null,allDay:null,className:"label-info"},s.cerrarEventoCalendario())},s.aplicarCalendario=function(){var e=new Date;e.getDate(),e.getMonth(),e.getFullYear();s.calendar=$("#calendar").fullCalendar({buttonHtml:{prev:'<i class="ace-icon fa fa-chevron-left"></i>',next:'<i class="ace-icon fa fa-chevron-right"></i>'},header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:[],editable:!0,droppable:!0,drop:function(e){var a=$(this).data("eventObject"),o=$(this).attr("data-class"),i=$.extend({},a);i.start=e,i.allDay=!1,o&&(i.className=[o]),s.calendar.fullCalendar("renderEvent",i,!0),$("#drop-remove").is(":checked")&&$(this).remove()},selectable:!0,selectHelper:!0,select:function(e,a,o){s.evento={title:"",start:e,end:a,allDay:o,className:"label-info"},s.abrirEventoCalendario(),s.calendar.fullCalendar("unselect")},eventClick:function(e,a,o){s.evento=e,s.abrirEditarEventoCalendario()}})},s.inicio()}]),angular.module("agil.controladores").controller("ControladorVentas",["$scope","$filter","$localStorage","$location","$templateCache","$route","blockUI","$timeout","$window","InventarioPaginador","Venta","Ventas","VentasProductos","detalle","detalleEmpresa","Clientes","ClientesNit","ProductosNombre","ClasesTipo","VentasContado","VentasCredito","PagosVenta","DatosVenta","VentaEmpresaDatos","ProductosPanel","ListaProductosEmpresaUsuario","ListaInventariosProducto","Paginator","socket","ConfiguracionVentaVistaDatos","ConfiguracionVentaVista","ListaGruposProductoEmpresa","ReporteVentasMensualesDatos","ConfiguracionImpresionEmpresaDato","VerificarUsuarioEmpresa","GuardarVentasImportados","ImprimirSalida","ModificarVenta","ListaVendedorVenta","VendedorVenta","VendedorVentaActualizacion","GuardarUsuarLectorDeBarra","VerificarLimiteCredito","ListaSucursalesUsuario","ListaGruposProductoUsuario","ListaServiciosVentas","GuardarListaServiciosVentas","EliminarVentaServicio","ventasDetalleEmpresa","EliminarDetalleVentaEdicion","filtroCotizacionesPendientes","CotizacionRechazo","ListaInventariosProductoVentaEdicion",function(E,a,s,e,o,i,v,t,n,c,l,p,d,r,u,m,f,g,h,b,C,P,_,M,D,x,S,A,T,w,I,R,j,O,F,V,N,H,B,z,L,k,U,y,G,q,Y,W,J,X,K,Z,Q){v.start(),E.usuario=JSON.parse(s.usuario),convertUrlToBase64Image(E.usuario.empresa.imagen,function(e){E.usuario.empresa.imagen=e});var ee=new Image;ee.onload=function(){E.usuario.altura_imagen=this.height/96},ee.src=E.usuario.empresa.imagen,E.idModalPago="dialog-pago",E.idModalCierre="dialog-cierre-caja",E.idModalWizardCompraEdicion="modal-wizard-venta-edicion",E.idModalWizardVentaVista="modal-wizard-venta-vista",E.idModalEliminarCompra="dialog-eliminar-venta",E.idModalContenedorCompraEdicion="modal-wizard-container-venta-edicion",E.idModalContenedorVentaVista="modal-wizard-container-venta-vista",E.idInputCompletar="nit",E.idModalPanelVentas="dialog-panel-ventas",E.idModalConfirmacionEliminacionVenta="dialog-eliminar-venta",E.idModalInventario="dialog-productos-venta",E.idModalPanelVentasCobro="dialog-panel-cobro",E.idModalEdicionVendedor="dialog-edicion-vendedor",E.idModalImpresionVencimiento="dialog-imprimir-con-fecha-vencimiento",E.IdModalVerificarCuenta="modal-verificar-cuenta",E.modalReportesProductos="dialog-reportes-productos",E.modelGraficaProductos="reporte-grafico-productos",E.modalServicioVenta="dialog-servicios-venta",E.modalReportesEmpresas="dialog-reporte-por-empresas",E.modelGraficaEmpresas="reporte-grafico-empresas",E.modelImportacionVentaServicio="dialog-importacion-ventas-servicios",E.idModalCotizaciones="dialog-cotizaciones-venta",E.idModalDetalleCotizaciones="dialog-detalle-cotizaciones",E.idModalDetalleCotizacionEditar="dialog-cotizacione-editar",E.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsVenta(E.idModalWizardCompraEdicion,E.idModalWizardVentaVista,E.idModalEliminarCompra,E.idModalContenedorCompraEdicion,E.idModalContenedorVentaVista,E.idInputCompletar,E.url,E.idModalPago,E.idModalCierre,E.idModalPanelVentas,E.idModalConfirmacionEliminacionVenta,E.idModalInventario,E.idModalPanelVentasCobro,E.idModalEdicionVendedor,E.idModalImpresionVencimiento,E.IdModalVerificarCuenta,E.modalReportesProductos,E.modalServicioVenta,E.modelGraficaProductos,E.modalReportesEmpresas,E.modelGraficaEmpresas,E.modelImportacionVentaServicio,E.idModalCotizaciones,E.idModalDetalleCotizaciones,E.idModalDetalleCotizacionEditar),E.buscarAplicacion(E.usuario.aplicacionesUsuario,e.path().substring(1)),v.stop()}),E.inicio=function(){E.ordenProductos=!0,E.esContado=!0,E.obtenerTiposDePago(),E.obtenerConfiguracionVentaVista(),E.sucursales=[],E.obtenerSucursales(),E.sucursalesUsuario="",E.obtenerFormatoFactura(),E.obtenerMovimientosEgreso(),E.obtenerVendedores(),E.detalleVenta={eliminado:!1,producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},E.estadoProducto=!1,E.estadoEmpresa=!1,E.dynamicPopoverPrecios={templateUrl:"preciosTemplate.html"}},E.obtenerConfiguracionVentaVista=function(){v.start(),w(E.usuario.id_empresa).then(function(e){E.configuracionVentaVista=e,v.stop()})},E.guardarConfiguracionVentaVista=function(){I.update({id_empresa:E.usuario.id_empresa},E.configuracionVentaVista,function(e){})},E.generarListaGruposSeleccionados=function(e,a){for(var o=0;o<e.length;o++)for(var i=0;i<a.length;i++)e[o].id==a[i].id&&(e[o].selected=a[i].selected);return e},E.verificarLimiteCredito=function(c){c.cliente&&c.tipoPago.nombre==E.diccionario.TIPO_PAGO_CREDITO?U(c).then(function(e){var t=e.ventas.slice(0),r=new Date,n=0,s={uno:"",dos:""};e.ventas.forEach(function(e,a,o){if((n+=e.saldo)>=c.cliente.linea_credito&&(s.uno="exedio el limite de la linea de credito"),a==o.length-1){var i=new Date(t.fecha);E.diferenciaEntreDiasEnDias(i,r)>c.cliente.plazo_credito&&(s.dos="exedio el limide de dias de credito"),1==c.cliente.bloquear_limite_credito?(E.mostrarMensaje(s.uno+" "+s.dos+" no puede realizar mas compras"),E.blockerVenta=!1):(E.mostrarMensaje(s.uno+" "+s.dos+", pero puede seguir consumiendo"),E.blockerVenta=!0)}})}):E.blockerVenta=!0},E.diferenciaEntreDiasEnDias=function(e,a){var o=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),i=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate());return Math.floor((i-o)/864e5)},E.obtenerGruposProductoEmpresa=function(){G(E.usuario.id_empresa,E.usuario.id).then(function(e){if(E.grupos_productos=e,angular.isDefined(s.grupos_productos))E.grupos_productos=E.generarListaGruposSeleccionados(E.grupos_productos,s.grupos_productos);else for(var a=0;a<e.length;a++)E.grupos_productos[a].selected=!0;E.listChecked=[],E.saveCheckList=function(){E.listChecked.splice(0,E.listChecked.length);for(var e=0;e<E.grupos_productos.length;e++)1==E.grupos_productos[e].selected&&E.listChecked.push(E.grupos_productos[e]);s.grupos_productos=E.grupos_productos},E.saveCheckList(),E.allChecked=!1,E.checkedUnchecked=function(){for(var e=0;e<E.grupos_productos.length;e++)E.grupos_productos[e].selected=E.allChecked;E.saveCheckList()}})},E.obtenerTiposDePago=function(){v.start(),h("TIPA").then(function(e){E.tiposPago=e.clases,v.stop()})},E.abrirPopuEdicionVendedor=function(){E.vendedor=new z({id_empresa:E.usuario.id_empresa}),E.abrirPopup(E.idModalEdicionVendedor)},E.cerrarPopupEdicionVendedor=function(){E.cerrarPopup(E.idModalEdicionVendedor)},E.guardarVendedor=function(e){E.cerrarPopup(E.idModalEdicionVendedor),e.id?L.update({id_vendedor:e.id},e,function(e){E.mostrarMensaje(e.mensaje),E.obtenerVendedores()}):e.$save(function(e){E.mostrarMensaje("Vendedor registrado satisfactoriamente!"),E.obtenerVendedores()})},E.obtenerVendedores=function(){v.start(),B(E.usuario.id_empresa).then(function(e){E.vendedores=e,v.stop()})},E.obtenerMovimientosEgreso=function(){v.start(),h("MOVEGR").then(function(e){E.movimientosEgreso=e.clases,v.stop()})},E.obtenerTipoEgreso=function(e){var a=e.nombre_corto;E.tipoEgreso=a,E.venta.sucursal&&E.obtenerActividades(E.venta.sucursal.id)},E.buscarCliente=function(e){if(""!=e&&null!=e)return f(E.usuario.id_empresa,e)},E.obtenerClientes=function(){m(E.usuario.id_empresa).then(function(e){for(var a=0;a<e.length;a++)e[a].nit=e[a].nit.toString();E.clientes=e})},E.buscarProductoLectorBarra=function(e){if(v.start(),""!=e&&null!=e){var a=x(E.usuario.id_empresa,e,E.usuario.id,E.venta.almacen.id);return a.then(function(e){1==e.length&&E.establecerProducto(e[0]),v.stop()},function(e){E.mostrarMensaje(e.message),v.stop()}),v.stop(),a}},E.buscarProducto=function(e){if(v.start(),""!=e&&null!=e){var a=x(E.usuario.id_empresa,e,E.usuario.id,E.venta.almacen.id);return v.stop(),a}},E.establecerProductoEdicionVenta=function(t){t.tipoProducto=null==t.tipoProducto?{id:t["tipoProducto.id"],nombre:t["tipoProducto.nombre"],nombre_corto:t["tipoProducto.nombre_corto"]}:t.tipoProducto,E.editar_precio=!1;var e=new Date(E.convertirFecha(E.venta.fechaTexto));Q(t.id,E.venta.almacen.id,e).then(function(e){t.inventarios=e;for(var a=0;a<t.inventarios.length;a++)t.inventarios[a].fecha_vencimiento=t.inventarios[a].fecha_vencimiento?new Date(t.inventarios[a].fecha_vencimiento):null,t.inventarios[a].fechaVencimientoTexto=t.inventarios[a].fecha_vencimiento?t.inventarios[a].fecha_vencimiento.getDate()+"/"+(t.inventarios[a].fecha_vencimiento.getMonth()+1)+"/"+t.inventarios[a].fecha_vencimiento.getFullYear():"",t.inventarios[a].detallesMovimiento[0].movimiento.fecha=new Date(t.inventarios[a].detallesMovimiento[0].movimiento.fecha),t.inventarios[a].detallesMovimiento[0].movimiento.fechaTexto=t.inventarios[a].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(t.inventarios[a].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+t.inventarios[a].detallesMovimiento[0].movimiento.fecha.getFullYear();E.inventariosDisponibleProducto=[],E.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),E.inventariosDisponibleProducto=E.inventariosDisponibleProducto.concat(t.inventarios);var o=E.obtenerInventarioTotal(t);if(E.detalleVenta={eliminado:!1,producto:t,precio_unitario:t.precio_unitario,inventarioProducto:E.inventariosDisponibleProducto[0],inventario_disponible:o,costos:t.activar_inventario?t.inventarios:[],cantidad:1,descuento:t.descuento,recargo:0,ice:0,excento:0,tipo_descuento:0<t.descuento,tipo_recargo:!1},E.precio_inventario,0<t.inventarios.length){var i=t.inventarios.find(function(e){var a=e;return a.id<=e.id&&(a=e),e});E.precio_inventario=i.costo_unitario+" Bs"}else E.precio_inventario="Sin histórico";E.inventarioProducto=t.activar_inventario?t.inventarios:[],E.colorearInventarioDisponible(o,t),document.getElementById("cantidad").focus(),E.calcularImporte(),E.cerrarPopup(E.idModalInventario)})},E.establecerProducto=function(r){r.tipoProducto=null==r.tipoProducto?{id:r["tipoProducto.id"],nombre:r["tipoProducto.nombre"],nombre_corto:r["tipoProducto.nombre_corto"]}:r.tipoProducto,E.editar_precio=!1,S(r.id,E.venta.almacen.id).then(function(e){r.inventarios=e;for(var a=0;a<r.inventarios.length;a++)r.inventarios[a].fecha_vencimiento=r.inventarios[a].fecha_vencimiento?new Date(r.inventarios[a].fecha_vencimiento):null,r.inventarios[a].fechaVencimientoTexto=r.inventarios[a].fecha_vencimiento?r.inventarios[a].fecha_vencimiento.getDate()+"/"+(r.inventarios[a].fecha_vencimiento.getMonth()+1)+"/"+r.inventarios[a].fecha_vencimiento.getFullYear():"",r.inventarios[a].detallesMovimiento[0].movimiento.fecha=new Date(r.inventarios[a].detallesMovimiento[0].movimiento.fecha),r.inventarios[a].detallesMovimiento[0].movimiento.fechaTexto=r.inventarios[a].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(r.inventarios[a].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+r.inventarios[a].detallesMovimiento[0].movimiento.fecha.getFullYear();E.inventariosDisponibleProducto=[];var o=0;E.TipoPrecioProducto={},E.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),E.inventariosDisponibleProducto=E.inventariosDisponibleProducto.concat(r.inventarios);var i=E.obtenerInventarioTotal(r);if(E.venta.cliente.id&&E.venta.cliente.tipoPrecioVenta&&E.usuario.empresa.usar_tipo_precio&&0<r.tiposPrecio.length?r.tiposPrecio.forEach(function(e){e.id_tipo_precio==E.venta.cliente.tipoPrecioVenta.id?(o=e.precio_unitario,E.tipoPrecioProducto=e):o=r.precio_unitario}):o=r.precio_unitario,E.detalleVenta={eliminado:!1,producto:r,precio_unitario:o,inventarioProducto:E.inventariosDisponibleProducto[0],inventario_disponible:i,costos:r.activar_inventario?r.inventarios:[],cantidad:1,descuento:r.descuento,recargo:0,ice:0,excento:0,tipo_descuento:0<r.descuento,tipo_recargo:!1},E.precio_inventario,0<r.inventarios.length){var t=r.inventarios.find(function(e){var a=e;return a.id<=e.id&&(a=e),e});E.precio_inventario=t.costo_unitario+" Bs"}else E.precio_inventario="Sin histórico";E.inventarioProducto=r.activar_inventario?r.inventarios:[],E.colorearInventarioDisponible(i,r),document.getElementById("cantidad").focus(),E.calcularImporte(),E.cerrarPopup(E.idModalInventario)})},E.colorearInventarioDisponible=function(e,a){0==e?(E.porcentaje="100",E.color="red"):e>3*a.inventario_minimo+1?(E.porcentaje="100",E.color="green"):e>2*a.inventario_minimo+1?(E.porcentaje="75",E.color="green"):e>1.5*a.inventario_minimo+1?(E.porcentaje="50",E.color="green"):e==a.inventario_minimo+1?(E.porcentaje="38",E.color="yellow"):e==a.inventario_minimo?(E.porcentaje="25",E.color="red"):e<a.inventario_minimo&&0<e&&(E.porcentaje="12",E.color="red")},E.actualizarInventarioDisponibleFechaVencimiento=function(e){0!=e.inventarioProducto.id?(e.costos=[],e.costos.push(e.inventarioProducto),e.inventario_disponible=E.obtenerInventarioTotalPorFechaVencimiento(e),e.lote=e.inventarioProducto.lote):(e.inventario_disponible=E.obtenerInventarioTotal(e.producto),e.costos=e.producto.inventarios,e.lote=""),E.colorearInventarioDisponible(e.inventario_disponible,e.producto),E.calcularImporte()},E.establecerCliente=function(e){E.venta.cliente=e,E.enfocar("razon_social"),E.capturarInteraccion()},E.eliminarVendedor=function(e){E.cerrarConfirmacionEliminacion(),new L(e).$delete(function(e){E.mostrarMensaje(e.mensaje),E.obtenerVendedores()},function(e){E.mostrarMensaje("Ocurrio un problema al eliminar!")})},E.modificarVendedor=function(e){E.vendedor=e,E.abrirPopup(E.idModalEdicionVendedor)},E.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario){for(var o=0;o<e.inventarios.length;o++)a+=e.inventarios[o].cantidad;for(var i=0;i<E.venta.detallesVenta.length;i++)if(E.venta.detallesVenta[i].producto.tipoProducto.nombre_corto==E.diccionario.TIPO_PRODUCTO_FINAL||E.venta.detallesVenta[i].producto.tipoProducto.nombre_corto==E.diccionario.TIPO_PRODUCTO_INTER)for(var t=0;t<E.venta.detallesVenta[i].producto.productosBase.length;t++){var r=E.venta.detallesVenta[i].producto.productosBase[t];if(r.productoBase.tipoProducto.nombre_corto==E.diccionario.TIPO_PRODUCTO_INTER)for(var n=0;n<r.productoBase.productosBase.length;n++){var s=r.productoBase.productosBase[n];s.productoBase.id!=e.id||E.venta.detallesVenta[i].id||(a-=parseInt(s.formulacion))}else r.productoBase.id!=e.id||E.venta.detallesVenta[i].id||(a-=parseInt(r.formulacion))}else E.venta.detallesVenta[i].producto.id!=e.id||E.venta.detallesVenta[i].id||(a-=E.venta.detallesVenta[i].cantidad)}else a=5e5;return a},E.obtenerInventarioTotalPorFechaVencimiento=function(e){if(E.usuario.empresa.usar_peps){for(var a=e.inventarioProducto.cantidad,o=0;o<E.venta.detallesVenta.length;o++)E.venta.detallesVenta[o].producto.id!=e.producto.id||E.venta.detallesVenta[o].costos[0].id!=e.inventarioProducto.id||E.venta.detallesVenta[o].id||(a-=E.venta.detallesVenta[o].cantidad);return a}for(a=e.inventario_disponible,o=0;o<E.venta.detallesVenta.length;o++)E.venta.detallesVenta[o].producto.id==e.producto.id&&E.venta.detallesVenta[o].costos[0].id==e.inventarioProducto.id&&(a-=E.venta.detallesVenta[o].cantidad);return a},E.agregarDetalleVentaServicio=function(e){e.servicio.id&&e.importe&&(E.calcularImporteServicio(),E.venta.detallesVenta.push(e),E.inventariosDisponibleProducto=[],E.sumarTotal(),E.sumarTotalImporte(),E.calcularSaldo(),E.calcularCambio(),E.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},E.enfocar("id_servicio"))},E.calcularImporteServicio=function(){E.detalleVenta.total=Math.round(1e3*(E.detalleVenta.importe-E.detalleVenta.descuento+E.detalleVenta.recargo-E.detalleVenta.ice-E.detalleVenta.excento))/1e3},E.agregarDetalleVenta=function(e){if(e.producto.id){if(e.producto.activar_inventario)if(E.usuario.empresa.usar_peps)if(1<e.costos.length)for(var a=e.cantidad,o=0,i=JSON.parse(JSON.stringify(e));o<e.costos.length&&0<a;){if(e.inventarioProducto=e.costos[o],0<(r=E.obtenerInventarioTotalPorFechaVencimiento(e))){var t=JSON.parse(JSON.stringify(i));r<a?a-=n=r:(n=a,a=0),(E.detalleVenta=t).cantidad=n,E.usuario.empresa.usar_vencimientos&&(t.fecha_vencimiento=e.costos[o].fecha_vencimiento,t.lote=e.costos[o].lote),t.costos=[],t.costos.push(e.costos[o]),t.inventario=e.costos[o],E.calcularImporte(),E.venta.detallesVenta.push(t)}o++}else 0<e.costos.length&&E.usuario.empresa.usar_vencimientos&&(e.fecha_vencimiento=e.costos[0].fecha_vencimiento,e.lote=e.costos[0].lote,e.inventario=e.costos[0]),E.venta.detallesVenta.push(e);else{var r;a=e.cantidad,o=0,i=JSON.parse(JSON.stringify(e));if(e.inventarioProducto=e.costos[o],0<(r=E.obtenerInventarioTotalPorFechaVencimiento(e))){var n;t=JSON.parse(JSON.stringify(i));r<a?a-=n=r:(n=a,a=0),(E.detalleVenta=t).cantidad=n,E.usuario.empresa.usar_vencimientos&&(t.fecha_vencimiento=e.costos[o].fecha_vencimiento,t.lote=e.costos[o].lote),t.costos=[],t.costos.push(e.costos[o]),t.inventario=e.costos[o],E.calcularImporte(),E.venta.detallesVenta.push(t)}}else E.venta.detallesVenta.push(e);E.inventariosDisponibleProducto=[],E.sumarTotal(),E.sumarTotalImporte(),E.calcularSaldo(),E.calcularCambio(),E.precio_inventario="Sin histórico",E.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},E.enfocar("id_producto")}},E.enfocar=function(e){t(function(){$("#"+e).focus()},0)},E.interceptarTecla=function(e,a,o){13===e.which&&(o?E.enfocar(a):t(function(){$("#"+a).trigger("click")},0))},E.eliminarDetalleVenta=function(e){e.id?e.eliminado=!0:E.venta.detallesVenta.splice(E.venta.detallesVenta.indexOf(e),1),E.sumarTotal(),E.sumarTotalImporte(),E.calcularSaldo(),E.calcularCambio(),E.capturarInteraccion()},E.eliminarDetalleVentaEdicion=function(a){a.id?(E.CancelacionVentaEdicion=!0,X(a,E.venta.movimientoActual.id,E.venta).then(function(e){1==e.hasError||(E.venta.detallesVenta.splice(E.venta.detallesVenta.indexOf(a),1),E.sumarTotal(),E.sumarTotalImporte(),E.calcularSaldo(),E.calcularCambio(),E.capturarInteraccion()),E.mostrarMensaje(e.mensaje)})):(E.venta.detallesVenta.splice(E.venta.detallesVenta.indexOf(a),1),E.sumarTotal(),E.sumarTotalImporte(),E.calcularSaldo(),E.calcularCambio(),E.capturarInteraccion())},E.eliminarDetalleVentaPanel=function(e){var a=E.productosProcesados.indexOf(e.producto);E.productosProcesados[a].inventario_disponible=E.productosProcesados[a].inventario_disponible+e.cantidad,E.venta.detallesVenta.splice(E.venta.detallesVenta.indexOf(e),1),E.sumarTotal(),E.sumarTotalImporte(),E.calcularSaldo(),E.calcularCambio(),E.capturarInteraccion()},E.cambiarTipoPago=function(e){if(e.tipoPago){var a=e.tipoPago,o=$.grep(E.tiposPago,function(e){return e.id==a.id})[0];E.esContado="CONT"==o.nombre_corto,E.calcularCambio(),1==e.cliente.usar_limite_credito&&E.verificarLimiteCredito(e)}},E.recalcular=function(){E.calcularImporte()},E.calcularImporte=function(){var e,a;E.detalleVenta.importe=Math.round(E.detalleVenta.cantidad*E.detalleVenta.precio_unitario*1e3)/1e3,e=E.detalleVenta.tipo_descuento?E.detalleVenta.importe*(E.detalleVenta.descuento/100):E.detalleVenta.descuento,a=E.detalleVenta.tipo_recargo?E.detalleVenta.importe*(E.detalleVenta.recargo/100):E.detalleVenta.recargo,E.detalleVenta.total=Math.round(1e3*(E.detalleVenta.importe-e+a-E.detalleVenta.ice-E.detalleVenta.excento))/1e3},E.sumarTotalImporte=function(){for(var e=0,a=0;a<E.venta.detallesVenta.length;a++)E.venta.detallesVenta[a].eliminado||(e+=E.venta.detallesVenta[a].importe);E.venta.importe=Math.round(1e3*e)/1e3},E.sumarTotal=function(){for(var e=0,a=0;a<E.venta.detallesVenta.length;a++)E.venta.detallesVenta[a].eliminado||(e+=E.venta.detallesVenta[a].total);E.venta.total=Math.round(1e3*e)/1e3,E.venta.pagado=E.venta.total},E.calcularSaldo=function(){E.venta.saldo=E.venta.total-E.venta.a_cuenta},E.obtenerSucursales=function(){y(E.usuario.id).then(function(e){e.sucursales.map(function(e){E.sucursales.push(e.sucursal)}),E.usuario.sucursalesUsuario=e.sucursales;for(var a=0;a<E.usuario.sucursalesUsuario.length;a++)E.sucursalesUsuario=E.sucursalesUsuario+E.usuario.sucursalesUsuario[a].sucursal.id,a+1!=E.usuario.sucursalesUsuario.length&&(E.sucursalesUsuario=E.sucursalesUsuario+",")})},E.obtenerAlmacenesSucursalesDiferente=function(e){E.obtenerAlmacenes(e),E.obtenerSucursalesDiferente(e)},E.obtenerAlmacenesDiferente=function(a){E.almacenesDiferente=[];var e=$.grep(E.sucursales,function(e){return e.id==a})[0];E.almacenesDiferente=e.almacenes,E.venta.almacenDestino=1==E.almacenesDiferente.length?E.almacenesDiferente[0]:null},E.obtenerSucursalesDiferente=function(a){E.sucursalesDiferente=$.grep(E.sucursales,function(e){return e.id!=a}),E.almacenesDiferente=E.sucursalesDiferente.almacenes},E.obtenerAlmacenesActividades=function(e){E.obtenerAlmacenes(e),E.obtenerActividades(e)},E.obtenerAlmacenes=function(a){E.almacenes=[];var e=$.grep(E.sucursales,function(e){return e.id==a})[0];E.almacenes=e.almacenes,E.venta.editar||(E.venta.almacen=1==E.almacenes.length?E.almacenes[0]:null,E.venta.almacen&&E.cargarProductos())},E.obtenerActividades=function(a){E.actividades=[];var e=$.grep(E.sucursales,function(e){return e.id==a})[0];E.actividadesDosificaciones=e.actividadesDosificaciones,E.actividades=[];for(var o=0;o<E.actividadesDosificaciones.length;o++)E.actividadesDosificaciones[o].dosificacion&&(E.venta.movimiento&&"SERV"==E.venta.movimiento.nombre_corto?E.actividadesDosificaciones[o].expirado||E.actividadesDosificaciones[o].dosificacion.expirado||1!=E.actividadesDosificaciones[o].dosificacion.tipo_dosificacion?E.dosificacionesExpiradas=!0:E.actividades.push(E.actividadesDosificaciones[o].actividad):E.actividadesDosificaciones[o].expirado||E.actividadesDosificaciones[o].dosificacion.expirado||0!=E.actividadesDosificaciones[o].dosificacion.tipo_dosificacion?E.dosificacionesExpiradas=!0:E.actividades.push(E.actividadesDosificaciones[o].actividad));E.venta.id||(E.venta.actividad=1==E.actividades.length?E.actividades[0]:null)},E.obtenerVentas=function(){var e=new Date,a=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear();E.filtrarVentas(E.sucursalesUsuario,a,a)},E.filtrarVentas=function(e,a,o,i,t,r,n,s,c,l,d,u){i=""==i||null==i?0:i,d=""==d||null==d?0:d,t=null==t||null==t?0:t,r=null==r||null==r?0:r,n=null==n?0:n,s=null==s||null==s?0:s,c=null==c||null==c?0:c,l=0<$.grep(E.usuario.rolesUsuario,function(e){return e.rol.nombre==E.diccionario.ROL_ADMINISTRADOR}).length?""==l||null==l?0:l:E.usuario.nombre_usuario,u=!u&&u,v.start(),E.razon_sociald=i,E.nitd=t,E.montod=r,E.usuariod=l,0!=c&&(E.transacciond=0<$.grep(E.movimientosEgreso,function(e){return e.id==c}).length?$.grep(E.movimientosEgreso,function(e){return e.id==c})[0].nombre:"todos"),0!=s&&(E.sucursald=0<$.grep(E.sucursales,function(e){return e.id==s}).length?$.grep(E.sucursales,function(e){return e.id==s})[0].nombre:"todos"),0!=n&&(E.tipoPagod=0<$.grep(E.tiposPago,function(e){return e.id==n}).length?$.grep(E.tiposPago,function(e){return e.id==n})[0].nombre:"todos"),a=new Date(E.convertirFecha(a)),o=new Date(E.convertirFecha(o)),p(e,a,o,i,t,r,n,s,c,l,d).then(function(e){E.ventas=e,v.stop()})},E.abrirPopupPago=function(e){E.venta=e,E.pago=null,E.abrirPopup(E.idModalPago)},E.cerrarPopupPago=function(){E.cerrarPopup(E.idModalPago)},E.efectuarPago=function(a){v.start(),M.update({id:E.venta.id,id_empresa:E.usuario.id_empresa},{pago:a,id_usuario_cajero:E.usuario.id},function(e){E.mostrarMensaje(e.mensaje),E.cerrarPopup(E.idModalPago),E.obtenerVentas(),E.imprimirRecibo(e,e.venta,a),v.stop()},function(e){E.mostrarMensaje(e),E.cerrarPopup(E.idModalPago),E.obtenerVentas(),v.stop()})},E.imprimirRecibo=function(e,a,o){v.start();var i=new PDFDocument({compress:!1,size:[227,353],margin:10}),t=i.pipe(blobStream());i.moveDown(2),i.font("Helvetica-Bold",8),i.text(E.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),i.moveDown(.4),i.font("Helvetica",7),i.text(a.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),i.moveDown(.4),i.text(a.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),i.moveDown(.4);var r=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");i.text("TELF.: "+r,{align:"center"}),i.moveDown(.4),i.text("COCHABAMBA - BOLIVIA",{align:"center"}),i.moveDown(.5),i.font("Helvetica-Bold",8),i.text("RECIBO",{align:"center"}),i.font("Helvetica",7),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.text(a.almacen.sucursal.nota_recibo_correlativo,{align:"center"}),i.moveDown(.4),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.moveDown(.6);var n=new Date;i.text("FECHA : "+n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear(),{align:"left"}),i.moveDown(.4),i.text("He recibido de : "+E.venta.cliente.razon_social,{align:"left"}),i.moveDown(.4),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.2),i.text("       CONCEPTO                                   ",{align:"left"}),i.moveDown(.2),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.4),a.fecha=new Date(a.fecha),i.text("Fecha: "+a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear(),15,210);var s=E.venta.movimiento.clase.nombre_corto==E.diccionario.EGRE_FACTURACION?"Factura nro. "+E.venta.factura:"Proforma nro. "+E.venta.factura;i.text(s,105,210,{width:100}),i.text("Saldo Bs "+(a.saldo-o)+".-",105,220,{width:100}),i.text("Bs "+o+".-",170,210,{width:100}),i.text("--------------",10,230,{align:"right"}),i.moveDown(.3),i.text("TOTAL Bs.              "+o.toFixed(2),{align:"right"}),i.moveDown(.4),i.moveDown(.4),i.text("SON: "+e.pago,{align:"left"}),i.moveDown(.6),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.text("-------------------------                       -------------------------",{align:"center"}),i.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),v.stop()},E.abrirPopupCierre=function(){E.cierre={},E.abrirPopup(E.idModalCierre)},E.cerrarPopupCierre=function(){E.cerrarPopup(E.idModalCierre)},E.cerrarCaja=function(i){v.start(),inicio=new Date,fin=new Date;var e=b(E.sucursalesUsuario,inicio,fin,E.usuario.id);e.then(function(o){(e=C(E.sucursalesUsuario,inicio,fin,E.usuario.id)).then(function(a){(e=P(E.sucursalesUsuario,inicio,fin,E.usuario.id)).then(function(e){E.generarReporteCierreCaja(i,o,a,e),E.cerrarPopupCierre()})})})},E.generarReporteCierreCaja=function(i,t,r,n){O(E.usuario.id_empresa,0).then(function(e){var a=[612,792];if(e.usar){if(e.tamanoPapelCierreCaja.nombre_corto==E.diccionario.FACT_PAPEL_OFICIO)a=[612,936],E.imprimirReporteCierreCajaCartaOficio(a,i,t,r,n);else if(e.tamanoPapelCierreCaja.nombre_corto==E.diccionario.FACT_PAPEL_CARTA)a=[612,792],E.imprimirReporteCierreCajaCartaOficio(a,i,t,r,n);else if(e.tamanoPapelCierreCaja.nombre_corto==E.diccionario.FACT_PAPEL_MEDIOOFICIO)a=[612,468],E.imprimirReporteCierreCajaCartaOficio(a,i,t,r,n);else if(e.tamanoPapelCierreCaja.nombre_corto==E.diccionario.FACT_PAPEL_ROLLO){var o;a=[227,(o=t.length+r.length+n.length)<=2?310:310+20*(o-2)],E.imprimirReporteCierreCajaRollo(a,i,t,r,n)}}else a=[227,(o=t.length+r.length+n.length)<=2?310:310+20*(o-2)],E.imprimirReporteCierreCajaRollo(a,i,t,r,n)})},E.trueDetalle=!0,E.verDetalle=function(){E.trueDetalle?E.trueDetalle=!1:E.trueDetalle=!0},E.imprimirFiltroCajaCartaOficio=function(e,a,o){var i=new PDFDocument({compress:!1,size:[612,792],margin:0}),t=i.pipe(blobStream()),r=20;if(E.trueDetalle){for(var n=2*e.length,s=0;s<e.length;s++)n+=e[s].detallesVenta.length;var c=Math.ceil(n/r)}else r=20,c=Math.ceil(e.length/r);var l=100,d=0,u=1;E.imprimirCabeceraFiltroCajaCartaOficio(i,1,c,e,a,o),i.font("Helvetica",7);for(s=0;s<e.length;s++)if(i.font("Helvetica",7),i.rect(50,l+9,520,0).stroke(),i.text(s+1,55,l+20),i.font("Helvetica",6),i.text(e[s].movimiento?e[s].movimiento.clase.nombre:e[s].movimientoServicio.nombre,65,l+20),i.text(e[s].almacen?e[s].almacen.sucursal.nombre:e[s].sucursal.nombre,120,l+20,{width:60}),e[s].cliente?(i.font("Helvetica",6),i.text(e[s].cliente.razon_social,170,l+15,{width:75}),i.font("Helvetica",7),i.text(e[s].cliente.nit,245,l+20)):(i.text("",205,l+16,{width:75}),i.text("",265,l+20)),i.text(e[s].factura,305,l+20),e[s].fecha=new Date(e[s].fecha),i.text(e[s].fecha.getDate()+"/"+(e[s].fecha.getMonth()+1)+"/"+e[s].fecha.getFullYear(),345,l+20),i.text(e[s].fecha.getHours()+":"+e[s].fecha.getMinutes()+" - ",385,l+13,{width:28}),i.text(e[s].fecha.getDate()+"/"+(e[s].fecha.getMonth()+1)+"/"+e[s].fecha.getFullYear(),385,l+21,{width:32}),i.text(e[s].total,425,l+20),e[s].tipoPago?(i.text(e[s].tipoPago.nombre,455,l+20),e[s].tipoPago.nombre==E.diccionario.TIPO_PAGO_CREDITO&&(i.font("Helvetica",6),i.text("Plazo: "+e[s].dias_credito+" A cuenta: Bs "+e[s].a_cuenta+" Saldo: Bs "+e[s].saldo,510,l+16,{width:55}))):(i.text("",455,l+20),i.text("",520,l+16,{width:65})),E.trueDetalle){i.rect(50,l+34,520,0).stroke(),i.font("Helvetica",7),l+=50,i.text("N°",105,l),i.text("Nombre",115,l),i.text("Codigo Item",170,l),i.text("Unidad de Med",230,l),i.text("Cantidad",295,l),i.text("Importe",355,l),d++;for(var p=0;p<e[s].detallesVenta.length;p++)if(i.font("Helvetica",7),i.text(p+1,105,l+20),i.text(e[s].detallesVenta[p].producto?e[s].detallesVenta[p].producto.nombre:e[s].detallesVenta[p].servicio.nombre,115,l+20,{width:55}),i.text(e[s].detallesVenta[p].producto?e[s].detallesVenta[p].producto.id:"0",170,l+20),i.text(e[s].detallesVenta[p].producto?e[s].detallesVenta[p].producto.unidad_medida:"0",230,l+20),i.text(e[s].detallesVenta[p].producto?e[s].detallesVenta[p].cantidad:"0",295,l+20),i.text(e[s].detallesVenta[p].importe,355,l+20),l+=24,r-1<++d+1){l+=10,i.text(u+" de "+c,520,705);var m=new Date;i.text("FECHA : "+m.getDate()+"/"+(m.getMonth()+1)+"/"+m.getFullYear()+"   Hr:"+m.getHours()+":"+m.getMinutes(),55,705),i.text("USUARIO: "+E.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),l=100,d=0,u+=1,E.imprimirCabeceraFiltroCajaCartaOficio(i,1,c,e,a,o)}if(i.font("Helvetica",7),l+=4,r<++d){l+=10,i.text(u+" de "+c,520,705);m=new Date;i.text("FECHA : "+m.getDate()+"/"+(m.getMonth()+1)+"/"+m.getFullYear()+"   Hr:"+m.getHours()+":"+m.getMinutes(),55,705),i.text("USUARIO: "+E.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),l=100,d=0,u+=1,E.imprimirCabeceraFiltroCajaCartaOficio(i,1,c,e,a,o)}}else if(i.font("Helvetica",7),l+=30,++d==r){i.text(u+" de "+c,520,705);m=new Date;i.text("FECHA : "+m.getDate()+"/"+(m.getMonth()+1)+"/"+m.getFullYear()+"   Hr:"+m.getHours()+":"+m.getMinutes(),55,705),i.text("USUARIO: "+E.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),l=100,d=0,u+=1,E.imprimirCabeceraFiltroCajaCartaOficio(i,1,c,e,a,o)}i.font("Helvetica",7),i.text(u+" de "+c,520,705);m=new Date;i.text("FECHA : "+m.getDate()+"/"+(m.getMonth()+1)+"/"+m.getFullYear()+"   Hr:"+m.getHours()+":"+m.getMinutes(),55,705),i.text("USUARIO: "+E.usuario.nombre_usuario,150,705),i.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),v.stop()},E.imprimirCabeceraFiltroCajaCartaOficio=function(e,a,o,i,t,r){e.font("Helvetica-Bold",16),e.text("REPORTE",0,40,{align:"center"}),e.font("Helvetica-Bold",8),e.rect(50,80,520,620).stroke(),e.text("Desde: "+t+" Hasta: "+r,0,55,{align:"center"});var n=[E.razon_sociald,E.nitd,E.montod,E.usuariod,E.transacciond,E.sucursald,E.tipoPagod],s=0,c="";e.text("Filtro: ",55,65);for(var l=0;l<n.length;l++)0!=n[l]&&null!=n[l]?(c=c+n[l]+", ",65):7==(s+=1)&&e.text("GENERAL",85,65);e.text(c,85,65),e.font("Helvetica-Bold",7),e.font("Helvetica-Bold",8),e.text("N°",55,90),e.text("Transaccion",65,90),e.text("Sucursal",120,90,{width:43}),e.text("Razon Social",170,90),e.text("Nit Cliente",245,90,{width:43}),e.text("Fac.",305,90),e.text("Fecha-Fact.",345,86,{width:43}),e.text("Hora-Fecha",385,86,{width:43}),e.text("Monto",420,90),e.text("Tipo de Pago",455,90),e.text("Pago",520,90)},E.imprimirFiltroExcelCajaCartaOficio=function(e){v.start();for(var a=[["N°","Tipo de Transaccion","Sucursal","Razon Social","N° DE LA FACTURA","Nit Cliente","Fac.","Fecha-Fact.","Hora-Fecha","Monto","Tipo de Pago","Pago","Sucursal dest"]],o=0;o<e.length;o++)e[o].fecha=new Date(e[o].fecha);e.sort(function(e,a){return e.fecha>a.fecha?1:e.fecha<a.fecha?-1:0});for(o=0;o<e.length;o++){var i=[];if(i.push(o+1),i.push(e[o].movimiento?e[o].movimiento.clase.nombre:e[o].movimientoServicio.nombre),i.push(e[o].almacen?e[o].almacen.sucursal.nombre:e[o].sucursal.nombre),e[o].cliente?(i.push(e[o].cliente.razon_social),i.push(e[o].factura),i.push(e[o].cliente.nit)):(i.push(""),i.push(e[o].factura),i.push("")),i.push(e[o].factura),i.push(e[o].fecha),i.push(e[o].fecha),i.push(e[o].total),e[o].tipoPago?(i.push(e[o].tipoPago.nombre),e[o].tipoPago.nombre==E.diccionario.TIPO_PAGO_CREDITO&&i.push("Plazo: "+e[o].dias_credito+" A cuenta: Bs "+e[o].a_cuenta+" Saldo: Bs "+e[o].saldo)):i.push(""),e[o].movimiento&&"TRASPASO"==e[o].movimiento.clase.nombre&&(i.push(""),i.push(e[o].almacenTraspaso.sucursal.nombre)),a.push(i),E.trueDetalle){a.push(["","","","","N°","Nombre","Codigo Item","Unidad de Med","Cantidad","Importe","lote"]);for(var t=0;t<e[o].detallesVenta.length;t++)(i=[]).push(""),i.push(""),i.push(""),i.push(""),i.push(t+1),i.push(e[o].detallesVenta[t].producto?e[o].detallesVenta[t].producto.nombre:e[o].detallesVenta[t].servicio?e[o].detallesVenta[t].servicio.nombre:"ERROR SIN NOMBRE"),i.push(e[o].detallesVenta[t].producto?e[o].detallesVenta[t].producto.codigo:e[o].detallesVenta[t].servicio?"0":"ERROR SIN NOMBRE"),i.push(e[o].detallesVenta[t].producto?e[o].detallesVenta[t].producto.unidad_medida:e[o].detallesVenta[t].servicio?"0":"ERROR SIN NOMBRE"),i.push(e[o].detallesVenta[t].producto?e[o].detallesVenta[t].cantidad:e[o].detallesVenta[t].servicio?"0":"ERROR SIN NOMBRE"),i.push(e[o].detallesVenta[t].producto?e[o].detallesVenta[t].importe:"ERROR SIN NOMBRE"),i.push(e[o].detallesVenta[t].producto?e[o].detallesVenta[t].lote:e[o].detallesVenta[t].servicio?"0":"ERROR SIN NOMBRE"),a.push(i)}o+1==e.length&&((i=[]).push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push("TOTALES"),a.push(i))}var r=new Workbook,n=sheet_from_array_of_arrays(a);r.SheetNames.push("SheetJS"),r.Sheets.SheetJS=n;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"Reporte-ventas.xlsx"),v.stop()},E.imprimirReporteCierreCajaCartaOficio=function(e,a,o,i,t){var r=new PDFDocument({compress:!1,size:e,margin:0}),n=r.pipe(blobStream());r.font("Helvetica-Bold",15),r.text("CIERRE DE CAJA",55,50),r.font("Helvetica-Bold",8),r.text("SALDO INICIAL: ",55,80),r.text(a.saldo_inicial,350,80),r.font("Helvetica-Bold",8),r.text("VENTAS AL CONTADO: ",55,100),r.font("Helvetica",8);for(var s=100,c=0,l=0,d=0;d<o.length;d++)r.text("No. "+o[d].factura,55,s+20),r.text(o[d].cliente.razon_social,100,s+20),r.text(o[d].total,300,s+20),c+=o[d].total,s+=20;r.font("Helvetica-Bold",8),r.text(c,350,100),r.font("Helvetica-Bold",8),r.text("VENTAS AL CREDITO: ",55,s+20),r.font("Helvetica",8);var u=s+20;s+=20;var p=0;for(d=0;d<i.length;d++)0<i[d].pagosVenta.length?0<i[d].pagosVenta[0].a_cuenta_anterior&&(r.text("No. "+i[d].factura,55,s+20),r.text(i[d].cliente.razon_social,100,s+20),r.text(i[d].pagosVenta[0].a_cuenta_anterior,300,s+20),p+=i[d].pagosVenta[0].a_cuenta_anterior,s+=20):i[d].a_cuenta&&(r.text("No. "+i[d].factura,55,s+20),r.text(i[d].cliente.razon_social,100,s+20),r.text(i[d].a_cuenta,300,s+20),p+=i[d].a_cuenta,s+=20);r.font("Helvetica-Bold",8),r.text(p,350,u);var m=s+20;r.text("COBROS REALIZADOS: ",55,s+20),r.font("Helvetica",8),s+=20;for(d=0;d<t.length;d++)r.text("No. "+t[d].venta.factura,55,s+20),r.text(t[d].venta.cliente.razon_social,100,s+20),r.text(t[d].monto_pagado,300,s+20),l+=t[d].monto_pagado,s+=20;r.text(l,350,m),r.font("Helvetica-Bold",8),r.text("GASTOS: ",55,s+40),r.text(a.gastos,350,s+40),r.text("SALDO FINAL CAJA: ",55,s+60),r.text(Math.round(100*(a.saldo_inicial+c+p+l-a.gastos))/100,350,s+60),r.text("---------------------------------------------                       ---------------------------------------------",0,s+100,{align:"center"}),r.text("ENTREGUE CONFORME                                     RECIBI CONFORME",0,s+130,{align:"center"}),r.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),v.stop()},E.imprimirReporteCierreCajaRollo=function(e,a,o,i,t){var r=new PDFDocument({compress:!1,size:e,margins:{top:10,bottom:10,left:10,right:20}}),n=r.pipe(blobStream());r.moveDown(2),r.font("Helvetica-Bold",8),r.text("CIERRE DE CAJA",{align:"center"}),r.moveDown(.4),r.font("Helvetica-Bold",8);var s=r.y;r.text("SALDO INICIAL: ",{align:"left",width:100}),r.text(a.saldo_inicial,0,s,{align:"right"}),r.x=10,r.moveDown(.8),r.font("Helvetica-Bold",8);var c=r.y;r.text("VENTAS AL CONTADO: ",{align:"left"}),r.font("Helvetica",8),r.moveDown(.4);for(var l=r.y,d=0,u=0,p=0;p<o.length;p++)r.text("No. "+o[p].factura,20,l),r.text(o[p].cliente.razon_social,60,l,{width:90}),r.text(o[p].total,150,l),d+=o[p].total,l+=20;r.font("Helvetica-Bold",8),r.text(d,0,c,{align:"right"}),r.y=l,r.moveDown(.4),r.x=10,r.font("Helvetica-Bold",8);var m=r.y;r.text("VENTAS AL CREDITO: ",{align:"left"}),r.font("Helvetica",8),r.moveDown(.4),l=r.y;var f=0;for(p=0;p<i.length;p++)0<i[p].pagosVenta.length?0<i[p].pagosVenta[0].a_cuenta_anterior&&(r.text("No. "+i[p].factura,20,l),r.text(i[p].cliente.razon_social,60,l,{width:90}),r.text(i[p].pagosVenta[0].a_cuenta_anterior,150,l),f+=i[p].pagosVenta[0].a_cuenta_anterior,l+=20):i[p].a_cuenta&&(r.text("No. "+i[p].factura,20,l),r.text(i[p].cliente.razon_social,60,l,{width:90}),r.text(i[p].a_cuenta,150,l),f+=i[p].a_cuenta,l+=20);r.font("Helvetica-Bold",8),r.text(f,0,m,{align:"right"}),r.y=l,r.moveDown(.4),r.x=10;var g=r.y;r.text("COBROS REALIZADOS: ",{align:"left"}),r.font("Helvetica",8),r.moveDown(.4),l=r.y;for(p=0;p<t.length;p++)r.text("No. "+t[p].venta.factura,20,l),r.text(t[p].venta.cliente.razon_social,60,l,{width:90}),r.text(t[p].monto_pagado,150,l),u+=t[p].monto_pagado,l+=20;r.font("Helvetica-Bold",8),r.text(u,0,g,{align:"right"}),r.y=l,r.moveDown(.4),r.x=10,r.font("Helvetica-Bold",8),s=r.y,r.text("GASTOS: ",{align:"left"}),r.text(a.gastos,0,s,{align:"right"}),r.x=10,r.moveDown(.4),s=r.y,r.text("SALDO FINAL CAJA: ",{align:"left"}),r.text(Math.round(100*(a.saldo_inicial+d+f+u-a.gastos))/100,0,s,{align:"right"}),r.x=10,r.text("-----------------------------      -----------------------------",0,l+100,{align:"center"}),r.text("ENTREGUE CONFORME   RECIBI CONFORME",{align:"center"}),r.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),v.stop()},E.sumarMonto=function(){for(var e=0,a=0;a<E.ventas.length;a++)E.ventas[a].movimiento?E.ventas[a].movimiento.clase.nombre_corto!=E.diccionario.EGRE_FACTURACION&&E.ventas[a].movimiento.clase.nombre_corto!=E.diccionario.EGRE_PROFORMA||!E.ventas[a].activa||(e+=E.ventas[a].total):E.ventas[a].movimientoServicio.nombre_corto==E.diccionario.EGRE_SERVICIO&&E.ventas[a].activa&&(e+=E.ventas[a].total);return Math.round(100*e)/100},E.crearNuevaVenta=function(e){E.obtenerListaServiciosVentas(),E.blockerVenta=!0,E.venta=new l({id_empresa:E.usuario.id_empresa,id_usuario:E.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],pagado:0,cambio:0,despachado:!1,vendedor:null});var a=0;null==e?E.venta.sucursal=1==E.sucursales.length?E.sucursales[0]:null:(E.venta.sucursal=e.sucursal,a=e.almacen),E.venta.sucursal&&(E.obtenerAlmacenesActividades(E.venta.sucursal.id),null!=a&&a.id&&(E.venta.almacen=a)),E.venta.movimiento=E.movimientosEgreso[0],E.obtenerTipoEgreso(E.venta.movimiento);var o=new Date;E.venta.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),E.venta.tipoPago=E.tiposPago[0],E.cambiarTipoPago(E.venta),E.editar_precio=!1,E.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},E.abrirPopup(E.idModalWizardCompraEdicion),angular.element(n).unbind("keydown"),angular.element(n).bind("keydown",function(e){115==e.keyCode&&E.venderProformaDirectoNormal(E.venta)}),E.enfocar("nit")},E.venderProformaDirectoNormal=function(o){0<o.detallesVenta.length?f(E.usuario.id_empresa,0).then(function(e){1==e.length||1<e.length?E.establecerCliente(e[0]):E.venta.cliente.razon_social=null,o.movimiento=$.grep(E.movimientosEgreso,function(e){return e.nombre_corto==E.diccionario.EGRE_PROFORMA})[0],o.tipoPago=$.grep(E.tiposPago,function(e){return e.nombre==E.diccionario.TIPO_PAGO_CONTADO})[0],E.obtenerTipoEgreso(o.movimiento),E.cambiarTipoPago(o);var a=new Date;o.fechaTexto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),fecha=a,o.pagado=o.total,o.cambio=0,E.usuario.empresa.usar_vencimientos=!1,E.guardarVenta(!0,o),E.venta.sucursal=o.sucursal}):E.$apply(function(){E.message="¡Debe agregar al menos un producto para realizar la transacción!",E.mostrarMensaje(E.message)})},E.verVenta=function(e){E.venta=e,E.abrirPopup(E.idModalWizardVentaVista)},E.cerrarPopupVista=function(){E.cerrarPopup(E.idModalWizardVentaVista)},E.cerrarPopupEdicion=function(){E.ocultarMensajesValidacion(),E.cerrarPopup(E.idModalWizardCompraEdicion)},E.calcularCambio=function(){E.esContado?(E.venta.cambio=Math.round(100*(E.venta.pagado-E.venta.total))/100,E.pagoMinimo=E.venta.total):(E.venta.cambio=0,E.pagoMinimo=0)},E.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},E.imprimirVenta=function(e){_(e.id,E.usuario.id_empresa).then(function(e){var a=e.venta;a.configuracion=e.configuracion,a.sucursal=e.sucursal,a.numero_literal=e.numero_literal,a.pieFactura=e.pieFactura,a.sucursalDestino=e.sucursalDestino;var o=new Date(a.fecha);a.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),a.movimiento?N(a.movimiento.clase.nombre_corto,a,!1,E.usuario,!1):N(a.movimientoServicio.nombre_corto,a,!1,E.usuario,!1)})},E.modificarPrecio=function(){E.editar_precio=!0},E.establecerPrecio=function(){E.editar_precio=!1},E.obtenerFormatoFactura=function(){v.start(),h("FORM_IMP_FAC").then(function(e){E.formatosFactura=e.clases,v.stop()})},E.guardarVenta=function(e,a){if(e){E.ocultarMensajesValidacion();var o=new Date;if(a.fecha=new Date(E.convertirFecha(a.fechaTexto)),a.fecha.setHours(o.getHours()),a.fecha.setMinutes(o.getMinutes()),a.fecha.setSeconds(o.getSeconds()),v.start(),a.id){H(a).then(function(e){v.stop(),E.cerrarPopPupEdicion(),E.mostrarMensaje(e.mensaje),E.recargarItemsTabla()})}else{var i=a.movimiento.nombre_corto;a.usar_peps=E.usuario.empresa.usar_peps,a.$save(function(e){e.hasError?(v.stop(),E.crearNuevaVenta(e),E.mostrarMensaje(e.message)):(v.stop(),E.cerrarPopPupEdicion(),i==E.diccionario.EGRE_SERVICIO?N(i,e,!0,E.usuario,!1):(a.actualizarCotizacion&&Z.update({id_cotizacion:a.cotizacion_id},{estado:"ACEPTADO"},function(e){},function(e){E.mostrarMensaje("Hubo un problema al guardar.")}),E.usuario.empresa.usar_vencimientos?(E.impresion={movimiento:i,res:e,al_guardar:!0,usuario:E.usuario},E.abrirPopup(E.idModalImpresionVencimiento)):N(i,e,!0,E.usuario,!1)),E.crearNuevaVenta(e),E.mostrarMensaje("Venta registrada exitosamente!"))},function(e){v.stop(),E.cerrarPopPupEdicion(),E.mostrarMensaje("Ocurrio un problema al momento de guardar!"),E.recargarItemsTabla()})}}},E.imprimirConVencimiento=function(){E.impresion.res.con_vencimiento=!0,N(E.impresion.movimiento,E.impresion.res,E.impresion.al_guardar,E.impresion.usuario,!1),E.cerrarPopup(E.idModalImpresionVencimiento)},E.imprimirSinVencimiento=function(){E.impresion.res.con_vencimiento=!1,N(E.impresion.movimiento,E.impresion.res,E.impresion.al_guardar,E.impresion.usuario,!1),E.cerrarPopup(E.idModalImpresionVencimiento)},E.imprimirVentaConVencimiento=function(e){_(e.id,E.usuario.id_empresa).then(function(e){var a=e.venta;a.con_vencimiento=!0,a.configuracion=e.configuracion,a.sucursal=e.sucursal,a.numero_literal=e.numero_literal,a.pieFactura=e.pieFactura,a.sucursalDestino=e.sucursalDestino;var o=new Date(a.fecha);a.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),N(a.movimiento.clase.nombre_corto,a,!1,E.usuario,!1)})},E.cerrarPopPupEdicion=function(){E.cerrarPopup(E.idModalWizardCompraEdicion)},E.fechaATexto=function(e){return fech=new Date(e),e=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},E.obtenerAlmacenesEditar=function(a){E.almacenes=[];var e=$.grep(E.sucursales,function(e){return e.id==a})[0];E.almacenes=e.almacenes},E.buscarNit=function(a,e){13===a.which&&f(E.usuario.id_empresa,e).then(function(e){1==e.length||1<e.length?E.establecerCliente(e[0]):E.venta.cliente.razon_social=null,E.interceptarTecla(a,"razon_socialP",!0),E.interceptarTecla(a,"razon_socialP1",!0)});E.capturarInteraccion()},E.capturarInteraccion=function(){E.usuario.empresa.usar_pantalla_cliente&&T.emit("comenzarVenta",E.venta)},E.abrirPopupPanel=function(e,a,o,i,t){E.venta=new l({id_empresa:E.usuario.id_empresa,id_usuario:E.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],despachado:!1,sucursal:e,almacen:a,actividad:o,tipoPago:i,movimiento:t,vendedor:null}),E.obtenerGruposProductoEmpresa(),e||(E.venta.sucursal=E.sucursales[0]),E.venta.sucursal&&null==E.venta.almacen&&E.obtenerAlmacenesActividades(E.venta.sucursal.id),t||(E.venta.movimiento=E.movimientosEgreso[0]),E.obtenerTipoEgreso(E.venta.movimiento),i||(E.venta.tipoPago=E.tiposPago[0]),E.cambiarTipoPago(E.venta);var r=new Date;E.venta.fechaTexto=r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),E.abrirPopup(E.idModalPanelVentas),E.enfocar("nitP"),setTimeout(function(){aplicarDatePickers(),$("#venta-proforma").draggable({cursor:"crosshair",start:E.startDragging})},2e3),angular.element(n).unbind("keydown"),angular.element(n).bind("keydown",function(e){if(115==e.keyCode&&E.venderProformaDirecto(E.venta,!1),113==e.keyCode&&E.venderProformaDirecto(E.venta,!0),121==e.keyCode)if(e.preventDefault(),0<E.venta.detallesVenta.length){var a=new Date;E.horaActual=a.getHours()+":"+a.getMinutes()+":"+a.getSeconds(),E.abrirPopup(E.idModalPanelVentasCobro),E.enfocar("nitP1");var o=$("#movimiento").val("24");angular.element(o).triggerHandler("change"),angular.element($("#pagadoP").val(E.venta.total)).triggerHandler("change"),$("form").bind("keydown",function(e){if(13===e.keyCode)return!1})}else E.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")})},E.capturarPago=function(e,a,o){13==e.keyCode&&(E.guardarVentaPanel(a,o,!1),E.cerrarPopPupVentasCobro())},E.abrirPopPupVentasCobro=function(){if(0<E.venta.detallesVenta.length){var e=new Date;E.horaActual=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds(),E.abrirPopup(E.idModalPanelVentasCobro),E.enfocar("nitP1"),angular.element(select).triggerHandler("change"),angular.element($("#pagadoP").val(E.venta.total)).triggerHandler("change"),$("form").bind("keydown",function(e){if(13===e.keyCode)return!1})}else E.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")},E.cerrarPopPupVentasCobro=function(){E.cerrarPopup(E.idModalPanelVentasCobro)},E.cerrarPopupPanel=function(){E.cerrarPopup(E.idModalPanelVentas),E.recargarItemsTabla(),E.usuario.empresa.usar_pantalla_cliente&&T.emit("terminarVenta",E.venta.sucursal),angular.element(n).unbind("keydown")},E.clasificarGrupo=function(e){E.productosProcesados=a("filter")(E.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},E.cargarProductos=function(){D(E.usuario.id_empresa,E.venta.almacen.id,E.usuario.id).then(function(e){for(var a=0;a<e.length;a++)e[a].activar_inventario&&(e[a].inventario_disponible=E.obtenerInventarioTotal(e[a]));if(E.productos=e,angular.isDefined(s.productosProcesados)){E.productosProcesados=e;for(a=0;a<s.productosProcesados.length;a++)for(var o=0;o<E.productosProcesados.length;o++)s.productosProcesados[a].id==E.productosProcesados[o].id&&(E.productosProcesados[o].rankin=s.productosProcesados[a].rankin)}else E.productosProcesados=e;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},E.textorder="A<- ->Z",E.ordenarProductos=function(e){E.productosProcesados=a("orderBy")(E.productos,["nombre"],e),E.ordenProductos=!e,E.textorder=e?"A<- ->Z":"Z<- ->A",setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},E.filtrarProductos=function(e){E.productosProcesados=a("filter")(E.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},angular.isDefined(s.color)?E.color=s.color:(s.color={style:"red-style",stylebutton:"red-style-button"},E.color={style:"red-style",stylebutton:"red-style-button"}),E.cambiarColor=function(e,a){s.color={style:e,stylebutton:a},$("#dialog-panel-ventas .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-ventas .widget-main").addClass(e),$("#dialog-panel-ventas .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-ventas .widget-main .button-style").addClass(a)},E.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},E.dragged=!1,E.proformaClick=function(e){E.dragged||E.venderProformaDirecto(e,!1),E.dragged=!1},E.startDragging=function(){E.dragged=!0},E.venderProformaDirecto=function(o,i){0<o.detallesVenta.length?f(E.usuario.id_empresa,0).then(function(e){1==e.length||1<e.length?E.establecerCliente(e[0]):E.venta.cliente.razon_social=null,o.movimiento=$.grep(E.movimientosEgreso,function(e){return e.nombre_corto==E.diccionario.EGRE_PROFORMA})[0],o.tipoPago=$.grep(E.tiposPago,function(e){return e.nombre==E.diccionario.TIPO_PAGO_CONTADO})[0],E.obtenerTipoEgreso(o.movimiento),E.cambiarTipoPago(o);var a=new Date;o.fechaTexto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),fecha=a,o.pagado=o.total,o.cambio=0,E.guardarVentaPanel(!0,o,i)}):E.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")},E.calcularImporteDetalleVenta=function(e){var a,o;e.importe=Math.round(e.cantidad*e.precio_unitario*1e3)/1e3,a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,o=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+o-e.ice-e.excento},E.agregarDetalleVentaPanel=function(a){var e;if(E.cantidadInventario=0,a.activar_inventario)for(var o=0;o<a.inventarios.length;o++)E.cantidadInventario=E.cantidadInventario+a.inventarios[o].cantidad;for(var i=0,t=!1;i<E.venta.detallesVenta.length&&!t;)E.venta.detallesVenta[i].producto.id==a.id&&(a.activar_inventario?E.venta.detallesVenta[i].cantidad+1<=E.cantidadInventario?E.venta.detallesVenta[i].cantidad=E.venta.detallesVenta[i].cantidad+1:E.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+E.cantidadInventario+"!"):E.venta.detallesVenta[i].cantidad=E.venta.detallesVenta[i].cantidad+1,t=!0,e=E.venta.detallesVenta[i]),i++;if(t)E.calcularImporteDetalleVenta(e);else if(a.activar_inventario)if(1<=E.cantidadInventario){var r=0;E.venta.cliente.id&&E.venta.cliente.tipoPrecioVenta&&E.usuario.empresa.usar_tipo_precio&&0<a.tiposPrecio.length?a.tiposPrecio.forEach(function(e){r=e.id_tipo_precio==E.venta.cliente.tipoPrecioVenta.id?e.precio_unitario:a.precio_unitario}):r=a.precio_unitario,e={producto:a,precio_unitario:r,inventario_disponible:E.cantidadInventario,costos:a.inventarios,cantidad:1,descuento:a.descuento,tipo_descuento:0<a.descuento,recargo:0,ice:0,excento:0,tipo_recargo:!1},E.venta.detallesVenta.push(e),E.calcularImporteDetalleVenta(e)}else E.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+E.cantidadInventario+"!");else{r=0;E.venta.cliente.id&&E.venta.cliente.tipoPrecioVenta&&E.usuario.empresa.usar_tipo_precio&&0<a.tiposPrecio.length?a.tiposPrecio.forEach(function(e){r=e.id_tipo_precio==E.venta.cliente.tipoPrecioVenta.id?e.precio_unitario:a.precio_unitario}):r=a.precio_unitario,e={producto:a,precio_unitario:r,inventario_disponible:E.cantidadInventario,costos:a.inventarios,cantidad:1,descuento:a.descuento,tipo_descuento:0<a.descuento,recargo:0,ice:0,excento:0,tipo_recargo:!1},E.venta.detallesVenta.push(e),E.calcularImporteDetalleVenta(e)}E.sumarTotal(),E.sumarTotalImporte(),E.calcularSaldo(),E.capturarInteraccion(),a.rankin+=1;var n=E.productosProcesados.indexOf(a);E.productosProcesados[n]=a,s.productosProcesados=E.productosProcesados,a.activar_inventario&&(a.inventario_disponible=E.cantidadInventario-e.cantidad)},E.disminuirDetalleVenta=function(e){var a=E.productosProcesados.indexOf(e.producto);1==e.cantidad?E.eliminarDetalleVentaPanel(e):(e.cantidad=e.cantidad-1,E.productosProcesados[a].inventario_disponible=E.productosProcesados[a].inventario_disponible+1,E.calcularImporteDetalleVenta(e),E.sumarTotal(),E.sumarTotalImporte(),E.calcularSaldo(),E.capturarInteraccion())},E.guardarVentaPanel=function(e,a,o){if(e){E.usuario.empresa.usar_pantalla_cliente&&T.emit("terminarVenta",a.sucursal),E.ocultarMensajesValidacion();var i=new Date;if(a.fecha=new Date(E.convertirFecha(a.fechaTexto)),a.fecha.setHours(i.getHours()),a.fecha.setMinutes(i.getMinutes()),v.start(),a.id)l.update({idCompra:compra.id},compra,function(e){v.stop(),E.cerrarPopPupEdicion(),E.mostrarMensaje("Actualizado Exitosamente!"),E.recargarItemsTabla()});else{var t=a.movimiento.nombre_corto;a.$save(function(e){v.stop(),e.hasError?(v.stop(),E.mostrarMensaje(e.message),E.venta.almacen.id=a.almacen.id,E.abrirPopupPanel(a.sucursal,a.almacen,a.actividad,a.tipoPago,a.movimiento)):(N(t,e,!0,E.usuario,o),E.mostrarMensaje("Venta registrada exitosamente!"),E.cargarProductos(),E.abrirPopupPanel(a.sucursal,a.almacen,a.actividad,a.tipoPago,a.movimiento),E.enfocar("nitP"))},function(e){v.stop(),E.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}}},E.mostrarConfirmacionEliminacionVenta=function(e){E.venta=new l(e),E.abrirPopup(E.idModalConfirmacionEliminacionVenta)},E.cerrarConfirmacionEliminacionVenta=function(){E.cerrarPopup(E.idModalConfirmacionEliminacionVenta)},E.eliminarVenta=function(e){(v.start(),E.cerrarConfirmacionEliminacionVenta(),e.movimientoServicio)?W(e).then(function(e){E.mostrarMensaje(e.mensaje)}):e.$delete();E.mostrarMensaje("Anulado exitosamente!"),E.recargarItemsTabla(),v.stop()},E.abrirPopupInventario=function(){E.abs=n.Math.abs,E.itemsPorPagina=10,E.paginaActual=1,E.columna="nombre",E.direccion="asc",E.cantidadInv="0",E.textoBusqueda="",E.venta.almacen&&(E.almacenBusqueda=E.venta.almacen,E.buscarInventarios(E.almacenBusqueda.id,E.paginaActual,E.itemsPorPagina,E.textoBusqueda,E.columna,E.direccion,E.cantidadInv)),E.abrirPopup(E.idModalInventario)},E.barcodeScanned=function(e){E.search=e,E.filtrarProductos(e)},E.limpiarBusqueda=function(){E.search="",E.filtrarProductos()},E.buscarInventarios=function(e,a,o,i,t,r,n){v.start(),E.itemsPorPagina=o,""==i||null==i?i=0:E.textoBusqueda=i,E.paginaActual=a,c(E.usuario.id_empresa,e,a,o,i,t,r,n,void 0,E.usuario.id).then(function(e){for(var a=e.productos,o=0;o<a.length;o++){a[o].fecha_vencimiento=new Date(a[o].fecha_vencimiento),a[o].cantidad_total=a[o].cantidad}E.paginas=[];for(o=1;o<=e.paginas;o++)E.paginas.push(o);E.productos=a,v.stop()})},E.clasificarColumna=function(e){E.columna==e?"asc"==E.direccion?(E.direccion="desc",$("#"+e+"p").removeClass("fa-caret-up"),$("#"+e+"p").addClass("fa-caret-down")):(E.direccion="asc",$("#"+e+"p").removeClass("fa-caret-down"),$("#"+e+"p").addClass("fa-caret-up")):(E.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+e+"p").addClass("fa-caret-up"),$("#"+e+"p").removeClass("fa-sort")),E.columna=e,E.buscarInventarios(E.almacenBusqueda.id,E.paginaActual,E.itemsPorPagina,E.textoBusqueda,E.columna,E.direccion,E.cantidadInv)},E.verificarPulso=function(e,a){13===e.keyCode&&(E.textoBusqueda=a,E.almacenBusqueda&&E.buscarInventarios(E.almacenBusqueda.id,1,E.itemsPorPagina,E.textoBusqueda,E.columna,E.direccion,E.cantidadInv))},E.abrirModalVerificarCuenta=function(e,a){E.dato=e,E.tipoDatosPermiso=a,E.abrirPopup(E.IdModalVerificarCuenta)},E.cerrarModalVerificarCuenta=function(){E.cerrarPopup(E.IdModalVerificarCuenta)},E.verificarCuentaAdmin=function(e){F.save({id_empresa:E.usuario.id_empresa},e,function(e){e.type?(E.mostrarMensaje(e.message),"venta"==E.tipoDatosPermiso&&E.modificarVenta(E.dato),E.cerrarModalVerificarCuenta()):E.mostrarMensaje(e.message)})},E.abrirReporteProductos=function(){null!=E.filtro?(E.filtro.razon_social?E.razon_social=E.filtro.razon_social:E.razon_social=0,E.filtro.usuario?E.usuario_elegido=E.filtro.usuario:E.usuario_elegido=0,E.filtro.sucursal?E.sucursal=E.filtro.sucursal:E.sucursal=0,E.filtro.nit?E.nit=E.filtro.nit:E.nit=0,E.filtro.monto?E.monto=E.filtro.monto:E.monto=0,E.filtro.tipo_pago?E.tipo_pago=E.filtro.tipo_pago:E.tipo_pago=0,E.filtro.transaccion?E.transaccion=E.filtro.transaccion:E.transaccion=0,E.filtro.estado?E.estado=E.filtro.estado:E.estado=0):(E.razon_social=0,E.usuario_elegido=0,E.sucursal=0,E.nit=0,E.monto=0,E.tipo_pago=0,E.transaccion=0,E.estado=0);for(var e=0;e<E.sucursales.length;e++)E.sucursal?E.sucursal==E.sucursales[e].id?E.sucursal=E.sucursales[e].nombre:0==E.sucursal&&(E.sucursal="Todos"):E.sucursal="Todos";if(E.razonSocial?E.razonSocial:E.razonSocial="Todos",void 0===E.fechaInicioTexto&&void 0===E.fechaFinTexto)E.mostrarMensaje("Ingrese primero las fechas !");else{E.fechaInicioTexto,E.fechaFinTexto;E.obtenerDetalles(),E.abrirPopup(E.modalReportesProductos)}},E.obtenerDetalles=function(){E.paginator=A(),E.paginator.column="nombre",E.paginator.direccion="asc",E.filtroDetallesProducto={sucursalUsuario:E.sucursalesUsuario,inicio:E.fechaInicioTexto,fin:E.fechaFinTexto,sucursal:E.sucursal},E.paginator.callBack=E.filtrarDetalles,E.paginator.getSearch("",E.filtroDetallesProducto,null)},E.filtrarDetalles=function(){v.start(),d(E.paginator).then(function(e){E.ventasPopUp=e.ventas,E.paginator.setPages(e.paginas),v.stop()})},E.generarExcelVentasMensuales=function(){if(!0===E.verDetalle){v.start(),inicio=new Date(E.convertirFecha(E.fechaInicioTexto)),fin=new Date(E.convertirFecha(E.fechaFinTexto)),null!=E.filtro&&E.filtro.sucursal?E.sucursal=E.filtro.sucursal:E.sucursal=0,j(E.usuario.id_empresa,E.sucursal,inicio,fin).then(function(e){var a=JSON.parse(e.detallesVenta),o=[["FECHA DE LA FACTURA","N° DE LA FACTURA","N° DE AUTORIZACION","NIT/CI CLIENTE","NOMBRE O RAZON SOCIAL","UBICACION CLIENTE","CODIGO","DETALLE","UNIDAD","GRUPO","CANTIDAD","PU","TOTAL","IMPORTE ICE/IEHD/TASAS","EXPORTACIONES Y OPERACIONES EXENTAS","VENTAS GRAVADAS A TASA CERO","SUBTOTAL","DESCUENTOS, BONIFICACIONES Y REBAJAS OBTENIDAS","IMPORTE BASE PARA DEBITO FISCAL","DEBITO FISCAL","SUCURSAL","USUARIO"]];E.usuario.empresa.usar_vencimientos&&(o[0].push("FECHA VENCIMIENTO"),o[0].push("LOTE")),o[0].push("VENDEDOR");for(var i=0;i<a.length;i++){var t=[];a[i].venta.fecha=new Date(a[i].venta.fecha),t.push(a[i].venta.fecha),t.push(a[i].venta.factura),t.push(a[i].venta.autorizacion),t.push(a[i].venta.cliente.nit),t.push(a[i].venta.cliente.razon_social),t.push(a[i].venta.cliente.ubicacion_geografica),t.push(a[i].producto.codigo),t.push(a[i].producto.nombre),t.push(a[i].producto.unidad_medida),a[i].producto.grupo?t.push(a[i].producto.grupo.nombre):t.push(""),t.push(a[i].cantidad),t.push(a[i].precio_unitario),t.push(a[i].importe),t.push(a[i].ice),t.push(0),t.push(0),t.push(a[i].importe-a[i].ice);var r=a[i].importe-a[i].ice-a[i].excento+a[i].recargo;t.push(r),t.push(a[i].total),t.push(Math.round(.13*a[i].total*100)/100),t.push(a[i].venta.almacen.sucursal.nombre),t.push(a[i].venta.usuario.nombre_usuario),E.usuario.empresa.usar_vencimientos&&(a[i].inventario?(a[i].inventario.fecha_vencimiento=new Date(a[i].inventario.fecha_vencimiento),t.push(a[i].inventario.fecha_vencimiento),t.push(a[i].inventario.lote)):null!=a[i].lote?(a[i].fecha_vencimiento=new Date(a[i].fecha_vencimiento),t.push(a[i].fecha_vencimiento),t.push(a[i].lote)):(t.push(""),t.push(""))),t.push(a[i].venta.vendedor?a[i].venta.vendedor.persona.nombre_completo:""),o.push(t)}var n=new Workbook,s=sheet_from_array_of_arrays(o);n.SheetNames.push("SheetJS"),n.Sheets.SheetJS=s;var c=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"VENTAS-MENSUALES.xlsx"),v.stop()})}else{v.start(),inicio=new Date(E.convertirFecha(E.fechaInicioTexto)),fin=new Date(E.convertirFecha(E.fechaFinTexto)),E.paginator.itemsPerPage=0;inicio,fin;d(E.paginator).then(function(e){E.ventasExcelDetalle=e.ventas;var a=[];a.push(["Producto","Unidad Medida","Cantidad","Monto"]);for(var o=0;o<E.ventasExcelDetalle.length;o++)columns=[],columns.push(E.ventasExcelDetalle[o].nombre),columns.push(E.ventasExcelDetalle[o].unidad_medida),columns.push(E.ventasExcelDetalle[o].cantidad),columns.push(E.ventasExcelDetalle[o].total),a.push(columns);var i=new Workbook,t=sheet_from_array_of_arrays(a);i.SheetNames.push("SheetJS"),i.Sheets.SheetJS=t;var r=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"VENTAS-DETALLE-PRODUCTO.xlsx"),v.stop()})}},E.generarPdfVentasMensuales=function(){if(!0===E.verDetalle){v.start(),inicio=new Date(E.convertirFecha(E.fechaInicioTexto)),fin=new Date(E.convertirFecha(E.fechaFinTexto)),null!=E.filtro&&E.filtro.sucursal?E.sucursal=E.filtro.sucursal:E.sucursal=0;var u=[inicio,fin,E.sucursal];j(E.usuario.id_empresa,E.sucursal,inicio,fin).then(function(e){var a=JSON.parse(e.detallesVenta),o=new PDFDocument({compress:!1,margin:10}),i=o.pipe(blobStream());o.font("Helvetica",8);var t=150,r=0,n=1;E.dibujarCabeceraPDFVentasMensuales(o,e,u,n);for(var s=0;s<a.length&&r<=15;s++)o.rect(40,t-10,540,40).stroke(),o.font("Helvetica",8),a[s].venta.fecha=new Date(a[s].venta.fecha),o.text(a[s].venta.fecha.getDate()+"/"+(a[s].venta.fecha.getMonth()+1)+"/"+a[s].venta.fecha.getFullYear().toString().substr(-2),45,t),o.text(a[s].venta.factura?a[s].venta.factura:"",80,t),o.font("Helvetica",7),o.text(a[s].venta.cliente.razon_social,115,t-2,{width:80}),o.text(a[s].producto.nombre,205,t-2,{width:80}),o.font("Helvetica",8),o.text(a[s].cantidad,300,t,{width:50}),o.text(a[s].producto.unidad_medida,330,t,{width:50}),E.usuario.empresa.usar_vencimientos&&a[s].inventario&&(a[s].inventario.fecha_vencimiento=new Date(a[s].inventario.fecha_vencimiento),o.text(a[s].inventario.fecha_vencimiento.getDate()+"/"+(a[s].inventario.fecha_vencimiento.getMonth()+1)+"/"+a[s].inventario.fecha_vencimiento.getFullYear().toString().substr(-2),385,t),o.text(a[s].inventario.lote,435,t)),o.text(a[s].descuento,475,t),o.text(a[s].recargo,505,t),o.text(a[s].total,535,t),t+=40,15!=++r&&s+1!=a.length||s+1==a.length||(o.addPage({margin:0,bufferPages:!0}),t=150,r=0,n+=1,E.dibujarCabeceraPDFVentasMensuales(o,e,u,n),o.font("Helvetica",8));var c=new Date,l=c.getMinutes();l<10&&(l="0"+l),o.text("USUARIO: "+E.usuario.nombre_usuario,45,t),o.text("IMPRESION : "+c.getDate()+"/"+(c.getMonth()+1)+"/"+c.getFullYear()+" Hr. "+c.getHours()+":"+l,175,t),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),v.stop()})}else{v.start(),inicio=new Date(E.convertirFecha(E.fechaInicioTexto)),fin=new Date(E.convertirFecha(E.fechaFinTexto));u=[inicio,fin];d(E.paginator).then(function(e){E.ventaSinDetalle=e.ventas;var a=new PDFDocument({compress:!1,margin:10}),o=a.pipe(blobStream());a.font("Helvetica",8);var i=150,t=0,r=1,n=Math.ceil(E.ventaSinDetalle.length/20);E.dibujarCabeceraPDFVentasMensualesSinDetalle(a,E.ventaSinDetalle,u,r,n);for(var s=0,c=0;c<E.ventaSinDetalle.length&&t<=20;c++)s=c+1,a.font("Helvetica",8),a.text(s,45,i),a.font("Helvetica",8),a.text(E.ventaSinDetalle[c].nombre,65,i),a.font("Helvetica",8,{align:"center"}),a.text(E.ventaSinDetalle[c].unidad_medida,390,i),a.font("Helvetica",8),a.text(E.ventaSinDetalle[c].cantidad,470,i),a.font("Helvetica",8),a.text(E.ventaSinDetalle[c].total,500,i),i+=25,20!=++t&&c+1!=E.ventaSinDetalle.length||c+1==E.ventaSinDetalle.length||(a.addPage({margin:0,bufferPages:!0}),i=150,t=0,r+=1,E.dibujarCabeceraPDFVentasMensualesSinDetalle(a,E.ventaSinDetalle,u,r,n),a.font("Helvetica",8));var l=new Date,d=l.getMinutes();d<10&&(d="0"+d),a.text("USUARIO: "+E.usuario.nombre_usuario,45,750),a.text("IMPRESION : "+l.getDate()+"/"+(l.getMonth()+1)+"/"+l.getFullYear()+" Hr. "+l.getHours()+":"+d,175,750),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),v.stop()})}},E.dibujarCabeceraPDFVentasMensuales=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("REPORTE DE VENTAS",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+o.inicio,-70,40,{align:"center"}),e.text("Hasta "+o.fin,70,40,{align:"center"}),e.text("FOLIO "+i,550,25),e.rect(40,60,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("NOMBRE O RAZÓN SOCIAL : ",65,75),e.text("NIT : ",440,75),e.font("Helvetica",8),e.text(a.empresa.razon_social,195,75),e.text(a.empresa.nit,460,75),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,110,{width:40}),e.text("Nº De Nota",80,110,{width:30}),e.text("Cliente",115,110),e.text("Producto",205,110),e.text("Cant.",290,110),e.text("Unidad",330,110),e.text("Fecha Venc",385,110,{width:30}),e.text("Lote",435,110,{width:35}),e.text("Desc.",470,110),e.text("Rec.",500,110),e.text("Total",535,110)},E.dibujarCabeceraPDFVentasMensualesSinDetalle=function(e,a,o,i,t){e.font("Helvetica-Bold",12),e.text("REPORTE DE VENTAS POR PRODUCTOS SIN DETALLE",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+o.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+o.fechaFinTexto,70,40,{align:"center"}),e.text("FOLIO "+i,550,25),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("N°",45,110),e.text("Producto",65,110),e.text("Unidad Medida.",370,110),e.text("Cantidad",450,110),e.text("Monto",500,110),e.font("Helvetica",8),e.text("Pagina "+i+" de "+t,500,750)},E.PopoverReportesRapido={templateUrl:"PopoverReportesRapido.html",title:"Reportes Rapidos",isOpen:!1},E.ImprimirSimpleReporte=function(e){v.start();var a;a=E.usuario.id_empresa,inicio=new Date(E.convertirFecha(E.fechaInicioTexto)),fin=new Date(E.convertirFecha(E.fechaFinTexto)),r(inicio,fin,a,e).then(function(e){E.detallePorProducto=e;var a=new PDFDocument({compress:!1,margin:10}),o=a.pipe(blobStream());a.font("Helvetica",8);var i=150,t=0,r=1,n=Math.ceil(E.detallePorProducto.length/20);E.dibujarCabeceraPDFDetalleProductos(a,e,r,n);for(var s=0,c=0;c<E.detallePorProducto.length&&t<=20;c++)s=c+1,a.font("Helvetica",8),a.text(s,45,i),a.font("Helvetica",8),a.text(E.detallePorProducto[c].venta.factura,65,i,{width:150}),a.font("Helvetica",8),E.detallePorProducto[c].venta.cliente&&(a.font("Helvetica",8),a.text(E.detallePorProducto[c].venta.cliente.razon_social,120,i)),a.font("Helvetica",8),a.text(E.detallePorProducto[c].cantidad,470,i),a.font("Helvetica",8),a.text(E.detallePorProducto[c].total,520,i),i+=30,20!=++t&&c+1!=E.detallePorProducto.length||c+1==E.detallePorProducto.length||(a.addPage({margin:0,bufferPages:!0}),i=150,t=0,r+=1,E.dibujarCabeceraPDFDetalleProductos(a,e,r,n),a.font("Helvetica",8));var l=new Date,d=l.getMinutes();d<10&&(d="0"+d),a.text("USUARIO: "+E.usuario.nombre_usuario,45,750),a.text("IMPRESION : "+l.getDate()+"/"+(l.getMonth()+1)+"/"+l.getFullYear()+" Hr. "+l.getHours()+":"+d,175,750),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),v.stop()})},E.dibujarCabeceraPDFDetalleProductos=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("DETALLE DEL PRODUCTO",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+E.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+E.fechaFinTexto,70,40,{align:"center"}),e.font("Helvetica-Bold",8),e.text(a[0].producto.nombre,0,55,{align:"center"}),e.font("Helvetica-Bold",8),e.text("Codigo: "+a[0].producto.codigo,45,65),e.font("Helvetica-Bold",8),e.text("Unidad Medida: "+a[0].producto.unidad_medida,45,75),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",45,110),e.text("N° Factura",65,110),e.text("Razon Social",120,110),e.text("Cantidad",450,110),e.text("Monto",520,110),e.font("Helvetica",8),e.text("Pagina "+o+" de "+i,500,750)},E.abrirReporteGraficoProductos=function(){E.abrirPopup(E.modelGraficaProductos)},E.cerrarReporteGraficoProductos=function(){E.cerrarPopup(E.modelGraficaProductos)},E.graficarProductos=function(e){var t=e;v.start();var r=[];inicio=new Date(E.convertirFecha(E.fechaInicioTexto)),fin=new Date(E.convertirFecha(E.fechaFinTexto)),E.paginator.itemsPerPage=0,d(E.paginator).then(function(e){E.datosProductosGrafico=e.ventas.sort(function(e,a){return a.total-e.total});for(var a=0;a<E.datosProductosGrafico.length;a++){var o=[];o.push(E.datosProductosGrafico[a].nombre),o.push(E.datosProductosGrafico[a].unidad_medida),o.push(E.datosProductosGrafico[a].cantidad),o.push(E.datosProductosGrafico[a].total),r.push(o)}var i=[];contenido=r.map(function(e,a){10<=i.length||i.push(e)}),E.reporteGrafico(i,t),v.stop()})},E.reporteGrafico=function(e,a){E.abrirReporteGraficoProductos();var o=[];if(0!=e.length&&(o=e.map(function(e,a){return{label:e[0],y:e[3]}})),0==a)new CanvasJS.Chart("tablaReportes",{animationEnabled:!0,exportEnabled:!0,theme:"light1",title:{text:""},data:[{type:"column",indexLabelFontSize:10,dataPoints:o}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"white",labelMaxWidth:50,labelWrap:!0,interval:1}}).render();else if(1==a){new CanvasJS.Chart("tablaReportes",{animationEnabled:!0,exportEnabled:!0,theme:"light2",title:{text:""},data:[{type:"pie",startAngle:25,toolTipContent:"<b>{label}</b>: {y} Bs.",showInLegend:"true",legendText:"{label}",indexLabelFontSize:10,indexLabel:"{label} - {y} Bs.",dataPoints:o}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"black",labelMaxWidth:50,labelWrap:!0,interval:1}}).render()}},E.abrirReporteGraficoEmpresa=function(){E.abrirPopup(E.modelGraficaEmpresas)},E.cerrarReporteGraficoEmpresa=function(){E.cerrarPopup(E.modelGraficaEmpresas)},E.graficarEmpresa=function(e){var t=e;v.start();var r=[];inicio=new Date(E.convertirFecha(E.fechaInicioTexto)),fin=new Date(E.convertirFecha(E.fechaFinTexto)),E.paginator.itemsPerPage=0,J(E.paginator).then(function(e){E.datosReporteGraficoEmpresa=e.detalle.sort(function(e,a){return a.total-e.total});for(var a=0;a<E.datosReporteGraficoEmpresa.length;a++){var o=[];o.push(E.datosReporteGraficoEmpresa[a].razon_social),o.push(E.datosReporteGraficoEmpresa[a].total),r.push(o)}var i=[];r.map(function(e,a){10<=i.length||i.push(e)}),E.reporteGraficoEmpresas(i,t),v.stop()})},E.reporteGraficoEmpresas=function(e,a){E.abrirReporteGraficoEmpresa();var o=[];if(0!=e.length&&(o=e.map(function(e,a){return{label:e[0],y:e[1]}})),0==a)new CanvasJS.Chart("tablaReportesEmpresas",{animationEnabled:!0,exportEnabled:!0,theme:"light1",title:{text:""},data:[{type:"column",indexLabelFontSize:10,dataPoints:o}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"white",labelMaxWidth:50,labelWrap:!0,interval:1}}).render();else if(1==a){new CanvasJS.Chart("tablaReportesEmpresas",{animationEnabled:!0,exportEnabled:!0,theme:"light2",title:{text:""},data:[{type:"pie",startAngle:25,toolTipContent:"<b>{label}</b>: {y} Bs.",showInLegend:"true",legendText:"{label}",indexLabelFontSize:10,indexLabel:"{label} - {y} Bs.",dataPoints:o}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"black",labelMaxWidth:50,labelWrap:!0,interval:1}}).render()}},E.cerrarReporteProductos=function(){E.cerrarPopup(E.modalReportesProductos)},E.verDetalle=!0,E.conDetalle=function(){!0===E.verDetalle?E.verDetalle=!1:!1===E.verDetalle&&(E.verDetalle=!0)},E.abrirReporteEmpresas=function(){E.fechaInicioTexto,E.fechaFinTexto,E.idEmpresa=E.usuario.id_empresa,null!=E.filtro&&E.filtro.sucursal?E.sucursalSelec=E.filtro.sucursal:E.sucursalSelec=0;for(var e=0;e<E.sucursales.length;e++)E.sucursal?E.sucursal==E.sucursales[e].id?E.sucursal=E.sucursales[e].nombre:0==E.sucursal&&(E.sucursal="Todos"):E.sucursal="Todos";E.razonSocial?E.razonSocial:E.razonSocial="Todos",void 0===E.fechaInicioTexto&&void 0===E.fechaFinTexto?E.mostrarMensaje("Ingrese primero las fechas !"):(E.obtenerDetallesEmpresa(),E.abrirReportePorEmpresa())},E.obtenerDetallesEmpresa=function(){E.paginator=A(),E.paginator.column="razon_social",E.paginator.direccion="asc",E.filtroDetallesProducto={idsSucursales:E.sucursalesUsuario,inicio:E.fechaInicioTexto,fin:E.fechaFinTexto,sucursal:E.sucursalSelec,idEmpresa:E.idEmpresa},E.paginator.callBack=E.filtroDetalleEmpresa,E.paginator.getSearch("",E.filtroDetallesProducto,null)},E.filtroDetalleEmpresa=function(){v.start(),J(E.paginator).then(function(e){E.detalleEmpresa=e.detalle,E.paginator.setPages(e.paginas),v.stop()})},E.imprimirSimpleReporteEmpresa=function(e){v.start();var a;a=E.usuario.id_empresa,inicio=new Date(E.convertirFecha(E.fechaInicioTexto)),fin=new Date(E.convertirFecha(E.fechaFinTexto)),u(inicio,fin,a,e).then(function(e){E.detallePorEmpresa=e;var a=new PDFDocument({compress:!1,margin:10}),o=a.pipe(blobStream());a.font("Helvetica",8);var i=150,t=0,r=1,n=Math.ceil(E.detallePorEmpresa.length/20);E.dibujarCabeceraPDFDetalleEmpresas(a,e,r,n);for(var s=0,c=0;c<E.detallePorEmpresa.length&&t<=20;c++){columns=[],E.producto=E.detallePorEmpresa[c];for(var l=0;l<E.producto.detallesVenta.length;l++)E.DetalleVenta=E.producto.detallesVenta[l],a.font("Helvetica"),s=c+1,a.text(s,45,i),a.text(E.DetalleVenta.venta.factura,65,i),a.text(E.producto.nombre,120,i),a.text(E.DetalleVenta.cantidad,465,i),a.text(E.DetalleVenta.total,520,i),i+=30,20!=++t&&l+1!=E.detallePorEmpresa.length||l+1==E.detallePorEmpresa.length||(a.addPage({margin:0,bufferPages:!0}),i=150,t=0,r+=1,E.dibujarCabeceraPDFDetalleProductos(a,e,r,n),a.font("Helvetica",8))}var d=new Date,u=d.getMinutes();u<10&&(u="0"+u),a.text("USUARIO: "+E.usuario.nombre_usuario,45,750),a.text("IMPRESION : "+d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+" Hr. "+d.getHours()+":"+u,175,750),a.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),v.stop()})},E.dibujarCabeceraPDFDetalleEmpresas=function(e,a,o,i){e.font("Helvetica-Bold",12),e.text("VENTAS",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+E.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+E.fechaFinTexto,70,40,{align:"center"}),e.font("Helvetica-Bold",8),e.text(a[0].detallesVenta[0].venta.cliente.razon_social,0,55,{align:"center"}),e.font("Helvetica-Bold",8),e.text("Codigo: "+a[0].codigo,45,65),e.font("Helvetica-Bold",8),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",45,110),e.text("N° Factura",65,110),e.text("Producto",120,110),e.text("Cantidad",450,110),e.text("Monto",520,110),e.font("Helvetica",8),e.text("Pagina "+o+" de "+i,500,750)},E.abrirReportePorEmpresa=function(){E.abrirPopup(E.modalReportesEmpresas)},E.cerrarReportePorEmpresa=function(){E.cerrarPopup(E.modalReportesEmpresas)},E.modificarVenta=function(e){$("#modal-wizard-venta-edicion").dialog({closeOnEscape:!1}),E.blockerVenta=!0,E.venta=new l(e),E.venta.editable=!0,E.venta.movimientoActual=Object.assign({},e.movimiento);var a;E.venta.sucursal=e.almacen.sucursal,a=e.almacen,E.venta.sucursal&&(E.obtenerAlmacenesActividades(E.venta.sucursal.id),a.id&&(E.venta.almacen=a)),E.venta.detallesVenta.forEach(function(e){e.eliminado=!1}),E.venta.movimiento=E.venta.movimiento.clase,E.obtenerTipoEgreso(E.venta.movimiento);var o=new Date(E.venta.fecha);E.venta.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),E.cambiarTipoPago(E.venta),E.editar_precio=!1,E.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},E.abrirPopup(E.idModalWizardCompraEdicion),angular.element(n).unbind("keydown"),angular.element(n).bind("keydown",function(e){115==e.keyCode&&E.venderProformaDirectoNormal(E.venta)}),E.venta.id_empresa=E.usuario.id_empresa,E.enfocar("nit")},E.abrirmodalServicioVenta=function(){E.servicio={habilitado:!0,eliminado:!1},E.abrirPopup(E.modalServicioVenta)},E.cerrarmodalServicioVenta=function(){E.cerrarPopup(E.modalServicioVenta)},E.abrirModalImportacionVentaServicio=function(){E.venta={sucursal:"",actividad:"",fecha:"",movimiento:{nombre_corto:"SERV"}},E.obtenerListaServiciosVentas(),E.abrirPopup(E.modelImportacionVentaServicio)},E.cerrarModalImportacionVentaServicio=function(){E.cerrarPopup(E.modelImportacionVentaServicio)},E.obtenerListaServiciosVentas=function(){q(E.usuario.id_empresa).then(function(e){E.serviciosVentas=e.servicios})},E.establecerServicioSeleccionado=function(e){E.establecerServicio(e),E.cerrarmodalServicioVenta()},E.establecerServicio=function(e){E.detalleVenta={centroCosto:null,servicio:e,importe:e.precio,descuento:e.descuento,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},E.enfocar("cantidad")},E.agregarServicioVenta=function(e){e.id||e.edit||E.serviciosVentas.push(e),E.servicio={habilitado:!0,eliminado:!1}},E.modificarServicioVenta=function(e){E.servicio=e,E.servicio.edit=!0},E.cancelarEdicionVentaServicio=function(e){E.servicio={habilitado:!0,eliminado:!1}},E.guardarServiciosVenta=function(e){Y(E.usuario.id_empresa,e).then(function(e){E.obtenerListaServiciosVentas(),E.mostrarMensaje(e.mensaje),E.cerrarmodalServicioVenta()})},E.verificarCamposForimImpServ=function(e){e.activ.$touched=!!e.activ.$invalid,e.fechaSerImp.$touched=!!e.fechaSerImp.$invalid,e.sucServImp.$touched=!!e.sucServImp.$invalid},E.subirExcelVentasServicios=function(e){var a,o,i=e.target.files;for(o=i[a=0];a!=i.length;++a){var t=new FileReader;o.name;t.onload=function(e){var a=e.target.result,o=XLSX.read(a,{type:"binary"}),i=o.SheetNames[0],t=2,r=0,n=2,s=o.Sheets[i],c=[],l=[],d=[];do{n=2;var u={tipoPago:{},detallesVenta:[],cliente:{},fechaTexto:E.venta.fecha,sucursal:E.venta.sucursal,actividad:E.venta.actividad},p=null!=s["A"+t]&&""!=s["A"+t]?s["A"+t].v.toString():null;if(2==t)var m=null!=s["A"+t]&&""!=s["A"+t]?s["A"+t].v.toString():null;else m=null!=s["A"+(t-1)]&&""!=s["A"+(t-1)]?s["A"+(t-1)].v.toString():null;u.cliente.nit=null!=s["B"+t]&&""!=s["B"+t]?s["B"+t].v.toString():null,u.cliente.razon_social=null!=s["C"+t]&&""!=s["C"+t]?s["C"+t].v.toString():null;var f=!1;if(0<d.length){for(r=0;r<d.length;r++){var g=d[r].nit;null!=u.cliente.nit&&g==u.cliente.nit&&(f=!0)}f||d.push(u.cliente)}else d.push(u.cliente);u.vendedor=null!=s["D"+t]&&""!=s["D"+t]?s["D"+t].v.toString():null,u.observacion=null!=s["E"+t]&&""!=s["E"+t]?s["E"+t].v.toString():null,u.tipoPago.nombre=null!=s["F"+t]&&""!=s["F"+t]?s["F"+t].v.toString():null,u.dias_credito=null!=s["G"+t]&&""!=s["G"+t]?parseInt(s["G"+t].v.toString()):null,u.a_cuenta=null!=s["H"+t]&&""!=s["H"+t]?parseFloat(s["H"+t].v.toString()):null;do{var v={servicio:{}};v.servicio.nombre=null!=s["I"+n]&&""!=s["I"+n]?s["I"+n].v.toString():null,v.servicio.precio=null!=s["K"+n]&&""!=s["K"+n]?parseFloat(s["K"+n].v.toString()):null,v.servicio.id_empresa=E.usuario.id_empresa;f=!1;if(0<l.length){for(r=0;r<l.length;r++){g=l[r].nombre;null!=v.servicio.nombre&&g==v.servicio.nombre&&(f=!0)}f||l.push(v.servicio)}else l.push(v.servicio);if(v.observaciones=null!=s["J"+n]&&""!=s["J"+n]?s["J"+n].v.toString():null,v.importe=null!=s["K"+n]&&""!=s["K"+n]?parseFloat(s["K"+n].v.toString()):null,v.descuento=null!=s["L"+n]&&""!=s["L"+n]?parseFloat(s["L"+n].v.toString()):null,v.tipo_recargo=null!=s["M"+n]&&""!=s["M"+n]?parseFloat(s["M"+n].v.toString()):null,v.recargo=null!=s["N"+n]&&""!=s["N"+n]?parseFloat(s["N"+n].v.toString()):null,v.ice=null!=s["O"+n]&&""!=s["O"+n]?parseFloat(s["O"+n].v.toString()):null,v.excento=null!=s["P"+n]&&""!=s["P"+n]?parseFloat(s["P"+n].v.toString()):null,p==(null!=s["A"+n]&&""!=s["A"+n]?s["A"+n].v.toString():null)){var h=v.recargo;"%"==v.tipo_recargo&&(h=E.detalleVenta.importe*(v.recargo/100));var b=E.serviciosVentas.filter(function(e){return e.nombre==v.servicio.nombre});0<b.length&&(v.servicio=b[0]),v.total=Math.round(1e3*(v.importe-v.descuento+h-v.ice-v.excento))/1e3,u.detallesVenta.push(v)}n++}while(null!=s["A"+n]);if(p!=m||2==t){var C=0;for(r=0;r<u.detallesVenta.length;r++)u.detallesVenta[r].eliminado||(C+=u.detallesVenta[r].importe);u.importe=Math.round(1e3*C)/1e3;var P=0;for(r=0;r<u.detallesVenta.length;r++)u.detallesVenta[r].eliminado||(P+=u.detallesVenta[r].total);u.total=Math.round(1e3*P)/1e3,u.pagado=u.total;var _=E.tiposPago.filter(function(e){return e.nombre==u.tipoPago.nombre});u.tipoPago=_[0],"CREDITO"==u.tipoPago.nombre?u.saldo=u.total-u.a_cuenta:u.saldo=null,u.cambio=0,u.id_usuario=E.usuario.id;var M=E.movimientosEgreso.filter(function(e){return e.nombre_corto==E.diccionario.EGRE_SERVICIO}),D=E.vendedores.filter(function(e){return e.persona.nombre_completo==u.vendedor});0<D.length&&(u.vendedor=D[0]),u.movimiento=M[0],u.id_empresa=E.usuario.id_empresa,u.fecha=new Date(E.convertirFecha(u.fechaTexto)),c.push(u)}t++,r++}while(null!=s["A"+t]);E.guardarImportacionVentasServicios(c,l,d)},t.readAsBinaryString(o)}},E.guardarImportacionVentasServicios=function(e,a,o){v.start(),V(e,a,o).then(function(e){v.stop(),E.mostrarMensaje(e.mensaje)})},E.obtenerCotizaciones=function(){E.paginator=A(),E.paginator.column="nombre",E.paginator.direction="desc",E.paginator.callBack=E.obtenerLista,E.filtro={empresa:E.usuario.id_empresa,inicio:"",fin:"",fecha_inicio:new Date(E.convertirFecha("14/08/2018")),fecha_fin:new Date(E.convertirFecha("27/08/2018")),busqueda:"",importe:0},E.paginator.getSearch("",E.filtro,null)},E.obtenerLista=function(){v.start(),K(E.paginator).then(function(e){console.log("llegooo  cotissssssss",e),E.paginator.setPages(e.paginas),E.cotizaciones=e.cotizaciones,v.stop()})},E.abrirPopupCotizaciones=function(){E.obtenerCotizaciones(),E.abrirPopup(E.idModalCotizaciones)},E.cerrarPopupCotizaciones=function(){E.cerrarPopup(E.idModalCotizaciones)},E.obtenerDetalleCotizacion=function(e,a){E.editCoticacion=a,console.log("datos usuarioooooooo ",E.usuario);for(var o=0;o<e.detallesCotizacion.length;o++){var i=e.detallesCotizacion[o].producto,t=E.obtenerInventarioTotal(i);e.detallesCotizacion[o].disponible=t,e.detallesCotizacion[o].aceptar=!1,t<e.detallesCotizacion[o].cantidad?(e.detallesCotizacion[o].faltante=e.detallesCotizacion[o].cantidad-t,e.detallesCotizacion[o].entregar=t):(e.detallesCotizacion[o].faltante=0,e.detallesCotizacion[o].entregar=e.detallesCotizacion[o].cantidad),0<e.detallesCotizacion[o].entregar&&(e.detallesCotizacion[o].aceptar=!0),0<e.detallesCotizacion[o].faltante&&(e.detallesCotizacion[o].aceptar=!1),e.detallesCotizacion[o].total=e.detallesCotizacion[o].entregar*e.detallesCotizacion[o].precio_unitario,console.log("disponibleeeeee ",t)}console.log("la cotizacvion recibidooo ",e.detallesCotizacion),E.cotizacion=e,E.abrirPopup(E.idModalDetalleCotizaciones)},E.isCheckedCotizacion=function(e){if(e)for(var a in e.detallesCotizacion){if(e.detallesCotizacion[a].aceptar)return!1}return!0},E.cerrarPopupDetalleCotizaciones=function(){E.cerrarPopup(E.idModalDetalleCotizaciones)},E.aceptarDetalleCotizacion=function(e){e.aceptar=!0},E.cancelarDetalleCotizacion=function(e){e.aceptar=!1},E.agregarVentaCotizacion=function(e){console.log("la cotizacion para venta",e),E.obtenerAlmacenesActividades(e.sucursal.id);var a=new Date;e.fecha=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),E.detalleVenta=[];for(var o=0,i=0;i<e.detallesCotizacion.length;i++)if(e.detallesCotizacion[i].aceptar){var t={eliminado:!1,producto:e.detallesCotizacion[i].producto,precio_unitario:e.detallesCotizacion[i].precio_unitario,costos:e.detallesCotizacion[i].producto.activar_inventario?e.detallesCotizacion[i].producto.inventarios:[],cantidad:e.detallesCotizacion[i].cantidad,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,importe:e.detallesCotizacion[i].importe,total:e.detallesCotizacion[i].total};o+=e.detallesCotizacion[i].total,E.detalleVenta.push(t)}E.venta=new l({id_empresa:E.usuario.id_empresa,id_usuario:E.usuario.id,cliente:e.cliente,sucursal:e.sucursal,almacen:e.almacen,fechaTexto:e.fecha,tipoPago:E.tiposPago[0],cotizacion_id:e.id,actualizarCotizacion:!0,detallesVenta:E.detalleVenta,detallesVentaNoConsolidadas:[],pagado:o,cambio:0,despachado:!1,vendedor:null,total:o}),E.cerrarPopupDetalleCotizaciones(),E.cerrarPopupCotizaciones()},E.editarDetalleCotizacion=function(e){E.Cprecio_unitario=e.precio_unitario,E.c=e,E.abrirPopup(E.idModalDetalleCotizacionEditar)},E.guardarEditarCotizacion=function(e){E.c=e,E.cerrarPopupCotizacionEditar()},E.cancelarPopupCotizacionEditar=function(e){E.c.precio_unitario=E.Cprecio_unitario,E.cerrarPopup(E.idModalDetalleCotizacionEditar)},E.cerrarPopupCotizacionEditar=function(){E.cerrarPopup(E.idModalDetalleCotizacionEditar)},E.$on("$routeChangeStart",function(e,a){E.eliminarPopup(E.idModalWizardCompraEdicion),E.eliminarPopup(E.idModalWizardVentaVista),E.eliminarPopup(E.idModalEliminarCompra),E.eliminarPopup(E.idModalPago),E.eliminarPopup(E.idModalCierre),E.eliminarPopup(E.idModalPanelVentas),E.eliminarPopup(E.idModalInventario),E.eliminarPopup(E.idModalPanelVentasCobro),E.eliminarPopup(E.idModalEdicionVendedor),E.eliminarPopup(E.idModalImpresionVencimiento),E.eliminarPopup(E.IdModalVerificarCuenta),E.eliminarPopup(E.modalReportesProductos),E.eliminarPopup(E.modelGraficaProductos),E.eliminarPopup(E.modalServicioVenta),E.eliminarPopup(E.modelImportacionVentaServicio),E.eliminarPopup(E.idModalCotizaciones),E.eliminarPopup(E.idModalDetalleCotizaciones),E.eliminarPopup(E.idModalDetalleCotizacionEditar)}),E.UsarLectorDeBarra=function(){if(1==E.usuario.usar_lector_de_barra){E.usuario.usar_lector_de_barra=!0,s.usuario=JSON.stringify(E.usuario);k(E.usuario)}else{E.usuario.usar_lector_de_barra=!1,localStorage.usuario=JSON.stringify(E.usuario);k(E.usuario)}},E.inicio()}]),angular.module("agil.controladores").controller("ControladorIncrementoSalarial",["$scope","$localStorage","$location","$templateCache","$route","blockUI",function(o,e,a,i,t,r){o.$on("$viewContentLoaded",function(){o.idModalNuevoIncrementoSalarial="dialog-nueva-incremento-salarial",ejecutarScriptsIncrementoSalarial(o.idModalNuevoIncrementoSalarial)}),o.$on("$routeChangeStart",function(e,a){o.eliminarPopup(o.idModalNuevoIncrementoSalarial)}),o.abrirDialogNuevoIncrementoSalarial=function(){o.abrirPopup(o.idModalNuevoIncrementoSalarial)},o.cerrarDialogNuevoIncrementoSalarial=function(){o.cerrarPopup(o.idModalNuevoIncrementoSalarial)}}]),angular.module("agil.controladores").controller("ControladorPlanillaSueldos",["$scope","$localStorage","$location","$templateCache","$route,blockUI","Parametro","Parametros","RecursosHumanosEmpleados","ClasesTipo","RecursosHumanosEmpleadosHorasExtras","RecursosHumanosPlanillaSueldos","RRHHlistaPlanillaSueldos",function($scope,$localStorage,$location,$templateCache,$route,blockUI,Parametro,Parametros,RecursosHumanosEmpleados,ClasesTipo,RecursosHumanosEmpleadosHorasExtras,RecursosHumanosPlanillaSueldos,RRHHlistaPlanillaSueldos){function HMToDecimal(hora,minuto){var d1=hora,m1=minuto,d=eval(d1),m=eval(m1),dH=Math.abs(d)+m/60;return console.log("en decimal es ",round(dH,2)),round(dH,2)}function calcAge(e){var a=+new Date(e);return~~((Date.now()-a)/315576e5)}function round(e,a){return Number(Math.round(e+"e"+a)+"e-"+a)}$scope.$on("$viewContentLoaded",function(){$scope.idModalNuevaPlanillaSueldos="dialog-nueva-planilla-sueldos",$scope.idModalEditarPlanillaSueldo="dialog-editar-planilla-sueldo",$scope.idModalParametros="dialog-parametros",$scope.idModalTR3="dialog-tr3",$scope.idModalHistorialTR3="dialog-historial-tr3",$scope.idEliminarSueldoEmpleado="dialog-eliminar-salario-empleado",ejecutarScriptsPlanillaSueldos($scope.idModalNuevaPlanillaSueldos,$scope.idModalEditarPlanillaSueldo,$scope.idModalParametros,$scope.idModalTR3,$scope.idModalHistorialTR3,$scope.idEliminarSueldoEmpleado)}),$scope.$on("$routeChangeStart",function(e,a){$scope.eliminarPopup($scope.idModalNuevaPlanillaSueldos,$scope.idModalEditarPlanillaSueldo,$scope.idModalParametros,$scope.idModalTR3,$scope.idModalHistorialTR3,$scope.idEliminarSueldoEmpleado)}),$scope.usuario=JSON.parse($localStorage.usuario),$scope.fechaATexto=function(e){return fech=new Date(e),e=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},$scope.obtenerGestiones=function(){blockUI.start(),ClasesTipo("GTN").then(function(e){$scope.gestiones=e.clases,blockUI.stop()})},$scope.obtenerGestiones(),$scope.nuevaPlanillaSueldos=function(){$scope.planilla=new RecursosHumanosPlanillaSueldos({id_empresa:$scope.usuario.id_empresa}),$scope.sumarTotales($scope.planilla)},$scope.abrirDialogNuevaPlanillaSueldos=function(){$scope.nuevaPlanillaSueldos(),$scope.abrirPopup($scope.idModalNuevaPlanillaSueldos)},$scope.filtrarSueldos=function(o){console.log("cabezera",o);var i=RecursosHumanosEmpleados($scope.usuario.id_empresa);i.then(function(e){console.log("empleadossssstt ",e),o.RecursosHumanosEmpleados=e.empleados,o.RecursosHumanosEmpleados.forEach(function(a){console.log("los ides de empleados ==== ",a),(i=RecursosHumanosEmpleadosHorasExtras(a.id_ficha,o.gestion,o.mes.split("-")[0],a.id)).then(function(e){console.log("los datos de  los empleados ",e),a.sueldoBasico=a.haber_basico,$scope.horasExtras=8,console.log("ficha fecha inicio ==== ",a.fecha_inicio),$scope.antiguedad=calcAge(a.fecha_inicio),console.log("$scope.antiguedad",$scope.antiguedad),$scope.bonoFrontera=0,$scope.otrosBonos=0,a.horasExtras=e.totalHoras,a.totalHorasExtras=round(a.sueldoBasico/30/8*a.horasExtras*2,2),a.recargoNocturno=round(a.sueldoBasico/30/8*a.horasExtras*1.5,2),a.bonoAntiguedad=$scope.calcularBonoAntiguedad($scope.antiguedad),a.bonoFrontera=$scope.bonoFrontera,a.otrosBonos=$scope.otrosBonos,a.totalGanado=round(a.sueldoBasico+a.totalHorasExtras+a.recargoNocturno+a.bonoAntiguedad+a.bonoFrontera+a.otrosBonos,2),a.afp=round(12.71*a.totalGanado/100,2),null==a.rc_iva_mes&&(a.rc_iva_mes=0),a.rc_iva=a.rc_iva_mes,a.anticipos=round(e.totalAnticipo,2),a.prestamos=round(e.totalCuotas,2),a.totalDescuento=round(a.afp+a.rc_iva+a.anticipos+a.prestamos,2),a.liquidoPagable=round(a.totalGanado-a.totalDescuento,2),$scope.sumarTotales(o)})}),blockUI.stop()})},$scope.generar=function(e){e.$save(function(e){$scope.nuevaPlanillaSueldos(),blockUI.stop(),$scope.mostrarMensaje("Planilla registrada exitosamente!")},function(e){blockUI.stop(),console.log("fallo ",e)}),console.log("los datos  de planilla ",e)},$scope.sumarTotales=function(e){$scope.totalSueldoBasico=0,$scope.sumaHorasExtras=0,$scope.sumaTotalHorasExtras=0,$scope.sumaRecargoNocturno=0,$scope.sumaBonoAntiguedad=0,$scope.sumaBonoFrontera=0,$scope.sumaOtrosBonos=0,$scope.sumaTotalGanado=0,$scope.sumaAFP=0,$scope.sumaRCIVA=0,$scope.sumaAniticipos=0,$scope.sumaPrestamos=0,$scope.sumaTotalDescuento=0;var a=$scope.sumaLiquidoPagable=0;if(null!=e.RecursosHumanosEmpleados)for(var o=0;o<e.RecursosHumanosEmpleados.length;o++)a+=1,$scope.totalSueldoBasico=round($scope.totalSueldoBasico+e.RecursosHumanosEmpleados[o].sueldoBasico,2),$scope.sumaHorasExtras=$scope.sumaHorasExtras+e.RecursosHumanosEmpleados[o].horasExtras,$scope.sumaTotalHorasExtras=$scope.sumaTotalHorasExtras+e.RecursosHumanosEmpleados[o].totalHorasExtras,$scope.sumaRecargoNocturno=$scope.sumaRecargoNocturno+e.RecursosHumanosEmpleados[o].recargoNocturno,$scope.sumaBonoAntiguedad=$scope.sumaBonoAntiguedad+e.RecursosHumanosEmpleados[o].bonoAntiguedad,$scope.sumaBonoFrontera=$scope.sumaBonoFrontera+e.RecursosHumanosEmpleados[o].bonoFrontera,$scope.sumaOtrosBonos=$scope.sumaOtrosBonos+e.RecursosHumanosEmpleados[o].otrosBonos,$scope.sumaTotalGanado=round($scope.sumaTotalGanado+e.RecursosHumanosEmpleados[o].totalGanado,2),$scope.sumaAFP=round($scope.sumaAFP+e.RecursosHumanosEmpleados[o].afp,2),$scope.sumaRCIVA=round($scope.sumaRCIVA+e.RecursosHumanosEmpleados[o].rc_iva,2),$scope.sumaAniticipos=round($scope.sumaAniticipos+e.RecursosHumanosEmpleados[o].anticipos,2),$scope.sumaPrestamos=round($scope.sumaPrestamos+e.RecursosHumanosEmpleados[o].prestamos,2),$scope.sumaTotalDescuento=round($scope.sumaTotalDescuento+e.RecursosHumanosEmpleados[o].totalDescuento,2),$scope.sumaLiquidoPagable=round($scope.sumaLiquidoPagable+e.RecursosHumanosEmpleados[o].liquidoPagable,2);e.totalEmpleados=a,e.importeSueldoBasico=$scope.totalSueldoBasico,e.totalHorasExtras=$scope.sumaHorasExtras,e.importeHorasExtras=$scope.sumaTotalHorasExtras,e.importeRecargoNocturno=$scope.sumaRecargoNocturno,e.importeBonoAntiguedad=$scope.sumaBonoAntiguedad,e.importeBonoFrontera=$scope.sumaBonoFrontera,e.importeOtrosBonos=$scope.sumaOtrosBonos,e.importeAFP=$scope.sumaAFP,e.importeRCIVA=$scope.sumaRCIVA,e.importeAniticipos=$scope.sumaAniticipos,e.importePrestamos=$scope.sumaPrestamos,e.importeTotalDescuento=$scope.sumaTotalDescuento,e.importeTotalGanado=$scope.sumaTotalGanado,e.importeLiquidoPagable=$scope.sumaLiquidoPagable},$scope.calcularBonoAntiguedad=function(e){return 0<=e&&e<=2?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_cero_dos/100:2<e&&e<=5?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_dos_cinco/100:5<e&&e<=8?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_cinco_ocho/100:8<e&&e<=11?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_ocho_once/100:11<e&&e<=15?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_once_quince/100:15<e&&e<=20?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_quice_veinte/100:20<e&&e<=25?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_veinte_veinticinco/100:25<e?3*$scope.parametros.salario_base_antiguedad*$scope.parametros.antiguedad_mas_veinticinco/100:void 0},$scope.cerrarDialogNuevaPlanillaSueldos=function(){$scope.cerrarPopup($scope.idModalNuevaPlanillaSueldos)},$scope.obtenerParametros=function(e){blockUI.start(),null==e&&(e=0),Parametros(e).then(function(e){$scope.parametros=e,blockUI.stop()})},$scope.abrirDialogEditarPlanillaSueldo=function(e){$scope.empleado=e,$scope.sueldo=angular.copy(e),$scope.abrirPopup($scope.idModalEditarPlanillaSueldo)},$scope.modificarSueldo=function(e){$scope.empleado=angular.extend($scope.empleado,e),$scope.sumarTotales($scope.planilla),$scope.cerrarDialogEditarPlanillaSueldo()},$scope.cerrarDialogEditarPlanillaSueldo=function(){$scope.cerrarPopup($scope.idModalEditarPlanillaSueldo)},$scope.cerrarDialogEliminarSueldoEmpleado=function(){$scope.cerrarPopup($scope.idEliminarSueldoEmpleado)},$scope.abrirDialogEliminarSueldoEmpleado=function(e,a){$scope.empleado=a,$scope.index=e,$scope.abrirPopup($scope.idEliminarSueldoEmpleado)},$scope.eliminarSueldoEmpleado=function(e,a){$scope.planilla.RecursosHumanosEmpleados.splice(e,1),$scope.sumarTotales($scope.planilla),$scope.empleado=null,$scope.cerrarDialogEliminarSueldoEmpleado(),$scope.mostrarMensaje("el sueldo se elimino")},$scope.calcularTotalEditados=function(){$scope.sueldo.totalHorasExtras=round($scope.sueldo.sueldoBasico/30/8*$scope.horasExtras*2,2),$scope.sueldo.recargoNocturno=Math.round($scope.sueldo.sueldoBasico/30/8*$scope.sueldo.horasExtras*1.5),$scope.sueldo.totalGanado=$scope.sueldo.sueldoBasico+$scope.sueldo.totalHorasExtras+$scope.sueldo.recargoNocturno+$scope.sueldo.bonoAntiguedad+$scope.sueldo.bonoFrontera+$scope.sueldo.otrosBonos,$scope.sueldo.afp=round(12.71*$scope.sueldo.totalGanado/100,2),$scope.sueldo.totalDescuento=$scope.sueldo.afp+$scope.sueldo.rc_iva+$scope.sueldo.anticipos+$scope.sueldo.prestamos,$scope.sueldo.liquidoPagable=round($scope.sueldo.totalGanado-$scope.sueldo.totalDescuento,2)},$scope.filtrarListaPlanillaSueldos=function(a){console.log("cabezera generalllllll ",a),RRHHlistaPlanillaSueldos($scope.usuario.id_empresa,a.gestion,a.mes).then(function(e){console.log("empleadossssstt ",e),a.planillas=e.planillas,blockUI.stop()})},$scope.abrirDialogParametros=function(){$scope.abrirPopup($scope.idModalParametros)},$scope.cerrarDialogParametros=function(){$scope.cerrarPopup($scope.idModalParametros)},$scope.editarParametros=function(e){blockUI.start(),$scope.parametros=e,Parametro.update({idEmpresa:$scope.usuario.id_empresa},e,function(e){console.log("el mensaje es----",e.mensaje),$scope.mostrarMensaje(e.mensaje)},function(e){$scope.mostrarMensaje("Ocurrio un problema al momento de guardar!")}),blockUI.stop(),$scope.cerrarDialogParametros()},$scope.abrirDialogTR3=function(){$scope.abrirPopup($scope.idModalTR3)},$scope.cerrarDialogTR3=function(){$scope.cerrarPopup($scope.idModalTR3)},$scope.abrirDialogHistorialTR3=function(){$scope.abrirPopup($scope.idModalHistorialTR3)},$scope.cerrarDialogHistorialTR3=function(){$scope.cerrarPopup($scope.idModalHistorialTR3)},$scope.obtenerParametros($scope.usuario.id_empresa)}]);