angular.module("agil.controladores").controller("ControladorActivosFijos",["$scope","$timeout","Paginator","$localStorage","$location","blockUI","ListaSubGruposProductoEmpresa","FieldViewer","GuardarConfiguracionActivosFijos","ObtenerConfiguracionActivosFijos","ActivosFijosEmpresa","RevaluarActivo",function(c,o,a,i,t,e,r,n,s,u,l,d){c.idModalconfiguracionActivos="modal-configuracion-activos",c.idModalRevaluarActivo="modal-revaluar-activos",c.usuarioSesion=JSON.parse(i.usuario),c.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsActivos(c.idModalconfiguracionActivos,c.idModalRevaluarActivo),c.buscarAplicacion(c.usuarioSesion.aplicacionesUsuario,t.path().substring(1)),c.obtenerColumnasAplicacion()}),c.$on("$routeChangeStart",function(a,o){c.eliminarPopup(c.idModalconfiguracionActivos),c.eliminarPopup(c.idModalRevaluarActivo)}),c.calcularTotales=function(){c.totalesActivosFijos={totalValores:0,totalActualizacion:0,totalActualizado:0,totalDepreciacionAcumulada:0,totalActualizacionDepreciacionAcumulada:0,totalDepreciacionActualizada:0,totalDepreciacionMensual:0,totalDepreciacion:0,totalNeto:0},c.activosFijos.forEach(function(a){c.totalesActivosFijos.totalValores+=a.valores[0].valor,c.totalesActivosFijos.totalActualizacion+=a.valores[0].incremento_actualizacion,c.totalesActivosFijos.totalActualizado+=a.valores[0].valor_actualizado,c.totalesActivosFijos.totalDepreciacionAcumulada+=a.valores[0].depreciacion_acumulada,c.totalesActivosFijos.totalActualizacionDepreciacionAcumulada+=a.valores[0].incremento_actualizacion_depreciacion_acumulada,c.totalesActivosFijos.totalDepreciacionActualizada+=a.valores[0].depreciacion_acumulada_actualizada,c.totalesActivosFijos.totalDepreciacionMensual+=a.valores[0].depreciacion,c.totalesActivosFijos.totalDepreciacion+=a.valores[0].total_depreciacion_acumulada,c.totalesActivosFijos.totalNeto+=a.valores[0].valor_neto})},c.factorConfiguracion=Array.apply(null,new Array(20)).map(function(a,o){return{id:5*(o+1)}}),c.abrirConfiguracionActivos=function(){c.abrirPopup(c.idModalconfiguracionActivos)},c.cerrarConfiguracionActivos=function(){c.cerrarPopup(c.idModalconfiguracionActivos)},c.inicio=function(){c.configuracionActivosFijos=[],c.obtenerConfiguracionActivos(),c.filtro={mes:{id:(new Date).getMonth()+1},anio:{id:(new Date).getFullYear()},subgrupo:0,codigo:0,activo:0,vida_util:0},c.obtenerSubGruposProductosEmpresaUsuario(),c.obtenerPaginadorActivos(),c.listaEstados=[{id:1,nombre:"Activo"},{id:2,nombre:"Inactivo"}],c.ConteoBusqueda=0},c.agregarDetalleConfiguracion=function(o){if(c.configuracionActivosFijos.some(function(a){return a.subgrupo.id===o.subgrupo.id}))c.mostrarMensaje("Ya existe en la lista de configuración.");else{var a={subgrupo:o.subgrupo,vida_util:o.vida_util,factor:o.factor};c.configuracionActivosFijos.push(a)}},c.obtenerColumnasAplicacion=function(){e.start(),c.fieldViewer=n({crear:!0,id_empresa:c.usuarioSesion.empresa.id,configuracion:{numero:{value:"Número",show:!0},activo:{value:"Activo",show:!0},codigo:{value:"Código",show:!0},cantidad:{value:"Cantidad",show:!0},mes:{value:"Mes",show:!0},anio:{value:"Año",show:!0},fecha_ingreso:{value:"Fecha ingreso",show:!0},valor:{value:"Valor",show:!0},actualizacion:{value:"Actualización",show:!0},valor_actualizado:{value:"Valor actualizado",show:!0},depreciacion_acumulada:{value:"Depreciación acumulada",show:!0},actualizacion_depreciacion_acumulada:{value:"Actualización de la depreciación acumulada",show:!0},depreciacion_acumulada_actualizada:{value:"Depreciación acumulada actualizada",show:!0},depreciacion_mes:{value:"Depreciación mensual",show:!0},total_depreciacion:{value:"Total depreciación",show:!0},valor_neto:{value:"Valor neto",show:!0},vida_util:{value:"Vida útil",show:!0},vida_restante:{value:"Vida restante (Meses)",show:!0},revaluado:{value:"Revaluado",show:!0}}},c.aplicacion.aplicacion.id),c.fieldViewer.updateObject(),e.stop()},c.obtenerSubGruposProductosEmpresaUsuario=function(){e.start(),r(c.usuarioSesion.id_empresa,c.usuarioSesion.id).then(function(a){e.stop(),0<a.length?c.subGruposProducto=a:(c.subGruposProducto=[],c.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(a){c.subGruposProducto=[];var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.data&&null!==a.data&&""!==a.data?a.data:"Error: Se perdio la conexión.";c.mostrarMensaje(o),e.stop()})},c.obtenerConfiguracionActivos=function(){e.start(),u(c.usuarioSesion.id_empresa,c.usuarioSesion.id).then(function(a){a.hasErr?(c.configuracionActivosFijos=[],c.mostrarMensaje(a.mensaje)):c.configuracionActivosFijos=a.configuracion,e.stop()}).catch(function(a){e.stop();var o=void 0!==a.stack&&null!==a.stack&&""!==a.stack?a.stack:null!==a.data&&void 0!==a.data&""!==a.data?a.data:"Error: se perdio la conexión con el servidor.";c.mostrarMensaje(o)})},c.obtenerPaginadorActivos=function(){c.paginator=a(),c.paginator.column="nombre",c.paginator.direccion="asc",c.paginator.callBack=c.buscarActivos,c.paginator.getSearch("",null,null)},c.filtrarFiltro=function(a,o,i){if(void 0!==i)for(var t in a)0==a[t]&&(a[t]="");else for(var t in a)""!==a[t]&&null!==a[t]&&void 0!==a[t]||(a[t]=0);if(void 0!==o&&o)return a;c.buscarActivos()},c.buscarActivos=function(){e.start(),c.filtro=c.filtrarFiltro(c.filtro,!0),c.paginator.filter=c.filtro,l(c.usuarioSesion.id_empresa,c.paginator).then(function(a){if(a.hasErr)c.mostrarMensaje(a.mensaje);else{if(0<a.activos.length){c.activosFijos=a.activos,c.paginator.setPages(a.paginas);var t=-1;0<c.configuracionActivosFijos.length&&c.activosFijos.forEach(function(i,a){if(c.configuracionActivosFijos.some(function(a,o){return t=o,a.subgrupo.id==i.activo.subgrupo.id})){var o=(new Date).getMonth()-new Date(i.fecha_ingreso).getMonth()+12*((new Date).getFullYear()-new Date(i.fecha_ingreso).getFullYear());c.activosFijos[a].vida_util=c.configuracionActivosFijos[t].vida_util,c.activosFijos[a].vida_restante=c.configuracionActivosFijos[t].vida_util-o}}),c.calcularTotales()}else{if(c.ConteoBusqueda<1)return c.ConteoBusqueda+=1,void o(function(){c.buscarActivos()},5e3);c.activosFijos=a.activos,c.totalesActivosFijos={totalValores:0,totalActualizacion:0,totalActualizado:0,totalDepreciacionAcumulada:0,totalActualizacionDepreciacionAcumulada:0,totalDepreciacionActualizada:0,totalDepreciacionMensual:0,totalDepreciacion:0,totalNeto:0}}e.stop()}e.stop(),c.filtrarFiltro(c.filtro,!0,!0)}).catch(function(a){e.stop();var o=void 0!==a.stack&&null!==a.stack&&""!==a.stack?a.stack:null!==a.data&&void 0!==a.data&""!==a.data?a.data:"Error: se perdio la conexión con el servidor.";c.mostrarMensaje(o)})},c.revaluarActivo=function(){e.start(),d(c.activo,c.usuarioSesion.id_empresa,c.usuarioSesion.id).then(function(a){a.hasErr?c.mostrarMensaje(a.mensaje):c.cerrarDialogRevaluarActivo(),e.stop()}).catch(function(a){e.stop();var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.message&&null!==a.message?a.message:"Se perdió la conexión.";c.mostrarMensaje(o)})},c.guardarConfiguracionActivos=function(){(e.start(),0<c.configuracionActivosFijos.length)?s(c.usuarioSesion.id_empresa,c.usuarioSesion.id,c.configuracionActivosFijos).then(function(a){a.hasErr?c.mostrarMensaje(a.mensaje):(c.mostrarMensaje(a.mensaje),c.cerrarConfiguracionActivos()),e.stop()}).catch(function(a){e.stop();var o=void 0!==a.stack&&null!==a.stack&&""!==a.stack?a.stack:null!==a.data&&void 0!==a.data&""!==a.data?a.data:"Error: se perdio la conexión con el servidor.";c.mostrarMensaje(o)}):c.mostrarMensaje("No hay cambios para guardar.")},c.abrirDialogRevaluarActivo=function(a){null!=a?(c.activo=a,c.abrirPopup(c.idModalRevaluarActivo)):c.mostrarMensaje("La información del activo es incorrecta.")},c.cerrarDialogRevaluarActivo=function(){c.activo={},c.cerrarPopup(c.idModalRevaluarActivo)},c.inicio()}]);