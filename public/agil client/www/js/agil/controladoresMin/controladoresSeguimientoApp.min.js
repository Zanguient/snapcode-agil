angular.module("agil.controladores").controller("ControladorSeguimientoApp",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","UsuariosRutasLista","Rutas","uiGmapGoogleMapApi","UsuarioRutasSeguimiento","UsuarioRutaReporteDatos","UsuarioRutaGraficoDatos","UsuariosComisionesReporte","CierreCajaRutaUsuarioDatos",function(p,t,e,a,o,n,g,r,i,s,l,c,u,d,f){g.start(),p.usuario=JSON.parse(e.usuario),p.idModalSeguimientoVentas="dialog-seguimiento-ventas",p.idModalFiltroExcel="dialog-filtro-excel",p.idModalFiltroGraficos="dialog-filtro-graficos",p.idModalUsuarioComision="dialog-usuario-comision",p.inicio=function(){p.obtenerUsuariosRutas(),p.obtenerRutas()},p.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),setTimeout(function(){ejecutarScriptsSeguimiento(p.idModalSeguimientoVentas,p.idModalFiltroExcel,p.idModalFiltroGraficos,p.idModalUsuarioComision)},1e3),p.buscarAplicacion(p.usuario.aplicacionesUsuario,a.path().substring(1)),g.stop()}),p.obtenerUsuariosRutas=function(){var t=new Date,e=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear();p.filtrarRutasUsuarios(e,e,0,0)},p.obtenerRutas=function(){g.start(),i(p.usuario.id_empresa).then(function(t){p.rutas=t,g.stop()})},p.filtrarRutasUsuarios=function(t,e,a,o){g.start(),a=null==a||null==a?0:a,o=""==o||null==o?0:o;t=new Date(p.convertirFecha(t)),e=new Date(p.convertirFecha(e));r(p.usuario.id_empresa,t,e,o,a).then(function(t){p.usuariosRutas=t,g.stop()})},p.abrirSeguimientoVentas=function(t,e){g.start();var a=p.obtenerDiaActual();0<$.grep(e.dias,function(t){return t.dia.nombre_corto==a}).length?l(t,a).then(function(e){p.mostrarMap=!0,s.then(function(t){p.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}},window:{marker:{},show:!1,closeClick:function(){this.show=!1},options:{}},markersEvents:{click:function(t,e,a,arguments){p.map.window.model=a,p.map.window.show=!0}}},p.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},p.generarMarcadores(e[0].ruta.clientes),e[0].ruta.segmentos=JSON.parse(e[0].ruta.segmentos),p.dibujarRuta(e[0].ruta)}),p.abrirPopup(p.idModalSeguimientoVentas),g.stop()}):(p.mostrarMensaje("¡No existe ventas en el dia para esta Ruta y Usuario!"),g.stop())},p.generarMarcadores=function(t){var e=function(t,e,a,o,n,r,i,s,l,c,u){null==a&&(a="id");var d={latitude:o,longitude:n,title:u,options:r,razonSocial:s,ventas:l,detallesVentaNoConsolidadas:c,show:!1};return d[a]=i,d};p.markers=[];for(var a,o=[],n=0;n<t.length;n++){var r,i="",s="";0<t[n].cliente.ventas.length?(i=p.renderizarHtmlVentas(t[n].cliente.ventas[0]),0<t[n].cliente.ventas[0].detallesVentaNoConsolidadas.length?(s=p.renderizarHtmlVentasNoConsolidadas(t[n].cliente.ventas[0].detallesVentaNoConsolidadas),r="yellow"):r="green"):0<t[n].cliente.detallesVentaNoConsolidadas.length?(s=p.renderizarHtmlVentasNoConsolidadas(t[n].cliente.detallesVentaNoConsolidadas),r="red"):(i="¡Aún no se visito!",r="black"),a={labelContent:t[n].cliente.razon_social,labelAnchor:"8 35",labelClass:"marker-label",icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:r,scale:3}};var l=i+s;o.push(e(0,p.map.bounds,null,t[n].cliente.latitud,t[n].cliente.longitud,a,t[n].cliente.id,t[n].cliente.razon_social,t[n].cliente.ventas,t[n].cliente.detallesVentaNoConsolidadas,l))}p.markers=o},p.renderizarHtmlVentas=function(t){for(var e="",a=0;a<t.detallesVenta.length;a++)e=e+"<tr><td>"+(a+1)+"</td>\t\t\t\t\t<td>"+t.detallesVenta[a].cantidad+"</td>\t\t\t\t\t<td>"+t.detallesVenta[a].producto.nombre+"</td>\t\t\t\t\t<td>"+t.detallesVenta[a].total+"</td></tr>";return'<h3>Venta</h3><table class="table table-striped table-bordered table-hover" ng-if="modelo.detallesVenta.length>0"> \t\t\t<thead>\t\t\t\t<tr>\t\t\t\t\t<th>\t\t\t\t\t\t<label>#</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Cantidad</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Producto</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Precio (Bs)</label>\t\t\t\t\t</th>\t\t\t\t</tr>\t\t\t</thead>\t\t\t<tbody>'+e+("</tr>\t\t\t\t<tr>\t\t\t\t\t<td>\t\t\t\t\t</td>\t\t\t\t\t<td>\t\t\t\t\t</td>\t\t\t\t\t<td>\t\t\t\t\t\t<b>TOTALES</b>\t\t\t\t\t</td>\t\t\t\t\t<td>"+t.total+"</td>\t\t\t\t</tr>\t\t\t</tbody>\t\t</table>")},p.renderizarHtmlVentasNoConsolidadas=function(t){for(var e="",a=0;a<t.length;a++)e=e+"<tr><td>"+(a+1)+"</td>\t\t\t\t\t<td>"+t[a].cantidad+"</td>\t\t\t\t\t<td>"+t[a].producto.nombre+"</td>\t\t\t\t\t<td>"+t[a].total+"</td></tr>";return'<h3>Venta No Consolidada</h3>\t\t<table class="table table-striped table-bordered table-hover">\t\t\t<thead>\t\t\t\t<tr>\t\t\t\t\t<th>\t\t\t\t\t\t<label>#</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Cantidad</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Producto</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Precio (Bs)</label>\t\t\t\t\t</th>\t\t\t\t</tr>\t\t\t</thead>\t\t\t<tbody>'+e+"</tr>\t\t\t</tbody>\t\t</table>"},p.dibujarRuta=function(t){if(p.polylines=[],0<t.segmentos.length)for(var e=0;e<t.segmentos.length;e++){for(var a=[],o=0;o<t.segmentos[e].length;o++)a.push({latitude:t.segmentos[e][o].lat,longitude:t.segmentos[e][o].lng});p.polylines.push({id:e+1,path:a,stroke:{color:"#69AA46",weight:3},editable:!0,draggable:!0,geodesic:!0,visible:!0})}p.drawingManagerOptions={drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.POLYLINE]},polylineOptions:{strokeColor:"#69AA46",strokeWeight:5}},p.markersAndCircleFlag=!0,p.drawingManagerControl={},p.drawingManagerEvents={polylinecomplete:function(t,e,a,o){for(var n=o[0],r=n.getPath(),i=[],s=0;s<r.getArray().length;s++)i.push(r.getArray()[s].toJSON());p.ruta.segmentos.push(i),p.formas.push(n)}}},p.seleccionarMarcador=function(t,e,a){a.show=!a.show},p.cerrarSeguimientoVenta=function(){p.mostrarMap=!1,p.cerrarPopup(p.idModalSeguimientoVentas)},p.abrirPopupFiltroExcel=function(t,e){var a=new Date;p.reporte={bandera:3,id_usuario:t.id,usuario:t,ruta:e,id_ruta:e.id,mes:"1",gestion:"2017"},p.reporte.fechaTextoInicio=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),p.reporte.fechaTextoFin=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),p.abrirPopup(p.idModalFiltroExcel)},p.cerrarPopupFiltroExcel=function(){p.cerrarPopup(p.idModalFiltroExcel)},p.buscarDetallesVenta=function(l){if(g.start(),l.tipo){var t=new Date;t.setDate(1),t.setMonth(parseInt(l.mes)-1),t.setFullYear(parseInt(l.gestion)),l.inicio=t;var e=new Date;e.setDate(new Date(parseInt(l.gestion),parseInt(l.mes),0).getDate()),e.setMonth(parseInt(l.mes)-1),e.setFullYear(parseInt(l.gestion)),l.fin=e}else l.inicio=new Date(p.convertirFecha(l.fechaTextoInicio)),l.fin=new Date(p.convertirFecha(l.fechaTextoFin));c(l.id_usuario,l.inicio,l.fin,l.bandera,l.id_ruta).then(function(t){for(var e=[["","","REPORTE VENDEDOR RUTA"],["Vendedor : ",l.usuario.persona.nombres,"Ruta : ",l.ruta.nombre],["Nro.","Fecha","Cliente","Producto","Cantidad","P. U.","Total","Comision","Total Comision","Tipo de Venta","Dias"]],a=0;a<t.length;a++){var o=[];o.push((a+1).toString()),1==l.bandera?(t[a].fecha=new Date(t[a].fecha),o.push(t[a].fecha.getDate()+"/"+(t[a].fecha.getMonth()+1)+"/"+t[a].fecha.getFullYear()),o.push(t[a].cliente.razon_social),o.push("ROJO"),o.push("ROJO"),o.push("ROJO"),o.push("ROJO"),o.push("ROJO"),o.push("ROJO"),o.push("ROJO"),o.push("ROJO")):(t[a].venta.fecha=new Date(t[a].venta.fecha),o.push(t[a].venta.fecha.getDate()+"/"+(t[a].venta.fecha.getMonth()+1)+"/"+t[a].venta.fecha.getFullYear()),o.push(t[a].venta.cliente.razon_social),o.push(t[a].producto.nombre),o.push(t[a].cantidad),o.push(t[a].precio_unitario),o.push(t[a].total),o.push(t[a].producto.comision),o.push(t[a].cantidad*t[a].producto.comision),o.push(t[a].venta.tipoPago.nombre),t[a].venta.dias_credito&&o.push(t[a].venta.dias_credito)),e.push(o)}var n="SheetJS",r=new Workbook,i=sheet_from_array_of_arrays(e);r.SheetNames.push(n),r.Sheets[n]=i;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"REPORTE-RUTA-USUARIO.xlsx"),g.stop()})},p.abrirPopupFiltroGraficos=function(t,e){var a=new Date;p.reporte={bandera:3,id_usuario:t.id,usuario:t,ruta:e,id_ruta:e.id,mes:"1",gestion:"2017"},p.reporte.fechaTextoInicio=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),p.reporte.fechaTextoFin=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),p.abrirPopup(p.idModalFiltroGraficos)},p.buscarGraficos=function(r){if(g.start(),r.tipo){var t=new Date;t.setDate(1),t.setMonth(parseInt(r.mes)-1),t.setFullYear(parseInt(r.gestion)),r.inicio=t;var e=new Date;e.setDate(new Date(parseInt(r.gestion),parseInt(r.mes),0).getDate()),e.setMonth(parseInt(r.mes)-1),e.setFullYear(parseInt(r.gestion)),r.fin=e}else r.inicio=new Date(p.convertirFecha(r.fechaTextoInicio)),r.fin=new Date(p.convertirFecha(r.fechaTextoFin));u(r.id_usuario,r.inicio,r.fin,r.id_ruta).then(function(e){if(r.tipo){p.labels=[],p.data=[];for(var t=0,a=0;a<e.length;a++){e[a].fecha=new Date(e[a].fecha);var o=$.grep(e,function(t){return t.fecha=new Date(t.fecha),t.fecha.getDate()==e[a].fecha.getDate()&&t.fecha.getMonth()==e[a].fecha.getMonth()&&t.fecha.getFullYear()==e[a].fecha.getFullYear()});e=$.grep(e,function(t){return t.fecha=new Date(t.fecha),!(t.fecha.getDate()==e[a].fecha.getDate()&&t.fecha.getMonth()==e[a].fecha.getMonth()&&t.fecha.getFullYear()==e[a].fecha.getFullYear())}),a=-1;for(var n=t=0;n<o.length;n++)t+=o[n].total;p.labels.push(o[0].fecha.getDate()+"/"+(o[0].fecha.getMonth()+1)+"/"+o[0].fecha.getFullYear()),p.data.push(t)}p.series=["Series A"]}else{p.labels=[],p.data=[];for(t=0,a=0;a<e.length;a++){e[a].fecha=new Date(e[a].fecha);o=$.grep(e,function(t){return t.fecha=new Date(t.fecha),t.fecha.getMonth()==e[a].fecha.getMonth()&&t.fecha.getFullYear()==e[a].fecha.getFullYear()});e=$.grep(e,function(t){return t.fecha=new Date(t.fecha),!(t.fecha.getMonth()==e[a].fecha.getMonth()&&t.fecha.getFullYear()==e[a].fecha.getFullYear())}),a=-1;for(n=t=0;n<o.length;n++)t+=o[n].total;p.labels.push(o[0].fecha.getMonth()+1),p.data.push(t)}p.series=["Series A"]}g.stop()})},p.cerrarPopupFiltroGraficos=function(){p.cerrarPopup(p.idModalFiltroGraficos)},p.cerrarPopupUsuarioComision=function(){p.cerrarPopup(p.idModalUsuarioComision)},p.verComisionesVendedores=function(t,e){g.start(),p.abrirPopup(p.idModalUsuarioComision),t=new Date(p.convertirFecha(t)),e=new Date(p.convertirFecha(e)),d(p.usuario.id_empresa,t,e).then(function(t){p.labels=[],p.data=[];for(var e=0;e<t.length;e++){p.labels.push(t[e].persona.nombre_completo);for(var a=0,o=0;o<t[e].ventas.length;o++)for(var n=0;n<t[e].ventas[o].detallesVenta.length;n++)t[e].comision_activa?a+=t[e].comision_general:a+=t[e].ventas[o].detallesVenta[n].producto.comisionesVendedores[0].comision;p.data.push(a)}p.series=["Series A"],g.stop()})},p.cerrarCajaUsuarioRuta=function(l,t){g.start();var e=p.obtenerDiaActual(),a=$.grep(t.dias,function(t){return t.dia.nombre_corto==e}),c=100,u=1;if(0<a.length){var d=new PDFDocument({size:[612,792],margin:0}),h=d.pipe(blobStream());d.font("Helvetica-Bold",15),d.text("CIERRE DE CAJA",55,50),d.font("Helvetica-Bold",8),f(l.id,e).then(function(t){d.text("VENTAS",75,80),d.text("No.",100,100),d.text("Fecha",150,100),d.text("Cliente",200,100),d.text("Total",350,100),d.text("Comision",400,100),d.text("T. Comision",450,100),d.text("Tipo Venta",500,100),d.font("Helvetica",8);for(var e=0,a=0,o=0,n=0;n<t[0].ruta.clientes.length;n++)for(var r=0;r<t[0].ruta.clientes[n].cliente.ventas.length;r++){t[0].ruta.clientes[n].cliente.ventas[r].fecha=new Date(t[0].ruta.clientes[n].cliente.ventas[r].fecha),d.text("No. "+u,100,c+20),d.text(t[0].ruta.clientes[n].cliente.ventas[r].fecha.getDate()+"/"+(t[0].ruta.clientes[n].cliente.ventas[r].fecha.getMonth()+1)+"/"+t[0].ruta.clientes[n].cliente.ventas[r].fecha.getFullYear(),150,c+20),d.text(t[0].ruta.clientes[n].cliente.razon_social,200,c+20);var i=t[0].ruta.clientes[n].cliente.ventas[r].tipoPago.nombre==p.diccionario.TIPO_PAGO_CREDITO?t[0].ruta.clientes[n].cliente.ventas[r].a_cuenta:t[0].ruta.clientes[n].cliente.ventas[r].total;d.text(i,350,c+20),e+=i,l.comision_activa&&(d.text(l.comision_general+"%",400,c+20),d.text(t[0].ruta.clientes[n].cliente.ventas[r].total*l.comision_general/100,450,c+20),a+=t[0].ruta.clientes[n].cliente.ventas[r].total*l.comision_general/100),d.text(t[0].ruta.clientes[n].cliente.ventas[r].tipoPago.nombre,500,c+20),c+=20,u++}d.font("Helvetica-Bold",8),d.text("Totales",200,c+20),d.text(e,350,c+20),d.text(a,450,c+20),c+=20,d.text("COBROS",75,c+20),c+=20,d.text("No.",100,c+20),d.text("Fecha",150,c+20),d.text("Cliente",200,c+20),d.text("Total",350,c+20),d.text("Pago",400,c+20),d.font("Helvetica",8),c+=20,u=1;for(n=0;n<t[0].usuario.pagos.length;n++){t[0].usuario.pagos[n].createdAt=new Date(t[0].usuario.pagos[n].createdAt),d.text("No. "+u,100,c+20),d.text(t[0].usuario.pagos[n].createdAt.getDate()+"/"+(t[0].usuario.pagos[n].createdAt.getMonth()+1)+"/"+t[0].usuario.pagos[n].createdAt.getFullYear(),150,c+20),d.text(t[0].usuario.pagos[n].venta.cliente.razon_social,200,c+20),d.text(t[0].usuario.pagos[n].monto_pagado,350,c+20),o+=t[0].usuario.pagos[n].monto_pagado;var s=t[0].usuario.pagos[n].saldo_anterior==t[0].usuario.pagos[n].monto_pagado?"Total":"A/C";d.text(s,400,c+20),c+=20,u++}d.font("Helvetica-Bold",8),d.text("Totales",200,c+20),d.text(o,350,c+20),d.text("RESUMEN",200,c+40),d.text("Ventas",200,c+50),d.text("Cobros",200,c+60),d.text(e,280,c+50),d.text(o,280,c+60),d.text("Total a entregar",200,c+70),d.text(e+o,280,c+70),c+=40,d.text("---------------------------------------------                       ---------------------------------------------                       ---------------------------------------------",0,c+100,{align:"center"}),d.text("ENTREGUE CONFORME                                               RECIBI CONFORME                                               VoBo                         ",0,c+130,{align:"center"}),d.text("NOMBRE                                                        NOMBRE                                                       NOMBRE                         ",0,c+145,{align:"center"}),d.text("CI                                                              CI                                                              CI                           ",0,c+160,{align:"center"}),g.stop(),d.end(),h.on("finish",function(){var t=h.toBlobURL("application/pdf");window.open(t,"_blank","location=no")})})}else p.mostrarMensaje("¡No existe ventas en el dia para esta Ruta y Usuario!"),g.stop()},p.$on("$routeChangeStart",function(t,e){p.eliminarPopup(p.idModalSeguimientoVentas),p.eliminarPopup(p.idModalFiltroExcel),p.eliminarPopup(p.idModalFiltroGraficos),p.eliminarPopup(p.idModalUsuarioComision)}),p.inicio()}]);