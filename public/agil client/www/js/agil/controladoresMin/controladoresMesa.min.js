angular.module("agil.controladores").controller("ControladorMesa",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ListaSalas","ListaGruposProductoEmpresa","ProductosPanel","Sala","Mesa","ClasesTipo","MesaPedidoRestaurante","PedidoRestaurante","PedidoRestauranteActualizacion","MesaActualizacion","$timeout","Venta","ImprimirSalida","ListaInventariosProducto","InactivarPedido","ClientesNit","ActualizarGarzon","CrearGarzon","Garzon","ListaGarzones","EliminacionMesaPedidoRestaurante",function(d,e,a,o,t,u,n,i,r,s,c,l,p,m,g,f,P,v,M,R,z,b,h,_,E,w,G){u.start(),d.usuario=JSON.parse(e.usuario),d.idModalPanelPedido="dialog-panel-ventas",d.idModalSalaEdicion="modal-wizard-sala-edicion",d.idModalContenedorSalaEdicion="modal-wizard-container-sala-edicion",d.idModalMesaEdicion="modal-wizard-mesa-edicion",d.idModalContenedorMesaEdicion="modal-wizard-container-mesa-edicion",d.idModalGarzonEdicion="modal-wizard-garzon-edicion",d.idModalContenedorGarzonEdicion="modal-wizard-container-garzon-edicion",d.idModalFacturacion="modal-wizard-facturacion",d.idModalContenedorFacturacion="modal-wizard-container-facturacion",d.idModalReserva="modal-wizard-reserva",d.idModalContenedorReserva="modal-wizard-container-reserva",d.idModalCambioMesa="modal-wizard-cambio-mesa",d.idModalContenedorCambioMesa="modal-wizard-container-cambio-mesa",d.idModalUnionMesas="modal-wizard-union-mesas",d.idModalContenedorUnionMesas="modal-wizard-container-union-mesas",d.idModalAsignacionGarzon="modal-wizard-asignacion-garzon",d.idModalContenedorAsignacionGarzon="modal-wizard-container-asignacion-garzon",d.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsMesas(d.idModalPanelPedido,d.idModalSalaEdicion,d.idModalContenedorSalaEdicion,d.idModalMesaEdicion,d.idModalContenedorMesaEdicion,d.idModalGarzonEdicion,d.idModalContenedorGarzonEdicion,d.idModalFacturacion,d.idModalContenedorFacturacion,d.idModalReserva,d.idModalContenedorReserva,d.idModalCambioMesa,d.idModalContenedorCambioMesa,d.idModalUnionMesas,d.idModalContenedorUnionMesas,d.idModalAsignacionGarzon,d.idModalContenedorAsignacionGarzon),d.buscarAplicacion(d.usuario.aplicacionesUsuario,a.path().substring(1)),u.stop()}),d.inicio=function(){u.start(),l("EM").then(function(e){d.estadosMesa=e.clases,u.stop()}),d.sucursales=d.obtenerSucursales(),d.obtenerMovimientosEgreso(),d.obtenerTiposDePago(),d.obtenerGarzones()},d.obtenerMovimientosEgreso=function(){u.start(),l("MOVEGR").then(function(e){d.movimientosEgreso=e.clases,u.stop()})},d.obtenerTiposDePago=function(){u.start(),l("TIPA").then(function(e){d.tiposPago=e.clases,u.stop()})},d.obtenerSalas=function(e){u.start(),d.obtenerAlmacenes(e),n(e).then(function(e){d.salas=e,d.mesas=[],u.stop()})},d.obtenerSucursales=function(){for(var e=[],a=0;a<d.usuario.sucursalesUsuario.length;a++)e.push(d.usuario.sucursalesUsuario[a].sucursal);return e},d.obtenerAlmacenes=function(a){d.almacenes=[];var e=$.grep(d.sucursales,function(e){return e.id==a})[0];d.almacenes=e.almacenes,d.filtro.almacen=1==d.almacenes.length?d.almacenes[0]:null},d.obtenerGarzones=function(){u.start(),w(d.usuario.empresa.id).then(function(e){d.garzones=e,d.llenarGarzonesOpciones(),u.stop()})},d.cargarProductosPanel=function(){r(d.usuario.id_empresa,d.filtro.almacen.id).then(function(e){for(var a=0;a<e.length;a++)e[a].activar_inventario&&(e[a].inventario_disponible=d.obtenerInventarioTotal(e[a]));d.productos=e,d.productosProcesados=e})},d.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario)for(var o=0;o<e.inventarios.length;o++)a+=e.inventarios[o].cantidad;else a=5e5;return a},d.verSala=function(e){d.salaVista=e,d.mesas=e.mesas,d.llenarMesasOpciones()},d.llenarMesasOpciones=function(){d.mesas_unidas=[];for(var e=0;e<d.mesas.length;e++){var a={name:d.mesas[e].numero+"",numero:d.mesas[e].numero,maker:"",ticked:!1,id:d.mesas[e].id};d.mesas_unidas.push(a)}},d.llenarGarzonesOpciones=function(){d.garzonesOpciones=[];for(var e=0;e<d.garzones.length;e++){var a={name:d.garzones[e].persona.nombre_completo,maker:"",ticked:!1,id:d.garzones[e].id,persona:{imagen:d.garzones[e].persona.imagen}};d.garzonesOpciones.push(a)}},d.verGarzon=function(e){d.garzon=e,d.garzonVista=e,d.abrirPopup(d.idModalGarzonEdicion),null!=d.garzon&&(d.garzon.persona.imagen="img/icon-user-default.png")},d.obtenerGruposProductoEmpresa=function(){i(d.usuario.id_empresa).then(function(e){d.grupos_productos=e})},d.verPedido=function(o){d.cargarProductosPanel(),p(o.id,d.filtro.almacen.id).then(function(e){if(e.pedidosRestaurante){d.pedidoRestaurante=e.pedidosRestaurante[0].pedidoRestaurante;for(var a=0;a<d.pedidoRestaurante.detallesPedidoRestaurante.length;a++)d.pedidoRestaurante.detallesPedidoRestaurante[a].producto.activar_inventario?d.pedidoRestaurante.detallesPedidoRestaurante[a].costos=d.pedidoRestaurante.detallesPedidoRestaurante[a].producto.inventarios:d.pedidoRestaurante.detallesPedidoRestaurante[a].costos=[]}else d.pedidoRestaurante=new m({detallesPedidoRestaurante:[],mesas:[],pedido_activo:!0,garzones:[]}),d.pedidoRestaurante.mesas.push(o);d.obtenerGruposProductoEmpresa(),d.abrirPopup(d.idModalPanelPedido),d.sumarTotal(),d.sumarTotalImporte(),setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},d.liberarMesa=function(a){p(a.id,d.filtro.almacen.id).then(function(e){e.pedidosRestaurante?d.mostrarMensaje("La mesa no puede ser liberada porque aun existe un pedido pendiente!"):(a.estado=$.grep(d.estadosMesa,function(e){return e.nombre_corto==d.diccionario.ESTADO_MESA_DISPONIBLE})[0],f.update({id_mesa:a.id},a,function(e){u.stop(),d.mostrarMensaje("Mesa liberada exitosamente!")}))})},d.reservarMesa=function(e){d.mesa=e,d.abrirPopup(d.idModalReserva)},d.crearReserva=function(){d.abrirPopup(d.idModalReserva)},d.guardarPedidoRestaurante=function(e,a){if(e)if(a.id)g.update({id_pedido_restaurante:a.id},a,function(e){u.stop(),d.cerrarPedido(),d.mostrarMensaje("Pedido actualizado Exitosamente!")});else{var o=a.mesas;a.$save(function(e){for(var a=0;a<o.length;a++)o[a].estado=e;u.stop(),d.cerrarPedido(),d.mostrarMensaje("Pedido guardado Exitosamente!")},function(e){u.stop(),d.cerrarPedido(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},d.abrirPopupDatosFacturacion=function(){d.venta=new v({cliente:{},pagado:0}),d.abrirPopup(d.idModalFacturacion)},d.buscarNit=function(a,e){13===a.which&&b(d.usuario.id_empresa,e).then(function(e){1==e.length||1<e.length?d.establecerCliente(e[0]):d.venta.cliente.razon_social=null,d.interceptarTecla(a,"razon_social",!0)})},d.interceptarTecla=function(e,a,o){13===e.which&&(o?d.enfocar(a):P(function(){$("#"+a).trigger("click")},0))},d.cerrarPopupFacturacion=function(){d.cerrarPopup(d.idModalFacturacion)},d.cerrarPopupReserva=function(){d.cerrarPopup(d.idModalReserva)},d.enfocar=function(e){P(function(){$("#"+e).focus()},0)},d.establecerCliente=function(e){d.venta.cliente=e,d.enfocar("razon_social")},d.calcularCambio=function(){d.venta.cambio=Math.round(100*(d.venta.pagado-d.pedidoRestaurante.total))/100,d.pagoMinimo=d.pedidoRestaurante.total},d.facturarPedidoRestaurante=function(){if("Siguiente"!=$("#siguienteFacturacion").text().trim()){u.start(),d.venta.total=d.pedidoRestaurante.total,d.venta.importe=d.pedidoRestaurante.importe,d.venta.id_usuario=d.usuario.id,d.venta.id_empresa=d.usuario.empresa.id,d.venta.detallesVentaNoConsolidadas=[],d.venta.fecha=new Date,d.venta.fechaTexto=d.venta.fecha.getDate()+"/"+(d.venta.fecha.getMonth()+1)+"/"+d.venta.fecha.getFullYear(),d.venta.almacen=d.filtro.almacen,d.venta.sucursal=d.filtro.sucursal,d.venta.actividad=d.filtro.sucursal.actividadesDosificaciones[0].actividad,d.venta.detallesVenta=d.pedidoRestaurante.detallesPedidoRestaurante,d.venta.movimiento=$.grep(d.movimientosEgreso,function(e){return e.nombre_corto==d.diccionario.EGRE_FACTURACION})[0],d.venta.tipoPago=$.grep(d.tiposPago,function(e){return e.nombre==d.diccionario.TIPO_PAGO_CONTADO})[0];var n=d.venta.movimiento.nombre_corto;d.venta.$save(function(e){if(d.pedidoRestaurante.id)z.update({id:d.pedidoRestaurante.id},d.pedidoRestaurante,function(e){for(var a=0;a<d.pedidoRestaurante.mesasPedidoRestaurante.length;a++){var o=$.grep(d.mesas,function(e){return e.id==d.pedidoRestaurante.mesasPedidoRestaurante[a].mesa.id})[0];d.liberarMesa(o)}u.stop()});else{console.log(d.pedidoRestaurante),d.pedidoRestaurante.pedido_activo=!1;var a=Object.create(d.pedidoRestaurante);d.guardarPedidoRestaurante(!0,d.pedidoRestaurante);for(var o=0;o<a.mesas.length;o++){var t=$.grep(d.mesas,function(e){return e.id==a.mesas[o].id})[0];d.liberarMesa(t)}}M(n,e,!0,d.usuario),d.cerrarPopup(d.idModalFacturacion),d.cerrarPedido(),d.mostrarMensaje("Venta registrada exitosamente!"),u.stop()},function(e){u.stop(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},d.eliminarDetallePedidoRestaurante=function(e){e.eliminado=!0,d.sumarTotal(),d.sumarTotalImporte()},d.disminuirDetallePedidoRestaurante=function(e){1==e.cantidad?d.eliminarDetallePedidoRestaurante(e):(e.cantidad=e.cantidad-1,d.calcularImporteDetallePedido(e),d.sumarTotal(),d.sumarTotalImporte())},d.agregarDetallePedido=function(e){var a;if(d.cantidadInventario=0,e.activar_inventario)for(var o=0;o<e.inventarios.length;o++)d.cantidadInventario=d.cantidadInventario+e.inventarios[o].cantidad;for(var t=0,n=!1;t<d.pedidoRestaurante.detallesPedidoRestaurante.length&&!n;)d.pedidoRestaurante.detallesPedidoRestaurante[t].eliminado||d.pedidoRestaurante.detallesPedidoRestaurante[t].producto.id!=e.id||(e.activar_inventario?d.pedidoRestaurante.detallesPedidoRestaurante[t].cantidad+1<=d.cantidadInventario?d.pedidoRestaurante.detallesPedidoRestaurante[t].cantidad=d.pedidoRestaurante.detallesPedidoRestaurante[t].cantidad+1:d.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+d.cantidadInventario+"!"):d.pedidoRestaurante.detallesPedidoRestaurante[t].cantidad=d.pedidoRestaurante.detallesPedidoRestaurante[t].cantidad+1,n=!0,a=d.pedidoRestaurante.detallesPedidoRestaurante[t]),t++;n?d.calcularImporteDetallePedido(a):e.activar_inventario?1<=d.cantidadInventario?(a={producto:e,precio_unitario:e.precio_unitario,inventario_disponible:d.cantidadInventario,costos:e.inventarios,cantidad:1,descuento:e.descuento,tipo_descuento:0<e.descuento,recargo:0,ice:0,excento:0,tipo_recargo:!1},d.pedidoRestaurante.detallesPedidoRestaurante.push(a),d.calcularImporteDetallePedido(a)):d.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+d.cantidadInventario+"!"):(a={producto:e,precio_unitario:e.precio_unitario,inventario_disponible:d.cantidadInventario,costos:[],cantidad:1,descuento:e.descuento,tipo_descuento:0<e.descuento,recargo:0,ice:0,excento:0,tipo_recargo:!1},d.pedidoRestaurante.detallesPedidoRestaurante.push(a),d.calcularImporteDetallePedido(a)),d.sumarTotal(),d.sumarTotalImporte()},d.sumarTotalImporte=function(){for(var e=0,a=0;a<d.pedidoRestaurante.detallesPedidoRestaurante.length;a++)d.pedidoRestaurante.detallesPedidoRestaurante[a].eliminado||(e+=d.pedidoRestaurante.detallesPedidoRestaurante[a].importe);d.pedidoRestaurante.importe=Math.round(1e3*e)/1e3},d.sumarTotal=function(){for(var e=0,a=0;a<d.pedidoRestaurante.detallesPedidoRestaurante.length;a++)d.pedidoRestaurante.detallesPedidoRestaurante[a].eliminado||(e+=d.pedidoRestaurante.detallesPedidoRestaurante[a].total);d.pedidoRestaurante.total=Math.round(1e3*e)/1e3},d.calcularImporteDetallePedido=function(e){var a,o;e.importe=Math.round(e.cantidad*e.precio_unitario*1e3)/1e3,a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,o=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+o-e.ice-e.excento},d.cerrarPedido=function(){d.cerrarPopup(d.idModalPanelPedido)},d.clasificarGrupo=function(e){d.productosProcesados=$filter("filter")(d.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},d.ordenarProductos=function(e){console.log(e),d.productosProcesados=$filter("orderBy")(d.productos,["nombre"],e),d.ordenProductos=!e,setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},d.filtrarProductos=function(e){d.productosProcesados=$filter("filter")(d.productos,e),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},d.cambiarColor=function(e,a){$("#dialog-panel-ventas .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-ventas .widget-main").addClass(e),$("#dialog-panel-ventas .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-ventas .widget-main .button-style").addClass(a)},d.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},d.crearSala=function(e){d.sala=new s({id_sucursal:e}),d.abrirPopup(d.idModalSalaEdicion),$("#sala_step_1").trigger("click")},d.crearMesa=function(e){d.mesa=new c({id_sala:e,imagen:"img/table.png"}),d.mesa.estado=$.grep(d.estadosMesa,function(e){return e.nombre_corto==d.diccionario.ESTADO_MESA_DISPONIBLE})[0],d.abrirPopup(d.idModalMesaEdicion),$("#mesa_step_1").trigger("click")},d.crearGarzon=function(e){d.garzon=new _({id_empresa:d.usuario.id_empresa,persona:{imagen:"img/icon-user-default.png"}}),d.abrirPopup(d.idModalGarzonEdicion),$("#garzon_step_1").trigger("click")},d.cerrarPopPupEdicionSala=function(){d.cerrarPopup(d.idModalSalaEdicion)},d.cerrarPopPupEdicionMesa=function(){d.cerrarPopup(d.idModalMesaEdicion)},d.cerrarPopPupEdicionGarzon=function(){d.cerrarPopup(d.idModalGarzonEdicion)},d.guardarSala=function(a){"Siguiente"!=$("#siguiente").text().trim()&&(u.start(),a.id?s.update({id_sala:a.id},a,function(e){u.stop(),d.cerrarPopPupEdicionSala(),d.mostrarMensaje("Sala actualizada Exitosamente!")}):a.$save(function(e){u.stop(),d.cerrarPopPupEdicionSala(),d.obtenerSalas(a.id_sucursal),d.mostrarMensaje("Sala guardada Exitosamente!")},function(e){u.stop(),d.cerrarPopPupEdicionSala(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!")}))},d.guardarMesa=function(e){if("Siguiente"!=$("#siguienteMesa").text().trim()){u.start();var a=e.estado;e.id?c.update({id_mesa:e.id},e,function(e){u.stop(),d.cerrarPopPupEdicionMesa(),d.mostrarMensaje("Mesa actualizada Exitosamente!")}):e.$save(function(e){e.estado=a,d.salaVista.mesas.push(e),u.stop(),d.cerrarPopPupEdicionMesa(),d.mostrarMensaje("Mesa guardada Exitosamente!")},function(e){u.stop(),d.cerrarPopPupEdicionMesa(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},d.guardarGarzon=function(e){if(d.garzon=e,"Siguiente"!=$("#siguienteGarzon").text().trim()){u.start();var s=e.persona.imagen;e.id?h.update({id_garzon:e.id},d.garzon,function(e){if(null==e.signedRequest)d.obtenerGarzones(),u.stop(),d.cerrarPopPupEdicionGarzon(),d.mostrarMensaje("Garzon actualizado Exitosamente!");else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(d.obtenerGarzones(),u.stop(),d.cerrarPopPupEdicionGarzon(),d.mostrarMensaje("Garzon actualizado Exitosamente!")):alert("Could not upload file."))};for(var o=atob(s.split(",")[1]),t=[],n=0;n<o.length;n++)t.push(o.charCodeAt(n));var i=new Blob([new Uint8Array(t)],{type:"image/jpeg"}),r=new File([i],e.image_name,{type:"image/jpeg"});console.log(r),a.send(r)}}):e.$save(function(e){if(null==e.signedRequest)d.verGarzon(),d.obtenerGarzones(),u.stop(),d.cerrarPopPupEdicionGarzon(),d.mostrarMensaje("Garzon guardado Exitosamente!");else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(d.verGarzon(),d.obtenerGarzones(),u.stop(),d.cerrarPopPupEdicionGarzon(),d.mostrarMensaje("Garzon guardado Exitosamente!")):alert("Could not upload file."))};for(var o=atob(s.split(",")[1]),t=[],n=0;n<o.length;n++)t.push(o.charCodeAt(n));var i=new Blob([new Uint8Array(t)],{type:"image/jpeg"}),r=new File([i],e.image_name,{type:"image/jpeg"});a.send(r)}},function(e){u.stop(),d.cerrarPopPupEdicionGarzon(),d.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},d.abrirPopupAsignacionGarzon=function(){if(d.llenarGarzonesOpciones(),d.pedidoRestaurante.garzones)for(var e=0;e<d.garzonesOpciones.length;e++)for(var a=0;a<d.pedidoRestaurante.garzones.length;a++)d.garzonesOpciones[e].id==d.pedidoRestaurante.garzones[a].id&&(d.garzonesOpciones[e].ticked=!0);else for(e=0;e<d.garzonesOpciones.length;e++)for(a=0;a<d.pedidoRestaurante.garzonesPedidoRestaurante.length;a++)d.garzonesOpciones[e].id==d.pedidoRestaurante.garzonesPedidoRestaurante[a].garzon.id&&(d.garzonesOpciones[e].ticked=!0);d.abrirPopup(d.idModalAsignacionGarzon)},d.abrirPopupUnionMesas=function(){if(d.llenarMesasOpciones(),d.pedidoRestaurante.mesas)for(var e=0;e<d.mesas_unidas.length;e++)for(var a=0;a<d.pedidoRestaurante.mesas.length;a++)d.mesas_unidas[e].id==d.pedidoRestaurante.mesas[a].id&&(d.mesas_unidas[e].ticked=!0);else for(e=0;e<d.mesas_unidas.length;e++)for(a=0;a<d.pedidoRestaurante.mesasPedidoRestaurante.length;a++)d.mesas_unidas[e].id==d.pedidoRestaurante.mesasPedidoRestaurante[a].mesa.id&&(d.mesas_unidas[e].ticked=!0);d.abrirPopup(d.idModalUnionMesas)},d.abrirPopupCambioMesa=function(){d.mesaAcambiar=null,d.abrirPopup(d.idModalCambioMesa)},d.cerrarPopupCambioMesa=function(){d.cerrarPopup(d.idModalCambioMesa)},d.cerrarPopupUnionMesas=function(){d.cerrarPopup(d.idModalUnionMesas)},d.cerrarPopupAsignacionGarzones=function(){d.cerrarPopup(d.idModalAsignacionGarzon)},d.cambiarMesa=function(a){d.pedidoRestaurante.mesas||z.update({id:d.pedidoRestaurante.id},d.pedidoRestaurante,function(e){for(var a=0;a<d.pedidoRestaurante.mesasPedidoRestaurante.length;a++){var o=$.grep(d.mesas,function(e){return e.id==d.pedidoRestaurante.mesasPedidoRestaurante[a].mesa.id})[0];d.liberarMesa(o)}d.guardarPedidoRestaurante(!0,d.pedidoRestaurante)}),d.pedidoRestaurante.mesas=[],d.pedidoRestaurante.mesas.push(a),$.grep(d.mesas,function(e){return e.id==a.id})[0].estado=$.grep(d.estadosMesa,function(e){return e.nombre_corto==d.diccionario.ESTADO_MESA_OCUPADO})[0],d.cerrarPopupCambioMesa()},d.estaMesaUnida=function(e){for(var a=!1,o=0,t=d.pedidoRestaurante.mesas?d.pedidoRestaurante.mesas:d.pedidoRestaurante.mesasPedidoRestaurante;o<t.length&&!a;){(t[o].mesa?t[o].mesa:t[o]).id==e.id&&(a=!0),o++}return a},d.unirMesas=function(e){for(var a=[],o=0;o<e.length;o++){if(!d.estaMesaUnida(e[o]))a.push(e[o]),p(e[o].id,d.filtro.almacen.id).then(function(e){if(e.pedidosRestaurante)for(var a=e.pedidosRestaurante[0].pedidoRestaurante,o=0;o<a.detallesPedidoRestaurante.length;o++){a.detallesPedidoRestaurante[o].producto.activar_inventario?a.detallesPedidoRestaurante[o].costos=a.detallesPedidoRestaurante[o].producto.inventarios:a.detallesPedidoRestaurante[o].costos=[];for(var t=0;t<a.detallesPedidoRestaurante[o].cantidad;t++)d.agregarDetallePedido(a.detallesPedidoRestaurante[o].producto)}d.sumarTotal(),d.sumarTotalImporte()})}if(0<a.length){for(var t="",n=0;n<a.length;n++)t=n==a.length-1?t+""+a[n].id:a[n].id+","+t;new G({id:t}).$delete(function(){d.pedidoRestaurante.mesas=e,g.update({id_pedido_restaurante:d.pedidoRestaurante.id},d.pedidoRestaurante,function(e){u.stop(),d.cerrarPopupUnionMesas(),d.mostrarMensaje("Mesas Unidas satisfactoriamente!")})})}d.cerrarPopupUnionMesas(),d.mostrarMensaje("Mesas Unidas satisfactoriamente!")},d.estaGarzon=function(e){for(var a=!1,o=0,t=d.pedidoRestaurante.garzones?d.pedidoRestaurante.garzones:d.pedidoRestaurante.garzonesPedidoRestaurante;o<t.length&&!a;){(t[o].garzon?t[o].mesa:t[o]).id==e.id&&(a=!0),o++}return a},d.asignarGarzones=function(a){d.pedidoRestaurante.garzones=a,d.pedidoRestaurante.id?g.update({id_pedido_restaurante:d.pedidoRestaurante.id},d.pedidoRestaurante,function(e){d.pedidoRestaurante.garzones=a,u.stop(),d.cerrarPopupAsignacionGarzones(),d.mostrarMensaje("Garzones asignados satisfactoriamente!")}):(d.cerrarPopupAsignacionGarzones(),d.mostrarMensaje("Garzones asignados satisfactoriamente!"))},d.generarCuenta=function(e){var a=new PDFDocument({size:[227,350],margins:{top:10,bottom:10,left:20,right:20}});stream=a.pipe(blobStream()),a.font("Helvetica-Bold",14),a.moveDown(.8);var o="";if(e.mesas)for(var t=0;t<e.mesas.length;t++)o=o+" "+e.mesas[t].numero+",";else for(t=0;t<e.mesasPedidoRestaurante.length;t++)o=o+" "+e.mesasPedidoRestaurante[t].mesa.numero+",";a.text("MESAS: "+o,{align:"center"}),a.font("Helvetica",10),a.moveDown(.4),a.text("Cant.  Consumo                P/U           total",{align:"left"}),a.moveDown(.4);var n=a.y;for(t=0;t<e.detallesPedidoRestaurante.length;t++)a.font("Helvetica",9),a.text(e.detallesPedidoRestaurante[t].cantidad,20,n),a.text(e.detallesPedidoRestaurante[t].producto.nombre,30,n,{width:100}),a.text(e.detallesPedidoRestaurante[t].producto.precio_unitario.toFixed(2),140,n),a.text(e.detallesPedidoRestaurante[t].producto.precio_unitario*e.detallesPedidoRestaurante[t].cantidad,180,n),n+=20;a.x=20,a.font("Helvetica",10),a.moveDown(.4),a.text("Total Transacción:                         "+e.total.toFixed(2),{align:"left"}),a.moveDown(2),a.text("Por favor llene sus datos para la emision de factura:",{align:"left"}),a.moveDown(.4),a.text("Razon social:.........................................",{align:"left"}),a.moveDown(.4),a.text("...............................................................",{align:"left"}),a.moveDown(.4),a.text("Nit:.........................................................",{align:"left"}),a.moveDown(2);var i=new Date,r=i.getMinutes();r<10&&(r="0"+r),a.text(" Fecha : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+"  "+i.getHours()+":"+r+"  ",{align:"center"}),a.end(),stream.on("finish",function(){var e=stream.toBlobURL("application/pdf"),a=window.open(e,"_blank","location=no");P(function(){a.print()},500)})},d.obtenerMesasLibres=function(){if(d.mesas){for(var e=[],a=0;a<d.mesas.length;a++)d.mesas[a].estado.nombre_corto==d.diccionario.ESTADO_MESA_DISPONIBLE&&e.push(d.mesas[a]);return e}},d.$on("$routeChangeStart",function(e,a){d.eliminarPopup(d.idModalPanelPedido),d.eliminarPopup(d.idModalSalaEdicion),d.eliminarPopup(d.idModalMesaEdicion),d.eliminarPopup(d.idModalGarzonEdicion),d.eliminarPopup(d.idModalFacturacion),d.eliminarPopup(d.idModalReserva),d.eliminarPopup(d.idModalCambioMesa),d.eliminarPopup(d.idModalUnionMesas),d.eliminarPopup(d.idModalAsignacionGarzon)}),d.inicio()}]);