angular.module("agil.controladores").controller("ControladorOperaciones",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","blockUI","ConfiguracionVentaVistaDatos","ClasesTipo","ListaGruposProductoEmpresa","ProductosOperaciones","socket","ListaGruposProductoEmpresa","SolicitudesReposicion","SolicitudesFormulacionProducto","SolicitudReposicion","EliminarSolicitudReposicion","Paginator","ImpresionSolicitudDatos","ListaInventariosProducto","ListaSucursalesUsuario","ListaGruposProductoUsuario","CerrarSolicitud","Solicitud","ProveedoresNit","ListaProductosEmpresaUsuario","$timeout","GuardarPedido","ListaProveedores","ProductosPaginadorSubgrupos","ListaProductosProveedores","ProductosPaginadorAsignados","ActualizarProductosProveedor","ListaSubGruposProductoEmpresa",function(v,e,o,i,a,t,r,s,g,d,n,c,u,l,c,p,f,P,m,h,S,b,_,D,x,k,E,M,C,I,w,j,A,B,V,T){v.usuarioSesion=JSON.parse(s.usuario),convertUrlToBase64Image(v.usuarioSesion.empresa.imagen,function(o){v.usuarioSesion.empresa.imagen=o}),v.idDialogDialogPanelOperaciones="dialog-panel-operaciones",v.idDialogDatos="modal-wizard-venta-edicion",v.idDialogEntregaViveres="dialogEntregaViveres",v.idConfirmacionCierre="dialog-confirmacion-entrega",v.idDialogTotalIngredientes="dialog-total-ingredientes",v.idDialogoListadoPedido="modal-listado-nuevo-pedido",v.idDialogoNuevoPedido="modal-nuevo-pedido",v.idDialogProductosProveedor="dialog-productos-proveedor-configuracion",v.idDialogBusquedaProveedor="dialog-Busqueda-proveedor",v.idDialogProductosAsigandosProveedor="dialog-productos-proveedor-asignados",v.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),C(function(){ejecutarScriptsOperaciones(v.idDialogDialogPanelOperaciones,v.idDialogDatos,v.idDialogEntregaViveres,v.idConfirmacionCierre,v.idDialogTotalIngredientes,v.idDialogoListadoPedido,v.idDialogoNuevoPedido,v.idDialogProductosProveedor,v.idDialogBusquedaProveedor,v.idDialogProductosAsigandosProveedor),v.buscarAplicacion(v.usuarioSesion.aplicacionesUsuario,t.path().substring(1))},500)}),v.$on("$routeChangeStart",function(o,e){v.eliminarPopup(v.idDialogDialogPanelOperaciones),v.eliminarPopup(v.idDialogDatos),v.eliminarPopup(v.idDialogEntregaViveres),v.eliminarPopup(v.idConfirmacionCierre),v.eliminarPopup(v.idDialogTotalIngredientes),v.eliminarPopup(v.idDialogoListadoPedido),v.eliminarPopup(v.idDialogoNuevoPedido),v.eliminarPopup(v.idDialogProductosProveedor),v.eliminarPopup(v.idDialogBusquedaProveedor),v.eliminarPopup(v.idDialogProductosAsigandosProveedor)}),v.inicio=function(){v.imprimir={detalle:!1},v.listaProductosProveedor=[],v.seleccionProductosProveedor={seleccionar_todos:!1},v.productosAsignadosPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},v.configuracionPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},v.detallesPedido=[],v.mostarBusquedaProducto=!1,v.ordenProductos=!0,v.esContado=!0,v.obtenerConfiguracionVentaVista(),v.alreadyCalculated=!1,v.sucursalesUsuario="";for(var o=0;o<v.usuarioSesion.sucursalesUsuario.length;o++)v.sucursalesUsuario=v.sucursalesUsuario+v.usuarioSesion.sucursalesUsuario[o].sucursal.id,o+1!=v.usuarioSesion.sucursalesUsuario.length&&(v.sucursalesUsuario=v.sucursalesUsuario+",");v.obtenerProveedores(),v.obtenerProductos(),v.obtenerProductosAsignados(),v.obtenerPaginador(),v.sucursales=v.obtenerSucursales(),v.obtenerSubGruposProductosEmpresaUsuario()},v.obtenerProveedores=function(){w(v.usuarioSesion.id_empresa).then(function(o){v.proveedores=o.proveedores,v.proveedoresProcesado=o.proveedores}).catch(function(o){v.proveedores=[];var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.data&&null!==o.data&&""!==o.data?o.data:"Error: Se perdio la conexión.";v.mostrarMensaje(e)})},v.filtrarProveedores=function(o){void 0!==v.proveedores?v.proveedoresProcesado=e("filter")(v.proveedores,o):v.proveedoresProcesado=[]},v.agregarProductosSeleccionados=function(){0<v.productosProveedorSeleccionados.length?v.productosProveedorSeleccionados.forEach(function(o,e,i){v.detallePedido={producto:o,precio_unitario:o.precio_unitario,cantidad:1,id_grupo:o.id_grupo,id_subgrupo:o.id_subgrupo},v.agregardetallePedido(v.detallePedido),e===i.length&&v.cerrarModalProductosAsignadosProveedor()}):v.mostrarMensaje("No se seleccionó ningún producto para ser agregado.")},v.establecerProveedor=function(o,e){v.productosAsignadosProveedor=[],void 0===v.pedido&&(v.pedido={}),v.pedido.proveedor=o,void 0!==e&&v.cerrarModalBusquedaProveedor(),v.pedido.por_proveedor&&v.generarPorProveedor()},v.abrirModalProductosProveedor=function(o){v.checkProveedor(o)?(v.buscarProductos(null,v.pedido),v.abrirPopup(v.idDialogProductosProveedor)):v.mostrarMensaje("Seleccione un proveedor para ver su asignación de productos..")},v.generarPorProveedor=function(){if(v.pedido.proveedor)if(v.pedido.por_proveedor)if(0<v.pedido.proveedor.productos.length){v.paginatorProductosAsignados.filter=v.productosAsignadosPorveedor.grupo?v.productosAsignadosPorveedor.grupo:{id:0};A(v.usuarioSesion.id_empresa,v.pedido.proveedor).then(function(o){if(o.hasErr)v.mostrarMensaje(o.mensaje),v.listaProductosProveedor=[];else if(o.productos){var e=o.productos.split(",");v.listaProductosProveedor=e.map(function(o){return parseInt(o)}),B(v.usuarioSesion.id_empresa,v.paginatorProductosAsignados,v.usuarioSesion.id,v.listaProductosProveedor,!0).then(function(o){o.hasErr?v.mostrarMensaje(o.mensaje):(v.paginatorProductosAsignados.setPages(o.paginas),v.productosAsignadosProveedor=o.productos,v.productosAsignadosProveedor.forEach(function(e){v.listaProductosProveedor.some(function(o){return o===e.id})&&(v.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,id_grupo:e.id_grupo,id_subgrupo:e.id_subgrupo},v.agregardetallePedido(v.detallePedido))})),g.stop()}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";v.mostrarMensaje(e)})}else v.mostrarMensaje("El proveedor no tiene productos asignados."),v.listaProductosProveedor=[];g.stop()}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";v.mostrarMensaje(e)})}else v.mostrarMensaje("El proveedor no tiene productos asignados.");else v.detallePedido={},v.detallesPedido=[];else v.mostrarMensaje("Seleccione un proveedor.")},v.verificarAsignacionProductosProveedor=function(){0<v.listaProductosProveedor.length&&v.listaProductosProveedor.forEach(function(e){v.productosAsignacionProveedor.forEach(function(o){o.id===e&&(o.seleccionado=!0)})})},v.checkProveedor=function(o){return!!v.pedido&&(!!v.pedido.proveedor&&!!v.pedido.proveedor.id)},v.buscarProveedor=function(o){if(""!=o&&null!=o)return E(v.usuario.id_empresa,o)},v.buscarProducto=function(o,e){if(void 0!==v.pedido)return""!=o&&null!=o&&null==e&&v.pedido.almacen?M(v.usuarioSesion.id_empresa,o,v.usuarioSesion.id,v.pedido.almacen):""!=o&&null!=o&&e&&v.pedido.almacen?M(v.usuarioSesion.id_empresa,o,v.usuarioSesion.id,v.pedido.almacen):void v.mostrarMensaje("Seleccione un almacen.");v.mostrarMensaje("Seleccione un almacen.")},v.establecerProducto=function(o,e){v.detallePedido={},o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto;var i=0;0<o.inventarios.length&&o.inventarios.forEach(function(o){i+=o.cantidad}),v.detallePedido={producto:o,precio_unitario:o.precio_unitario,cantidad:1,inventario_disponible:i}},v.nuevoPedido=function(){v.detallesPedido=[],v.pedido={},v.detallePedido={},v.abrirModalNuevoPedido()},v.generarPedido=function(){v.detallesPedido=[],v.pedido={generado:!0},v.detallePedido={};var o=v.calcularViveresDesdeFiltro(!0);v.detallesPedido=o.map(function(o){return 0<o.producto.inventarios.length&&o.producto.inventarios.forEach(function(o){o.cantidad}),{producto:o.producto,precio_unitario:o.producto.precio_unitario,cantidad:o.cantidad,solicitud:o.solicitud}}),v.abriridDialogoListadoPedido()},v.agregardetallePedido=function(e){null!=e?(v.detallesPedido.some(function(o){return o.producto.id===e.producto.id})?v.detallesPedido.forEach(function(o){o.producto.id===e.producto.id&&(o.cantidad+=e.cantidad)}):v.detallesPedido.push(e),v.detallePedido=void 0):v.mostrarMensaje("Ocurrió un problema, no se puede agregar un valor no definido o nulo.")},v.interceptarTecla=function(o,e,i){13===o.which&&(i?v.enfocar(e):C(function(){$("#"+e).trigger("click")},0))},v.mostrarBusqueda=function(){v.mostarBusquedaProducto?v.mostarBusquedaProducto=!1:v.mostarBusquedaProducto=!0},v.obtenerSubGruposProductosEmpresaUsuario=function(){g.start(),T(v.usuarioSesion.id_empresa,v.usuarioSesion.id).then(function(o){g.stop(),0<o.length?v.subGruposProducto=o:(v.subGruposProducto=[],v.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(o){v.subGruposProducto=[];var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.data&&null!==o.data&&""!==o.data?o.data:"Error: Se perdio la conexión.";v.mostrarMensaje(e),g.stop()})},v.obtenerPaginador=function(){g.start(),v.paginator=h(),v.paginator.column="fecha",v.paginator.direccion="asc",v.filtro={empresa:v.usuarioSesion.id_empresa,rol:v.usuarioSesion.rolesUsuario[0].rol.nombre,id:v.usuarioSesion.id,desde:0,hasta:0,sucursal:0,almacen:0,movimiento:0,estado:0,valuado:0,pagina:1,items_pagina:10,busqueda:""},v.paginator.callBack=v.obtenerSolicitudes,v.paginator.getSearch("",v.filtro,null),g.stop()},v.obtenerSolicitudes=function(){g.start(),v.filtro.busqueda=v.paginator.search,v.filtro.desde=void 0!==v.filtro.fechaInicioTexto&&""!==v.filtro.fechaInicioTexto?v.convertirFecha(v.filtro.fechaInicioTexto):0,v.filtro.hasta=void 0!==v.filtro.fechaFinTexto&&""!==v.filtro.fechaFinTexto?v.convertirFecha(v.filtro.fechaFinTexto):0,v.filtro.movimiento=0,v.filtro.estado=null!==v.filtro.estado&&void 0!==v.filtro.estado.id?v.filtro.estado.id:0,v.paginator.filter=v.filtro,p(v.paginator).then(function(o){v.paginator.setPages(o.paginas),v.solicitudesOperaciones=o.solicitudes,g.stop()}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";v.mostrarMensaje(e)})},v.obtenerSucursales=function(){for(var o=[],e=0;e<v.usuarioSesion.sucursalesUsuario.length;e++)o.push(v.usuarioSesion.sucursalesUsuario[e].sucursal);return o},v.obtenerAlmacenes=function(e){if(void 0===e&&(v.filtro.sucursal=void 0,v.almacenes=[]),void 0!==e){v.almacenes=[];var o=$.grep(v.sucursales,function(o){return o.id==e})[0];v.almacenes=o?o.almacenes:[]}},v.eliminar=function(o){v.solicitud=o,m(o).then(function(o){o.hasErr?v.mostrarMensaje(o.mensaje):(v.recargarItemsTabla(),v.solicitud=void 0),g.stop()}).catch(function(o){var e=(v.solicitud=void 0)!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:null!==o.data&&void 0!==o.data?o.data:"Se perdió la conexión.";v.mostrarMensaje(e),g.stop()}),v.cerrarConfirmacionEliminacion()},v.ver=function(o){v.solicitud=o,v.solicitud.ver=!0,v.solicitud.sucursal=v.solicitud.almacen.sucursal,v.obtenerAlmacenes(v.solicitud.sucursal.id),v.solicitud.almacen=v.solicitud.almacen,v.abrirDialogPanelOperaciones()},v.calcularTotalViveres=function(i,o){if(v.totalViveresSolicitados={},void 0===i)throw new Error("Hubo un problema con la solicitud, no esta definida!");v.solicitud=i,v.totalViveresSolicitados.usuario=i.usuario,v.totalViveresSolicitados.fecha=i.fecha,v.totalViveresSolicitados.sucursal=i.almacen.sucursal,v.totalViveresSolicitados.almacen=i.almacen,v.totalViveresSolicitados.identificador=i.id,v.totalViveresSolicitados.productos=[];var t=[];v.solicitud.solicitudesProductos.map(function(o){if(!1===o.eliminado||void 0===o.eliminado){if(o.productoSolicitado.activar_inventario){var e={estado:i.activo,almacen:i.almacen,cantidad_ideal:o.cantidad,cantidad_real:o.cantidad,id:o.id,id_detalle_solicitud_producto:o.id,id_producto_base:o.productoSolicitado,productoSolicitudBase:o.productoSolicitado,total:o.cantidad,monto:i.monto,solicitud:i.id};v.totalViveresSolicitados.productos.push(e)}0<o.detallesIngredientesProducto.length&&o.detallesIngredientesProducto.map(function(o){if(void 0===o.eliminado||!1===o.eliminado){var e={estado:i.activo,almacen:i.almacen,cantidad_ideal:o.cantidad_ideal,cantidad_real:o.cantidad_real,id:o.id,id_detalle_solicitud_producto:o.id_detalle_solicitud_producto,id_producto_base:o.id_producto_base,productoSolicitudBase:o.productoSolicitudBase,total:0,monto:i.monto,solicitud:i.id};t.push(e)}})}});var r=[];v.solicitud.solicitudesProductos.map(function(o){for(var a=0;a<t.length;)t.forEach(function(o,e,i){e<a&&t[a].id_producto_base===o.id_producto_base&&r.push(e)}),a+=1}),r.forEach(function(o){delete t[o]}),t.map(function(o){if(void 0!==o){var e={estado:i.activo,almacen:i.almacen,cantidad_ideal:0,cantidad_real:0,id:o.id,id_detalle_solicitud_producto:o.id_detalle_solicitud_producto,id_producto_base:o.id_producto_base,productoSolicitudBase:o.productoSolicitudBase,total:0,monto:i.monto,solicitud:i.id};v.totalViveresSolicitados.productos.push(e)}}),v.solicitadoTotalFinalBs=0;if(v.totalViveresSolicitados.productos.map(function(e){e.totalMostrar=0,v.solicitud.solicitudesProductos.map(function(o){o.detallesIngredientesProducto.map(function(o){e.id_producto_base==o.id_producto_base&&(e.cantidad_ideal+=o.cantidad_ideal,e.cantidad_real+=o.cantidad_real,e.totalMostrar+=o.total,e.total+=o.total,e.totalSumar=o.total,e.totalbs=e.totalSumar*o.productoSolicitudBase.precio_unitario,v.solicitadoTotalFinalBs+=e.totalbs)}),e.id_producto_base==o.id_producto&&(e.cantidad_ideal=1,e.cantidad_real=o.cantidad,e.totalMostrar=o.cantidad,e.totalSumar=o.cantidad,e.total=o.cantidad,e.totalbs=e.totalSumar*o.productoSolicitado.precio_unitario,v.solicitadoTotalFinalBs+=e.totalbs)})}),v.alreadyCalculated=!0,void 0!==o)return v.totalViveresSolicitados;void 0!==i?v.abrirDialogTotalIngredientes():v.solicitud=void 0},v.clasificarGrupo=function(o){v.productosProcesados=e("filter")(v.productos,o),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},v.verFormulacion=function(o){if(void 0!==v.productoSeleccionado&&o.productoSolicitado.id!=v.productoSeleccionado.productoSolicitado.id){var e=v.solicitud.solicitudesProductos.indexOf(o);v.solicitud.solicitudesProductos[e].verFormulacion=void 0,v.productoSeleccionado.verFormulacion=void 0}void 0===o.verFormulacion?o.verFormulacion=!0:o.verFormulacion=void 0,v.productoSeleccionado=o},v.eliminarDetalleVenta=function(o,e){void 0===o.id?v.solicitud.solicitudesProductos.splice(v.solicitud.solicitudesProductos.indexOf(o),1):(o.eliminado=!0,o.cantidad=0,o.detallesIngredientesProducto.map(function(o){o.eliminado=!0}))},v.eliminarIngrediente=function(o){if(void 0===o.id?v.productoSeleccionado.detallesIngredientesProducto.splice(v.productoSeleccionado.detallesIngredientesProducto.indexOf(o),1):o.eliminado=!0,0==v.productoSeleccionado.detallesIngredientesProducto.length)v.eliminarDetalleVenta(v.productoSeleccionado,!0);else{var e=0;v.productoSeleccionado.detallesIngredientesProducto.map(function(o){e+=!0===o.eliminado?1:0}),e==v.productoSeleccionado.detallesIngredientesProducto.length&&v.eliminarDetalleVenta(v.productoSeleccionado)}},v.disminuirDetalleVenta=function(e){1==e.cantidad?v.eliminarDetalleVenta(e,!0):(e.cantidad=e.cantidad-1,e.detallesIngredientesProducto.map(function(o){o.total=e.cantidad*o.cantidad_ideal}))},v.actualizarTotalReal=function(e){e.detallesIngredientesProducto.map(function(o){o.total=e.cantidad*o.cantidad_ideal})},v.obtenerConfiguracionVentaVista=function(){g.start(),d(v.usuarioSesion.id_empresa).then(function(o){v.configuracionVentaVista=o,g.stop()})},v.guardarConfiguracionVentaVista=function(){ConfiguracionVentaVista.update({id_empresa:v.usuarioSesion.id_empresa},v.configuracionVentaVista,function(o){})},v.enfocar=function(o){C(function(){$("#"+o).focus()},0)},v.interceptarTecla=function(o,e,i){13===o.which&&(i?v.enfocar(e):C(function(){$("#"+e).trigger("click")},0))},v.getFecha=function(){return void 0!==v.solicitud?new Date(v.solicitud.fecha):new Date},v.guardarOperacionPanel=function(o,i){g.start();var a=0;if(o){var e=v.calcularTotalViveres(i,!0);i.listaProductosSolicitados=e,i.solicitudesProductos.map(function(o){var e=0;void 0!==o.detallesIngredientesProducto?o.detallesIngredientesProducto.length<1?void 0!==o.eliminado&&!1!==o.eliminado||(e+=o.productoSolicitado.precio_unitario*o.cantidad):void 0!==o.eliminado&&!1!==o.eliminado||o.detallesIngredientesProducto.map(function(o){void 0!==o.eliminado&&!1!==o.eliminado||(e+=o.total*o.productoSolicitudBase.precio_unitario)}):void 0===o.eliminado&&(e+=o.productoSolicitado.precio_unitario*o.cantida),a+=e}),i.monto=a;var t=new Date,r=i.fecha.split("/").reverse();i.fecha=new Date(r[0],r[1]-1,r[2],t.getHours(),t.getMinutes()),i.id_usuario=v.usuarioSesion.id,i.activo=!0,k(i,v.usuarioSesion.id_empresa,i.modificar).then(function(o){o.hasErr?(v.mostrarMensaje(o.mensaje),i.fecha=new Date(i.fecha).toLocaleDateString()):(v.mostrarMensaje(o.mensaje),v.recargarItemsTabla()),g.stop()}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:null!==o.data&&void 0!==o.data?o.data:"Se perdió la conexión.";v.mostrarMensaje(e),i.fecha=new Date(i.fecha).toLocaleDateString(),g.stop()})}else v.mostrarMensaje("Complete los campos requeridos"),g.stop()},v.obtenerInventariosProdSolicitud=function(){v.solicitud.solicitudesProductos.map(function(e){b(e.productoSolicitado.id,v.solicitud.almacen.id).then(function(o){e.inventarios=o})})},v.obtenerInventarioTotal=function(i){var o=0;if(b(i.id,v.solicitud.almacen.id).then(function(o){i.inventarios=o;for(var e=0;e<i.inventarios.length;e++)i.inventarios[e].fecha_vencimiento=i.inventarios[e].fecha_vencimiento?new Date(i.inventarios[e].fecha_vencimiento):null,i.inventarios[e].fechaVencimientoTexto=i.inventarios[e].fecha_vencimiento?i.inventarios[e].fecha_vencimiento.getDate()+"/"+(i.inventarios[e].fecha_vencimiento.getMonth()+1)+"/"+i.inventarios[e].fecha_vencimiento.getFullYear():"",i.inventarios[e].detallesMovimiento[0].movimiento.fecha=new Date(i.inventarios[e].detallesMovimiento[0].movimiento.fecha),i.inventarios[e].detallesMovimiento[0].movimiento.fechaTexto=i.inventarios[e].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(i.inventarios[e].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+i.inventarios[e].detallesMovimiento[0].movimiento.fecha.getFullYear()}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:null!==o.data&&void 0!==o.data?o.data:"Se perdió la conexión.";return v.mostrarMensaje(e),0}),i.activar_inventario){for(var e=0;e<i.inventarios.length;e++)o+=i.inventarios[e].cantidad;if(void 0!==v.solicitud.solicitudesProductos&&v.solicitud.copia)for(var a=0;a<v.solicitud.solicitudesProductos.length;a++)v.solicitud.solicitudesProductos[a].productoSolicitado.id==i.id&&(o-=v.solicitud.solicitudesProductos[a].cantidad)}else o=5e5;return o},v.cargarProductos=function(){u(v.usuarioSesion.id_empresa,v.solicitud.almacen.id,v.usuarioSesion.id).then(function(o){if(0<o.length){for(var e=0;e<o.length;e++)o[e].activar_inventario&&(o[e].inventario_disponible=v.obtenerInventarioTotal(o[e]));v.productos=o}else v.productos=[];if(angular.isDefined(s.productosProcesados)){v.productosProcesados=o;for(e=0;e<s.productosProcesados.length;e++)for(var i=0;i<v.productosProcesados.length;i++)s.productosProcesados[e].id==v.productosProcesados[i].id&&(v.productosProcesados[i].rankin=s.productosProcesados[e].rankin)}else v.productosProcesados=o;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},v.agregarDetalleVentaPanel=function(e){v.cantidadInventario=0;var i={productoSolicitado:e,precio_unitario:e.precio_unitario,inventario_disponible:v.cantidadInventario,inventarios:e.inventarios,cantidad:1,detallesIngredientesProducto:[]};if(e.activar_inventario){v.cantidadInventario=e.inventario_disponible;var a=0,o=!1;if(void 0===v.solicitud.solicitudesProductos&&(v.solicitud.solicitudesProductos=[]),1<=v.cantidadInventario){for(;a<v.solicitud.solicitudesProductos.length&&!o;)void 0===v.solicitud.solicitudesProductos[a].eliminado&&v.solicitud.solicitudesProductos[a].productoSolicitado.id==e.id&&(v.solicitud.solicitudesProductos[a].cantidad=v.solicitud.solicitudesProductos[a].cantidad+1,v.solicitud.solicitudesProductos[a].eliminado=void 0,v.solicitud.solicitudesProductos[a].detallesIngredientesProducto.map(function(o){o.total=o.cantidad_ideal*v.solicitud.solicitudesProductos[a].cantidad}),o=!0,i=v.solicitud.solicitudesProductos[a]),a++;if(o)e.eliminado=void 0;else{var t=f(e.id),r=[];t.then(function(o){o.productosBase&&o.productosBase.forEach(function(o){ingrediente={cantidad_ideal:parseFloat(o.formulacion),cantidad_real:parseFloat(o.formulacion),total:parseFloat(o.formulacion),id_producto_base:o.productoBase.id,productoSolicitudBase:o.productoBase},r.push(ingrediente)})}),e.activar_inventario?1<=v.cantidadInventario?(i={productoSolicitado:e,precio_unitario:e.precio_unitario,inventario_disponible:v.cantidadInventario,inventarios:e.inventarios,cantidad:1,detallesIngredientesProducto:r},v.solicitud.solicitudesProductos.push(i)):v.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+v.cantidadInventario+"!"):(i={productoSolicitado:e,precio_unitario:e.precio_unitario,inventario_disponible:v.cantidadInventario,inventarios:e.inventarios,cantidad:1,detallesIngredientesProducto:r},v.solicitud.solicitudesProductos.push(i))}}else v.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+v.cantidadInventario+"!")}else{a=0,o=!1;if(v.solicitud.solicitudesProductos)for(;a<v.solicitud.solicitudesProductos.length&&!o;)void 0===v.solicitud.solicitudesProductos[a].eliminado&&v.solicitud.solicitudesProductos[a].productoSolicitado.id==e.id&&(v.solicitud.solicitudesProductos[a].cantidad=v.solicitud.solicitudesProductos[a].cantidad+1,v.solicitud.solicitudesProductos[a].eliminado=void 0,v.solicitud.solicitudesProductos[a].detallesIngredientesProducto.map(function(o){o.total=o.cantidad_ideal*v.solicitud.solicitudesProductos[a].cantidad}),o=!0,i=v.solicitud.solicitudesProductos[a]),a++;else v.solicitud.solicitudesProductos=[];if(o)e.eliminado=void 0;else{t=f(e.id),r=[];t.then(function(o){o.productosBase&&o.productosBase.forEach(function(o){ingrediente={cantidad_ideal:parseFloat(o.formulacion),cantidad_real:parseFloat(o.formulacion),total:parseFloat(o.formulacion),id_producto_base:o.productoBase?o.productoBase.id:null,productoSolicitudBase:o.productoBase},r.push(ingrediente)}),i={productoSolicitado:e,precio_unitario:e.precio_unitario,inventario_disponible:v.cantidadInventario,inventarios:e.inventarios,cantidad:1,detallesIngredientesProducto:r},v.solicitud.solicitudesProductos.push(i)})}}e.rankin+=1;var d=v.productosProcesados.indexOf(e);v.productosProcesados[d]=e,s.productosProcesados=v.productosProcesados},v.filtrarProductos=function(o){v.productosProcesados=e("filter")(v.productos,o),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},v.confirmarEntrega=function(o){v.solicitudCerrar=o,v.abrirDialogConfirmacionCierre()},v.cerrarSolicitud=function(e){g.start();var o=v.calcularTotalViveres(e,!0);e.listaProductosSolicitados=o,x(e,v.usuarioSesion.id_empresa).then(function(o){o.hasErr?v.mostrarMensaje(o.mensaje):(v.mostrarMensaje(o.mensaje),v.solicitudCerrar=void 0,e.activo=!1,v.solicitud=void 0,v.cerrarDialogConfirmacionCierre()),g.stop()}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:null!==o.data&&void 0!==o.data?o.data:"Se perdió la conexión.";v.mostrarMensaje(e),g.stop()})},v.editar=function(o){v.solicitud=o,v.solicitud.fechaTexto=v.fechaATexto(v.solicitud.fecha),v.solicitud.modificar=!0,v.abrirDialogPanelOperaciones(),v.solicitud.sucursal=v.solicitud.almacen.sucursal,v.solicitud.almacen=v.solicitud.almacen,v.obtenerAlmacenes(v.solicitud.sucursal.id),v.obtenerInventariosProdSolicitud()},v.generarListaGruposSeleccionados=function(o,e){for(var i=0;i<o.length;i++)for(var a=0;a<e.length;a++)o[i].id==e[a].id&&(o[i].selected=e[a].selected);return o},v.obtenerGruposProductoEmpresa=function(){D(v.usuarioSesion.id_empresa,v.usuario.id).then(function(o){if(v.grupos_productos=o,angular.isDefined(s.grupos_productos))v.grupos_productos=v.generarListaGruposSeleccionados(v.grupos_productos,s.grupos_productos);else for(var e=0;e<o.length;e++)v.grupos_productos[e].selected=!0;v.listChecked=[],v.saveCheckList=function(){v.listChecked.splice(0,v.listChecked.length);for(var o=0;o<v.grupos_productos.length;o++)1==v.grupos_productos[o].selected&&v.listChecked.push(v.grupos_productos[o]);s.grupos_productos=v.grupos_productos},v.saveCheckList(),v.allChecked=!1,v.checkedUnchecked=function(){for(var o=0;o<v.grupos_productos.length;o++)v.grupos_productos[o].selected=v.allChecked;v.saveCheckList()}})},angular.isDefined(s.color)?v.color=s.color:(s.color={style:"red-style",stylebutton:"red-style-button"},v.color={style:"red-style",stylebutton:"red-style-button"}),v.cambiarColor=function(o,e){s.color={style:o,stylebutton:e},$("#dialog-panel-operaciones .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-operaciones .widget-main").addClass(o),$("#dialog-panel-operaciones .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-operaciones .widget-main .button-style").addClass(e)},v.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},v.dragged=!1,v.proformaClick=function(o){v.dragged||v.venderProformaDirecto(o),v.dragged=!1},v.startDragging=function(){v.dragged=!0},v.colorearInventarioDisponible=function(o,e){0==o?(v.porcentaje="100",v.color="red"):o>3*e.inventario_minimo+1?(v.porcentaje="100",v.color="green"):o>2*e.inventario_minimo+1?(v.porcentaje="75",v.color="green"):o>1.5*e.inventario_minimo+1?(v.porcentaje="50",v.color="green"):o==e.inventario_minimo+1?(v.porcentaje="38",v.color="yellow"):o==e.inventario_minimo?(v.porcentaje="25",v.color="red"):o<e.inventario_minimo&&0<o&&(v.porcentaje="12",v.color="red")},v.clasificarColumna=function(o){v.columna==o?"asc"==v.direccion?(v.direccion="desc",$("#"+o+"p").removeClass("fa-caret-up"),$("#"+o+"p").addClass("fa-caret-down")):(v.direccion="asc",$("#"+o+"p").removeClass("fa-caret-down"),$("#"+o+"p").addClass("fa-caret-up")):(v.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+o+"p").addClass("fa-caret-up"),$("#"+o+"p").removeClass("fa-sort")),v.columna=o,v.buscarInventarios(v.almacenBusqueda.id,v.paginaActual,v.itemsPorPagina,v.textoBusqueda,v.columna,v.direccion)},v.sinFuncionalidad=function(){v.mostrarMensaje("Sin funcionalidad")},v.filtrarSolicitudesOperaciones=function(o){for(var e in o)void 0===o[e]&&(o[e]=0);v.obtenerSolicitudes()},v.copiar=function(o){o.id=void 0,o.solicitudesProductos=o.solicitudesProductos.map(function(o){return o.id=void 0,o.id_solicitud=void 0,0<o.detallesIngredientesProducto.length&&(o.detallesIngredientesProducto=o.detallesIngredientesProducto.map(function(o){return o.id=void 0,o.id_detalle_solicitud_producto=void 0,o})),o}),v.solicitud=o,v.solicitud.copia=!0,v.solicitud.sucursal=v.solicitud.almacen.sucursal,v.obtenerAlmacenes(v.solicitud.sucursal.id),v.solicitud.almacen=v.solicitud.almacen,v.obtenerInventariosProdSolicitud(),v.abrirDialogPanelOperaciones()},v.fechaATexto=function(o){return fech=new Date(o),o=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},v.abrirDialogPanelOperaciones=function(){void 0!==v.solicitud?void 0===v.solicitud.id?(v.productoSeleccionado=void 0,v.solicitud.fecha=(new Date).toLocaleDateString()):void 0===v.solicitud.copia?(v.solicitud.fecha=new Date(v.solicitud.fecha).toLocaleDateString(),v.solicitud.modificar||(v.solicitud.nueva=!0)):(v.solicitud.id=void 0,v.solicitud.fecha=(new Date).toLocaleDateString(),v.solicitud.activo=!0):(v.solicitud={},v.solicitud.fecha=(new Date).toLocaleDateString(),v.solicitud.activo=!0),v.obtenerGruposProductoEmpresa(),v.abrirPopup(v.idDialogDialogPanelOperaciones)},v.cerrarPopupPanel=function(){void 0!==v.solicitud&&(v.solicitud.copia=void 0,v.solicitud=void 0),v.productoSeleccionado=void 0,v.recargarItemsTabla(),v.productosProcesados=[],v.cerrarPopup(v.idDialogDialogPanelOperaciones)},v.abriridDialogoListadoPedido=function(){v.abrirPopup(v.idDialogoListadoPedido)},v.cerraridDialogoListadoPedido=function(){v.detallesPedido=[],v.pedido={},v.detallePedido={},v.solicitudesPedido=[],v.cerrarPopup(v.idDialogoListadoPedido)},v.verificarPulso=function(o,e){13===o.keyCode&&v.buscarProductos(1)},v.verificarPulsoAsignados=function(o,e){13===o.keyCode&&v.buscarProductosAsignados(1)},v.abrirDialogDatos=function(){v.abrirPopup(v.idDialogDatos)},v.cerrarDialogDatos=function(){v.cerrarPopup(v.idDialogDatos)},v.abrirDialogEntregaViveres=function(){v.abrirPopup(v.idDialogEntregaViveres)},v.cerrarDialogEntregaViveres=function(){v.cerrarPopup(v.idDialogEntregaViveres)},v.abrirDialogConfirmacionCierre=function(){v.abrirPopup(v.idConfirmacionCierre)},v.cerrarDialogConfirmacionCierre=function(){v.cerrarPopup(v.idConfirmacionCierre)},v.abrirDialogTotalIngredientes=function(){v.abrirPopup(v.idDialogTotalIngredientes)},v.cerrarDialogTotalIngredientes=function(){v.alreadyCalculated=!1,v.cerrarPopup(v.idDialogTotalIngredientes)},v.generarPdfSolicitud=function(o){g.start(),v.calcularTotalViveres(o,!0);var e=new PDFDocument({size:[612,792],margin:10,compress:!1}),i=e.pipe(blobStream());(t=(a=new Date).getMinutes())<10&&(t="0"+t),e.font("Helvetica",8);var a,t,r=115,d=0,s=1,n=Math.ceil(v.totalViveresSolicitados.productos.length/29);v.dibujarCabeceraPDFSolicitud(e,s,n);for(var c=0;c<v.totalViveresSolicitados.productos.length&&d<=29;c++)e.font("Helvetica",8),e.text(c+1,65,r),e.text(v.totalViveresSolicitados.productos[c].productoSolicitudBase.codigo,100,r),e.text(v.totalViveresSolicitados.productos[c].productoSolicitudBase.nombre,220,r),e.text(v.totalViveresSolicitados.productos[c].productoSolicitudBase.unidad_medida,400,r),e.text(v.totalViveresSolicitados.productos[c].total.toFixed(2),500,r),r+=20,29<++d&&(e.rect(40,105,540,r-115).stroke(),e.text(s+"/"+n,570,r+15),e.font("Helvetica",6),e.text("RESPONSABLE: "+v.usuarioSesion.nombre_usuario,45,r+10),e.text("SOLICITANTE: "+v.totalViveresSolicitados.usuario.persona.nombre_completo,345,r+10),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,r+10),e.addPage({size:[612,792],margin:10}),r=115,d=0,s+=1,v.dibujarCabeceraPDFSolicitud(e,s,n));e.rect(40,105,540,r-115).stroke(),(t=(a=new Date).getMinutes())<10&&(t="0"+t),e.text(s+"/"+n,570,r+15),e.font("Helvetica",6),e.text("RESPONSABLE: "+v.usuarioSesion.nombre_usuario,45,r+5),e.text("SOLICITANTE: "+v.totalViveresSolicitados.usuario.persona.nombre_completo,345,r+5),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,r+5),e.end(),i.on("finish",function(){var o=i.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),g.stop()},v.dibujarCabeceraPDFSolicitud=function(o,e,i){o.font("Helvetica-Bold",12),o.text("CONSUMOS",0,25,{align:"center"}),o.font("Helvetica-Bold",8),o.text("SUCURSAL : ",-40,50,{align:"center"}),o.font("Helvetica",8),o.text(v.totalViveresSolicitados.sucursal.nombre,60,50,{align:"center"}),o.font("Helvetica-Bold",8),o.text("FECHA : ",40,60,{width:40}),o.font("Helvetica",8),o.text(v.fechaATexto(v.totalViveresSolicitados.fecha),75,60,{width:40}),o.font("Helvetica-Bold",14),o.text("N°",380,40,{align:"center"}),o.text(v.totalViveresSolicitados.identificador,440,40,{align:"center"}),o.rect(40,80,540,25).stroke(),o.font("Helvetica-Bold",8),o.text("Nº",65,90),o.text("Código Ítem",100,90),o.text("Producto",220,90),o.text("Unidad medida",380,90),o.text("Cantidad solicitada",480,90)},v.calcularViveresDesdeFiltro=function(a){var t=[];v.totalViveresSolicitados={},v.solicitudesPedido=[],v.solicitudesOperaciones.forEach(function(o,e){if(o.activo||void 0!==a){if(a&&!o.id_pedido){v.solicitudesPedido.push(o.id);i=v.calcularTotalViveres(o,!0);t.push(i)}}else{var i=v.calcularTotalViveres(o,!0);t.push(i)}});var r=[];if(t.forEach(function(i){i.productos.forEach(function(o){var e={almacen:o.almacen,sucursal:o.almacen.sucursal,cantidad:o.cantidad_real,fecha:i.fecha,hora_fecha:i.fecha,usuario:i.usuario,estado:o.estado,producto:o.productoSolicitudBase,costo:o.productoSolicitudBase.inventarios&&o.productoSolicitudBase.inventarios.length?o.productoSolicitudBase.inventarios[0].costo_unitario:0,grupo:o.productoSolicitudBase.grupo,subgrupo:o.productoSolicitudBase.subgrupo,total:(o.productoSolicitudBase.inventarios&&o.productoSolicitudBase.inventarios.length?o.productoSolicitudBase.inventarios[0].costo_unitario:0)*o.cantidad_real,monto:o.monto,solicitud:o.solicitud};r.push(e)})}),a){for(var o=[];0<r.length;){var i=r.pop();if(0===o.length)o.push(i);else{var d,s=!1;o.forEach(function(o,e){o.producto.id!=i.producto.id||s||(s=!0,d=e)}),s&&void 0!==d?(o[d].cantidad+=i.cantidad,o[d].total=o[d].cantidad*o[d].costo):o.push(i)}}return o}return r},v.reporteExcel=function(o){if(g.start(),v.imprimir.detalle){(t=[]).push(["Nro.","Sucursal","Almacén","Hora-fecha","Usuario","Estado","Detalle","Unidad","Grupo","Subgrupo","Cantidad","Costo","Total"]);for(var e=v.calcularViveresDesdeFiltro(),i=[],a=0;a<e.length;a++)(i=[]).push(a+1),i.push(e[a].almacen.sucursal.nombre),i.push(e[a].almacen.nombre),i.push(new Date(e[a].fecha).toLocaleTimeString()+" "+new Date(e[a].fecha).toLocaleDateString()),i.push(e[a].usuario.nombre_usuario),i.push(e[a].estado?"Abierto":"Cerrado"),i.push(e[a].producto.nombre),i.push(e[a].producto.unidad_medida),i.push(e[a].grupo.nombre),i.push(e[a].subgrupo.nombre),i.push(e[a].cantidad),i.push(e[a].costo),i.push(e[a].total.toFixed(2)),t.push(i);g.stop()}else{var t;(t=[]).push(["Nro.","Sucursal","Hora-fecha","Monto","Usuario","Estado"]);for(i=[],a=0;a<v.solicitudesOperaciones.length;a++)(i=[]).push(a+1),i.push(v.solicitudesOperaciones[a].almacen.sucursal.nombre),i.push(new Date(v.solicitudesOperaciones[a].fecha).toLocaleTimeString()+" "+new Date(v.solicitudesOperaciones[a].fecha).toLocaleDateString()),i.push(v.solicitudesOperaciones[a].monto),i.push(v.solicitudesOperaciones[a].usuario.nombre_usuario),i.push(v.solicitudesOperaciones[a].activo?"Abierto":"Cerrado"),t.push(i);g.stop()}if(o)v.reportePdf(t),g.stop();else{var r="SheetJS",d=new Workbook,s=sheet_from_array_of_arrays(t);s["!cols"]=[{wch:5},{wch:18},{wch:18},{wch:12},{wch:15},{wch:15},{wch:12},{wch:25},{wch:12},{wch:12},{wch:12}],s["!rows"]=[{hpx:28,level:3}],d.SheetNames.push(r),d.Sheets[r]=s;var n=XLSX.write(d,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),"REPORTE OPERACIONES.xlsx"),g.stop()}},v.reportePdf=function(o){var e=new PDFDocument({size:"letter",margin:10,compress:!1}),i=e.pipe(blobStream());(t=(a=new Date).getMinutes())<10&&(t="0"+t),v.posXforPdf=[],e.font("Helvetica",8);var a,t,r=65,d=115,s=0,n=1,c=Math.ceil(o.length/29);if(v.dibujarCabeceraReportePdf(e,o),v.imprimir.detalle){r=50;for(var u=0;u<o.length&&s<=29;u++){var l=r;if(e.font("Helvetica",8),0<u){for(var p=0;p<o[u].length;p++)e.text(o[u][p],l,d,{width:40},{align:"center"}),l=v.posXforPdf[p];d+=20,s++}29<s&&(e.rect(40,105,540,d-115).stroke(),e.text(n+"/"+c,570,d+15),e.font("Helvetica",6),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,d+10),e.addPage({size:[612,792],margin:10}),d=115,s=0,n+=1,v.dibujarCabeceraPDFSolicitud(e,n,c))}}else for(u=0;u<o.length&&s<=29;u++){l=r;if(e.font("Helvetica",8),0<u){for(p=0;p<o[u].length;p++)e.text(o[u][p],l,d,{width:40}),l+=0==p?30:60;d+=20,s++}29<s&&(e.rect(40,105,540,d-115).stroke(),e.text(n+"/"+c,570,d+15),e.font("Helvetica",6),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,d+10),e.addPage({size:[612,792],margin:10}),d=115,s=0,n+=1,v.dibujarCabeceraPDFSolicitud(e,n,c))}e.rect(40,105,540,650).stroke(),(t=(a=new Date).getMinutes())<10&&(t="0"+t),e.text(n+"/"+c,570,765),e.font("Helvetica",6),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,765),e.end(),i.on("finish",function(){var o=i.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),g.stop()},v.dibujarCabeceraReportePdf=function(o,e){if(o.font("Helvetica-Bold",12),o.text("REPORTE OPERACIONES",0,25,{align:"center"}),o.font("Helvetica-Bold",8),o.text("FECHA : ",40,60,{width:40}),o.font("Helvetica",8),o.text((new Date).toLocaleDateString(),75,60,{width:40}),o.rect(40,80,540,25).stroke(),o.font("Helvetica-Bold",8),v.imprimir.detalle){px=50;for(var i=0;i<e[0].length;i++)o.text(e[0][i],px,90),0==i?px+=4*e[0][i].length+5:(v.imprimir.detalle,px+=4*e[0][i].length+15),v.posXforPdf.push(px)}else{px=65;for(i=0;i<e[0].length;i++)o.text(e[0][i],px,90),0==i?(px+=20,v.posXforPdf.push(px)):v.imprimir.detalle?px+=40:px+=60}o.font("Helvetica",8)},v.obtenerProductos=function(){v.paginatorProductos=h(),v.paginatorProductos.column="nombre",v.paginatorProductos.filter=v.grupo,v.paginatorProductos.callBack=v.buscarProductos,v.paginatorProductos.getSearch("",null,null)},v.modificarListaProductosProveedor=function(o){var e=v.listaProductosProveedor.indexOf(o.id);0<=e&&!o.seleccionado?v.listaProductosProveedor.splice(e,1):-1==e&&o.seleccionado&&v.listaProductosProveedor.push(o.id)},v.seleccionarTodosParaAsignar=function(){v.seleccionProductosProveedor.seleccionar_todos?v.productosAsignacionProveedor.forEach(function(o){o.seleccionado=!0,v.modificarListaProductosProveedor(o)}):v.productosAsignacionProveedor.forEach(function(o){o.seleccionado=!1,v.modificarListaProductosProveedor(o)})},v.actualizarProductosProveedor=function(){V(v.usuarioSesion.id_empresa,v.listaProductosProveedor,v.pedido.proveedor).then(function(o){o.hasErr?v.mostrarMensaje(o.mensaje):(v.mostrarMensaje(o.mensaje),v.cerrarModalProductosProveedor())}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";v.mostrarMensaje(e)})},v.buscarProductos=function(o){g.start(),o&&(v.paginatorProductos.currentPage=o),v.paginatorProductos.filter=v.configuracionPorveedor.grupo?v.configuracionPorveedor.grupo:{id:0},v.paginatorProductos.search=v.configuracionPorveedor.textoBusqueda?v.configuracionPorveedor.textoBusqueda:0,j(v.usuarioSesion.id_empresa,v.paginatorProductos,v.usuarioSesion.id).then(function(o){o.hasErr?v.mostrarMensaje(o.mensaje):(v.paginatorProductos.setPages(o.paginas),v.productosAsignacionProveedor=o.productos,v.pedido&&v.pedido.proveedor&&A(v.usuarioSesion.id_empresa,v.pedido.proveedor).then(function(o){if(o.hasErr)v.mostrarMensaje(o.mensaje),v.listaProductosProveedor=[];else if(o.productos){var e=o.productos.split(",");v.listaProductosProveedor=e.map(function(o){return parseInt(o)}),v.verificarAsignacionProductosProveedor()}else v.listaProductosProveedor=[];g.stop()}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";v.mostrarMensaje(e)}));g.stop()}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";v.mostrarMensaje(e)})},v.obtenerProductosAsignados=function(){v.paginatorProductosAsignados=h(),v.paginatorProductosAsignados.column="nombre",v.paginatorProductosAsignados.filter=v.grupo,v.paginatorProductosAsignados.callBack=v.buscarProductosAsignados,v.paginatorProductosAsignados.getSearch("",null,null)},v.buscarProductosAsignados=function(o,e){(g.start(),o&&(v.paginatorProductosAsignados.currentPage=o),void 0===v.pedido)?(v.pedido={},g.stop()):v.pedido.proveedor?(v.paginatorProductosAsignados.filter=v.productosAsignadosPorveedor.grupo?v.productosAsignadosPorveedor.grupo:{id:0},v.paginatorProductosAsignados.search=v.productosAsignadosPorveedor.textoBusqueda?v.productosAsignadosPorveedor.textoBusqueda:0,A(v.usuarioSesion.id_empresa,v.pedido.proveedor).then(function(o){if(o.hasErr)v.mostrarMensaje(o.mensaje),v.listaProductosProveedor=[];else if(o.productos){var e=o.productos.split(",");v.listaProductosProveedor=e.map(function(o){return parseInt(o)}),B(v.usuarioSesion.id_empresa,v.paginatorProductosAsignados,v.usuarioSesion.id,v.listaProductosProveedor).then(function(o){o.hasErr?v.mostrarMensaje(o.mensaje):(v.paginatorProductosAsignados.setPages(o.paginas),v.productosAsignadosProveedor=o.productos,v.listaProductosProveedorSeleccionados=[],v.verificarSeleccionProductosProveedor()),g.stop()}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";v.mostrarMensaje(e)})}else v.listaProductosProveedor=[];g.stop()}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";v.mostrarMensaje(e)})):v.mostrarMensaje("El proveedor no tiene productos asignados.")},v.verificarSeleccionProductosProveedor=function(){0<v.listaProductosProveedorSeleccionados.length&&v.listaProductosProveedorSeleccionados.forEach(function(e){v.productosProveedorSeleccionados.forEach(function(o){o.id===e&&(o.seleccionado=!0)})})},v.filtrarProductosSeleccionadosPorGrupo=function(){if(0<v.detallesPedido.length){var e=[];v.detallesPedido.forEach(function(o){o.id_subgrupo===v.pedido.grupo&&e.push(o)}),0<e.length?v.detallesPedido=e.map(function(o){return o}):v.mostrarMensaje("No existen productos pertenecientes al grupo seleccionado. No se realizaron cambios.")}},v.abrirmodalBusquedaProveedor=function(){v.filtrarProveedores(""),v.abrirPopup(v.idDialogBusquedaProveedor)},v.cerrarModalBusquedaProveedor=function(){v.cerrarPopup(v.idDialogBusquedaProveedor)},v.abrirmodalProductosAsignadosProveedor=function(){void 0===v.pedido&&(v.pedido={por_proveedor:!1}),v.pedido.proveedor?(v.generarPorProveedor(),v.buscarProductosAsignados(),v.abrirPopup(v.idDialogProductosAsigandosProveedor)):v.mostrarMensaje("Seleccione un proveedor.")},v.cerrarModalProductosAsignadosProveedor=function(){v.cerrarPopup(v.idDialogProductosAsigandosProveedor)},v.cerrarModalProductosProveedor=function(){v.productosAsignacionProveedor=[],v.listaProductosProveedor=[],v.cerrarPopup(v.idDialogProductosProveedor)},v.abrirModalNuevoPedido=function(){v.abrirPopup(v.idDialogoNuevoPedido)},v.cerrarModalNuevoPedido=function(){v.detallesPedido=[],v.pedido={},v.detallePedido={},v.solicitudesPedido=[],v.cerrarPopup(v.idDialogoNuevoPedido)},v.eliminarDetallePedido=function(o){o.id?o.eliminar=!0:v.detallesPedido.splice(v.detallesPedido.indexOf(o),1)},v.guardarPedido=function(o,e){if(g.start(),void 0!==o&&0<v.detallesPedido.length){e&&(o.solicitudesIds=v.solicitudesPedido.map(function(o){return o}));var i=new Date,a=o.fecha.split("/").reverse(),t={fecha:new Date(a[0],a[1]-1,a[2],i.getHours(),i.getMinutes()),sucursal:o.sucursal,almacen:o.almacen,proveedor:o.proveedor.id,observacion:o.observacion,grupo:void 0!==o.grupo&&null!==o.grupo?o.grupo:0,detallesPedido:v.detallesPedido,usuario:v.usuarioSesion.id,solicitudesIds:o.generado?v.solicitudesPedido:[]};I(v.usuario.id_empresa,t,v.usuarioSesion.id).then(function(o){g.stop(),o.hasErr?v.mostrarMensaje(o.mensaje):(v.mostrarMensaje(o.mensaje),v.recargarItemsTabla())}).catch(function(o){g.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.data&&null!==o.data?o.data:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";v.mostrarMensaje(e)})}else 0<v.detallesPedido.length?v.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar!"):v.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar sin lista de productos!"),g.stop()},v.inicio()}]);