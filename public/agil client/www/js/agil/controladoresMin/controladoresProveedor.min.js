angular.module("agil.controladores").controller("ControladorProveedores",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","Proveedor","Proveedores","Empresas","ProveedoresEmpresa","ProveedoresPaginador","EliminarProveedor",function(s,e,o,a,t,n,d,l,i,c,u,f,p){d.start(),s.usuario=JSON.parse(o.usuario),s.inicio=function(){s.obtenerEmpresas(),s.obtenerProveedores(),s.buscarTodosProveedores()},s.$on("$viewContentLoaded",function(){resaltarPestaña(a.path().substring(1)),ejecutarScriptsProveedor("modal-wizard-proveedor","modal-wizard-proveedor-vista","dialog-eliminar-proveedor","modal-wizard-container-proveedor-edicion","modal-wizard-container-proveedor-vista"),s.buscarAplicacion(s.usuario.aplicacionesUsuario,a.path().substring(1)),d.stop()}),s.crearNuevoProveedor=function(){var e=JSON.parse(o.usuario);s.proveedor=new l({id_empresa:e.id_empresa}),s.abrirPopup("modal-wizard-proveedor")},s.verProveedor=function(e){(s.proveedor=e).fecha1=new Date(e.fecha1),e.fecha2=new Date(e.fecha2),s.proveedor.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear(),s.proveedor.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear(),s.abrirPopup("modal-wizard-proveedor-vista")},s.cerrarPopPupVista=function(){s.cerrarPopup("modal-wizard-proveedor-vista")},s.cerrarPopPupNuevoProveedor=function(){s.cerrarPopup("modal-wizard-proveedor")},s.modificarProveedor=function(e){(s.proveedor=e).fecha1&&(e.fecha1=new Date(e.fecha1),s.proveedor.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear()),e.fecha2&&(e.fecha2=new Date(e.fecha2),s.proveedor.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear()),s.abrirPopup("modal-wizard-proveedor")},s.mostrarConfirmacionEliminacion=function(e){s.proveedor=new l(e),s.abrirPopup("dialog-eliminar-proveedor")},s.cerrarConfirmacionEliminacion=function(){s.cerrarPopup("dialog-eliminar-proveedor")},s.eliminarProveedor=function(e){d.start(),s.cerrarConfirmacionEliminacion(),p(e.id).then(function(e){s.mostrarMensaje(e.mensaje)}),s.recargarItemsTabla(),d.stop()},s.saveForm=function(n){if("Siguiente"!=$("#siguiente").text().trim()){d.start();var e=document.getElementById("doc-nit").files[0],o=document.getElementById("doc-funda").files[0],a=document.getElementById("doc-licencia").files[0],t=document.getElementById("doc-ci").files[0],i=document.getElementById("doc-seguro-social").files[0],c=[];[e,o,a,t,i].forEach(function(e,o,a){e&&c.push(e),o==a.length-1&&(0<c.length?c.forEach(function(o,a,t){r=new FileReader,o?(r.onloadend=function(e){o.nombre=o.name,o.data=e.target.result,a===t.length-1&&(n.fecha1=null,n.fechatexto1&&(n.fecha1=new Date(s.convertirFecha(n.fechatexto1))),n.fecha2=null,n.fechatexto2&&(n.fecha2=new Date(s.convertirFecha(n.fechatexto2))),n.id?l.update({idProveedor:n.id},n,function(e){d.stop(),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Actualizado Exitosamente!"),s.recargarItemsTabla()}):n.$save(function(e){d.stop(),s.proveedor=new l({}),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Guardado Exitosamente!"),s.recargarItemsTabla()},function(e){d.stop(),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Ocurrio un problema al momento de guardar!"),s.recargarItemsTabla()}))},r.readAsBinaryString(o)):a===t.length-1&&(n.fecha1=null,n.fechatexto1&&(n.fecha1=new Date(s.convertirFecha(n.fechatexto1))),n.fecha2=null,n.fechatexto2&&(n.fecha2=new Date(s.convertirFecha(n.fechatexto2))),n.id?l.update({idProveedor:n.id},n,function(e){d.stop(),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Actualizado Exitosamente!"),s.recargarItemsTabla()}):n.$save(function(e){d.stop(),s.proveedor=new l({}),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Guardado Exitosamente!"),s.recargarItemsTabla()},function(e){d.stop(),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Ocurrio un problema al momento de guardar!"),s.recargarItemsTabla()}))}):(n.fecha1=null,n.fechatexto1&&(n.fecha1=new Date(s.convertirFecha(n.fechatexto1))),n.fecha2=null,n.fechatexto2&&(n.fecha2=new Date(s.convertirFecha(n.fechatexto2))),n.id?l.update({idProveedor:n.id},n,function(e){d.stop(),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Actualizado Exitosamente!"),s.recargarItemsTabla()}):n.$save(function(e){d.stop(),s.proveedor=new l({}),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Guardado Exitosamente!"),s.recargarItemsTabla()},function(e){d.stop(),s.cerrarPopPupNuevoProveedor(),s.mostrarMensaje("Ocurrio un problema al momento de guardar!"),s.recargarItemsTabla()})))})}},s.obtenerEmpresas=function(){d.start(),c().then(function(e){s.empresas=e,d.stop()})},s.obtenerProveedores=function(){s.abs=e.Math.abs,s.itemsPorPagina=10,s.buscarProveedores(1,s.itemsPorPagina,"")},s.verificarPulso=function(e,o){13===e.keyCode&&s.buscarProveedores(1,s.itemsPorPagina,o)},s.buscarProveedores=function(e,o,r){d.start(),s.itemsPorPagina=o,""==r||null==r?r=0:s.textoBusqueda=r,s.paginaActual=e,f(s.usuario.id_empresa,e,o,r).then(function(e){s.paginas=[];for(var o=1;o<=e.paginas;o++)s.paginas.push(o);s.proveedores=e.proveedores,d.stop()})},s.buscarTodosProveedores=function(){i(s.usuario.id_empresa).then(function(e){s.TodoProveedores=e}),d.stop()},s.reporteExcel=function(){var e=s.TodoProveedores;d.start();var o=[];o.push(["Codigo","Razón Social","Nit","Direccion","Telefono1","Telefono2","Contacto","Ubicacion Geo.","Rubro","Categoria","Fecha Imp.1","Fecha Imp.2","Texto1","Texto2"]);for(var r=0;r<e.length;r++)columns=[],columns.push(e[r].codigo),columns.push(e[r].razon_social),columns.push(e[r].nit),columns.push(e[r].direccion),columns.push(e[r].telefono1),columns.push(e[r].telefono2),columns.push(e[r].contacto),e[r].ubicacion_geografica?columns.push(e[r].ubicacion_geografica):columns.push(" "),columns.push(e[r].rubro),e[r].categoria?columns.push(e[r].categoria):columns.push(" "),e[r].fecha1?columns.push(new Date(e[r].fecha1)):columns.push(" "),e[r].fecha2?columns.push(new Date(e[r].fecha2)):columns.push(" "),e[r].texto1?columns.push(e[r].texto1):columns.push(" "),e[r].texto2?columns.push(e[r].texto2):columns.push(" "),o.push(columns);var a="SheetJS",t=new Workbook,n=sheet_from_array_of_arrays(o);t.SheetNames.push(a),t.Sheets[a]=n;var i=XLSX.write(t,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(i)],{type:"application/octet-stream"}),"REPORTE-USUARIOS.xlsx"),d.stop()},s.dibujarCabeceraPDFProveedores=function(e,o,r,a){var t=(new Date).toLocaleDateString();e.fontSize(23).text("REPORTE DE PROVEEDORES",0,80,{align:"center"}),e.rect(133,100,335,0).stroke(),e.font("Helvetica-Bold",10),e.text("Fecha: ",30,140),e.font("Helvetica",10).text(t,63,140),e.font("Helvetica-Bold",10).text("N°",30,160),e.font("Helvetica-Bold",10).text("Código",52,160),e.font("Helvetica-Bold",10).text("Razón Social",100,160),e.font("Helvetica-Bold",10).text("Nit",230,160),e.font("Helvetica-Bold",10).text("Direccion",300,160),e.font("Helvetica-Bold",10).text("Telefono",390,160),e.font("Helvetica-Bold",10).text("Rubro",470,160),e.text("PÁGINA "+o+" DE "+r,0,740,{align:"center"})},s.reportePdf=function(){var e=s.TodoProveedores;d.start();var o=new PDFDocument({size:"letter",margin:10}),r=o.pipe(blobStream()),a=200,t=0,n=1,i=Math.ceil(e.length/15);s.dibujarCabeceraPDFProveedores(o,1,i,e),o.font("Helvetica",8);for(var c=e.length-1,l=0;l<c&&t<=15;l++){var u=l+1;o.font("Helvetica",9).text(u,30,a),e[l].codigo?o.font("Helvetica",9).text(e[l].codigo,52,a):o.font("Helvetica",9).text("null",52,a),e[l].razon_social?o.font("Helvetica",9).text(e[l].razon_social,100,a,{width:130}):o.font("Helvetica",9).text("null",100,a),e[l].nit?o.font("Helvetica",9).text(e[l].nit,230,a):o.font("Helvetica",9).text("null",230,a),e[l].direccion?(o.font("Helvetica",9).text(e[l].direccion,300,a,{width:80}),console.log(e[l].direccion.length)):o.font("Helvetica",9).text("null",300,a),e[l].telefono1?o.font("Helvetica",9).text(e[l].telefono1,390,a):o.font("Helvetica",9).text("null",390,a),e[l].rubro?o.font("Helvetica",9).text(e[l].rubro,470,a):o.font("Helvetica",9).text("null",470,a),a+=33,15==++t&&(o.addPage({margin:0,bufferPages:!0}),a=200,t=0,n+=1,s.dibujarCabeceraPDFProveedores(o,n,i,e),o.font("Helvetica",8))}o.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),d.stop()},s.subirExcelProveedores=function(e){var o,r,a=e.target.files;for(r=a[o=0];o!=a.length;++o){var t=new FileReader;r.name;t.onload=function(e){d.start();var o=e.target.result,r=XLSX.read(o,{type:"binary"}),a=r.SheetNames[0],t=2,n=r.Sheets[a],i=[];do{var c={};c.codigo=null!=n["A"+t]&&""!=n["A"+t]?n["A"+t].v.toString():null,c.razon_social=null!=n["B"+t]&&""!=n["B"+t]?n["B"+t].v.toString():null,c.nit=null!=n["C"+t]&&""!=n["C"+t]?n["C"+t].v.toString():null,c.direccion=null!=n["D"+t]&&""!=n["D"+t]?n["D"+t].v.toString():null,c.telefono1=null!=n["E"+t]&&""!=n["E"+t]?n["E"+t].v.toString():null,c.telefono2=null!=n["F"+t]&&""!=n["F"+t]?n["F"+t].v.toString():null,c.telefono3=null!=n["G"+t]&&""!=n["G"+t]?n["G"+t].v.toString():null,c.contacto=null!=n["H"+t]&&""!=n["H"+t]?n["H"+t].v.toString():null,c.ubicacion_geografica=null!=n["I"+t]&&""!=n["I"+t]?n["I"+t].v.toString():null,c.rubro=null!=n["J"+t]&&""!=n["J"+t]?n["J"+t].v.toString():null,c.categoria=null!=n["K"+t]&&""!=n["K"+t]?n["K"+t].v.toString():null,c.fecha1=null!=n["L"+t]&&""!=n["L"+t]?new Date(s.convertirFecha(n["L"+t].v.toString())):null,c.fecha2=null!=n["M"+t]&&""!=n["M"+t]?new Date(s.convertirFecha(n["M"+t].v.toString())):null,c.texto1=null!=n["N"+t]&&""!=n["N"+t]?n["N"+t].v.toString():null,c.texto2=null!=n["O"+t]&&""!=n["O"+t]?n["O"+t].v.toString():null,i.push(c),t++,0}while(null!=n["A"+t]);s.guardarProveedores(i),d.stop()},t.readAsBinaryString(r)}},s.guardarProveedores=function(e){new u({proveedores:e,id_empresa:s.usuario.id_empresa}).$save(function(e){d.stop(),s.mostrarMensaje("Guardado Exitosamente!"),s.recargarItemsTabla()},function(e){d.stop(),s.mostrarMensaje("Ocurrio un problema al momento de guardar!"),s.recargarItemsTabla()})},s.$on("$routeChangeStart",function(e,o){s.eliminarPopup("modal-wizard-proveedor"),s.eliminarPopup("modal-wizard-proveedor-vista"),s.eliminarPopup("dialog-eliminar-proveedor")}),s.inicio()}]);