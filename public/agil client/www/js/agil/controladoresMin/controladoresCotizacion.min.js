angular.module("agil.controladores").controller("ControladorCotizacion",["$scope","blockUI","$localStorage","$location","$templateCache","$route","$timeout","ListaCotizacion","Cotizaciones","Cotizacion","filtroCotizaciones","Diccionario","ListaInventariosProducto","ClasesTipo","$window","ListaProductosEmpresa","InventarioPaginador","ConfiguracionCotizacionVista","ConfiguracionCotizacionVistaDatos","FiltroCotizacionPaginador","Paginator","DatosImpresionCotizacion","ultimaCotizacion","ListaSucursalesUsuario","ClientesNit","CotizacionRechazo",function(h,x,e,o,t,a,i,n,c,r,l,p,s,u,C,d,f,m,z,g,v,b,_,P,D,w){h.usuario=JSON.parse(e.usuario),h.idModalWizardCotizacionNueva="modal-wizard-cotizacion-nueva",h.idModalInventario="dialog-productos-venta",h.idModalDialogRechazo="dialog-editar-rechazo",h.inicio=function(){h.obtenerCotizaciones(),h.detalleCotizacion={producto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},h.sucursales=[],h.obtenerSucursales(),h.cotizacionModel=["id","nombre","descripcion","fecha","numero_documento","importe","usuario"],h.productoSeleccionado=!1},h.obtenerSucursales=function(){P(h.usuario.id).then(function(e){e.sucursales.map(function(e){h.sucursales.push(e.sucursal)}),h.usuario.sucursalesUsuario=e.sucursales;for(var o=0;o<h.usuario.sucursalesUsuario.length;o++)h.sucursalesUsuario=h.sucursalesUsuario+h.usuario.sucursalesUsuario[o].sucursal.id,o+1!=h.usuario.sucursalesUsuario.length&&(h.sucursalesUsuario=h.sucursalesUsuario+",")})},h.obtenerCotizaciones=function(){h.paginator=v(),h.paginator.column="id",h.paginator.direction="desc",h.dynamicPopoverRechazo={templateUrl:"myPopoverTemplate.html"},h.paginator.callBack=h.obtenerLista,h.filtro={empresa:h.usuario.id_empresa,inicio:"",fin:"",fecha_inicio:new Date,fecha_fin:new Date,busqueda:"",importe:0,estado:"",sucursal:"",usuario:"",razon_social:"",nit:""}},h.establecerFechas=function(e,o){h.filtro.fecha_inicio=new Date(convertirFecha(e)),h.filtro.fecha_fin=new Date(convertirFecha(o))},h.obtenerLista=function(){x.start(),l(h.paginator).then(function(e){h.paginator.setPages(e.paginas),h.cotizaciones=e.cotizaciones,x.stop()})},h.sumarMonto=function(){for(var e=0,o=0;o<h.cotizaciones.length;o++)e+=h.cotizaciones[o].importe;return Math.round(100*e)/100},h.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptsCotizacion(h.idModalWizardCotizacionNueva,h.idModalInventario,h.idModalDialogRechazo),h.buscarAplicacion(h.usuario.aplicacionesUsuario,o.path().substring(1))}),h.cerrarNuevaCotizacion=function(){h.cerrarPopup(h.idModalWizardCotizacionNueva)},h.abrirPopup=function(e){abrirPopup(e)},h.cerrarPopup=function(e){ocultarPopup(e)},h.eliminarPopup=function(e){eliminarPopup(e)},h.$on("$routeChangeStart",function(e,o){h.eliminarPopup(h.idModalWizardCotizacionNueva),h.eliminarPopup(h.idModalInventario),h.eliminarPopup(h.idModalDialogRechazo)}),h.ModificarCotizacion=function(e){h.cotizacion=e,h.obtenerAlmacenes(e.sucursal.id),h.cotizacion.fecha=new Date(h.cotizacion.fecha),h.cotizacion.fechaTexto=h.cotizacion.fecha.getDate()+"/"+(h.cotizacion.fecha.getMonth()+1)+"/"+h.cotizacion.fecha.getFullYear(),h.abrirPopup(h.idModalWizardCotizacionNueva)},h.buscarProducto=function(e){if(""!=e&&null!=e){var o=d(h.usuario.id_empresa,e);return setTimeout(h.enfocar("id_productoTB"),0),o}},h.eliminarDetalleCotizacion=function(e){indx=h.cotizacion.detallesCotizacion.indexOf(e),h.cotizacion.detallesCotizacion[indx].eliminado=!0,h.sumarTotalImporte()},h.establecerProducto=function(o){o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto,h.detalleCotizacion={producto:o,precio_unitario:o.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,descuento:o.descuento,eliminado:!1},h.editar_precio=!1,o.activar_inventario=!1,h.calcularImporte(),h.productoSeleccionado=!0,s(o.id,h.cotizacion.almacen.id).then(function(e){o.inventarios=e,h.precio_inventario,0<o.inventarios.length?h.precio_inventario=o.inventarios[o.inventarios.length-1].costo_unitario+" Bs":h.precio_inventario="Sin histórico"})},h.calcularImporte=function(){var e,o;h.detalleCotizacion.importe=Math.round(h.detalleCotizacion.cantidad*h.detalleCotizacion.precio_unitario*1e3)/1e3,e=h.detalleCotizacion.tipo_descuento?h.detalleCotizacion.importe*(h.detalleCotizacion.descuento/100):h.detalleCotizacion.descuento,o=h.detalleCotizacion.tipo_recargo?h.detalleCotizacion.importe*(h.detalleCotizacion.recargo/100):h.detalleCotizacion.recargo,h.detalleCotizacion.total=h.detalleCotizacion.importe-e+o-h.detalleCotizacion.ice-h.detalleCotizacion.excento},h.agregarDetalleCotizacion=function(e){h.cotizacion.detallesCotizacion.push(e),h.sumarTotalImporte(),h.detalleCotizacion={producto:{},cantidad:0,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},h.productoSeleccionado=!1},h.sumarTotalImporte=function(){for(var e=0,o=0;o<h.cotizacion.detallesCotizacion.length;o++)h.cotizacion.detallesCotizacion[o].eliminado||(e+=h.cotizacion.detallesCotizacion[o].importe);h.cotizacion.importe=Math.round(1e3*e)/1e3},h.crearNuevaCotizacion=function(){h.cotizacion=new r({id_empresa:h.usuario.id_empresa,id_usuario:h.usuario.id,cliente:{},detallesCotizacion:[]});var e=new Date;h.cotizacion.fechaTexto=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear(),h.detalleCotizacion={producto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},h.abrirPopup(h.idModalWizardCotizacionNueva),h.enfocar("nombreCotizacion")},h.guardarCotizacion=function(e,o){if(e){var t=new Date;if(o.fecha=new Date(h.convertirFecha(o.fechaTexto)),x.start(),o.id)r.update({id_cotizacion:o.id},o,function(e){x.stop(),h.imprimirCotizacion(o),h.cerrarNuevaCotizacion(),h.recargarItemsTabla(),h.mostrarMensaje("Actualizado exitosamente!")});else{t=new Date;o.fecha=new Date(h.convertirFecha(o.fechaTexto)),o.fecha.setHours(t.getHours()),o.fecha.setMinutes(t.getMinutes()),o.fecha.setSeconds(t.getSeconds()),o.$save(function(e){console.log("cotizacion guardaoooo ",e),x.stop(),h.imprimirCotizacion(e.cotizacion),h.cerrarNuevaCotizacion(),h.recargarItemsTabla(),h.mostrarMensaje("Cotización registrada exitosamente!"),x.stop()},function(e){x.stop(),h.mostrarMensaje("Ocurrio un problema al momento de guardar!"),h.recargarItemsTabla()})}}},h.obtenerAlmacenesActividades=function(e){h.obtenerAlmacenes(e)},h.obtenerAlmacenes=function(o){console.log("seleccion sucursallllllll ",o),h.almacenes=[];var e=$.grep(h.sucursales,function(e){return e.id==o})[0];h.almacenes=e.almacenes},h.buscarCliente=function(e){if(""!=e&&null!=e)return D(h.usuario.id_empresa,e)},h.establecerCliente=function(e){h.cotizacion.cliente=e,h.enfocar("razon_social")},h.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},h.enfocar=function(e){i(function(){$("#"+e).focus()},0)},h.interceptarTecla=function(e,o,t){13===e.which&&(t?h.enfocar(o):i(function(){$("#"+o).trigger("click")},0))},h.verificarPulso=function(e,o){13===e.keyCode&&o&&h.buscarCotizaciones(1,h.itemsPorPagina,o)},h.filtrarCotizaciones=function(e,o,t,a,i){x.start(),""==i||null==i?i=0:h.textoBusqueda=i,e=null==o||null==o?0:new Date(h.convertirFecha(e)),o=null==o||null==o?0:new Date(h.convertirFecha(o)),g(h.usuario.id_empresa,t,a,i,e,o).then(function(e){if(0==e.cotizaciones.length)return x.stop(),h.buscarCotizaciones(1,h.itemsPorPagina,"");h.cotizaciones=e.cotizaciones,h.paginas=[];for(var o=1;o<=e.paginas;o++)h.paginas.push(o);x.stop()})},h.verificarDescuentos=function(e){for(var o=!1,t=0;t<e.length;t++)(0<e[t].descuento||0<e[t].recargo||0<e[t].ice||0<e[t].excento)&&(o=!0);return o},h.dibujarCabeceraImpresionCotizacion=function(e,o,t,a,i,n){100<h.usuario.empresa.imagen.length&&e.image(h.usuario.empresa.imagen,60,40,{fit:[65,65]}),e.font("Helvetica-Bold",16),e.text("COTIZACIÓN",250,90),e.font("Helvetica-Bold",8),e.text(h.usuario.empresa.razon_social.toUpperCase(),60,110),e.font("Helvetica",7),e.text(o.sucursal.nombre.toUpperCase(),60,118);var c=o.sucursal.direccion.length,r=c<=45?129:45<c&&c<=90?139:145;e.text(o.sucursal.direccion.toUpperCase(),60,126);var l=(null!=o.sucursal.telefono1?o.sucursal.telefono1:"")+(null!=o.sucursal.telefono2?"-"+o.sucursal.telefono2:"")+(null!=o.sucursal.telefono3?"-"+o.sucursal.telefono3:"");e.text("TELF.: "+l,60,r+5),e.text("COCHABAMBA - BOLIVIA",60,r+13),e.font("Helvetica-Bold",10),e.rect(450,40,120,50).stroke(),e.text("NRO : ",460,60),e.text(o.numero_documento,500,60),e.font("Helvetica-Bold",8),e.rect(50,160,520,40).stroke(),e.text("FECHA : ",60,165),e.text("SEÑOR(ES) : ",60,180),e.text("NIT : ",360,165),e.text(o.fechaTexto,120,165),e.text(o.cliente.razon_social,120,180),e.text(o.cliente.nit,400,165),e.rect(50,200,520,25).stroke(),e.text("CODIGO",55,210,{width:70}),e.text("CANT.",125,210),o.detallesCotizacion[0].producto&&e.text("UNIDAD",155,210),e.text("DETALLE",198,210),o.detallesCotizacion[0].producto&&e.text("P.UNIT.",470,210),e.text("TOTAL",530,210),e.font("Helvetica",8);new Date},h.imprimirCotizacionCartaOficio=function(e,o,t,a){var i=new PDFDocument({size:e,compress:!1,margin:10}),n=i.pipe(blobStream());o.fecha=new Date(o.fecha),o.fechaTexto=o.fecha.getDate()+"/"+(o.fecha.getMonth()+1)+"/"+o.fecha.getFullYear();var c=240,r=0,l=0,s=1,u=Math.ceil(o.detallesCotizacion.length/t),d=h.verificarDescuentos(o.detallesCotizacion);h.dibujarCabeceraImpresionCotizacion(i,o,s,u,d,c-20);for(var p=0,f=0;f<o.detallesCotizacion.length;f++){i.font("Helvetica",7),indx=f+1,p+=o.detallesCotizacion[f].total,i.text(o.detallesCotizacion[f].producto.codigo,55,c,{width:70}),i.text(o.detallesCotizacion[f].cantidad,135,c),i.text(o.detallesCotizacion[f].producto.unidad_medida,155,c);var m=o.detallesCotizacion[f].producto.nombre.length,C=m<=45?c:45<m&&m<=90?c-7:c-14;i.text(o.detallesCotizacion[f].producto.nombre,200,C-5,{width:225}),i.text(null===o.detallesCotizacion[f].precio_unitario?"null":o.detallesCotizacion[f].precio_unitario.toFixed(2),470,c),i.text(o.detallesCotizacion[f].total.toFixed(2),530,c),ancho=m<=80?20:30,i.rect(50,c-15,520,30).stroke(),c+=30,(l+=1)==t&&(r+=l)!=o.detallesCotizacion.length&&(i.text("Pag. "+s+" de "+u,520,e[1]-40),i.addPage({size:e,margin:10}),c=240,l=0,s+=1,h.dibujarCabeceraImpresionCotizacion(i,o,s,u,d,c-20))}i.font("Helvetica-Bold",8),i.text("TOTAL",470,c),i.font("Helvetica",8),i.text(p.toFixed(2),530,c),i.text("SON : "+a,55,c),i.rect(50,c-15,520,30).stroke(),t-6<l&&(i.addPage({size:e,margin:10}),c=240,l=0,s+=1,h.dibujarCabeceraImpresionCotizacion(i,o,s,u,d,c-20)),i.rect(50,c+40,420,25).stroke(),i.font("Helvetica",8),i.text("Plazo de cotizacion: "+o.plazo,55,c+50),i.rect(50,c+80,420,25).stroke(),i.font("Helvetica",8),i.text("Nota: "+o.nota,55,c+90),i.rect(50,c+120,420,25).stroke(),i.font("Helvetica",8),null==o.descripcion&&(o.descripcion="Ninguna"),i.text("Observaciones: "+o.descripcion,55,c+130);var z=new Date,g=z.getMinutes();g<10&&(g="0"+g),i.font("Helvetica",8),i.text(o.firma,55,e[1]-90),i.text(o.cargo.toUpperCase(),55,e[1]-80),i.text("usuario : "+h.usuario.nombre_usuario,380,e[1]-60),i.text("fecha : "+z.getDate()+"/"+(z.getMonth()+1)+"/"+z.getFullYear()+"  "+z.getHours()+":"+g,480,e[1]-60),1<u&&i.text("Pag. "+s+" de "+u,520,e[1]-40),i.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),x.stop()},convertUrlToBase64Image(h.usuario.empresa.imagen,function(e){h.usuario.empresa.imagen=e}),h.dibujarCabeceraImpresionCotizacionCuartoCarta=function(e,o,t,a,i,n){100<h.usuario.empresa.imagen.length?e.image(h.usuario.empresa.imagen,20,n-80,{width:50,height:50}):e.image(h.usuario.empresa.imagen,20,n-80),sucurTel={};for(var c=0;c<h.sucursales.length;c++)h.sucursales[c].id==o.id_sucursal&&(sucurTel=h.sucursales[c].telefono1);e.font("Helvetica-Bold",8),e.text("COTIZACIÓN N°"+o.id,120,n-80),e.font("Helvetica",7),e.text("Nombre: "+o.nombre+"    Descripción: "+o.descripcion,20,n-20),e.text("Fecha: "+o.fechaTexto,225,n-20),e.font("Helvetica-Bold",7),e.text(h.usuario.empresa.razon_social.toUpperCase(),220,n-80+0),e.font("Helvetica",6),e.text("NIT "+h.usuario.empresa.nit,225,n-80+10),e.text("TELF.: "+sucurTel,225,n-80+20),e.text("Fecha: "+o.fechaTexto,225,n-80+30),e.font("Helvetica",5),e.text("COCHABAMBA - BOLIVIA",220,n-80+40),e.rect(15,n-10,282,20).stroke(),e.font("Helvetica",6),e.text("N°",20,n),i?(e.text("Cod.",30,n),e.text("Cant.",60,n),e.text("Unid.",80,n),e.text("Det.",100,n),e.text("P.Unit.",184,n),e.text("Imp.",212,n),e.text("Desc.",240,n),e.text("Totl.",270,n)):(e.text("Cod.",30,n),e.text("Cant.",60,n),e.text("Unid.",80,n),e.text("Detalle.",100,n),e.text("P.Unit.",195,n),e.text("Total.",270,n)),e.font("Helvetica",8)},h.imprimirCotizacionRollo=function(e,o){var t=new PDFDocument({size:e,compress:!1,margin:10}),a=t.pipe(blobStream());o.fecha=new Date(o.fecha),o.fechaTexto=o.fecha.getDate()+"/"+(o.fecha.getMonth()+1)+"/"+o.fecha.getFullYear();var i=0;o.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_MEDIOOFICIO?i=13:o.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_CUARTOCARTA&&(i=13);var n=140,c=Math.ceil(o.detallesCotizacion.length/i),r=h.verificarDescuentos(o.detallesCotizacion);h.dibujarCabeceraImpresionCotizacionCuartoCarta(t,o,1,c,r,n-20);for(var l=0,s=0;s<o.detallesCotizacion.length;s++){t.font("Helvetica",7),l+=o.detallesCotizacion[s].importe,indx=s+1;var u=o.detallesCotizacion[s].producto.nombre.length;if(t.text(indx,20,n),r){t.text(o.detallesCotizacion[s].producto.codigo,30,n-7,{width:32}),t.text(o.detallesCotizacion[s].cantidad,64,n,{width:30}),t.text(o.detallesCotizacion[s].producto.unidad_medida,79,n,{width:30});var d=u<=45?n-7:n;t.text(o.detallesCotizacion[s].producto.nombre,100,d-7,{width:80}),t.text(o.detallesCotizacion[s].precio_unitario.toFixed(2),184,n,{width:30}),t.text(o.detallesCotizacion[s].importe.toFixed(2),212,n),t.text(o.detallesCotizacion[s].tipo_descuento?"%":"Bs",240,n),t.text(o.detallesCotizacion[s].descuento.toFixed(2),250,n),t.text(o.detallesCotizacion[s].total.toFixed(2),270,n)}else{t.text(o.detallesCotizacion[s].producto.codigo,30,n-7,{width:32}),t.text(o.detallesCotizacion[s].cantidad,64,n,{width:30}),t.text(o.detallesCotizacion[s].producto.unidad_medida,79,n,{width:30}),console.log(u);d=u<=65?n-7:n;t.text(o.detallesCotizacion[s].producto.nombre,100,d,{width:80}),t.text(o.detallesCotizacion[s].precio_unitario.toFixed(2),184,n,{width:30}),t.text(o.detallesCotizacion[s].total.toFixed(2),270,n)}ancho=u<=80?20:30,t.rect(15,n-10,282,ancho).stroke(),n+=20,0}t.font("Helvetica-Bold",7),t.text("TOTAL BS.",225,n),t.text(l.toFixed(1),270,n),t.rect(220,n-10,77,20).stroke(),t.end(),a.on("finish",function(){var e=a.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),x.stop()},h.imprimirCotizacionCuartoCarta=function(e,o,t){var a=new PDFDocument({size:e,compress:!1,margin:10}),i=a.pipe(blobStream());o.fecha=new Date(o.fecha),o.fechaTexto=o.fecha.getDate()+"/"+(o.fecha.getMonth()+1)+"/"+o.fecha.getFullYear();var n=140,c=0,r=0,l=1,s=Math.ceil(o.detallesCotizacion.length/t),u=h.verificarDescuentos(o.detallesCotizacion);h.dibujarCabeceraImpresionCotizacionCuartoCarta(a,o,l,s,u,n-20);for(var d=0,p=0;p<o.detallesCotizacion.length;p++){a.font("Helvetica",7),d+=o.detallesCotizacion[p].importe,indx=p+1;var f=o.detallesCotizacion[p].producto.nombre.length;if(a.text(indx,20,n),u){a.text(o.detallesCotizacion[p].producto.codigo,30,n-7,{width:32}),a.text(o.detallesCotizacion[p].cantidad,64,n,{width:30}),a.text(o.detallesCotizacion[p].producto.unidad_medida,79,n,{width:30});var m=f<=45?n-7:n;a.text(o.detallesCotizacion[p].producto.nombre,100,m,{width:80}),a.text(o.detallesCotizacion[p].precio_unitario.toFixed(2),184,n,{width:30}),a.text(o.detallesCotizacion[p].importe.toFixed(2),212,n),a.text(o.detallesCotizacion[p].tipo_descuento?"%":"Bs",240,n),a.text(o.detallesCotizacion[p].descuento.toFixed(2),250,n),a.text(o.detallesCotizacion[p].total.toFixed(2),270,n)}else{a.text(o.detallesCotizacion[p].producto.codigo,30,n,{width:32}),a.text(o.detallesCotizacion[p].cantidad,64,n,{width:30}),a.text(o.detallesCotizacion[p].producto.unidad_medida,79,n,{width:30});m=f<=45?n-7:n;a.text(o.detallesCotizacion[p].producto.nombre,100,m,{width:80}),a.text(o.detallesCotizacion[p].precio_unitario.toFixed(2),184,n,{width:30}),a.text(o.detallesCotizacion[p].total.toFixed(2),270,n)}ancho=f<=80?20:30,a.rect(15,n-10,282,ancho).stroke(),n+=20,++r==t&&(c+=r)!=o.detallesCotizacion.length&&(a.text("Pag. "+l+" de "+s,260,e[1]-40),a.addPage({size:e,margin:10}),n=140,r=0,l+=1,h.dibujarCabeceraImpresionCotizacionCuartoCarta(a,o,l,s,u,n-20))}a.font("Helvetica-Bold",7),a.text("TOTAL BS.",225,n),a.text(d.toFixed(2),270,n),a.rect(220,n-10,77,20).stroke(),1<s&&a.text("Pag. "+l+" de "+s,255,e[1]-40),a.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");C.open(e,"_blank","location=no")}),x.stop()},h.imprimirCotizacion=function(e){console.log("cotizacion id"),console.log(e),b(e.id,h.usuario.id_empresa).then(function(e){console.log("datos"),console.log(e.cotizacion);var o=e.cotizacion;o.configuracion=e.configuracionGeneralFactura;var t,a=new Date(o.fecha);if(o.fechaTexto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),o.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_OFICIO)console.log("impresion papel oficio"),t=[612,936],itemsPorPagina=20,h.imprimirCotizacionCartaOficio(t,o,itemsPorPagina,e.numero_literal);else if(o.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_CARTA)console.log("impresion papel carta"),t=[612,792],itemsPorPagina=15,h.imprimirCotizacionCartaOficio(t,o,itemsPorPagina,e.numero_literal);else if(o.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_MEDIOOFICIO)console.log("impresion papel medio oficio"),t=[612,468],itemsPorPagina=5,h.imprimirCotizacionCartaOficio(t,o,itemsPorPagina,e.numero_literal);else if(o.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_ROLLO){var i;console.log("impresion papel rollo"),o.detallesCotizacion.length<=2?(console.log("impresion papel rollo detalle <= 2"),i=610):(console.log("impresion papel rollo detalle > 2"),i=610+20*(o.detallesCotizacion.length-2)),console.log("impresion papel rollo alto: "+i),t=[306,i],itemsPorPagina=10,h.imprimirCotizacionRollo(t,o)}else o.configuracion.tamanoPapelCotizacion.nombre_corto==p.FACT_PAPEL_CUARTOCARTA&&(t=[306,396],itemsPorPagina=8,h.imprimirCotizacionCuartoCarta(t,o,itemsPorPagina))})},h.abrirDialogDialogRechazo=function(e){h.cotizacion=e,h.abrirPopup(h.idModalDialogRechazo)},h.cerrarDialogDialogRechazo=function(){h.cerrarPopup(h.idModalDialogRechazo)},h.saveRechazo=function(e){console.log("cotizacion ssssss ",e),e.fecha_estado=new Date(h.convertirFecha(e.fechaTexto)),e.estado="RECHAZADO",w.update({id_cotizacion:e.id},e,function(e){h.mostrarMensaje("actualizado Exitosamente!")},function(e){h.mostrarMensaje("Hubo un problema al guardar.")}),x.stop(),h.cerrarDialogDialogRechazo()},h.imprimirFiltroCajaCartaOficio=function(e,o,t){var a=new PDFDocument({compress:!1,size:[612,792],margin:0}),i=a.pipe(blobStream()),n=Math.ceil(e.length/20),c=100,r=0,l=1;h.imprimirCabeceraFiltroCajaCartaOficio(a,1,n,e,o,t),a.font("Helvetica",7);for(var s=0;s<e.length;s++){a.font("Helvetica",7),a.rect(50,c+9,520,0).stroke(),a.text(s+1,55,c+20),a.font("Helvetica",6),a.text(e[s].sucursal.nombre,80,c+20),e[s].cliente?(a.font("Helvetica",6),a.text(e[s].cliente.razon_social,150,c+15,{width:75}),a.font("Helvetica",7),a.text(e[s].cliente.nit,270,c+20)):(a.text("",150,c+16,{width:75}),a.text("",270,c+20)),e[s].fecha=new Date(e[s].fecha),a.text(e[s].fecha.getHours()+":"+e[s].fecha.getMinutes()+" - ",340,c+21,{width:28});var u=360;if(10<e[s].fecha.getMinutes()&&(u=365),a.text(e[s].fecha.getDate()+"/"+(e[s].fecha.getMonth()+1)+"/"+e[s].fecha.getFullYear(),u,c+21,{width:32}),a.text(e[s].importe,425,c+20),a.text(e[s].usuario.nombre_usuario,455,c+20),a.text(e[s].estado,500,c+16,{width:65}),a.font("Helvetica",7),c+=30,20==++r){a.text(l+" de "+n,520,705);var d=new Date;a.text("FECHA : "+d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+"   Hr:"+d.getHours()+":"+d.getMinutes(),55,705),a.text("USUARIO: "+h.usuario.nombre_usuario,150,705),a.addPage({size:[612,792],margin:10}),c=100,r=0,l+=1,h.imprimirCabeceraFiltroCajaCartaOficio(a,1,n,e,o,t)}}a.font("Helvetica",7),a.text(l+" de "+n,520,705);d=new Date;a.text("FECHA : "+d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear()+"   Hr:"+d.getHours()+":"+d.getMinutes(),55,705),a.text("USUARIO: "+h.usuario.nombre_usuario,150,705),a.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),x.stop()},h.imprimirCabeceraFiltroCajaCartaOficio=function(e,o,t,a,i,n){e.font("Helvetica-Bold",16),e.text("REPORTE DE COTIZACIONES",0,40,{align:"center"}),e.font("Helvetica-Bold",8),e.rect(50,80,520,620).stroke(),e.text("Desde: "+i+" Hasta: "+n,0,55,{align:"center"}),e.font("Helvetica-Bold",7),e.font("Helvetica-Bold",8),e.text("N°",55,90),e.text("Sucursal",80,90),e.text("Razon Social",150,90),e.text("Nit Cliente",270,90),e.text("Fecha",340,90),e.text("Monto",420,90),e.text("Usuario",455,90),e.text("Estado",500,90)},h.imprimirFiltroExcelCajaCartaOficio=function(e){x.start();for(var o=[["N°","Sucursal","Razon Social","Nit Cliente","Fecha","Monto","Usuario","Estado"]],t=0;t<e.length;t++)e[t].fecha=new Date(e[t].fecha);e.sort(function(e,o){return e.fecha>o.fecha?1:e.fecha<o.fecha?-1:0});for(t=0;t<e.length;t++){var a=[];a.push(t+1),a.push(e[t].sucursal.nombre),e[t].cliente?(a.push(e[t].cliente.razon_social),a.push(e[t].cliente.nit)):(a.push(""),a.push("")),a.push(e[t].fecha),a.push(e[t].importe),a.push(e[t].usuario.nombre_usuario),a.push(e[t].estado),o.push(a)}var i="SheetJS",n=new Workbook,c=sheet_from_array_of_arrays(o);n.SheetNames.push(i),n.Sheets[i]=c;var r=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(r)],{type:"application/octet-stream"}),"Reporte-cotizaciones.xlsx"),x.stop()},h.inicio()}]);