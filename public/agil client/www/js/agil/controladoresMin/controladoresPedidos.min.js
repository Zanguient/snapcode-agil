angular.module("agil.controladores").controller("ControladorPedidos",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","blockUI","ClasesTipo","socket","Paginator","PedidosFiltro","ListaGruposProductoUsuario","ProveedoresNit","ListaProductosEmpresaUsuario","GuardarPedido","ListaProveedores","InventarioPaginador","ProductosPaginador","ListaProductosProveedores","ActualizarProductosProveedor","ListaSubGruposProductoEmpresa","ProductosPaginadorSubgrupos","ProductosPaginadorAsignados",function(P,e,o,r,a,t,i,s,v,d,n,c,u,l,p,g,f,m,h,S,b,x,A,E,M){P.usuarioSesion=JSON.parse(s.usuario),convertUrlToBase64Image(P.usuarioSesion.empresa.imagen,function(o){P.usuarioSesion.empresa.imagen=o}),P.idDialogNuevoPedido="modal-nuevo-pedido",P.idDialogProductosProveedor="dialog-productos-proveedor-configuracion",P.idDialogBusquedaProveedor="dialog-Busqueda-proveedor",P.idDialogProductosAsigandosProveedor="dialog-productos-proveedor-asignados",P.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsPedidos(P.idDialogNuevoPedido,P.idDialogProductosProveedor,P.idDialogBusquedaProveedor,P.idDialogProductosAsigandosProveedor),P.buscarAplicacion(P.usuarioSesion.aplicacionesUsuario,t.path().substring(1))}),P.$on("$routeChangeStart",function(o,e){P.eliminarPopup(P.idDialogListadoPedido),P.eliminarPopup(P.idDialogProductosProveedor),P.eliminarPopup(P.idDialogNuevoPedido),P.eliminarPopup(P.idDialogBusquedaProveedor),P.eliminarPopup(P.idDialogProductosAsigandosProveedor)}),P.inicio=function(){P.imprimir={detalle:!1},P.listaProductosProveedor=[],P.seleccionProductosProveedor={seleccionar_todos:!1},P.seleccionProductosProveedorAsignados={seleccionar_todos:!1},P.productosAsignadosPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},P.configuracionPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},P.detallesPedido=[],P.mostarBusquedaProducto=!1,P.ordenProductos=!0,P.esContado=!0,P.alreadyCalculated=!1,P.sucursalesUsuario="";for(var o=0;o<P.usuarioSesion.sucursalesUsuario.length;o++)P.sucursalesUsuario=P.sucursalesUsuario+P.usuarioSesion.sucursalesUsuario[o].sucursal.id,o+1!=P.usuarioSesion.sucursalesUsuario.length&&(P.sucursalesUsuario=P.sucursalesUsuario+",");P.obtenerProveedores(),P.obtenerProductos(),P.obtenerProductosAsignados(),P.filtro={desde:0,hasta:0,tipo:0,proveedor:0,nit:"",sucursal:0,estado:0,id_usuario:""},P.obtenerPaginador(),P.sucursales=P.obtenerSucursales(),P.obtenerSubGruposProductosEmpresaUsuario()},P.obtenerSubGruposProductosEmpresaUsuario=function(){v.start(),A(P.usuarioSesion.id_empresa,P.usuarioSesion.id).then(function(o){v.stop(),0<o.length?P.subGruposProducto=o:(P.subGruposProducto=[],P.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(o){P.subGruposProducto=[];var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.data&&null!==o.data&&""!==o.data?o.data:"Error: Se perdio la conexión.";P.mostrarMensaje(e),v.stop()})},P.obtenerProveedores=function(){m(P.usuarioSesion.id_empresa).then(function(o){P.proveedores=o.proveedores,P.proveedoresProcesado=o.proveedores}).catch(function(o){P.proveedores=[];var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.data&&null!==o.data&&""!==o.data?o.data:"Error: Se perdio la conexión.";P.mostrarMensaje(e)})},P.filtrarProveedores=function(o){void 0!==P.proveedores?P.proveedoresProcesado=e("filter")(P.proveedores,o):P.proveedoresProcesado=[]},P.establecerProveedor=function(o,e){void 0===P.pedido&&(P.pedido={}),P.pedido.proveedor=o,P.productosAsignadosProveedor=[],P.paginatorProductosAsignados.setPages(1),void 0!==e&&P.cerrarModalBusquedaProveedor(),P.pedido.por_proveedor&&P.generarPorProveedor()},P.checkProveedor=function(o){return!!P.pedido&&!!P.pedido.proveedor},P.buscarProveedor=function(o){if(""!=o&&null!=o)return p(P.usuario.id_empresa,o)},P.establecerProducto=function(o,e){P.detallePedido={},o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto;var r=0;0<o.inventarios.length&&o.inventarios.forEach(function(o){r+=o.cantidad}),P.detallePedido={producto:o,precio_unitario:o.precio_unitario,cantidad:1,inventario_disponible:r}},P.guardarPedido=function(o){if(v.start(),void 0!==o&&0<P.detallesPedido.length){var e=new Date,r=o.fecha.split("/").reverse(),a={fecha:new Date(r[0],r[1]-1,r[2],e.getHours(),e.getMinutes()),sucursal:o.sucursal,almacen:o.almacen,proveedor:o.proveedor.id,observacion:o.observacion,grupo:void 0!==o.grupo&&null!==o.grupo?o.grupo:0,detallesPedido:P.detallesPedido,usuario:P.usuarioSesion.id};f(P.usuario.id_empresa,a,P.usuarioSesion.id).then(function(o){o.hasErr?P.mostrarMensaje(o.mensaje):(P.mostrarMensaje(o.mensaje),P.recargarItemsTabla()),v.stop()}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.data&&null!==o.data?o.data:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";P.mostrarMensaje(e)})}else 0<P.detallesPedido.length?P.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar!"):P.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar sin lista de productos!"),v.stop()},P.mostrarBusqueda=function(){P.mostarBusquedaProducto?P.mostarBusquedaProducto=!1:P.mostarBusquedaProducto=!0},P.agregardetallePedido=function(e){null!=e?(P.detallesPedido.some(function(o){return o.producto.id===e.producto.id})?P.detallesPedido.forEach(function(o){o.producto.id===e.producto.id&&(o.cantidad+=e.cantidad)}):P.detallesPedido.push(e),P.detallePedido=void 0):P.mostrarMensaje("Ocurrió un problema, no se puede agregar un valor no definido o nulo.")},P.interceptarTecla=function(o,e,r){13===o.which&&(r?P.enfocar(e):$timeout(function(){$("#"+e).trigger("click")},0))},P.filtrarFiltro=function(o,e,r){if(void 0!==r)for(var a in o)0==o[a]&&(o[a]="");else for(var a in o)""!==o[a]&&null!==o[a]&&void 0!==o[a]||(o[a]=0);if(void 0!==e&&e)return o;P.obtenerPedidos()},P.obtenerPaginador=function(){v.start(),P.paginator=c(),P.paginator.column="fecha",P.paginator.direccion="asc",P.paginator.itemPerPage=10,P.paginator.page=1,P.filtro={desde:0,hasta:0,tipo:0,proveedor:0,nit:"",sucursal:0,estado:0,usuario:""},P.paginator.callBack=P.obtenerPedidos,P.paginator.getSearch(""),v.stop()},P.obtenerPedidos=function(){v.start(),P.filtro=P.filtrarFiltro(P.filtro,!0),P.paginator.filter=P.filtro,u(P.usuarioSesion.id_empresa,P.paginator).then(function(o){o.hasErr?P.mostrarMensaje(o.mensaje):(P.listaPedidos=o.pedidos,P.paginator.setPages(o.paginas)),P.filtro=P.filtrarFiltro(P.filtro,!0,!0),v.stop()}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.data&&null!==o.data?o.data:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";P.mostrarMensaje(e)})},P.obtenerSucursales=function(){for(var o=[],e=0;e<P.usuarioSesion.sucursalesUsuario.length;e++)o.push(P.usuarioSesion.sucursalesUsuario[e].sucursal);return o},P.obtenerAlmacenes=function(e){if(void 0===e&&(P.filtro.sucursal=void 0,P.almacenes=[]),void 0!==e){P.almacenes=[];var o=$.grep(P.sucursales,function(o){return o.id==e})[0];P.almacenes=o?o.almacenes:[]}},P.eliminar=function(r){P.solicitud=r,P.solicitud.solicitudesProductos.map(function(e){ListaInventariosProducto(e.productoSolicitado.id,P.solicitud.almacen.id).then(function(o){e.inventarios=o,e.inventario_disponible_utilizado=e.cantidad,P.solicitud.solicitudesProductos.indexOf(e)==P.solicitud.solicitudesProductos.length-1&&EliminarSolicitudReposicion.save({id_solicitud:r.id},r,function(o){P.mostrarMensaje(o.mensaje),P.recargarItemsTabla(),P.solicitud=void 0,v.stop()},function(o){P.solicitud=void 0,P.mostrarMensaje(err.stack?err.stack:err.message),v.stop()})})}),P.cerrarConfirmacionEliminacion()},P.ver=function(o){},P.interceptarTecla=function(o,e,r){13===o.which&&(r?P.enfocar(e):$timeout(function(){$("#"+e).trigger("click")},0))},P.editar=function(o){},P.sinFuncionalidad=function(){P.mostrarMensaje("Sin funcionalidad")},P.generarPdfSolicitud=function(o){v.start(),P.calcularTotalViveres(o);var e=new PDFDocument({size:[612,792],margin:10,compress:!1}),r=e.pipe(blobStream());(t=(a=new Date).getMinutes())<10&&(t="0"+t),e.font("Helvetica",8);var a,t,i=115,s=0,d=1,n=Math.ceil(P.totalViveresSolicitados.length/29);P.dibujarCabeceraPDFSolicitud(e,d,n);for(var c=0;c<P.totalViveresSolicitados.length&&s<=29;c++)e.font("Helvetica",8),e.text(c+1,65,i),e.text(P.totalViveresSolicitados[c].productoSolicitudBase.codigo,100,i),e.text(P.totalViveresSolicitados[c].productoSolicitudBase.nombre,220,i),e.text(P.totalViveresSolicitados[c].productoSolicitudBase.unidad_medida,400,i),e.text(P.totalViveresSolicitados[c].totalMostrar.toFixed(2),500,i),i+=20,29<++s&&(e.rect(40,105,540,i-115).stroke(),e.text(d+"/"+n,570,i+15),e.font("Helvetica",6),e.text("RESPONSABLE: "+P.usuarioSesion.nombre_usuario,45,i+10),e.text("SOLICITANTE: "+P.totalViveresSolicitados.usuario.persona.nombre_completo,345,i+10),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,i+10),e.addPage({size:[612,792],margin:10}),i=115,s=0,d+=1,P.dibujarCabeceraPDFSolicitud(e,d,n));e.rect(40,105,540,i-115).stroke(),(t=(a=new Date).getMinutes())<10&&(t="0"+t),e.text(d+"/"+n,570,i+15),e.font("Helvetica",6),e.text("RESPONSABLE: "+P.usuarioSesion.nombre_usuario,45,i+5),e.text("SOLICITANTE: "+P.totalViveresSolicitados.usuario.persona.nombre_completo,345,i+5),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,i+5),e.end(),r.on("finish",function(){var o=r.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),v.stop()},P.dibujarCabeceraPDFSolicitud=function(o,e,r){o.font("Helvetica-Bold",12),o.text("CONSUMOS",0,25,{align:"center"}),o.font("Helvetica-Bold",8),o.text("SUCURSAL : ",-40,50,{align:"center"}),o.font("Helvetica",8),o.text(P.totalViveresSolicitados.sucursal.nombre,60,50,{align:"center"}),o.font("Helvetica-Bold",8),o.text("FECHA : ",40,60,{width:40}),o.font("Helvetica",8),o.text(P.fechaATexto(P.totalViveresSolicitados.fecha),75,60,{width:40}),o.font("Helvetica-Bold",14),o.text("N°",380,40,{align:"center"}),o.text(P.totalViveresSolicitados.identificador,440,40,{align:"center"}),o.rect(40,80,540,25).stroke(),o.font("Helvetica-Bold",8),o.text("Nº",65,90),o.text("Código Ítem",100,90),o.text("Producto",220,90),o.text("Unidad medida",380,90),o.text("Cantidad solicitada",480,90)},P.calcularViveresDesdeFiltro=function(a){var t=[];P.totalViveresSolicitados={},P.solicitudesPedido=[],P.solicitudesOperaciones.forEach(function(o,e){if(o.activo||void 0!==a){if(a&&!o.id_pedido){P.solicitudesPedido.push(o.id);r=P.calcularTotalViveres(o,!0);t.push(r)}}else{var r=P.calcularTotalViveres(o,!0);t.push(r)}});var i=[];if(t.forEach(function(r){r.productos.forEach(function(o){var e={almacen:o.almacen,sucursal:o.almacen.sucursal,cantidad:o.cantidad_real,fecha:r.fecha,hora_fecha:r.fecha,usuario:r.usuario,estado:o.estado,producto:o.productoSolicitudBase,costo:o.productoSolicitudBase.inventarios&&o.productoSolicitudBase.inventarios.length?o.productoSolicitudBase.inventarios[0].costo_unitario:0,grupo:o.productoSolicitudBase.grupo,subgrupo:o.productoSolicitudBase.subgrupo,total:(o.productoSolicitudBase.inventarios&&o.productoSolicitudBase.inventarios.length?o.productoSolicitudBase.inventarios[0].costo_unitario:0)*o.cantidad_real,monto:o.monto};i.push(e)})}),a){for(var o=[];0<i.length;){var r=i.pop();if(0===o.length)o.push(r);else{var s,d=!1;o.forEach(function(o,e){o.producto.id!=r.producto.id||d||(d=!0,s=e)}),d&&void 0!==s?(o[s].cantidad+=r.cantidad,o[s].total=o[s].cantidad*o[s].costo):o.push(r)}}return o}return i},P.reporteExcel=function(o){if(v.start(),P.imprimir.detalle){(t=[]).push(["Nro.","Sucursal","Almacén","Hora-fecha","Usuario","Estado","Detalle","Unidad","Grupo","Subgrupo","Cantidad","Costo","Total"]);for(var e=P.calcularViveresDesdeFiltro(),r=[],a=0;a<e.length;a++)(r=[]).push(a+1),r.push(e[a].almacen.sucursal.nombre),r.push(e[a].almacen.nombre),r.push(new Date(e[a].fecha).toLocaleTimeString()+" "+new Date(e[a].fecha).toLocaleDateString()),r.push(e[a].usuario.nombre_usuario),r.push(e[a].estado?"Abierto":"Cerrado"),r.push(e[a].producto.nombre),r.push(e[a].producto.unidad_medida),r.push(e[a].grupo.nombre),r.push(e[a].subgrupo.nombre),r.push(e[a].cantidad),r.push(e[a].costo),r.push(e[a].total.toFixed(2)),t.push(r);v.stop()}else{var t;(t=[]).push(["Nro.","Sucursal","proveedor","Hora-fecha","Estado"]);for(r=[],a=0;a<P.listaPedidos.length;a++)(r=[]).push(a+1),r.push(P.listaPedidos[a].sucursal.nombre),r.push(P.listaPedidos[a].proveedor.razon_social),r.push(new Date(P.listaPedidos[a].fecha).toLocaleTimeString()+" "+new Date(P.listaPedidos[a].fecha).toLocaleDateString()),r.push(P.listaPedidos[a].recibido?"Completado":"En espera"),t.push(r);v.stop()}if(o)P.reportePdf(t),v.stop();else{var i="SheetJS",s=new Workbook,d=sheet_from_array_of_arrays(t);d["!cols"]=[{wch:5},{wch:18},{wch:18},{wch:12},{wch:15},{wch:15},{wch:12},{wch:25},{wch:12},{wch:12},{wch:12}],d["!rows"]=[{hpx:28,level:3}],s.SheetNames.push(i),s.Sheets[i]=d;var n=XLSX.write(s,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(n)],{type:"application/octet-stream"}),"REPORTE OPERACIONES.xlsx"),v.stop()}},P.reportePdf=function(o){var e=new PDFDocument({size:"letter",margin:10,compress:!1}),r=e.pipe(blobStream());(t=(a=new Date).getMinutes())<10&&(t="0"+t),P.posXforPdf=[],e.font("Helvetica",8);var a,t,i=65,s=115,d=0,n=1,c=Math.ceil(o.length/29);if(P.dibujarCabeceraReportePdf(e,o),P.imprimir.detalle){i=50;for(var u=0;u<o.length&&d<=29;u++){var l=i;if(e.font("Helvetica",8),0<u){for(var p=0;p<o[u].length;p++)e.text(o[u][p],l,s,{width:40},{align:"center"}),l=P.posXforPdf[p];s+=20,d++}29<d&&(e.rect(40,105,540,s-115).stroke(),e.text(n+"/"+c,570,s+15),e.font("Helvetica",6),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,s+10),e.addPage({size:[612,792],margin:10}),s=115,d=0,n+=1,P.dibujarCabeceraPDFSolicitud(e,n,c))}}else for(u=0;u<o.length&&d<=29;u++){l=i;if(e.font("Helvetica",8),0<u){for(p=0;p<o[u].length;p++)e.text(o[u][p],l,s,{width:40}),l+=0==p?30:60;s+=20,d++}29<d&&(e.rect(40,105,540,s-115).stroke(),e.text(n+"/"+c,570,s+15),e.font("Helvetica",6),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,s+10),e.addPage({size:[612,792],margin:10}),s=115,d=0,n+=1,P.dibujarCabeceraPDFSolicitud(e,n,c))}e.rect(40,105,540,650).stroke(),(t=(a=new Date).getMinutes())<10&&(t="0"+t),e.text(n+"/"+c,570,765),e.font("Helvetica",6),e.text("IMPRESION : "+a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear()+" Hr. "+a.getHours()+":"+t,175,765),e.end(),r.on("finish",function(){var o=r.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),v.stop()},P.dibujarCabeceraReportePdf=function(o,e){if(o.font("Helvetica-Bold",12),o.text("REPORTE OPERACIONES",0,25,{align:"center"}),o.font("Helvetica-Bold",8),o.text("FECHA : ",40,60,{width:40}),o.font("Helvetica",8),o.text((new Date).toLocaleDateString(),75,60,{width:40}),o.rect(40,80,540,25).stroke(),o.font("Helvetica-Bold",8),P.imprimir.detalle){px=50;for(var r=0;r<e[0].length;r++)o.text(e[0][r],px,90),0==r?px+=4*e[0][r].length+5:(P.imprimir.detalle,px+=4*e[0][r].length+15),P.posXforPdf.push(px)}else{px=65;for(r=0;r<e[0].length;r++)o.text(e[0][r],px,90),0==r?(px+=20,P.posXforPdf.push(px)):P.imprimir.detalle?px+=40:px+=60}o.font("Helvetica",8)},P.abrirModalProductosProveedor=function(o){P.checkProveedor(o)?(P.buscarProductos(null,P.pedido),P.abrirPopup(P.idDialogProductosProveedor)):P.mostrarMensaje("Seleccione un proveedor para ver su asignación de productos..")},P.seleccionarProductoAsignado=function(e){if(e.seleccionado)P.productosProveedorSeleccionados.some(function(o){return o===e.id})||P.productosProveedorSeleccionados.push(e);else{var o=P.productosProveedorSeleccionados.indexOf(e);0<=o&&!e.seleccionado?P.productosProveedorSeleccionados.splice(o,1):-1==o&&e.seleccionado&&P.productosProveedorSeleccionados.push(e.id)}},P.agregarProductosSeleccionados=function(){0<P.productosProveedorSeleccionados.length?P.productosProveedorSeleccionados.forEach(function(o,e,r){P.detallePedido={producto:o,precio_unitario:o.precio_unitario,cantidad:1,id_grupo:o.id_grupo,id_subgrupo:o.id_subgrupo},P.agregardetallePedido(P.detallePedido),e===r.length&&P.cerrarModalProductosAsignadosProveedor()}):P.mostrarMensaje("No se seleccionó ningún producto para ser agregado.")},P.eliminarDetallePedido=function(o){P.detallesPedido.splice(P.detallesPedido.indexOf(o),1)},P.generarPorProveedor=function(){if(P.pedido.proveedor)if(P.pedido.por_proveedor)if(0<P.pedido.proveedor.productos.length){P.paginatorProductosAsignados.filter=P.productosAsignadosPorveedor.grupo?P.productosAsignadosPorveedor.grupo:{id:0};b(P.usuarioSesion.id_empresa,P.pedido.proveedor).then(function(o){if(o.hasErr)P.mostrarMensaje(o.mensaje),P.listaProductosProveedor=[];else if(o.productos){var e=o.productos.split(",");P.listaProductosProveedor=e.map(function(o){return parseInt(o)}),M(P.usuarioSesion.id_empresa,P.paginatorProductosAsignados,P.usuarioSesion.id,P.listaProductosProveedor,!0).then(function(o){o.hasErr?P.mostrarMensaje(o.mensaje):(P.paginatorProductosAsignados.setPages(o.paginas),P.productosAsignadosProveedor=o.productos,P.productosAsignadosProveedor.forEach(function(e){P.listaProductosProveedor.some(function(o){return o===e.id})&&(P.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,id_grupo:e.id_grupo,id_subgrupo:e.id_subgrupo},P.agregardetallePedido(P.detallePedido))})),v.stop()}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";P.mostrarMensaje(e)})}else P.mostrarMensaje("El proveedor no tiene productos asignados."),P.listaProductosProveedor=[];v.stop()}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";P.mostrarMensaje(e)})}else P.mostrarMensaje("El proveedor no tiene productos asignados.");else P.detallePedido={},P.detallesPedido=[];else P.mostrarMensaje("Seleccione un proveedor.")},P.verificarAsignacionProductosProveedor=function(){0<P.listaProductosProveedor.length&&P.listaProductosProveedor.forEach(function(e){P.productosAsignacionProveedor.forEach(function(o){o.id===e&&(o.seleccionado=!0)})})},P.verificarSeleccionProductosProveedor=function(){0<P.listaProductosProveedorSeleccionados.length&&P.listaProductosProveedorSeleccionados.forEach(function(e){P.productosProveedorSeleccionados.forEach(function(o){o.id===e&&(o.seleccionado=!0)})})},P.obtenerProductos=function(){P.paginatorProductos=c(),P.paginatorProductos.column="nombre",P.paginatorProductos.filter=P.grupo,P.paginatorProductos.callBack=P.buscarProductos,P.paginatorProductos.getSearch("",null,null)},P.buscarProducto=function(o,e){if(void 0!==P.pedido)return""!=o&&null!=o&&null==e&&P.pedido.almacen?g(P.usuarioSesion.id_empresa,o,P.usuarioSesion.id,P.pedido.almacen):""!=o&&null!=o&&e&&P.pedido.almacen?g(P.usuarioSesion.id_empresa,o,P.usuarioSesion.id,P.pedido.almacen):void P.mostrarMensaje("Seleccione un almacen.");P.mostrarMensaje("Seleccione un almacen.")},P.filtrarProductosSeleccionadosPorGrupo=function(){if(0<P.detallesPedido.length){var e=[];P.detallesPedido.forEach(function(o){o.id_subgrupo===P.pedido.grupo&&e.push(o)}),0<e.length?P.detallesPedido=e.map(function(o){return o}):P.mostrarMensaje("No existen productos pertenecientes al grupo seleccionado. No se realizaron cambios.")}},P.modificarListaProductosProveedor=function(o){var e=P.listaProductosProveedor.indexOf(o.id);0<=e&&!o.seleccionado?P.listaProductosProveedor.splice(e,1):-1==e&&o.seleccionado&&P.listaProductosProveedor.push(o.id)},P.modificarListaProductosProveedorSeleccionados=function(o){var e=P.listaProductosProveedorSeleccionados.indexOf(o.id);0<=e&&!o.seleccionado?P.listaProductosProveedorSeleccionados.splice(e,1):-1==e&&o.seleccionado&&P.listaProductosProveedorSeleccionados.push(o.id)},P.seleccionarTodosParaAsignar=function(){P.seleccionProductosProveedor.seleccionar_todos?P.productosAsignacionProveedor.forEach(function(o){o.seleccionado=!0,P.modificarListaProductosProveedor(o)}):(P.productosAsignacionProveedor.forEach(function(o){o.seleccionado=!1}),P.modificarListaProductosProveedor(producto))},P.seleccionarTodosAsignados=function(){P.listaProductosProveedorSeleccionados=[],P.seleccionProductosProveedorAsignados.seleccionar_todos?P.productosAsignadosProveedor.forEach(function(o){o.seleccionado=!0,P.productosProveedorSeleccionados.push(o),P.modificarListaProductosProveedorSeleccionados(o)}):P.productosAsignadosProveedor.forEach(function(o){o.seleccionado=!1,P.productosProveedorSeleccionados.push(o),P.modificarListaProductosProveedorSeleccionados(o)})},P.actualizarProductosProveedor=function(){x(P.usuarioSesion.id_empresa,P.listaProductosProveedor,P.pedido.proveedor).then(function(o){o.hasErr?P.mostrarMensaje(o.mensaje):(P.mostrarMensaje(o.mensaje),P.cerrarModalProductosProveedor())}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";P.mostrarMensaje(e)})},P.verificarPulso=function(o,e){13===o.keyCode&&P.buscarProductos(1)},P.verificarPulsoAsignados=function(o,e){13===o.keyCode&&P.buscarProductosAsignados(1)},P.buscarProductos=function(o,e){v.start(),o&&(P.paginatorProductos.currentPage=o),P.paginatorProductos.filter=P.configuracionPorveedor.grupo?P.configuracionPorveedor.grupo:{id:0},P.paginatorProductos.search=P.configuracionPorveedor.textoBusqueda?P.configuracionPorveedor.textoBusqueda:0,E(P.usuarioSesion.id_empresa,P.paginatorProductos,P.usuarioSesion.id).then(function(o){o.hasErr?P.mostrarMensaje(o.mensaje):(P.paginatorProductos.setPages(o.paginas),P.productosAsignacionProveedor=o.productos,P.pedido&&P.pedido.proveedor&&b(P.usuarioSesion.id_empresa,P.pedido.proveedor).then(function(o){if(o.hasErr)P.mostrarMensaje(o.mensaje),P.listaProductosProveedor=[];else if(o.productos){var e=o.productos.split(",");P.listaProductosProveedor=e.map(function(o){return parseInt(o)}),P.verificarAsignacionProductosProveedor()}else P.listaProductosProveedor=[];v.stop()}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";P.mostrarMensaje(e)}));v.stop()}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";P.mostrarMensaje(e)})},P.obtenerProductosAsignados=function(){P.paginatorProductosAsignados=c(),P.paginatorProductosAsignados.column="nombre",P.paginatorProductosAsignados.filter=P.grupo,P.paginatorProductosAsignados.callBack=P.buscarProductosAsignados,P.paginatorProductosAsignados.getSearch("",null,null)},P.buscarProductosAsignados=function(o,e){(v.start(),o&&(P.paginatorProductosAsignados.currentPage=o),void 0===P.pedido)?(P.pedido={},v.stop()):P.pedido.proveedor?(P.paginatorProductosAsignados.filter=P.productosAsignadosPorveedor.grupo?P.productosAsignadosPorveedor.grupo:{id:0},P.paginatorProductosAsignados.search=P.productosAsignadosPorveedor.textoBusqueda?P.productosAsignadosPorveedor.textoBusqueda:0,b(P.usuarioSesion.id_empresa,P.pedido.proveedor).then(function(o){if(o.hasErr)P.mostrarMensaje(o.mensaje),P.listaProductosProveedor=[];else if(o.productos){var e=o.productos.split(",");P.listaProductosProveedor=e.map(function(o){return parseInt(o)}),M(P.usuarioSesion.id_empresa,P.paginatorProductosAsignados,P.usuarioSesion.id,P.listaProductosProveedor).then(function(o){o.hasErr?P.mostrarMensaje(o.mensaje):(P.paginatorProductosAsignados.setPages(o.paginas),P.productosAsignadosProveedor=o.productos,P.listaProductosProveedorSeleccionados=[],P.verificarSeleccionProductosProveedor()),v.stop()}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";P.mostrarMensaje(e)})}else P.listaProductosProveedor=[];v.stop()}).catch(function(o){v.stop();var e=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";P.mostrarMensaje(e)})):P.mostrarMensaje("El proveedor no tiene productos asignados.")},P.cerrarModalProductosProveedor=function(){P.productosAsignacionProveedor=[],P.listaProductosProveedor=[],P.cerrarPopup(P.idDialogProductosProveedor)},P.abrirModalNuevoPedido=function(){P.abrirPopup(P.idDialogNuevoPedido)},P.cerrarModalNuevoPedido=function(){P.pedido={},P.detallesPedido={},P.cerrarPopup(P.idDialogNuevoPedido)},P.abrirmodalBusquedaProveedor=function(){P.filtrarProveedores(""),P.abrirPopup(P.idDialogBusquedaProveedor)},P.cerrarModalBusquedaProveedor=function(){P.cerrarPopup(P.idDialogBusquedaProveedor)},P.abrirmodalProductosAsignadosProveedor=function(){void 0===P.pedido&&(P.pedido={por_proveedor:!1}),void 0!==P.productosProveedorSeleccionados&&null!==P.productosProveedorSeleccionados||(P.productosProveedorSeleccionados=[]),P.pedido.proveedor?(P.buscarProductosAsignados(),P.abrirPopup(P.idDialogProductosAsigandosProveedor)):P.mostrarMensaje("Seleccione un proveedor.")},P.cerrarModalProductosAsignadosProveedor=function(o){o&&(P.productosProveedorSeleccionados=[],P.seleccionProductosProveedorAsignados.seleccionar_todos=!1),P.cerrarPopup(P.idDialogProductosAsigandosProveedor)},P.inicio()}]);