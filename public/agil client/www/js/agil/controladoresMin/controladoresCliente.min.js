angular.module("agil.controladores").controller("ControladorClientes",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","$timeout","ClientesPaginador","Cliente","Clientes","Empresas","ClientesEmpresa","uiGmapGoogleMapApi","$cordovaGeolocation","DatoCodigoSiguienteClienteEmpresa","DestinosCliente","RazonesSocialesCliente","ClasesTipoEmpresa","Diccionario","Tipos","ClasesTipo","VerificarUsuarioEmpresa",function(u,e,i,t,o,a,p,n,c,d,s,l,h,f,m,g,v,C,b,_,P,E,x){p.start(),u.usuario=JSON.parse(i.usuario),u.idModalConceptoEdicionCorrelativos="dialog-conceptos-correlativos",u.IdModalVerificarCuenta="modal-verificar-cuenta",u.inicio=function(){u.diccionario=_,u.obtenerEmpresas(),u.obtenerClientes(),u.obtenerDestinos(),u.obtenerTiposPrecio(),f.then(function(e){console.log(e),u.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},u.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE}})},u.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsCliente("modal-wizard-cliente","modal-wizard-cliente-vista","dialog-eliminar-cliente","modal-wizard-container-cliente-edicion","modal-wizard-container-cliente-vista",u.idModalConceptoEdicionCorrelativos,u.IdModalVerificarCuenta),u.buscarAplicacion(u.usuario.aplicacionesUsuario,t.path().substring(1)),p.stop()}),u.obtenerCorrelativoCliente=function(){p.start(),b("correlativo_clientes",u.usuario.id_empresa).then(function(e){1<e.clases.length?e.clases.sort(function(e,t){return e.correlativo=e.nombre_corto.split("-")[0],e.correlativo_maximo=e.nombre_corto.split("-")[1],t.correlativo=t.nombre_corto.split("-")[0],t.correlativo_maximo=t.nombre_corto.split("-")[1],e.correlativo-t.correlativo}):1==e.clases.length&&(e.clases[0].correlativo=e.clases[0].nombre_corto.split("-")[0],e.clases[0].correlativo_maximo=e.clases[0].nombre_corto.split("-")[1]),u.correlativosClientes=e,p.stop()})},u.cargarCodigo=function(e){e.codigo=e.correlativo.correlativo},u.obtenerClientes=function(){u.abs=e.Math.abs,u.itemsPorPagina=10,u.buscarClientes(1,u.itemsPorPagina,"")},u.verificarPulso=function(e,t){13===e.keyCode&&u.buscarClientes(1,u.itemsPorPagina,t)},u.buscarClientes=function(e,t,o){p.start(),u.itemsPorPagina=t,""==o||null==o?o=0:u.textoBusqueda=o,u.paginaActual=e,c(u.usuario.id_empresa,e,t,o).then(function(e){u.paginas=[];for(var t=1;t<=e.paginas;t++)u.paginas.push(t);u.clientes=e.clientes,p.stop()})},u.abrirPopupCliente=function(e){u.mostrarMap=!1,u.cliente=e,u.map={center:{latitude:u.cliente.latitud,longitude:u.cliente.longitud},zoom:17,bounds:{northeast:{latitude:u.cliente.latitud,longitude:u.cliente.longitud}}},u.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE},u.coordsUpdates=0,u.dynamicMoveCtr=0,u.marker={id:0,coords:{latitude:u.cliente.latitud,longitude:u.cliente.longitud},options:{draggable:!0},events:{dragend:function(e,t,o){u.cliente.latitud=e.getPosition().lat(),u.cliente.longitud=e.getPosition().lng(),u.marker.options={draggable:!0,labelAnchor:"100 0",labelClass:"marker-labels"}}}},u.abrirPopup("modal-wizard-cliente")},u.mostrarMapa=function(){u.mostrarMap=!0,n(function(){u.$apply(function(){google.maps.event.trigger(u.map,"resize")})},2e3)},u.crearNuevoCliente=function(){u.obtenerCorrelativoCliente(),u.steps=[{cabeza:"cabeza-datos-cli",cuerpo:"cuerpo-datos-cli"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"}],console.log(u.steps),g(u.usuario.id_empresa).then(function(e){u.ultimo_codigo=e.ultimo_codigo?"CLI"+e.ultimo_codigo:0;var t=JSON.parse(i.usuario),o=new d({id_empresa:t.id_empresa,latitud:-17.403800007775388,longitud:-66.11349012184144,clientes_razon:[],cliente_destinos:[]});o.codigo="CLI"+((e.ultimo_codigo?e.ultimo_codigo:0)+1),u.abrirPopupCliente(o)})},u.verCliente=function(e){(u.cliente=e).fecha1=new Date(e.fecha1),e.fecha2=new Date(e.fecha2),u.cliente.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear(),u.cliente.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear(),u.abrirPopup("modal-wizard-cliente-vista")},u.cerrarPopPupVista=function(){u.cerrarPopup("modal-wizard-cliente-vista")},u.cerrarPopPupNuevoCliente=function(){u.cerrarPopup("modal-wizard-cliente")},u.modificarCliente=function(e){e.fecha1&&(e.fecha1=new Date(e.fecha1),e.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear()),e.fecha2&&(e.fecha2=new Date(e.fecha2),e.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear()),u.abrirPopupCliente(e)},u.verCliente=function(e){(u.cliente=e).fecha1=new Date(e.fecha1),e.fecha2=new Date(e.fecha2),u.cliente.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear(),u.cliente.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear(),u.abrirPopup("modal-wizard-cliente-vista")},u.cerrarPopPupVista=function(){u.cerrarPopup("modal-wizard-cliente-vista")},u.cerrarPopPupNuevoCliente=function(){u.cerrarPopup("modal-wizard-cliente")},u.modificarCliente=function(e){e.fecha1&&(e.fecha1=new Date(e.fecha1),e.fechatexto1=e.fecha1.getDate()+"/"+(e.fecha1.getMonth()+1)+"/"+e.fecha1.getFullYear()),e.fecha2&&(e.fecha2=new Date(e.fecha2),e.fechatexto2=e.fecha2.getDate()+"/"+(e.fecha2.getMonth()+1)+"/"+e.fecha2.getFullYear()),u.abrirPopupCliente(e)},u.mostrarConfirmacionEliminacion=function(e){u.cliente=new d(e),u.abrirPopup("dialog-eliminar-cliente")},u.cerrarConfirmacionEliminacion=function(){u.cerrarPopup("dialog-eliminar-cliente")},u.eliminarCliente=function(e){p.start(),u.cerrarConfirmacionEliminacion(),e.$delete(),u.mostrarMensaje("Eliminado exitosamente!"),u.recargarItemsTabla(),p.stop()},u.saveForm=function(a,e){if("Siguiente"!=$("#siguiente").text().trim()){p.start();var t=document.getElementById("doc-nit").files[0],o=document.getElementById("doc-funda").files[0],i=document.getElementById("doc-licencia").files[0],n=document.getElementById("doc-ci").files[0],c=document.getElementById("doc-seguro-social").files[0],s=[];[t,o,i,n,c].forEach(function(e,t,o){e&&s.push(e),t==o.length-1&&(0<s.length?s.forEach(function(t,o,i){r=new FileReader,t?(r.onloadend=function(e){t.nombre=t.name,t.data=e.target.result,o===i.length-1&&(a.fecha1=null,a.fechatexto1&&(a.fecha1=new Date(u.convertirFecha(a.fechatexto1))),a.fecha2=null,a.fechatexto2&&(a.fecha2=new Date(u.convertirFecha(a.fechatexto2))),a.id?d.update({idCliente:a.id},a,function(e){p.stop(),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje(e.mensaje),u.recargarItemsTabla()}):a.$save(function(e){p.stop(),u.cliente=new d({}),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje(e.mensaje),u.recargarItemsTabla()},function(e){p.stop(),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje("Ocurrio un problema al momento de guardar!"),u.recargarItemsTabla()}))},r.readAsBinaryString(t)):o===i.length-1&&(a.fecha1=null,a.fechatexto1&&(a.fecha1=new Date(u.convertirFecha(a.fechatexto1))),a.fecha2=null,a.fechatexto2&&(a.fecha2=new Date(u.convertirFecha(a.fechatexto2))),a.id?d.update({idCliente:a.id},a,function(e){p.stop(),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje(e.mensaje),u.recargarItemsTabla()}):a.$save(function(e){p.stop(),u.cliente=new d({}),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje(e.mensaje),u.recargarItemsTabla()},function(e){p.stop(),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje("Ocurrio un problema al momento de guardar!"),u.recargarItemsTabla()}))}):(a.fecha1=null,a.fechatexto1&&(a.fecha1=new Date(u.convertirFecha(a.fechatexto1))),a.fecha2=null,a.fechatexto2&&(a.fecha2=new Date(u.convertirFecha(a.fechatexto2))),a.id?d.update({idCliente:a.id},a,function(e){p.stop(),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje(e.mensaje),u.recargarItemsTabla()}):a.$save(function(e){p.stop(),u.cliente=new d({}),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje(e.mensaje),u.recargarItemsTabla()},function(e){p.stop(),u.cerrarPopPupNuevoCliente(),u.mostrarMensaje("Ocurrio un problema al momento de guardar!"),u.recargarItemsTabla()})))})}if(!u.usuario.usar_creditos){var l=$("#credito").attr("class");console.log(l),"ng-hide active"==l&&$("#siguiente").click()}if(!u.usuario.usar_razon_social){l=$("#razonsocial").attr("class");console.log(l),"ng-hide active"==l&&$("#siguiente").click()}if(!u.usuario.destinos){l=$("#destinos").attr("class");console.log(l),"ng-hide active"==l&&$("#siguiente").click()}},u.regresarwizard=function(){if(!u.usuario.destinos){var e=$("#destinos").attr("class");console.log(e),"ng-hide complete"==e&&$("#anterior").click()}if(!u.usuario.usar_razon_social){e=$("#razonsocial").attr("class");console.log(e),"ng-hide complete"==e&&$("#anterior").click()}if(!u.usuario.usar_creditos){e=$("#credito").attr("class");console.log(e),"ng-hide complete"==e&&$("#anterior").click()}},u.obtenerEmpresas=function(){p.start(),l().then(function(e){u.empresas=e,p.stop()})},u.agregarClienteRazon=function(e){e.nit&&e.razon_social&&(-1==u.cliente.clientes_razon.indexOf(e)&&u.cliente.clientes_razon.push(e),u.cliente_razon={})},u.modificarClienteRazon=function(e){u.cliente_razon=e},u.removerClienteRazon=function(e){e.eliminado=!0},u.obtenerDestinos=function(){v(u.usuario.id_empresa).then(function(e){u.destinos=e})},u.agregarDestino=function(e){if(e.id){var t={id_destino:e.id,destino:e};-1==u.cliente.cliente_destinos.indexOf(t)&&u.cliente.cliente_destinos.push(t),u.dato_destino={}}},u.removerDestino=function(e){e.eliminado=!0},u.generarExcelComprobacionDatosClientes=function(e,t){u.obtenerClientes();for(var o=[["N°","CODIGO","CLIENTE","NIT PRINCIPAL","RAZÓN SOCIAL PRINCIPAL","DIRECCION","TELEFONO UNO","TELEFONO DOS","TELEFONO TRES","UBIC. GEO.","RUBRO","CATEGORIA","FECHA IMP. 1","FECHA IMP. 2","TEXTO 1","TEXTO 2","RAZONES CLIENTE","NIT -RAZON","CODIGO SAP","DESTINOS","DIRECCION DESTINO"]],i=0;i<u.clientes.length;i++){var a=[];0<u.clientes[i].clientes_razon.length?u.clientes[i].clientes_razon.map(function(t,e){0<u.clientes[i].cliente_destinos.length?u.clientes[i].cliente_destinos.map(function(e){(a=[]).push(i+1),a.push(u.clientes[i].codigo),a.push(u.clientes[i].contacto),a.push(u.clientes[i].nit),a.push(u.clientes[i].razon_social),a.push(u.clientes[i].direccion),a.push(u.clientes[i].telefono1),a.push(u.clientes[i].telefono2),a.push(u.clientes[i].telefono3),a.push(u.clientes[i].ubicacion_geografica),a.push(u.clientes[i].rubro),a.push(u.clientes[i].categoria),a.push(u.fechaATexto(u.clientes[i].fecha1)),a.push(u.fechaATexto(u.clientes[i].fecha2)),a.push(u.clientes[i].texto2),a.push(u.clientes[i].texto2),a.push(t.razon_social),a.push(t.nit),a.push(t.codigo_sap),a.push(e.destino.destino),a.push(e.destino.direccion),o.push(a)}):((a=[]).push(i+1),a.push(u.clientes[i].codigo),a.push(u.clientes[i].contacto),a.push(u.clientes[i].nit),a.push(u.clientes[i].razon_social),a.push(u.clientes[i].direccion),a.push(u.clientes[i].telefono1),a.push(u.clientes[i].telefono2),a.push(u.clientes[i].telefono3),a.push(u.clientes[i].ubicacion_geografica),a.push(u.clientes[i].rubro),a.push(u.clientes[i].categoria),a.push(u.fechaATexto(u.clientes[i].fecha1)),a.push(u.fechaATexto(u.clientes[i].fecha2)),a.push(u.clientes[i].texto2),a.push(u.clientes[i].texto2),a.push(t.razon_social),a.push(t.nit),a.push(t.codigo_sap),a.push("sin dato"),a.push("sin dato"),o.push(a))}):0<u.clientes[i].cliente_destinos.length?u.clientes[i].cliente_destinos.map(function(e){(a=[]).push(i+1),a.push(u.clientes[i].codigo),a.push(u.clientes[i].contacto),a.push(u.clientes[i].nit),a.push(u.clientes[i].razon_social),a.push(u.clientes[i].direccion),a.push(u.clientes[i].telefono1),a.push(u.clientes[i].telefono2),a.push(u.clientes[i].telefono3),a.push(u.clientes[i].ubicacion_geografica),a.push(u.clientes[i].rubro),a.push(u.clientes[i].categoria),a.push(u.fechaATexto(u.clientes[i].fecha1)),a.push(u.fechaATexto(u.clientes[i].fecha2)),a.push(u.clientes[i].texto2),a.push(u.clientes[i].texto2),a.push("sin dato"),a.push("sin dato"),a.push("sin dato"),a.push(e.destino.destino),a.push(e.destino.direccion),o.push(a)}):((a=[]).push(i+1),a.push(u.clientes[i].codigo),a.push(u.clientes[i].contacto),a.push(u.clientes[i].nit),a.push(u.clientes[i].razon_social),a.push(u.clientes[i].direccion),a.push(u.clientes[i].telefono1),a.push(u.clientes[i].telefono2),a.push(u.clientes[i].telefono3),a.push(u.clientes[i].ubicacion_geografica),a.push(u.clientes[i].rubro),a.push(u.clientes[i].categoria),a.push(u.fechaATexto(u.clientes[i].fecha1)),a.push(u.fechaATexto(u.clientes[i].fecha2)),a.push(u.clientes[i].texto2),a.push(u.clientes[i].texto2),a.push("sin dato"),a.push("sin dato"),a.push("sin dato"),a.push("sin dato"),a.push("sin dato"),o.push(a))}var n="SheetJS",r=new Workbook,c=sheet_from_array_of_arrays(o);r.SheetNames.push(n),r.Sheets[n]=c;var s=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"COMPROBACION DATOS CLIENTES RAZONES DESTINOS.xlsx"),p.stop()},u.subirExcelClientes=function(e){var t,o,i=e.target.files;for(o=i[t=0];t!=i.length;++t){var a=new FileReader;o.name;a.onload=function(e){p.start();var t=e.target.result,o=XLSX.read(t,{type:"binary"}),i=o.SheetNames[0],a=2,n=o.Sheets[i],r=[];do{var c={};c.codigo=null!=n["A"+a]&&""!=n["A"+a]?n["A"+a].v.toString():null,c.razon_social=null!=n["B"+a]&&""!=n["B"+a]?n["B"+a].v.toString():null,c.nit=null!=n["C"+a]&&""!=n["C"+a]?n["C"+a].v.toString():null,c.direccion=null!=n["D"+a]&&""!=n["D"+a]?n["D"+a].v.toString():null,c.telefono1=null!=n["E"+a]&&""!=n["E"+a]?n["E"+a].v.toString():null,c.telefono2=null!=n["F"+a]&&""!=n["F"+a]?n["F"+a].v.toString():null,c.telefono3=null!=n["G"+a]&&""!=n["G"+a]?n["G"+a].v.toString():null,c.contacto=null!=n["H"+a]&&""!=n["H"+a]?n["H"+a].v.toString():null,c.ubicacion_geografica=null!=n["I"+a]&&""!=n["I"+a]?n["I"+a].v.toString():null,c.rubro=null!=n["J"+a]&&""!=n["J"+a]?n["J"+a].v.toString():null,c.categoria=null!=n["K"+a]&&""!=n["K"+a]?n["K"+a].v.toString():null,c.fecha1=null!=n["L"+a]&&""!=n["L"+a]?new Date(u.convertirFecha(n["L"+a].v.toString())):null,c.fecha2=null!=n["M"+a]&&""!=n["M"+a]?new Date(u.convertirFecha(n["M"+a].v.toString())):null,c.texto1=null!=n["N"+a]&&""!=n["N"+a]?n["N"+a].v.toString():null,c.texto2=null!=n["O"+a]&&""!=n["O"+a]?n["O"+a].v.toString():null,c.tipoPrecioVenta=null!=n["P"+a]&&""!=n["P"+a]?n["P"+a].v.toString():null,null!=c.tipoPrecioVenta&&(c.tipoPrecioVenta=u.tiposPrecios.clases.find(function(e){return c.tipoPrecioVenta.toUpperCase()===e.nombre})),r.push(c),a++,0}while(null!=n["A"+a]);u.guardarClientes(r),p.stop()},a.readAsBinaryString(o)}},u.subirExcelRazonesSocialesCliente=function(e){var t,o,i=e.target.files;for(o=i[t=0];t!=i.length;++t){var a=new FileReader;o.name;a.onload=function(e){p.start();var t=e.target.result,o=XLSX.read(t,{type:"binary"}),i=o.SheetNames[0],a=2,n=o.Sheets[i],r=[];do{var c={};c.codigo=null!=n["A"+a]&&""!=n["A"+a]?n["A"+a].v.toString():null,c.razon_social=null!=n["B"+a]&&""!=n["B"+a]?n["B"+a].v.toString():null,c.nit=null!=n["C"+a]&&""!=n["C"+a]?n["C"+a].v.toString():null,c.codigo_sap=null!=n["D"+a]&&""!=n["D"+a]?n["D"+a].v.toString():null,r.push(c),a++,0}while(null!=n["A"+a]);u.guardarRazonesSocialesClientes(r),p.stop()},a.readAsBinaryString(o)}},u.guardarRazonesSocialesClientes=function(e){C(e,u.usuario.id_empresa).then(function(e){p.stop(),u.mostrarMensaje(e.mensaje),u.recargarItemsTabla()})},u.guardarClientes=function(e){new h({clientes:e,id_empresa:u.usuario.id_empresa}).$save(function(e){p.stop(),u.mostrarMensaje(e.mensaje),u.recargarItemsTabla()},function(e){p.stop(),u.mostrarMensaje("Ocurrio un problema al momento de guardar!"),u.recargarItemsTabla()})},u.abrirModalConceptoEdicionCorrelativos=function(e){p.start(),b("correlativo_clientes",u.usuario.id_empresa).then(function(e){1<e.clases.length?(e.clases.sort(function(e,t){return e.correlativo=e.nombre_corto.split("-")[0],e.correlativo_maximo=e.nombre_corto.split("-")[1],t.correlativo=t.nombre_corto.split("-")[0],t.correlativo_maximo=t.nombre_corto.split("-")[1],e.correlativo-t.correlativo}),u.minimo=parseInt(e.clases[e.clases.length-1].correlativo_maximo)+1):1==e.clases.length&&(e.clases[0].correlativo=e.clases[0].nombre_corto.split("-")[0],e.clases[0].correlativo_maximo=e.clases[0].nombre_corto.split("-")[1],u.minimo=parseInt(e.clases[0].correlativo_maximo)+1),u.tipo_edicion=e,u.clase={},u.abrirPopup(u.idModalConceptoEdicionCorrelativos),p.stop()})},u.cerrarModalConceptoEdicionCorrelativos=function(){u.cerrarPopup(u.idModalConceptoEdicionCorrelativos)},u.agregarConceptoEdicion=function(e){e.nombre_corto=e.correlativo+"-"+e.correlativo_maximo,-1==u.tipo_edicion.clases.indexOf(e)&&(u.tipo_edicion.clases.length,u.tipo_edicion.clases.push(e),u.minimo=e.correlativo_maximo+1),u.clase={}},u.modificarConceptoEdicion=function(e){e.correlativo=parseInt(e.correlativo),e.correlativo_maximo=parseInt(e.correlativo_maximo),u.clase=e},u.removerConceptoEdicion=function(e){e.eliminado=!0},u.guardarConceptoEdicion=function(t){p.start(),P.update({id_tipo:t.id},t,function(e){E(t.nombre_corto).then(function(e){t=e,p.stop(),u.cerrarModalConceptoEdicionCorrelativos(),u.mostrarMensaje("Guardado Exitosamente!")})})},u.abrirModalVerificarCuenta=function(e,t){u.dato=e,u.tipoDatosPermiso=t,u.abrirPopup(u.IdModalVerificarCuenta)},u.cerrarModalVerificarCuenta=function(){u.cerrarPopup(u.IdModalVerificarCuenta)},u.verificarCuentaAdmin=function(e){x.save({id_empresa:u.usuario.id_empresa},e,function(e){e.type?(u.mostrarMensaje(e.message),"correlativo"==u.tipoDatosPermiso&&u.modificarConceptoEdicion(u.dato),u.cerrarModalVerificarCuenta()):u.mostrarMensaje(e.message)})},u.obtenerTiposPrecio=function(){p.start(),b("T_PAGO_PRODUCTO",u.usuario.id_empresa).then(function(e){u.tiposPrecios=e,p.stop()})},u.$on("$routeChangeStart",function(e,t){u.eliminarPopup("modal-wizard-cliente"),u.eliminarPopup("modal-wizard-cliente-vista"),u.eliminarPopup("dialog-eliminar-cliente"),u.eliminarPopup(u.idModalConceptoEdicionCorrelativos),u.eliminarPopup(u.IdModalVerificarCuenta)}),u.inicio()}]);