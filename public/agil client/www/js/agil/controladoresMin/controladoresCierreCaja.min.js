angular.module("agil.controladores").controller("ControladorCierresCaja",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","Clases","CierreCaja","ListaCierresCaja","CierreCajaDatos","VentasContado","VentasCredito","PagosVenta","ConfiguracionImpresionEmpresaDato","ListaBancos","PagosCompra","ComprasContado","ComprasCredito","CierresCajaPendiente","Paginator","CierreCajaDatosItem",function(M,e,a,t,r,S,o,i,c,n,s,u,d,p,g,l,C,m,f,v,h,x){S.start(),M.idModalWizardCierreEdicion="modal-wizard-cierre",M.idModalDeposito="modal-deposito",M.idModalWizardCierreVista="modal-wizard-cierre-vista",M.idModalEliminarCierre="dialog-eliminar-cierre",M.idModalContenedorCierreEdicion="modal-wizard-container-cierre-edicion",M.idModalContenedorCierreVista="modal-wizard-container-cierre-vista",M.idModalDatosAdicionalesReporte="dialog-datos-adicionales-reporte-cierre",M.usuario=JSON.parse(e.usuario),M.inicio=function(){M.obtenerCierres(M.usuario.id_empresa),M.obtenerBancos(M.usuario.id_empresa),M.sucursalesUsuario="";for(var e=0;e<M.usuario.sucursalesUsuario.length;e++)M.sucursalesUsuario=M.sucursalesUsuario+M.usuario.sucursalesUsuario[e].sucursal.id,e+1!=M.usuario.sucursalesUsuario.length&&(M.sucursalesUsuario=M.sucursalesUsuario+",");o("DC").then(function(e){M.destinos=e.clases,S.stop()})},M.$on("$viewContentLoaded",function(){resaltarPestaÃ±a(a.path().substring(1)),ejecutarScriptsCierre(M.idModalWizardCierreEdicion,M.idModalContenedorCierreEdicion,M.idModalWizardCierreVista,M.idModalContenedorCierreVista,M.idModalEliminarCierre,M.idModalDeposito,M.idModalDatosAdicionalesReporte),M.buscarAplicacion(M.usuario.aplicacionesUsuario,a.path().substring(1))}),M.seleccionarCierresPendientes=function(e){for(var a=0;a<M.sucursales.length;a++)for(var t=0;t<sucursalesUsuario.length;t++)M.sucursales[a].id==sucursalesUsuario[t].id&&(M.sucursales[a].ticked=!0)},M.llenarCierresPendientes=function(e,a){e.cierresPendientesOpciones=[];for(var t=0;t<a.length;t++){var r={name:a[t].cierreCaja.usuario.nombre_usuario+" - "+a[t].cierreCaja.importe,maker:"",ticked:!1,id:a[t].id,importe:a[t].cierreCaja.importe,usuario:a[t].cierreCaja.usuario.nombre_usuario};e.cierresPendientesOpciones.push(r)}},M.cambiarCierrePendiente=function(e){console.log(e)},M.crearNuevoCierre=function(){var e=new Date,a=new Date,t=u(M.sucursalesUsuario,e,a,M.usuario.id,0);t.then(function(l){(t=d(M.sucursalesUsuario,e,a,M.usuario.id,0)).then(function(s){(t=p(M.sucursalesUsuario,e,a,M.usuario.id,0)).then(function(n){(t=C(M.sucursalesUsuario,e,a,M.usuario.id,0)).then(function(i){(t=m(M.sucursalesUsuario,e,a,M.usuario.id,0)).then(function(o){(t=f(M.sucursalesUsuario,e,a,M.usuario.id,0)).then(function(r){(t=v(M.sucursalesUsuario)).then(function(e){var a=!1;M.nuevosCierresCaja=[];for(var t=0;t<M.usuario.sucursalesUsuario.length;t++)M.cierreCaja=new c({fecha:new Date,id_empresa:M.usuario.id_empresa,id_usuario:M.usuario.id,saldo_inicial:0,gastos:0}),M.cierreCaja.ventasContado=$.grep(l,function(e){return e.almacen.id_sucursal==M.usuario.sucursalesUsuario[t].sucursal.id}),M.cierreCaja.ventasCredito=$.grep(s,function(e){return e.almacen.id_sucursal==M.usuario.sucursalesUsuario[t].sucursal.id}),M.cierreCaja.pagosVenta=$.grep(n,function(e){return e.venta.almacen.id_sucursal==M.usuario.sucursalesUsuario[t].sucursal.id}),M.cierreCaja.pagosCompra=$.grep(i,function(e){return e.compra.almacen.id_sucursal==M.usuario.sucursalesUsuario[t].sucursal.id}),M.cierreCaja.comprasContado=$.grep(o,function(e){return e.almacen.id_sucursal==M.usuario.sucursalesUsuario[t].sucursal.id}),M.cierreCaja.comprasCredito=$.grep(r,function(e){return e.almacen.id_sucursal==M.usuario.sucursalesUsuario[t].sucursal.id}),M.cierreCaja.cierresPendientesLeidos=$.grep(e,function(e){return e.id_sucursal==M.usuario.sucursalesUsuario[t].sucursal.id}),M.cierreCaja.sucursal=M.usuario.sucursalesUsuario[t].sucursal,M.cierreCaja.id_sucursal=M.usuario.sucursalesUsuario[t].sucursal.id,(0<M.cierreCaja.ventasContado.length||0<M.cierreCaja.ventasCredito.length||0<M.cierreCaja.pagosVenta.length||0<M.cierreCaja.pagosCompra.length||0<M.cierreCaja.comprasContado.length||0<M.cierreCaja.comprasCredito.length||0<M.cierreCaja.cierresPendientesLeidos.length)&&(a=!0,M.cierreCaja.cierresPendientes=[],0<M.cierreCaja.cierresPendientesLeidos.length&&M.llenarCierresPendientes(M.cierreCaja,M.cierreCaja.cierresPendientesLeidos),M.nuevosCierresCaja.push(M.cierreCaja));S.stop(),a?M.abrirPopup(M.idModalWizardCierreEdicion):(M.cerrarPopPupEdicion(),M.mostrarMensaje("No existen Movimientos!"))})})})})})})})},M.calcularImporteCierre=function(e){for(var a=0,t=0;t<e.cierresPendientes.length;t++)a+=e.cierresPendientes[t].importe;return e.importe=Math.round(100*(a+e.saldo_inicial+M.sumarVentasContado(e.ventasContado)+M.sumarVentasCredito(e.ventasCredito)-M.sumarComprasContado(e.comprasContado)-M.sumarComprasCredito(e.comprasCredito)+M.sumarPagosVenta(e.pagosVenta)-M.sumarPagosCompra(e.pagosCompra)-e.gastos))/100,e.importe},M.cerrarPopPupNuevoCierre=function(){M.cerrarPopup(M.idModalWizardCierreEdicion)},M.cerrarPopPupDeposito=function(){M.cerrarPopup(M.idModalDeposito)},M.verCierreCaja=function(e){M.cierreCaja=e,M.abrirPopup(M.idModalWizardCierreVista)},M.cerrarPopPupVista=function(){M.cerrarPopup(M.idModalWizardCierreVista)},M.cerrarPopPupEdicion=function(){M.cerrarPopup(M.idModalWizardCierreEdicion)},M.modificarCierre=function(e){M.cierreCaja=e,M.abrirPopup(M.idModalWizardCierreEdicion)},M.mostrarConfirmacionEliminacion=function(e){M.cierreCaja=new c(e),M.abrirPopup(M.idModalEliminarCierre)},M.cerrarConfirmacionEliminacion=function(){M.cerrarPopup(M.idModalEliminarCierre)},M.eliminarCierre=function(e){S.start(),M.cerrarConfirmacionEliminacion(),banco.$delete(),M.mostrarMensaje("Eliminado exitosamente!"),M.recargarItemsTabla(),S.stop()},M.cerrarCaja=function(e){var a=$("#siguiente").text().trim();if(console.log(a),"Siguiente"!=a){S.start();for(var t=0;t<e.length;t++)M.guardarCierreCaja(e[t]),M.generarReporteCierreCaja(e[t].sucursal,e[t],e[t].ventasContado,e[t].ventasCredito,e[t].pagosVenta,e[t].pagosCompra,e[t].comprasContado,e[t].comprasCredito,e[t].cierresPendientes);M.cerrarPopPupNuevoCierre(),M.recargarItemsTabla(),M.mostrarMensaje("Guardado Exitosamente!")}},M.mostrarDatosAdicionalesReporte=function(e){M.cierreCajaImpresion=e,M.abrirPopup(M.idModalDatosAdicionalesReporte)},M.cerrarPopupDatosAdicionalesReporte=function(){M.cerrarPopup(M.idModalDatosAdicionalesReporte)},M.imprimirCierreCaja=function(l){var c=x(l.id);c.then(function(e){l=e,M.cerrarPopup(M.idModalDatosAdicionalesReporte);var n=new Date,s=new Date;(c=u(M.sucursalesUsuario,n,s,l.id_usuario,l.id)).then(function(i){(c=d(M.sucursalesUsuario,n,s,l.id_usuario,l.id)).then(function(o){(c=p(M.sucursalesUsuario,n,s,l.id_usuario,l.id)).then(function(r){(c=C(M.sucursalesUsuario,n,s,l.id_usuario,l.id)).then(function(t){(c=m(M.sucursalesUsuario,n,s,l.id_usuario,l.id)).then(function(a){(c=f(M.sucursalesUsuario,n,s,l.id_usuario,l.id)).then(function(e){M.generarReporteCierreCaja(l.sucursal,l,i,o,r,t,a,e,l.cajasSiguienteTurnoCerradas)})})})})})})})},M.generarReporteCierreCaja=function(i,n,s,l,c,u,d,p,C){var e=g(M.usuario.id_empresa,0);console.log(n),e.then(function(e){var a=[612,792];if(e.usar){if(e.tamanoPapelCierreCaja.nombre_corto==M.diccionario.FACT_PAPEL_OFICIO)a=[612,936],M.imprimirReporteCierreCajaCartaOficio(i,a,n,s,l,c,u,d,p,C);else if(e.tamanoPapelCierreCaja.nombre_corto==M.diccionario.FACT_PAPEL_CARTA)a=[612,792],M.imprimirReporteCierreCajaCartaOficio(i,a,n,s,l,c,u,d,p,C);else if(e.tamanoPapelCierreCaja.nombre_corto==M.diccionario.FACT_PAPEL_MEDIOOFICIO)a=[612,468],M.imprimirReporteCierreCajaCartaOficio(i,a,n,s,l,c,u,d,p,C);else if(e.tamanoPapelCierreCaja.nombre_corto==M.diccionario.FACT_PAPEL_ROLLO){var t=s.length+l.length+c.length+u.length+d.length+p.length+C.length;if(n.conMovimientoProductos){for(var r=0;r<s.length;r++)t+=s[r].detallesVenta.length;for(r=0;r<l.length;r++)t+=l[r].detallesVenta.length;for(r=0;r<d.length;r++)t+=d[r].detallesCompra.length;for(r=0;r<p.length;r++)t+=p[r].detallesCompra.length}if(n.conSaldoProductos){for(r=0;r<s.length;r++)t+=s[r].detallesVenta.length;for(r=0;r<l.length;r++)t+=l[r].detallesVenta.length;for(r=0;r<d.length;r++)t+=d[r].detallesCompra.length;for(r=0;r<p.length;r++)t+=p[r].detallesCompra.length}o=t<=2?470:470+20*(t-2),console.log(t),a=[227,o],M.imprimirReporteCierreCajaRollo(i,a,n,s,l,c,u,d,p,C)}}else{var o;t=s.length+l.length+c.length+u.length+d.length+p.length+C.length;if(n.conMovimientoProductos){for(r=0;r<s.length;r++)t+=s[r].detallesVenta.length;for(r=0;r<l.length;r++)t+=l[r].detallesVenta.length;for(r=0;r<d.length;r++)t+=d[r].detallesCompra.length;for(r=0;r<p.length;r++)t+=p[r].detallesCompra.length}if(n.conSaldoProductos){for(r=0;r<s.length;r++)t+=s[r].detallesVenta.length;for(r=0;r<l.length;r++)t+=l[r].detallesVenta.length;for(r=0;r<d.length;r++)t+=d[r].detallesCompra.length;for(r=0;r<p.length;r++)t+=p[r].detallesCompra.length}o=t<=2?470:470+20*(t-2),console.log(t),a=[227,o],M.imprimirReporteCierreCajaRollo(i,a,n,s,l,c,u,d,p,C)}})},M.imprimirReporteCierreCajaCartaOficio=function(e,a,t,r,o,i,n,s,l,c){var u=new PDFDocument({size:a,margin:0}),d=u.pipe(blobStream());u.font("Helvetica-Bold",15),u.text("CIERRE DE CAJA",55,50),u.text("SUCURSAL: "+e.nombre,200,50),u.font("Helvetica-Bold",8),u.text("SALDO INICIAL: ",55,80),u.text(t.saldo_inicial,350,80),u.font("Helvetica-Bold",8),u.text("VENTAS AL CONTADO: ",55,100),u.font("Helvetica",8);for(var p=100,C=0,g=0,m=0,f=0;f<r.length;f++)u.text("No. "+r[f].factura,55,p+20),u.text(r[f].cliente.razon_social,100,p+20),u.text(r[f].total,300,p+20),C+=r[f].total,p+=20;u.font("Helvetica-Bold",8),u.text(C,350,100),u.font("Helvetica-Bold",8),u.text("VENTAS AL CREDITO: ",55,p+20),u.font("Helvetica",8);var v=p+20;p+=20;var h=0;for(f=0;f<o.length;f++)0<o[f].pagosVenta.length?0<o[f].pagosVenta[0].a_cuenta_anterior&&(u.text("No. "+o[f].factura,55,p+20),u.text(o[f].cliente.razon_social,100,p+20),u.text(o[f].pagosVenta[0].a_cuenta_anterior,300,p+20),h+=o[f].pagosVenta[0].a_cuenta_anterior,p+=20):o[f].a_cuenta&&(u.text("No. "+o[f].factura,55,p+20),u.text(o[f].cliente.razon_social,100,p+20),u.text(o[f].a_cuenta,300,p+20),h+=o[f].a_cuenta,p+=20);u.font("Helvetica-Bold",8),u.text(h,350,v),u.font("Helvetica-Bold",8),u.text("COMPRAS AL CONTADO: ",55,p+20),u.font("Helvetica",8);var x=p+20;p+=20;var _=0;for(f=0;f<s.length;f++)u.text("No. "+s[f].factura,55,p+20),u.text(s[f].proveedor.razon_social,100,p+20),u.text(s[f].total,300,p+20),_+=s[f].total,p+=20;u.font("Helvetica-Bold",8),u.text(_,350,x),u.text("COMPRAS AL CREDITO: ",55,p+20),u.font("Helvetica",8);var P=p+20;p+=20;var D=0;for(f=0;f<l.length;f++)0<l[f].pagosCompra.length?0<l[f].pagosCompra[0].a_cuenta_anterior&&(u.text("No. "+l[f].factura,55,p+20),u.text(l[f].proveedor.razon_social,100,p+20),u.text(l[f].pagosCompra[0].a_cuenta_anterior,300,p+20),D+=l[f].pagosCompra[0].a_cuenta_anterior,p+=20):l[f].a_cuenta&&(u.text("No. "+l[f].factura,55,p+20),u.text(l[f].proveedor.razon_social,100,p+20),u.text(l[f].a_cuenta,300,p+20),D+=l[f].a_cuenta,p+=20);u.font("Helvetica-Bold",8),u.text(D,350,P);var A=p+20;u.text("COBROS REALIZADOS: ",55,p+20),u.font("Helvetica",8),p+=20;for(f=0;f<i.length;f++)u.text("No. "+i[f].venta.factura,55,p+20),u.text(i[f].venta.cliente.razon_social,100,p+20),u.text(i[f].monto_pagado,300,p+20),g+=i[f].monto_pagado,p+=20;u.text(g,350,A),u.font("Helvetica-Bold",8);var E=p+20;u.text("PAGOS REALIZADOS: ",55,p+20),u.font("Helvetica",8),p+=20;for(f=0;f<n.length;f++)u.text("No. "+n[f].compra.factura,55,p+20),u.text(n[f].compra.proveedor.razon_social,100,p+20),u.text(n[f].monto_pagado,300,p+20),m+=n[f].monto_pagado,p+=20;u.text(m,350,E),u.font("Helvetica-Bold",8),u.text("GASTOS: ",55,p+40),u.text(t.gastos,350,p+40),u.text("SALDO FINAL CAJA: ",55,p+60),u.text(t.importe,350,p+60),u.text("---------------------------------------------                       ---------------------------------------------",0,p+100,{align:"center"}),u.text("ENTREGUE CONFORME                                     RECIBI CONFORME",0,p+130,{align:"center"}),u.end(),d.on("finish",function(){var e=d.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),S.stop()},M.imprimirReporteCierreCajaRollo=function(e,a,t,r,o,i,n,s,l,c){var u=new PDFDocument({size:a,margins:{top:10,bottom:10,left:10,right:20}}),d=u.pipe(blobStream());if(t.fecha=new Date(t.fecha),u.moveDown(2),u.font("Helvetica-Bold",8),u.text("CIERRE DE CAJA",{align:"center"}),u.text("SUCURSAL: "+e.nombre,{align:"center"}),u.text("DEL: "+t.fecha.getDate()+"/"+(t.fecha.getMonth()+1)+"/"+t.fecha.getFullYear(),{align:"center"}),0<c.length){u.moveDown(.4);var p=u.y;u.text("SALDO ANTERIORES TURNOS: ",{align:"left"}),u.font("Helvetica",8),u.moveDown(.4);for(var C=u.y,g=0,m=0;m<c.length;m++)u.text(c[m].cierreCaja?c[m].cierreCaja.usuario.nombre_usuario:c[m].usuario,60,C,{width:90}),u.text(c[m].cierreCaja?c[m].cierreCaja.importe:c[m].importe,150,C),g+=c[m].cierreCaja?c[m].cierreCaja.importe:c[m].importe,C+=20;u.font("Helvetica-Bold",8),u.text(g,0,p,{align:"right"}),u.y=C,u.moveDown(.4),u.x=10}u.moveDown(.4),u.font("Helvetica-Bold",8);var f=u.y;u.text("SALDO INICIAL: ",{align:"left",width:100}),u.text(t.saldo_inicial,0,f,{align:"right"}),u.x=10,u.moveDown(.8),u.font("Helvetica-Bold",8);var v=u.y;u.text("VENTAS AL CONTADO: ",{align:"left"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y,suma=0,sumaPago=0;for(m=sumaCobro=0;m<r.length;m++)u.text("No. "+r[m].factura,20,C),u.text(r[m].cliente.razon_social,60,C,{width:90}),u.text(r[m].total,150,C),suma+=r[m].total,C+=20;u.font("Helvetica-Bold",8),u.text(suma,0,v,{align:"right"}),u.y=C,u.moveDown(.4),u.x=10,u.font("Helvetica-Bold",8);var h=u.y;u.text("VENTAS AL CREDITO: ",{align:"left"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y;var x=0;for(m=0;m<o.length;m++)0<o[m].pagosVenta.length?0<o[m].pagosVenta[0].a_cuenta_anterior&&(u.text("No. "+o[m].factura,20,C),u.text(o[m].cliente.razon_social,60,C,{width:90}),u.text(o[m].pagosVenta[0].a_cuenta_anterior,150,C),x+=o[m].pagosVenta[0].a_cuenta_anterior,C+=20):(u.text("No. "+o[m].factura,20,C),u.text(o[m].cliente.razon_social,60,C,{width:90}),u.text(o[m].a_cuenta,150,C),x+=o[m].a_cuenta,C+=20);u.font("Helvetica-Bold",8),u.text(x,0,h,{align:"right"}),u.y=C,u.moveDown(.4),u.x=10,u.font("Helvetica-Bold",8);var _=u.y;u.text("COMPRAS AL CONTADO: ",{align:"left"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y;var P=0;for(m=0;m<s.length;m++)u.text("No. "+s[m].factura,20,C),u.text(s[m].proveedor.razon_social,60,C,{width:90}),u.text(s[m].total,150,C),P+=s[m].total,C+=20;u.font("Helvetica-Bold",8),u.text(P,0,_,{align:"right"}),u.y=C,u.moveDown(.4),u.x=10;var D=u.y;u.text("COMPRAS AL CREDITO: ",{align:"left"}),u.font("Helvetica",8),C=u.y;var A=0;for(m=0;m<l.length;m++)0<l[m].pagosCompra.length?0<l[m].pagosCompra[0].a_cuenta_anterior&&(u.text("No. "+l[m].factura,20,C),u.text(l[m].proveedor.razon_social,60,C),u.text(l[m].pagosCompra[0].a_cuenta_anterior,150,C),A+=l[m].pagosCompra[0].a_cuenta_anterior,C+=20):l[m].a_cuenta&&(u.text("No. "+l[m].factura,20,C),u.text(l[m].proveedor.razon_social,60,C),u.text(l[m].a_cuenta,150,C),A+=l[m].a_cuenta,C+=20);u.font("Helvetica-Bold",8),u.text(A,0,D,{align:"right"}),u.y=C,u.moveDown(.4),u.x=10;var E=u.y;u.text("COBROS REALIZADOS: ",{align:"left"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y;for(m=0;m<i.length;m++)u.text("No. "+i[m].venta.factura,20,C),u.text(i[m].venta.cliente.razon_social,60,C,{width:90}),u.text(i[m].monto_pagado,150,C),sumaPago+=i[m].monto_pagado,C+=20;u.font("Helvetica-Bold",8),u.text(sumaPago,0,E,{align:"right"}),u.y=C,u.moveDown(.4),u.x=10;var O=u.y;u.text("PAGOS REALIZADOS: ",{align:"left"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y;for(m=0;m<n.length;m++)u.text("No. "+n[m].compra.factura,20,C),u.text(n[m].compra.proveedor.razon_social,60,C,{width:90}),u.text(n[m].monto_pagado,150,C),sumaCobro+=n[m].monto_pagado,C+=20;if(u.font("Helvetica-Bold",8),u.text(sumaCobro,0,O,{align:"right"}),u.y=C,u.moveDown(.4),u.x=10,u.font("Helvetica-Bold",8),f=u.y,u.text("GASTOS: ",{align:"left"}),u.text(t.gastos,0,f,{align:"right"}),u.x=10,u.moveDown(.4),f=u.y,u.text("SALDO FINAL CAJA: ",{align:"left"}),u.text(t.importe,0,f,{align:"right"}),u.moveDown(1.6),u.x=10,t.conMovimientoProductos){u.font("Helvetica-Bold",8),u.text("RESUMEN MOVIMIENTOS VENTA PRODUCTOS: ",{align:"center"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y;for(m=0;m<r.length;m++)for(var j=0;j<r[m].detallesVenta.length;j++)u.text(r[m].detallesVenta[j].cantidad,20,C),u.text(r[m].detallesVenta[j].producto.nombre,50,C,{width:100}),u.text(r[m].detallesVenta[j].total,160,C),C+=20;for(m=0;m<o.length;m++)for(j=0;j<o[m].detallesVenta.length;j++)u.text(o[m].detallesVenta[j].cantidad,20,C),u.text(o[m].detallesVenta[j].producto.nombre,50,C,{width:100}),u.text(o[m].detallesVenta[j].total,160,C),C+=20;u.y=C,u.moveDown(.4),u.x=10,u.font("Helvetica-Bold",8),u.text("RESUMEN MOVIMIENTOS COMPRA PRODUCTOS: ",{align:"center"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y;for(m=0;m<s.length;m++)for(j=0;j<s[m].detallesCompra.length;j++)u.text(s[m].detallesCompra[j].cantidad,20,C),u.text(s[m].detallesCompra[j].producto.nombre,50,C,{width:100}),u.text(s[m].detallesCompra[j].total,160,C),C+=20;for(m=0;m<l.length;m++)for(j=0;j<l[m].detallesCompra.length;j++)u.text(l[m].detallesCompra[j].cantidad,20,C),u.text(l[m].detallesCompra[j].producto.nombre,50,C,{width:100}),u.text(l[m].detallesCompra[j].total,160,C),C+=20;u.y=C,u.moveDown(.4),u.x=10}if(t.conSaldoProductos){u.font("Helvetica-Bold",8),u.text("RESUMEN SALDOS DE VENTA PRODUCTOS: ",{align:"center"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y;for(m=0;m<r.length;m++)for(j=0;j<r[m].detallesVenta.length;j++){u.text(r[m].detallesVenta[j].producto.nombre,50,C,{width:100});for(var R=0,V=0;V<r[m].detallesVenta[j].producto.inventarios.length;V++)r[m].detallesVenta[j].producto.inventarios[V].almacen.id_sucursal==e.id&&(R+=r[m].detallesVenta[j].producto.inventarios[V].cantidad);u.text(R+" Und.",160,C),C+=20}for(m=0;m<o.length;m++)for(j=0;j<o[m].detallesVenta.length;j++){u.text(o[m].detallesVenta[j].producto.nombre,50,C,{width:100});for(R=0,V=0;V<o[m].detallesVenta[j].producto.inventarios.length;V++)o[m].detallesVenta[j].producto.inventarios[V].almacen.id_sucursal==e.id&&(R+=o[m].detallesVenta[j].producto.inventarios[V].cantidad);u.text(R+" Und.",160,C),C+=20}u.y=C,u.moveDown(.4),u.x=10,u.font("Helvetica-Bold",8),u.text("RESUMEN SALDOS DE COMPRA PRODUCTOS: ",{align:"center"}),u.font("Helvetica",8),u.moveDown(.4),C=u.y;for(m=0;m<s.length;m++)for(j=0;j<s[m].detallesCompra.length;j++){u.text(s[m].detallesCompra[j].producto.nombre,50,C,{width:100});for(R=0,V=0;V<s[m].detallesCompra[j].producto.inventarios.length;V++)s[m].detallesCompra[j].producto.inventarios[V].almacen.id_sucursal==e.id&&(R+=s[m].detallesCompra[j].producto.inventarios[V].cantidad);u.text(R+" Und.",160,C),C+=20}for(m=0;m<l.length;m++)for(j=0;j<l[m].detallesCompra.length;j++){u.text(l[m].detallesCompra[j].producto.nombre,50,C,{width:100});for(R=0,V=0;V<l[m].detallesCompra[j].producto.inventarios.length;V++)l[m].detallesCompra[j].producto.inventarios[V].almacen.id_sucursal==e.id&&(R+=l[m].detallesCompra[j].producto.inventarios[V].cantidad);u.text(R+" Und.",160,C),C+=20}u.y=C,u.moveDown(.4),u.x=10}u.font("Helvetica-Bold",8),u.x=10,u.text("-----------------------------      -----------------------------",0,C+100,{align:"center"}),u.text("ENTREGUE CONFORME   RECIBI CONFORME",{align:"center"}),u.moveDown(.4),u.font("Helvetica",8);var w=new Date;u.text("Usuario: "+M.usuario.nombre_usuario+" "+w.getDate()+"/"+(w.getMonth()+1)+"/"+w.getFullYear()+" "+w.getHours()+":"+w.getMinutes(),{align:"center"}),u.end(),d.on("finish",function(){var e=d.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),S.stop()},M.sumarVentasContado=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].total;return a},M.sumarVentasCredito=function(e){for(var a=0,t=0;t<e.length;t++)0<e[t].pagosVenta.length?0<e[t].pagosVenta[0].a_cuenta_anterior&&(a+=e[t].pagosVenta[0].a_cuenta_anterior):a+=e[t].a_cuenta;return a},M.sumarComprasContado=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].total;return a},M.sumarComprasCredito=function(e){for(var a=0,t=0;t<e.length;t++)0<e[t].pagosCompra.length?0<e[t].pagosCompra[0].a_cuenta_anterior&&(a+=e[t].pagosCompra[0].a_cuenta_anterior):e[t].a_cuenta&&(a+=e[t].a_cuenta);return a},M.sumarPagosVenta=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].monto_pagado;return a},M.sumarPagosCompra=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].monto_pagado;return a},M.guardarCierreCaja=function(e){S.start(),e.$save(function(e){S.stop()},function(e){S.stop(),M.cerrarPopPupNuevoCierre(),M.mostrarMensaje("Ocurrio un problema al momento de guardar!"),M.recargarItemsTabla()})},M.guardarDeposito=function(e){S.start(),e.fecha_entrega=new Date(M.convertirFecha(e.fechaEntregaTexto)),s.update({id_cierre_caja:e.id},e,function(e){S.stop(),M.cerrarPopPupDeposito(),M.mostrarMensaje("Guardado Exitosamente!"),M.recargarItemsTabla()})},M.obtenerCierres=function(e){M.paginator=h(),M.paginator.column="fecha",M.paginator.direction="desc",M.paginator.callBack=M.obtenerLista;var a=0<$.grep(M.usuario.rolesUsuario,function(e){return e.rol.nombre==M.diccionario.ROL_ADMINISTRADOR}).length?0:M.usuario.id;M.filtro={empresa:M.usuario.id_empresa,usuario:a},M.paginator.getSearch("",M.filtro,null)},M.obtenerLista=function(){S.start(),n(M.paginator).then(function(e){M.paginator.setPages(e.paginas),M.cierresCaja=e.cierresCaja,S.stop()})},M.abrirPopupDeposito=function(e){M.cierreCaja=e,M.abrirPopup(M.idModalDeposito)},M.obtenerBancos=function(e){S.start(),l(e).then(function(e){M.bancos=e,S.stop()})},M.$on("$routeChangeStart",function(e,a){M.eliminarPopup(M.idModalWizardCierreEdicion),M.eliminarPopup(M.idModalWizardCierreVista),M.eliminarPopup(M.idModalEliminarCierre),M.eliminarPopup(M.idModalDeposito),M.eliminarPopup(M.idModalDatosAdicionalesReporte)}),M.inicio()}]);