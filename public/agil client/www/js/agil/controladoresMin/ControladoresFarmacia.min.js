angular.module("agil.controladores").controller("ControladoresFarmacia",["$scope","$localStorage","$location","$templateCache"," $route","$filter","$window","$timeout","blockUI","ClasesTipo","ConfiguracionVentaVistaDatos","ProductosPanel","InventarioPaginador","ListaInventariosProducto","ListaProductosEmpresa","Venta","PacientesNit","ImprimirSalidaFarmacia","Ventas","VentasFarmacia","DatosVentaFarmacia","VentaEmpresaDatos","VentaFarmacia",function(g,o,e,a,t,n,i,r,h,c,s,l,u,d,p,m,v,f,b,P,_,D,V){g.usuario=JSON.parse(o.usuario),convertUrlToBase64Image(g.usuario.empresa.imagen,function(e){g.usuario.empresa.imagen=e}),g.idModalWizardFarmaciaEdicion="modal-wizard-farmacia-edicion",g.idModalInventario="dialog-productos-venta",g.idModalWizardVentaVista="modal-wizard-venta-vista",g.idModalPago="dialog-pago",g.$on("$viewContentLoaded",function(){ejecutarScriptsFarmacia(g.idModalWizardFarmaciaEdicion,g.idModalInventario,g.idModalWizardVentaVista,g.idModalPago)}),g.inicio=function(){g.ordenProductos=!0,g.esContado=!0,g.obtenerCargos(),g.obtenerTiposDePago(),g.obtenerConfiguracionVentaVista(),g.sucursales=g.obtenerSucursales(),g.sucursalesUsuario="";for(var e=0;e<g.usuario.sucursalesUsuario.length;e++)g.sucursalesUsuario=g.sucursalesUsuario+g.usuario.sucursalesUsuario[e].sucursal.id,e+1!=g.usuario.sucursalesUsuario.length&&(g.sucursalesUsuario=g.sucursalesUsuario+",");g.obtenerMovimientosEgreso(),g.detalleVenta={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1}},g.obtenerTiposDePago=function(){h.start(),c("TIPA").then(function(e){g.tiposPago=e.clases,h.stop()})},g.obtenerConfiguracionVentaVista=function(){h.start(),s(g.usuario.id_empresa).then(function(e){g.configuracionVentaVista=e,h.stop()})},g.obtenerSucursales=function(){for(var e=[],a=0;a<g.usuario.sucursalesUsuario.length;a++)e.push(g.usuario.sucursalesUsuario[a].sucursal);return e},g.obtenerMovimientosEgreso=function(){h.start(),c("MOVEGR").then(function(e){console.log("la entidada es  ",e.clases),g.movimientosEgreso=n("filter")(e.clases,function(e){return"PROFORMA"==e.nombre||"PRE_FACTURACION"==e.nombre||"PLANILLA_ANTICIPOS"==e.nombre}),h.stop()})},g.obtenerTipoEgreso=function(e){var a=e.nombre_corto;g.tipoEgreso=a},g.obtenerAlmacenesActividades=function(e){g.obtenerAlmacenes(e),g.obtenerActividades(e)},g.obtenerAlmacenes=function(a){g.almacenes=[];var e=$.grep(g.sucursales,function(e){return e.id==a})[0];g.almacenes=e.almacenes,g.venta.almacen=1==g.almacenes.length?g.almacenes[0]:null,g.venta.almacen&&g.cargarProductos()},g.cargarProductos=function(){l(g.usuario.id_empresa,g.venta.almacen.id).then(function(e){for(var a=0;a<e.length;a++)e[a].activar_inventario&&(e[a].inventario_disponible=g.obtenerInventarioTotal(e[a]));if(g.productos=e,angular.isDefined(o.productosProcesados)){g.productosProcesados=e;for(a=0;a<o.productosProcesados.length;a++)for(var t=0;t<g.productosProcesados.length;t++)o.productosProcesados[a].id==g.productosProcesados[t].id&&(g.productosProcesados[t].rankin=o.productosProcesados[a].rankin)}else g.productosProcesados=e;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},g.obtenerActividades=function(a){g.actividades=[];var e=$.grep(g.sucursales,function(e){return e.id==a})[0];g.actividadesDosificaciones=e.actividadesDosificaciones,g.actividades=[];for(var t=0;t<g.actividadesDosificaciones.length;t++)g.actividades.push(g.actividadesDosificaciones[t].actividad);g.venta.actividad=1==g.actividades.length?g.actividades[0]:null},g.buscarInventarios=function(e,a,t,o,n,i,r){h.start(),g.itemsPorPagina=t,""==o||null==o?o=0:g.textoBusqueda=o,g.paginaActual=a,u(g.usuario.id_empresa,e,a,t,o,n,i,r).then(function(e){for(var a=e.productos,t=0;t<a.length;t++){a[t].fecha_vencimiento=new Date(a[t].fecha_vencimiento),a[t].cantidad_total=a[t].cantidad}g.paginas=[];for(t=1;t<=e.paginas;t++)g.paginas.push(t);g.productos=a,h.stop()})},g.buscarProducto=function(e){if(""!=e&&null!=e)return p(g.usuario.id_empresa,e)},g.establecerProducto=function(o){o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto,g.editar_precio=!1,d(o.id,g.venta.almacen.id).then(function(e){o.inventarios=e;for(var a=0;a<o.inventarios.length;a++)o.inventarios[a].fecha_vencimiento=o.inventarios[a].fecha_vencimiento?new Date(o.inventarios[a].fecha_vencimiento):null,o.inventarios[a].fechaVencimientoTexto=o.inventarios[a].fecha_vencimiento?o.inventarios[a].fecha_vencimiento.getDate()+"/"+(o.inventarios[a].fecha_vencimiento.getMonth()+1)+"/"+o.inventarios[a].fecha_vencimiento.getFullYear():"",o.inventarios[a].detallesMovimiento[0].movimiento.fecha=new Date(o.inventarios[a].detallesMovimiento[0].movimiento.fecha),o.inventarios[a].detallesMovimiento[0].movimiento.fechaTexto=o.inventarios[a].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(o.inventarios[a].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+o.inventarios[a].detallesMovimiento[0].movimiento.fecha.getFullYear();g.inventariosDisponibleProducto=[],g.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),g.inventariosDisponibleProducto=g.inventariosDisponibleProducto.concat(o.inventarios);var t=g.obtenerInventarioTotal(o);g.detalleVenta={producto:o,precio_unitario:o.precio_unitario,inventarioProducto:g.inventariosDisponibleProducto[0],inventario_disponible:t,costos:o.activar_inventario?o.inventarios:[],cantidad:1,descuento:o.descuento,recargo:0,ice:0,excento:0,tipo_descuento:0<o.descuento,tipo_recargo:!1},g.colorearInventarioDisponible(t,o),g.calcularImporte(),g.cerrarPopup(g.idModalInventario),g.enfocar("cantidad")})},g.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario){for(var t=0;t<e.inventarios.length;t++)a+=e.inventarios[t].cantidad;for(var o=0;o<g.venta.detallesVenta.length;o++)g.venta.detallesVenta[o].producto.id==e.id&&(a-=g.venta.detallesVenta[o].cantidad)}else a=5e5;return a},g.colorearInventarioDisponible=function(e,a){0==e?(g.porcentaje="100",g.color="red"):e>3*a.inventario_minimo+1?(g.porcentaje="100",g.color="green"):e>2*a.inventario_minimo+1?(g.porcentaje="75",g.color="green"):e>1.5*a.inventario_minimo+1?(g.porcentaje="50",g.color="green"):e==a.inventario_minimo+1?(g.porcentaje="38",g.color="yellow"):e==a.inventario_minimo?(g.porcentaje="25",g.color="red"):e<a.inventario_minimo&&0<e&&(g.porcentaje="12",g.color="red")},g.actualizarInventarioDisponibleFechaVencimiento=function(e){0!=e.inventarioProducto.id?(e.costos=[],e.costos.push(e.inventarioProducto),e.inventario_disponible=g.obtenerInventarioTotalPorFechaVencimiento(e),e.lote=e.inventarioProducto.lote):(e.inventario_disponible=g.obtenerInventarioTotal(e.producto),e.costos=e.producto.inventarios,e.lote=""),g.colorearInventarioDisponible(e.inventario_disponible,e.producto),g.calcularImporte()},g.enfocar=function(e){r(function(){$("#"+e).focus()},0)},g.interceptarTecla=function(e,a,t){13===e.which&&(t?g.enfocar(a):r(function(){$("#"+a).trigger("click")},0))},g.establecerCliente=function(e,a,t){console.log("el clientes es ::::: ",e),g.$model=a,g.$label=t,g.venta.cliente.id=e.id,g.venta.cliente.razon_social=e.persona.nombre_completo,g.venta.cliente.nit=parseInt(e.persona.ci),g.venta.cliente.campo=e.campo,g.venta.cliente.cargos=e.cargos,g.venta.cliente.designacion_empresa=e.designacion_empresa,g.enfocar("razon_social"),g.$apply()},g.obtenerInventarioTotalPorFechaVencimiento=function(e){for(var a=e.inventarioProducto.cantidad,t=0;t<g.venta.detallesVenta.length;t++)g.venta.detallesVenta[t].producto.id==e.producto.id&&g.venta.detallesVenta[t].costos[0].id==e.inventarioProducto.id&&(a-=g.venta.detallesVenta[t].cantidad);return a},g.agregarDetalleVenta=function(e){if(e.producto.activar_inventario)if(1<e.costos.length)for(var a=e.cantidad,t=0,o=JSON.parse(JSON.stringify(e));t<e.costos.length&&0<a;){e.inventarioProducto=e.costos[t];var n=g.obtenerInventarioTotalPorFechaVencimiento(e);if(0<n){var i,r=JSON.parse(JSON.stringify(o));0<t&&(r.descuento=0,r.recargo=0,r.ice=0,r.excento=0),n<a?a-=i=n:(i=a,a=0),(g.detalleVenta=r).cantidad=i,r.fecha_vencimiento=e.costos[t].fecha_vencimiento,r.lote=e.costos[t].lote,r.costos=[],r.costos.push(e.costos[t]),r.inventario=e.costos[t],g.calcularImporte(),g.venta.detallesVenta.push(r)}t++}else e.fecha_vencimiento=e.costos[0].fecha_vencimiento,e.lote=e.costos[0].lote,e.inventario=e.costos[0],g.venta.detallesVenta.push(e);else g.venta.detallesVenta.push(e);g.inventariosDisponibleProducto=[],g.sumarTotal(),g.sumarTotalImporte(),g.calcularSaldo(),g.calcularCambio(),g.detalleVenta={producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},g.enfocar("id_producto")},g.eliminarDetalleVenta=function(e){g.venta.detallesVenta.splice(g.venta.detallesVenta.indexOf(e),1),g.sumarTotal(),g.sumarTotalImporte(),g.calcularSaldo(),g.calcularCambio(),g.capturarInteraccion()},g.cambiarTipoPago=function(a){var e=$.grep(g.tiposPago,function(e){return e.id==a.id})[0];g.esContado="CONT"==e.nombre_corto,g.calcularCambio()},g.recalcular=function(){g.calcularImporte()},g.calcularCambio=function(){g.esContado?(g.venta.cambio=Math.round(100*(g.venta.pagado-g.venta.total))/100,g.pagoMinimo=g.venta.total):(g.venta.cambio=0,g.pagoMinimo=0)},g.calcularImporte=function(){var e,a;g.detalleVenta.importe=Math.round(g.detalleVenta.cantidad*g.detalleVenta.precio_unitario*1e3)/1e3,e=g.detalleVenta.tipo_descuento?g.detalleVenta.importe*(g.detalleVenta.descuento/100):g.detalleVenta.descuento,a=g.detalleVenta.tipo_recargo?g.detalleVenta.importe*(g.detalleVenta.recargo/100):g.detalleVenta.recargo,g.detalleVenta.total=Math.round(1e3*(g.detalleVenta.importe-e+a-g.detalleVenta.ice-g.detalleVenta.excento))/1e3},g.sumarTotalImporte=function(){for(var e=0,a=0;a<g.venta.detallesVenta.length;a++)e+=g.venta.detallesVenta[a].importe;g.venta.importe=Math.round(1e3*e)/1e3},g.sumarTotal=function(){for(var e=0,a=0;a<g.venta.detallesVenta.length;a++)e+=g.venta.detallesVenta[a].total;g.venta.total=Math.round(1e3*e)/1e3,g.venta.pagado=g.venta.total},g.calcularSaldo=function(){g.venta.saldo=g.venta.total-g.venta.a_cuenta},g.modificarPrecio=function(){g.editar_precio=!0},g.establecerPrecio=function(){g.editar_precio=!1},g.crearNuevaVenta=function(){g.venta=new V({id_empresa:g.usuario.id_empresa,id_usuario:g.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],pagado:0,cambio:0,despachado:!1,vendedor:null}),g.venta.sucursal=1==g.sucursales.length?g.sucursales[0]:null,g.venta.sucursal&&g.obtenerAlmacenesActividades(g.venta.sucursal.id),g.venta.movimiento=g.movimientosEgreso[0],g.obtenerTipoEgreso(g.venta.movimiento);var e=new Date;g.venta.fechaTexto=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear(),g.venta.tipoPago=g.tiposPago[0],g.cambiarTipoPago(g.venta.tipoPago),g.editar_precio=!1,g.detalleVenta={producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},g.abrirPopup(g.idModalWizardFarmaciaEdicion),g.enfocar("nit")},g.buscarCliente=function(e){if(""!=e&&null!=e)return v(g.usuario.id_empresa,e)},g.cerrarPopupFarmaciaEdicion=function(){g.cerrarPopup(g.idModalWizardFarmaciaEdicion)},g.abrirPopupInventario=function(){g.abs=i.Math.abs,g.itemsPorPagina=10,g.paginaActual=1,g.columna="nombre",g.direccion="asc",g.cantidadInv="0",g.textoBusqueda="",g.venta.almacen&&(g.almacenBusqueda=g.venta.almacen,g.buscarInventarios(g.almacenBusqueda.id,g.paginaActual,g.itemsPorPagina,g.textoBusqueda,g.columna,g.direccion,g.cantidadInv)),g.abrirPopup(g.idModalInventario)},g.obtenerCargos=function(){h.start(),c("RRHH_CARGO").then(function(e){var a=e.clases;g.llenarCargos(a),h.stop()})},g.llenarCargos=function(e){g.nuevoRH="",g.cargos=[];for(var a=0;a<e.length;a++){var t={nombre:e[a].nombre,maker:"",ticked:!1,id:e[a].id};g.cargos.push(t)}},g.obtenerVentas=function(){var e=new Date,a=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear();g.filtrarVentas(g.sucursalesUsuario,a,a)},g.filtrarVentas=function(e,a,t,o,n,i,r,c,s,l,u){o=""==o||null==o?0:o,n=""==n||null==n?0:n,i=null==i||null==i?0:i,r=null==r?0:r,c=""==c||null==c?0:c,s=null==s||null==s?0:s,l=""==l||null==l?0:l,u=""==u||null==u||null==u?0:u,h.start(),0!=r&&(g.tipoPagod=0<$.grep(g.tiposPago,function(e){return e.id==r}).length?$.grep(g.tiposPago,function(e){return e.id==r})[0].nombre:"todos"),a=new Date(g.convertirFecha(a)),t=new Date(g.convertirFecha(t)),P(e,a,t,o,n,i,r,c,s,l,u).then(function(e){g.ventas=e,h.stop()})},g.verVenta=function(e){g.venta=e,g.abrirPopup(g.idModalWizardVentaVista)},g.cerrarPopupVista=function(){g.cerrarPopup(g.idModalWizardVentaVista)},g.imprimirVenta=function(e){_(e.id,g.usuario.id_empresa).then(function(e){var a=e.venta;a.configuracion=e.configuracion,a.sucursal=e.sucursal,a.numero_literal=e.numero_literal,a.pieFactura=e.pieFactura,a.sucursalDestino=e.sucursalDestino;var t=new Date(a.fecha);a.fechaTexto=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear(),f(a.movimiento.clase.nombre_corto,a,!1,g.usuario)})},g.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},g.guardarVenta=function(e,a){if(e){g.ocultarMensajesValidacion();var t=new Date;if(a.fecha=new Date(g.convertirFecha(a.fechaTexto)),a.fecha.setHours(t.getHours()),a.fecha.setMinutes(t.getMinutes()),a.esFarmacia=!0,console.log("las ventas son ==== ",a),h.start(),a.id)m.update({idCompra:compra.id},compra,function(e){h.stop(),g.cerrarPopupFarmaciaEdicion(),g.mostrarMensaje("Actualizado Exitosamente!"),g.recargarItemsTabla()});else{a.movimiento.nombre_corto;a.$save(function(e){console.log("res ==================",e),e.hasError?(h.stop(),g.crearNuevaVenta(),g.mostrarMensaje(e.message)):(h.stop(),g.cerrarPopupFarmaciaEdicion(),g.imprimirVenta(e),g.crearNuevaVenta(),g.ocultarMensajesValidacion(),g.mostrarMensaje("Venta registrada exitosamente!"))},function(e){h.stop(),g.cerrarPopupFarmaciaEdicion(),g.mostrarMensaje("Ocurrio un problema al momento de guardar!"),g.recargarItemsTabla()})}}},g.sumarMonto=function(){for(var e=0,a=0;a<g.ventas.length;a++)g.ventas[a].movimiento.clase.nombre_corto!=g.diccionario.EGRE_FACTURACION&&g.ventas[a].movimiento.clase.nombre_corto!=g.diccionario.EGRE_PROFORMA||!g.ventas[a].activa||(e+=g.ventas[a].total);return Math.round(100*e)/100},g.trueDetalle=!0,g.verDetalle=function(){g.trueDetalle?g.trueDetalle=!1:g.trueDetalle=!0},g.imprimirFiltroCajaCartaOficio=function(e,a,t){var o=new PDFDocument({compress:!1,size:[612,792],margin:0}),n=o.pipe(blobStream()),i=20;if(g.trueDetalle){for(var r=2*e.length,c=0;c<e.length;c++)r+=e[c].detallesVenta.length;var s=Math.ceil(r/i)}else i=20,s=Math.ceil(e.length/i);var l=100,u=0,d=1;g.imprimirCabeceraFiltroCajaCartaOficio(o,1,s,e,a,t),o.font("Helvetica",7);for(c=0;c<e.length;c++){o.font("Helvetica",7),o.rect(50,l+9,520,0).stroke(),o.text(c+1,55,l+20),o.font("Helvetica",6),e[c].fecha=new Date(e[c].fecha),o.text(e[c].fecha.getDate()+"/"+(e[c].fecha.getMonth()+1)+"/"+e[c].fecha.getFullYear(),65,l+20),o.text(e[c].factura,120,l+20,{width:60}),o.font("Helvetica",6),o.text(e[c].farmacia.paciente.persona.nombre_completo,170,l+15,{width:75}),o.font("Helvetica",7),o.text(e[c].farmacia.paciente.designacion_empresa,245,l+20),o.text(e[c].farmacia.paciente.codigo,305,l+20),o.text(e[c].farmacia.paciente.campo,345,l+20);for(var p=[],m=0;m<e[c].farmacia.paciente.empleadosFichas[e[c].farmacia.paciente.empleadosFichas.length-1].cargos.length;m++)p.push(e[c].farmacia.paciente.empleadosFichas[e[c].farmacia.paciente.empleadosFichas.length-1].cargos[m].cargo.nombre);if(o.text(p.toString(),385,l+20,{width:50}),o.text(e[c].total,425,l+20),e[c].tipoPago?(o.text(e[c].tipoPago.nombre,455,l+20),e[c].tipoPago.nombre==g.diccionario.TIPO_PAGO_CREDITO&&(o.font("Helvetica",6),o.text("Plazo: "+e[c].dias_credito+" A cuenta: Bs "+e[c].a_cuenta+" Saldo: Bs "+e[c].saldo,510,l+16,{width:55}))):(o.text("",455,l+20),o.text("",520,l+16,{width:65})),g.trueDetalle){o.rect(50,l+34,520,0).stroke(),o.font("Helvetica",7),l+=50,o.text("N°",105,l),o.text("Nombre",115,l),o.text("Codigo Item",170,l),o.text("Unidad de Med",230,l),o.text("Cantidad",295,l),o.text("Importe",355,l),u++;for(var v=0;v<e[c].detallesVenta.length;v++)if(o.font("Helvetica",7),o.text(v+1,105,l+20),o.text(e[c].detallesVenta[v].producto.nombre,115,l+20,{width:55}),o.text(e[c].detallesVenta[v].producto.id,170,l+20),o.text(e[c].detallesVenta[v].producto.unidad_medida,230,l+20),o.text(e[c].detallesVenta[v].cantidad,295,l+20),o.text(e[c].detallesVenta[v].importe,355,l+20),l+=24,i-1<++u+1){l+=10,o.text(d+" de "+s,520,705);var f=new Date;o.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),o.text("USUARIO: "+g.usuario.nombre_usuario,150,705),o.addPage({size:[612,792],margin:10}),l=100,u=0,d+=1,g.imprimirCabeceraFiltroCajaCartaOficio(o,1,s,e,a,t)}if(o.font("Helvetica",7),l+=4,i<++u){l+=10,o.text(d+" de "+s,520,705);f=new Date;o.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),o.text("USUARIO: "+g.usuario.nombre_usuario,150,705),o.addPage({size:[612,792],margin:10}),l=100,u=0,d+=1,g.imprimirCabeceraFiltroCajaCartaOficio(o,1,s,e,a,t)}}else if(o.font("Helvetica",7),l+=30,++u==i){o.text(d+" de "+s,520,705);f=new Date;o.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),o.text("USUARIO: "+g.usuario.nombre_usuario,150,705),o.addPage({size:[612,792],margin:10}),l=100,u=0,d+=1,g.imprimirCabeceraFiltroCajaCartaOficio(o,1,s,e,a,t)}}o.font("Helvetica",7),o.text(d+" de "+s,520,705);f=new Date;o.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),o.text("USUARIO: "+g.usuario.nombre_usuario,150,705),o.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),h.stop()},g.imprimirCabeceraFiltroCajaCartaOficio=function(e,a,t,o,n,i){e.font("Helvetica-Bold",16),e.text("REPORTE",0,40,{align:"center"}),e.font("Helvetica-Bold",8),e.rect(50,80,520,620).stroke(),e.text("Desde: "+n+" Hasta: "+i,0,55,{align:"center"});var r=[g.razon_sociald,g.nitd,g.montod,g.usuariod,g.transacciond,g.sucursald,g.tipoPagod],c=0,s="";e.text("Filtro: ",55,65);for(var l=0;l<r.length;l++)0!=r[l]&&null!=r[l]?(s=s+r[l]+", ",65):7==(c+=1)&&e.text("GENERAL",85,65);e.text(s,85,65),e.font("Helvetica-Bold",7),e.font("Helvetica-Bold",8),e.text("N°",55,90),e.text("Fecha",65,90),e.text("Receta",120,90,{width:43}),e.text("Nombre Completo",170,90),e.text("Empresa",245,90,{width:43}),e.text("Código",305,90),e.text("Campo",345,90,{width:43}),e.text("Cargo",385,90,{width:43}),e.text("Monto",420,90),e.text("Tipo de Pago",455,90),e.text("Pago",520,90)},g.imprimirFiltroExcelCajaCartaOficio=function(e){h.start();for(var a=[["N°","Fecha","Receta","Nombre Completo","Empresa","Código","Campo","Cargo","Monto","Tipo de Pago","Pago"]],t=0;t<e.length;t++){var o=[];e[t].fecha=new Date(e[t].fecha),o.push(t+1),o.push(e[t].fecha.getDate()+"/"+(e[t].fecha.getMonth()+1)+"/"+e[t].fecha.getFullYear()),o.push(e[t].factura),o.push(e[t].farmacia.paciente.persona.nombre_completo),o.push(e[t].farmacia.paciente.designacion_empresa),o.push(e[t].farmacia.paciente.codigo),o.push(e[t].farmacia.paciente.campo);for(var n=[],i=0;i<e[t].farmacia.paciente.empleadosFichas[e[t].farmacia.paciente.empleadosFichas.length-1].cargos.length;i++)n.push(e[t].farmacia.paciente.empleadosFichas[e[t].farmacia.paciente.empleadosFichas.length-1].cargos[i].cargo.nombre);if(o.push(n.toString()),o.push(e[t].total),e[t].tipoPago?(o.push(e[t].tipoPago.nombre),e[t].tipoPago.nombre==g.diccionario.TIPO_PAGO_CREDITO&&o.push("Plazo: "+e[t].dias_credito+" A cuenta: Bs "+e[t].a_cuenta+" Saldo: Bs "+e[t].saldo)):o.push(""),"TRASPASO"==e[t].movimiento.clase.nombre&&(o.push(""),o.push(e[t].almacenTraspaso.sucursal.nombre)),a.push(o),g.trueDetalle){a.push(["","","","","N°","Nombre","Codigo Item","Unidad de Med","Cantidad","Importe"]);for(i=0;i<e[t].detallesVenta.length;i++)(o=[]).push(""),o.push(""),o.push(""),o.push(""),o.push(i+1),o.push(e[t].detallesVenta[i].producto.nombre),o.push(e[t].detallesVenta[i].producto.id),o.push(e[t].detallesVenta[i].producto.unidad_medida),o.push(e[t].detallesVenta[i].cantidad),o.push(e[t].detallesVenta[i].importe),a.push(o)}t+1==e.length&&((o=[]).push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),o.push(""),a.push(o))}var r="SheetJS",c=new Workbook,s=sheet_from_array_of_arrays(a);c.SheetNames.push(r),c.Sheets[r]=s;var l=XLSX.write(c,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"Reporte-ventas-farmacia.xlsx"),h.stop()},g.abrirPopupPago=function(e){g.venta=e,g.pago=null,g.abrirPopup(g.idModalPago)},g.cerrarPopupPago=function(){g.cerrarPopup(g.idModalPago)},g.efectuarPago=function(a){h.start(),D.update({id:g.venta.id,id_empresa:g.usuario.id_empresa},{pago:a,id_usuario_cajero:g.usuario.id},function(e){g.mostrarMensaje(e.mensaje),g.cerrarPopup(g.idModalPago),g.obtenerVentas(),g.imprimirRecibo(e,e.venta,a),h.stop()},function(e){g.mostrarMensaje(e),g.cerrarPopup(g.idModalPago),g.obtenerVentas(),h.stop()})},g.imprimirRecibo=function(e,a,t){h.start();var o=new PDFDocument({compress:!1,size:[227,353],margin:10}),n=o.pipe(blobStream());o.moveDown(2),o.font("Helvetica-Bold",8),o.text(g.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),o.moveDown(.4),o.font("Helvetica",7),o.text(a.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),o.moveDown(.4),o.text(a.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),o.moveDown(.4);var i=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");o.text("TELF.: "+i,{align:"center"}),o.moveDown(.4),o.text("COCHABAMBA - BOLIVIA",{align:"center"}),o.moveDown(.5),o.font("Helvetica-Bold",8),o.text("RECIBO",{align:"center"}),o.font("Helvetica",7),o.moveDown(.4),o.text("------------------------------------",{align:"center"}),o.moveDown(.4),o.text(a.almacen.sucursal.nota_recibo_correlativo,{align:"center"}),o.moveDown(.4),o.moveDown(.4),o.text("------------------------------------",{align:"center"}),o.moveDown(.4),o.moveDown(.6);var r=new Date;o.text("FECHA : "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),{align:"left"}),o.moveDown(.4),o.text("He recibido de : "+g.venta.farmacia.paciente.persona.nombre_completo,{align:"left"}),o.moveDown(.4),o.text("---------------------------------------------------------------------------------",{align:"center"}),o.moveDown(.2),o.text("       CONCEPTO                                   ",{align:"left"}),o.moveDown(.2),o.text("---------------------------------------------------------------------------------",{align:"center"}),o.moveDown(.4),a.fecha=new Date(a.fecha),o.text("Fecha: "+a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear(),15,210);var c=g.venta.movimiento.clase.nombre_corto==g.diccionario.EGRE_FACTURACION?"Factura nro. "+g.venta.factura:"Proforma nro. "+g.venta.factura;o.text(c,105,210,{width:100}),o.text("Saldo Bs "+(a.saldo-t)+".-",105,220,{width:100}),o.text("Bs "+t+".-",170,210,{width:100}),o.text("--------------",10,230,{align:"right"}),o.moveDown(.3),o.text("TOTAL Bs.              "+t.toFixed(2),{align:"right"}),o.moveDown(.4),o.moveDown(.4),o.text("SON: "+e.pago,{align:"left"}),o.moveDown(.6),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.moveDown(.4),o.text("-------------------------                       -------------------------",{align:"center"}),o.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),o.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),h.stop()},g.$on("$routeChangeStart",function(e,a){g.eliminarPopup(g.idModalWizardFarmaciaEdicion),g.eliminarPopup(g.idModalInventario),g.eliminarPopup(g.idModalWizardVentaVista),g.eliminarPopup(g.idModalPago)}),g.inicio()}]);