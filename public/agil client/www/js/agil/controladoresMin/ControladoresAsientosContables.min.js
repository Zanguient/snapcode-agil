angular.module("agil.controladores").controller("ControladorComprobantes",["$scope","$localStorage","$location","$templateCache","$route","blockUI","CodigoControl","Paginator","ComprobantePaginador","ClasesTipo","ListaCuentasComprobanteContabilidad","ListaAsientosComprobanteContabilidad","NuevoComprobanteContabilidad","ClasesTipo","LibroMayorCuenta","ComprobanteRevisarPaginador","AsignarComprobanteFavorito","Diccionario","ObtenerCambioMoneda","ImprimirComprobante","ComprasComprobante","VerificarUsuarioEmpresa","FieldViewer","DatosComprobante","EliminarComprobante","ListaCambioMoneda","ActualizarCambioMoneda","GuardarComprobantesImportados","ComprobanteTotalGeneralEmpresa","EdicionComprobanteContabilidad",function(g,o,a,e,r,h,n,t,i,l,s,u,c,l,p,m,b,d,f,C,v,M,_,S,I,w,P,D,E,A){h.start(),g.asientoNuevo=!1,g.usuario=JSON.parse(o.usuario),g.IdModalVerificarCuenta="modal-verificar-cuenta",g.IdModalEliminarComprobante="dialog-eliminar-comprobante",g.IdModalCambioMoneda="dialog-cambio-moneda",g.$on("$viewContentLoaded",function(){resaltarPesta√±a(a.path().substring(1)),ejecutarScriptsComprobante(g.IdModalVerificarCuenta,g.IdModalEliminarComprobante,g.IdModalCambioMoneda),g.buscarAplicacion(g.usuario.aplicacionesUsuario,a.path().substring(1)),g.obtenerColumnasAplicacion()}),g.$on("$routeChangeStart",function(o,a){g.eliminarPopup(g.IdModalVerificarCuenta),g.eliminarPopup(g.IdModalEliminarComprobante),g.eliminarPopup(g.IdModalCambioMoneda)}),g.inicio=function(){g.opcionBimonetario2=!1,g.detalleComprobante={},g.obtenerTiposComprobante(),g.asientos=[],g.cuenta={},g.diccionario=d,console.log(g.diccionario),g.comprobante={asientos:[]},g.sucursales=g.obtenerSucursales(),g.obtenerMeses(),g.ObtenerComprobantes(),g.obtenerGestiones(),g.obtenerAnios("2016"),g.obtenerCambioDolar()},g.obtenerColumnasAplicacion=function(){g.fieldViewer=_({crear:!0,id_empresa:g.usuario.id_empresa,configuracion:{abierto:{value:"Abierto",show:!0},comprobante:{value:"Comp.",show:!0},numero:{value:"Nro",show:!0},fecha:{value:"Fecha",show:!0},sucursal:{value:"Sucursal",show:!0},gloza:{value:"Gloza",show:!0},hora_fecha:{value:"Hora-Fecha",show:!0},importe:{value:"Importe",show:!0},usuario:{value:"Usuario",show:!0}}},g.aplicacion.aplicacion.id),g.fieldViewer.updateObject()},g.obtenerTotalGeneral=function(o){E(g.usuario.id_empresa).then(function(o){g.totalGeneralComprobantes=o.total[0].total})},g.obtenerSucursales=function(){for(var o=[],a=0;a<g.usuario.sucursalesUsuario.length;a++)o.push(g.usuario.sucursalesUsuario[a].sucursal);return console.log(g.usuario.sucursalesUsuario),o},g.ObtenerComprobantes=function(){g.paginator=t(),g.paginator.column="numero",g.paginator.direction="desc",g.paginator.callBack=g.obtenerLista;var o,a,e=new Date,r=g.fechaATexto(e),n=g.fechaATexto((a=-10,(o=e).setDate(o.getDate()+a),o));g.filtro={inicio:n,fin:r,empresa:g.usuario.id_empresa,clasificacion:"",tipo_comprobante:"",monto:""},null!=g.filtro.inicio&&g.paginator.getSearch("",g.filtro)},g.obtenerLista=function(){h.start();var a=g.paginator.filter.inicio,e=g.paginator.filter.fin;g.paginator.filter.inicio=new Date(g.convertirFecha(g.paginator.filter.inicio)),g.paginator.filter.fin=new Date(g.convertirFecha(g.paginator.filter.fin));var o=i(g.paginator);g.totalImporte=0,g.obtenerTotalGeneral(),o.then(function(o){g.paginator.setPages(o.paginas),g.comprobantes=o.comprobantes,g.comprobantes.forEach(function(o){g.totalImporte=g.totalImporte+o.importe},this),g.paginator.filter.inicio=a,g.paginator.filter.fin=e,h.stop()})},g.formatearFecha=function(o){var a=o.split("/");return a[0]+a[1]+a[2]},g.cerrarModalLibrosMayores=function(){g.cerrarPopup(g.IdModalLibroMayor)},g.obtenerTiposComprobante=function(){h.start(),l("TCMC").then(function(o){g.tiposComprobantes=o.clases,h.stop()})},g.obtenerGestiones=function(){h.start(),l("GTN").then(function(o){g.gestiones=o.clases,h.stop()})},g.buscarCuentas=function(o){if(""!=o&&null!=o){var a=s(g.usuario.id_empresa,o);return console.log(a),a}},g.DatosCodigoQr=[],g.cont2=1,g.disparo=!0,g.AgregarComprobante=function(){if(null!=g.nuevoComprobante.tipo_comprobante&&null!=g.nuevoComprobante.id_sucursal&&null!=g.nuevoComprobante.fecha){for(var o=0;o<g.nuevoComprobante.asientosContables.length;o++){var a=g.nuevoComprobante.asientosContables[o];0!=a.activo&&""!=a.debe_bs&&(g.nuevoComprobante.importe=Math.round(1e4*(g.nuevoComprobante.importe+a.debe_bs))/1e4)}g.nuevoComprobante.fecha=new Date(g.convertirFecha(g.nuevoComprobante.fecha)),c.save(g.nuevoComprobante,function(o){g.mostrarMensaje(o.mensaje),g.cerrarNuevoComprobante()})}},g.verComprobante=function(a,e){A(a.id).then(function(o){console.log(a),e?g.crearNuevoComprobante(null,null,o.comprobante,!0):a.abierto?(g.obtenerCambioMoneda2(g.fechaATexto(o.comprobante.fecha)),g.crearNuevoComprobante(null,null,o.comprobante)):o.comprobante.id||g.crearNuevoComprobante(null,null,o.comprobante)})},g.ComvertirDebeEnDolar=function(o){o.debe_sus=Math.round(o.debe_bs/g.valorDolar*1e4)/1e4},g.ComvertirHaberEnDolar=function(o){o.haber_sus=Math.round(o.haber_bs/g.valorDolar*1e4)/1e4},g.ComvertirDebeEnBolivianos=function(o){o.debe_bs=Math.round(o.debe_sus*g.valorDolar*1e4)/1e4},g.ComvertirHaberEnBolivianos=function(o){o.haber_bs=Math.round(o.haber_sus*g.valorDolar*1e4)/1e4},g.verificarCuentaAdmin=function(o){o.id_comprobante=g.dato.id,M.save({id_empresa:g.usuario.id_empresa},o,function(o){console.log(o),o.type?(g.mostrarMensaje(o.message),g.dato.abierto?g.dato.abierto=!1:g.dato.abierto=!0,g.cerrarModalVerificarCuenta()):g.mostrarMensaje(o.message)})},g.abrirModalVerificarCuenta=function(o){g.dato=o,g.abrirPopup(g.IdModalVerificarCuenta)},g.cerrarModalVerificarCuenta=function(){g.cerrarPopup(g.IdModalVerificarCuenta)},g.abrirModalEliminarComprobante=function(o){g.dato=o,g.abrirPopup(g.IdModalEliminarComprobante)},g.cerrarModalEliminarComprobante=function(){g.cerrarPopup(g.IdModalEliminarComprobante)},g.eliminarComprobante=function(){I(g.dato.id).then(function(o){g.recargarItemsTabla(),g.mostrarMensaje(o.mensaje),g.cerrarModalEliminarComprobante()})},g.opcionBimonetario=!0,g.VerBimonetario=function(){console.log(g.opcionBimonetario),1!=g.opcionBimonetario?g.opcionBimonetario=!1:g.opcionBimonetario=!0},g.imprimirComprobante=function(o,a){h.start(),S(o.id).then(function(o){o.comprobante.importe_literal=o.importeLiteral,C(o.comprobante,a,g.usuario,g.number_format),h.stop()})},g.buscarCambioMoneda=function(o){w(o).then(function(o){g.cambiosMoneda=o})},g.abrirCambioMoneda=function(){g.filtroMoneda={mes:"a",anio:2018},w(g.filtroMoneda).then(function(o){g.cambiosMoneda=o,g.abrirPopup(g.IdModalCambioMoneda)})},g.cerrarCambioMoneda=function(){g.cerrarPopup(g.IdModalCambioMoneda)},g.obtenerAnios=function(o){var a=(new Date).getFullYear(),e=[];for(o=o||1980;o<=a;)e.push(o++);g.listYears=e},g.EditarCambioMoneda=function(o){o.edit=!0},g.CancelarModificarMoneda=function(){w(g.filtroMoneda).then(function(o){g.cambiosMoneda=o})},g.GuardarCambio=function(a){P(a).then(function(o){g.mostrarMensaje(o.mensaje),a.edit=!1})},g.obtenerCambioDolar=function(){var o=new Date;f(o).then(function(o){console.log(o),o.monedaCambio&&(g.moneda=o.monedaCambio)})},g.subirExcelComprobantes=function(o){h.start();var a,e,r=o.target.files;for(e=r[a=0];a!=r.length;++a){var n=new FileReader;e.name;n.onload=function(o){h.start();var a=o.target.result,e=XLSX.read(a,{type:"binary"}),r=e.SheetNames[0],n=2,t=2,i=e.Sheets[r],l=[],s="",u="",c="";do{t=n;var p={asientosContables:[]};p.tipoCambio=g.moneda,p.tipo_comprobante=null!=i["A"+n]&&""!=i["A"+n]?i["A"+n].v.toString():null,c=p.tipo_comprobante,p.codigo=null!=i["B"+n]&&""!=i["B"+n]?i["B"+n].v.toString():null,s=p.codigo,p.fecha=null!=i["C"+n]&&""!=i["C"+n]?new Date(g.fecha_excel_angular(i["C"+n].v.toString())):null,p.fechaActual=new Date,p.sucursal=null!=i["D"+n]&&""!=i["D"+n]?i["D"+n].v.toString():null,u=null!=i["C"+n]&&""!=i["C"+n]?g.fecha_excel_angular(i["C"+n].v.toString()):null,p.importe=0,p.gloza=null!=i["E"+n]&&""!=i["E"+n]?i["E"+n].v.toString():null;do{var m={};m.numero_cuenta=null!=i["F"+t]&&""!=i["F"+t]?i["F"+t].v.toString():null,m.codigo=null!=i["G"+t]&&""!=i["G"+t]?i["G"+t].v.toString():null,m.gloza=null!=i["H"+t]&&""!=i["H"+t]?i["H"+t].v.toString():null,m.debe_bs=null!=i["I"+t]&&""!=i["I"+t]?parseFloat(i["I"+t].v.toString()):null,m.haber_bs=null!=i["J"+t]&&""!=i["J"+t]?parseFloat(i["J"+t].v.toString()):null,m.debe_sus=Math.round(m.debe_bs/g.moneda.dolar*1e4)/1e4,m.haber_sus=Math.round(m.haber_bs/g.moneda.dolar*1e4)/1e4,m.eliminado=!1;var b=null!=i["B"+t]&&""!=i["B"+t]?parseInt(i["B"+t].v.toString()):null,d=null!=i["C"+t]&&""!=i["C"+t]?g.fecha_excel_angular(i["C"+t].v.toString()):null,f=null!=i["A"+t]&&""!=i["A"+t]?i["A"+t].v.toString():null;b==s&&d==u&&c==f&&(p.importe+=m.debe_bs,p.asientosContables.push(m));var C=null!=i["B"+ ++t]&&""!=i["B"+t]?parseInt(i["B"+t].v.toString()):null}while(C==s);0==l.length?l.push(p):l[l.length-1].codigo==s&&l[l.length-1].tipo_comprobante==c||l.push(p),n=t,console.log(n),0}while(null!=i["A"+n]);g.GuardarComprobantesImportacion(l)},n.readAsBinaryString(e)}},g.GuardarComprobantesImportacion=function(o){g.comprobantesParaGuardar=o;var a=[];0<g.comprobantesParaGuardar.length?(300<g.comprobantesParaGuardar.length?(a=g.comprobantesParaGuardar.slice(0,300),g.comprobantesParaGuardar=g.comprobantesParaGuardar.slice(300,g.comprobantesParaGuardar.length)):(a=g.comprobantesParaGuardar,g.comprobantesParaGuardar=[]),D(a,g.usuario.id,g.usuario.id_empresa).then(function(o){h.stop(),g.mostrarMensaje("del codigo "+a[0].codigo+" hasta el codigo "+a[a.length-1].codigo+" "+o.mensaje+" faltan procesar "+g.comprobantesParaGuardar.length+" comprobantes"),g.GuardarComprobantesImportacion(g.comprobantesParaGuardar)})):h.stop()},g.imprimirFiltroExcelCajaCartaOficio=function(){h.start();g.paginator.filter.inicio,g.paginator.filter.fin;g.paginator.filter.inicio=new Date(g.convertirFecha(g.paginator.filter.inicio)),g.paginator.filter.fin=new Date(g.convertirFecha(g.paginator.filter.fin));var o=Object.assign({},g.paginator);o.itemsPerPage=0,i(o).then(function(o){g.ReporteComprovante=o.comprobantes;(o=[]).push(["N¬∞","COMPROBANTE","NUMERO"]);for(var a=0,e=0;e<g.ReporteComprovante.length;e++)g.reporte=g.ReporteComprovante[e],columns=[],a+=1,columns.push(a),columns.push(g.reporte.tipoComprobante.nombre),columns.push(g.reporte.numero),o.push(columns);var r="SheetJS",n=new Workbook,t=sheet_from_array_of_arrays(o);n.SheetNames.push(r),n.Sheets[r]=t;var i=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(i)],{type:"application/octet-stream"}),"VENTAS-MENSUALES.xlsx"),h.stop()})},g.inicio()}]);