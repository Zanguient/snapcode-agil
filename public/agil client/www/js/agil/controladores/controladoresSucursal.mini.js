angular.module("agil.controladores").controller("ControladorSucursales",["$scope","$localStorage","$location","$templateCache","$route","blockUI","Sucursal","Sucursales","SucursalesEmpresa","ClasesTipo","Clases","DosificacionesDisponibles","Sucursalupdate",function(i,a,o,r,c,n,e,s,u,d,t,l,p){n.start(),i.idModalWizardSucursalCorrelativoEdicion="modal-wizard-sucursal-correlativo-edicion",i.idModalWizardSucursalEdicion="modal-wizard-sucursal-edicion",i.idModalWizardSucursalVista="modal-wizard-sucursal-vista",i.idModalEliminarSucursal="dialog-eliminar-sucursal",i.idModalContenedorSucursalEdicion="modal-wizard-container-sucursal-edicion",i.idModalContenedorSucursalVista="modal-wizard-container-sucursal-vista",i.usuario=JSON.parse(a.usuario),i.inicio=function(){i.obtenerSucursales(),i.obtenerDepartamentos(),i.obtenerActividades(),i.obtenerDosificaciones(),i.obtenerTamanosPapelFactura(),setTimeout(function(){ejecutarScriptsTabla("tabla-sucursales",8)},2e3)},i.$on("$viewContentLoaded",function(){resaltarPestaÃ±a(o.path().substring(1)),ejecutarScriptsSucursal(i.idModalWizardSucursalEdicion,i.idModalWizardSucursalVista,i.idModalEliminarSucursal,i.idModalContenedorSucursalEdicion,i.idModalContenedorSucursalVista,i.idModalWizardSucursalCorrelativoEdicion),i.buscarAplicacion(i.usuario.aplicacionesUsuario,o.path().substring(1)),n.stop()}),i.obtenerTamanosPapelFactura=function(){n.start(),d("TAMPAPFACT").then(function(a){i.tamanosPapelFactura=a.clases,n.stop()})},i.obtenerSucursales=function(){n.start(),s(i.usuario.id_empresa).then(function(a){i.sucursales=a,console.log(a),n.stop()})},i.obtenerDepartamentos=function(){d("DEP").then(function(a){i.departamentos=a.clases})},i.obtenerActividades=function(){d("ACTCOM").then(function(a){i.actividades=a.clases})},i.obtenerDosificaciones=function(){l(i.usuario.id_empresa).then(function(a){i.dosificaciones=a})},i.buscarMunicipios=function(a){var o=a.split("-")[1];t(o+"M").then(function(a){i.municipios=a})},i.crearNuevaSucursal=function(){var o=JSON.parse(a.usuario);i.sucursal=new e({id_empresa:o.id_empresa,almacenes:[],actividadesDosificaciones:[]}),i.abrirPopup(i.idModalWizardSucursalEdicion)},i.verSucursal=function(a){i.sucursal=a,a.departamento&&i.buscarMunicipios(a.id_departamento+"-"+a.departamento.nombre_corto),i.abrirPopup(i.idModalWizardSucursalVista)},i.cerrarPopPupVista=function(){i.cerrarPopup(i.idModalWizardSucursalVista)},i.cerrarPopPupEdicion=function(){i.cerrarPopup(i.idModalWizardSucursalEdicion)},i.cerrarPopPupEdicionCorrelativo=function(){i.cerrarPopup(i.idModalWizardSucursalCorrelativoEdicion)},i.modificarSucursal=function(a){i.sucursal=a,console.log(a),a.departamento&&i.buscarMunicipios(a.id_departamento+"-"+a.departamento.nombre_corto),i.abrirPopup(i.idModalWizardSucursalEdicion)},i.mostrarConfirmacionEliminacion=function(a){i.sucursal=new e(a),i.abrirPopup(i.idModalEliminarSucursal)},i.cerrarConfirmacionEliminacion=function(){i.cerrarPopup(i.idModalEliminarSucursal)},i.eliminarSucursal=function(a){n.start(),i.cerrarConfirmacionEliminacion(),a.$delete(),i.mostrarMensaje("Eliminado exitosamente!"),i.recargarItemsTabla(),n.stop()},i.modificarCorrelativos=function(a){i.sucursal=a,i.abrirPopup(i.idModalWizardSucursalCorrelativoEdicion)},i.guardarCorrelativos=function(a){console.log(a),p.update({idSucursal:a.id},a,function(a){n.stop(),i.cerrarPopPupEdicionCorrelativo(),i.mostrarMensaje("Actualizado Exitosamente!"),i.recargarItemsTabla()})},i.saveForm=function(a){"Siguiente"!=$("#siguiente").text().trim()&&(n.start(),"string"==typeof a.id_departamento&&(a.id_departamento=a.id_departamento.split("-")[0]),a.id?(a.municipio&&(a.id_municipio=a.municipio.id),e.update({idSucursal:a.id},a,function(a){n.stop(),i.recargarItemsTabla(),i.cerrarPopPupEdicion(),i.mostrarMensaje("Actualizado Exitosamente!")})):(a.fecha_reinicio_correlativo=new Date,a.fecha_reinicio_correlativo.setDate(1),a.municipio&&(a.id_municipio=a.municipio.id),a.$save(function(a){n.stop(),i.sucursal=new e({}),i.cerrarPopPupEdicion(),i.recargarItemsTabla(),i.mostrarMensaje("Guardado Exitosamente!")},function(a){n.stop(),i.cerrarPopPupEdicion(),i.recargarItemsTabla(),i.mostrarMensaje("Ocurrio un problema al momento de guardar!")})))},i.agregarAlmacen=function(a){a.edit=!1,a.nombre&&a.numero&&a.direccion&&(-1==i.sucursal.almacenes.indexOf(a)&&i.sucursal.almacenes.push(a),i.almacen={})},i.modificarAlmacen=function(a){a.edit=!0,i.almacen=a},i.removerAlmacen=function(i){i.eliminado=!0},i.agregarActividadDosificacion=function(a){var o=!1;i.sucursal.actividadesDosificaciones.length>0?i.sucursal.actividadesDosificaciones.forEach(function(r,c,n){a.dosificacion.expirado;0==a.dosificacion.expirado&&(o=!1,r.id_dosificacion!=a.dosificacion.id&&r.id_actividad!=a.actividad.id||(o=!0)),c===n.length-1&&0==o&&a.actividad&&a.dosificacion&&(a.id||(a.id_actividad=a.actividad.id,a.id_dosificacion=a.dosificacion.id,a.expirado=!1,i.sucursal.actividadesDosificaciones.push(a)),i.actividadDosificacion={})}):a.actividad&&a.dosificacion&&(a.id||(a.id_actividad=a.actividad.id,a.id_dosificacion=a.dosificacion.id,i.sucursal.actividadesDosificaciones.push(a)),i.actividadDosificacion={})},i.removerActividadDosificacion=function(i){i.eliminado=!0},i.$on("$routeChangeStart",function(a,o){i.eliminarPopup(i.idModalWizardSucursalEdicion),i.eliminarPopup(i.idModalWizardSucursalCorrelativoEdicion),i.eliminarPopup(i.idModalWizardSucursalVista),i.eliminarPopup(i.idModalEliminarSucursal)}),i.inicio()}]);