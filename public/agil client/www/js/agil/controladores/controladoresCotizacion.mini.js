angular.module("agil.controladores").controller("ControladorCotizacion",["$scope","blockUI","$localStorage","$location","$templateCache","$route","$timeout","ListaCotizacion","Cotizaciones","Cotizacion","filtroCotizaciones","Diccionario","ListaInventariosProducto","ClasesTipo","$window","ListaProductosEmpresa","InventarioPaginador","ConfiguracionCotizacionVista","ConfiguracionCotizacionVistaDatos","FiltroCotizacionPaginador","Paginator","DatosImpresionCotizacion","ultimaCotizacion","ListaSucursalesUsuario","ClientesNit","CotizacionRechazo",function(e,o,t,i,a,n,c,r,l,s,u,d,p,f,m,C,z,h,g,x,v,b,_,P,D,w){e.usuario=JSON.parse(t.usuario),e.idModalWizardCotizacionNueva="modal-wizard-cotizacion-nueva",e.idModalInventario="dialog-productos-venta",e.idModalDialogRechazo="dialog-editar-rechazo",e.inicio=function(){e.obtenerCotizaciones(),e.detalleCotizacion={producto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},e.sucursales=[],e.obtenerSucursales(),e.cotizacionModel=["id","nombre","descripcion","fecha","numero_documento","importe","usuario"],e.productoSeleccionado=!1},e.obtenerSucursales=function(){P(e.usuario.id).then(function(o){o.sucursales.map(function(o){e.sucursales.push(o.sucursal)}),e.usuario.sucursalesUsuario=o.sucursales;for(var t=0;t<e.usuario.sucursalesUsuario.length;t++)e.sucursalesUsuario=e.sucursalesUsuario+e.usuario.sucursalesUsuario[t].sucursal.id,t+1!=e.usuario.sucursalesUsuario.length&&(e.sucursalesUsuario=e.sucursalesUsuario+",")})},e.obtenerCotizaciones=function(){e.paginator=v(),e.paginator.column="id",e.paginator.direction="desc",e.dynamicPopoverRechazo={templateUrl:"myPopoverTemplate.html"},e.paginator.callBack=e.obtenerLista,e.filtro={empresa:e.usuario.id_empresa,inicio:"",fin:"",fecha_inicio:new Date,fecha_fin:new Date,busqueda:"",importe:0,estado:"",sucursal:"",usuario:"",razon_social:"",nit:""}},e.establecerFechas=function(o,t){e.filtro.fecha_inicio=new Date(convertirFecha(o)),e.filtro.fecha_fin=new Date(convertirFecha(t))},e.obtenerLista=function(){o.start(),u(e.paginator).then(function(t){e.paginator.setPages(t.paginas),e.cotizaciones=t.cotizaciones,o.stop()})},e.sumarMonto=function(){for(var o=0,t=0;t<e.cotizaciones.length;t++)o+=e.cotizaciones[t].importe;return Math.round(100*o)/100},e.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),ejecutarScriptsCotizacion(e.idModalWizardCotizacionNueva,e.idModalInventario,e.idModalDialogRechazo),e.buscarAplicacion(e.usuario.aplicacionesUsuario,i.path().substring(1))}),e.cerrarNuevaCotizacion=function(){e.cerrarPopup(e.idModalWizardCotizacionNueva)},e.abrirPopup=function(e){abrirPopup(e)},e.cerrarPopup=function(e){ocultarPopup(e)},e.eliminarPopup=function(e){eliminarPopup(e)},e.$on("$routeChangeStart",function(o,t){e.eliminarPopup(e.idModalWizardCotizacionNueva),e.eliminarPopup(e.idModalInventario),e.eliminarPopup(e.idModalDialogRechazo)}),e.ModificarCotizacion=function(o){e.cotizacion=o,e.obtenerAlmacenes(o.sucursal.id),e.cotizacion.fecha=new Date(e.cotizacion.fecha),e.cotizacion.fechaTexto=e.cotizacion.fecha.getDate()+"/"+(e.cotizacion.fecha.getMonth()+1)+"/"+e.cotizacion.fecha.getFullYear(),e.abrirPopup(e.idModalWizardCotizacionNueva)},e.buscarProducto=function(o){if(""!=o&&void 0!=o){var t=C(e.usuario.id_empresa,o);return setTimeout(e.enfocar("id_productoTB"),0),t}},e.eliminarDetalleCotizacion=function(o){indx=e.cotizacion.detallesCotizacion.indexOf(o),e.cotizacion.detallesCotizacion[indx].eliminado=!0,e.sumarTotalImporte()},e.establecerProducto=function(o){o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto,e.detalleCotizacion={producto:o,precio_unitario:o.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,descuento:o.descuento,eliminado:!1},e.editar_precio=!1,o.activar_inventario=!1,e.calcularImporte(),e.productoSeleccionado=!0,p(o.id,e.cotizacion.almacen.id).then(function(t){o.inventarios=t,e.precio_inventario,o.inventarios.length>0?e.precio_inventario=o.inventarios[o.inventarios.length-1].costo_unitario+" Bs":e.precio_inventario="Sin histórico"})},e.calcularImporte=function(){var o,t;e.detalleCotizacion.importe=Math.round(e.detalleCotizacion.cantidad*e.detalleCotizacion.precio_unitario*1e3)/1e3,o=e.detalleCotizacion.tipo_descuento?e.detalleCotizacion.importe*(e.detalleCotizacion.descuento/100):e.detalleCotizacion.descuento,t=e.detalleCotizacion.tipo_recargo?e.detalleCotizacion.importe*(e.detalleCotizacion.recargo/100):e.detalleCotizacion.recargo,e.detalleCotizacion.total=e.detalleCotizacion.importe-o+t-e.detalleCotizacion.ice-e.detalleCotizacion.excento},e.agregarDetalleCotizacion=function(o){e.cotizacion.detallesCotizacion.push(o),e.sumarTotalImporte(),e.detalleCotizacion={producto:{},cantidad:0,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},e.productoSeleccionado=!1},e.sumarTotalImporte=function(){for(var o=0,t=0;t<e.cotizacion.detallesCotizacion.length;t++)e.cotizacion.detallesCotizacion[t].eliminado||(o+=e.cotizacion.detallesCotizacion[t].importe);e.cotizacion.importe=Math.round(1e3*o)/1e3},e.crearNuevaCotizacion=function(){e.cotizacion=new s({id_empresa:e.usuario.id_empresa,id_usuario:e.usuario.id,cliente:{},detallesCotizacion:[]});var o=new Date;e.cotizacion.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),e.detalleCotizacion={producto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},e.abrirPopup(e.idModalWizardCotizacionNueva),e.enfocar("nombreCotizacion")},e.guardarCotizacion=function(t,i){if(t){var a=new Date;if(i.fecha=new Date(e.convertirFecha(i.fechaTexto)),o.start(),i.id)s.update({id_cotizacion:i.id},i,function(t){o.stop(),e.imprimirCotizacion(i),e.cerrarNuevaCotizacion(),e.recargarItemsTabla(),e.mostrarMensaje("Actualizado exitosamente!")});else{a=new Date;i.fecha=new Date(e.convertirFecha(i.fechaTexto)),i.fecha.setHours(a.getHours()),i.fecha.setMinutes(a.getMinutes()),i.fecha.setSeconds(a.getSeconds()),i.$save(function(t){console.log("cotizacion guardaoooo ",t),o.stop(),e.imprimirCotizacion(t.cotizacion),e.cerrarNuevaCotizacion(),e.recargarItemsTabla(),e.mostrarMensaje("Cotización registrada exitosamente!"),o.stop()},function(t){o.stop(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})}}},e.obtenerAlmacenesActividades=function(o){e.obtenerAlmacenes(o)},e.obtenerAlmacenes=function(o){console.log("seleccion sucursallllllll ",o),e.almacenes=[];var t=$.grep(e.sucursales,function(e){return e.id==o})[0];e.almacenes=t.almacenes},e.buscarCliente=function(o){if(""!=o&&void 0!=o)return D(e.usuario.id_empresa,o)},e.establecerCliente=function(o){e.cotizacion.cliente=o,e.enfocar("razon_social")},e.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},e.enfocar=function(e){c(function(){$("#"+e).focus()},0)},e.interceptarTecla=function(o,t,i){13===o.which&&(i?e.enfocar(t):c(function(){$("#"+t).trigger("click")},0))},e.verificarPulso=function(o,t){13===o.keyCode&&t&&e.buscarCotizaciones(1,e.itemsPorPagina,t)},e.filtrarCotizaciones=function(t,i,a,n,c){o.start(),""==c||null==c?c=0:e.textoBusqueda=c,t=null==i||void 0==i?0:new Date(e.convertirFecha(t)),i=null==i||void 0==i?0:new Date(e.convertirFecha(i)),x(e.usuario.id_empresa,a,n,c,t,i).then(function(t){if(0==t.cotizaciones.length)return o.stop(),e.buscarCotizaciones(1,e.itemsPorPagina,"");e.cotizaciones=t.cotizaciones,e.paginas=[];for(var i=1;i<=t.paginas;i++)e.paginas.push(i);o.stop()})},e.verificarDescuentos=function(e){for(var o=!1,t=0;t<e.length;t++)(e[t].descuento>0||e[t].recargo>0||e[t].ice>0||e[t].excento>0)&&(o=!0);return o},e.dibujarCabeceraImpresionCotizacion=function(o,t,i,a,n,c){e.usuario.empresa.imagen.length>100&&o.image(e.usuario.empresa.imagen,60,40,{fit:[65,65]}),o.font("Helvetica-Bold",16),o.text("COTIZACIÓN",250,90),o.font("Helvetica-Bold",8),o.text(e.usuario.empresa.razon_social.toUpperCase(),60,110),o.font("Helvetica",7),o.text(t.sucursal.nombre.toUpperCase(),60,118);var r=t.sucursal.direccion.length,l=r<=45?129:r>45&&r<=90?139:145;o.text(t.sucursal.direccion.toUpperCase(),60,126);var s=(null!=t.sucursal.telefono1?t.sucursal.telefono1:"")+(null!=t.sucursal.telefono2?"-"+t.sucursal.telefono2:"")+(null!=t.sucursal.telefono3?"-"+t.sucursal.telefono3:"");o.text("TELF.: "+s,60,l+5),o.text("COCHABAMBA - BOLIVIA",60,l+13),o.font("Helvetica-Bold",10),o.rect(450,40,120,50).stroke(),o.text("NRO : ",460,60),o.text(t.numero_documento,500,60),o.font("Helvetica-Bold",8),o.rect(50,160,520,40).stroke(),o.text("FECHA : ",60,165),o.text("SEÑOR(ES) : ",60,180),o.text("NIT : ",360,165),o.text(t.fechaTexto,120,165),o.text(t.cliente.razon_social,120,180),o.text(t.cliente.nit,400,165),o.rect(50,200,520,25).stroke(),o.text("CODIGO",55,210,{width:70}),o.text("CANT.",125,210),t.detallesCotizacion[0].producto&&o.text("UNIDAD",155,210),o.text("DETALLE",198,210),t.detallesCotizacion[0].producto&&o.text("P.UNIT.",470,210),o.text("TOTAL",530,210),o.font("Helvetica",8);new Date},e.imprimirCotizacionCartaOficio=function(t,i,a,n){var c=new PDFDocument({size:t,compress:!1,margin:10}),r=c.pipe(blobStream());i.fecha=new Date(i.fecha),i.fechaTexto=i.fecha.getDate()+"/"+(i.fecha.getMonth()+1)+"/"+i.fecha.getFullYear();var l=240,s=0,u=0,d=1,p=Math.ceil(i.detallesCotizacion.length/a),f=e.verificarDescuentos(i.detallesCotizacion);e.dibujarCabeceraImpresionCotizacion(c,i,d,p,f,l-20);for(var m=0,C=0;C<i.detallesCotizacion.length;C++){c.font("Helvetica",7),indx=C+1,m+=i.detallesCotizacion[C].total,c.text(i.detallesCotizacion[C].producto.codigo,55,l,{width:70}),c.text(i.detallesCotizacion[C].cantidad,135,l),c.text(i.detallesCotizacion[C].producto.unidad_medida,155,l);var z=i.detallesCotizacion[C].producto.nombre.length,h=z<=45?l:z>45&&z<=90?l-7:l-14;c.text(i.detallesCotizacion[C].producto.nombre,200,h-5,{width:225}),c.text(null===i.detallesCotizacion[C].precio_unitario?"null":i.detallesCotizacion[C].precio_unitario.toFixed(2),470,l),c.text(i.detallesCotizacion[C].total.toFixed(2),530,l),ancho=z<=80?20:30,c.rect(50,l-15,520,30).stroke(),l+=30,(u+=1)==a&&(s+=u)!=i.detallesCotizacion.length&&(c.text("Pag. "+d+" de "+p,520,t[1]-40),c.addPage({size:t,margin:10}),l=240,u=0,d+=1,e.dibujarCabeceraImpresionCotizacion(c,i,d,p,f,l-20))}c.font("Helvetica-Bold",8),c.text("TOTAL",470,l),c.font("Helvetica",8),c.text(m.toFixed(2),530,l),c.text("SON : "+n,55,l),c.rect(50,l-15,520,30).stroke(),u>a-6&&(c.addPage({size:t,margin:10}),l=240,u=0,d+=1,e.dibujarCabeceraImpresionCotizacion(c,i,d,p,f,l-20)),c.rect(50,l+40,420,25).stroke(),c.font("Helvetica",8),c.text("Plazo de cotizacion: "+i.plazo,55,l+50),c.rect(50,l+80,420,25).stroke(),c.font("Helvetica",8),c.text("Nota: "+i.nota,55,l+90),c.rect(50,l+120,420,25).stroke(),c.font("Helvetica",8),null==i.descripcion&&(i.descripcion="Ninguna"),c.text("Observaciones: "+i.descripcion,55,l+130);var g=new Date,x=g.getMinutes();x<10&&(x="0"+x),c.font("Helvetica",8),c.text(i.firma,55,t[1]-90),c.text(i.cargo.toUpperCase(),55,t[1]-80),c.text("usuario : "+e.usuario.nombre_usuario,380,t[1]-60),c.text("fecha : "+g.getDate()+"/"+(g.getMonth()+1)+"/"+g.getFullYear()+"  "+g.getHours()+":"+x,480,t[1]-60),p>1&&c.text("Pag. "+d+" de "+p,520,t[1]-40),c.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),o.stop()},e.dibujarCabeceraImpresionCotizacionCuartoCarta=function(o,t,i,a,n,c){e.usuario.empresa.imagen.length>100?o.image(e.usuario.empresa.imagen,20,c-80,{width:50,height:50}):o.image(e.usuario.empresa.imagen,20,c-80),sucurTel={};for(var r=0;r<e.sucursales.length;r++)e.sucursales[r].id==t.id_sucursal&&(sucurTel=e.sucursales[r].telefono1);o.font("Helvetica-Bold",8),o.text("COTIZACIÓN N°"+t.id,120,c-80),o.font("Helvetica",7),o.text("Nombre: "+t.nombre+"    Descripción: "+t.descripcion,20,c-20),o.text("Fecha: "+t.fechaTexto,225,c-20),o.font("Helvetica-Bold",7),o.text(e.usuario.empresa.razon_social.toUpperCase(),220,c-80+0),o.font("Helvetica",6),o.text("NIT "+e.usuario.empresa.nit,225,c-80+10),o.text("TELF.: "+sucurTel,225,c-80+20),o.text("Fecha: "+t.fechaTexto,225,c-80+30),o.font("Helvetica",5),o.text("COCHABAMBA - BOLIVIA",220,c-80+40),o.rect(15,c-10,282,20).stroke(),o.font("Helvetica",6),o.text("N°",20,c),n?(o.text("Cod.",30,c),o.text("Cant.",60,c),o.text("Unid.",80,c),o.text("Det.",100,c),o.text("P.Unit.",184,c),o.text("Imp.",212,c),o.text("Desc.",240,c),o.text("Totl.",270,c)):(o.text("Cod.",30,c),o.text("Cant.",60,c),o.text("Unid.",80,c),o.text("Detalle.",100,c),o.text("P.Unit.",195,c),o.text("Total.",270,c)),o.font("Helvetica",8)},e.imprimirCotizacionRollo=function(t,i){var a=new PDFDocument({size:t,compress:!1,margin:10}),n=a.pipe(blobStream());i.fecha=new Date(i.fecha),i.fechaTexto=i.fecha.getDate()+"/"+(i.fecha.getMonth()+1)+"/"+i.fecha.getFullYear();var c=0;i.configuracion.tamanoPapelCotizacion.nombre_corto==d.FACT_PAPEL_MEDIOOFICIO?c=13:i.configuracion.tamanoPapelCotizacion.nombre_corto==d.FACT_PAPEL_CUARTOCARTA&&(c=13);var r=140,l=Math.ceil(i.detallesCotizacion.length/c),s=e.verificarDescuentos(i.detallesCotizacion);e.dibujarCabeceraImpresionCotizacionCuartoCarta(a,i,1,l,s,r-20);for(var u=0,p=0;p<i.detallesCotizacion.length;p++){a.font("Helvetica",7),u+=i.detallesCotizacion[p].importe,indx=p+1;var f=i.detallesCotizacion[p].producto.nombre.length;if(a.text(indx,20,r),s){a.text(i.detallesCotizacion[p].producto.codigo,30,r-7,{width:32}),a.text(i.detallesCotizacion[p].cantidad,64,r,{width:30}),a.text(i.detallesCotizacion[p].producto.unidad_medida,79,r,{width:30});var m=f<=45?r-7:r;a.text(i.detallesCotizacion[p].producto.nombre,100,m-7,{width:80}),a.text(i.detallesCotizacion[p].precio_unitario.toFixed(2),184,r,{width:30}),a.text(i.detallesCotizacion[p].importe.toFixed(2),212,r),a.text(i.detallesCotizacion[p].tipo_descuento?"%":"Bs",240,r),a.text(i.detallesCotizacion[p].descuento.toFixed(2),250,r),a.text(i.detallesCotizacion[p].total.toFixed(2),270,r)}else{a.text(i.detallesCotizacion[p].producto.codigo,30,r-7,{width:32}),a.text(i.detallesCotizacion[p].cantidad,64,r,{width:30}),a.text(i.detallesCotizacion[p].producto.unidad_medida,79,r,{width:30}),console.log(f);m=f<=65?r-7:r;a.text(i.detallesCotizacion[p].producto.nombre,100,m,{width:80}),a.text(i.detallesCotizacion[p].precio_unitario.toFixed(2),184,r,{width:30}),a.text(i.detallesCotizacion[p].total.toFixed(2),270,r)}ancho=f<=80?20:30,a.rect(15,r-10,282,ancho).stroke(),r+=20,0}a.font("Helvetica-Bold",7),a.text("TOTAL BS.",225,r),a.text(u.toFixed(1),270,r),a.rect(220,r-10,77,20).stroke(),a.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),o.stop()},e.imprimirCotizacionCuartoCarta=function(t,i,a){ObtenerImagen(e.usuarioSesion.empresa.imagen).then(function(n){e.usuario.empresa.imagen=n;var c=new PDFDocument({size:t,compress:!1,margin:10}),r=c.pipe(blobStream());i.fecha=new Date(i.fecha),i.fechaTexto=i.fecha.getDate()+"/"+(i.fecha.getMonth()+1)+"/"+i.fecha.getFullYear();var l=140,s=0,u=0,d=1,p=Math.ceil(i.detallesCotizacion.length/a),f=e.verificarDescuentos(i.detallesCotizacion);e.dibujarCabeceraImpresionCotizacionCuartoCarta(c,i,d,p,f,l-20);for(var C=0,z=0;z<i.detallesCotizacion.length;z++){c.font("Helvetica",7),C+=i.detallesCotizacion[z].importe,indx=z+1;var h=i.detallesCotizacion[z].producto.nombre.length;if(c.text(indx,20,l),f){c.text(i.detallesCotizacion[z].producto.codigo,30,l-7,{width:32}),c.text(i.detallesCotizacion[z].cantidad,64,l,{width:30}),c.text(i.detallesCotizacion[z].producto.unidad_medida,79,l,{width:30});var g=h<=45?l-7:l;c.text(i.detallesCotizacion[z].producto.nombre,100,g,{width:80}),c.text(i.detallesCotizacion[z].precio_unitario.toFixed(2),184,l,{width:30}),c.text(i.detallesCotizacion[z].importe.toFixed(2),212,l),c.text(i.detallesCotizacion[z].tipo_descuento?"%":"Bs",240,l),c.text(i.detallesCotizacion[z].descuento.toFixed(2),250,l),c.text(i.detallesCotizacion[z].total.toFixed(2),270,l)}else{c.text(i.detallesCotizacion[z].producto.codigo,30,l,{width:32}),c.text(i.detallesCotizacion[z].cantidad,64,l,{width:30}),c.text(i.detallesCotizacion[z].producto.unidad_medida,79,l,{width:30});g=h<=45?l-7:l;c.text(i.detallesCotizacion[z].producto.nombre,100,g,{width:80}),c.text(i.detallesCotizacion[z].precio_unitario.toFixed(2),184,l,{width:30}),c.text(i.detallesCotizacion[z].total.toFixed(2),270,l)}ancho=h<=80?20:30,c.rect(15,l-10,282,ancho).stroke(),l+=20,++u==a&&(s+=u)!=i.detallesCotizacion.length&&(c.text("Pag. "+d+" de "+p,260,t[1]-40),c.addPage({size:t,margin:10}),l=140,u=0,d+=1,e.dibujarCabeceraImpresionCotizacionCuartoCarta(c,i,d,p,f,l-20))}c.font("Helvetica-Bold",7),c.text("TOTAL BS.",225,l),c.text(C.toFixed(2),270,l),c.rect(220,l-10,77,20).stroke(),p>1&&c.text("Pag. "+d+" de "+p,255,t[1]-40),c.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");m.open(e,"_blank","location=no")}),o.stop()})},e.imprimirCotizacion=function(o){console.log("cotizacion id"),console.log(o),b(o.id,e.usuario.id_empresa).then(function(o){console.log("datos"),console.log(o.cotizacion);var t=o.cotizacion;t.configuracion=o.configuracionGeneralFactura;var i,a=new Date(t.fecha);if(t.fechaTexto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),t.configuracion.tamanoPapelCotizacion.nombre_corto==d.FACT_PAPEL_OFICIO)console.log("impresion papel oficio"),i=[612,936],itemsPorPagina=20,e.imprimirCotizacionCartaOficio(i,t,itemsPorPagina,o.numero_literal);else if(t.configuracion.tamanoPapelCotizacion.nombre_corto==d.FACT_PAPEL_CARTA)console.log("impresion papel carta"),i=[612,792],itemsPorPagina=15,e.imprimirCotizacionCartaOficio(i,t,itemsPorPagina,o.numero_literal);else if(t.configuracion.tamanoPapelCotizacion.nombre_corto==d.FACT_PAPEL_MEDIOOFICIO)console.log("impresion papel medio oficio"),i=[612,468],itemsPorPagina=5,e.imprimirCotizacionCartaOficio(i,t,itemsPorPagina,o.numero_literal);else if(t.configuracion.tamanoPapelCotizacion.nombre_corto==d.FACT_PAPEL_ROLLO){var n;console.log("impresion papel rollo"),t.detallesCotizacion.length<=2?(console.log("impresion papel rollo detalle <= 2"),n=610):(console.log("impresion papel rollo detalle > 2"),n=610+20*(t.detallesCotizacion.length-2)),console.log("impresion papel rollo alto: "+n),i=[306,n],itemsPorPagina=10,e.imprimirCotizacionRollo(i,t)}else t.configuracion.tamanoPapelCotizacion.nombre_corto==d.FACT_PAPEL_CUARTOCARTA&&(i=[306,396],itemsPorPagina=8,e.imprimirCotizacionCuartoCarta(i,t,itemsPorPagina))})},e.abrirDialogDialogRechazo=function(o){e.cotizacion=o,e.abrirPopup(e.idModalDialogRechazo)},e.cerrarDialogDialogRechazo=function(){e.cerrarPopup(e.idModalDialogRechazo)},e.saveRechazo=function(t){console.log("cotizacion ssssss ",t),t.fecha_estado=new Date(e.convertirFecha(t.fechaTexto)),t.estado="RECHAZADO",w.update({id_cotizacion:t.id},t,function(o){e.mostrarMensaje("actualizado Exitosamente!")},function(o){e.mostrarMensaje("Hubo un problema al guardar.")}),o.stop(),e.cerrarDialogDialogRechazo()},e.imprimirFiltroCajaCartaOficio=function(t,i,a){var n=new PDFDocument({compress:!1,size:[612,792],margin:0}),c=n.pipe(blobStream()),r=Math.ceil(t.length/20),l=100,s=0,u=1;e.imprimirCabeceraFiltroCajaCartaOficio(n,1,r,t,i,a),n.font("Helvetica",7);for(var d=0;d<t.length;d++){n.font("Helvetica",7),n.rect(50,l+9,520,0).stroke(),n.text(d+1,55,l+20),n.font("Helvetica",6),n.text(t[d].sucursal.nombre,80,l+20),t[d].cliente?(n.font("Helvetica",6),n.text(t[d].cliente.razon_social,150,l+15,{width:75}),n.font("Helvetica",7),n.text(t[d].cliente.nit,270,l+20)):(n.text("",150,l+16,{width:75}),n.text("",270,l+20)),t[d].fecha=new Date(t[d].fecha),n.text(t[d].fecha.getHours()+":"+t[d].fecha.getMinutes()+" - ",340,l+21,{width:28});var p=360;if(t[d].fecha.getMinutes()>10&&(p=365),n.text(t[d].fecha.getDate()+"/"+(t[d].fecha.getMonth()+1)+"/"+t[d].fecha.getFullYear(),p,l+21,{width:32}),n.text(t[d].importe,425,l+20),n.text(t[d].usuario.nombre_usuario,455,l+20),n.text(t[d].estado,500,l+16,{width:65}),n.font("Helvetica",7),l+=30,20==++s){n.text(u+" de "+r,520,705);var f=new Date;n.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),n.text("USUARIO: "+e.usuario.nombre_usuario,150,705),n.addPage({size:[612,792],margin:10}),l=100,s=0,u+=1,e.imprimirCabeceraFiltroCajaCartaOficio(n,1,r,t,i,a)}}n.font("Helvetica",7),n.text(u+" de "+r,520,705);f=new Date;n.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),n.text("USUARIO: "+e.usuario.nombre_usuario,150,705),n.end(),c.on("finish",function(){var e=c.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),o.stop()},e.imprimirCabeceraFiltroCajaCartaOficio=function(e,o,t,i,a,n){e.font("Helvetica-Bold",16),e.text("REPORTE DE COTIZACIONES",0,40,{align:"center"}),e.font("Helvetica-Bold",8),e.rect(50,80,520,620).stroke(),e.text("Desde: "+a+" Hasta: "+n,0,55,{align:"center"}),e.font("Helvetica-Bold",7),e.font("Helvetica-Bold",8),e.text("N°",55,90),e.text("Sucursal",80,90),e.text("Razon Social",150,90),e.text("Nit Cliente",270,90),e.text("Fecha",340,90),e.text("Monto",420,90),e.text("Usuario",455,90),e.text("Estado",500,90)},e.imprimirFiltroExcelCajaCartaOficio=function(e){o.start();for(var t=[["N°","Sucursal","Razon Social","Nit Cliente","Fecha","Monto","Usuario","Estado"]],i=0;i<e.length;i++)e[i].fecha=new Date(e[i].fecha);e.sort(function(e,o){return e.fecha>o.fecha?1:e.fecha<o.fecha?-1:0});for(i=0;i<e.length;i++){var a=[];a.push(i+1),a.push(e[i].sucursal.nombre),e[i].cliente?(a.push(e[i].cliente.razon_social),a.push(e[i].cliente.nit)):(a.push(""),a.push("")),a.push(e[i].fecha),a.push(e[i].importe),a.push(e[i].usuario.nombre_usuario),a.push(e[i].estado),t.push(a)}var n="SheetJS",c=new Workbook,r=sheet_from_array_of_arrays(t);c.SheetNames.push(n),c.Sheets[n]=r;var l=XLSX.write(c,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"Reporte-cotizaciones.xlsx"),o.stop()},e.inicio()}]);