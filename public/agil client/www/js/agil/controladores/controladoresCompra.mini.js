angular.module("agil.controladores").controller("ControladorCompras",["$scope","$localStorage","$location","$templateCache","$route","blockUI","DatosCompra","$timeout","Compra","Compras","Proveedores","ProveedoresNit","ListaProductosEmpresaUsuario","ClasesTipo","CompraDatos","ConfiguracionCompraVistaDatos","ConfiguracionCompraVista","ConfiguracionesCuentasEmpresa","ClasesTipoEmpresa","Tipos","SaveCompra","ListaCompraPedidosEmpresa","EliminarPedidoEmpresa","EliminarDetallePedidoEmpresa",function(e,o,a,t,r,i,n,c,l,s,p,d,m,u,C,v,g,f,_,P,E,b,x,h){i.start(),e.usuario=JSON.parse(o.usuario),e.idModalPago="dialog-pago",e.idModalWizardCompraEdicion="modal-wizard-compra-edicion",e.idModalWizardCompraVista="modal-wizard-compra-vista",e.idModalEliminarCompra="dialog-eliminar-compra",e.idModalContenedorCompraEdicion="modal-wizard-container-compra-edicion",e.idModalContenedorCompraVista="modal-wizard-container-compra-vista",e.idInputCompletar="nit",e.idModalServicios="dialog-servicios",e.idModalPedidos="dialog-pedidos",e.idModalDetallePedidos="dialog-detalle-pedidos",e.idModalEliminarPedido="dialog-eliminar-pedido",e.idModalEliminarProductoPedido="dialog-eliminar-producto-pedido",e.ModalMensajePago="Modal-Mensaje-Pago",e.url=restServer+"/proveedores/empresa/"+e.usuario.id_empresa+"/texto/",e.$on("$viewContentLoaded",function(){resaltarPesta√±a(a.path().substring(1)),ejecutarScriptsCompra(e.idModalWizardCompraEdicion,e.idModalWizardCompraVista,e.idModalEliminarCompra,e.idModalContenedorCompraEdicion,e.idModalContenedorCompraVista,e.idInputCompletar,e.url,e.idModalPago,e.idModalServicios,e.idModalPedidos,e.idModalDetallePedidos,e.idModalEliminarPedido,e.idModalEliminarProductoPedido,e.ModalMensajePago),e.buscarAplicacion(e.usuario.aplicacionesUsuario,a.path().substring(1)),$("#formularioCompra").ketchup({validateEvents:"blur focus keyup change submit"}),i.stop()}),e.inicio=function(){e.esContado=!0,e.obtenerProveedores(),e.obtenerTiposDePago(),e.obtenerConfiguracionCompraVista(),e.obtenerCentrosDeCosto(),e.sucursales=e.obtenerSucursales(),e.obtenerCompras(),e.busquedaProductoHabilidato=!1,e.usuario.empresa.usar_funciones_erp&&(e.obtenerMovimientosIngreso(),e.obtenerconfiuracionCuentas()),e.detalleCompra={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1}},e.obtenerconfiuracionCuentas=function(){var o=f(e.usuario.id_empresa);e.plantilla={retencionServicios:{it:{},iue:{},servicio:{}},retencionBienesGasto:{it:{},iue:{},gasto:{}},retencionBienes:{it:{},iue:{},almacen:{}},egreso:{ivacf:{},cajaBanco:{}},ingreso:{ivadf:{},it:{},itPorPagar:{},cajaBanco:{}}},o.then(function(o){o.lista.forEach(function(o){e.diccionario.IVA_DF==o.nombre&&(e.plantilla.ingreso.ivadf={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IT==o.nombre&&(e.plantilla.ingreso.it={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IT_POR_PAGAR==o.nombre&&(e.plantilla.ingreso.itPorPagar={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.CAJA_BANCOS==o.nombre&&(e.plantilla.ingreso.cajaBanco={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IVA_CF==o.nombre&&(e.plantilla.egreso.ivacf={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.CAJA_BANCOS==o.nombre&&(e.plantilla.egreso.cajaBanco={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IT_RETENCION_BIEN==o.nombre&&(e.plantilla.retencionBienes.it={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IUE_RETENCION_BIEN==o.nombre&&(e.plantilla.retencionBienes.iue={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.CUENTA_ALMACEN_RETENCION_BIEN==o.nombre&&(e.plantilla.retencionBienes.almacen={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IT_RETENCION_BIEN_GASTO==o.nombre&&(e.plantilla.retencionBienesGasto.it={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IUE_RETENCION_BIEN_GASTO==o.nombre&&(e.plantilla.retencionBienesGasto.iue={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.CUENTA_GASTO_RETENCION_BIEN==o.nombre&&(e.plantilla.retencionBienesGasto.gasto={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IT_RETENCION_SERVICIO==o.nombre&&(e.plantilla.retencionServicios.it={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.IUE_RETENCION_SERVICIO==o.nombre&&(e.plantilla.retencionServicios.iue={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),e.diccionario.CUENTA_RETENCION_SERVICIO==o.nombre&&(e.plantilla.retencionServicios.servicio={porsentaje:parseFloat(o.valor),cuenta:o.cuenta})},this)})},e.obtenerConfiguracionCompraVista=function(){i.start(),v(e.usuario.id_empresa).then(function(o){e.configuracionCompraVista=o,i.stop()})},e.guardarConfiguracionCompraVista=function(){g.update({id_empresa:e.usuario.id_empresa},e.configuracionCompraVista,function(e){})},e.obtenerTiposDePago=function(){i.start(),u("TIPA").then(function(o){e.tiposPago=o.clases,i.stop()})},e.obtenerCentrosDeCosto=function(){i.start(),u("CCO").then(function(o){if(e.centrosCosto=o.clases,e.usuario.empresa.usar_funciones_erp){var a=[];e.centrosCosto.forEach(function(e,o,t){"ALM"==e.nombre_corto||"VR"==e.nombre_corto||a.push(o)}),a.reverse().forEach(function(o,a,t){e.centrosCosto.splice(o,1)})}i.stop()})},e.obtenerProveedores=function(){p(e.usuario.id_empresa).then(function(o){for(var a=0;a<o.length;a++)o[a].nit=o[a].nit.toString();e.proveedores=o})},e.modificarCompra=function(o){C(o.id).then(function(o){""!=o.observacion&&(o.usarObservacion=!0),e.compra=o,e.compra.fecha=new Date(e.compra.fecha),e.compra.fechaTexto=e.compra.fecha.getDate()+"/"+(e.compra.fecha.getMonth()+1)+"/"+e.compra.fecha.getFullYear(),void 0==e.compra.sucursal&&(e.compra.sucursal=o.almacen.sucursal),void 0==e.compra.movimiento&&(e.compra.movimiento={clase:{}},e.compra.movimiento.clase=e.compra.tipoMovimiento),e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_BIENES||e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_SERVICIOS?(e.configuracionCompraVista.mostrar_it_retencion=!0,e.configuracionCompraVista.mostrar_iue=!0,e.configuracionCompraVista.mostrar_pagado=!0):(e.configuracionCompraVista.mostrar_it_retencion=!1,e.configuracionCompraVista.mostrar_iue=!1,e.configuracionCompraVista.mostrar_pagado=!1),e.obtenerAlmacenes(e.compra.sucursal.id),e.cambiarTipoPago(e.compra.tipoPago),e.usuario.empresa.usar_vencimientos&&e.compra.usar_producto&&e.aplicarFechaTextoDetalleCompra(e.compra),e.abrirPopup(e.idModalWizardCompraEdicion)})},e.aplicarFechaTextoDetalleCompra=function(e){for(var o=0;o<e.detallesCompra.length;o++)"ALM"==e.detallesCompra[o].centroCosto.nombre_corto&&(e.detallesCompra[o].inventario.fecha_vencimiento=new Date(e.detallesCompra[o].inventario.fecha_vencimiento),e.detallesCompra[o].inventario.fechaVencimientoTexto=e.detallesCompra[o].inventario.fecha_vencimiento.getDate()+"/"+(e.detallesCompra[o].inventario.fecha_vencimiento.getMonth()+1)+"/"+e.detallesCompra[o].inventario.fecha_vencimiento.getFullYear())},e.buscarProveedor=function(o){if(""!=o&&void 0!=o)return d(e.usuario.id_empresa,o)},e.establecerProveedor=function(o){e.compra.proveedor=o},e.buscarProducto=function(o){if(""!=o&&void 0!=o&&e.busquedaProductoHabilidato)return m(e.usuario.id_empresa,o,e.usuario.id,e.compra.almacen.id)},e.verificarProducto=function(o){o.centroCosto.nombre.nombre==e.diccionario.CENTRO_COSTO_ALMACEN?o.producto.id?void 0!=e.compra.movimiento.clase&&e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_BIENES?(o.descuento=0,o.ice=0,o.recargo=0,o.excento=0,e.configuracionCompraVista.mostrar_it_retencion=!0,e.configuracionCompraVista.mostrar_iue=!0,e.configuracionCompraVista.mostrar_pagado=!0,e.agregarDetalleCompra(o)):e.agregarDetalleCompra(o):e.mostrarMensaje("El producto no se encuentra en el catalogo"):void 0!=e.compra.movimiento.clase&&e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_BIENES?(o.descuento=0,o.ice=0,o.recargo=0,o.excento=0,e.configuracionCompraVista.mostrar_it_retencion=!0,e.configuracionCompraVista.mostrar_iue=!0,e.configuracionCompraVista.mostrar_pagado=!0,e.agregarDetalleCompra(o)):e.agregarDetalleCompra(o)},e.verificarServicio=function(o){o.servicio.id?void 0!=e.compra.movimiento.clase&&e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_SERVICIOS?(o.descuento=0,o.ice=0,o.recargo=0,o.excento=0,e.configuracionCompraVista.mostrar_it_retencion=!0,e.configuracionCompraVista.mostrar_iue=!0,e.configuracionCompraVista.mostrar_pagado=!0,e.agregarDetalleCompraServicio(o)):e.agregarDetalleCompraServicio(o):e.mostrarMensaje("El producto no se encuentra en el catalogo")},e.agregarDetalleCompra=function(o){if(o.producto.nombre.id&&(o.producto=o.producto.nombre),o.centroCosto.nombre.id)o.centroCosto=o.centroCosto.nombre;else if(o.centroCosto.nombre==e.diccionario.CENTRO_COSTO_ALMACEN){var a=$.grep(e.centrosCosto,function(o){return o.nombre==e.diccionario.CENTRO_COSTO_ALMACEN})[0];o.centroCosto=a}o.fechaVencimientoTexto&&(o.fecha_vencimiento=new Date(e.convertirFecha(o.fechaVencimientoTexto))),e.compra.detallesCompra.push(o),e.sumarTotal(),e.sumarTotalImporte(),e.compra.descuento_general&&e.calcularImporteGeneral(),e.compra.tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO?e.calcularSaldo():(e.compra.a_cuenta=null,e.compra.saldo=null,e.compra.dias_credito=null),e.detalleCompra={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},e.enfocar("centro_costo")},e.agregarDetalleCompraServicio=function(o){e.compra.detallesCompra.push(o),e.sumarTotal(),e.sumarTotalImporte(),e.compra.descuento_general&&e.calcularImporteGeneral(),e.compra.tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO?e.calcularSaldo():(e.compra.a_cuenta=null,e.compra.saldo=null,e.compra.dias_credito=null),e.detalleCompra={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},e.enfocar("centro_costo")},e.eliminarDetalleCompra=function(o){e.compra.id?o.eliminado=!0:e.compra.detallesCompra.splice(e.compra.detallesCompra.indexOf(o),1),e.sumarTotal(),e.sumarTotalImporte(),e.compra.descuento_general&&e.calcularImporteGeneral(),e.compra.tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO?e.calcularSaldo():(e.compra.a_cuenta=null,e.compra.saldo=null,e.compra.dias_credito=null)},e.cambiarTipoPago=function(o){o=$.grep(e.tiposPago,function(e){return e.id==o.id})[0];e.esContado="CONT"==o.nombre_corto,e.compra.id_tipo_pago=o.id,e.esContado?(e.compra.a_cuenta=null,e.compra.saldo=null,e.compra.dias_credito=null):e.calcularSaldo()},e.recalcular=function(){e.calcularImporteGeneral(),e.calcularImporte()},e.calcularImporteGeneral=function(){var o,a;o=e.compra.tipo_descuento?e.compra.importe*(e.compra.descuento/100):e.compra.descuento,a=e.compra.tipo_recargo?e.compra.importe*(e.compra.recargo/100):e.compra.recargo,e.compra.total=Math.round(1e3*(e.compra.importe-o+a-e.compra.ice-e.compra.excento))/1e3},e.calcularImportePedido=function(o){var a,t;o.importe=Math.round(o.cantidad*o.costo_unitario*1e3)/1e3,e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_BIENES?e.compra.tipo_retencion?o.centroCosto.nombre.nombre==e.diccionario.CENTRO_COSTO_ALMACEN?(o.total=o.importe,o.importe=o.total*(e.plantilla.retencionBienes.it.porsentaje+e.plantilla.retencionBienes.iue.porsentaje)/(100-(e.plantilla.retencionBienes.it.porsentaje+e.plantilla.retencionBienes.iue.porsentaje))+o.total,o.it=o.importe*e.plantilla.retencionBienes.it.porsentaje/100,o.iue=o.importe*e.plantilla.retencionBienes.iue.porsentaje/100):(o.total=o.importe,o.importe=o.total*(e.plantilla.retencionBienesGasto.it.porsentaje+e.plantilla.retencionBienesGasto.iue.porsentaje)/(100-(e.plantilla.retencionBienesGasto.it.porsentaje+e.plantilla.retencionBienesGasto.iue.porsentaje))+o.total,o.it=o.importe*e.plantilla.retencionBienesGasto.it.porsentaje/100,o.iue=o.importe*e.plantilla.retencionBienesGasto.iue.porsentaje/100):o.centroCosto.nombre.nombre==e.diccionario.CENTRO_COSTO_ALMACEN?(o.it=o.importe*e.plantilla.retencionBienes.it.porsentaje/100,o.iue=o.importe*e.plantilla.retencionBienes.iue.porsentaje/100,o.total=o.importe*e.plantilla.retencionBienes.almacen.porsentaje/100):(o.it=o.importe*e.plantilla.retencionBienesGasto.it.porsentaje/100,o.iue=o.importe*e.plantilla.retencionBienesGasto.iue.porsentaje/100,o.total=o.importe*e.plantilla.retencionBienesGasto.gasto.porsentaje/100):e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_IMPORTACION?o.total=o.importe:e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_SERVICIOS?e.compra.tipo_retencion?(o.total=o.importe,o.importe=o.total*(e.plantilla.retencionServicios.it.porsentaje+e.plantilla.retencionServicios.iue.porsentaje)/(100-(e.plantilla.retencionServicios.it.porsentaje+e.plantilla.retencionServicios.iue.porsentaje))+o.total,o.it=o.importe*e.plantilla.retencionServicios.it.porsentaje/100,o.iue=o.importe*e.plantilla.retencionServicios.iue.porsentaje/100):(o.it=o.importe*e.plantilla.retencionServicios.it.porsentaje/100,o.iue=o.importe*e.plantilla.retencionServicios.iue.porsentaje/100,o.total=o.importe*e.plantilla.retencionServicios.servicio.porsentaje/100):e.compra.descuento_general?(a=e.compra.tipo_descuento?o.importe*(e.compra.descuento/100):e.compra.descuento,t=e.compra.tipo_recargo?o.importe*(e.compra.recargo/100):e.compra.recargo,o.total=o.importe-a+t-e.compra.ice-e.compra.excento):(a=o.tipo_descuento?o.importe*(o.descuento/100):o.descuento,t=o.tipo_recargo?o.importe*(o.recargo/100):o.recargo,o.total=o.importe-a+t-o.ice-o.excento)},e.calcularImporte=function(){var o,a;e.detalleCompra.importe=Math.round(e.detalleCompra.cantidad*e.detalleCompra.costo_unitario*1e3)/1e3,e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_BIENES?e.compra.tipo_retencion?e.detalleCompra.centroCosto.nombre.nombre==e.diccionario.CENTRO_COSTO_ALMACEN?(e.detalleCompra.total=e.detalleCompra.importe,e.detalleCompra.importe=e.detalleCompra.total*(e.plantilla.retencionBienes.it.porsentaje+e.plantilla.retencionBienes.iue.porsentaje)/(100-(e.plantilla.retencionBienes.it.porsentaje+e.plantilla.retencionBienes.iue.porsentaje))+e.detalleCompra.total,e.detalleCompra.it=e.detalleCompra.importe*e.plantilla.retencionBienes.it.porsentaje/100,e.detalleCompra.iue=e.detalleCompra.importe*e.plantilla.retencionBienes.iue.porsentaje/100):(e.detalleCompra.total=e.detalleCompra.importe,e.detalleCompra.importe=e.detalleCompra.total*(e.plantilla.retencionBienesGasto.it.porsentaje+e.plantilla.retencionBienesGasto.iue.porsentaje)/(100-(e.plantilla.retencionBienesGasto.it.porsentaje+e.plantilla.retencionBienesGasto.iue.porsentaje))+e.detalleCompra.total,e.detalleCompra.it=e.detalleCompra.importe*e.plantilla.retencionBienesGasto.it.porsentaje/100,e.detalleCompra.iue=e.detalleCompra.importe*e.plantilla.retencionBienesGasto.iue.porsentaje/100):e.detalleCompra.centroCosto.nombre.nombre==e.diccionario.CENTRO_COSTO_ALMACEN?(e.detalleCompra.it=e.detalleCompra.importe*e.plantilla.retencionBienes.it.porsentaje/100,e.detalleCompra.iue=e.detalleCompra.importe*e.plantilla.retencionBienes.iue.porsentaje/100,e.detalleCompra.total=e.detalleCompra.importe*e.plantilla.retencionBienes.almacen.porsentaje/100):(e.detalleCompra.it=e.detalleCompra.importe*e.plantilla.retencionBienesGasto.it.porsentaje/100,e.detalleCompra.iue=e.detalleCompra.importe*e.plantilla.retencionBienesGasto.iue.porsentaje/100,e.detalleCompra.total=e.detalleCompra.importe*e.plantilla.retencionBienesGasto.gasto.porsentaje/100):e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_IMPORTACION?e.detalleCompra.total=e.detalleCompra.importe:e.compra.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_SERVICIOS?e.compra.tipo_retencion?(e.detalleCompra.total=e.detalleCompra.importe,e.detalleCompra.importe=e.detalleCompra.total*(e.plantilla.retencionServicios.it.porsentaje+e.plantilla.retencionServicios.iue.porsentaje)/(100-(e.plantilla.retencionServicios.it.porsentaje+e.plantilla.retencionServicios.iue.porsentaje))+e.detalleCompra.total,e.detalleCompra.it=e.detalleCompra.importe*e.plantilla.retencionServicios.it.porsentaje/100,e.detalleCompra.iue=e.detalleCompra.importe*e.plantilla.retencionServicios.iue.porsentaje/100):(e.detalleCompra.it=e.detalleCompra.importe*e.plantilla.retencionServicios.it.porsentaje/100,e.detalleCompra.iue=e.detalleCompra.importe*e.plantilla.retencionServicios.iue.porsentaje/100,e.detalleCompra.total=e.detalleCompra.importe*e.plantilla.retencionServicios.servicio.porsentaje/100):e.compra.descuento_general?(o=e.compra.tipo_descuento?e.detalleCompra.importe*(e.compra.descuento/100):e.compra.descuento,a=e.compra.tipo_recargo?e.detalleCompra.importe*(e.compra.recargo/100):e.compra.recargo,e.detalleCompra.total=e.detalleCompra.importe-o+a-e.compra.ice-e.compra.excento):(o=e.detalleCompra.tipo_descuento?e.detalleCompra.importe*(e.detalleCompra.descuento/100):e.detalleCompra.descuento,a=e.detalleCompra.tipo_recargo?e.detalleCompra.importe*(e.detalleCompra.recargo/100):e.detalleCompra.recargo,e.detalleCompra.total=e.detalleCompra.importe-o+a-e.detalleCompra.ice-e.detalleCompra.excento)},e.calcularImporteDetalleEdicion=function(o){var a,t;o.importe=Math.round(o.cantidad*o.costo_unitario*1e3)/1e3,a=o.tipo_descuento?o.importe*(o.descuento/100):o.descuento,t=o.tipo_recargo?o.importe*(o.recargo/100):o.recargo,o.total=o.importe-a+t-o.ice-o.excento,e.sumarTotal(),e.sumarTotalImporte(),e.compra.descuento_general&&e.calcularImporteGeneral(),e.compra.tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO?e.calcularSaldo():(e.compra.a_cuenta=null,e.compra.saldo=null,e.compra.dias_credito=null)},e.sumarMonto=function(e){for(var o=0,a=0;a<e.length;a++)o+=e[a].total;return Math.round(100*o)/100},e.sumarTotalImporte=function(){for(var o=0,a=0;a<e.compra.detallesCompra.length;a++)e.compra.detallesCompra[a].eliminado||(o+=e.compra.detallesCompra[a].importe);e.compra.importe=Math.round(1e3*o)/1e3},e.sumarTotal=function(){for(var o=0,a=0;a<e.compra.detallesCompra.length;a++)e.compra.detallesCompra[a].eliminado||(o+=e.compra.detallesCompra[a].total);e.compra.total=Math.round(1e3*o)/1e3},e.calcularSaldo=function(){e.compra.saldo=e.compra.total-e.compra.a_cuenta},e.obtenerSucursales=function(){for(var o=[],a=0;a<e.usuario.sucursalesUsuario.length;a++)o.push(e.usuario.sucursalesUsuario[a].sucursal);return o},e.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},e.enfocar=function(e){c(function(){$("#"+e).focus()},0)},e.interceptarTecla=function(o,a,t){13===o.which&&(t?e.enfocar(a):c(function(){$("#"+a).trigger("click")},0))},e.obtenerMovimientosIngreso=function(o){i.start(),u("MOVING").then(function(o){e.movimientosIngreso=o.clases;var a=[];e.movimientosIngreso.forEach(function(o,t,r){o.nombre!==e.diccionario.MOVING_INVENTARIO_INICIAL&&o.nombre!==e.diccionario.MOVING_POR_TRASPASO&&o.nombre!==e.diccionario.MOVING_POR_DEVOLUCION&&o.nombre!==e.diccionario.MOVING_POR_AJUSTE||a.push(t)}),a.reverse().forEach(function(o){e.movimientosIngreso.splice(o,1)}),i.stop()})},e.verificarMomivmiento=function(o){o.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_SERVICIOS?o.usar_producto=!1:o.movimiento.clase.nombre==e.diccionario.MOVING_POR_RETENCION_BIENES?o.usar_producto=!0:o.movimiento.clase.nombre==e.diccionario.MOVING_POR_IMPORTACION&&(o.factura=0,o.autorizacion=3,o.codigo_control=0,o.descuento_general=!1,o.usar_producto=!0)},e.obtenerAlmacenes=function(o){e.almacenes=[];var a=$.grep(e.sucursales,function(e){return e.id==o})[0];e.almacenes=a.almacenes,void 0==e.compra.id&&(e.compra.almacen=1==e.almacenes.length?e.almacenes[0]:null)},e.formatearCodigoControl=function(e){for(var o="",a=0;a<e.length;a++)a%2==0&&(o+=e.substring(a,a+2),e.length-a>2&&(o+="-"));return o},e.obtenerCompras=function(){e.sucursalesUsuario="";for(var o=0;o<e.usuario.sucursalesUsuario.length;o++)e.sucursalesUsuario=e.sucursalesUsuario+e.usuario.sucursalesUsuario[o].sucursal.id,o+1!=e.usuario.sucursalesUsuario.length&&(e.sucursalesUsuario=e.sucursalesUsuario+",");var a=new Date,t=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear();e.filtrarCompras(e.sucursalesUsuario,t,t)},e.filtrarCompras=function(o,a,t,r,n,c,l,p,d,m){r=""==r||void 0==r?0:r,n=null==n||void 0==n?0:n,c=null==c||void 0==c?0:c,l=void 0==l?0:l,m=void 0==m?0:m,p=null==p||void 0==p?0:p,d=$.grep(e.usuario.rolesUsuario,function(o){return o.rol.nombre==e.diccionario.ROL_ADMINISTRADOR}).length>0?""==d||void 0==d?0:d:e.usuario.nombre_usuario,i.start(),a=new Date(e.convertirFecha(a)),t=new Date(e.convertirFecha(t)),s(o,a,t,r,n,c,l,p,d,e.usuario.id,m).then(function(o){e.compras=o,i.stop()})},e.abrirPopupPago=function(o){e.compra=o,e.pago=null,e.abrirPopup(e.idModalPago)},e.cerrarPopupPago=function(){e.cerrarPopup(e.idModalPago)},e.abrirDialogServicios=function(o){e.tipo_edicion=o,e.clase={},e.abrirPopup(e.idModalServicios)},e.cerrarDialogServicios=function(){e.cerrarPopup(e.idModalServicios)},e.abrirDialogPedidos=function(){e.obtenerPedidosEmpresa(),e.abrirPopup(e.idModalPedidos)},e.cerrarDialogPedidos=function(){e.cerrarPopup(e.idModalPedidos)},e.abrirDialogDetallePedidos=function(o){e.pedido=o,e.cerrarDialogPedidos(),e.obtenerAlmacenes(o.sucursal.id),e.compra.proveedor=o.proveedor,e.compra.almacen=o.almacen,e.compra.sucursal=o.sucursal,e.pedido.detallesPedido.forEach(function(o){var a=0;o.producto.inventarios.length>0&&(a=o.producto.inventarios[o.producto.inventarios.length-1].costo_unitario?o.producto.inventarios[o.producto.inventarios.length-1].costo_unitario:0),o.producto.costoanterior=a,e.establecerProductoPedido(o,o.producto,a)}),e.abrirPopup(e.idModalDetallePedidos)},e.guardarDetalleCompraDePedido=function(o){e.compra.generado_por_pedido=!0,e.compra.pedido=e.pedido,o.forEach(function(o){1!=o.eliminado&&e.verificarProducto(o.detalleCompra)}),e.cerrarDialogDetallePedidos()},e.establecerProductoPedido=function(o,a,t){a.tipoProducto=null==a.tipoProducto?{id:a["tipoProducto.id"],nombre:a["tipoProducto.nombre"],nombre_corto:a["tipoProducto.nombre_corto"]}:a.tipoProducto;var r={};e.centrosCosto.forEach(function(e,i,n){"ALM"==e.nombre_corto&&(r=e),i===n.length-1&&(o.detalleCompra={centroCosto:r,producto:a,costo_unitario:t,cantidad:1,descuento:a.descuento,recargo:0,ice:0,excento:0,tipo_descuento:a.descuento>0,tipo_recargo:!1})}),e.cerrarPopup(e.idModalInventario),e.enfocar("cantidad")},e.cerrarDialogDetallePedidos=function(){e.cerrarPopup(e.idModalDetallePedidos)},e.cerrarDialogEliminarPedido=function(){e.cerrarPopup(e.idModalEliminarPedido)},e.abrirDialogEliminarPedido=function(o){e.pedido=o,e.abrirPopup(e.idModalEliminarPedido)},e.cerrarDialogEliminarDetallePedido=function(){e.cerrarPopup(e.idModalEliminarProductoPedido)},e.abrirDialogEliminarDetallePedido=function(o){e.detalle=o,e.abrirPopup(e.idModalEliminarProductoPedido)},e.obtenerPedidosEmpresa=function(){b(e.usuario.id_empresa).then(function(o){e.pedidos=o.pedidos})},e.obtenerServicios=function(){i.start(),_("SERVICIOS_COMPRA",e.usuario.id_empresa).then(function(o){e.datosServicios=o,i.stop()})},e.agregarConceptoEdicion=function(o){o.nombre&&o.nombre_corto&&(-1==e.tipo_edicion.clases.indexOf(o)&&e.tipo_edicion.clases.push(o),e.clase={})},e.modificarConceptoEdicion=function(o){e.clase=o},e.removerConceptoEdicion=function(e){e.eliminado=!0},e.guardarConceptoEdicion=function(o){i.start(),P.update({id_tipo:o.id},o,function(a){u(o.nombre_corto).then(function(a){o=a,i.stop(),e.cerrarDialogServicios(),e.mostrarMensaje("Guardado Exitosamente!")})})},e.realizarPago=function(o,a,t){var r;(r=e.compra.saldo-a)<0?retante=r:r>=0&&(retante=0),i.start(),l.update({id:o},{pago:a,id_usuario_cajero:t,saldoRestante:r},function(o){e.mostrarMensaje(o.mensaje),e.cerrarPopup(e.idModalPago),e.obtenerCompras(),e.imprimirRecibo(o,o.compra,a),i.stop()},function(o){e.mostrarMensaje(o),e.cerrarPopup(e.idModalPago),e.obtenerCompras(),i.stop()})},e.mensaje=function(o){e.accion=o,1==e.accion?e.realizarPago(e.compra.id,pago,e.usuario.id):e.cerrarPopup(e.ModalMensajePago)},e.efectuarPago=function(o){var a=e.usuario.empresa.usar_pago_anticipado;e.pago=o,1==a?o<=e.compra.saldo?e.realizarPago(e.compra.id,o,e.usuario.id):e.abrirPopup(e.ModalMensajePago):o<=e.venta.saldo?e.realizarPago(e.compra.id,o,e.usuario.id):e.mostrarMensaje("El cobro excede el monto a cobrar")},e.imprimirRecibo=function(o,a,t){i.start();var r=new PDFDocument({size:[227,353],margin:10}),n=r.pipe(blobStream());r.moveDown(2),r.font("Helvetica-Bold",8),r.text(e.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),r.moveDown(.4),r.font("Helvetica",7),r.text(a.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),r.moveDown(.4),r.text(a.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),r.moveDown(.4);var c=(null!=a.almacen.sucursal.telefono1?a.almacen.sucursal.telefono1:"")+(null!=a.almacen.sucursal.telefono2?"-"+a.almacen.sucursal.telefono2:"")+(null!=a.almacen.sucursal.telefono3?"-"+a.almacen.sucursal.telefono3:"");r.text("TELF.: "+c,{align:"center"}),r.moveDown(.4),r.text("COCHABAMBA - BOLIVIA",{align:"center"}),r.moveDown(.5),r.font("Helvetica-Bold",8),r.text("PAGO",{align:"center"}),r.font("Helvetica",7),r.moveDown(.4),r.text("------------------------------------",{align:"center"}),r.moveDown(.4),r.moveDown(.4),r.text(a.almacen.sucursal.nota_recibo_correlativo,{align:"center"}),r.moveDown(.4),r.moveDown(.4),r.text("------------------------------------",{align:"center"}),r.moveDown(.4),r.moveDown(.6);var l=new Date;r.text("FECHA : "+l.getDate()+"/"+(l.getMonth()+1)+"/"+l.getFullYear(),{align:"left"}),r.moveDown(.4),r.text("Pagado a : "+e.compra.proveedor.razon_social,{align:"left"}),r.moveDown(.4),r.text("---------------------------------------------------------------------------------",{align:"center"}),r.moveDown(.2),r.text("       CONCEPTO                                   ",{align:"left"}),r.moveDown(.2),r.text("---------------------------------------------------------------------------------",{align:"center"}),r.moveDown(.4),a.fecha=new Date(a.fecha),r.text("Fecha: "+a.fecha.getDate()+"/"+(a.fecha.getMonth()+1)+"/"+a.fecha.getFullYear(),15,210);var s=e.compra.factura;r.text(s,105,210,{width:100}),r.text("Bs "+t+".-",170,210,{width:100}),r.text("--------------",10,230,{align:"right"}),r.moveDown(.3),r.text("TOTAL Bs.              "+t.toFixed(2),{align:"right"}),r.moveDown(.4),r.moveDown(.4),r.text("SON: "+o.pago,{align:"left"}),r.moveDown(.6),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.moveDown(.4),r.text("-------------------------                       -------------------------",{align:"center"}),r.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),r.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),i.stop()},e.establecerCentroCosto=function(o){console.log(o),(o.nombre?o.nombre:o)==e.diccionario.CENTRO_COSTO_ALMACEN?e.busquedaProductoHabilidato=!0:e.busquedaProductoHabilidato=!1},e.crearNuevaCompra=function(){e.obtenerServicios(),e.verDescuento=!1,e.compra=new l({generado_por_pedido:!1,usar_producto:!0,movimiento:{clase:{}},tipo_retencion:!0,id_empresa:e.usuario.id_empresa,id_usuario:e.usuario.id,proveedor:{},id_tipo_pago:e.tiposPago[0].id,tipoPago:e.tiposPago[0],detallesCompra:[],descuento_general:!1,tipo_descuento:!1,codigo_control:0,autorizacion:0,tipo_recargo:!1,descuento:0,recargo:0,ice:0,excento:0}),e.cambiarTipoPago(e.tiposPago[0]),e.usuario.empresa.usar_funciones_erp&&(e.compra.movimiento.clase=e.movimientosIngreso[0]),e.compra.sucursal=1==e.sucursales.length?e.sucursales[0]:null,e.compra.sucursal&&e.obtenerAlmacenes(e.compra.sucursal.id);var o=new Date;e.compra.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),e.abrirPopup(e.idModalWizardCompraEdicion),e.enfocar("nit")},e.verCompra=function(o){e.compra=o,e.abrirPopup(e.idModalWizardCompraVista)},e.cerrarPopupVista=function(){e.cerrarPopup(e.idModalWizardCompraVista)},e.cerrarPopupEdicion=function(){e.ocultarMensajesValidacion(),e.cerrarPopup(e.idModalWizardCompraEdicion)},e.verificarDescuentos=function(e){for(var o=!1,a=0;a<e.length;a++)(e[a].descuento>0||e[a].recargo>0||e[a].ice>0||e[a].excento>0)&&(o=!0);return o},e.dibujarCabeceraImpresionCompra=function(o,a,t,r,i){e.usuario.empresa.imagen.length>100&&o.image(e.usuario.empresa.imagen,60,50,{width:50,height:50}),o.font("Helvetica-Bold",8),o.text(e.usuario.empresa.razon_social.toUpperCase(),60,105),o.font("Helvetica",7),o.text(a.sucursal.nombre.toUpperCase(),60,113),o.text(a.sucursal.direccion.toUpperCase(),60,121);var n=(null!=a.sucursal.telefono1?a.sucursal.telefono1:"")+(null!=a.sucursal.telefono2?"-"+a.sucursal.telefono2:"")+(null!=a.sucursal.telefono3?"-"+a.sucursal.telefono3:"");o.text("TELF.: "+n,60,129),o.text("COCHABAMBA - BOLIVIA",60,137),o.font("Helvetica-Bold",16),o.text("NOTA DE COMPRA",150,50),o.font("Helvetica-Bold",8),o.rect(380,50,190,50).stroke(),o.text("NIT : ",390,60),o.text("FACTURA No : ",390,70),o.text("AUTORIZACI√ìN No : ",390,80),o.text(e.usuario.empresa.nit,500,60),o.text(a.factura,500,70),o.text(a.autorizacion,500,80),o.rect(50,150,540,50).stroke(),o.text("FECHA : ",60,165),o.text("SE√ëOR(ES) : ",60,175),o.text("NIT : ",360,165),o.text(a.fechaTexto,120,165),o.text(a.proveedor.razon_social,120,175),o.text(a.proveedor.nit,400,165),o.rect(50,200,540,25).stroke(),o.rect(50,225,540,449).stroke(),i?e.usuario.empresa.usar_vencimientos?(o.font("Helvetica-Bold",7),o.text("CODIGO",55,210),o.text("CANT.",105,210),o.text("UNID.",135,210),o.text("DETALLE",170,210),o.text("P. UNIT.",280,210),o.text("IMPORTE",315,210),o.text("DESC.",365,210),o.text("REC.",395,210),o.text("ICE",425,210),o.text("EXC.",455,210),o.text("F. VENC.",485,210,{width:50}),o.text("LOTE",525,210),o.text("TOTAL",555,210)):(o.font("Helvetica-Bold",8),o.text("CODIGO",55,210),o.text("CANT.",105,210),o.text("UNID.",135,210),o.text("DETALLE",170,210),o.text("P. UNIT.",300,210),o.text("IMPORTE",335,210),o.text("DESC.",385,210),o.text("REC.",420,210),o.text("ICE",455,210),o.text("EXC.",490,210),o.text("TOTAL",520,210)):(o.font("Helvetica-Bold",8),o.text("CODIGO",55,210),o.text("CANT.",135,210),o.text("UNID.",165,210),e.usuario.empresa.usar_vencimientos?(o.text("DETALLE",210,210),o.text("FECHA VENC.",400,205,{width:50}),o.text("LOTE",450,210)):o.text("DETALLE",210,210),o.text("P.UNIT.",495,210),o.text("TOTAL",540,210)),o.font("Helvetica",6);var c=new Date;o.text("Usuario: "+e.usuario.nombre_usuario+"   Fecha:"+c.getDate()+"/"+(c.getMonth()+1)+"/"+c.getFullYear()+"   Hr:"+c.getHours()+":"+c.getMinutes(),50,750)},e.imprimirCompra=function(o){n(o.id,e.usuario.id_empresa).then(function(a){(o=a.compra).sucursal=a.sucursal,o.numero_literal=a.numero_literal,o.fecha=new Date(o.fecha),o.fechaTexto=o.fecha.getDate()+"/"+(o.fecha.getMonth()+1)+"/"+o.fecha.getFullYear(),o.configuracion=a.configuracion;var t=new PDFDocument({size:[612,792],margin:10}),r=t.pipe(blobStream()),n=240,c=0,l=0,s=1,p=Math.ceil(o.detallesCompra.length/15),d=e.verificarDescuentos(o.detallesCompra);e.dibujarCabeceraImpresionCompra(t,o,s,p,d);n=240;for(var m=0;m<o.detallesCompra.length;m++){if(d)if(e.usuario.empresa.usar_vencimientos){t.font("Helvetica",7);var u=(C=o.detallesCompra[m].producto.codigo.length)<=11?n:C>11&&C<=22?n-4:n-11;o.detallesCompra[m].producto&&t.text(o.detallesCompra[m].producto.codigo,55,u,{width:50}),t.text(o.detallesCompra[m].cantidad,110,n),o.detallesCompra[m].producto&&t.text(o.detallesCompra[m].producto.unidad_medida,135,n),o.detallesCompra[m].producto?t.text(o.detallesCompra[m].producto.nombre,170,n-6,{width:130}):t.text(o.detallesCompra[m].servicio.nombre,170,n-6,{width:130}),t.text(o.detallesCompra[m].costo_unitario.toFixed(2),280,n),t.text(o.detallesCompra[m].importe.toFixed(2),315,n),t.text(o.detallesCompra[m].tipo_descuento?"%":"Bs",365,n-10),t.text(o.detallesCompra[m].descuento.toFixed(2),365,n),t.text(o.detallesCompra[m].tipo_recargo?"%":"Bs",395,n-10),t.text(o.detallesCompra[m].recargo.toFixed(2),395,n),t.text(o.detallesCompra[m].ice.toFixed(2),425,n),t.text(o.detallesCompra[m].excento.toFixed(2),455,n),t.text(o.detallesCompra[m].total.toFixed(2),555,n),o.detallesCompra[m].inventario&&(o.detallesCompra[m].inventario.fecha_vencimiento=new Date(o.detallesCompra[m].inventario.fecha_vencimiento),o.detallesCompra[m].inventario.fechaVencimientoTexto=o.detallesCompra[m].inventario.fecha_vencimiento.getDate()+"/"+(o.detallesCompra[m].inventario.fecha_vencimiento.getMonth()+1)+"/"+o.detallesCompra[m].inventario.fecha_vencimiento.getYear(),t.text(o.detallesCompra[m].inventario.fechaVencimientoTexto,485,n),t.text(o.detallesCompra[m].inventario.lote?o.detallesCompra[m].inventario.lote:"",525,n))}else{t.font("Helvetica",8);u=(C=o.detallesCompra[m].producto.codigo.length)<=11?n:C>11&&C<=22?n-4:n-11;o.detallesCompra[m].producto&&t.text(o.detallesCompra[m].producto.codigo,55,u,{width:70}),t.text(o.detallesCompra[m].cantidad,110,n),o.detallesCompra[m].producto&&t.text(o.detallesCompra[m].producto.unidad_medida,135,n),o.detallesCompra[m].producto?t.text(o.detallesCompra[m].producto.nombre,170,n-6,{width:130}):t.text(o.detallesCompra[m].servicio.nombre,170,n-6,{width:130}),t.text(o.detallesCompra[m].costo_unitario.toFixed(2),300,n),t.text(o.detallesCompra[m].importe.toFixed(2),335,n),t.text(o.detallesCompra[m].tipo_descuento?"%":"Bs",385,n-10),t.text(o.detallesCompra[m].descuento.toFixed(2),385,n),t.text(o.detallesCompra[m].tipo_recargo?"%":"Bs",420,n-10),t.text(o.detallesCompra[m].recargo.toFixed(2),420,n),t.text(o.detallesCompra[m].ice.toFixed(2),455,n),t.text(o.detallesCompra[m].excento.toFixed(2),490,n),t.text(o.detallesCompra[m].total.toFixed(2),520,n)}else{if(t.font("Helvetica",8),o.detallesCompra[m].producto&&t.text(o.detallesCompra[m].producto.codigo,55,n,{width:70}),t.text(o.detallesCompra[m].cantidad,140,n),o.detallesCompra[m].producto&&t.text(o.detallesCompra[m].producto.unidad_medida,160,n),o.detallesCompra[m].producto)u=(C=o.detallesCompra[m].producto.nombre.length)<=45?n:C>45&&C<=90?n-4:n-11;else{var C;u=(C=o.detallesCompra[m].servicio.nombre.length)<=45?n:C>45&&C<=90?n-4:n-11}e.usuario.empresa.usar_vencimientos?(o.detallesCompra[m].inventario&&(o.detallesCompra[m].inventario.fecha_vencimiento=new Date(o.detallesCompra[m].inventario.fecha_vencimiento),o.detallesCompra[m].inventario.fechaVencimientoTexto=o.detallesCompra[m].inventario.fecha_vencimiento.getDate()+"/"+(o.detallesCompra[m].inventario.fecha_vencimiento.getMonth()+1)+"/"+o.detallesCompra[m].inventario.fecha_vencimiento.getFullYear(),t.text(o.detallesCompra[m].inventario.fechaVencimientoTexto,400,n),t.text(o.detallesCompra[m].inventario.lote,460,n)),o.detallesCompra[m].producto?t.text(o.detallesCompra[m].producto.nombre,210,u-11.5,{width:185}):t.text(o.detallesCompra[m].servicio.nombre,210,u-11.5,{width:185})):o.detallesCompra[m].producto?t.text(o.detallesCompra[m].producto.nombre,210,u-11.5,{width:225}):t.text(o.detallesCompra[m].servicio.nombre,210,u-11.5,{width:185}),t.text(o.detallesCompra[m].costo_unitario.toFixed(2),500,n),t.text(o.detallesCompra[m].total.toFixed(2),540,n)}t.rect(50,n-15,540,30).stroke(),n+=30,15==++l&&(c+=l)!=o.detallesCompra.length&&(t.addPage({size:[612,792],margin:10}),n=240,l=0,s+=1,e.dibujarCabeceraImpresionCompra(t,o,s,p,d))}t.font("Helvetica-Bold",8),t.text("TOTAL",455,695),t.font("Helvetica",8),t.text(o.total.toFixed(2),520,695),t.text("SON : "+o.numero_literal,55,695),t.text("C√ìDIGO DE CONTROL : "+o.codigo_control,55,730),t.rect(50,685,540,30).stroke(),t.rect(50,720,400,20).stroke(),t.end(),r.on("finish",function(){var e=r.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),i.stop()})},e.guardarCompra=function(o,a){if(o){e.ocultarMensajesValidacion(),a.proveedor.nit.id&&(a.proveedor=a.proveedor.nit),a.usar_peps=e.usuario.empresa.usar_peps;var t=new Date;if(a.fecha=new Date(e.convertirFecha(a.fechaTexto)),a.fecha.setHours(t.getHours()),a.fecha.setMinutes(t.getMinutes()),a.fecha.setSeconds(t.getSeconds()),i.start(),a.id){a.esModificacion=!0;for(var r=[],n=0;n<a.detallesCompra.length;n++)void 0!=a.detallesCompra[n].cantidad&&void 0!=a.detallesCompra[n].costo_unitario||r.push(a.detallesCompra[n].producto.nombre+" no tiene cantidad o precio");r.length>0?(e.mostrarMensaje(r),e.abrirPopup(e.idModalAlerta),i.stop()):l.update({id:a.id},a,function(o){i.stop(),e.cerrarPopPupEdicion(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()})}else{E(a).then(function(o){e.cerrarPopPupEdicion(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla(),o.compra&&e.imprimirCompra(o.compra)})}}},e.establecerProducto=function(o){o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto;var a=e.detalleCompra.centroCosto;e.precio_inventario,o.inventarios.length>0?e.precio_inventario=o.inventarios.pop().costo_unitario+" Bs":e.precio_inventario="Sin hist√≥rico",e.detalleCompra={centroCosto:a,producto:o,precio_unitario:o.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:o.descuento>0,tipo_recargo:!1},e.cerrarPopup(e.idModalInventario),e.enfocar("cantidad")},e.verDescuentosPedido=function(){e.verDescuento=0==e.verDescuento},e.establecerServicioSeleccionado=function(o){e.establecerServicio(o),e.cerrarDialogServicios()},e.establecerServicio=function(o){o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto;e.detalleCompra.centroCosto;e.detalleCompra={centroCosto:null,servicio:o,precio_unitario:o.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},e.cerrarPopup(e.idModalInventario),e.enfocar("cantidad")},e.cerrarPopPupEdicion=function(){e.cerrarPopup(e.idModalWizardCompraEdicion)},e.generarCompraDePedido=function(e){e.detallesPedido.forEach(function(e,o,a){})},e.EliminarPedido=function(o){x(o.id).then(function(o){e.mostrarMensaje(o.mensaje),e.obtenerPedidosEmpresa(),e.cerrarDialogEliminarPedido()})},e.EliminarPedidoDetalle=function(o){o.eliminado=!0,h(o.id).then(function(o){e.mostrarMensaje(o.mensaje),e.cerrarDialogEliminarDetallePedido()})},e.$on("$routeChangeStart",function(o,a){e.eliminarPopup(e.idModalWizardCompraEdicion),e.eliminarPopup(e.idModalWizardCompraVista),e.eliminarPopup(e.idModalEliminarCompra),e.eliminarPopup(e.idModalPago),e.eliminarPopup(e.idModalServicios),e.eliminarPopup(e.idModalPedidos),e.eliminarPopup(e.idModalDetallePedidos),e.eliminarPopup(e.idModalEliminarPedido),e.eliminarPopup(e.idModalEliminarProductoPedido)}),e.inicio()}]);