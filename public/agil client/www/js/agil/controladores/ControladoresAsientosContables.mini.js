angular.module("agil.controladores").controller("ControladorComprobantes",["$scope","$localStorage","$location","$templateCache","$route","blockUI","CodigoControl","Paginator","ComprobantePaginador","ClasesTipo","ListaCuentasComprobanteContabilidad","ListaAsientosComprobanteContabilidad","NuevoComprobanteContabilidad","ClasesTipo","LibroMayorCuenta","ComprobanteRevisarPaginador","AsignarComprobanteFavorito","Diccionario","ObtenerCambioMoneda","ImprimirComprobante","ComprasComprobante","VerificarUsuarioEmpresa","FieldViewer","DatosComprobante","EliminarComprobante","ListaCambioMoneda","ActualizarCambioMoneda","GuardarComprobantesImportados","ComprobanteTotalGeneralEmpresa","EdicionComprobanteContabilidad",function(o,a,e,r,n,t,i,s,l,c,u,p,m,c,b,d,f,C,v,g,h,M,_,S,I,w,P,D,E,A){t.start(),o.asientoNuevo=!1,o.usuario=JSON.parse(a.usuario),o.IdModalVerificarCuenta="modal-verificar-cuenta",o.IdModalEliminarComprobante="dialog-eliminar-comprobante",o.IdModalCambioMoneda="dialog-cambio-moneda",o.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsComprobante(o.IdModalVerificarCuenta,o.IdModalEliminarComprobante,o.IdModalCambioMoneda),o.buscarAplicacion(o.usuario.aplicacionesUsuario,e.path().substring(1)),o.obtenerColumnasAplicacion()}),o.$on("$routeChangeStart",function(a,e){o.eliminarPopup(o.IdModalVerificarCuenta),o.eliminarPopup(o.IdModalEliminarComprobante),o.eliminarPopup(o.IdModalCambioMoneda)}),o.inicio=function(){o.opcionBimonetario2=!1,o.detalleComprobante={},o.obtenerTiposComprobante(),o.asientos=[],o.cuenta={},o.diccionario=C,console.log(o.diccionario),o.comprobante={asientos:[]},o.sucursales=o.obtenerSucursales(),o.obtenerMeses(),o.ObtenerComprobantes(),o.obtenerGestiones(),o.obtenerAnios("2016"),o.obtenerCambioDolar()},o.obtenerColumnasAplicacion=function(){o.fieldViewer=_({crear:!0,id_empresa:o.usuario.id_empresa,configuracion:{abierto:{value:"Abierto",show:!0},comprobante:{value:"Comp.",show:!0},numero:{value:"Nro",show:!0},fecha:{value:"Fecha",show:!0},sucursal:{value:"Sucursal",show:!0},gloza:{value:"Gloza",show:!0},hora_fecha:{value:"Hora-Fecha",show:!0},importe:{value:"Importe",show:!0},usuario:{value:"Usuario",show:!0}}},o.aplicacion.aplicacion.id),o.fieldViewer.updateObject()},o.obtenerTotalGeneral=function(a){E(o.usuario.id_empresa).then(function(a){o.totalGeneralComprobantes=a.total[0].total})},o.obtenerSucursales=function(){for(var a=[],e=0;e<o.usuario.sucursalesUsuario.length;e++)a.push(o.usuario.sucursalesUsuario[e].sucursal);return console.log(o.usuario.sucursalesUsuario),a},o.ObtenerComprobantes=function(){o.paginator=s(),o.paginator.column="numero",o.paginator.direction="desc",o.paginator.callBack=o.obtenerLista;var a,e,r=new Date,n=o.fechaATexto(r),t=o.fechaATexto((e=-10,(a=r).setDate(a.getDate()+e),a));o.filtro={inicio:t,fin:n,empresa:o.usuario.id_empresa,clasificacion:"",tipo_comprobante:"",monto:""},null!=o.filtro.inicio&&o.paginator.getSearch("",o.filtro)},o.obtenerLista=function(){t.start();var a=o.paginator.filter.inicio,e=o.paginator.filter.fin;o.paginator.filter.inicio=new Date(o.convertirFecha(o.paginator.filter.inicio)),o.paginator.filter.fin=new Date(o.convertirFecha(o.paginator.filter.fin));var r=l(o.paginator);o.totalImporte=0,o.obtenerTotalGeneral(),r.then(function(r){o.paginator.setPages(r.paginas),o.comprobantes=r.comprobantes,o.comprobantes.forEach(function(a){o.totalImporte=o.totalImporte+a.importe},this),o.paginator.filter.inicio=a,o.paginator.filter.fin=e,t.stop()})},o.formatearFecha=function(o){var a=o.split("/");return a[0]+a[1]+a[2]},o.cerrarModalLibrosMayores=function(){o.cerrarPopup(o.IdModalLibroMayor)},o.obtenerTiposComprobante=function(){t.start(),c("TCMC").then(function(a){o.tiposComprobantes=a.clases,t.stop()})},o.obtenerGestiones=function(){t.start(),c("GTN").then(function(a){o.gestiones=a.clases,t.stop()})},o.buscarCuentas=function(a){if(""!=a&&void 0!=a){var e=u(o.usuario.id_empresa,a);return console.log(e),e}},o.DatosCodigoQr=[],o.cont2=1,o.disparo=!0,o.AgregarComprobante=function(){if(null!=o.nuevoComprobante.tipo_comprobante&&null!=o.nuevoComprobante.id_sucursal&&null!=o.nuevoComprobante.fecha){for(var a=0;a<o.nuevoComprobante.asientosContables.length;a++){var e=o.nuevoComprobante.asientosContables[a];0!=e.activo&&""!=e.debe_bs&&(o.nuevoComprobante.importe=Math.round(1e4*(o.nuevoComprobante.importe+e.debe_bs))/1e4)}o.nuevoComprobante.fecha=new Date(o.convertirFecha(o.nuevoComprobante.fecha)),m.save(o.nuevoComprobante,function(a){o.mostrarMensaje(a.mensaje),o.cerrarNuevoComprobante()})}},o.verComprobante=function(a,e){A(a.id).then(function(r){console.log(a),e?o.crearNuevoComprobante(null,null,r.comprobante,!0):a.abierto?(o.obtenerCambioMoneda2(o.fechaATexto(r.comprobante.fecha)),o.crearNuevoComprobante(null,null,r.comprobante)):r.comprobante.id||o.crearNuevoComprobante(null,null,r.comprobante)})},o.ComvertirDebeEnDolar=function(a){a.debe_sus=Math.round(a.debe_bs/o.valorDolar*1e4)/1e4},o.ComvertirHaberEnDolar=function(a){a.haber_sus=Math.round(a.haber_bs/o.valorDolar*1e4)/1e4},o.ComvertirDebeEnBolivianos=function(a){a.debe_bs=Math.round(a.debe_sus*o.valorDolar*1e4)/1e4},o.ComvertirHaberEnBolivianos=function(a){a.haber_bs=Math.round(a.haber_sus*o.valorDolar*1e4)/1e4},o.verificarCuentaAdmin=function(a){a.id_comprobante=o.dato.id,M.save({id_empresa:o.usuario.id_empresa},a,function(a){console.log(a),a.type?(o.mostrarMensaje(a.message),o.dato.abierto?o.dato.abierto=!1:o.dato.abierto=!0,o.cerrarModalVerificarCuenta()):o.mostrarMensaje(a.message)})},o.abrirModalVerificarCuenta=function(a){o.dato=a,o.abrirPopup(o.IdModalVerificarCuenta)},o.cerrarModalVerificarCuenta=function(){o.cerrarPopup(o.IdModalVerificarCuenta)},o.abrirModalEliminarComprobante=function(a){o.dato=a,o.abrirPopup(o.IdModalEliminarComprobante)},o.cerrarModalEliminarComprobante=function(){o.cerrarPopup(o.IdModalEliminarComprobante)},o.eliminarComprobante=function(){I(o.dato.id).then(function(a){o.recargarItemsTabla(),o.mostrarMensaje(a.mensaje),o.cerrarModalEliminarComprobante()})},o.opcionBimonetario=!0,o.VerBimonetario=function(){console.log(o.opcionBimonetario),1!=o.opcionBimonetario?o.opcionBimonetario=!1:o.opcionBimonetario=!0},o.imprimirComprobante=function(a,e){t.start(),S(a.id).then(function(a){a.comprobante.importe_literal=a.importeLiteral,g(a.comprobante,e,o.usuario,o.number_format),t.stop()})},o.buscarCambioMoneda=function(a){w(a).then(function(a){o.cambiosMoneda=a})},o.abrirCambioMoneda=function(){o.filtroMoneda={mes:"a",anio:2018},w(o.filtroMoneda).then(function(a){o.cambiosMoneda=a,o.abrirPopup(o.IdModalCambioMoneda)})},o.cerrarCambioMoneda=function(){o.cerrarPopup(o.IdModalCambioMoneda)},o.obtenerAnios=function(a){var e=(new Date).getFullYear(),r=[];for(a=a||1980;a<=e;)r.push(a++);o.listYears=r},o.EditarCambioMoneda=function(o){o.edit=!0},o.CancelarModificarMoneda=function(){w(o.filtroMoneda).then(function(a){o.cambiosMoneda=a})},o.GuardarCambio=function(a){P(a).then(function(e){o.mostrarMensaje(e.mensaje),a.edit=!1})},o.obtenerCambioDolar=function(){var a=new Date;v(a).then(function(a){console.log(a),a.monedaCambio&&(o.moneda=a.monedaCambio)})},o.subirExcelComprobantes=function(a){t.start();var e,r,n=a.target.files;for(r=n[e=0];e!=n.length;++e){var i=new FileReader;r.name;i.onload=function(a){t.start();var e=a.target.result,r=XLSX.read(e,{type:"binary"}),n=r.SheetNames[0],i=2,s=2,l=r.Sheets[n],c=[],u="",p="",m="";do{s=i;var b={asientosContables:[]};b.tipoCambio=o.moneda,b.tipo_comprobante=void 0!=l["A"+i]&&""!=l["A"+i]?l["A"+i].v.toString():null,m=b.tipo_comprobante,b.codigo=void 0!=l["B"+i]&&""!=l["B"+i]?l["B"+i].v.toString():null,u=b.codigo,b.fecha=void 0!=l["C"+i]&&""!=l["C"+i]?new Date(o.fecha_excel_angular(l["C"+i].v.toString())):null,b.fechaActual=new Date,b.sucursal=void 0!=l["D"+i]&&""!=l["D"+i]?l["D"+i].v.toString():null,p=void 0!=l["C"+i]&&""!=l["C"+i]?o.fecha_excel_angular(l["C"+i].v.toString()):null,b.importe=0,b.gloza=void 0!=l["E"+i]&&""!=l["E"+i]?l["E"+i].v.toString():null;do{var d={};d.numero_cuenta=void 0!=l["F"+s]&&""!=l["F"+s]?l["F"+s].v.toString():null,d.codigo=void 0!=l["G"+s]&&""!=l["G"+s]?l["G"+s].v.toString():null,d.gloza=void 0!=l["H"+s]&&""!=l["H"+s]?l["H"+s].v.toString():null,d.debe_bs=void 0!=l["I"+s]&&""!=l["I"+s]?parseFloat(l["I"+s].v.toString()):null,d.haber_bs=void 0!=l["J"+s]&&""!=l["J"+s]?parseFloat(l["J"+s].v.toString()):null,d.debe_sus=Math.round(d.debe_bs/o.moneda.dolar*1e4)/1e4,d.haber_sus=Math.round(d.haber_bs/o.moneda.dolar*1e4)/1e4,d.eliminado=!1;var f=void 0!=l["B"+s]&&""!=l["B"+s]?parseInt(l["B"+s].v.toString()):null,C=void 0!=l["C"+s]&&""!=l["C"+s]?o.fecha_excel_angular(l["C"+s].v.toString()):null,v=void 0!=l["A"+s]&&""!=l["A"+s]?l["A"+s].v.toString():null;f==u&&C==p&&m==v&&(b.importe+=d.debe_bs,b.asientosContables.push(d));var g=void 0!=l["B"+ ++s]&&""!=l["B"+s]?parseInt(l["B"+s].v.toString()):null}while(g==u);0==c.length?c.push(b):c[c.length-1].codigo==u&&c[c.length-1].tipo_comprobante==m||c.push(b),i=s,console.log(i),0}while(void 0!=l["A"+i]);o.GuardarComprobantesImportacion(c)},i.readAsBinaryString(r)}},o.GuardarComprobantesImportacion=function(a){o.comprobantesParaGuardar=a;var e=[];o.comprobantesParaGuardar.length>0?(o.comprobantesParaGuardar.length>300?(e=o.comprobantesParaGuardar.slice(0,300),o.comprobantesParaGuardar=o.comprobantesParaGuardar.slice(300,o.comprobantesParaGuardar.length)):(e=o.comprobantesParaGuardar,o.comprobantesParaGuardar=[]),D(e,o.usuario.id,o.usuario.id_empresa).then(function(a){t.stop(),o.mostrarMensaje("del codigo "+e[0].codigo+" hasta el codigo "+e[e.length-1].codigo+" "+a.mensaje+" faltan procesar "+o.comprobantesParaGuardar.length+" comprobantes"),o.GuardarComprobantesImportacion(o.comprobantesParaGuardar)})):t.stop()},o.imprimirFiltroExcelCajaCartaOficio=function(){t.start();o.paginator.filter.inicio,o.paginator.filter.fin;o.paginator.filter.inicio=new Date(o.convertirFecha(o.paginator.filter.inicio)),o.paginator.filter.fin=new Date(o.convertirFecha(o.paginator.filter.fin));var a=Object.assign({},o.paginator);a.itemsPerPage=0,l(a).then(function(a){o.ReporteComprovante=a.comprobantes;(a=[]).push(["N°","COMPROBANTE","NUMERO"]);for(var e=0,r=0;r<o.ReporteComprovante.length;r++)o.reporte=o.ReporteComprovante[r],columns=[],e+=1,columns.push(e),columns.push(o.reporte.tipoComprobante.nombre),columns.push(o.reporte.numero),a.push(columns);var n="SheetJS",i=new Workbook,s=sheet_from_array_of_arrays(a);i.SheetNames.push(n),i.Sheets[n]=s;var l=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"VENTAS-MENSUALES.xlsx"),t.stop()})},o.inicio()}]);