angular.module("agil.controladores").controller("ControladorClientes",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","$timeout","ClientesPaginador","Cliente","Clientes","Empresas","ClientesEmpresa","uiGmapGoogleMapApi","$cordovaGeolocation","DatoCodigoSiguienteClienteEmpresa","DestinosCliente","RazonesSocialesCliente","ClasesTipoEmpresa","Diccionario","Tipos","ClasesTipo","VerificarUsuarioEmpresa",function(e,o,t,i,a,n,c,s,l,u,p,d,h,f,m,g,v,C,b,_,P,E,x){c.start(),e.usuario=JSON.parse(t.usuario),e.idModalConceptoEdicionCorrelativos="dialog-conceptos-correlativos",e.IdModalVerificarCuenta="modal-verificar-cuenta",e.inicio=function(){e.diccionario=_,e.obtenerEmpresas(),e.obtenerClientes(),e.obtenerDestinos(),e.obtenerTiposPrecio(),f.then(function(o){console.log(o),e.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},e.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE}})},e.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),ejecutarScriptsCliente("modal-wizard-cliente","modal-wizard-cliente-vista","dialog-eliminar-cliente","modal-wizard-container-cliente-edicion","modal-wizard-container-cliente-vista",e.idModalConceptoEdicionCorrelativos,e.IdModalVerificarCuenta),e.buscarAplicacion(e.usuario.aplicacionesUsuario,i.path().substring(1)),c.stop()}),e.obtenerCorrelativoCliente=function(){c.start(),b("correlativo_clientes",e.usuario.id_empresa).then(function(o){o.clases.length>1?o.clases.sort(function(e,o){return e.correlativo=e.nombre_corto.split("-")[0],e.correlativo_maximo=e.nombre_corto.split("-")[1],o.correlativo=o.nombre_corto.split("-")[0],o.correlativo_maximo=o.nombre_corto.split("-")[1],e.correlativo-o.correlativo}):1==o.clases.length&&(o.clases[0].correlativo=o.clases[0].nombre_corto.split("-")[0],o.clases[0].correlativo_maximo=o.clases[0].nombre_corto.split("-")[1]),e.correlativosClientes=o,c.stop()})},e.cargarCodigo=function(e){e.codigo=e.correlativo.correlativo},e.obtenerClientes=function(){e.abs=o.Math.abs,e.itemsPorPagina=10,e.buscarClientes(1,e.itemsPorPagina,"")},e.verificarPulso=function(o,t){13===o.keyCode&&e.buscarClientes(1,e.itemsPorPagina,t)},e.buscarClientes=function(o,t,i){c.start(),e.itemsPorPagina=t,""==i||null==i?i=0:e.textoBusqueda=i,e.paginaActual=o,l(e.usuario.id_empresa,o,t,i).then(function(o){e.paginas=[];for(var t=1;t<=o.paginas;t++)e.paginas.push(t);e.clientes=o.clientes,c.stop()})},e.abrirPopupCliente=function(o){e.mostrarMap=!1,e.cliente=o,e.map={center:{latitude:e.cliente.latitud,longitude:e.cliente.longitud},zoom:17,bounds:{northeast:{latitude:e.cliente.latitud,longitude:e.cliente.longitud}}},e.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.SATELLITE},e.coordsUpdates=0,e.dynamicMoveCtr=0,e.marker={id:0,coords:{latitude:e.cliente.latitud,longitude:e.cliente.longitud},options:{draggable:!0},events:{dragend:function(o,t,i){e.cliente.latitud=o.getPosition().lat(),e.cliente.longitud=o.getPosition().lng(),e.marker.options={draggable:!0,labelAnchor:"100 0",labelClass:"marker-labels"}}}},e.abrirPopup("modal-wizard-cliente")},e.mostrarMapa=function(){e.mostrarMap=!0,s(function(){e.$apply(function(){google.maps.event.trigger(e.map,"resize")})},2e3)},e.crearNuevoCliente=function(){e.obtenerCorrelativoCliente(),e.steps=[{cabeza:"cabeza-datos-cli",cuerpo:"cuerpo-datos-cli"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"}],console.log(e.steps),g(e.usuario.id_empresa).then(function(o){e.ultimo_codigo=o.ultimo_codigo?"CLI"+o.ultimo_codigo:0;var i=JSON.parse(t.usuario),a=new u({id_empresa:i.id_empresa,latitud:-17.403800007775388,longitud:-66.11349012184144,clientes_razon:[],cliente_destinos:[]});a.codigo="CLI"+((o.ultimo_codigo?o.ultimo_codigo:0)+1),e.abrirPopupCliente(a)})},e.verCliente=function(o){e.cliente=o,o.fecha1=new Date(o.fecha1),o.fecha2=new Date(o.fecha2),e.cliente.fechatexto1=o.fecha1.getDate()+"/"+(o.fecha1.getMonth()+1)+"/"+o.fecha1.getFullYear(),e.cliente.fechatexto2=o.fecha2.getDate()+"/"+(o.fecha2.getMonth()+1)+"/"+o.fecha2.getFullYear(),e.abrirPopup("modal-wizard-cliente-vista")},e.cerrarPopPupVista=function(){e.cerrarPopup("modal-wizard-cliente-vista")},e.cerrarPopPupNuevoCliente=function(){e.cerrarPopup("modal-wizard-cliente")},e.modificarCliente=function(o){o.fecha1&&(o.fecha1=new Date(o.fecha1),o.fechatexto1=o.fecha1.getDate()+"/"+(o.fecha1.getMonth()+1)+"/"+o.fecha1.getFullYear()),o.fecha2&&(o.fecha2=new Date(o.fecha2),o.fechatexto2=o.fecha2.getDate()+"/"+(o.fecha2.getMonth()+1)+"/"+o.fecha2.getFullYear()),e.abrirPopupCliente(o)},e.verCliente=function(o){e.cliente=o,o.fecha1=new Date(o.fecha1),o.fecha2=new Date(o.fecha2),e.cliente.fechatexto1=o.fecha1.getDate()+"/"+(o.fecha1.getMonth()+1)+"/"+o.fecha1.getFullYear(),e.cliente.fechatexto2=o.fecha2.getDate()+"/"+(o.fecha2.getMonth()+1)+"/"+o.fecha2.getFullYear(),e.abrirPopup("modal-wizard-cliente-vista")},e.cerrarPopPupVista=function(){e.cerrarPopup("modal-wizard-cliente-vista")},e.cerrarPopPupNuevoCliente=function(){e.cerrarPopup("modal-wizard-cliente")},e.modificarCliente=function(o){o.fecha1&&(o.fecha1=new Date(o.fecha1),o.fechatexto1=o.fecha1.getDate()+"/"+(o.fecha1.getMonth()+1)+"/"+o.fecha1.getFullYear()),o.fecha2&&(o.fecha2=new Date(o.fecha2),o.fechatexto2=o.fecha2.getDate()+"/"+(o.fecha2.getMonth()+1)+"/"+o.fecha2.getFullYear()),e.abrirPopupCliente(o)},e.mostrarConfirmacionEliminacion=function(o){e.cliente=new u(o),e.abrirPopup("dialog-eliminar-cliente")},e.cerrarConfirmacionEliminacion=function(){e.cerrarPopup("dialog-eliminar-cliente")},e.eliminarCliente=function(o){c.start(),e.cerrarConfirmacionEliminacion(),o.$delete(),e.mostrarMensaje("Eliminado exitosamente!"),e.recargarItemsTabla(),c.stop()},e.saveForm=function(o,t){if("Siguiente"!=$("#siguiente").text().trim()){c.start();var i=[];[document.getElementById("doc-nit").files[0],document.getElementById("doc-funda").files[0],document.getElementById("doc-licencia").files[0],document.getElementById("doc-ci").files[0],document.getElementById("doc-seguro-social").files[0]].forEach(function(t,a,n){t&&i.push(t),a==n.length-1&&(i.length>0?i.forEach(function(t,i,a){r=new FileReader,t?(r.onloadend=function(n){t.nombre=t.name,t.data=n.target.result,i===a.length-1&&(o.fecha1=null,o.fechatexto1&&(o.fecha1=new Date(e.convertirFecha(o.fechatexto1))),o.fecha2=null,o.fechatexto2&&(o.fecha2=new Date(e.convertirFecha(o.fechatexto2))),o.id?u.update({idCliente:o.id},o,function(o){c.stop(),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()}):o.$save(function(o){c.stop(),e.cliente=new u({}),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()},function(o){c.stop(),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()}))},r.readAsBinaryString(t)):i===a.length-1&&(o.fecha1=null,o.fechatexto1&&(o.fecha1=new Date(e.convertirFecha(o.fechatexto1))),o.fecha2=null,o.fechatexto2&&(o.fecha2=new Date(e.convertirFecha(o.fechatexto2))),o.id?u.update({idCliente:o.id},o,function(o){c.stop(),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()}):o.$save(function(o){c.stop(),e.cliente=new u({}),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()},function(o){c.stop(),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()}))}):(o.fecha1=null,o.fechatexto1&&(o.fecha1=new Date(e.convertirFecha(o.fechatexto1))),o.fecha2=null,o.fechatexto2&&(o.fecha2=new Date(e.convertirFecha(o.fechatexto2))),o.id?u.update({idCliente:o.id},o,function(o){c.stop(),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()}):o.$save(function(o){c.stop(),e.cliente=new u({}),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()},function(o){c.stop(),e.cerrarPopPupNuevoCliente(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})))})}if(!e.usuario.usar_creditos){var a=$("#credito").attr("class");console.log(a),"ng-hide active"==a&&$("#siguiente").click()}if(!e.usuario.usar_razon_social){a=$("#razonsocial").attr("class");console.log(a),"ng-hide active"==a&&$("#siguiente").click()}if(!e.usuario.destinos){a=$("#destinos").attr("class");console.log(a),"ng-hide active"==a&&$("#siguiente").click()}},e.regresarwizard=function(){if(!e.usuario.destinos){var o=$("#destinos").attr("class");console.log(o),"ng-hide complete"==o&&$("#anterior").click()}if(!e.usuario.usar_razon_social){o=$("#razonsocial").attr("class");console.log(o),"ng-hide complete"==o&&$("#anterior").click()}if(!e.usuario.usar_creditos){o=$("#credito").attr("class");console.log(o),"ng-hide complete"==o&&$("#anterior").click()}},e.obtenerEmpresas=function(){c.start(),d().then(function(o){e.empresas=o,c.stop()})},e.agregarClienteRazon=function(o){o.nit&&o.razon_social&&(-1==e.cliente.clientes_razon.indexOf(o)&&e.cliente.clientes_razon.push(o),e.cliente_razon={})},e.modificarClienteRazon=function(o){e.cliente_razon=o},e.removerClienteRazon=function(e){e.eliminado=!0},e.obtenerDestinos=function(){v(e.usuario.id_empresa).then(function(o){e.destinos=o})},e.agregarDestino=function(o){if(o.id){var t={id_destino:o.id,destino:o};-1==e.cliente.cliente_destinos.indexOf(t)&&e.cliente.cliente_destinos.push(t),e.dato_destino={}}},e.removerDestino=function(e){e.eliminado=!0},e.generarExcelComprobacionDatosClientes=function(o,t){e.obtenerClientes();for(var i=[["N°","CODIGO","CLIENTE","NIT PRINCIPAL","RAZÓN SOCIAL PRINCIPAL","DIRECCION","TELEFONO UNO","TELEFONO DOS","TELEFONO TRES","UBIC. GEO.","RUBRO","CATEGORIA","FECHA IMP. 1","FECHA IMP. 2","TEXTO 1","TEXTO 2","RAZONES CLIENTE","NIT -RAZON","CODIGO SAP","DESTINOS","DIRECCION DESTINO"]],a=0;a<e.clientes.length;a++){var n=[];e.clientes[a].clientes_razon.length>0?e.clientes[a].clientes_razon.map(function(o,t){e.clientes[a].cliente_destinos.length>0?e.clientes[a].cliente_destinos.map(function(t){(n=[]).push(a+1),n.push(e.clientes[a].codigo),n.push(e.clientes[a].contacto),n.push(e.clientes[a].nit),n.push(e.clientes[a].razon_social),n.push(e.clientes[a].direccion),n.push(e.clientes[a].telefono1),n.push(e.clientes[a].telefono2),n.push(e.clientes[a].telefono3),n.push(e.clientes[a].ubicacion_geografica),n.push(e.clientes[a].rubro),n.push(e.clientes[a].categoria),n.push(e.fechaATexto(e.clientes[a].fecha1)),n.push(e.fechaATexto(e.clientes[a].fecha2)),n.push(e.clientes[a].texto2),n.push(e.clientes[a].texto2),n.push(o.razon_social),n.push(o.nit),n.push(o.codigo_sap),n.push(t.destino.destino),n.push(t.destino.direccion),i.push(n)}):((n=[]).push(a+1),n.push(e.clientes[a].codigo),n.push(e.clientes[a].contacto),n.push(e.clientes[a].nit),n.push(e.clientes[a].razon_social),n.push(e.clientes[a].direccion),n.push(e.clientes[a].telefono1),n.push(e.clientes[a].telefono2),n.push(e.clientes[a].telefono3),n.push(e.clientes[a].ubicacion_geografica),n.push(e.clientes[a].rubro),n.push(e.clientes[a].categoria),n.push(e.fechaATexto(e.clientes[a].fecha1)),n.push(e.fechaATexto(e.clientes[a].fecha2)),n.push(e.clientes[a].texto2),n.push(e.clientes[a].texto2),n.push(o.razon_social),n.push(o.nit),n.push(o.codigo_sap),n.push("sin dato"),n.push("sin dato"),i.push(n))}):e.clientes[a].cliente_destinos.length>0?e.clientes[a].cliente_destinos.map(function(o){(n=[]).push(a+1),n.push(e.clientes[a].codigo),n.push(e.clientes[a].contacto),n.push(e.clientes[a].nit),n.push(e.clientes[a].razon_social),n.push(e.clientes[a].direccion),n.push(e.clientes[a].telefono1),n.push(e.clientes[a].telefono2),n.push(e.clientes[a].telefono3),n.push(e.clientes[a].ubicacion_geografica),n.push(e.clientes[a].rubro),n.push(e.clientes[a].categoria),n.push(e.fechaATexto(e.clientes[a].fecha1)),n.push(e.fechaATexto(e.clientes[a].fecha2)),n.push(e.clientes[a].texto2),n.push(e.clientes[a].texto2),n.push("sin dato"),n.push("sin dato"),n.push("sin dato"),n.push(o.destino.destino),n.push(o.destino.direccion),i.push(n)}):((n=[]).push(a+1),n.push(e.clientes[a].codigo),n.push(e.clientes[a].contacto),n.push(e.clientes[a].nit),n.push(e.clientes[a].razon_social),n.push(e.clientes[a].direccion),n.push(e.clientes[a].telefono1),n.push(e.clientes[a].telefono2),n.push(e.clientes[a].telefono3),n.push(e.clientes[a].ubicacion_geografica),n.push(e.clientes[a].rubro),n.push(e.clientes[a].categoria),n.push(e.fechaATexto(e.clientes[a].fecha1)),n.push(e.fechaATexto(e.clientes[a].fecha2)),n.push(e.clientes[a].texto2),n.push(e.clientes[a].texto2),n.push("sin dato"),n.push("sin dato"),n.push("sin dato"),n.push("sin dato"),n.push("sin dato"),i.push(n))}var r="SheetJS",s=new Workbook,l=sheet_from_array_of_arrays(i);s.SheetNames.push(r),s.Sheets[r]=l;var u=XLSX.write(s,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(u)],{type:"application/octet-stream"}),"COMPROBACION DATOS CLIENTES RAZONES DESTINOS.xlsx"),c.stop()},e.subirExcelClientes=function(o){var t,i,a=o.target.files;for(i=a[t=0];t!=a.length;++t){var n=new FileReader;i.name;n.onload=function(o){c.start();var t=o.target.result,i=XLSX.read(t,{type:"binary"}),a=i.SheetNames[0],n=2,r=i.Sheets[a],s=[];do{var l={};l.codigo=void 0!=r["A"+n]&&""!=r["A"+n]?r["A"+n].v.toString():null,l.razon_social=void 0!=r["B"+n]&&""!=r["B"+n]?r["B"+n].v.toString():null,l.nit=void 0!=r["C"+n]&&""!=r["C"+n]?r["C"+n].v.toString():null,l.direccion=void 0!=r["D"+n]&&""!=r["D"+n]?r["D"+n].v.toString():null,l.telefono1=void 0!=r["E"+n]&&""!=r["E"+n]?r["E"+n].v.toString():null,l.telefono2=void 0!=r["F"+n]&&""!=r["F"+n]?r["F"+n].v.toString():null,l.telefono3=void 0!=r["G"+n]&&""!=r["G"+n]?r["G"+n].v.toString():null,l.contacto=void 0!=r["H"+n]&&""!=r["H"+n]?r["H"+n].v.toString():null,l.ubicacion_geografica=void 0!=r["I"+n]&&""!=r["I"+n]?r["I"+n].v.toString():null,l.rubro=void 0!=r["J"+n]&&""!=r["J"+n]?r["J"+n].v.toString():null,l.categoria=void 0!=r["K"+n]&&""!=r["K"+n]?r["K"+n].v.toString():null,l.fecha1=void 0!=r["L"+n]&&""!=r["L"+n]?new Date(e.convertirFecha(r["L"+n].v.toString())):null,l.fecha2=void 0!=r["M"+n]&&""!=r["M"+n]?new Date(e.convertirFecha(r["M"+n].v.toString())):null,l.texto1=void 0!=r["N"+n]&&""!=r["N"+n]?r["N"+n].v.toString():null,l.texto2=void 0!=r["O"+n]&&""!=r["O"+n]?r["O"+n].v.toString():null,l.tipoPrecioVenta=void 0!=r["P"+n]&&""!=r["P"+n]?r["P"+n].v.toString():null,null!=l.tipoPrecioVenta&&(l.tipoPrecioVenta=e.tiposPrecios.clases.find(function(e){return l.tipoPrecioVenta.toUpperCase()===e.nombre})),s.push(l),n++,0}while(void 0!=r["A"+n]);e.guardarClientes(s),c.stop()},n.readAsBinaryString(i)}},e.subirExcelRazonesSocialesCliente=function(o){var t,i,a=o.target.files;for(i=a[t=0];t!=a.length;++t){var n=new FileReader;i.name;n.onload=function(o){c.start();var t=o.target.result,i=XLSX.read(t,{type:"binary"}),a=i.SheetNames[0],n=2,r=i.Sheets[a],s=[];do{var l={};l.codigo=void 0!=r["A"+n]&&""!=r["A"+n]?r["A"+n].v.toString():null,l.razon_social=void 0!=r["B"+n]&&""!=r["B"+n]?r["B"+n].v.toString():null,l.nit=void 0!=r["C"+n]&&""!=r["C"+n]?r["C"+n].v.toString():null,l.codigo_sap=void 0!=r["D"+n]&&""!=r["D"+n]?r["D"+n].v.toString():null,s.push(l),n++,0}while(void 0!=r["A"+n]);e.guardarRazonesSocialesClientes(s),c.stop()},n.readAsBinaryString(i)}},e.guardarRazonesSocialesClientes=function(o){C(o,e.usuario.id_empresa).then(function(o){c.stop(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()})},e.guardarClientes=function(o){new h({clientes:o,id_empresa:e.usuario.id_empresa}).$save(function(o){c.stop(),e.mostrarMensaje(o.mensaje),e.recargarItemsTabla()},function(o){c.stop(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})},e.abrirModalConceptoEdicionCorrelativos=function(o){c.start(),b("correlativo_clientes",e.usuario.id_empresa).then(function(o){o.clases.length>1?(o.clases.sort(function(e,o){return e.correlativo=e.nombre_corto.split("-")[0],e.correlativo_maximo=e.nombre_corto.split("-")[1],o.correlativo=o.nombre_corto.split("-")[0],o.correlativo_maximo=o.nombre_corto.split("-")[1],e.correlativo-o.correlativo}),e.minimo=parseInt(o.clases[o.clases.length-1].correlativo_maximo)+1):1==o.clases.length&&(o.clases[0].correlativo=o.clases[0].nombre_corto.split("-")[0],o.clases[0].correlativo_maximo=o.clases[0].nombre_corto.split("-")[1],e.minimo=parseInt(o.clases[0].correlativo_maximo)+1),e.tipo_edicion=o,e.clase={},e.abrirPopup(e.idModalConceptoEdicionCorrelativos),c.stop()})},e.cerrarModalConceptoEdicionCorrelativos=function(){e.cerrarPopup(e.idModalConceptoEdicionCorrelativos)},e.agregarConceptoEdicion=function(o){o.nombre_corto=o.correlativo+"-"+o.correlativo_maximo,-1==e.tipo_edicion.clases.indexOf(o)&&(e.tipo_edicion.clases.length,e.tipo_edicion.clases.push(o),e.minimo=o.correlativo_maximo+1),e.clase={}},e.modificarConceptoEdicion=function(o){o.correlativo=parseInt(o.correlativo),o.correlativo_maximo=parseInt(o.correlativo_maximo),e.clase=o},e.removerConceptoEdicion=function(e){e.eliminado=!0},e.guardarConceptoEdicion=function(o){c.start(),P.update({id_tipo:o.id},o,function(t){E(o.nombre_corto).then(function(t){o=t,c.stop(),e.cerrarModalConceptoEdicionCorrelativos(),e.mostrarMensaje("Guardado Exitosamente!")})})},e.abrirModalVerificarCuenta=function(o,t){e.dato=o,e.tipoDatosPermiso=t,e.abrirPopup(e.IdModalVerificarCuenta)},e.cerrarModalVerificarCuenta=function(){e.cerrarPopup(e.IdModalVerificarCuenta)},e.verificarCuentaAdmin=function(o){x.save({id_empresa:e.usuario.id_empresa},o,function(o){o.type?(e.mostrarMensaje(o.message),"correlativo"==e.tipoDatosPermiso&&e.modificarConceptoEdicion(e.dato),e.cerrarModalVerificarCuenta()):e.mostrarMensaje(o.message)})},e.obtenerTiposPrecio=function(){c.start(),b("T_PAGO_PRODUCTO",e.usuario.id_empresa).then(function(o){e.tiposPrecios=o,c.stop()})},e.$on("$routeChangeStart",function(o,t){e.eliminarPopup("modal-wizard-cliente"),e.eliminarPopup("modal-wizard-cliente-vista"),e.eliminarPopup("dialog-eliminar-cliente"),e.eliminarPopup(e.idModalConceptoEdicionCorrelativos),e.eliminarPopup(e.IdModalVerificarCuenta)}),e.inicio()}]);