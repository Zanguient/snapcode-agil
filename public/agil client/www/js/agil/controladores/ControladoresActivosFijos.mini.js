angular.module("agil.controladores").controller("ControladorActivosFijos",["$scope","$timeout","Paginator","$localStorage","$location","blockUI","ListaSubGruposProductoEmpresa","FieldViewer","GuardarConfiguracionActivosFijos","ObtenerConfiguracionActivosFijos","ActivosFijosEmpresa","RevaluarActivo",function(a,o,i,t,c,e,r,n,s,u,l,d){a.idModalconfiguracionActivos="modal-configuracion-activos",a.idModalRevaluarActivo="modal-revaluar-activos",a.usuarioSesion=JSON.parse(t.usuario),a.$on("$viewContentLoaded",function(){resaltarPestaña(c.path().substring(1)),ejecutarScriptsActivos(a.idModalconfiguracionActivos,a.idModalRevaluarActivo),a.buscarAplicacion(a.usuarioSesion.aplicacionesUsuario,c.path().substring(1)),a.obtenerColumnasAplicacion()}),a.$on("$routeChangeStart",function(o,i){a.eliminarPopup(a.idModalconfiguracionActivos),a.eliminarPopup(a.idModalRevaluarActivo)}),a.calcularTotales=function(){a.totalesActivosFijos={totalValores:0,totalActualizacion:0,totalActualizado:0,totalDepreciacionAcumulada:0,totalActualizacionDepreciacionAcumulada:0,totalDepreciacionActualizada:0,totalDepreciacionMensual:0,totalDepreciacion:0,totalNeto:0},a.activosFijos.forEach(function(o){a.totalesActivosFijos.totalValores+=o.valores[0].valor,a.totalesActivosFijos.totalActualizacion+=o.valores[0].incremento_actualizacion,a.totalesActivosFijos.totalActualizado+=o.valores[0].valor_actualizado,a.totalesActivosFijos.totalDepreciacionAcumulada+=o.valores[0].depreciacion_acumulada,a.totalesActivosFijos.totalActualizacionDepreciacionAcumulada+=o.valores[0].incremento_actualizacion_depreciacion_acumulada,a.totalesActivosFijos.totalDepreciacionActualizada+=o.valores[0].depreciacion_acumulada_actualizada,a.totalesActivosFijos.totalDepreciacionMensual+=o.valores[0].depreciacion,a.totalesActivosFijos.totalDepreciacion+=o.valores[0].total_depreciacion_acumulada,a.totalesActivosFijos.totalNeto+=o.valores[0].valor_neto})},a.factorConfiguracion=Array.apply(null,new Array(20)).map(function(a,o){return{id:5*(o+1)}}),a.abrirConfiguracionActivos=function(){a.abrirPopup(a.idModalconfiguracionActivos)},a.cerrarConfiguracionActivos=function(){a.cerrarPopup(a.idModalconfiguracionActivos)},a.inicio=function(){a.configuracionActivosFijos=[],a.obtenerConfiguracionActivos(),a.filtro={mes:{id:(new Date).getMonth()+1},anio:{id:(new Date).getFullYear()},subgrupo:0,codigo:0,activo:0,vida_util:0},a.obtenerSubGruposProductosEmpresaUsuario(),a.obtenerPaginadorActivos(),a.listaEstados=[{id:1,nombre:"Activo"},{id:2,nombre:"Inactivo"}],a.ConteoBusqueda=0},a.agregarDetalleConfiguracion=function(o){if(a.configuracionActivosFijos.some(function(a){return a.subgrupo.id===o.subgrupo.id}))a.mostrarMensaje("Ya existe en la lista de configuración.");else{var i={subgrupo:o.subgrupo,vida_util:o.vida_util,factor:o.factor};a.configuracionActivosFijos.push(i)}},a.obtenerColumnasAplicacion=function(){e.start(),a.fieldViewer=n({crear:!0,id_empresa:a.usuarioSesion.empresa.id,configuracion:{numero:{value:"Número",show:!0},activo:{value:"Activo",show:!0},codigo:{value:"Código",show:!0},cantidad:{value:"Cantidad",show:!0},mes:{value:"Mes",show:!0},anio:{value:"Año",show:!0},fecha_ingreso:{value:"Fecha ingreso",show:!0},valor:{value:"Valor",show:!0},actualizacion:{value:"Actualización",show:!0},valor_actualizado:{value:"Valor actualizado",show:!0},depreciacion_acumulada:{value:"Depreciación acumulada",show:!0},actualizacion_depreciacion_acumulada:{value:"Actualización de la depreciación acumulada",show:!0},depreciacion_acumulada_actualizada:{value:"Depreciación acumulada actualizada",show:!0},depreciacion_mes:{value:"Depreciación mensual",show:!0},total_depreciacion:{value:"Total depreciación",show:!0},valor_neto:{value:"Valor neto",show:!0},vida_util:{value:"Vida útil",show:!0},vida_restante:{value:"Vida restante (Meses)",show:!0},revaluado:{value:"Revaluado",show:!0}}},a.aplicacion.aplicacion.id),a.fieldViewer.updateObject(),e.stop()},a.obtenerSubGruposProductosEmpresaUsuario=function(){e.start(),r(a.usuarioSesion.id_empresa,a.usuarioSesion.id).then(function(o){e.stop(),o.length>0?a.subGruposProducto=o:(a.subGruposProducto=[],a.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(o){a.subGruposProducto=[];var i=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.data&&null!==o.data&&""!==o.data?o.data:"Error: Se perdio la conexión.";a.mostrarMensaje(i),e.stop()})},a.obtenerConfiguracionActivos=function(){e.start(),u(a.usuarioSesion.id_empresa,a.usuarioSesion.id).then(function(o){o.hasErr?(a.configuracionActivosFijos=[],a.mostrarMensaje(o.mensaje)):a.configuracionActivosFijos=o.configuracion,e.stop()}).catch(function(o){e.stop();var i=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";a.mostrarMensaje(i)})},a.obtenerPaginadorActivos=function(){a.paginator=i(),a.paginator.column="nombre",a.paginator.direccion="asc",a.paginator.callBack=a.buscarActivos,a.paginator.getSearch("",null,null)},a.filtrarFiltro=function(o,i,t){if(void 0!==t)for(var c in o)0==o[c]&&(o[c]="");else for(var c in o)""!==o[c]&&null!==o[c]&&void 0!==o[c]||(o[c]=0);if(void 0!==i&&i)return o;a.buscarActivos()},a.buscarActivos=function(){e.start(),a.filtro=a.filtrarFiltro(a.filtro,!0),a.paginator.filter=a.filtro,l(a.usuarioSesion.id_empresa,a.paginator).then(function(i){if(i.hasErr)a.mostrarMensaje(i.mensaje);else{if(i.activos.length>0){a.activosFijos=i.activos,a.paginator.setPages(i.paginas);var t=-1;a.configuracionActivosFijos.length>0&&a.activosFijos.forEach(function(o,i){if(a.configuracionActivosFijos.some(function(a,i){return t=i,a.subgrupo.id==o.activo.subgrupo.id})){var c=(new Date).getMonth()-new Date(o.fecha_ingreso).getMonth()+12*((new Date).getFullYear()-new Date(o.fecha_ingreso).getFullYear());a.activosFijos[i].vida_util=a.configuracionActivosFijos[t].vida_util,a.activosFijos[i].vida_restante=a.configuracionActivosFijos[t].vida_util-c}}),a.calcularTotales()}else{if(a.ConteoBusqueda<1)return a.ConteoBusqueda+=1,void o(function(){a.buscarActivos()},5e3);a.activosFijos=i.activos,a.totalesActivosFijos={totalValores:0,totalActualizacion:0,totalActualizado:0,totalDepreciacionAcumulada:0,totalActualizacionDepreciacionAcumulada:0,totalDepreciacionActualizada:0,totalDepreciacionMensual:0,totalDepreciacion:0,totalNeto:0}}e.stop()}e.stop(),a.filtrarFiltro(a.filtro,!0,!0)}).catch(function(o){e.stop();var i=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";a.mostrarMensaje(i)})},a.revaluarActivo=function(){e.start(),d(a.activo,a.usuarioSesion.id_empresa,a.usuarioSesion.id).then(function(o){o.hasErr?a.mostrarMensaje(o.mensaje):a.cerrarDialogRevaluarActivo(),e.stop()}).catch(function(o){e.stop();var i=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(i)})},a.guardarConfiguracionActivos=function(){(e.start(),a.configuracionActivosFijos.length>0)?s(a.usuarioSesion.id_empresa,a.usuarioSesion.id,a.configuracionActivosFijos).then(function(o){o.hasErr?a.mostrarMensaje(o.mensaje):(a.mostrarMensaje(o.mensaje),a.cerrarConfiguracionActivos()),e.stop()}).catch(function(o){e.stop();var i=void 0!==o.stack&&null!==o.stack&&""!==o.stack?o.stack:null!==o.data&&void 0!==o.data&""!==o.data?o.data:"Error: se perdio la conexión con el servidor.";a.mostrarMensaje(i)}):a.mostrarMensaje("No hay cambios para guardar.")},a.abrirDialogRevaluarActivo=function(o){void 0!==o&&null!==o?(a.activo=o,a.abrirPopup(a.idModalRevaluarActivo)):a.mostrarMensaje("La información del activo es incorrecta.")},a.cerrarDialogRevaluarActivo=function(){a.activo={},a.cerrarPopup(a.idModalRevaluarActivo)},a.inicio()}]);