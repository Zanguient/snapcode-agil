angular.module("agil.controladores").controller("ControladorVentas",["$scope","$filter","$localStorage","$location","$templateCache","$route","blockUI","$timeout","$window","InventarioPaginador","Venta","Ventas","VentasProductos","detalle","detalleEmpresa","Clientes","ClientesNit","ProductosNombre","ClasesTipo","VentasContado","VentasCredito","PagosVenta","DatosVenta","VentaEmpresaDatos","ProductosPanel","ListaProductosEmpresaUsuario","ListaInventariosProducto","Paginator","socket","ConfiguracionVentaVistaDatos","ConfiguracionVentaVista","ListaGruposProductoEmpresa","ReporteVentasMensualesDatos","ConfiguracionImpresionEmpresaDato","VerificarUsuarioEmpresa","GuardarVentasImportados","ImprimirSalida","ModificarVenta","ListaVendedorVenta","VendedorVenta","VendedorVentaActualizacion","GuardarUsuarLectorDeBarra","VerificarLimiteCredito","ListaSucursalesUsuario","ListaGruposProductoUsuario","ListaServiciosVentas","GuardarListaServiciosVentas","EliminarVentaServicio","ventasDetalleEmpresa","EliminarDetalleVentaEdicion","filtroCotizacionesPendientes","CotizacionRechazo","ListaInventariosProductoVentaEdicion",function(e,a,t,o,i,n,r,c,s,l,d,u,p,v,m,f,g,h,P,b,_,D,C,V,x,E,M,S,I,T,w,O,A,R,F,z,H,N,B,L,y,j,U,k,G,Y,J,W,q,X,Z,K,Q){r.start(),e.usuario=JSON.parse(t.usuario),convertUrlToBase64Image(e.usuario.empresa.imagen,function(a){e.usuario.empresa.imagen=a});var ee=new Image;ee.onload=function(){e.usuario.altura_imagen=this.height/96},ee.src=e.usuario.empresa.imagen,e.idModalPago="dialog-pago",e.idModalCierre="dialog-cierre-caja",e.idModalWizardCompraEdicion="modal-wizard-venta-edicion",e.idModalWizardVentaVista="modal-wizard-venta-vista",e.idModalEliminarCompra="dialog-eliminar-venta",e.idModalContenedorCompraEdicion="modal-wizard-container-venta-edicion",e.idModalContenedorVentaVista="modal-wizard-container-venta-vista",e.idInputCompletar="nit",e.idModalPanelVentas="dialog-panel-ventas",e.idModalConfirmacionEliminacionVenta="dialog-eliminar-venta",e.idModalInventario="dialog-productos-venta",e.idModalPanelVentasCobro="dialog-panel-cobro",e.idModalEdicionVendedor="dialog-edicion-vendedor",e.idModalImpresionVencimiento="dialog-imprimir-con-fecha-vencimiento",e.IdModalVerificarCuenta="modal-verificar-cuenta",e.modalReportesProductos="dialog-reportes-productos",e.modelGraficaProductos="reporte-grafico-productos",e.modalServicioVenta="dialog-servicios-venta",e.modalReportesEmpresas="dialog-reporte-por-empresas",e.modelGraficaEmpresas="reporte-grafico-empresas",e.modelImportacionVentaServicio="dialog-importacion-ventas-servicios",e.idModalCotizaciones="dialog-cotizaciones-venta",e.idModalDetalleCotizaciones="dialog-detalle-cotizaciones",e.idModalDetalleCotizacionEditar="dialog-cotizacione-editar",e.ModalMensajePago="Modal-Mensaje-Pago",e.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptsVenta(e.idModalWizardCompraEdicion,e.idModalWizardVentaVista,e.idModalEliminarCompra,e.idModalContenedorCompraEdicion,e.idModalContenedorVentaVista,e.idInputCompletar,e.url,e.idModalPago,e.idModalCierre,e.idModalPanelVentas,e.idModalConfirmacionEliminacionVenta,e.idModalInventario,e.idModalPanelVentasCobro,e.idModalEdicionVendedor,e.idModalImpresionVencimiento,e.IdModalVerificarCuenta,e.modalReportesProductos,e.modalServicioVenta,e.modelGraficaProductos,e.modalReportesEmpresas,e.modelGraficaEmpresas,e.modelImportacionVentaServicio,e.idModalCotizaciones,e.idModalDetalleCotizaciones,e.idModalDetalleCotizacionEditar,e.ModalMensajePago),e.buscarAplicacion(e.usuario.aplicacionesUsuario,o.path().substring(1)),r.stop()}),e.inicio=function(){e.ordenProductos=!0,e.esContado=!0,e.obtenerTiposDePago(),e.obtenerConfiguracionVentaVista(),e.sucursales=[],e.obtenerSucursales(),e.sucursalesUsuario="",e.obtenerFormatoFactura(),e.obtenerMovimientosEgreso(),e.obtenerVendedores(),e.detalleVenta={eliminado:!1,producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},e.estadoProducto=!1,e.estadoEmpresa=!1,e.dynamicPopoverPrecios={templateUrl:"preciosTemplate.html"}},e.obtenerConfiguracionVentaVista=function(){r.start(),T(e.usuario.id_empresa).then(function(a){e.configuracionVentaVista=a,r.stop()})},e.guardarConfiguracionVentaVista=function(){w.update({id_empresa:e.usuario.id_empresa},e.configuracionVentaVista,function(e){})},e.generarListaGruposSeleccionados=function(e,a){for(var t=0;t<e.length;t++)for(var o=0;o<a.length;o++)e[t].id==a[o].id&&(e[t].selected=a[o].selected);return e},e.verificarLimiteCredito=function(a){a.cliente&&a.tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO?U(a).then(function(t){var o=t.ventas.slice(0),i=new Date,n=0,r={uno:"",dos:""};t.ventas.forEach(function(t,c,s){if((n+=t.saldo)>=a.cliente.linea_credito&&(r.uno="exedio el limite de la linea de credito"),c==s.length-1){var l=new Date(o.fecha);e.diferenciaEntreDiasEnDias(l,i)>a.cliente.plazo_credito?(r.dos="exedio el limide de dias de credito",1==a.cliente.bloquear_limite_credito?(e.mostrarMensaje(r.uno+" "+r.dos+" no puede realizar mas compras"),e.blockerVenta=!1):(e.mostrarMensaje(r.uno+" "+r.dos+", pero puede seguir consumiendo"),e.blockerVenta=!0)):1==a.cliente.bloquear_limite_credito?(e.mostrarMensaje(r.uno+" "+r.dos+" no puede realizar mas compras"),e.blockerVenta=!1):(e.mostrarMensaje(r.uno+" "+r.dos+", pero puede seguir consumiendo"),e.blockerVenta=!0)}})}):e.blockerVenta=!0},e.diferenciaEntreDiasEnDias=function(e,a){var t=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),o=Date.UTC(a.getFullYear(),a.getMonth(),a.getDate());return Math.floor((o-t)/864e5)},e.obtenerGruposProductoEmpresa=function(){G(e.usuario.id_empresa,e.usuario.id).then(function(a){if(e.grupos_productos=a,angular.isDefined(t.grupos_productos))e.grupos_productos=e.generarListaGruposSeleccionados(e.grupos_productos,t.grupos_productos);else for(var o=0;o<a.length;o++)e.grupos_productos[o].selected=!0;e.listChecked=[],e.saveCheckList=function(){e.listChecked.splice(0,e.listChecked.length);for(var a=0;a<e.grupos_productos.length;a++)1==e.grupos_productos[a].selected&&e.listChecked.push(e.grupos_productos[a]);t.grupos_productos=e.grupos_productos},e.saveCheckList(),e.allChecked=!1,e.checkedUnchecked=function(){for(var a=0;a<e.grupos_productos.length;a++)e.grupos_productos[a].selected=e.allChecked;e.saveCheckList()}})},e.obtenerTiposDePago=function(){r.start(),P("TIPA").then(function(a){e.tiposPago=a.clases,r.stop()})},e.abrirPopuEdicionVendedor=function(){e.vendedor=new L({id_empresa:e.usuario.id_empresa}),e.abrirPopup(e.idModalEdicionVendedor)},e.cerrarPopupEdicionVendedor=function(){e.cerrarPopup(e.idModalEdicionVendedor)},e.guardarVendedor=function(a){e.cerrarPopup(e.idModalEdicionVendedor),a.id?y.update({id_vendedor:a.id},a,function(a){e.mostrarMensaje(a.mensaje),e.obtenerVendedores()}):a.$save(function(a){e.mostrarMensaje("Vendedor registrado satisfactoriamente!"),e.obtenerVendedores()})},e.obtenerVendedores=function(){r.start(),B(e.usuario.id_empresa).then(function(a){e.vendedores=a,r.stop()})},e.obtenerMovimientosEgreso=function(){r.start(),P("MOVEGR").then(function(a){e.movimientosEgreso=a.clases,r.stop()})},e.obtenerTipoEgreso=function(a){var t=a.nombre_corto;e.tipoEgreso=t,e.venta.sucursal&&e.obtenerActividades(e.venta.sucursal.id)},e.buscarCliente=function(a){if(""!=a&&void 0!=a)return g(e.usuario.id_empresa,a)},e.obtenerClientes=function(){f(e.usuario.id_empresa).then(function(a){for(var t=0;t<a.length;t++)a[t].nit=a[t].nit.toString();e.clientes=a})},e.buscarProductoLectorBarra=function(a){if(r.start(),""!=a&&void 0!=a){var t=E(e.usuario.id_empresa,a,e.usuario.id,e.venta.almacen.id);return t.then(function(a){1==a.length&&e.establecerProducto(a[0]),r.stop()},function(a){e.mostrarMensaje(a.message),r.stop()}),r.stop(),t}},e.buscarProducto=function(a){if(r.start(),""!=a&&void 0!=a){var t=E(e.usuario.id_empresa,a,e.usuario.id,e.venta.almacen.id);return r.stop(),t}},e.establecerProductoEdicionVenta=function(a){a.tipoProducto=null==a.tipoProducto?{id:a["tipoProducto.id"],nombre:a["tipoProducto.nombre"],nombre_corto:a["tipoProducto.nombre_corto"]}:a.tipoProducto,e.editar_precio=!1;var t=new Date(e.convertirFecha(e.venta.fechaTexto));Q(a.id,e.venta.almacen.id,t).then(function(t){a.inventarios=t;for(var o=0;o<a.inventarios.length;o++)a.inventarios[o].fecha_vencimiento=a.inventarios[o].fecha_vencimiento?new Date(a.inventarios[o].fecha_vencimiento):null,a.inventarios[o].fechaVencimientoTexto=a.inventarios[o].fecha_vencimiento?a.inventarios[o].fecha_vencimiento.getDate()+"/"+(a.inventarios[o].fecha_vencimiento.getMonth()+1)+"/"+a.inventarios[o].fecha_vencimiento.getFullYear():"",a.inventarios[o].detallesMovimiento[0].movimiento.fecha=new Date(a.inventarios[o].detallesMovimiento[0].movimiento.fecha),a.inventarios[o].detallesMovimiento[0].movimiento.fechaTexto=a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getFullYear();e.inventariosDisponibleProducto=[],e.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),e.inventariosDisponibleProducto=e.inventariosDisponibleProducto.concat(a.inventarios);var i=e.obtenerInventarioTotal(a);if(e.detalleVenta={eliminado:!1,producto:a,precio_unitario:a.precio_unitario,inventarioProducto:e.inventariosDisponibleProducto[0],inventario_disponible:i,costos:a.activar_inventario?a.inventarios:[],cantidad:1,descuento:a.descuento,recargo:0,ice:0,excento:0,tipo_descuento:a.descuento>0,tipo_recargo:!1},e.precio_inventario,a.inventarios.length>0){var n=a.inventarios.find(function(e){var a=e;return a.id<=e.id&&(a=e),e});e.precio_inventario=n.costo_unitario+" Bs"}else e.precio_inventario="Sin histórico";e.inventarioProducto=a.activar_inventario?a.inventarios:[],e.colorearInventarioDisponible(i,a),document.getElementById("cantidad").focus(),e.calcularImporte(),e.cerrarPopup(e.idModalInventario)})},e.establecerProducto=function(a){a.tipoProducto=null==a.tipoProducto?{id:a["tipoProducto.id"],nombre:a["tipoProducto.nombre"],nombre_corto:a["tipoProducto.nombre_corto"]}:a.tipoProducto,e.editar_precio=!1,M(a.id,e.venta.almacen.id).then(function(t){a.inventarios=t;for(var o=0;o<a.inventarios.length;o++)a.inventarios[o].fecha_vencimiento=a.inventarios[o].fecha_vencimiento?new Date(a.inventarios[o].fecha_vencimiento):null,a.inventarios[o].fechaVencimientoTexto=a.inventarios[o].fecha_vencimiento?a.inventarios[o].fecha_vencimiento.getDate()+"/"+(a.inventarios[o].fecha_vencimiento.getMonth()+1)+"/"+a.inventarios[o].fecha_vencimiento.getFullYear():"",a.inventarios[o].detallesMovimiento[0].movimiento.fecha=new Date(a.inventarios[o].detallesMovimiento[0].movimiento.fecha),a.inventarios[o].detallesMovimiento[0].movimiento.fechaTexto=a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getFullYear();e.inventariosDisponibleProducto=[];var i=0;e.TipoPrecioProducto={},e.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),e.inventariosDisponibleProducto=e.inventariosDisponibleProducto.concat(a.inventarios);var n=e.obtenerInventarioTotal(a);if(e.venta.cliente.id&&e.venta.cliente.tipoPrecioVenta&&e.usuario.empresa.usar_tipo_precio&&a.tiposPrecio.length>0?a.tiposPrecio.forEach(function(t){t.id_tipo_precio==e.venta.cliente.tipoPrecioVenta.id?(i=t.precio_unitario,e.tipoPrecioProducto=t):i=a.precio_unitario}):i=a.precio_unitario,e.detalleVenta={eliminado:!1,producto:a,precio_unitario:i,inventarioProducto:e.inventariosDisponibleProducto[0],inventario_disponible:n,costos:a.activar_inventario?a.inventarios:[],cantidad:1,descuento:a.descuento,recargo:0,ice:0,excento:0,tipo_descuento:a.descuento>0,tipo_recargo:!1},e.precio_inventario,a.inventarios.length>0){var r=a.inventarios.find(function(e){var a=e;return a.id<=e.id&&(a=e),e});e.precio_inventario=r.costo_unitario+" Bs"}else e.precio_inventario="Sin histórico";e.inventarioProducto=a.activar_inventario?a.inventarios:[],e.colorearInventarioDisponible(n,a),document.getElementById("cantidad").focus(),e.calcularImporte(),e.cerrarPopup(e.idModalInventario)})},e.colorearInventarioDisponible=function(a,t){0==a?(e.porcentaje="100",e.color="red"):a>3*t.inventario_minimo+1?(e.porcentaje="100",e.color="green"):a>2*t.inventario_minimo+1?(e.porcentaje="75",e.color="green"):a>1.5*t.inventario_minimo+1?(e.porcentaje="50",e.color="green"):a==t.inventario_minimo+1?(e.porcentaje="38",e.color="yellow"):a==t.inventario_minimo?(e.porcentaje="25",e.color="red"):a<t.inventario_minimo&&a>0&&(e.porcentaje="12",e.color="red")},e.actualizarInventarioDisponibleFechaVencimiento=function(a){0!=a.inventarioProducto.id?(a.costos=[],a.costos.push(a.inventarioProducto),a.inventario_disponible=e.obtenerInventarioTotalPorFechaVencimiento(a),a.lote=a.inventarioProducto.lote):(a.inventario_disponible=e.obtenerInventarioTotal(a.producto),a.costos=a.producto.inventarios,a.lote=""),e.colorearInventarioDisponible(a.inventario_disponible,a.producto),e.calcularImporte()},e.establecerCliente=function(a){e.venta.cliente=a,e.enfocar("razon_social"),e.capturarInteraccion()},e.eliminarVendedor=function(a){e.cerrarConfirmacionEliminacion(),new y(a).$delete(function(a){e.mostrarMensaje(a.mensaje),e.obtenerVendedores()},function(a){e.mostrarMensaje("Ocurrio un problema al eliminar!")})},e.modificarVendedor=function(a){e.vendedor=a,e.abrirPopup(e.idModalEdicionVendedor)},e.obtenerInventarioTotal=function(a){var t=0;if(a.activar_inventario){for(var o=0;o<a.inventarios.length;o++)t+=a.inventarios[o].cantidad;for(var i=0;i<e.venta.detallesVenta.length;i++)if(e.venta.detallesVenta[i].producto.tipoProducto.nombre_corto==e.diccionario.TIPO_PRODUCTO_FINAL||e.venta.detallesVenta[i].producto.tipoProducto.nombre_corto==e.diccionario.TIPO_PRODUCTO_INTER)for(var n=0;n<e.venta.detallesVenta[i].producto.productosBase.length;n++){var r=e.venta.detallesVenta[i].producto.productosBase[n];if(r.productoBase.tipoProducto.nombre_corto==e.diccionario.TIPO_PRODUCTO_INTER)for(var c=0;c<r.productoBase.productosBase.length;c++){var s=r.productoBase.productosBase[c];s.productoBase.id!=a.id||e.venta.detallesVenta[i].id||(t-=parseInt(s.formulacion))}else r.productoBase.id!=a.id||e.venta.detallesVenta[i].id||(t-=parseInt(r.formulacion))}else e.venta.detallesVenta[i].producto.id!=a.id||e.venta.detallesVenta[i].id||(t-=e.venta.detallesVenta[i].cantidad)}else t=5e5;return t},e.obtenerInventarioTotalPorFechaVencimiento=function(a){if(e.usuario.empresa.usar_peps){for(var t=a.inventarioProducto.cantidad,o=0;o<e.venta.detallesVenta.length;o++)e.venta.detallesVenta[o].producto.id!=a.producto.id||e.venta.detallesVenta[o].costos[0].id!=a.inventarioProducto.id||e.venta.detallesVenta[o].id||(t-=e.venta.detallesVenta[o].cantidad);return t}for(t=a.inventario_disponible,o=0;o<e.venta.detallesVenta.length;o++)e.venta.detallesVenta[o].producto.id==a.producto.id&&e.venta.detallesVenta[o].costos[0].id==a.inventarioProducto.id&&(t-=e.venta.detallesVenta[o].cantidad);return t},e.agregarDetalleVentaServicio=function(a){a.servicio.id&&a.importe&&(e.calcularImporteServicio(),e.venta.detallesVenta.push(a),e.inventariosDisponibleProducto=[],e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},e.enfocar("id_servicio"))},e.calcularImporteServicio=function(){e.detalleVenta.total=Math.round(1e3*(e.detalleVenta.importe-e.detalleVenta.descuento+e.detalleVenta.recargo-e.detalleVenta.ice-e.detalleVenta.excento))/1e3},e.agregarDetalleVenta=function(a){if(a.producto.id){if(a.producto.activar_inventario)if(e.usuario.empresa.usar_peps)if(a.costos.length>1)for(var t=a.cantidad,o=0,i=JSON.parse(JSON.stringify(a));o<a.costos.length&&t>0;){if(a.inventarioProducto=a.costos[o],(r=e.obtenerInventarioTotalPorFechaVencimiento(a))>0){var n=JSON.parse(JSON.stringify(i));e.detalleVenta=n,t>r?(c=r,t-=r):(c=t,t=0),n.cantidad=c,e.usuario.empresa.usar_vencimientos&&(n.fecha_vencimiento=a.costos[o].fecha_vencimiento,n.lote=a.costos[o].lote),n.costos=[],n.costos.push(a.costos[o]),n.inventario=a.costos[o],e.calcularImporte(),e.venta.detallesVenta.push(n)}o++}else a.costos.length>0&&e.usuario.empresa.usar_vencimientos&&(a.fecha_vencimiento=a.costos[0].fecha_vencimiento,a.lote=a.costos[0].lote,a.inventario=a.costos[0]),e.venta.detallesVenta.push(a);else{var r;t=a.cantidad,o=0,i=JSON.parse(JSON.stringify(a));if(a.inventarioProducto=a.costos[o],(r=e.obtenerInventarioTotalPorFechaVencimiento(a))>0){var c;n=JSON.parse(JSON.stringify(i));e.detalleVenta=n,t>r?(c=r,t-=r):(c=t,t=0),n.cantidad=c,e.usuario.empresa.usar_vencimientos&&(n.fecha_vencimiento=a.costos[o].fecha_vencimiento,n.lote=a.costos[o].lote),n.costos=[],n.costos.push(a.costos[o]),n.inventario=a.costos[o],e.calcularImporte(),e.venta.detallesVenta.push(n)}}else e.venta.detallesVenta.push(a);e.inventariosDisponibleProducto=[],e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.precio_inventario="Sin histórico",e.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},e.enfocar("id_producto")}},e.enfocar=function(e){c(function(){$("#"+e).focus()},0)},e.interceptarTecla=function(a,t,o){13===a.which&&(o?e.enfocar(t):c(function(){$("#"+t).trigger("click")},0))},e.eliminarDetalleVenta=function(a){a.id?(a.eliminado=!0,e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.capturarInteraccion()):(e.venta.detallesVenta.splice(e.venta.detallesVenta.indexOf(a),1),e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.capturarInteraccion())},e.eliminarDetalleVentaEdicion=function(a){a.id?(e.CancelacionVentaEdicion=!0,X(a,e.venta.movimientoActual.id,e.venta).then(function(t){1==t.hasError||(e.venta.detallesVenta.splice(e.venta.detallesVenta.indexOf(a),1),e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.capturarInteraccion()),e.mostrarMensaje(t.mensaje)})):(e.venta.detallesVenta.splice(e.venta.detallesVenta.indexOf(a),1),e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.capturarInteraccion())},e.eliminarDetalleVentaPanel=function(a){var t=e.productosProcesados.indexOf(a.producto);e.productosProcesados[t].inventario_disponible=e.productosProcesados[t].inventario_disponible+a.cantidad,e.venta.detallesVenta.splice(e.venta.detallesVenta.indexOf(a),1),e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.capturarInteraccion()},e.cambiarTipoPago=function(a){if(a.tipoPago){var t=a.tipoPago,o=$.grep(e.tiposPago,function(e){return e.id==t.id})[0];e.esContado="CONT"==o.nombre_corto,e.calcularCambio(),1==a.cliente.usar_limite_credito&&e.verificarLimiteCredito(a)}},e.recalcular=function(){e.calcularImporte()},e.calcularImporte=function(){var a,t;e.detalleVenta.importe=Math.round(e.detalleVenta.cantidad*e.detalleVenta.precio_unitario*1e3)/1e3,a=e.detalleVenta.tipo_descuento?e.detalleVenta.importe*(e.detalleVenta.descuento/100):e.detalleVenta.descuento,t=e.detalleVenta.tipo_recargo?e.detalleVenta.importe*(e.detalleVenta.recargo/100):e.detalleVenta.recargo,e.detalleVenta.total=Math.round(1e3*(e.detalleVenta.importe-a+t-e.detalleVenta.ice-e.detalleVenta.excento))/1e3},e.sumarTotalImporte=function(){for(var a=0,t=0;t<e.venta.detallesVenta.length;t++)e.venta.detallesVenta[t].eliminado||(a+=e.venta.detallesVenta[t].importe);e.venta.importe=Math.round(1e3*a)/1e3},e.sumarTotal=function(){for(var a=0,t=0;t<e.venta.detallesVenta.length;t++)e.venta.detallesVenta[t].eliminado||(a+=e.venta.detallesVenta[t].total);e.venta.total=Math.round(1e3*a)/1e3,e.venta.pagado=e.venta.total},e.calcularSaldo=function(){e.venta.saldo=e.venta.total-e.venta.a_cuenta},e.obtenerSucursales=function(){k(e.usuario.id).then(function(a){a.sucursales.map(function(a){e.sucursales.push(a.sucursal)}),e.usuario.sucursalesUsuario=a.sucursales;for(var t=0;t<e.usuario.sucursalesUsuario.length;t++)e.sucursalesUsuario=e.sucursalesUsuario+e.usuario.sucursalesUsuario[t].sucursal.id,t+1!=e.usuario.sucursalesUsuario.length&&(e.sucursalesUsuario=e.sucursalesUsuario+",")})},e.obtenerAlmacenesSucursalesDiferente=function(a){e.obtenerAlmacenes(a),e.obtenerSucursalesDiferente(a)},e.obtenerAlmacenesDiferente=function(a){e.almacenesDiferente=[];var t=$.grep(e.sucursales,function(e){return e.id==a})[0];e.almacenesDiferente=t.almacenes,e.venta.almacenDestino=1==e.almacenesDiferente.length?e.almacenesDiferente[0]:null},e.obtenerSucursalesDiferente=function(a){e.sucursalesDiferente=$.grep(e.sucursales,function(e){return e.id!=a}),e.almacenesDiferente=e.sucursalesDiferente.almacenes},e.obtenerAlmacenesActividades=function(a){e.obtenerAlmacenes(a),e.obtenerActividades(a)},e.obtenerAlmacenes=function(a){e.almacenes=[];var t=$.grep(e.sucursales,function(e){return e.id==a})[0];e.almacenes=t.almacenes,e.venta.editar||(e.venta.almacen=1==e.almacenes.length?e.almacenes[0]:null,e.venta.almacen&&e.cargarProductos())},e.obtenerActividades=function(a){e.actividades=[];var t=$.grep(e.sucursales,function(e){return e.id==a})[0];e.actividadesDosificaciones=t.actividadesDosificaciones,e.actividades=[];for(var o=0;o<e.actividadesDosificaciones.length;o++)e.actividadesDosificaciones[o].dosificacion&&(e.venta.movimiento&&"SERV"==e.venta.movimiento.nombre_corto?e.actividadesDosificaciones[o].expirado||e.actividadesDosificaciones[o].dosificacion.expirado||1!=e.actividadesDosificaciones[o].dosificacion.tipo_dosificacion?e.dosificacionesExpiradas=!0:e.actividades.push(e.actividadesDosificaciones[o].actividad):e.actividadesDosificaciones[o].expirado||e.actividadesDosificaciones[o].dosificacion.expirado||0!=e.actividadesDosificaciones[o].dosificacion.tipo_dosificacion?e.dosificacionesExpiradas=!0:e.actividades.push(e.actividadesDosificaciones[o].actividad));e.venta.id||(e.venta.actividad=1==e.actividades.length?e.actividades[0]:null)},e.obtenerVentas=function(){var a=new Date,t=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear();e.filtrarVentas(e.sucursalesUsuario,t,t)},e.filtrarVentas=function(a,t,o,i,n,c,s,l,d,p,v,m){i=""==i||void 0==i?0:i,v=""==v||void 0==v?0:v,n=null==n||void 0==n?0:n,c=null==c||void 0==c?0:c,s=void 0==s?0:s,l=null==l||void 0==l?0:l,d=null==d||void 0==d?0:d,p=$.grep(e.usuario.rolesUsuario,function(a){return a.rol.nombre==e.diccionario.ROL_ADMINISTRADOR}).length>0?""==p||void 0==p?0:p:e.usuario.nombre_usuario,m=!m&&m,r.start(),e.razon_sociald=i,e.nitd=n,e.montod=c,e.usuariod=p,0!=d&&(e.transacciond=$.grep(e.movimientosEgreso,function(e){return e.id==d}).length>0?$.grep(e.movimientosEgreso,function(e){return e.id==d})[0].nombre:"todos"),0!=l&&(e.sucursald=$.grep(e.sucursales,function(e){return e.id==l}).length>0?$.grep(e.sucursales,function(e){return e.id==l})[0].nombre:"todos"),0!=s&&(e.tipoPagod=$.grep(e.tiposPago,function(e){return e.id==s}).length>0?$.grep(e.tiposPago,function(e){return e.id==s})[0].nombre:"todos"),t=new Date(e.convertirFecha(t)),o=new Date(e.convertirFecha(o)),u(a,t,o,i,n,c,s,l,d,p,v).then(function(a){e.ventas=a,r.stop()})},e.abrirPopupPago=function(a){e.venta=a,e.pago=null,e.abrirPopup(e.idModalPago)},e.cerrarPopupPago=function(){e.cerrarPopup(e.idModalPago)},e.realizarPago=function(a,t,o,i){var n;(n=e.venta.saldo-o)<0?retante=n:n>=0&&(retante=0),r.start(),V.update({id:a,id_empresa:t},{pago:o,id_usuario_cajero:i,saldoRestante:n},function(a){e.mostrarMensaje(a.mensaje),e.cerrarPopup(e.idModalPago),e.obtenerVentas(),e.imprimirRecibo(a,a.venta,o),r.stop()},function(a){e.mostrarMensaje(a),e.cerrarPopup(e.idModalPago),e.obtenerVentas(),r.stop()})},e.mensaje=function(a){e.accion=a,1==e.accion?e.realizarPago(e.venta.id,e.usuario.id_empresa,e.pago,e.usuario.id):e.cerrarPopup(e.ModalMensajePago)},e.efectuarPago=function(a){var t=e.usuario.empresa.usar_pago_anticipado;e.pago=a,1==t?a<=e.venta.saldo?e.realizarPago(e.venta.id,e.usuario.id_empresa,a,e.usuario.id):e.abrirPopup(e.ModalMensajePago):a<=e.venta.saldo?e.realizarPago(e.venta.id,e.usuario.id_empresa,a,e.usuario.id):e.mostrarMensaje("El cobro excede el monto a cobrar")},e.imprimirRecibo=function(a,t,o){r.start();var i=new PDFDocument({compress:!1,size:[227,353],margin:10}),n=i.pipe(blobStream());i.moveDown(2),i.font("Helvetica-Bold",8),i.text(e.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),i.moveDown(.4),i.font("Helvetica",7),i.text(t.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),i.moveDown(.4),i.text(t.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),i.moveDown(.4);var c=(null!=t.almacen.sucursal.telefono1?t.almacen.sucursal.telefono1:"")+(null!=t.almacen.sucursal.telefono2?"-"+t.almacen.sucursal.telefono2:"")+(null!=t.almacen.sucursal.telefono3?"-"+t.almacen.sucursal.telefono3:"");i.text("TELF.: "+c,{align:"center"}),i.moveDown(.4),i.text("COCHABAMBA - BOLIVIA",{align:"center"}),i.moveDown(.5),i.font("Helvetica-Bold",8),i.text("RECIBO",{align:"center"}),i.font("Helvetica",7),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.text(t.almacen.sucursal.nota_recibo_correlativo,{align:"center"}),i.moveDown(.4),i.moveDown(.4),i.text("------------------------------------",{align:"center"}),i.moveDown(.4),i.moveDown(.6);var s=new Date;i.text("FECHA : "+s.getDate()+"/"+(s.getMonth()+1)+"/"+s.getFullYear(),{align:"left"}),i.moveDown(.4),i.text("He recibido de : "+e.venta.cliente.razon_social,{align:"left"}),i.moveDown(.4),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.2),i.text("       CONCEPTO                                   ",{align:"left"}),i.moveDown(.2),i.text("---------------------------------------------------------------------------------",{align:"center"}),i.moveDown(.4),t.fecha=new Date(t.fecha),i.text("Fecha: "+t.fecha.getDate()+"/"+(t.fecha.getMonth()+1)+"/"+t.fecha.getFullYear(),15,210);var l=e.venta.movimiento.clase.nombre_corto==e.diccionario.EGRE_FACTURACION?"Factura nro. "+e.venta.factura:"Proforma nro. "+e.venta.factura;i.text(l,105,210,{width:100}),i.text("Saldo Bs "+(t.saldo-o)+".-",105,220,{width:100}),i.text("Bs "+o+".-",170,210,{width:100}),i.text("--------------",10,230,{align:"right"}),i.moveDown(.3),i.text("TOTAL Bs.              "+o.toFixed(2),{align:"right"}),i.moveDown(.4),i.moveDown(.4),i.text("SON: "+a.pago,{align:"left"}),i.moveDown(.6),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.moveDown(.4),i.text("-------------------------                       -------------------------",{align:"center"}),i.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),i.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),r.stop()},e.abrirPopupCierre=function(){e.cierre={},e.abrirPopup(e.idModalCierre)},e.cerrarPopupCierre=function(){e.cerrarPopup(e.idModalCierre)},e.cerrarCaja=function(a){r.start(),inicio=new Date,fin=new Date;var t=b(e.sucursalesUsuario,inicio,fin,e.usuario.id);t.then(function(o){(t=_(e.sucursalesUsuario,inicio,fin,e.usuario.id)).then(function(i){(t=D(e.sucursalesUsuario,inicio,fin,e.usuario.id)).then(function(t){e.generarReporteCierreCaja(a,o,i,t),e.cerrarPopupCierre()})})})},e.generarReporteCierreCaja=function(a,t,o,i){R(e.usuario.id_empresa,0).then(function(n){var r=[612,792];if(n.usar){if(n.tamanoPapelCierreCaja.nombre_corto==e.diccionario.FACT_PAPEL_OFICIO)r=[612,936],e.imprimirReporteCierreCajaCartaOficio(r,a,t,o,i);else if(n.tamanoPapelCierreCaja.nombre_corto==e.diccionario.FACT_PAPEL_CARTA)r=[612,792],e.imprimirReporteCierreCajaCartaOficio(r,a,t,o,i);else if(n.tamanoPapelCierreCaja.nombre_corto==e.diccionario.FACT_PAPEL_MEDIOOFICIO)r=[612,468],e.imprimirReporteCierreCajaCartaOficio(r,a,t,o,i);else if(n.tamanoPapelCierreCaja.nombre_corto==e.diccionario.FACT_PAPEL_ROLLO){var c;r=[227,(c=t.length+o.length+i.length)<=2?310:310+20*(c-2)],e.imprimirReporteCierreCajaRollo(r,a,t,o,i)}}else r=[227,(c=t.length+o.length+i.length)<=2?310:310+20*(c-2)],e.imprimirReporteCierreCajaRollo(r,a,t,o,i)})},e.trueDetalle=!0,e.verDetalle=function(){e.trueDetalle?e.trueDetalle=!1:e.trueDetalle=!0},e.imprimirFiltroCajaCartaOficio=function(a,t,o){var i=new PDFDocument({compress:!1,size:[612,792],margin:0}),n=i.pipe(blobStream()),c=20;if(e.trueDetalle){for(var s=2*a.length,l=0;l<a.length;l++)s+=a[l].detallesVenta.length;var d=Math.ceil(s/c)}else c=20,d=Math.ceil(a.length/c);var u=100,p=0,v=1;e.imprimirCabeceraFiltroCajaCartaOficio(i,1,d,a,t,o),i.font("Helvetica",7);for(l=0;l<a.length;l++)if(i.font("Helvetica",7),i.rect(50,u+9,520,0).stroke(),i.text(l+1,55,u+20),i.font("Helvetica",6),i.text(a[l].movimiento?a[l].movimiento.clase.nombre:a[l].movimientoServicio.nombre,65,u+20),i.text(a[l].almacen?a[l].almacen.sucursal.nombre:a[l].sucursal.nombre,120,u+20,{width:60}),a[l].cliente?(i.font("Helvetica",6),i.text(a[l].cliente.razon_social,170,u+15,{width:75}),i.font("Helvetica",7),i.text(a[l].cliente.nit,245,u+20)):(i.text("",205,u+16,{width:75}),i.text("",265,u+20)),i.text(a[l].factura,305,u+20),a[l].fecha=new Date(a[l].fecha),i.text(a[l].fecha.getDate()+"/"+(a[l].fecha.getMonth()+1)+"/"+a[l].fecha.getFullYear(),345,u+20),i.text(a[l].fecha.getHours()+":"+a[l].fecha.getMinutes()+" - ",385,u+13,{width:28}),i.text(a[l].fecha.getDate()+"/"+(a[l].fecha.getMonth()+1)+"/"+a[l].fecha.getFullYear(),385,u+21,{width:32}),i.text(a[l].total,425,u+20),a[l].tipoPago?(i.text(a[l].tipoPago.nombre,455,u+20),a[l].tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO&&(i.font("Helvetica",6),i.text("Plazo: "+a[l].dias_credito+" A cuenta: Bs "+a[l].a_cuenta+" Saldo: Bs "+a[l].saldo,510,u+16,{width:55}))):(i.text("",455,u+20),i.text("",520,u+16,{width:65})),e.trueDetalle){i.rect(50,u+34,520,0).stroke(),i.font("Helvetica",7),u+=50,i.text("N°",105,u),i.text("Nombre",115,u),i.text("Codigo Item",170,u),i.text("Unidad de Med",230,u),i.text("Cantidad",295,u),i.text("Importe",355,u),p++;for(var m=0;m<a[l].detallesVenta.length;m++)if(i.font("Helvetica",7),i.text(m+1,105,u+20),i.text(a[l].detallesVenta[m].producto?a[l].detallesVenta[m].producto.nombre:a[l].detallesVenta[m].servicio.nombre,115,u+20,{width:55}),i.text(a[l].detallesVenta[m].producto?a[l].detallesVenta[m].producto.id:"0",170,u+20),i.text(a[l].detallesVenta[m].producto?a[l].detallesVenta[m].producto.unidad_medida:"0",230,u+20),i.text(a[l].detallesVenta[m].producto?a[l].detallesVenta[m].cantidad:"0",295,u+20),i.text(a[l].detallesVenta[m].importe,355,u+20),u+=24,++p+1>c-1){u+=10,i.text(v+" de "+d,520,705);var f=new Date;i.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),i.text("USUARIO: "+e.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),u=100,p=0,v+=1,e.imprimirCabeceraFiltroCajaCartaOficio(i,1,d,a,t,o)}if(i.font("Helvetica",7),u+=4,++p>c){u+=10,i.text(v+" de "+d,520,705);f=new Date;i.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),i.text("USUARIO: "+e.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),u=100,p=0,v+=1,e.imprimirCabeceraFiltroCajaCartaOficio(i,1,d,a,t,o)}}else if(i.font("Helvetica",7),u+=30,++p==c){i.text(v+" de "+d,520,705);f=new Date;i.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),i.text("USUARIO: "+e.usuario.nombre_usuario,150,705),i.addPage({size:[612,792],margin:10}),u=100,p=0,v+=1,e.imprimirCabeceraFiltroCajaCartaOficio(i,1,d,a,t,o)}i.font("Helvetica",7),i.text(v+" de "+d,520,705);f=new Date;i.text("FECHA : "+f.getDate()+"/"+(f.getMonth()+1)+"/"+f.getFullYear()+"   Hr:"+f.getHours()+":"+f.getMinutes(),55,705),i.text("USUARIO: "+e.usuario.nombre_usuario,150,705),i.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),r.stop()},e.imprimirCabeceraFiltroCajaCartaOficio=function(a,t,o,i,n,r){a.font("Helvetica-Bold",16),a.text("REPORTE",0,40,{align:"center"}),a.font("Helvetica-Bold",8),a.rect(50,80,520,620).stroke(),a.text("Desde: "+n+" Hasta: "+r,0,55,{align:"center"});var c=[e.razon_sociald,e.nitd,e.montod,e.usuariod,e.transacciond,e.sucursald,e.tipoPagod],s=0,l="";a.text("Filtro: ",55,65);for(var d=0;d<c.length;d++)0!=c[d]&&void 0!=c[d]?(l=l+c[d]+", ",65):7==(s+=1)&&a.text("GENERAL",85,65);a.text(l,85,65),a.font("Helvetica-Bold",7),a.font("Helvetica-Bold",8),a.text("N°",55,90),a.text("Transaccion",65,90),a.text("Sucursal",120,90,{width:43}),a.text("Razon Social",170,90),a.text("Nit Cliente",245,90,{width:43}),a.text("Fac.",305,90),a.text("Fecha-Fact.",345,86,{width:43}),a.text("Hora-Fecha",385,86,{width:43}),a.text("Monto",420,90),a.text("Tipo de Pago",455,90),a.text("Pago",520,90)},e.imprimirFiltroExcelCajaCartaOficio=function(a){r.start();for(var t=[["N°","Tipo de Transaccion","Sucursal","Razon Social","N° DE LA FACTURA","Nit Cliente","Fac.","Fecha-Fact.","Hora-Fecha","Monto","Tipo de Pago","Pago","Sucursal dest"]],o=0;o<a.length;o++)a[o].fecha=new Date(a[o].fecha);a.sort(function(e,a){return e.fecha>a.fecha?1:e.fecha<a.fecha?-1:0});for(o=0;o<a.length;o++){var i=[];if(i.push(o+1),i.push(a[o].movimiento?a[o].movimiento.clase.nombre:a[o].movimientoServicio.nombre),i.push(a[o].almacen?a[o].almacen.sucursal.nombre:a[o].sucursal.nombre),a[o].cliente?(i.push(a[o].cliente.razon_social),i.push(a[o].factura),i.push(a[o].cliente.nit)):(i.push(""),i.push(a[o].factura),i.push("")),i.push(a[o].factura),i.push(a[o].fecha),i.push(a[o].fecha),i.push(a[o].total),a[o].tipoPago?(i.push(a[o].tipoPago.nombre),a[o].tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO&&i.push("Plazo: "+a[o].dias_credito+" A cuenta: Bs "+a[o].a_cuenta+" Saldo: Bs "+a[o].saldo)):i.push(""),a[o].movimiento&&"TRASPASO"==a[o].movimiento.clase.nombre&&(i.push(""),i.push(a[o].almacenTraspaso.sucursal.nombre)),t.push(i),e.trueDetalle){t.push(["","","","","N°","Nombre","Codigo Item","Unidad de Med","Cantidad","Importe","lote"]);for(var n=0;n<a[o].detallesVenta.length;n++)(i=[]).push(""),i.push(""),i.push(""),i.push(""),i.push(n+1),i.push(a[o].detallesVenta[n].producto?a[o].detallesVenta[n].producto.nombre:a[o].detallesVenta[n].servicio?a[o].detallesVenta[n].servicio.nombre:"ERROR SIN NOMBRE"),i.push(a[o].detallesVenta[n].producto?a[o].detallesVenta[n].producto.codigo:a[o].detallesVenta[n].servicio?"0":"ERROR SIN NOMBRE"),i.push(a[o].detallesVenta[n].producto?a[o].detallesVenta[n].producto.unidad_medida:a[o].detallesVenta[n].servicio?"0":"ERROR SIN NOMBRE"),i.push(a[o].detallesVenta[n].producto?a[o].detallesVenta[n].cantidad:a[o].detallesVenta[n].servicio?"0":"ERROR SIN NOMBRE"),i.push(a[o].detallesVenta[n].producto?a[o].detallesVenta[n].importe:"ERROR SIN NOMBRE"),i.push(a[o].detallesVenta[n].producto?a[o].detallesVenta[n].lote:a[o].detallesVenta[n].servicio?"0":"ERROR SIN NOMBRE"),t.push(i)}o+1==a.length&&((i=[]).push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push(""),i.push("TOTALES"),t.push(i))}var c="SheetJS",s=new Workbook,l=sheet_from_array_of_arrays(t);s.SheetNames.push(c),s.Sheets[c]=l;var d=XLSX.write(s,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(d)],{type:"application/octet-stream"}),"Reporte-ventas.xlsx"),r.stop()},e.imprimirReporteCierreCajaCartaOficio=function(e,a,t,o,i){var n=new PDFDocument({compress:!1,size:e,margin:0}),c=n.pipe(blobStream());n.font("Helvetica-Bold",15),n.text("CIERRE DE CAJA",55,50),n.font("Helvetica-Bold",8),n.text("SALDO INICIAL: ",55,80),n.text(a.saldo_inicial,350,80),n.font("Helvetica-Bold",8),n.text("VENTAS AL CONTADO: ",55,100),n.font("Helvetica",8);for(var s=100,l=0,d=0,u=0;u<t.length;u++)n.text("No. "+t[u].factura,55,s+20),n.text(t[u].cliente.razon_social,100,s+20),n.text(t[u].total,300,s+20),l+=t[u].total,s+=20;n.font("Helvetica-Bold",8),n.text(l,350,100),n.font("Helvetica-Bold",8),n.text("VENTAS AL CREDITO: ",55,s+20),n.font("Helvetica",8);var p=s+20;s+=20;var v=0;for(u=0;u<o.length;u++)o[u].pagosVenta.length>0?o[u].pagosVenta[0].a_cuenta_anterior>0&&(n.text("No. "+o[u].factura,55,s+20),n.text(o[u].cliente.razon_social,100,s+20),n.text(o[u].pagosVenta[0].a_cuenta_anterior,300,s+20),v+=o[u].pagosVenta[0].a_cuenta_anterior,s+=20):o[u].a_cuenta&&(n.text("No. "+o[u].factura,55,s+20),n.text(o[u].cliente.razon_social,100,s+20),n.text(o[u].a_cuenta,300,s+20),v+=o[u].a_cuenta,s+=20);n.font("Helvetica-Bold",8),n.text(v,350,p);var m=s+20;n.text("COBROS REALIZADOS: ",55,s+20),n.font("Helvetica",8),s+=20;for(u=0;u<i.length;u++)n.text("No. "+i[u].venta.factura,55,s+20),n.text(i[u].venta.cliente.razon_social,100,s+20),n.text(i[u].monto_pagado,300,s+20),d+=i[u].monto_pagado,s+=20;n.text(d,350,m),n.font("Helvetica-Bold",8),n.text("GASTOS: ",55,s+40),n.text(a.gastos,350,s+40),n.text("SALDO FINAL CAJA: ",55,s+60),n.text(Math.round(100*(a.saldo_inicial+l+v+d-a.gastos))/100,350,s+60),n.text("---------------------------------------------                       ---------------------------------------------",0,s+100,{align:"center"}),n.text("ENTREGUE CONFORME                                     RECIBI CONFORME",0,s+130,{align:"center"}),n.end(),c.on("finish",function(){var e=c.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),r.stop()},e.imprimirReporteCierreCajaRollo=function(e,a,t,o,i){var n=new PDFDocument({compress:!1,size:e,margins:{top:10,bottom:10,left:10,right:20}}),c=n.pipe(blobStream());n.moveDown(2),n.font("Helvetica-Bold",8),n.text("CIERRE DE CAJA",{align:"center"}),n.moveDown(.4),n.font("Helvetica-Bold",8);var s=n.y;n.text("SALDO INICIAL: ",{align:"left",width:100}),n.text(a.saldo_inicial,0,s,{align:"right"}),n.x=10,n.moveDown(.8),n.font("Helvetica-Bold",8);var l=n.y;n.text("VENTAS AL CONTADO: ",{align:"left"}),n.font("Helvetica",8),n.moveDown(.4);for(var d=n.y,u=0,p=0,v=0;v<t.length;v++)n.text("No. "+t[v].factura,20,d),n.text(t[v].cliente.razon_social,60,d,{width:90}),n.text(t[v].total,150,d),u+=t[v].total,d+=20;n.font("Helvetica-Bold",8),n.text(u,0,l,{align:"right"}),n.y=d,n.moveDown(.4),n.x=10,n.font("Helvetica-Bold",8);var m=n.y;n.text("VENTAS AL CREDITO: ",{align:"left"}),n.font("Helvetica",8),n.moveDown(.4),d=n.y;var f=0;for(v=0;v<o.length;v++)o[v].pagosVenta.length>0?o[v].pagosVenta[0].a_cuenta_anterior>0&&(n.text("No. "+o[v].factura,20,d),n.text(o[v].cliente.razon_social,60,d,{width:90}),n.text(o[v].pagosVenta[0].a_cuenta_anterior,150,d),f+=o[v].pagosVenta[0].a_cuenta_anterior,d+=20):o[v].a_cuenta&&(n.text("No. "+o[v].factura,20,d),n.text(o[v].cliente.razon_social,60,d,{width:90}),n.text(o[v].a_cuenta,150,d),f+=o[v].a_cuenta,d+=20);n.font("Helvetica-Bold",8),n.text(f,0,m,{align:"right"}),n.y=d,n.moveDown(.4),n.x=10;var g=n.y;n.text("COBROS REALIZADOS: ",{align:"left"}),n.font("Helvetica",8),n.moveDown(.4),d=n.y;for(v=0;v<i.length;v++)n.text("No. "+i[v].venta.factura,20,d),n.text(i[v].venta.cliente.razon_social,60,d,{width:90}),n.text(i[v].monto_pagado,150,d),p+=i[v].monto_pagado,d+=20;n.font("Helvetica-Bold",8),n.text(p,0,g,{align:"right"}),n.y=d,n.moveDown(.4),n.x=10,n.font("Helvetica-Bold",8),s=n.y,n.text("GASTOS: ",{align:"left"}),n.text(a.gastos,0,s,{align:"right"}),n.x=10,n.moveDown(.4),s=n.y,n.text("SALDO FINAL CAJA: ",{align:"left"}),n.text(Math.round(100*(a.saldo_inicial+u+f+p-a.gastos))/100,0,s,{align:"right"}),n.x=10,n.text("-----------------------------      -----------------------------",0,d+100,{align:"center"}),n.text("ENTREGUE CONFORME   RECIBI CONFORME",{align:"center"}),n.end(),c.on("finish",function(){var e=c.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),r.stop()},e.sumarMonto=function(){for(var a=0,t=0;t<e.ventas.length;t++)e.ventas[t].movimiento?e.ventas[t].movimiento.clase.nombre_corto!=e.diccionario.EGRE_FACTURACION&&e.ventas[t].movimiento.clase.nombre_corto!=e.diccionario.EGRE_PROFORMA||!e.ventas[t].activa||(a+=e.ventas[t].total):e.ventas[t].movimientoServicio.nombre_corto==e.diccionario.EGRE_SERVICIO&&e.ventas[t].activa&&(a+=e.ventas[t].total);return Math.round(100*a)/100},e.crearNuevaVenta=function(a){e.obtenerListaServiciosVentas(),e.blockerVenta=!0,e.venta=new d({id_empresa:e.usuario.id_empresa,id_usuario:e.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],pagado:0,cambio:0,despachado:!1,vendedor:null});var t=0;void 0==a?e.venta.sucursal=1==e.sucursales.length?e.sucursales[0]:null:(e.venta.sucursal=a.sucursal,t=a.almacen),e.venta.sucursal&&(e.obtenerAlmacenesActividades(e.venta.sucursal.id),null!=t&&t.id&&(e.venta.almacen=t)),e.venta.movimiento=e.movimientosEgreso[0],e.obtenerTipoEgreso(e.venta.movimiento);var o=new Date;e.venta.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),e.venta.tipoPago=e.tiposPago[0],e.cambiarTipoPago(e.venta),e.editar_precio=!1,e.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,servicio:{}},e.abrirPopup(e.idModalWizardCompraEdicion),angular.element(s).unbind("keydown"),angular.element(s).bind("keydown",function(a){115==a.keyCode&&e.venderProformaDirectoNormal(e.venta)}),e.enfocar("nit")},e.venderProformaDirectoNormal=function(a){a.detallesVenta.length>0?g(e.usuario.id_empresa,0).then(function(t){1==t.length||t.length>1?e.establecerCliente(t[0]):e.venta.cliente.razon_social=null,a.movimiento=$.grep(e.movimientosEgreso,function(a){return a.nombre_corto==e.diccionario.EGRE_PROFORMA})[0],a.tipoPago=$.grep(e.tiposPago,function(a){return a.nombre==e.diccionario.TIPO_PAGO_CONTADO})[0],e.obtenerTipoEgreso(a.movimiento),e.cambiarTipoPago(a);var o=new Date;a.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),fecha=o,a.pagado=a.total,a.cambio=0,e.usuario.empresa.usar_vencimientos=!1,e.guardarVenta(!0,a),e.venta.sucursal=a.sucursal}):e.$apply(function(){e.message="¡Debe agregar al menos un producto para realizar la transacción!",e.mostrarMensaje(e.message)})},e.verVenta=function(a){e.venta=a,e.abrirPopup(e.idModalWizardVentaVista)},e.cerrarPopupVista=function(){e.cerrarPopup(e.idModalWizardVentaVista)},e.cerrarPopupEdicion=function(){e.ocultarMensajesValidacion(),e.cerrarPopup(e.idModalWizardCompraEdicion)},e.calcularCambio=function(){e.esContado?(e.venta.cambio=Math.round(100*(e.venta.pagado-e.venta.total))/100,e.pagoMinimo=e.venta.total):(e.venta.cambio=0,e.pagoMinimo=0)},e.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},e.imprimirVenta=function(a){C(a.id,e.usuario.id_empresa).then(function(a){var t=a.venta;t.configuracion=a.configuracion,t.sucursal=a.sucursal,t.numero_literal=a.numero_literal,t.pieFactura=a.pieFactura,t.sucursalDestino=a.sucursalDestino;var o=new Date(t.fecha);t.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),t.movimiento?H(t.movimiento.clase.nombre_corto,t,!1,e.usuario,!1):H(t.movimientoServicio.nombre_corto,t,!1,e.usuario,!1)})},e.modificarPrecio=function(){e.editar_precio=!0},e.establecerPrecio=function(){e.editar_precio=!1},e.obtenerFormatoFactura=function(){r.start(),P("FORM_IMP_FAC").then(function(a){e.formatosFactura=a.clases,r.stop()})},e.guardarVenta=function(a,t){if(a){e.ocultarMensajesValidacion();var o=new Date;if(t.fecha=new Date(e.convertirFecha(t.fechaTexto)),t.fecha.setHours(o.getHours()),t.fecha.setMinutes(o.getMinutes()),t.fecha.setSeconds(o.getSeconds()),r.start(),t.id){N(t).then(function(a){r.stop(),e.cerrarPopPupEdicion(),e.mostrarMensaje(a.mensaje),e.recargarItemsTabla()})}else{var i=t.movimiento.nombre_corto;t.usar_peps=e.usuario.empresa.usar_peps,t.$save(function(a){a.hasError?(r.stop(),e.crearNuevaVenta(a),e.mostrarMensaje(a.message)):(r.stop(),e.cerrarPopPupEdicion(),i==e.diccionario.EGRE_SERVICIO?H(i,a,!0,e.usuario,!1):(t.actualizarCotizacion&&K.update({id_cotizacion:t.cotizacion_id},{estado:"ACEPTADO"},function(e){},function(a){e.mostrarMensaje("Hubo un problema al guardar.")}),e.usuario.empresa.usar_vencimientos?(e.impresion={movimiento:i,res:a,al_guardar:!0,usuario:e.usuario},e.abrirPopup(e.idModalImpresionVencimiento)):H(i,a,!0,e.usuario,!1)),e.crearNuevaVenta(a),e.mostrarMensaje("Venta registrada exitosamente!"))},function(a){r.stop(),e.cerrarPopPupEdicion(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})}}},e.imprimirConVencimiento=function(){e.impresion.res.con_vencimiento=!0,H(e.impresion.movimiento,e.impresion.res,e.impresion.al_guardar,e.impresion.usuario,!1),e.cerrarPopup(e.idModalImpresionVencimiento)},e.imprimirSinVencimiento=function(){e.impresion.res.con_vencimiento=!1,H(e.impresion.movimiento,e.impresion.res,e.impresion.al_guardar,e.impresion.usuario,!1),e.cerrarPopup(e.idModalImpresionVencimiento)},e.imprimirVentaConVencimiento=function(a){C(a.id,e.usuario.id_empresa).then(function(a){var t=a.venta;t.con_vencimiento=!0,t.configuracion=a.configuracion,t.sucursal=a.sucursal,t.numero_literal=a.numero_literal,t.pieFactura=a.pieFactura,t.sucursalDestino=a.sucursalDestino;var o=new Date(t.fecha);t.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),H(t.movimiento.clase.nombre_corto,t,!1,e.usuario,!1)})},e.cerrarPopPupEdicion=function(){e.cerrarPopup(e.idModalWizardCompraEdicion)},e.fechaATexto=function(e){return fech=new Date(e),e=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},e.obtenerAlmacenesEditar=function(a){e.almacenes=[];var t=$.grep(e.sucursales,function(e){return e.id==a})[0];e.almacenes=t.almacenes},e.buscarNit=function(a,t){13===a.which&&g(e.usuario.id_empresa,t).then(function(t){1==t.length||t.length>1?(e.establecerCliente(t[0]),e.interceptarTecla(a,"razon_socialP",!0),e.interceptarTecla(a,"razon_socialP1",!0)):(e.venta.cliente.razon_social=null,e.interceptarTecla(a,"razon_socialP",!0),e.interceptarTecla(a,"razon_socialP1",!0))});e.capturarInteraccion()},e.capturarInteraccion=function(){e.usuario.empresa.usar_pantalla_cliente&&I.emit("comenzarVenta",e.venta)},e.abrirPopupPanel=function(a,t,o,i,n){e.venta=new d({id_empresa:e.usuario.id_empresa,id_usuario:e.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],despachado:!1,sucursal:a,almacen:t,actividad:o,tipoPago:i,movimiento:n,vendedor:null}),e.obtenerGruposProductoEmpresa(),a||(e.venta.sucursal=e.sucursales[0]),e.venta.sucursal&&null==e.venta.almacen&&e.obtenerAlmacenesActividades(e.venta.sucursal.id),n||(e.venta.movimiento=e.movimientosEgreso[0]),e.obtenerTipoEgreso(e.venta.movimiento),i||(e.venta.tipoPago=e.tiposPago[0]),e.cambiarTipoPago(e.venta);var r=new Date;e.venta.fechaTexto=r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear(),e.abrirPopup(e.idModalPanelVentas),e.enfocar("nitP"),setTimeout(function(){aplicarDatePickers(),$("#venta-proforma").draggable({cursor:"crosshair",start:e.startDragging})},2e3),angular.element(s).unbind("keydown"),angular.element(s).bind("keydown",function(a){if(115==a.keyCode&&e.venderProformaDirecto(e.venta,!1),113==a.keyCode&&e.venderProformaDirecto(e.venta,!0),121==a.keyCode)if(a.preventDefault(),e.venta.detallesVenta.length>0){var t=new Date;e.horaActual=t.getHours()+":"+t.getMinutes()+":"+t.getSeconds(),e.abrirPopup(e.idModalPanelVentasCobro),e.enfocar("nitP1");var o=$("#movimiento").val("24");angular.element(o).triggerHandler("change"),angular.element($("#pagadoP").val(e.venta.total)).triggerHandler("change"),$("form").bind("keydown",function(e){if(13===e.keyCode)return!1})}else e.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")})},e.capturarPago=function(a,t,o){13==a.keyCode&&(e.guardarVentaPanel(t,o,!1),e.cerrarPopPupVentasCobro())},e.abrirPopPupVentasCobro=function(){if(e.venta.detallesVenta.length>0){var a=new Date;e.horaActual=a.getHours()+":"+a.getMinutes()+":"+a.getSeconds(),e.abrirPopup(e.idModalPanelVentasCobro),e.enfocar("nitP1"),angular.element(select).triggerHandler("change"),angular.element($("#pagadoP").val(e.venta.total)).triggerHandler("change"),$("form").bind("keydown",function(e){if(13===e.keyCode)return!1})}else e.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")},e.cerrarPopPupVentasCobro=function(){e.cerrarPopup(e.idModalPanelVentasCobro)},e.cerrarPopupPanel=function(){e.cerrarPopup(e.idModalPanelVentas),e.recargarItemsTabla(),e.usuario.empresa.usar_pantalla_cliente&&I.emit("terminarVenta",e.venta.sucursal),angular.element(s).unbind("keydown")},e.clasificarGrupo=function(t){e.productosProcesados=a("filter")(e.productos,t),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},e.cargarProductos=function(){x(e.usuario.id_empresa,e.venta.almacen.id,e.usuario.id).then(function(a){for(var o=0;o<a.length;o++)a[o].activar_inventario&&(a[o].inventario_disponible=e.obtenerInventarioTotal(a[o]));if(e.productos=a,angular.isDefined(t.productosProcesados)){e.productosProcesados=a;for(o=0;o<t.productosProcesados.length;o++)for(var i=0;i<e.productosProcesados.length;i++)t.productosProcesados[o].id==e.productosProcesados[i].id&&(e.productosProcesados[i].rankin=t.productosProcesados[o].rankin)}else e.productosProcesados=a;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},e.textorder="A<- ->Z",e.ordenarProductos=function(t){e.productosProcesados=a("orderBy")(e.productos,["nombre"],t),e.ordenProductos=!t,e.textorder=t?"A<- ->Z":"Z<- ->A",setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},e.filtrarProductos=function(t){e.productosProcesados=a("filter")(e.productos,t),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},angular.isDefined(t.color)?e.color=t.color:(t.color={style:"red-style",stylebutton:"red-style-button"},e.color={style:"red-style",stylebutton:"red-style-button"}),e.cambiarColor=function(e,a){t.color={style:e,stylebutton:a},$("#dialog-panel-ventas .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-ventas .widget-main").addClass(e),$("#dialog-panel-ventas .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-ventas .widget-main .button-style").addClass(a)},e.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},e.dragged=!1,e.proformaClick=function(a){e.dragged||e.venderProformaDirecto(a,!1),e.dragged=!1},e.startDragging=function(){e.dragged=!0},e.venderProformaDirecto=function(a,t){a.detallesVenta.length>0?g(e.usuario.id_empresa,0).then(function(o){1==o.length||o.length>1?e.establecerCliente(o[0]):e.venta.cliente.razon_social=null,a.movimiento=$.grep(e.movimientosEgreso,function(a){return a.nombre_corto==e.diccionario.EGRE_PROFORMA})[0],a.tipoPago=$.grep(e.tiposPago,function(a){return a.nombre==e.diccionario.TIPO_PAGO_CONTADO})[0],e.obtenerTipoEgreso(a.movimiento),e.cambiarTipoPago(a);var i=new Date;a.fechaTexto=i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear(),fecha=i,a.pagado=a.total,a.cambio=0,e.guardarVentaPanel(!0,a,t)}):e.mostrarMensaje("¡Debe agregar al menos un producto para realizar la transacción!")},e.calcularImporteDetalleVenta=function(e){var a,t;e.importe=Math.round(e.cantidad*e.precio_unitario*1e3)/1e3,a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,t=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+t-e.ice-e.excento},e.agregarDetalleVentaPanel=function(a){var o;if(e.cantidadInventario=0,a.activar_inventario)for(var i=0;i<a.inventarios.length;i++)e.cantidadInventario=e.cantidadInventario+a.inventarios[i].cantidad;for(var n=0,r=!1;n<e.venta.detallesVenta.length&&!r;)e.venta.detallesVenta[n].producto.id==a.id&&(a.activar_inventario?e.venta.detallesVenta[n].cantidad+1<=e.cantidadInventario?e.venta.detallesVenta[n].cantidad=e.venta.detallesVenta[n].cantidad+1:e.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+e.cantidadInventario+"!"):e.venta.detallesVenta[n].cantidad=e.venta.detallesVenta[n].cantidad+1,r=!0,o=e.venta.detallesVenta[n]),n++;if(r)e.calcularImporteDetalleVenta(o);else if(a.activar_inventario)if(1<=e.cantidadInventario){var c=0;e.venta.cliente.id&&e.venta.cliente.tipoPrecioVenta&&e.usuario.empresa.usar_tipo_precio&&a.tiposPrecio.length>0?a.tiposPrecio.forEach(function(t){c=t.id_tipo_precio==e.venta.cliente.tipoPrecioVenta.id?t.precio_unitario:a.precio_unitario}):c=a.precio_unitario,o={producto:a,precio_unitario:c,inventario_disponible:e.cantidadInventario,costos:a.inventarios,cantidad:1,descuento:a.descuento,tipo_descuento:a.descuento>0,recargo:0,ice:0,excento:0,tipo_recargo:!1},e.venta.detallesVenta.push(o),e.calcularImporteDetalleVenta(o)}else e.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+e.cantidadInventario+"!");else{c=0;e.venta.cliente.id&&e.venta.cliente.tipoPrecioVenta&&e.usuario.empresa.usar_tipo_precio&&a.tiposPrecio.length>0?a.tiposPrecio.forEach(function(t){c=t.id_tipo_precio==e.venta.cliente.tipoPrecioVenta.id?t.precio_unitario:a.precio_unitario}):c=a.precio_unitario,o={producto:a,precio_unitario:c,inventario_disponible:e.cantidadInventario,costos:a.inventarios,cantidad:1,descuento:a.descuento,tipo_descuento:a.descuento>0,recargo:0,ice:0,excento:0,tipo_recargo:!1},e.venta.detallesVenta.push(o),e.calcularImporteDetalleVenta(o)}e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.capturarInteraccion(),a.rankin+=1;var s=e.productosProcesados.indexOf(a);e.productosProcesados[s]=a,t.productosProcesados=e.productosProcesados,a.activar_inventario&&(a.inventario_disponible=e.cantidadInventario-o.cantidad)},e.disminuirDetalleVenta=function(a){var t=e.productosProcesados.indexOf(a.producto);1==a.cantidad?e.eliminarDetalleVentaPanel(a):(a.cantidad=a.cantidad-1,e.productosProcesados[t].inventario_disponible=e.productosProcesados[t].inventario_disponible+1,e.calcularImporteDetalleVenta(a),e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.capturarInteraccion())},e.guardarVentaPanel=function(a,t,o){if(a){e.usuario.empresa.usar_pantalla_cliente&&I.emit("terminarVenta",t.sucursal),e.ocultarMensajesValidacion();var i=new Date;if(t.fecha=new Date(e.convertirFecha(t.fechaTexto)),t.fecha.setHours(i.getHours()),t.fecha.setMinutes(i.getMinutes()),r.start(),t.id)d.update({idCompra:compra.id},compra,function(a){r.stop(),e.cerrarPopPupEdicion(),e.mostrarMensaje("Actualizado Exitosamente!"),e.recargarItemsTabla()});else{var n=t.movimiento.nombre_corto;t.$save(function(a){r.stop(),a.hasError?(r.stop(),e.mostrarMensaje(a.message),e.venta.almacen.id=t.almacen.id,e.abrirPopupPanel(t.sucursal,t.almacen,t.actividad,t.tipoPago,t.movimiento)):(H(n,a,!0,e.usuario,o),e.mostrarMensaje("Venta registrada exitosamente!"),e.cargarProductos(),e.abrirPopupPanel(t.sucursal,t.almacen,t.actividad,t.tipoPago,t.movimiento),e.enfocar("nitP"))},function(a){r.stop(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}}},e.mostrarConfirmacionEliminacionVenta=function(a){e.venta=new d(a),e.abrirPopup(e.idModalConfirmacionEliminacionVenta)},e.cerrarConfirmacionEliminacionVenta=function(){e.cerrarPopup(e.idModalConfirmacionEliminacionVenta)},e.eliminarVenta=function(a){(r.start(),e.cerrarConfirmacionEliminacionVenta(),a.movimientoServicio)?W(a).then(function(a){e.mostrarMensaje(a.mensaje)}):a.$delete();e.mostrarMensaje("Anulado exitosamente!"),e.recargarItemsTabla(),r.stop()},e.abrirPopupInventario=function(){e.abs=s.Math.abs,e.itemsPorPagina=10,e.paginaActual=1,e.columna="nombre",e.direccion="asc",e.cantidadInv="0",e.textoBusqueda="",e.venta.almacen&&(e.almacenBusqueda=e.venta.almacen,e.buscarInventarios(e.almacenBusqueda.id,e.paginaActual,e.itemsPorPagina,e.textoBusqueda,e.columna,e.direccion,e.cantidadInv)),e.abrirPopup(e.idModalInventario)},e.barcodeScanned=function(a){e.search=a,e.filtrarProductos(a)},e.limpiarBusqueda=function(){e.search="",e.filtrarProductos()},e.buscarInventarios=function(a,t,o,i,n,c,s){r.start(),e.itemsPorPagina=o,""==i||null==i?i=0:e.textoBusqueda=i,e.paginaActual=t,l(e.usuario.id_empresa,a,t,o,i,n,c,s,void 0,e.usuario.id).then(function(a){for(var t=a.productos,o=0;o<t.length;o++){t[o].fecha_vencimiento=new Date(t[o].fecha_vencimiento),t[o].cantidad_total=t[o].cantidad}e.paginas=[];for(o=1;o<=a.paginas;o++)e.paginas.push(o);e.productos=t,r.stop()})},e.clasificarColumna=function(a){e.columna==a?"asc"==e.direccion?(e.direccion="desc",$("#"+a+"p").removeClass("fa-caret-up"),$("#"+a+"p").addClass("fa-caret-down")):(e.direccion="asc",$("#"+a+"p").removeClass("fa-caret-down"),$("#"+a+"p").addClass("fa-caret-up")):(e.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+a+"p").addClass("fa-caret-up"),$("#"+a+"p").removeClass("fa-sort")),e.columna=a,e.buscarInventarios(e.almacenBusqueda.id,e.paginaActual,e.itemsPorPagina,e.textoBusqueda,e.columna,e.direccion,e.cantidadInv)},e.verificarPulso=function(a,t){13===a.keyCode&&(e.textoBusqueda=t,e.almacenBusqueda&&e.buscarInventarios(e.almacenBusqueda.id,1,e.itemsPorPagina,e.textoBusqueda,e.columna,e.direccion,e.cantidadInv))},e.abrirModalVerificarCuenta=function(a,t){e.dato=a,e.tipoDatosPermiso=t,e.abrirPopup(e.IdModalVerificarCuenta)},e.cerrarModalVerificarCuenta=function(){e.cerrarPopup(e.IdModalVerificarCuenta)},e.verificarCuentaAdmin=function(a){F.save({id_empresa:e.usuario.id_empresa},a,function(a){a.type?(e.mostrarMensaje(a.message),"venta"==e.tipoDatosPermiso&&e.modificarVenta(e.dato),e.cerrarModalVerificarCuenta()):e.mostrarMensaje(a.message)})},e.abrirReporteProductos=function(){void 0!=e.filtro?(e.filtro.razon_social?e.razon_social=e.filtro.razon_social:e.razon_social=0,e.filtro.usuario?e.usuario_elegido=e.filtro.usuario:e.usuario_elegido=0,e.filtro.sucursal?e.sucursal=e.filtro.sucursal:e.sucursal=0,e.filtro.nit?e.nit=e.filtro.nit:e.nit=0,e.filtro.monto?e.monto=e.filtro.monto:e.monto=0,e.filtro.tipo_pago?e.tipo_pago=e.filtro.tipo_pago:e.tipo_pago=0,e.filtro.transaccion?e.transaccion=e.filtro.transaccion:e.transaccion=0,e.filtro.estado?e.estado=e.filtro.estado:e.estado=0):(e.razon_social=0,e.usuario_elegido=0,e.sucursal=0,e.nit=0,e.monto=0,e.tipo_pago=0,e.transaccion=0,e.estado=0);for(var a=0;a<e.sucursales.length;a++)e.sucursal?e.sucursal==e.sucursales[a].id?e.sucursal=e.sucursales[a].nombre:0==e.sucursal&&(e.sucursal="Todos"):e.sucursal="Todos";if(e.razonSocial?e.razonSocial:e.razonSocial="Todos",void 0===e.fechaInicioTexto&&void 0===e.fechaFinTexto)e.mostrarMensaje("Ingrese primero las fechas !");else{e.fechaInicioTexto,e.fechaFinTexto;e.obtenerDetalles(),e.abrirPopup(e.modalReportesProductos)}},e.obtenerDetalles=function(){e.paginator=S(),e.paginator.column="nombre",e.paginator.direccion="asc",e.filtroDetallesProducto={sucursalUsuario:e.sucursalesUsuario,inicio:e.fechaInicioTexto,fin:e.fechaFinTexto,sucursal:e.sucursal},e.paginator.callBack=e.filtrarDetalles,e.paginator.getSearch("",e.filtroDetallesProducto,null)},e.filtrarDetalles=function(){r.start(),p(e.paginator).then(function(a){e.ventasPopUp=a.ventas,e.paginator.setPages(a.paginas),r.stop()})},e.generarExcelVentasMensuales=function(){if(!0===e.verDetalle){r.start(),inicio=new Date(e.convertirFecha(e.fechaInicioTexto)),fin=new Date(e.convertirFecha(e.fechaFinTexto)),void 0!=e.filtro&&e.filtro.sucursal?e.sucursal=e.filtro.sucursal:e.sucursal=0,A(e.usuario.id_empresa,e.sucursal,inicio,fin).then(function(a){var t=JSON.parse(a.detallesVenta),o=[["FECHA DE LA FACTURA","N° DE LA FACTURA","N° DE AUTORIZACION","NIT/CI CLIENTE","NOMBRE O RAZON SOCIAL","UBICACION CLIENTE","CODIGO","DETALLE","UNIDAD","GRUPO","CANTIDAD","PU","TOTAL","IMPORTE ICE/IEHD/TASAS","EXPORTACIONES Y OPERACIONES EXENTAS","VENTAS GRAVADAS A TASA CERO","SUBTOTAL","DESCUENTOS, BONIFICACIONES Y REBAJAS OBTENIDAS","IMPORTE BASE PARA DEBITO FISCAL","DEBITO FISCAL","SUCURSAL","USUARIO"]];e.usuario.empresa.usar_vencimientos&&(o[0].push("FECHA VENCIMIENTO"),o[0].push("LOTE")),o[0].push("VENDEDOR");for(var i=0;i<t.length;i++){var n=[];t[i].venta.fecha=new Date(t[i].venta.fecha),n.push(t[i].venta.fecha),n.push(t[i].venta.factura),n.push(t[i].venta.autorizacion),n.push(t[i].venta.cliente.nit),n.push(t[i].venta.cliente.razon_social),n.push(t[i].venta.cliente.ubicacion_geografica),n.push(t[i].producto.codigo),n.push(t[i].producto.nombre),n.push(t[i].producto.unidad_medida),t[i].producto.grupo?n.push(t[i].producto.grupo.nombre):n.push(""),n.push(t[i].cantidad),n.push(t[i].precio_unitario),n.push(t[i].importe),n.push(t[i].ice),n.push(0),n.push(0),n.push(t[i].importe-t[i].ice);var c=t[i].importe-t[i].ice-t[i].excento+t[i].recargo;n.push(c),n.push(t[i].total),n.push(Math.round(.13*t[i].total*100)/100),n.push(t[i].venta.almacen.sucursal.nombre),n.push(t[i].venta.usuario.nombre_usuario),e.usuario.empresa.usar_vencimientos&&(t[i].inventario?(t[i].inventario.fecha_vencimiento=new Date(t[i].inventario.fecha_vencimiento),n.push(t[i].inventario.fecha_vencimiento),n.push(t[i].inventario.lote)):null!=t[i].lote?(t[i].fecha_vencimiento=new Date(t[i].fecha_vencimiento),n.push(t[i].fecha_vencimiento),n.push(t[i].lote)):(n.push(""),n.push(""))),n.push(t[i].venta.vendedor?t[i].venta.vendedor.persona.nombre_completo:""),o.push(n)}var s="SheetJS",l=new Workbook,d=sheet_from_array_of_arrays(o);l.SheetNames.push(s),l.Sheets[s]=d;var u=XLSX.write(l,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(u)],{type:"application/octet-stream"}),"VENTAS-MENSUALES.xlsx"),r.stop()})}else{r.start(),inicio=new Date(e.convertirFecha(e.fechaInicioTexto)),fin=new Date(e.convertirFecha(e.fechaFinTexto)),e.paginator.itemsPerPage=0;inicio,fin;p(e.paginator).then(function(a){e.ventasExcelDetalle=a.ventas;var t=[];t.push(["Producto","Unidad Medida","Cantidad","Monto"]);for(var o=0;o<e.ventasExcelDetalle.length;o++)columns=[],columns.push(e.ventasExcelDetalle[o].nombre),columns.push(e.ventasExcelDetalle[o].unidad_medida),columns.push(e.ventasExcelDetalle[o].cantidad),columns.push(e.ventasExcelDetalle[o].total),t.push(columns);var i="SheetJS",n=new Workbook,c=sheet_from_array_of_arrays(t);n.SheetNames.push(i),n.Sheets[i]=c;var s=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"VENTAS-DETALLE-PRODUCTO.xlsx"),r.stop()})}},e.generarPdfVentasMensuales=function(){if(!0===e.verDetalle){r.start(),inicio=new Date(e.convertirFecha(e.fechaInicioTexto)),fin=new Date(e.convertirFecha(e.fechaFinTexto)),void 0!=e.filtro&&e.filtro.sucursal?e.sucursal=e.filtro.sucursal:e.sucursal=0;var a=[inicio,fin,e.sucursal];A(e.usuario.id_empresa,e.sucursal,inicio,fin).then(function(t){var o=JSON.parse(t.detallesVenta),i=new PDFDocument({compress:!1,margin:10}),n=i.pipe(blobStream());i.font("Helvetica",8);var c=150,s=0,l=1;e.dibujarCabeceraPDFVentasMensuales(i,t,a,l);for(var d=0;d<o.length&&s<=15;d++)i.rect(40,c-10,540,40).stroke(),i.font("Helvetica",8),o[d].venta.fecha=new Date(o[d].venta.fecha),i.text(o[d].venta.fecha.getDate()+"/"+(o[d].venta.fecha.getMonth()+1)+"/"+o[d].venta.fecha.getFullYear().toString().substr(-2),45,c),i.text(o[d].venta.factura?o[d].venta.factura:"",80,c),i.font("Helvetica",7),i.text(o[d].venta.cliente.razon_social,115,c-2,{width:80}),i.text(o[d].producto.nombre,205,c-2,{width:80}),i.font("Helvetica",8),i.text(o[d].cantidad,300,c,{width:50}),i.text(o[d].producto.unidad_medida,330,c,{width:50}),e.usuario.empresa.usar_vencimientos&&o[d].inventario&&(o[d].inventario.fecha_vencimiento=new Date(o[d].inventario.fecha_vencimiento),i.text(o[d].inventario.fecha_vencimiento.getDate()+"/"+(o[d].inventario.fecha_vencimiento.getMonth()+1)+"/"+o[d].inventario.fecha_vencimiento.getFullYear().toString().substr(-2),385,c),i.text(o[d].inventario.lote,435,c)),i.text(o[d].descuento,475,c),i.text(o[d].recargo,505,c),i.text(o[d].total,535,c),c+=40,15!=++s&&d+1!=o.length||d+1==o.length||(i.addPage({margin:0,bufferPages:!0}),c=150,s=0,l+=1,e.dibujarCabeceraPDFVentasMensuales(i,t,a,l),i.font("Helvetica",8));var u=new Date,p=u.getMinutes();p<10&&(p="0"+p),i.text("USUARIO: "+e.usuario.nombre_usuario,45,c),i.text("IMPRESION : "+u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear()+" Hr. "+u.getHours()+":"+p,175,c),i.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),r.stop()})}else{r.start(),inicio=new Date(e.convertirFecha(e.fechaInicioTexto)),fin=new Date(e.convertirFecha(e.fechaFinTexto));a=[inicio,fin];p(e.paginator).then(function(t){e.ventaSinDetalle=t.ventas;var o=new PDFDocument({compress:!1,margin:10}),i=o.pipe(blobStream());o.font("Helvetica",8);var n=150,c=0,s=1,l=Math.ceil(e.ventaSinDetalle.length/20);e.dibujarCabeceraPDFVentasMensualesSinDetalle(o,e.ventaSinDetalle,a,s,l);for(var d=0,u=0;u<e.ventaSinDetalle.length&&c<=20;u++)d=u+1,o.font("Helvetica",8),o.text(d,45,n),o.font("Helvetica",8),o.text(e.ventaSinDetalle[u].nombre,65,n),o.font("Helvetica",8,{align:"center"}),o.text(e.ventaSinDetalle[u].unidad_medida,390,n),o.font("Helvetica",8),o.text(e.ventaSinDetalle[u].cantidad,470,n),o.font("Helvetica",8),o.text(e.ventaSinDetalle[u].total,500,n),n+=25,20!=++c&&u+1!=e.ventaSinDetalle.length||u+1==e.ventaSinDetalle.length||(o.addPage({margin:0,bufferPages:!0}),n=150,c=0,s+=1,e.dibujarCabeceraPDFVentasMensualesSinDetalle(o,e.ventaSinDetalle,a,s,l),o.font("Helvetica",8));var p=new Date,v=p.getMinutes();v<10&&(v="0"+v),o.text("USUARIO: "+e.usuario.nombre_usuario,45,750),o.text("IMPRESION : "+p.getDate()+"/"+(p.getMonth()+1)+"/"+p.getFullYear()+" Hr. "+p.getHours()+":"+v,175,750),o.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),r.stop()})}},e.dibujarCabeceraPDFVentasMensuales=function(e,a,t,o){e.font("Helvetica-Bold",12),e.text("REPORTE DE VENTAS",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+t.inicio,-70,40,{align:"center"}),e.text("Hasta "+t.fin,70,40,{align:"center"}),e.text("FOLIO "+o,550,25),e.rect(40,60,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("NOMBRE O RAZÓN SOCIAL : ",65,75),e.text("NIT : ",440,75),e.font("Helvetica",8),e.text(a.empresa.razon_social,195,75),e.text(a.empresa.nit,460,75),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,110,{width:40}),e.text("Nº De Nota",80,110,{width:30}),e.text("Cliente",115,110),e.text("Producto",205,110),e.text("Cant.",290,110),e.text("Unidad",330,110),e.text("Fecha Venc",385,110,{width:30}),e.text("Lote",435,110,{width:35}),e.text("Desc.",470,110),e.text("Rec.",500,110),e.text("Total",535,110)},e.dibujarCabeceraPDFVentasMensualesSinDetalle=function(e,a,t,o,i){e.font("Helvetica-Bold",12),e.text("REPORTE DE VENTAS POR PRODUCTOS SIN DETALLE",0,25,{align:"center"}),e.font("Helvetica",8),e.text("Desde  "+t.fechaInicioTexto,-70,40,{align:"center"}),e.text("Hasta "+t.fechaFinTexto,70,40,{align:"center"}),e.text("FOLIO "+o,550,25),e.rect(40,100,540,40).stroke(),e.font("Helvetica-Bold",8),e.text("N°",45,110),e.text("Producto",65,110),e.text("Unidad Medida.",370,110),e.text("Cantidad",450,110),e.text("Monto",500,110),e.font("Helvetica",8),e.text("Pagina "+o+" de "+i,500,750)},e.PopoverReportesRapido={templateUrl:"PopoverReportesRapido.html",title:"Reportes Rapidos",isOpen:!1},e.ImprimirSimpleReporte=function(a){r.start();var t;t=e.usuario.id_empresa,inicio=new Date(e.convertirFecha(e.fechaInicioTexto)),fin=new Date(e.convertirFecha(e.fechaFinTexto)),v(inicio,fin,t,a).then(function(a){e.detallePorProducto=a;var t=new PDFDocument({compress:!1,margin:10}),o=t.pipe(blobStream());t.font("Helvetica",8);var i=150,n=0,c=1,s=Math.ceil(e.detallePorProducto.length/20);e.dibujarCabeceraPDFDetalleProductos(t,a,c,s);for(var l=0,d=0;d<e.detallePorProducto.length&&n<=20;d++)l=d+1,t.font("Helvetica",8),t.text(l,45,i),t.font("Helvetica",8),t.text(e.detallePorProducto[d].venta.factura,65,i,{width:150}),t.font("Helvetica",8),e.detallePorProducto[d].venta.cliente&&(t.font("Helvetica",8),t.text(e.detallePorProducto[d].venta.cliente.razon_social,120,i)),t.font("Helvetica",8),t.text(e.detallePorProducto[d].cantidad,470,i),t.font("Helvetica",8),t.text(e.detallePorProducto[d].total,520,i),i+=30,20!=++n&&d+1!=e.detallePorProducto.length||d+1==e.detallePorProducto.length||(t.addPage({margin:0,bufferPages:!0}),i=150,n=0,c+=1,e.dibujarCabeceraPDFDetalleProductos(t,a,c,s),t.font("Helvetica",8));var u=new Date,p=u.getMinutes();p<10&&(p="0"+p),t.text("USUARIO: "+e.usuario.nombre_usuario,45,750),t.text("IMPRESION : "+u.getDate()+"/"+(u.getMonth()+1)+"/"+u.getFullYear()+" Hr. "+u.getHours()+":"+p,175,750),t.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),r.stop()})},e.dibujarCabeceraPDFDetalleProductos=function(a,t,o,i){a.font("Helvetica-Bold",12),a.text("DETALLE DEL PRODUCTO",0,25,{align:"center"}),a.font("Helvetica",8),a.text("Desde  "+e.fechaInicioTexto,-70,40,{align:"center"}),a.text("Hasta "+e.fechaFinTexto,70,40,{align:"center"}),a.font("Helvetica-Bold",8),a.text(t[0].producto.nombre,0,55,{align:"center"}),a.font("Helvetica-Bold",8),a.text("Codigo: "+t[0].producto.codigo,45,65),a.font("Helvetica-Bold",8),a.text("Unidad Medida: "+t[0].producto.unidad_medida,45,75),a.rect(40,100,540,40).stroke(),a.font("Helvetica-Bold",8),a.text("Nº",45,110),a.text("N° Factura",65,110),a.text("Razon Social",120,110),a.text("Cantidad",450,110),a.text("Monto",520,110),a.font("Helvetica",8),a.text("Pagina "+o+" de "+i,500,750)},e.abrirReporteGraficoProductos=function(){e.abrirPopup(e.modelGraficaProductos)},e.cerrarReporteGraficoProductos=function(){e.cerrarPopup(e.modelGraficaProductos)},e.graficarProductos=function(a){var t=a;r.start();var o=[];inicio=new Date(e.convertirFecha(e.fechaInicioTexto)),fin=new Date(e.convertirFecha(e.fechaFinTexto)),e.paginator.itemsPerPage=0,p(e.paginator).then(function(a){e.datosProductosGrafico=a.ventas.sort(function(e,a){return a.total-e.total});for(var i=0;i<e.datosProductosGrafico.length;i++){var n=[];n.push(e.datosProductosGrafico[i].nombre),n.push(e.datosProductosGrafico[i].unidad_medida),n.push(e.datosProductosGrafico[i].cantidad),n.push(e.datosProductosGrafico[i].total),o.push(n)}var c=[];contenido=o.map(function(e,a){c.length>=10||c.push(e)}),e.reporteGrafico(c,t),r.stop()})},e.reporteGrafico=function(a,t){e.abrirReporteGraficoProductos();var o=[];if(0!=a.length&&(o=a.map(function(e,a){return{label:e[0],y:e[3]}})),0==t)new CanvasJS.Chart("tablaReportes",{animationEnabled:!0,exportEnabled:!0,theme:"light1",title:{text:""},data:[{type:"column",indexLabelFontSize:10,dataPoints:o}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"white",labelMaxWidth:50,labelWrap:!0,interval:1}}).render();else if(1==t){new CanvasJS.Chart("tablaReportes",{animationEnabled:!0,exportEnabled:!0,theme:"light2",title:{text:""},data:[{type:"pie",startAngle:25,toolTipContent:"<b>{label}</b>: {y} Bs.",showInLegend:"true",legendText:"{label}",indexLabelFontSize:10,indexLabel:"{label} - {y} Bs.",dataPoints:o}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"black",labelMaxWidth:50,labelWrap:!0,interval:1}}).render()}},e.abrirReporteGraficoEmpresa=function(){e.abrirPopup(e.modelGraficaEmpresas)},e.cerrarReporteGraficoEmpresa=function(){e.cerrarPopup(e.modelGraficaEmpresas)},e.graficarEmpresa=function(a){var t=a;r.start();var o=[];inicio=new Date(e.convertirFecha(e.fechaInicioTexto)),fin=new Date(e.convertirFecha(e.fechaFinTexto)),e.paginator.itemsPerPage=0,q(e.paginator).then(function(a){e.datosReporteGraficoEmpresa=a.detalle.sort(function(e,a){return a.total-e.total});for(var i=0;i<e.datosReporteGraficoEmpresa.length;i++){var n=[];n.push(e.datosReporteGraficoEmpresa[i].razon_social),n.push(e.datosReporteGraficoEmpresa[i].total),o.push(n)}var c=[];o.map(function(e,a){c.length>=10||c.push(e)}),e.reporteGraficoEmpresas(c,t),r.stop()})},e.reporteGraficoEmpresas=function(a,t){e.abrirReporteGraficoEmpresa();var o=[];if(0!=a.length&&(o=a.map(function(e,a){return{label:e[0],y:e[1]}})),0==t)new CanvasJS.Chart("tablaReportesEmpresas",{animationEnabled:!0,exportEnabled:!0,theme:"light1",title:{text:""},data:[{type:"column",indexLabelFontSize:10,dataPoints:o}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"white",labelMaxWidth:50,labelWrap:!0,interval:1}}).render();else if(1==t){new CanvasJS.Chart("tablaReportesEmpresas",{animationEnabled:!0,exportEnabled:!0,theme:"light2",title:{text:""},data:[{type:"pie",startAngle:25,toolTipContent:"<b>{label}</b>: {y} Bs.",showInLegend:"true",legendText:"{label}",indexLabelFontSize:10,indexLabel:"{label} - {y} Bs.",dataPoints:o}],axisY:{prefix:"",suffix:" Bs."},axisX:{labelFontColor:"black",labelMaxWidth:50,labelWrap:!0,interval:1}}).render()}},e.cerrarReporteProductos=function(){e.cerrarPopup(e.modalReportesProductos)},e.verDetalle=!0,e.conDetalle=function(){!0===e.verDetalle?e.verDetalle=!1:!1===e.verDetalle&&(e.verDetalle=!0)},e.abrirReporteEmpresas=function(){e.fechaInicioTexto,e.fechaFinTexto,e.idEmpresa=e.usuario.id_empresa,void 0!=e.filtro&&e.filtro.sucursal?e.sucursalSelec=e.filtro.sucursal:e.sucursalSelec=0;for(var a=0;a<e.sucursales.length;a++)e.sucursal?e.sucursal==e.sucursales[a].id?e.sucursal=e.sucursales[a].nombre:0==e.sucursal&&(e.sucursal="Todos"):e.sucursal="Todos";e.razonSocial?e.razonSocial:e.razonSocial="Todos",void 0===e.fechaInicioTexto&&void 0===e.fechaFinTexto?e.mostrarMensaje("Ingrese primero las fechas !"):(e.obtenerDetallesEmpresa(),e.abrirReportePorEmpresa())},e.obtenerDetallesEmpresa=function(){e.paginator=S(),e.paginator.column="razon_social",e.paginator.direccion="asc",e.filtroDetallesProducto={idsSucursales:e.sucursalesUsuario,inicio:e.fechaInicioTexto,fin:e.fechaFinTexto,sucursal:e.sucursalSelec,idEmpresa:e.idEmpresa},e.paginator.callBack=e.filtroDetalleEmpresa,e.paginator.getSearch("",e.filtroDetallesProducto,null)},e.filtroDetalleEmpresa=function(){r.start(),q(e.paginator).then(function(a){e.detalleEmpresa=a.detalle,e.paginator.setPages(a.paginas),r.stop()})},e.imprimirSimpleReporteEmpresa=function(a){r.start();var t;t=e.usuario.id_empresa,inicio=new Date(e.convertirFecha(e.fechaInicioTexto)),fin=new Date(e.convertirFecha(e.fechaFinTexto)),m(inicio,fin,t,a).then(function(a){e.detallePorEmpresa=a;var t=new PDFDocument({compress:!1,margin:10}),o=t.pipe(blobStream());t.font("Helvetica",8);var i=150,n=0,c=1,s=Math.ceil(e.detallePorEmpresa.length/20);e.dibujarCabeceraPDFDetalleEmpresas(t,a,c,s);for(var l=0,d=0;d<e.detallePorEmpresa.length&&n<=20;d++){columns=[],e.producto=e.detallePorEmpresa[d];for(var u=0;u<e.producto.detallesVenta.length;u++)e.DetalleVenta=e.producto.detallesVenta[u],t.font("Helvetica"),l=d+1,t.text(l,45,i),t.text(e.DetalleVenta.venta.factura,65,i),t.text(e.producto.nombre,120,i),t.text(e.DetalleVenta.cantidad,465,i),t.text(e.DetalleVenta.total,520,i),i+=30,20!=++n&&u+1!=e.detallePorEmpresa.length||u+1==e.detallePorEmpresa.length||(t.addPage({margin:0,bufferPages:!0}),i=150,n=0,c+=1,e.dibujarCabeceraPDFDetalleProductos(t,a,c,s),t.font("Helvetica",8))}var p=new Date,v=p.getMinutes();v<10&&(v="0"+v),t.text("USUARIO: "+e.usuario.nombre_usuario,45,750),t.text("IMPRESION : "+p.getDate()+"/"+(p.getMonth()+1)+"/"+p.getFullYear()+" Hr. "+p.getHours()+":"+v,175,750),t.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),r.stop()})},e.dibujarCabeceraPDFDetalleEmpresas=function(a,t,o,i){a.font("Helvetica-Bold",12),a.text("VENTAS",0,25,{align:"center"}),a.font("Helvetica",8),a.text("Desde  "+e.fechaInicioTexto,-70,40,{align:"center"}),a.text("Hasta "+e.fechaFinTexto,70,40,{align:"center"}),a.font("Helvetica-Bold",8),a.text(t[0].detallesVenta[0].venta.cliente.razon_social,0,55,{align:"center"}),a.font("Helvetica-Bold",8),a.text("Codigo: "+t[0].codigo,45,65),a.font("Helvetica-Bold",8),a.rect(40,100,540,40).stroke(),a.font("Helvetica-Bold",8),a.text("Nº",45,110),a.text("N° Factura",65,110),a.text("Producto",120,110),a.text("Cantidad",450,110),a.text("Monto",520,110),a.font("Helvetica",8),a.text("Pagina "+o+" de "+i,500,750)},e.abrirReportePorEmpresa=function(){e.abrirPopup(e.modalReportesEmpresas)},e.cerrarReportePorEmpresa=function(){e.cerrarPopup(e.modalReportesEmpresas)},e.modificarVenta=function(a){$("#modal-wizard-venta-edicion").dialog({closeOnEscape:!1}),e.blockerVenta=!0,e.venta=new d(a),e.venta.editable=!0,e.venta.movimientoActual=Object.assign({},a.movimiento);var t;e.venta.sucursal=a.almacen.sucursal,t=a.almacen,e.venta.sucursal&&(e.obtenerAlmacenesActividades(e.venta.sucursal.id),t.id&&(e.venta.almacen=t)),e.venta.detallesVenta.forEach(function(e){e.eliminado=!1}),e.venta.movimiento=e.venta.movimiento.clase,e.obtenerTipoEgreso(e.venta.movimiento);var o=new Date(e.venta.fecha);e.venta.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),e.cambiarTipoPago(e.venta),e.editar_precio=!1,e.detalleVenta={eliminado:!1,producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},e.abrirPopup(e.idModalWizardCompraEdicion),angular.element(s).unbind("keydown"),angular.element(s).bind("keydown",function(a){115==a.keyCode&&e.venderProformaDirectoNormal(e.venta)}),e.venta.id_empresa=e.usuario.id_empresa,e.enfocar("nit")},e.abrirmodalServicioVenta=function(){e.servicio={habilitado:!0,eliminado:!1},e.abrirPopup(e.modalServicioVenta)},e.cerrarmodalServicioVenta=function(){e.cerrarPopup(e.modalServicioVenta)},e.abrirModalImportacionVentaServicio=function(){e.venta={sucursal:"",actividad:"",fecha:"",movimiento:{nombre_corto:"SERV"}},e.obtenerListaServiciosVentas(),e.abrirPopup(e.modelImportacionVentaServicio)},e.cerrarModalImportacionVentaServicio=function(){e.cerrarPopup(e.modelImportacionVentaServicio)},e.obtenerListaServiciosVentas=function(){Y(e.usuario.id_empresa).then(function(a){e.serviciosVentas=a.servicios})},e.establecerServicioSeleccionado=function(a){e.establecerServicio(a),e.cerrarmodalServicioVenta()},e.establecerServicio=function(a){e.detalleVenta={centroCosto:null,servicio:a,importe:a.precio,descuento:a.descuento,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,eliminado:!1},e.enfocar("cantidad")},e.agregarServicioVenta=function(a){a.id?e.servicio={habilitado:!0,eliminado:!1}:a.edit?e.servicio={habilitado:!0,eliminado:!1}:(e.serviciosVentas.push(a),e.servicio={habilitado:!0,eliminado:!1})},e.modificarServicioVenta=function(a){e.servicio=a,e.servicio.edit=!0},e.cancelarEdicionVentaServicio=function(a){e.servicio={habilitado:!0,eliminado:!1}},e.guardarServiciosVenta=function(a){J(e.usuario.id_empresa,a).then(function(a){e.obtenerListaServiciosVentas(),e.mostrarMensaje(a.mensaje),e.cerrarmodalServicioVenta()})},e.verificarCamposForimImpServ=function(e){e.activ.$touched=!!e.activ.$invalid,e.fechaSerImp.$touched=!!e.fechaSerImp.$invalid,e.sucServImp.$touched=!!e.sucServImp.$invalid},e.subirExcelVentasServicios=function(a){var t,o,i=a.target.files;for(o=i[t=0];t!=i.length;++t){var n=new FileReader;o.name;n.onload=function(a){var t=a.target.result,o=XLSX.read(t,{type:"binary"}),i=o.SheetNames[0],n=2,r=0,c=2,s=o.Sheets[i],l=[],d=[],u=[];do{c=2;var p={tipoPago:{},detallesVenta:[],cliente:{},fechaTexto:e.venta.fecha,sucursal:e.venta.sucursal,actividad:e.venta.actividad},v=void 0!=s["A"+n]&&""!=s["A"+n]?s["A"+n].v.toString():null;if(2==n)var m=void 0!=s["A"+n]&&""!=s["A"+n]?s["A"+n].v.toString():null;else m=void 0!=s["A"+(n-1)]&&""!=s["A"+(n-1)]?s["A"+(n-1)].v.toString():null;p.cliente.nit=void 0!=s["B"+n]&&""!=s["B"+n]?s["B"+n].v.toString():null,p.cliente.razon_social=void 0!=s["C"+n]&&""!=s["C"+n]?s["C"+n].v.toString():null;var f=!1;if(u.length>0){for(r=0;r<u.length;r++){var g=u[r].nit;null!=p.cliente.nit&&g==p.cliente.nit&&(f=!0)}f||u.push(p.cliente)}else u.push(p.cliente);p.vendedor=void 0!=s["D"+n]&&""!=s["D"+n]?s["D"+n].v.toString():null,p.observacion=void 0!=s["E"+n]&&""!=s["E"+n]?s["E"+n].v.toString():null,p.tipoPago.nombre=void 0!=s["F"+n]&&""!=s["F"+n]?s["F"+n].v.toString():null,p.dias_credito=void 0!=s["G"+n]&&""!=s["G"+n]?parseInt(s["G"+n].v.toString()):null,p.a_cuenta=void 0!=s["H"+n]&&""!=s["H"+n]?parseFloat(s["H"+n].v.toString()):null;do{var h={servicio:{}};h.servicio.nombre=void 0!=s["I"+c]&&""!=s["I"+c]?s["I"+c].v.toString():null,h.servicio.precio=void 0!=s["K"+c]&&""!=s["K"+c]?parseFloat(s["K"+c].v.toString()):null,h.servicio.id_empresa=e.usuario.id_empresa;f=!1;if(d.length>0){for(r=0;r<d.length;r++){g=d[r].nombre;null!=h.servicio.nombre&&g==h.servicio.nombre&&(f=!0)}f||d.push(h.servicio)}else d.push(h.servicio);if(h.observaciones=void 0!=s["J"+c]&&""!=s["J"+c]?s["J"+c].v.toString():null,h.importe=void 0!=s["K"+c]&&""!=s["K"+c]?parseFloat(s["K"+c].v.toString()):null,h.descuento=void 0!=s["L"+c]&&""!=s["L"+c]?parseFloat(s["L"+c].v.toString()):null,h.tipo_recargo=void 0!=s["M"+c]&&""!=s["M"+c]?parseFloat(s["M"+c].v.toString()):null,h.recargo=void 0!=s["N"+c]&&""!=s["N"+c]?parseFloat(s["N"+c].v.toString()):null,h.ice=void 0!=s["O"+c]&&""!=s["O"+c]?parseFloat(s["O"+c].v.toString()):null,h.excento=void 0!=s["P"+c]&&""!=s["P"+c]?parseFloat(s["P"+c].v.toString()):null,v==(void 0!=s["A"+c]&&""!=s["A"+c]?s["A"+c].v.toString():null)){var P=h.recargo;"%"==h.tipo_recargo&&(P=e.detalleVenta.importe*(h.recargo/100));var b=e.serviciosVentas.filter(function(e){return e.nombre==h.servicio.nombre});b.length>0&&(h.servicio=b[0]),h.total=Math.round(1e3*(h.importe-h.descuento+P-h.ice-h.excento))/1e3,p.detallesVenta.push(h)}c++}while(void 0!=s["A"+c]);if(v!=m||2==n){var _=0;for(r=0;r<p.detallesVenta.length;r++)p.detallesVenta[r].eliminado||(_+=p.detallesVenta[r].importe);p.importe=Math.round(1e3*_)/1e3;var D=0;for(r=0;r<p.detallesVenta.length;r++)p.detallesVenta[r].eliminado||(D+=p.detallesVenta[r].total);p.total=Math.round(1e3*D)/1e3,p.pagado=p.total;var C=e.tiposPago.filter(function(e){return e.nombre==p.tipoPago.nombre});p.tipoPago=C[0],"CREDITO"==p.tipoPago.nombre?p.saldo=p.total-p.a_cuenta:p.saldo=null,p.cambio=0,p.id_usuario=e.usuario.id;var V=e.movimientosEgreso.filter(function(a){return a.nombre_corto==e.diccionario.EGRE_SERVICIO}),x=e.vendedores.filter(function(e){return e.persona.nombre_completo==p.vendedor});x.length>0&&(p.vendedor=x[0]),p.movimiento=V[0],p.id_empresa=e.usuario.id_empresa,p.fecha=new Date(e.convertirFecha(p.fechaTexto)),l.push(p)}n++,r++}while(void 0!=s["A"+n]);e.guardarImportacionVentasServicios(l,d,u)},n.readAsBinaryString(o)}},e.guardarImportacionVentasServicios=function(a,t,o){r.start(),z(a,t,o).then(function(a){r.stop(),e.mostrarMensaje(a.mensaje)})},e.obtenerCotizaciones=function(){e.paginator=S(),e.paginator.column="nombre",e.paginator.direction="desc",e.paginator.callBack=e.obtenerLista,e.filtro={empresa:e.usuario.id_empresa,inicio:"",fin:"",fecha_inicio:new Date(e.convertirFecha("14/08/2018")),fecha_fin:new Date(e.convertirFecha("27/08/2018")),busqueda:"",importe:0},e.paginator.getSearch("",e.filtro,null)},e.obtenerLista=function(){r.start(),Z(e.paginator).then(function(a){console.log("llegooo  cotissssssss",a),e.paginator.setPages(a.paginas),e.cotizaciones=a.cotizaciones,r.stop()})},e.abrirPopupCotizaciones=function(){e.obtenerCotizaciones(),e.abrirPopup(e.idModalCotizaciones)},e.cerrarPopupCotizaciones=function(){e.cerrarPopup(e.idModalCotizaciones)},e.obtenerDetalleCotizacion=function(a,t){e.editCoticacion=t,console.log("datos usuarioooooooo ",e.usuario);for(var o=0;o<a.detallesCotizacion.length;o++){var i=a.detallesCotizacion[o].producto,n=e.obtenerInventarioTotal(i);a.detallesCotizacion[o].disponible=n,a.detallesCotizacion[o].aceptar=!1,n<a.detallesCotizacion[o].cantidad?(a.detallesCotizacion[o].faltante=a.detallesCotizacion[o].cantidad-n,a.detallesCotizacion[o].entregar=n):(a.detallesCotizacion[o].faltante=0,a.detallesCotizacion[o].entregar=a.detallesCotizacion[o].cantidad),a.detallesCotizacion[o].entregar>0&&(a.detallesCotizacion[o].aceptar=!0),a.detallesCotizacion[o].faltante>0&&(a.detallesCotizacion[o].aceptar=!1),a.detallesCotizacion[o].total=a.detallesCotizacion[o].entregar*a.detallesCotizacion[o].precio_unitario,console.log("disponibleeeeee ",n)}console.log("la cotizacvion recibidooo ",a.detallesCotizacion),e.cotizacion=a,e.abrirPopup(e.idModalDetalleCotizaciones)},e.isCheckedCotizacion=function(e){if(e)for(var a in e.detallesCotizacion){if(e.detallesCotizacion[a].aceptar)return!1}return!0},e.cerrarPopupDetalleCotizaciones=function(){e.cerrarPopup(e.idModalDetalleCotizaciones)},e.aceptarDetalleCotizacion=function(e){e.aceptar=!0},e.cancelarDetalleCotizacion=function(e){e.aceptar=!1},e.agregarVentaCotizacion=function(a){console.log("la cotizacion para venta",a),e.obtenerAlmacenesActividades(a.sucursal.id);var t=new Date;a.fecha=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear(),e.detalleVenta=[];for(var o=0,i=0;i<a.detallesCotizacion.length;i++)if(a.detallesCotizacion[i].aceptar){var n={eliminado:!1,producto:a.detallesCotizacion[i].producto,precio_unitario:a.detallesCotizacion[i].precio_unitario,costos:a.detallesCotizacion[i].producto.activar_inventario?a.detallesCotizacion[i].producto.inventarios:[],cantidad:a.detallesCotizacion[i].cantidad,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1,importe:a.detallesCotizacion[i].importe,total:a.detallesCotizacion[i].total};o+=a.detallesCotizacion[i].total,e.detalleVenta.push(n)}e.venta=new d({id_empresa:e.usuario.id_empresa,id_usuario:e.usuario.id,cliente:a.cliente,sucursal:a.sucursal,almacen:a.almacen,fechaTexto:a.fecha,tipoPago:e.tiposPago[0],cotizacion_id:a.id,actualizarCotizacion:!0,detallesVenta:e.detalleVenta,detallesVentaNoConsolidadas:[],pagado:o,cambio:0,despachado:!1,vendedor:null,total:o}),e.cerrarPopupDetalleCotizaciones(),e.cerrarPopupCotizaciones()},e.editarDetalleCotizacion=function(a){e.Cprecio_unitario=a.precio_unitario,e.c=a,e.abrirPopup(e.idModalDetalleCotizacionEditar)},e.guardarEditarCotizacion=function(a){e.c=a,e.cerrarPopupCotizacionEditar()},e.cancelarPopupCotizacionEditar=function(a){e.c.precio_unitario=e.Cprecio_unitario,e.cerrarPopup(e.idModalDetalleCotizacionEditar)},e.cerrarPopupCotizacionEditar=function(){e.cerrarPopup(e.idModalDetalleCotizacionEditar)},e.$on("$routeChangeStart",function(a,t){e.eliminarPopup(e.idModalWizardCompraEdicion),e.eliminarPopup(e.idModalWizardVentaVista),e.eliminarPopup(e.idModalEliminarCompra),e.eliminarPopup(e.idModalPago),e.eliminarPopup(e.idModalCierre),e.eliminarPopup(e.idModalPanelVentas),e.eliminarPopup(e.idModalInventario),e.eliminarPopup(e.idModalPanelVentasCobro),e.eliminarPopup(e.idModalEdicionVendedor),e.eliminarPopup(e.idModalImpresionVencimiento),e.eliminarPopup(e.IdModalVerificarCuenta),e.eliminarPopup(e.modalReportesProductos),e.eliminarPopup(e.modelGraficaProductos),e.eliminarPopup(e.modalServicioVenta),e.eliminarPopup(e.modelImportacionVentaServicio),e.eliminarPopup(e.idModalCotizaciones),e.eliminarPopup(e.idModalDetalleCotizaciones),e.eliminarPopup(e.idModalDetalleCotizacionEditar)}),e.UsarLectorDeBarra=function(){if(1==e.usuario.usar_lector_de_barra){e.usuario.usar_lector_de_barra=!0,t.usuario=JSON.stringify(e.usuario);j(e.usuario)}else{e.usuario.usar_lector_de_barra=!1,localStorage.usuario=JSON.stringify(e.usuario);j(e.usuario)}},e.inicio()}]);