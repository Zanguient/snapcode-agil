angular.module("agil.controladores").controller("ControladoresFarmacia",["$scope","$localStorage","$location","$templateCache"," $route","$filter","$window","$timeout","blockUI","ClasesTipo","ConfiguracionVentaVistaDatos","ProductosPanel","InventarioPaginador","ListaInventariosProducto","ListaProductosEmpresa","Venta","PacientesNit","ImprimirSalidaFarmacia","Ventas","VentasFarmacia","DatosVentaFarmacia","VentaEmpresaDatos","VentaFarmacia",function(e,a,t,o,n,i,r,c,s,l,u,d,p,m,v,f,g,h,b,P,_,D,V){e.usuario=JSON.parse(a.usuario),convertUrlToBase64Image(e.usuario.empresa.imagen,function(a){e.usuario.empresa.imagen=a}),e.idModalWizardFarmaciaEdicion="modal-wizard-farmacia-edicion",e.idModalInventario="dialog-productos-venta",e.idModalWizardVentaVista="modal-wizard-venta-vista",e.idModalPago="dialog-pago",e.$on("$viewContentLoaded",function(){ejecutarScriptsFarmacia(e.idModalWizardFarmaciaEdicion,e.idModalInventario,e.idModalWizardVentaVista,e.idModalPago)}),e.inicio=function(){e.ordenProductos=!0,e.esContado=!0,e.obtenerCargos(),e.obtenerTiposDePago(),e.obtenerConfiguracionVentaVista(),e.sucursales=e.obtenerSucursales(),e.sucursalesUsuario="";for(var a=0;a<e.usuario.sucursalesUsuario.length;a++)e.sucursalesUsuario=e.sucursalesUsuario+e.usuario.sucursalesUsuario[a].sucursal.id,a+1!=e.usuario.sucursalesUsuario.length&&(e.sucursalesUsuario=e.sucursalesUsuario+",");e.obtenerMovimientosEgreso(),e.detalleVenta={producto:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1}},e.obtenerTiposDePago=function(){s.start(),l("TIPA").then(function(a){e.tiposPago=a.clases,s.stop()})},e.obtenerConfiguracionVentaVista=function(){s.start(),u(e.usuario.id_empresa).then(function(a){e.configuracionVentaVista=a,s.stop()})},e.obtenerSucursales=function(){for(var a=[],t=0;t<e.usuario.sucursalesUsuario.length;t++)a.push(e.usuario.sucursalesUsuario[t].sucursal);return a},e.obtenerMovimientosEgreso=function(){s.start(),l("MOVEGR").then(function(a){console.log("la entidada es  ",a.clases),e.movimientosEgreso=i("filter")(a.clases,function(e){return"PROFORMA"==e.nombre||"PRE_FACTURACION"==e.nombre||"PLANILLA_ANTICIPOS"==e.nombre}),s.stop()})},e.obtenerTipoEgreso=function(a){var t=a.nombre_corto;e.tipoEgreso=t},e.obtenerAlmacenesActividades=function(a){e.obtenerAlmacenes(a),e.obtenerActividades(a)},e.obtenerAlmacenes=function(a){e.almacenes=[];var t=$.grep(e.sucursales,function(e){return e.id==a})[0];e.almacenes=t.almacenes,e.venta.almacen=1==e.almacenes.length?e.almacenes[0]:null,e.venta.almacen&&e.cargarProductos()},e.cargarProductos=function(){d(e.usuario.id_empresa,e.venta.almacen.id).then(function(t){for(var o=0;o<t.length;o++)t[o].activar_inventario&&(t[o].inventario_disponible=e.obtenerInventarioTotal(t[o]));if(e.productos=t,angular.isDefined(a.productosProcesados)){e.productosProcesados=t;for(o=0;o<a.productosProcesados.length;o++)for(var n=0;n<e.productosProcesados.length;n++)a.productosProcesados[o].id==e.productosProcesados[n].id&&(e.productosProcesados[n].rankin=a.productosProcesados[o].rankin)}else e.productosProcesados=t;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},e.obtenerActividades=function(a){e.actividades=[];var t=$.grep(e.sucursales,function(e){return e.id==a})[0];e.actividadesDosificaciones=t.actividadesDosificaciones,e.actividades=[];for(var o=0;o<e.actividadesDosificaciones.length;o++)e.actividades.push(e.actividadesDosificaciones[o].actividad);e.venta.actividad=1==e.actividades.length?e.actividades[0]:null},e.buscarInventarios=function(a,t,o,n,i,r,c){s.start(),e.itemsPorPagina=o,""==n||null==n?n=0:e.textoBusqueda=n,e.paginaActual=t,p(e.usuario.id_empresa,a,t,o,n,i,r,c).then(function(a){for(var t=a.productos,o=0;o<t.length;o++){t[o].fecha_vencimiento=new Date(t[o].fecha_vencimiento),t[o].cantidad_total=t[o].cantidad}e.paginas=[];for(o=1;o<=a.paginas;o++)e.paginas.push(o);e.productos=t,s.stop()})},e.buscarProducto=function(a){if(""!=a&&void 0!=a)return v(e.usuario.id_empresa,a)},e.establecerProducto=function(a){a.tipoProducto=null==a.tipoProducto?{id:a["tipoProducto.id"],nombre:a["tipoProducto.nombre"],nombre_corto:a["tipoProducto.nombre_corto"]}:a.tipoProducto,e.editar_precio=!1,m(a.id,e.venta.almacen.id).then(function(t){a.inventarios=t;for(var o=0;o<a.inventarios.length;o++)a.inventarios[o].fecha_vencimiento=a.inventarios[o].fecha_vencimiento?new Date(a.inventarios[o].fecha_vencimiento):null,a.inventarios[o].fechaVencimientoTexto=a.inventarios[o].fecha_vencimiento?a.inventarios[o].fecha_vencimiento.getDate()+"/"+(a.inventarios[o].fecha_vencimiento.getMonth()+1)+"/"+a.inventarios[o].fecha_vencimiento.getFullYear():"",a.inventarios[o].detallesMovimiento[0].movimiento.fecha=new Date(a.inventarios[o].detallesMovimiento[0].movimiento.fecha),a.inventarios[o].detallesMovimiento[0].movimiento.fechaTexto=a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+a.inventarios[o].detallesMovimiento[0].movimiento.fecha.getFullYear();e.inventariosDisponibleProducto=[],e.inventariosDisponibleProducto.push({id:0,fecha_vencimiento:"TODOS",fechaVencimientoTexto:"TODOS"}),e.inventariosDisponibleProducto=e.inventariosDisponibleProducto.concat(a.inventarios);var n=e.obtenerInventarioTotal(a);e.detalleVenta={producto:a,precio_unitario:a.precio_unitario,inventarioProducto:e.inventariosDisponibleProducto[0],inventario_disponible:n,costos:a.activar_inventario?a.inventarios:[],cantidad:1,descuento:a.descuento,recargo:0,ice:0,excento:0,tipo_descuento:a.descuento>0,tipo_recargo:!1},e.colorearInventarioDisponible(n,a),e.calcularImporte(),e.cerrarPopup(e.idModalInventario),e.enfocar("cantidad")})},e.obtenerInventarioTotal=function(a){var t=0;if(a.activar_inventario){for(var o=0;o<a.inventarios.length;o++)t+=a.inventarios[o].cantidad;for(var n=0;n<e.venta.detallesVenta.length;n++)e.venta.detallesVenta[n].producto.id==a.id&&(t-=e.venta.detallesVenta[n].cantidad)}else t=5e5;return t},e.colorearInventarioDisponible=function(a,t){0==a?(e.porcentaje="100",e.color="red"):a>3*t.inventario_minimo+1?(e.porcentaje="100",e.color="green"):a>2*t.inventario_minimo+1?(e.porcentaje="75",e.color="green"):a>1.5*t.inventario_minimo+1?(e.porcentaje="50",e.color="green"):a==t.inventario_minimo+1?(e.porcentaje="38",e.color="yellow"):a==t.inventario_minimo?(e.porcentaje="25",e.color="red"):a<t.inventario_minimo&&a>0&&(e.porcentaje="12",e.color="red")},e.actualizarInventarioDisponibleFechaVencimiento=function(a){0!=a.inventarioProducto.id?(a.costos=[],a.costos.push(a.inventarioProducto),a.inventario_disponible=e.obtenerInventarioTotalPorFechaVencimiento(a),a.lote=a.inventarioProducto.lote):(a.inventario_disponible=e.obtenerInventarioTotal(a.producto),a.costos=a.producto.inventarios,a.lote=""),e.colorearInventarioDisponible(a.inventario_disponible,a.producto),e.calcularImporte()},e.enfocar=function(e){c(function(){$("#"+e).focus()},0)},e.interceptarTecla=function(a,t,o){13===a.which&&(o?e.enfocar(t):c(function(){$("#"+t).trigger("click")},0))},e.establecerCliente=function(a,t,o){console.log("el clientes es ::::: ",a),e.$model=t,e.$label=o,e.venta.cliente.id=a.id,e.venta.cliente.razon_social=a.persona.nombre_completo,e.venta.cliente.nit=parseInt(a.persona.ci),e.venta.cliente.campo=a.campo,e.venta.cliente.cargos=a.cargos,e.venta.cliente.designacion_empresa=a.designacion_empresa,e.enfocar("razon_social"),e.$apply()},e.obtenerInventarioTotalPorFechaVencimiento=function(a){for(var t=a.inventarioProducto.cantidad,o=0;o<e.venta.detallesVenta.length;o++)e.venta.detallesVenta[o].producto.id==a.producto.id&&e.venta.detallesVenta[o].costos[0].id==a.inventarioProducto.id&&(t-=e.venta.detallesVenta[o].cantidad);return t},e.agregarDetalleVenta=function(a){if(a.producto.activar_inventario)if(a.costos.length>1)for(var t=a.cantidad,o=0,n=JSON.parse(JSON.stringify(a));o<a.costos.length&&t>0;){a.inventarioProducto=a.costos[o];var i=e.obtenerInventarioTotalPorFechaVencimiento(a);if(i>0){var r,c=JSON.parse(JSON.stringify(n));o>0&&(c.descuento=0,c.recargo=0,c.ice=0,c.excento=0),e.detalleVenta=c,t>i?(r=i,t-=i):(r=t,t=0),c.cantidad=r,c.fecha_vencimiento=a.costos[o].fecha_vencimiento,c.lote=a.costos[o].lote,c.costos=[],c.costos.push(a.costos[o]),c.inventario=a.costos[o],e.calcularImporte(),e.venta.detallesVenta.push(c)}o++}else a.fecha_vencimiento=a.costos[0].fecha_vencimiento,a.lote=a.costos[0].lote,a.inventario=a.costos[0],e.venta.detallesVenta.push(a);else e.venta.detallesVenta.push(a);e.inventariosDisponibleProducto=[],e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.detalleVenta={producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},e.enfocar("id_producto")},e.eliminarDetalleVenta=function(a){e.venta.detallesVenta.splice(e.venta.detallesVenta.indexOf(a),1),e.sumarTotal(),e.sumarTotalImporte(),e.calcularSaldo(),e.calcularCambio(),e.capturarInteraccion()},e.cambiarTipoPago=function(a){var t=$.grep(e.tiposPago,function(e){return e.id==a.id})[0];e.esContado="CONT"==t.nombre_corto,e.calcularCambio()},e.recalcular=function(){e.calcularImporte()},e.calcularCambio=function(){e.esContado?(e.venta.cambio=Math.round(100*(e.venta.pagado-e.venta.total))/100,e.pagoMinimo=e.venta.total):(e.venta.cambio=0,e.pagoMinimo=0)},e.calcularImporte=function(){var a,t;e.detalleVenta.importe=Math.round(e.detalleVenta.cantidad*e.detalleVenta.precio_unitario*1e3)/1e3,a=e.detalleVenta.tipo_descuento?e.detalleVenta.importe*(e.detalleVenta.descuento/100):e.detalleVenta.descuento,t=e.detalleVenta.tipo_recargo?e.detalleVenta.importe*(e.detalleVenta.recargo/100):e.detalleVenta.recargo,e.detalleVenta.total=Math.round(1e3*(e.detalleVenta.importe-a+t-e.detalleVenta.ice-e.detalleVenta.excento))/1e3},e.sumarTotalImporte=function(){for(var a=0,t=0;t<e.venta.detallesVenta.length;t++)a+=e.venta.detallesVenta[t].importe;e.venta.importe=Math.round(1e3*a)/1e3},e.sumarTotal=function(){for(var a=0,t=0;t<e.venta.detallesVenta.length;t++)a+=e.venta.detallesVenta[t].total;e.venta.total=Math.round(1e3*a)/1e3,e.venta.pagado=e.venta.total},e.calcularSaldo=function(){e.venta.saldo=e.venta.total-e.venta.a_cuenta},e.modificarPrecio=function(){e.editar_precio=!0},e.establecerPrecio=function(){e.editar_precio=!1},e.crearNuevaVenta=function(){e.venta=new V({id_empresa:e.usuario.id_empresa,id_usuario:e.usuario.id,cliente:{},detallesVenta:[],detallesVentaNoConsolidadas:[],pagado:0,cambio:0,despachado:!1,vendedor:null}),e.venta.sucursal=1==e.sucursales.length?e.sucursales[0]:null,e.venta.sucursal&&e.obtenerAlmacenesActividades(e.venta.sucursal.id),e.venta.movimiento=e.movimientosEgreso[0],e.obtenerTipoEgreso(e.venta.movimiento);var a=new Date;e.venta.fechaTexto=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear(),e.venta.tipoPago=e.tiposPago[0],e.cambiarTipoPago(e.venta.tipoPago),e.editar_precio=!1,e.detalleVenta={producto:{activar_inventario:!0},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},e.abrirPopup(e.idModalWizardFarmaciaEdicion),e.enfocar("nit")},e.buscarCliente=function(a){if(""!=a&&void 0!=a)return g(e.usuario.id_empresa,a)},e.cerrarPopupFarmaciaEdicion=function(){e.cerrarPopup(e.idModalWizardFarmaciaEdicion)},e.abrirPopupInventario=function(){e.abs=r.Math.abs,e.itemsPorPagina=10,e.paginaActual=1,e.columna="nombre",e.direccion="asc",e.cantidadInv="0",e.textoBusqueda="",e.venta.almacen&&(e.almacenBusqueda=e.venta.almacen,e.buscarInventarios(e.almacenBusqueda.id,e.paginaActual,e.itemsPorPagina,e.textoBusqueda,e.columna,e.direccion,e.cantidadInv)),e.abrirPopup(e.idModalInventario)},e.obtenerCargos=function(){s.start(),l("RRHH_CARGO").then(function(a){var t=a.clases;e.llenarCargos(t),s.stop()})},e.llenarCargos=function(a){e.nuevoRH="",e.cargos=[];for(var t=0;t<a.length;t++){var o={nombre:a[t].nombre,maker:"",ticked:!1,id:a[t].id};e.cargos.push(o)}},e.obtenerVentas=function(){var a=new Date,t=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear();e.filtrarVentas(e.sucursalesUsuario,t,t)},e.filtrarVentas=function(a,t,o,n,i,r,c,l,u,d,p){n=""==n||void 0==n?0:n,i=""==i||void 0==i?0:i,r=null==r||void 0==r?0:r,c=void 0==c?0:c,l=""==l||void 0==l?0:l,u=null==u||void 0==u?0:u,d=""==d||void 0==d?0:d,p=""==p||null==p||void 0==p?0:p,s.start(),0!=c&&(e.tipoPagod=$.grep(e.tiposPago,function(e){return e.id==c}).length>0?$.grep(e.tiposPago,function(e){return e.id==c})[0].nombre:"todos"),t=new Date(e.convertirFecha(t)),o=new Date(e.convertirFecha(o)),P(a,t,o,n,i,r,c,l,u,d,p).then(function(a){e.ventas=a,s.stop()})},e.verVenta=function(a){e.venta=a,e.abrirPopup(e.idModalWizardVentaVista)},e.cerrarPopupVista=function(){e.cerrarPopup(e.idModalWizardVentaVista)},e.imprimirVenta=function(a){_(a.id,e.usuario.id_empresa).then(function(a){var t=a.venta;t.configuracion=a.configuracion,t.sucursal=a.sucursal,t.numero_literal=a.numero_literal,t.pieFactura=a.pieFactura,t.sucursalDestino=a.sucursalDestino;var o=new Date(t.fecha);t.fechaTexto=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),h(t.movimiento.clase.nombre_corto,t,!1,e.usuario)})},e.mostrarDescuentos=function(){"none"==$(".des-datos").css("display")?$(".des-datos").css("display",""):$(".des-datos").css("display","none")},e.guardarVenta=function(a,t){if(a){e.ocultarMensajesValidacion();var o=new Date;if(t.fecha=new Date(e.convertirFecha(t.fechaTexto)),t.fecha.setHours(o.getHours()),t.fecha.setMinutes(o.getMinutes()),t.esFarmacia=!0,console.log("las ventas son ==== ",t),s.start(),t.id)f.update({idCompra:compra.id},compra,function(a){s.stop(),e.cerrarPopupFarmaciaEdicion(),e.mostrarMensaje("Actualizado Exitosamente!"),e.recargarItemsTabla()});else{t.movimiento.nombre_corto;t.$save(function(a){console.log("res ==================",a),a.hasError?(s.stop(),e.crearNuevaVenta(),e.mostrarMensaje(a.message)):(s.stop(),e.cerrarPopupFarmaciaEdicion(),e.imprimirVenta(a),e.crearNuevaVenta(),e.ocultarMensajesValidacion(),e.mostrarMensaje("Venta registrada exitosamente!"))},function(a){s.stop(),e.cerrarPopupFarmaciaEdicion(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})}}},e.sumarMonto=function(){for(var a=0,t=0;t<e.ventas.length;t++)e.ventas[t].movimiento.clase.nombre_corto!=e.diccionario.EGRE_FACTURACION&&e.ventas[t].movimiento.clase.nombre_corto!=e.diccionario.EGRE_PROFORMA||!e.ventas[t].activa||(a+=e.ventas[t].total);return Math.round(100*a)/100},e.trueDetalle=!0,e.verDetalle=function(){e.trueDetalle?e.trueDetalle=!1:e.trueDetalle=!0},e.imprimirFiltroCajaCartaOficio=function(a,t,o){var n=new PDFDocument({compress:!1,size:[612,792],margin:0}),i=n.pipe(blobStream()),r=20;if(e.trueDetalle){for(var c=2*a.length,l=0;l<a.length;l++)c+=a[l].detallesVenta.length;var u=Math.ceil(c/r)}else r=20,u=Math.ceil(a.length/r);var d=100,p=0,m=1;e.imprimirCabeceraFiltroCajaCartaOficio(n,1,u,a,t,o),n.font("Helvetica",7);for(l=0;l<a.length;l++){n.font("Helvetica",7),n.rect(50,d+9,520,0).stroke(),n.text(l+1,55,d+20),n.font("Helvetica",6),a[l].fecha=new Date(a[l].fecha),n.text(a[l].fecha.getDate()+"/"+(a[l].fecha.getMonth()+1)+"/"+a[l].fecha.getFullYear(),65,d+20),n.text(a[l].factura,120,d+20,{width:60}),n.font("Helvetica",6),n.text(a[l].farmacia.paciente.persona.nombre_completo,170,d+15,{width:75}),n.font("Helvetica",7),n.text(a[l].farmacia.paciente.designacion_empresa,245,d+20),n.text(a[l].farmacia.paciente.codigo,305,d+20),n.text(a[l].farmacia.paciente.campo,345,d+20);for(var v=[],f=0;f<a[l].farmacia.paciente.empleadosFichas[a[l].farmacia.paciente.empleadosFichas.length-1].cargos.length;f++)v.push(a[l].farmacia.paciente.empleadosFichas[a[l].farmacia.paciente.empleadosFichas.length-1].cargos[f].cargo.nombre);if(n.text(v.toString(),385,d+20,{width:50}),n.text(a[l].total,425,d+20),a[l].tipoPago?(n.text(a[l].tipoPago.nombre,455,d+20),a[l].tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO&&(n.font("Helvetica",6),n.text("Plazo: "+a[l].dias_credito+" A cuenta: Bs "+a[l].a_cuenta+" Saldo: Bs "+a[l].saldo,510,d+16,{width:55}))):(n.text("",455,d+20),n.text("",520,d+16,{width:65})),e.trueDetalle){n.rect(50,d+34,520,0).stroke(),n.font("Helvetica",7),d+=50,n.text("N°",105,d),n.text("Nombre",115,d),n.text("Codigo Item",170,d),n.text("Unidad de Med",230,d),n.text("Cantidad",295,d),n.text("Importe",355,d),p++;for(var g=0;g<a[l].detallesVenta.length;g++)if(n.font("Helvetica",7),n.text(g+1,105,d+20),n.text(a[l].detallesVenta[g].producto.nombre,115,d+20,{width:55}),n.text(a[l].detallesVenta[g].producto.id,170,d+20),n.text(a[l].detallesVenta[g].producto.unidad_medida,230,d+20),n.text(a[l].detallesVenta[g].cantidad,295,d+20),n.text(a[l].detallesVenta[g].importe,355,d+20),d+=24,++p+1>r-1){d+=10,n.text(m+" de "+u,520,705);var h=new Date;n.text("FECHA : "+h.getDate()+"/"+(h.getMonth()+1)+"/"+h.getFullYear()+"   Hr:"+h.getHours()+":"+h.getMinutes(),55,705),n.text("USUARIO: "+e.usuario.nombre_usuario,150,705),n.addPage({size:[612,792],margin:10}),d=100,p=0,m+=1,e.imprimirCabeceraFiltroCajaCartaOficio(n,1,u,a,t,o)}if(n.font("Helvetica",7),d+=4,++p>r){d+=10,n.text(m+" de "+u,520,705);h=new Date;n.text("FECHA : "+h.getDate()+"/"+(h.getMonth()+1)+"/"+h.getFullYear()+"   Hr:"+h.getHours()+":"+h.getMinutes(),55,705),n.text("USUARIO: "+e.usuario.nombre_usuario,150,705),n.addPage({size:[612,792],margin:10}),d=100,p=0,m+=1,e.imprimirCabeceraFiltroCajaCartaOficio(n,1,u,a,t,o)}}else if(n.font("Helvetica",7),d+=30,++p==r){n.text(m+" de "+u,520,705);h=new Date;n.text("FECHA : "+h.getDate()+"/"+(h.getMonth()+1)+"/"+h.getFullYear()+"   Hr:"+h.getHours()+":"+h.getMinutes(),55,705),n.text("USUARIO: "+e.usuario.nombre_usuario,150,705),n.addPage({size:[612,792],margin:10}),d=100,p=0,m+=1,e.imprimirCabeceraFiltroCajaCartaOficio(n,1,u,a,t,o)}}n.font("Helvetica",7),n.text(m+" de "+u,520,705);h=new Date;n.text("FECHA : "+h.getDate()+"/"+(h.getMonth()+1)+"/"+h.getFullYear()+"   Hr:"+h.getHours()+":"+h.getMinutes(),55,705),n.text("USUARIO: "+e.usuario.nombre_usuario,150,705),n.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),s.stop()},e.imprimirCabeceraFiltroCajaCartaOficio=function(a,t,o,n,i,r){a.font("Helvetica-Bold",16),a.text("REPORTE",0,40,{align:"center"}),a.font("Helvetica-Bold",8),a.rect(50,80,520,620).stroke(),a.text("Desde: "+i+" Hasta: "+r,0,55,{align:"center"});var c=[e.razon_sociald,e.nitd,e.montod,e.usuariod,e.transacciond,e.sucursald,e.tipoPagod],s=0,l="";a.text("Filtro: ",55,65);for(var u=0;u<c.length;u++)0!=c[u]&&void 0!=c[u]?(l=l+c[u]+", ",65):7==(s+=1)&&a.text("GENERAL",85,65);a.text(l,85,65),a.font("Helvetica-Bold",7),a.font("Helvetica-Bold",8),a.text("N°",55,90),a.text("Fecha",65,90),a.text("Receta",120,90,{width:43}),a.text("Nombre Completo",170,90),a.text("Empresa",245,90,{width:43}),a.text("Código",305,90),a.text("Campo",345,90,{width:43}),a.text("Cargo",385,90,{width:43}),a.text("Monto",420,90),a.text("Tipo de Pago",455,90),a.text("Pago",520,90)},e.imprimirFiltroExcelCajaCartaOficio=function(a){s.start();for(var t=[["N°","Fecha","Receta","Nombre Completo","Empresa","Código","Campo","Cargo","Monto","Tipo de Pago","Pago"]],o=0;o<a.length;o++){var n=[];a[o].fecha=new Date(a[o].fecha),n.push(o+1),n.push(a[o].fecha.getDate()+"/"+(a[o].fecha.getMonth()+1)+"/"+a[o].fecha.getFullYear()),n.push(a[o].factura),n.push(a[o].farmacia.paciente.persona.nombre_completo),n.push(a[o].farmacia.paciente.designacion_empresa),n.push(a[o].farmacia.paciente.codigo),n.push(a[o].farmacia.paciente.campo);for(var i=[],r=0;r<a[o].farmacia.paciente.empleadosFichas[a[o].farmacia.paciente.empleadosFichas.length-1].cargos.length;r++)i.push(a[o].farmacia.paciente.empleadosFichas[a[o].farmacia.paciente.empleadosFichas.length-1].cargos[r].cargo.nombre);if(n.push(i.toString()),n.push(a[o].total),a[o].tipoPago?(n.push(a[o].tipoPago.nombre),a[o].tipoPago.nombre==e.diccionario.TIPO_PAGO_CREDITO&&n.push("Plazo: "+a[o].dias_credito+" A cuenta: Bs "+a[o].a_cuenta+" Saldo: Bs "+a[o].saldo)):n.push(""),"TRASPASO"==a[o].movimiento.clase.nombre&&(n.push(""),n.push(a[o].almacenTraspaso.sucursal.nombre)),t.push(n),e.trueDetalle){t.push(["","","","","N°","Nombre","Codigo Item","Unidad de Med","Cantidad","Importe"]);for(r=0;r<a[o].detallesVenta.length;r++)(n=[]).push(""),n.push(""),n.push(""),n.push(""),n.push(r+1),n.push(a[o].detallesVenta[r].producto.nombre),n.push(a[o].detallesVenta[r].producto.id),n.push(a[o].detallesVenta[r].producto.unidad_medida),n.push(a[o].detallesVenta[r].cantidad),n.push(a[o].detallesVenta[r].importe),t.push(n)}o+1==a.length&&((n=[]).push(""),n.push(""),n.push(""),n.push(""),n.push(""),n.push(""),n.push(""),n.push(""),n.push(""),n.push(""),n.push(""),t.push(n))}var c="SheetJS",l=new Workbook,u=sheet_from_array_of_arrays(t);l.SheetNames.push(c),l.Sheets[c]=u;var d=XLSX.write(l,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(d)],{type:"application/octet-stream"}),"Reporte-ventas-farmacia.xlsx"),s.stop()},e.abrirPopupPago=function(a){e.venta=a,e.pago=null,e.abrirPopup(e.idModalPago)},e.cerrarPopupPago=function(){e.cerrarPopup(e.idModalPago)},e.efectuarPago=function(a){s.start(),D.update({id:e.venta.id,id_empresa:e.usuario.id_empresa},{pago:a,id_usuario_cajero:e.usuario.id},function(t){e.mostrarMensaje(t.mensaje),e.cerrarPopup(e.idModalPago),e.obtenerVentas(),e.imprimirRecibo(t,t.venta,a),s.stop()},function(a){e.mostrarMensaje(a),e.cerrarPopup(e.idModalPago),e.obtenerVentas(),s.stop()})},e.imprimirRecibo=function(a,t,o){s.start();var n=new PDFDocument({compress:!1,size:[227,353],margin:10}),i=n.pipe(blobStream());n.moveDown(2),n.font("Helvetica-Bold",8),n.text(e.usuario.empresa.razon_social.toUpperCase(),{align:"center"}),n.moveDown(.4),n.font("Helvetica",7),n.text(t.almacen.sucursal.nombre.toUpperCase(),{align:"center"}),n.moveDown(.4),n.text(t.almacen.sucursal.direccion.toUpperCase(),{align:"center"}),n.moveDown(.4);var r=(null!=t.almacen.sucursal.telefono1?t.almacen.sucursal.telefono1:"")+(null!=t.almacen.sucursal.telefono2?"-"+t.almacen.sucursal.telefono2:"")+(null!=t.almacen.sucursal.telefono3?"-"+t.almacen.sucursal.telefono3:"");n.text("TELF.: "+r,{align:"center"}),n.moveDown(.4),n.text("COCHABAMBA - BOLIVIA",{align:"center"}),n.moveDown(.5),n.font("Helvetica-Bold",8),n.text("RECIBO",{align:"center"}),n.font("Helvetica",7),n.moveDown(.4),n.text("------------------------------------",{align:"center"}),n.moveDown(.4),n.text(t.almacen.sucursal.nota_recibo_correlativo,{align:"center"}),n.moveDown(.4),n.moveDown(.4),n.text("------------------------------------",{align:"center"}),n.moveDown(.4),n.moveDown(.6);var c=new Date;n.text("FECHA : "+c.getDate()+"/"+(c.getMonth()+1)+"/"+c.getFullYear(),{align:"left"}),n.moveDown(.4),n.text("He recibido de : "+e.venta.farmacia.paciente.persona.nombre_completo,{align:"left"}),n.moveDown(.4),n.text("---------------------------------------------------------------------------------",{align:"center"}),n.moveDown(.2),n.text("       CONCEPTO                                   ",{align:"left"}),n.moveDown(.2),n.text("---------------------------------------------------------------------------------",{align:"center"}),n.moveDown(.4),t.fecha=new Date(t.fecha),n.text("Fecha: "+t.fecha.getDate()+"/"+(t.fecha.getMonth()+1)+"/"+t.fecha.getFullYear(),15,210);var l=e.venta.movimiento.clase.nombre_corto==e.diccionario.EGRE_FACTURACION?"Factura nro. "+e.venta.factura:"Proforma nro. "+e.venta.factura;n.text(l,105,210,{width:100}),n.text("Saldo Bs "+(t.saldo-o)+".-",105,220,{width:100}),n.text("Bs "+o+".-",170,210,{width:100}),n.text("--------------",10,230,{align:"right"}),n.moveDown(.3),n.text("TOTAL Bs.              "+o.toFixed(2),{align:"right"}),n.moveDown(.4),n.moveDown(.4),n.text("SON: "+a.pago,{align:"left"}),n.moveDown(.6),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.moveDown(.4),n.text("-------------------------                       -------------------------",{align:"center"}),n.text("ENTREGUE CONFORME            RECIBI CONFORME",{align:"center"}),n.end(),i.on("finish",function(){var e=i.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),s.stop()},e.$on("$routeChangeStart",function(a,t){e.eliminarPopup(e.idModalWizardFarmaciaEdicion),e.eliminarPopup(e.idModalInventario),e.eliminarPopup(e.idModalWizardVentaVista),e.eliminarPopup(e.idModalPago)}),e.inicio()}]);