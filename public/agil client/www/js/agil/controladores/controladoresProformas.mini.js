angular.module("agil.controladores").controller("controladorProformas",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","Paginator","$timeout","blockUI","ClasesTipo","socket","ObtenerCambioMoneda","ClientesNit","FiltroProformas","ActividadServicio","ActividadesEmpresa","ServiciosEmpresa","ProformaInfo","Clientes","fechasProforma","ListaSucursalesActividadesDosificacionEmpresa","DosificacionesDisponibles","ListaSucursalesUsuario","ListaHistorialActividad","ImprimirSalida","ConfiguracionesFacturasProformas","ProformasFacturadas","ActualizarProforma","GuardarProformas","ProformaEliminar","GuardarActividadesEmpresa","obtenerAsignacionCentroCosto","GuardarAsignacionCentroCosto",function(a,o,e,r,i,t,n,c,s,d,l,m,f,u,p,v,g,P,h,C,b,D,_,S,E,A,k,x,j,M,F,w,I,B,L){a.usuario=JSON.parse(c.usuario),a.modalConfiguracionActividadesServicios="modalConfiguracionActividadesServicios",a.wizardConfiguracionActividadesServicios="modal-wizard-panel-container",a.modalConfiguracionActividades="modalConfiguracionActividades",a.wizardConfiguracionActividades="modal-wizard-panel-container-actividad",a.dialogProformaEdicion="proforma-edicion",a.dialogClientesProforma="dialog-cliente-proforma",a.dialogmodalFechas="modalFechas",a.dialogBusquedaServicio="dialog-Busqueda-servicio-proforma",a.dialogDosificacionesDisponibles="dialog-dosificaciones-disponibles",a.confirmarDosificacion="dialog-dosificar-actividad",a.asignacionCentroCostoCliente="modalEmpresaCentroCosto",a.dialogClienteEmpresa="dialog-cliente-empresa",a.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsProformas(a.modalConfiguracionActividadesServicios,a.wizardConfiguracionActividadesServicios,a.dialogProformaEdicion,a.dialogClientesProforma,a.modalConfiguracionActividades,a.wizardConfiguracionActividades,a.dialogmodalFechas,a.dialogBusquedaServicio,a.dialogDosificacionesDisponibles,a.confirmarDosificacion,a.asignacionCentroCostoCliente,a.dialogClienteEmpresa),a.buscarAplicacion(a.usuario.aplicacionesUsuario,t.path().substring(1))}),a.$on("$routeChangeStart",function(o,e){a.eliminarPopup(a.modalConfiguracionActividadesServicios),a.eliminarPopup(a.dialogProformaEdicion),a.eliminarPopup(a.modalConfiguracionActividades),a.eliminarPopup(a.dialogClientesProforma),a.eliminarPopup(a.dialogmodalFechas),a.eliminarPopup(a.dialogBusquedaServicio),a.eliminarPopup(a.dialogDosificacionesDisponibles),a.eliminarPopup(a.confirmarDosificacion),a.eliminarPopup(a.asignacionCentroCostoCliente),a.eliminarPopup(a.dialogClienteEmpresa)}),a.abrirdialogClienteEmpresa=function(){a.abrirPopup(a.dialogClienteEmpresa)},a.cerrardialogClienteEmpresa=function(){a.cerrarPopup(a.dialogClienteEmpresa)},a.calcularTotalProformas=function(){a.totalProformas=0;var o=new Date;a.totalProformasDolar=0,u(new Date).then(function(o){a.totalProformas=0;for(var e=0;e<a.proformas.length;e++)a.proformas[e].eliminado||(a.totalProformas+=a.proformas[e].totalImporteBs,a.totalProformasDolar=a.totalProformas/o.monedaCambio.dolar)},function(e){a.mostrarMensaje("Hubo un problema al recuperar el cambio de dolar para "+o.toLocaleDateString)})},a.obtenerHistorialActividad=function(o){void 0!==o.id&&A(o.actividad.id,o.id_sucursal).then(function(o){a.historialActividad=o.historial})},a.verificarDetallesProformas=function(){if(a.detallesProformas.length>0){var o=0;return a.detallesProformas.forEach(function(a){a.eliminado&&(o+=1)}),o!==a.detallesProformas.length}return!a.proforma.ver&&!!a.proforma.cliente},a.verificarBloqueoServicios=function(){return void 0!==a.proformaFechas?void 0!==a.proformaFechas.ver:a.proforma.editar?a.verificarDetallesProformas():!a.proforma.nueva},a.eliminar=function(o){l.start(),w(o).then(function(e){e.hasErr||(o.eliminado=!0,a.calcularTotalProformas()),a.mostrarMensaje(e.mensaje),l.stop()}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e),l.stop()})},a.editar=function(o,e){if(o.fecha_factura){var r=new Date(o.fecha_factura);if(null!==o.fecha_factura&&void 0!==o.fecha_factura&&"[object Date]"===Object.prototype.toString.call(r)){if(isNaN(r.getTime()))return void a.mostrarMensaje("Hay un problema con la fecha de la factura. Se bloqueará la edición de esta proforma.");if(!e)return void a.mostrarMensaje("Esta proforma no se puede editar, ya fué facturada.")}}l.start();var i=new Date(o.fecha_proforma);u(i).then(function(r){r.monedaCambio?(a.moneda=r.monedaCambio,void 0!==a.detalleProforma&&a.calcularImporte()):(a.moneda={ufv:"--",dolar:"--"},a.mostrarMensaje("La fecha "+a.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema.")),C(o.id,o.actividadEconomica.id).then(function(o){if(a.proforma=o.proforma,a.proforma.editar=!0,a.proforma.sucursal=o.proforma.sucursal,a.obtenerActividadesSucursal(a.proforma.sucursal.id),a.proforma.actividadEconomica=o.proforma.actividadEconomica,a.obtenerServiciosActividadEmpresaPrincipal(a.proforma.actividadEconomica),void 0!==e&&(a.proforma.ver=!0),void 0!==o.mensaje)a.mostrarMensaje(o.mensaje);else{a.proforma.fecha_proforma=a.fechaATexto(new Date(a.proforma.fecha_proforma));var r=new Date(a.convertirFecha(a.proforma.fecha_proforma));a.obtenerCambioMonedaProforma(r);var i=a.moneda.dolar;a.proforma.periodo_mes={id:a.proforma.periodo_mes},a.proforma.periodo_anio={id:a.proforma.periodo_anio},a.obtenercentroCostosClienteEmpresa(a.proforma.cliente),a.detallesProformas=a.proforma.detallesProformas,a.detallesProformas.map(function(o,e){a.detalleProforma=o,a.calcularImporte(),a.detalleProforma=void 0}),a.proforma.totalImporteSus=a.proforma.totalImporteBs/i,a.proforma.importeLiteral=ConvertirALiteral(a.proforma.totalImporteBs.toFixed(2))}l.stop()}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})}),a.detalleProforma=void 0,a.abrirdialogProformaEdicion(a.proforma)},a.ver=function(o){a.proforma=o,a.proforma.ver=!0,a.editar(a.proforma,!0)},a.mostarMensajeConfirmacionEliminacionActividad=function(o){a.abrirPopupConfirmacionEliminacion(a.eliminarDetalleActividadEmpresa,o)},a.imprimirFactura=function(o){if(null!=o.fecha_factura){l.start();var e=[];j(a.usuario.id_empresa,o.factura).then(function(o){e=o.datosProformas;var r={};x(a.usuario.id_empresa).then(function(o){m("MOVEGR").then(function(i){i.clases.forEach(function(a){"FACTURACIÓN"==a.nombre&&"FACT"==a.nombre_corto&&(r=a)}),m("TIPA").then(function(i){a.tiposPago=i.clases,a.facturaProformas={},a.facturaProformas.configuracion=o.configuracion,a.facturaProformas.movimiento=r,a.facturaProformas.cliente=e[0].cliente,a.facturaProformas.autorizacion=e[0].autorizacion,a.facturaProformas.factura=e[0].factura,a.facturaProformas.codigo_control=e[0].codigo_control,a.facturaProformas.fecha=new Date(e[0].fecha_factura),a.facturaProformas.fecha_limite_emision=new Date(e[0].fecha_limite_emision),a.facturaProformas.actividad=e[0].actividadEconomica,a.facturaProformas.sucursal=e[0].sucursal,a.facturaProformas.detallesVenta=[],a.facturaProformas.detalle="",a.facturaProformas.totalImporteBs=e[0].totalImporteBs,a.facturaProformas.importe=e[0].importe,a.facturaProformas.fecha_factura=new Date(e[0].fecha_factura).toLocaleDateString(),a.facturaProformas.fechaTexto=new Date(a.facturaProformas.fecha).toLocaleDateString(),a.facturaProformas.periodo_mes=e[0].mes,a.facturaProformas.periodo_anio=e[0].anio,a.facturaProformas.datosProformas=e,a.facturaProformas.descripcion="",a.facturaProformas.movimiento=r,a.facturaProformas.id_movimiento=a.facturaProformas.movimiento.id,a.facturaProformas.id_tipo_pago=a.tiposPago[0].id,a.facturaProformas.tipoPago=a.tiposPago[1],a.obtenerTipoEgreso(a.facturaProformas.movimiento),a.esContado=!1,a.facturaProformas.usar_servicios=!0,a.facturaProformas.id_usuario=a.usuario.id,a.facturaProformas.fecha=e[0].fecha,a.facturaProformas.id_empresa=a.usuario.id_empresa,a.facturaProformas.datosProformas.forEach(function(o,e){a.facturaProformas.descripcion+=o.detalle+". ",a.facturaProformas.importe=0,a.facturaProformas.total=0;var r={ufv:"--",dolar:"--"};u(o.fecha_proforma).then(function(i){i.monedaCambio&&(r={ufv:i.monedaCambio.ufv,dolar:i.monedaCambio.dolar}),o.tc=r,o.detallesProformas.map(function(r,i){a.facturaProformas.importe+=r.precio_unitario*r.cantidad,a.facturaProformas.detallesVenta.push(r),a.facturaProformas.total=a.facturaProformas.importe,a.facturaProformas.importeLiteral=ConvertirALiteral(a.facturaProformas.importe.toFixed(2)),a.facturaProformas.numero_literal=a.facturaProformas.importeLiteral,r.tc=o.tc,r.total=r.importe*r.cantidad,i===o.detallesProformas.length-1&&(e==a.facturaProformas.datosProformas.length-1&&(a.checkResourceImg(a.usuario.empresa.imagen,a.usuario.empresa.imageLoaded)?convertUrlToBase64Image(a.usuario.empresa.imagen,function(o){o.length>0&&"error"!==o?(a.usuario.empresa.imagen=o,a.usuario.empresa.imageLoaded=!0,k("FACT",a.facturaProformas,!1,a.usuario)):convertUrlToBase64Image("img/agilsoftware.png",function(o){a.mostrarMensaje("No se encuentra la imagen de la empresa. Se usara la imagen del software."),a.usuario.empresa.imagen=o,a.usuario.empresa.imageLoaded=!0,k("FACT",a.facturaProformas,!1,a.usuario)})}):(a.mostrarMensaje("Existe un problema con la imagen, no se incluira en la impresión."),d(function(){k("FACT",a.facturaProformas,!1,a.usuario)},1500))),a.dolarActual=a.obtenerCambioDolarActual())})}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})}),l.stop()}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e),l.stop()})}else a.mostrarMensaje("La proforma aún no ha sido facturada.")},a.eliminarDetalleActividadEmpresa=function(o){void 0!==o.id?o.eliminado=!0:a.actividadesSucursal.splice(a.actividadesSucursal.indexOf(o),1),a.cerrarConfirmacionEliminacion()},a.getFecha=function(){return void 0!==a.proforma?new Date(a.proforma.fecha):new Date},a.editarServicio=function(o){o.editado=!0,a.nActividad.actividadEconomica.actividad=o.actividad,a.nActividad.servicio=o},a.modificarProformaPrecioUnitarioServicio=function(a){void 0===a.editarPrecio?a.editarPrecio=!0:a.editarPrecio=void 0},a.actualizarPeriodo=function(o){var e=new Date(a.convertirFecha(o));a.obtenerCambioMonedaProforma(e),a.proforma.periodo_mes.id=e.getMonth(),a.proforma.periodo_anio.id=e.getFullYear()},a.buscarCliente=function(o){if(""!=o&&void 0!=o)return p(a.usuario.id_empresa,o)},a.establecerCliente=function(o){!a.proforma.ver&&a.verificarDetallesProformas()?(a.proforma.cliente=o,a.obtenercentroCostosClienteEmpresa(o),a.enfocar("proformaDetalle")):a.mostrarMensaje("No se permite.")},a.enfocar=function(a){d(function(){$("#"+a).focus()},0)},a.inicio=function(){a.listaCentroCostosClienteEmpresa=[],a.actividadesSucursal=[],a.nActividad={},a.proforma={},a.configuracionActividadServicio=[],a.servicios=[],a.detalleProforma={},a.detallesProformas=[],a.obtenerClientes(),a.obtenerActividadesEmpresa(a.usuario.empresa.id),a.filtro={empresa:a.usuario.empresa.id,mes:0,anio:0,sucursal:0,actividadEconomica:0,servicio:0,monto:0,razon:0,usuario:"",pagina:1,items_pagina:10,busqueda:0,numero:0},a.meses=[{id:0,nombre:"Enero"},{id:1,nombre:"Febrero"},{id:2,nombre:"Marzo"},{id:3,nombre:"Abril"},{id:4,nombre:"Mayo"},{id:5,nombre:"Junio"},{id:6,nombre:"Julio"},{id:7,nombre:"Agosto"},{id:8,nombre:"Septiembre"},{id:9,nombre:"Octubre"},{id:10,nombre:"Noviembre"},{id:11,nombre:"Diciembre"}],a.proformas=[],a.sucursalesUsuario="";for(var o=0;o<a.usuario.sucursalesUsuario.length;o++)a.sucursalesUsuario=a.sucursalesUsuario+a.usuario.sucursalesUsuario[o].sucursal.id,o+1!=a.usuario.sucursalesUsuario.length&&(a.sucursalesUsuario=a.sucursalesUsuario+",");a.obtenerPaginador(),a.obtenerCentroCosto()},a.verificarFechaRecepcion=function(a){return null===a||void 0===a},a.verificarFechaProformaOk=function(a){return null===a||void 0===a},a.verificarFechaFactura=function(a){return null===a||void 0===a},a.actualizarFechas=function(o){l.start(),void 0!==o&&(o.fecha_recepcion=o.fecha_recepcion instanceof Date?o.fecha_recepcion:null===o.fecha_recepcion?null:new Date(a.convertirFecha(o.fecha_recepcion)),o.fecha_proforma_ok=o.fecha_proforma_ok instanceof Date?o.fecha_proforma_ok:null===o.fecha_proforma_ok?null:new Date(a.convertirFecha(o.fecha_proforma_ok)),o.fecha_factura=o.fecha_factura instanceof Date?o.fecha_factura:null===o.fecha_factura?null:new Date(a.convertirFecha(o.fecha_factura)),o.fecha_cobro=o.fecha_cobro instanceof Date?o.fecha_cobro:null===o.fecha_cobro?null:new Date(a.convertirFecha(o.fecha_cobro)),D.save({id:o.id},o,function(o){a.proforma=void 0,a.mostrarMensaje(o.mensaje),a.cerrardialogmodalFechas(),a.recargarItemsTabla(),l.stop()},function(o){a.mostrarMensaje(void 0===o.message?o.stack:o.message),l.stop()}))},a.sinFuncionalidad=function(){a.mostrarMensaje("Sin funcionalidad")},a.agregardetalleProforma=function(o){void 0!==o.id_servicio&&(a.proforma.totalImporteBs=0,a.proforma.totalImporteSus=0,o.editar?(a.detallesProformas[a.detallesProformas.indexOf(o)]=o,a.detalleProforma.editar=void 0):a.detallesProformas.push(o),a.detalleProforma={},a.detallesProformas.forEach(function(o){o.eliminado||(a.proforma.totalImporteBs+=o.importe,a.proforma.totalImporteSus+=o.importeSus)}),a.proforma.importeLiteral=ConvertirALiteral(a.proforma.totalImporteBs.toFixed(2)),a.modificarProformaPrecioUnitarioServicio(o)),a.enfocar("id_servicioProforma")},a.obtenerCambioMonedaProforma=function(o){u(o).then(function(o){o.monedaCambio?(a.moneda=o.monedaCambio,void 0!==a.detalleProforma&&a.calcularImporte()):(a.moneda={ufv:"--",dolar:"--"},a.mostrarMensaje("La fecha "+a.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema."))})},a.obtenerCentroCosto=function(){m("CENCOS").then(function(o){a.centroCostos=o.clases.sort(function(a,o){return a.nombre>o.nombre?1:a.nombre<o.nombre?-1:0})})},a.obtenerActividadesSucursal=function(o){var e=$.grep(a.sucursales,function(a){return a.id==o})[0];a.actividadesDosificaciones=e.actividadesDosificaciones,a.actividadesSucursal=[],a.actividadesDosificaciones.map(function(o){o.dosificacion&&(o.expirado||o.dosificacion.expirado?a.dosificacionesExpiradas=!0:a.actividadesSucursal.push(o.actividad))})},a.obtenerActividadesGral=function(){a.actividades=[],m("ACTCOM").then(function(o){a.actividades=o.clases.sort()})},a.obtenerPaginador=function(){l.start(),a.paginator=s(),a.paginator.column="fecha",a.paginator.direccion="asc",a.filtro={empresa:a.usuario.empresa.id,mes:0,anio:0,sucursal:0,actividadEconomica:0,servicio:0,monto:0,razon:0,usuario:0,numero:0},a.paginator.filter=a.filtro,a.paginator.callBack=a.obtenerProformas,a.paginator.getSearch("",a.filtro,null),a.filtro={empresa:a.usuario.empresa.id,mes:"",anio:"",sucursal:"",actividadEconomica:"",servicio:"",monto:"",razon:"",usuario:"",numero:""},l.stop()},a.guardarConfiguracionActividadServicios=function(o){if("Siguiente"!=$("#siguiente").text().trim()){l.start(),a.nActividad={};var e=[],r=o.map(function(a,o){if(void 0===a.id||a.eliminado||void 0!==a.editado)return a;e.push(o)});if(e.reverse().forEach(function(a){r.splice(a,1)}),r.length>0)GuardarActividadServicio(a.usuario.empresa.id,0,r).then(function(o){a.mostrarMensaje(o.mensaje),a.obtenerSucursales(),l.stop(),a.cerrarConfiguracionActividadesServicios()}).catch(function(o){a.mostrarMensaje(void 0===o.message?o.stack:o.message),l.stop(),a.cerrarConfiguracionActividadesServicios()});else l.stop(),a.cerrarConfiguracionActividadesServicios()}},a.buscarservicio=function(e){if(""!=e&&void 0!=e){if(a.configuracionActividadServicio.length>0)return o("filter")(a.configuracionActividadServicio,e);void 0!==a.proforma&&void 0!==a.proforma.actividadEconomica&&a.mostrarMensaje('No hay servicios en la actividad seleccionada: "'+a.proforma.actividadEconomica.nombre+'"')}},a.establecerservicio=function(o,e){var r=Object.assign({},o);a.detalleProforma&&a.detalleProforma.servicio?(a.detalleProforma.id_servicio=r.id,a.detalleProforma.servicio=r,a.detalleProforma.precio_unitario=r.precio,a.detalleProforma.actividad_id=r.actividad.id,a.detalleProforma.actividad=r.actividad):a.detalleProforma={id_servicio:r.id,cantidad:1,servicio:r,precio_unitario:r.precio,actividad_id:r.actividad.id,actividad:r.actividad},a.detalleProforma.importe=a.detalleProforma.precio_unitario*a.detalleProforma.cantidad,void 0!==a.moneda&&null!==a.moneda.dolar&&"--"!==a.moneda.dolar&&(a.detalleProforma.precioSus=a.detalleProforma.precio_unitario/a.moneda.dolar,a.detalleProforma.importeSus=a.detalleProforma.precio_unitario/a.moneda.dolar*a.detalleProforma.cantidad),a.enfocar("cantidad"),void 0!==e&&a.cerrarBusquedaServiciosProforma()},a.calcularImporte=function(o){void 0===o?(a.detalleProforma.importe=a.detalleProforma.precio_unitario*a.detalleProforma.cantidad,void 0!==a.moneda&&null!==a.moneda.dolar&&"--"!==a.moneda.dolar&&(a.detalleProforma.precioSus=a.detalleProforma.precio_unitario/a.moneda.dolar,a.detalleProforma.importeSus=a.detalleProforma.precio_unitario/a.moneda.dolar*a.detalleProforma.cantidad)):(a.detalleProforma.importeSus=a.detalleProforma.precioSus*a.detalleProforma.cantidad,void 0!==a.moneda&&null!==a.moneda.dolar&&"--"!==a.moneda.dolar&&(a.detalleProforma.precio_unitario=a.detalleProforma.precioSus*a.moneda.dolar,a.detalleProforma.importe=a.detalleProforma.precioSus*a.moneda.dolar*a.detalleProforma.cantidad))},a.agregarDetalleActividadServicio=function(o){if(void 0!==o&&null!==o){var e=!1;if(void 0!==o.actividadEconomica&&null!==o.actividadEconomica||(e=!0),void 0===o.servicio&&null===o.servicio?e=!0:void 0===o.servicio.codigo||void 0===o.servicio.nombre||void 0===o.servicio.precio?e=!0:""!==o.servicio.codigo&&""!==o.servicio.nombre&&""!==o.servicio.precio||(e=!0),void 0!==o.actividadEconomica.dosificacion&&null!==o.actividadEconomica.dosificacion||(e=!0,errDos=!0),e)errDos?a.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar."):a.mostrarMensaje("Revise los datos e intente nuevamente.");else{var r=a.buscarservicio(o.servicio.nombre);if(void 0!==r)if(r.length<1)if(o.actividadEconomica.dosificacion,void 0!==o.actividadEconomica.dosificacion.id&&null!==o.actividadEconomica.dosificacion.id){var i={id:o.id,actividad:o.actividadEconomica.actividad,codigo:o.servicio.codigo,nombre:o.servicio.nombre,precio:o.servicio.precio};a.configuracionActividadServicio.push(i),a.nActividad.servicio=void 0}else a.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.");else if(void 0===o.servicio.id){var t=!1;if(r.map(function(e){e.nombre===o.servicio.nombre&&(t=!0,a.mostrarMensaje("El servicio ya fue asignado a esta actividad")),e.codigo===o.servicio.codigo&&(t=!0,a.mostrarMensaje("El codigo del servicio ya esta en uso o listo para ser asignado."))}),!t)if(void 0!==o.actividadEconomica.dosificacion.id&&null!==o.actividadEconomica.dosificacion.id){i={id:o.id,actividad:o.actividadEconomica.actividad,codigo:o.servicio.codigo,nombre:o.servicio.nombre,precio:o.servicio.precio};a.configuracionActividadServicio.push(i),a.nActividad.servicio=void 0}else a.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.")}else a.nActividad.servicio=void 0;else if(void 0!==o.actividadEconomica.dosificacion.id&&null!==o.actividadEconomica.dosificacion.id){i={id:o.id,actividad:o.actividadEconomica.actividad,codigo:o.servicio.codigo,nombre:o.servicio.nombre,precio:o.servicio.precio};a.configuracionActividadServicio.push(i),a.nActividad.servicio=void 0}else a.mostrarMensaje("La actividad seleccionada no tiene dosificación activa, por favor asigne una dosificación para poder continuar.")}}},a.interceptarTecla=function(o,e,r){13===o.which&&(r?a.proforma.cliente?a.detalleProforma.servicio?a.enfocar(e):a.abrirBusquedaServiciosProforma(a.proforma.actividadEconomica):a.abrirdialogClientesProforma():d(function(){$("#"+e).trigger("click")},0))},a.filtrarClientes=function(e){a.clientesProcesados=o("filter")(a.clientes,e)},a.filtrarServicios=function(e){a.filser?a.serviciosProcesados=o("filter")(a.filser,e):a.serviciosProcesados=o("filter")(a.configuracionActividadServicio,e)},a.guardarConfiguracionActividadEconomicas=function(){if(l.start(),a.actividadesDosificaciones.length>0){var o=[],e=a.actividadesDosificaciones.map(function(a,e){if((void 0===a.id||a.eliminado||null==a.id_dosificacion&&(void 0==a.dosificacion||null==a.dosificacion)||a.editar)&&0==a.expirado)return a;o.push(e)});if(o.reverse().forEach(function(a){e.splice(a,1)}),e.length>0)I(a.usuario.empresa.id,e).then(function(o){void 0===o.hasErr?(a.obtenerSucursales(),a.mostrarMensaje(o.mensaje),a.actividadesDosificaciones=[],P(a.usuario.empresa.id).then(function(o){a.actividadesEmpresa=o.actividades,void 0!==o.mensaje&&a.mostrarMensaje(o.mensaje),l.stop(),a.cerrarConfiguracionActividades()}).catch(function(o){a.mostrarMensaje(void 0===o.message?o.stack:o.message),l.stop(),a.cerrarConfiguracionActividades()})):(a.mostrarMensaje(o.mensaje),l.stop())}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e),l.stop()});else l.stop(),a.cerrarConfiguracionActividades()}else l.stop(),a.mostrarMensaje("Ingrese al menos 1 actividad para guardar.")},a.editarDetalleProforma=function(o){o.editar=!0,a.detalleProforma=o},a.obtenerServiciosActividadEmpresaPrincipal=function(o,e){(a.detalleProforma={},void 0!=o)?void 0!==o.id&&h(a.usuario.empresa.id,o.id).then(function(o){void 0!==e?(a.filser=o.servicios,a.serviciosProcesados=o.servicios):(a.configuracionActividadServicio=o.servicios,a.serviciosProcesados=o.servicios),void 0!==o.mensaje&&a.mostrarMensaje(o.mensaje)}).catch(function(o){proforma.fecha_proforma=a.fechaATexto(proforma.fecha_proforma),l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)}):a.serviciosProcesados=[]},a.showInActivities=function(a){return!(a.expirado||a.eliminado||a.dosificacion.expirado)},a.obtenerSucursales=function(){l.start(),E(a.usuario.id).then(function(o){a.sucursales=o.sucursales.map(function(a){return a.sucursal}),l.stop()}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})},a.dosificarSucursalActividad=function(){if(a.cerrarconfirmarDosificacion(),a.actividadesDosificaciones.length>0){for(var o=!1,e=!1,r=0;0==e;)void 0!==a.actividadesDosificaciones[r].dosificacion&&null!==a.actividadesDosificaciones[r].dosificacion&&a.actividadesDosificaciones[r].dosificacion.id==a.paraDosificar.id&&(o=!0,e=!0),r<a.actividadesDosificaciones.length-1?r+=1:e=!0;o?a.mostrarMensaje("Hubo un problema, la dosificacion esta en lista para ser asignada!"):(a.actividadADosificar.dosificacionAnterior=void 0!==a.actividadADosificar.dosificacion||null!==a.actividadADosificar.dosificacion?a.actividadADosificar.dosificacion:null,a.actividadesDosificaciones[a.actividadesDosificaciones.indexOf(a.actividadADosificar)].dosificacion=a.paraDosificar,a.actividadADosificar.editar=!0,a.actividadADosificar=void 0,a.cerrardialogDosificacionesDisponibles())}},a.agregarDetalleActividadEmpresa=function(o,e){if(void 0!==e.id)if(a.actividadesDosificaciones.length>0){for(var r=!1,i=!1,t=0;0==i;)a.actividadesDosificaciones[t].actividad.nombre!==e.nombre||a.actividadesDosificaciones[t].expirado?t>=a.actividadesDosificaciones.length-1?i=!0:t+=1:(r=!0,i=!0);if(r)a.mostrarMensaje('La actividad "'+e.nombre+'" ya esta en la lista de esta sucursal "'+o.nombre+'".');else{var n={actividad:e,sucursal:o,expirado:!1};a.actividadesDosificaciones.push(n)}}else{n={actividad:e,sucursal:o,expirado:!1};a.actividadesDosificaciones.push(n)}},a.obtenerDosificaciones=function(){S(a.usuario.id_empresa).then(function(o){a.dosificaciones=o}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})},a.abrirBusquedaServiciosProforma=function(){a.abrirPopup(a.dialogBusquedaServicio)},a.cerrarBusquedaServiciosProforma=function(){a.cerrarPopup(a.dialogBusquedaServicio)},a.abrirconfirmarDosificacion=function(o){a.paraDosificar=o,a.abrirPopup(a.confirmarDosificacion)},a.cerrarconfirmarDosificacion=function(){a.cerrarPopup(a.confirmarDosificacion)},a.abrirdialogDosificacionesDisponibles=function(o){a.obtenerDosificaciones(),a.actividadADosificar=o,a.abrirPopup(a.dialogDosificacionesDisponibles)},a.cerrardialogDosificacionesDisponibles=function(){a.dosificaciones=void 0,a.actividadADosificar=void 0,a.cerrarPopup(a.dialogDosificacionesDisponibles)},a.eliminarDetalleProforma=function(o){void 0!==o.id?o.eliminado=!0:a.detallesProformas.splice(a.detallesProformas.indexOf(o),1),a.recalcularImportesProforma()},a.recalcularImportesProforma=function(){var o=0;a.detallesProformas.map(function(a){a.eliminado||(o+=a.precio_unitario*a.cantidad,a.importe=a.precio_unitario*a.cantidad)}),a.proforma.totalImporteBs=o,a.proforma.totalImporteSus=6.96*o,a.proforma.importeLiteral=ConvertirALiteral(a.proforma.totalImporteBs.toFixed(2))},a.eliminarDetalleConfiguracion=function(o){void 0!==o.id?o.eliminado=!0:a.configuracionActividadServicio.splice(a.configuracionActividadServicio.indexOf(o),1),a.cerrarConfirmacionEliminacion()},a.buscarCliente=function(o){if(""!=o&&void 0!=o)return p(a.usuario.id_empresa,o)},a.seleccionarcliente=function(o){if(a.proforma.ver||a.verificarDetallesProformas())a.mostrarMensaje("No se permite.");else{var e=Object.assign({},o);a.proforma.cliente=e,a.obtenercentroCostosClienteEmpresa(o),a.cerrardialogClientesProforma()}},a.obtenerClientes=function(){b(a.usuario.id_empresa).then(function(o){a.clientes=o,a.clientesProcesados=o}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})},a.filtrarProformasOperaciones=function(o,e,r,i){if(void 0!==r)for(var t in o)0==o[t]&&(o[t]="");else for(var t in o)""!==o[t]&&null!==o[t]||(o[t]=0);if(void 0!==e&&e)return o;a.obtenerProformas(!0)},a.obtenerProformas=function(o,e){l.start(),a.filtro=a.filtrarProformasOperaciones(a.filtro,!0),a.paginator.filter=a.filtro,o&&(a.paginator.currentPage=1),v(a.paginator).then(function(o){a.proformas=o.proformas.map(function(a){return a.eliminado?a.color="red":a.color="",a}),a.paginator.setPages(o.count),void 0!==o.mensaje&&a.mostrarMensaje(o.mensaje),a.filtro=a.filtrarProformasOperaciones(a.filtro,!0,!0),d(function(){a.$apply(function(){a.totalProformas=0,a.totalProformasDolar=0,a.calcularTotalProformas()})},1e3),l.stop()}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})},a.guardarProforma=function(o,e){if(l.start(),o&&a.detallesProformas.length>0){if(a.detallesProformas.some(function(a){return a.editar}))return a.mostrarMensaje("No ha finalizado la edición de un detalle. No se puede guardar."),void l.stop();if(void 0!==e.id){var r=0;if(a.detallesProformas.forEach(function(a){a.eliminado&&(r+=1)}),r===a.detallesProformas.length)return a.mostrarMensaje("Se requiere al menos un dellate."),void l.stop();e.detallesProformas=a.detallesProformas,e.usuarioProforma=a.usuario,e.id_empresa=a.usuario.empresa.id,e.fecha_proforma=new Date(a.convertirFecha(e.fecha_proforma)),e.movimiento="PFR",M(e.id,e).then(function(o){a.mostrarMensaje(o.mensaje),void 0===o.hasErr?(a.cerrardialogProformaEdicion(),a.recargarItemsTabla()):a.proforma=o.proforma,l.stop()}).catch(function(o){l.stop();var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})}else{e.id_empresa=a.usuario.empresa.id,e.detallesProformas=a.detallesProformas,e.usuarioProforma=a.usuario,e.fecha_proforma=new Date(a.convertirFecha(e.fecha_proforma)),F(a.usuario.empresa.id,a.usuario.id,e).then(function(o){a.mostrarMensaje(o.mensaje),void 0===o.hasErr?(a.cerrardialogProformaEdicion(),a.recargarItemsTabla()):e.fecha_proforma=a.fechaATexto(e.fecha_proforma),l.stop()}).catch(function(o){e.fecha_proforma=a.fechaATexto(e.fecha_proforma),l.stop();var r=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(r)})}}else a.mostrarMensaje("Falta algún dato requerido. Por favor revise el formulario."),l.stop()},a.fechaATexto=function(a){return fech=new Date(a),a=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},a.abrirdialogProformaEdicion=function(o){void 0!==o?a.detalleProforma=void 0:(a.proforma.nueva=!0,a.proforma.sucursal=a.sucursales[0],a.proforma.fecha_proforma=(new Date).toLocaleDateString(),a.proforma.periodo_mes={id:(new Date).getMonth()},a.proforma.periodo_anio={id:(new Date).getFullYear()},a.obtenerCambioMonedaProforma(new Date),a.detalleProforma=void 0,a.obtenerActividadesSucursal(a.proforma.sucursal.id)),a.detalleProforma={},a.abrirPopup(a.dialogProformaEdicion)},a.cerrardialogProformaEdicion=function(){a.proforma.ver=void 0,a.detallesProformas=[],a.proforma={},a.configuracionActividadServicio=[],a.actividadesSucursal=[],a.listaCentroCostosClienteEmpresaPro=[],a.cerrarPopup(a.dialogProformaEdicion)},a.abrirConfiguracionActividadesServicios=function(){a.obtenerSucursales(),a.obtenerActividadesEmpresa(a.usuario.empresa.id),a.abrirPopup(a.modalConfiguracionActividadesServicios)},a.abrirdialogClientesProforma=function(){a.abrirPopup(a.dialogClientesProforma)},a.cerrardialogClientesProforma=function(){a.cerrarPopup(a.dialogClientesProforma)},a.obtenerActividadesEmpresa=function(o){_(o).then(function(o){a.actividadesEmpresaSinRepeticion=[],a.actividadesEmpresa=o.actividades,a.actividadesEmpresa.map(function(o){0==a.actividadesEmpresaSinRepeticion.length&&a.actividadesEmpresaSinRepeticion.push(o),a.actividadesEmpresaSinRepeticion.some(function(a,e){return a.actividad.id===o.actividad.id})||a.actividadesEmpresaSinRepeticion.push(o)})},function(o){a.mostrarMensaje(void 0!==o.stack?o.stack:o.message)})},a.obtenerActividadesDosificadasEmpresa=function(o){_(o).then(function(o){a.actividadesDosificadosEmpresa=o.actividades},function(o){a.mostrarMensaje(void 0!==o.stack?o.stack:o.message)})},a.abrirConfiguracionActividades=function(){a.obtenerSucursales(),a.obtenerActividadesGral(),a.obtenerActividadesEmpresa(a.usuario.empresa.id),a.abrirPopup(a.modalConfiguracionActividades)},a.cerrarConfiguracionActividades=function(){a.sucursalActividades=void 0,a.actividadEconomicaEmpresa=void 0,a.actividadesSucursal=[],a.obtenerActividadesEmpresa(a.usuario.empresa.id),a.recargarItemsTabla(),a.cerrarPopup(a.modalConfiguracionActividades)},a.abrirdialogmodalFechas=function(o,e){if(a.proformaFechas=o,a.abrirPopup(a.dialogmodalFechas),null!==a.proformaFechas.fecha_recepcion){var r=new Date(a.proformaFechas.fecha_recepcion).toLocaleDateString();a.proformaFechas.fecha_recepcion="Invalid Date"===r?new Date(a.convertirFecha(a.proformaFechas.fecha_recepcion)).toLocaleDateString():r}if(null!==a.proformaFechas.fecha_factura){r=new Date(a.proformaFechas.fecha_factura).toLocaleDateString();a.proformaFechas.fecha_factura="Invalid Date"===r?new Date(a.convertirFecha(a.proformaFechas.fecha_factura)).toLocaleDateString():r}if(null!==a.proformaFechas.fecha_proforma_ok){r=new Date(a.proformaFechas.fecha_proforma_ok).toLocaleDateString();a.proformaFechas.fecha_proforma_ok="Invalid Date"===r?new Date(a.convertirFecha(a.proformaFechas.fecha_proforma_ok)).toLocaleDateString():r}null!==a.proformaFechas.fecha_cobro&&(a.proformaFechas.fecha_cobro="Invalid Date"===r?new Date(a.convertirFecha(a.proformaFechas.fecha_cobro)).toLocaleDateString():r)},a.cerrardialogmodalFechas=function(){a.proformaFechas=void 0,a.recargarItemsTabla(),a.cerrarPopup(a.dialogmodalFechas)},a.cerrarConfiguracionActividadesServicios=function(){a.nActividad={},a.configuracionActividadServicio=[],a.recargarItemsTabla(),a.cerrarPopup(a.modalConfiguracionActividadesServicios)},a.abrirConfiguracionCentrosCostos=function(o){null!==o&&void 0!==o?(a.centroCostosClienteEmpresa||(a.centroCostosClienteEmpresa={}),a.centroCostosClienteEmpresa.empresa=o,a.centroCostosClienteEmpresa.desdeProforma=!0,a.obtenercentroCostosClienteEmpresa(o),a.abrirPopup(a.asignacionCentroCostoCliente)):a.abrirPopup(a.asignacionCentroCostoCliente)},a.cerrarConfiguracionCentrosCostos=function(){a.listaCentroCostosClienteEmpresa=[],a.centroCostosClienteEmpresa={},a.cerrarPopup(a.asignacionCentroCostoCliente)},a.agregarDetalleCentroCostosCliente=function(o){if(a.listaCentroCostosClienteEmpresa.some(function(a){return a.id==o.centroCosto.id}))a.mostrarMensaje("El centro ya fué asigando. No se puede duplicar.");else{var e=Object.assign({},o.centroCosto);e.nuevo=!0,a.listaCentroCostosClienteEmpresa.push(e)}},a.eliminarAsignacionCentroCosto=function(o){a.listaCentroCostosClienteEmpresa[a.listaCentroCostosClienteEmpresa.indexOf(o)].eliminado=!0},a.guardarAsignacionCentroCostos=function(o,e){if("Siguiente"!=$("#siguiente").text().trim()){var r=[];a.listaCentroCostosClienteEmpresa.forEach(function(a){(a.nuevo||a.eliminado)&&r.push(a)}),L(o.id,r).then(function(o){a.mostrarMensaje(o.mensaje),o.hasErr||(a.centroCostosClienteEmpresa.desdeProforma&&r.forEach(function(o){if(o.nuevo&&!o.eliminado&&a.listaCentroCostosClienteEmpresaPro.push(o),o.eliminado){var e=a.listaCentroCostosClienteEmpresaPro.indexOf(o);e>-1&&a.listaCentroCostosClienteEmpresaPro.splice(e,1)}}),a.cerrarConfiguracionCentrosCostos())}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})}},a.obtenercentroCostosClienteEmpresa=function(o){a.listaCentroCostosClienteEmpresa=[],a.listaCentroCostosClienteEmpresaPro=[],B(o.id).then(function(o){o.hasErr?a.mostrarMensaje(o.mensaje):(a.listaCentroCostosClienteEmpresa=o.centros.map(function(a){return a.centroCosto}),a.listaCentroCostosClienteEmpresaPro=Object.assign([],a.listaCentroCostosClienteEmpresa))}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e)})},a.showInHist=function(a,o){return!(a.id_actividad!=o.id_actividad||!a.expirado)},a.PopoverConfiguracionActividad={templateUrl:"PopoverConfiguracionActividad.html",title:"Menu",isOpen:!1},a.PopoverConfiguracionLlenarTabla={templateUrl:"PopoverConfiguracionLlenarTabla.html",title:"Empresas",isOpen:!1},a.PopoverConfiguracionActividadhistorial={templateUrl:"PopoverConfiguracionActividadhistorial.html",title:"Historial dosificacion actividad",isOpen:!1},a.impresiones={templateUrl:"impresiones.html",title:"Opcion de impresion",isOpen:!1},a.imprimir=function(o,e){l.start(),C(o.id,o.actividadEconomica.id).then(function(o){if(a.proforma=o.proforma,void 0!==o.mensaje||null==o.proforma||void 0==o.proforma)null!=o.proforma&&void 0!=o.proforma||void 0!=o.mensaje?a.mostrarMensaje(o.mensaje):a.mostrarMensaje("No se encuentra la información requerida");else{a.proforma.fecha_proforma=a.fechaATexto(new Date(a.proforma.fecha_proforma));var r=new Date(a.convertirFecha(a.proforma.fecha_proforma));u(r).then(function(o){o.monedaCambio?(a.moneda=o.monedaCambio,void 0!==a.detalleProforma&&a.calcularImporte()):(a.moneda={ufv:"--",dolar:"--"},a.mostrarMensaje("La fecha "+a.proforma.fecha_proforma+" no tiene datos del tipo de cambio de dolar. El tipo de cambio de dolar no afecta la información de la proforma y puede continuar sin problema.")),convertUrlToBase64Image(a.usuario.empresa.imagen,function(o){if(o.length>0&&"error"!==o){var r=o;0==e&&a.imprimirSinDetalle(a.proforma,r),1==e&&a.imprimirConDetalle(a.proforma,r),2==e&&a.imprimirMixto(a.proforma,r)}else convertUrlToBase64Image("img/agilsoftware.png",function(o){if(o.length>0&&"error"!==o){a.mostrarMensaje("No se encuentra la imagen de la empresa. Se usara la imagen del software.");var r=o;0==e&&a.imprimirSinDetalle(a.proforma,r),1==e&&a.imprimirConDetalle(a.proforma,r),2==e&&a.imprimirMixto(a.proforma,r)}else convertUrlToBase64Image("img/agilsoftware.png",function(o){a.mostrarMensaje("No se encuentra la imagen de la empresa ni la imagen alternativa. No se imprimira la la imagen.");var r=o;0==e&&a.imprimirSinDetalle(a.proforma,r),1==e&&a.imprimirConDetalle(a.proforma,r),2==e&&a.imprimirMixto(a.proforma,r)})})}),l.stop()}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e),l.stop()})}}).catch(function(o){var e=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(e),l.stop()})},a.imprimirMixto=function(o,e){a.proforma=o;var r=new PDFDocument({size:"letter",margin:10,compress:!1}),i=r.pipe(blobStream());new Date;r.font("Helvetica",8);var t=245,n=0,c=1,s=Math.ceil(1/29);a.dibujarCabeceraPDFImpresion(r,c,s,a.proforma,e);for(var d=0,m=0;m<=a.proforma.detallesProformas.length&&n<=29;m++){if(r.font("Helvetica",8),0==m){r.text(a.proforma.detalle,150,t-2,{width:260});var f=null!==a.proforma.detalle?a.proforma.detalle.length:0;d=20*Math.ceil(f/260)}else r.text(a.proforma.detallesProformas[m-1].cantidad,70,t-2),r.text(a.proforma.detallesProformas[m-1].servicio.nombre,150,t-2,{width:260}),r.text(a.number_format(a.proforma.detallesProformas[m-1].precio_unitario,2),440,t-2),r.text(a.number_format(a.proforma.detallesProformas[m-1].importe,2),510,t-2);t=t+20+d,1===m?a.proforma.importe:0,1===m?a.proforma.cantidad:0,d=0,0,(++n>29||t>700)&&(r.addPage({size:[612,792],margin:10}),t=245,n=0,c+=1,a.dibujarCabeceraPDFImpresion(r,c,s,a.proforma,e))}r.rect(40,705,540,15).stroke(),r.rect(40,725,540,15).stroke(),a.proforma.importeLiteral=ConvertirALiteral(a.proforma.totalImporteBs.toFixed(2)),r.text("Son : "+a.proforma.importeLiteral,58,710),r.text(a.number_format(a.proforma.totalImporteBs,2),510,710),r.rect(41,725,538,14).fill("silver","#000").fill("black"),r.text("Son : "+a.number_format(a.proforma.totalImporteBs/a.moneda.dolar,2)+"  Dólares x "+a.moneda.dolar,58,730),r.end(),i.on("finish",function(){var a=i.toBlobURL("application/pdf");window.open(a,"_blank","location=no")}),l.stop()},a.imprimirConDetalle=function(o,e){a.proforma=o;var r=new PDFDocument({size:"letter",margin:10,compress:!1}),i=r.pipe(blobStream());new Date;r.font("Helvetica",8);var t=245,n=0,c=1,s=Math.ceil(1/29);a.dibujarCabeceraPDFImpresion(r,c,s,a.proforma,e);for(var d=0,m=0;m<a.proforma.detallesProformas.length&&n<=29;m++)r.font("Helvetica",8),r.text(a.proforma.detallesProformas[m].cantidad,70,t-2),r.text(a.proforma.detallesProformas[m].servicio.nombre,150,t-2,{width:260}),r.text(a.number_format(a.proforma.detallesProformas[m].precio_unitario,2),440,t-2),r.text(a.number_format(a.proforma.detallesProformas[m].importe,2),510,t-2),a.proforma.detallesProformas[m].servicio.nombre.length>260&&(d=10*Math.ceil(a.proforma.detallesProformas[m].servicio.nombre.length/260)),t=t+20+d,1===m?a.proforma.importe:0,1===m?a.proforma.cantidad:0,d=0,(++n>29||t>700)&&(r.addPage({size:[612,792],margin:10}),t=245,n=0,c+=1,a.dibujarCabeceraPDFImpresion(r,c,s,a.proforma,e));r.rect(40,705,540,15).stroke(),r.rect(40,725,540,15).stroke(),a.proforma.importeLiteral=ConvertirALiteral(a.proforma.totalImporteBs.toFixed(2)),r.text("Son : "+a.proforma.importeLiteral,58,710),r.text(a.number_format(a.proforma.totalImporteBs,2),510,710),r.rect(41,725,538,14).fill("silver","#000").fill("black"),r.text("Son : "+a.number_format(a.proforma.totalImporteBs/a.moneda.dolar,2)+"  Dólares x "+a.moneda.dolar,58,730),r.end(),i.on("finish",function(){var a=i.toBlobURL("application/pdf");window.open(a,"_blank","location=no")}),l.stop()},a.imprimirSinDetalle=function(o,e){a.proforma=o;var r=new PDFDocument({size:"letter",margin:10,compress:!1}),i=r.pipe(blobStream());new Date;r.font("Helvetica",8);var t=245,n=Math.ceil(1/29);a.dibujarCabeceraPDFImpresion(r,1,n,a.proforma,e),r.font("Helvetica",8);a.proforma.detallesProformas.map(function(a){a.cantidad}),r.text(1,70,t-2),r.text(a.proforma.detalle,150,t-2,{width:260}),extraDetalle=20*Math.ceil(a.proforma.detalle.length/260),r.text(a.number_format(a.proforma.totalImporteBs,2),440,t-2),r.text(a.number_format(a.proforma.totalImporteBs,2),510,t-2),t=t+20+extraDetalle,a.proforma.importeLiteral=ConvertirALiteral(a.proforma.totalImporteBs.toFixed(2)),r.rect(40,705,540,15).stroke(),r.rect(40,725,540,15).stroke(),r.text("Son : "+a.proforma.importeLiteral,58,710),r.text(a.number_format(a.proforma.totalImporteBs,2),510,710),r.rect(41,725,538,14).fill("silver","#000").fill("black"),r.text("Son : "+a.number_format(a.proforma.totalImporteBs/a.moneda.dolar,2)+"  Dólares x "+a.moneda.dolar,58,730),r.end(),i.on("finish",function(){var a=i.toBlobURL("application/pdf");window.open(a,"_blank","location=no")}),l.stop()},a.dibujarCabeceraPDFImpresion=function(o,e,r,i,t){var n=(new Date).getDate()+"/"+((new Date).getMonth()+1)+"/"+(new Date).getFullYear();o.rect(40,210,540,25).fillAndStroke("silver","#000"),o.font("Helvetica-Bold",12).fill("black"),o.text("PROFORMA",0,130,{align:"center"}),o.font("Helvetica-Bold",8),o.font("Helvetica",8),o.font("Helvetica-Bold",8),o.font("Helvetica",8),t&&o.image(t,40,30,{fit:[100,100]}),o.text(a.usuario.empresa.telefono1,80,110),o.text(a.usuario.empresa.direccion+" Santa Cruz",40,120,{width:90}),o.text("Santa Cruz,     ",65,165,{lineBreak:!1}).font("Helvetica-Bold",10).text(n.split("/")[0],{lineBreak:!1}).font("Helvetica",10).text("   de   ",{lineBreak:!1}).font("Helvetica-Bold",10).text(a.meses[new Date(a.convertirFecha(n)).getMonth()].nombre,{lineBreak:!1}).font("Helvetica",10).text("   de   ",{lineBreak:!1}).font("Helvetica-Bold",10).text(n.split("/")[2]),o.font("Helvetica-Bold",8),o.font("Helvetica",8),o.font("Helvetica-Bold",14),o.text("N°",380,60,{align:"center"}),o.text(i.correlativo,510,60),o.rect(40,210,540,25).stroke().fill("silver"),o.rect(0,0,0,0).stroke().fill("black"),o.font("Helvetica-Bold",8),o.text("CANTIDAD",55,220),o.text("DETALLE",200,220),o.text("P.UNIT",440,220),o.text("IMPORTE BS",510,220),o.text("Señor (es):",50,193),o.text("CI/NIT:",440,195),o.text("Teléfono:",40,110),o.font("Helvetica",8),o.text(i.cliente.razon_social,100,193),o.text(i.cliente.nit,500,195),o.rect(40,160,540,20).stroke(),o.rect(40,185,540,20).stroke(),o.rect(40,210,540,490).stroke(),o.rect(120,210,0,490).stroke(),o.rect(430,210,0,490).stroke(),o.rect(490,210,0,490).stroke(),o.text("Nota: La aprobación de la proforma deberá realizarse dentro de los próximos 7 días a partir de la fecha de recepción",0,750,{align:"center"})},a.inicio()}]);