angular.module("agil.controladores").controller("ControladorOperaciones",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","blockUI","ConfiguracionVentaVistaDatos","ClasesTipo","ListaGruposProductoEmpresa","ProductosOperaciones","socket","ListaGruposProductoEmpresa","SolicitudesReposicion","SolicitudesFormulacionProducto","SolicitudReposicion","EliminarSolicitudReposicion","Paginator","ImpresionSolicitudDatos","ListaInventariosProducto","ListaSucursalesUsuario","ListaGruposProductoUsuario","CerrarSolicitud","Solicitud","ProveedoresNit","ListaProductosEmpresaUsuario","$timeout","GuardarPedido","ListaProveedores","ProductosPaginadorSubgrupos","ListaProductosProveedores","ProductosPaginadorAsignados","ActualizarProductosProveedor","ListaSubGruposProductoEmpresa","ObtenerImagen",function(o,e,i,a,t,r,d,s,n,c,u,l,p,v,l,g,f,P,m,h,S,b,_,D,x,k,E,M,C,I,w,j,A,B,V,T,O){o.usuarioSesion=JSON.parse(s.usuario),o.idDialogDialogPanelOperaciones="dialog-panel-operaciones",o.idDialogDatos="modal-wizard-venta-edicion",o.idDialogEntregaViveres="dialogEntregaViveres",o.idConfirmacionCierre="dialog-confirmacion-entrega",o.idDialogTotalIngredientes="dialog-total-ingredientes",o.idDialogoListadoPedido="modal-listado-nuevo-pedido",o.idDialogoNuevoPedido="modal-nuevo-pedido",o.idDialogProductosProveedor="dialog-productos-proveedor-configuracion",o.idDialogBusquedaProveedor="dialog-Busqueda-proveedor",o.idDialogProductosAsigandosProveedor="dialog-productos-proveedor-asignados",o.$on("$viewContentLoaded",function(){resaltarPestaña(r.path().substring(1)),C(function(){ejecutarScriptsOperaciones(o.idDialogDialogPanelOperaciones,o.idDialogDatos,o.idDialogEntregaViveres,o.idConfirmacionCierre,o.idDialogTotalIngredientes,o.idDialogoListadoPedido,o.idDialogoNuevoPedido,o.idDialogProductosProveedor,o.idDialogBusquedaProveedor,o.idDialogProductosAsigandosProveedor),o.buscarAplicacion(o.usuarioSesion.aplicacionesUsuario,r.path().substring(1))},500)}),o.$on("$routeChangeStart",function(e,i){o.eliminarPopup(o.idDialogDialogPanelOperaciones),o.eliminarPopup(o.idDialogDatos),o.eliminarPopup(o.idDialogEntregaViveres),o.eliminarPopup(o.idConfirmacionCierre),o.eliminarPopup(o.idDialogTotalIngredientes),o.eliminarPopup(o.idDialogoListadoPedido),o.eliminarPopup(o.idDialogoNuevoPedido),o.eliminarPopup(o.idDialogProductosProveedor),o.eliminarPopup(o.idDialogBusquedaProveedor),o.eliminarPopup(o.idDialogProductosAsigandosProveedor)}),o.inicio=function(){o.imprimir={detalle:!1},o.listaProductosProveedor=[],o.seleccionProductosProveedor={seleccionar_todos:!1},o.productosAsignadosPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},o.configuracionPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},o.detallesPedido=[],o.mostarBusquedaProducto=!1,o.ordenProductos=!0,o.esContado=!0,o.obtenerConfiguracionVentaVista(),o.alreadyCalculated=!1,o.sucursalesUsuario="";for(var e=0;e<o.usuarioSesion.sucursalesUsuario.length;e++)o.sucursalesUsuario=o.sucursalesUsuario+o.usuarioSesion.sucursalesUsuario[e].sucursal.id,e+1!=o.usuarioSesion.sucursalesUsuario.length&&(o.sucursalesUsuario=o.sucursalesUsuario+",");o.obtenerProveedores(),o.obtenerProductos(),o.obtenerProductosAsignados(),o.obtenerPaginador(),o.sucursales=o.obtenerSucursales(),o.obtenerSubGruposProductosEmpresaUsuario()},o.obtenerProveedores=function(){w(o.usuarioSesion.id_empresa).then(function(e){o.proveedores=e.proveedores,o.proveedoresProcesado=e.proveedores}).catch(function(e){o.proveedores=[];var i=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";o.mostrarMensaje(i)})},o.filtrarProveedores=function(i){void 0!==o.proveedores?o.proveedoresProcesado=e("filter")(o.proveedores,i):o.proveedoresProcesado=[]},o.agregarProductosSeleccionados=function(){o.productosProveedorSeleccionados.length>0?o.productosProveedorSeleccionados.forEach(function(e,i,a){o.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,id_grupo:e.id_grupo,id_subgrupo:e.id_subgrupo},o.agregardetallePedido(o.detallePedido),i===a.length&&o.cerrarModalProductosAsignadosProveedor()}):o.mostrarMensaje("No se seleccionó ningún producto para ser agregado.")},o.establecerProveedor=function(e,i){o.productosAsignadosProveedor=[],void 0===o.pedido&&(o.pedido={}),o.pedido.proveedor=e,void 0!==i&&o.cerrarModalBusquedaProveedor(),o.pedido.por_proveedor&&o.generarPorProveedor()},o.abrirModalProductosProveedor=function(e){o.checkProveedor(e)?(o.buscarProductos(null,o.pedido),o.abrirPopup(o.idDialogProductosProveedor)):o.mostrarMensaje("Seleccione un proveedor para ver su asignación de productos..")},o.generarPorProveedor=function(){if(o.pedido.proveedor)if(o.pedido.por_proveedor)if(o.pedido.proveedor.productos.length>0){o.paginatorProductosAsignados.filter=o.productosAsignadosPorveedor.grupo?o.productosAsignadosPorveedor.grupo:{id:0};A(o.usuarioSesion.id_empresa,o.pedido.proveedor).then(function(e){if(e.hasErr)o.mostrarMensaje(e.mensaje),o.listaProductosProveedor=[];else if(e.productos){var i=e.productos.split(",");o.listaProductosProveedor=i.map(function(o){return parseInt(o)}),B(o.usuarioSesion.id_empresa,o.paginatorProductosAsignados,o.usuarioSesion.id,o.listaProductosProveedor,!0).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.paginatorProductosAsignados.setPages(e.paginas),o.productosAsignadosProveedor=e.productos,o.productosAsignadosProveedor.forEach(function(e){o.listaProductosProveedor.some(function(o){return o===e.id})&&(o.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,id_grupo:e.id_grupo,id_subgrupo:e.id_subgrupo},o.agregardetallePedido(o.detallePedido))})),n.stop()}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(i)})}else o.mostrarMensaje("El proveedor no tiene productos asignados."),o.listaProductosProveedor=[];n.stop()}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(i)})}else o.mostrarMensaje("El proveedor no tiene productos asignados.");else o.detallePedido={},o.detallesPedido=[];else o.mostrarMensaje("Seleccione un proveedor.")},o.verificarAsignacionProductosProveedor=function(){o.listaProductosProveedor.length>0&&o.listaProductosProveedor.forEach(function(e){o.productosAsignacionProveedor.forEach(function(o){o.id===e&&(o.seleccionado=!0)})})},o.checkProveedor=function(e){return!!o.pedido&&(!!o.pedido.proveedor&&!!o.pedido.proveedor.id)},o.buscarProveedor=function(e){if(""!=e&&void 0!=e)return E(o.usuario.id_empresa,e)},o.buscarProducto=function(e,i){if(void 0!==o.pedido)return""!=e&&void 0!=e&&void 0==i&&o.pedido.almacen?M(o.usuarioSesion.id_empresa,e,o.usuarioSesion.id,o.pedido.almacen):""!=e&&void 0!=e&&i&&o.pedido.almacen?M(o.usuarioSesion.id_empresa,e,o.usuarioSesion.id,o.pedido.almacen):void o.mostrarMensaje("Seleccione un almacen.");o.mostrarMensaje("Seleccione un almacen.")},o.establecerProducto=function(e,i){o.detallePedido={},e.tipoProducto=null==e.tipoProducto?{id:e["tipoProducto.id"],nombre:e["tipoProducto.nombre"],nombre_corto:e["tipoProducto.nombre_corto"]}:e.tipoProducto;var a=0;e.inventarios.length>0&&e.inventarios.forEach(function(o){a+=o.cantidad}),o.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,inventario_disponible:a}},o.nuevoPedido=function(){o.detallesPedido=[],o.pedido={},o.detallePedido={},o.abrirModalNuevoPedido()},o.generarPedido=function(){o.detallesPedido=[],o.pedido={generado:!0},o.detallePedido={};var e=o.calcularViveresDesdeFiltro(!0);o.detallesPedido=e.map(function(o){return o.producto.inventarios.length>0&&o.producto.inventarios.forEach(function(o){o.cantidad}),{producto:o.producto,precio_unitario:o.producto.precio_unitario,cantidad:o.cantidad,solicitud:o.solicitud}}),o.abriridDialogoListadoPedido()},o.agregardetallePedido=function(e){void 0!==e&&null!==e?(o.detallesPedido.some(function(o){return o.producto.id===e.producto.id})?o.detallesPedido.forEach(function(o){o.producto.id===e.producto.id&&(o.cantidad+=e.cantidad)}):o.detallesPedido.push(e),o.detallePedido=void 0):o.mostrarMensaje("Ocurrió un problema, no se puede agregar un valor no definido o nulo.")},o.interceptarTecla=function(e,i,a){13===e.which&&(a?o.enfocar(i):C(function(){$("#"+i).trigger("click")},0))},o.mostrarBusqueda=function(){o.mostarBusquedaProducto?o.mostarBusquedaProducto=!1:o.mostarBusquedaProducto=!0},o.obtenerSubGruposProductosEmpresaUsuario=function(){n.start(),T(o.usuarioSesion.id_empresa,o.usuarioSesion.id).then(function(e){n.stop(),e.length>0?o.subGruposProducto=e:(o.subGruposProducto=[],o.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){o.subGruposProducto=[];var i=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";o.mostrarMensaje(i),n.stop()})},o.obtenerPaginador=function(){n.start(),o.paginator=h(),o.paginator.column="fecha",o.paginator.direccion="asc",o.filtro={empresa:o.usuarioSesion.id_empresa,rol:o.usuarioSesion.rolesUsuario[0].rol.nombre,id:o.usuarioSesion.id,desde:0,hasta:0,sucursal:0,almacen:0,movimiento:0,estado:0,valuado:0,pagina:1,items_pagina:10,busqueda:""},o.paginator.callBack=o.obtenerSolicitudes,o.paginator.getSearch("",o.filtro,null),n.stop()},o.obtenerSolicitudes=function(){n.start(),o.filtro.busqueda=o.paginator.search,o.filtro.desde=void 0!==o.filtro.fechaInicioTexto&&""!==o.filtro.fechaInicioTexto?o.convertirFecha(o.filtro.fechaInicioTexto):0,o.filtro.hasta=void 0!==o.filtro.fechaFinTexto&&""!==o.filtro.fechaFinTexto?o.convertirFecha(o.filtro.fechaFinTexto):0,o.filtro.movimiento=0,o.filtro.estado=null!==o.filtro.estado&&void 0!==o.filtro.estado.id?o.filtro.estado.id:0,o.paginator.filter=o.filtro,g(o.paginator).then(function(e){o.paginator.setPages(e.paginas),o.solicitudesOperaciones=e.solicitudes,n.stop()}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(i)})},o.obtenerSucursales=function(){for(var e=[],i=0;i<o.usuarioSesion.sucursalesUsuario.length;i++)e.push(o.usuarioSesion.sucursalesUsuario[i].sucursal);return e},o.obtenerAlmacenes=function(e){if(void 0===e&&(o.filtro.sucursal=void 0,o.almacenes=[]),void 0!==e){o.almacenes=[];var i=$.grep(o.sucursales,function(o){return o.id==e})[0];o.almacenes=i?i.almacenes:[]}},o.eliminar=function(e){o.solicitud=e,m(e).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.recargarItemsTabla(),o.solicitud=void 0),n.stop()}).catch(function(e){o.solicitud=void 0;var i=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";o.mostrarMensaje(i),n.stop()}),o.cerrarConfirmacionEliminacion()},o.ver=function(e){o.solicitud=e,o.solicitud.ver=!0,o.solicitud.sucursal=o.solicitud.almacen.sucursal,o.obtenerAlmacenes(o.solicitud.sucursal.id),o.solicitud.almacen=o.solicitud.almacen,o.abrirDialogPanelOperaciones()},o.calcularTotalViveres=function(e,i){if(o.totalViveresSolicitados={},void 0===e)throw new Error("Hubo un problema con la solicitud, no esta definida!");o.solicitud=e,o.totalViveresSolicitados.usuario=e.usuario,o.totalViveresSolicitados.fecha=e.fecha,o.totalViveresSolicitados.sucursal=e.almacen.sucursal,o.totalViveresSolicitados.almacen=e.almacen,o.totalViveresSolicitados.identificador=e.id,o.totalViveresSolicitados.productos=[];var a=[];o.solicitud.solicitudesProductos.map(function(i){if(!1===i.eliminado||void 0===i.eliminado){if(i.productoSolicitado.activar_inventario){var t={estado:e.activo,almacen:e.almacen,cantidad_ideal:i.cantidad,cantidad_real:i.cantidad,id:i.id,id_detalle_solicitud_producto:i.id,id_producto_base:i.productoSolicitado,productoSolicitudBase:i.productoSolicitado,total:i.cantidad,monto:e.monto,solicitud:e.id};o.totalViveresSolicitados.productos.push(t)}i.detallesIngredientesProducto.length>0&&i.detallesIngredientesProducto.map(function(o){if(void 0===o.eliminado||!1===o.eliminado){var i={estado:e.activo,almacen:e.almacen,cantidad_ideal:o.cantidad_ideal,cantidad_real:o.cantidad_real,id:o.id,id_detalle_solicitud_producto:o.id_detalle_solicitud_producto,id_producto_base:o.id_producto_base,productoSolicitudBase:o.productoSolicitudBase,total:0,monto:e.monto,solicitud:e.id};a.push(i)}})}});var t=[];o.solicitud.solicitudesProductos.map(function(o){for(var e=0;e<a.length;)a.forEach(function(o,i,r){e>i&&a[e].id_producto_base===o.id_producto_base&&t.push(i)}),e+=1}),t.forEach(function(o){delete a[o]}),a.map(function(i){if(void 0!==i){var a={estado:e.activo,almacen:e.almacen,cantidad_ideal:0,cantidad_real:0,id:i.id,id_detalle_solicitud_producto:i.id_detalle_solicitud_producto,id_producto_base:i.id_producto_base,productoSolicitudBase:i.productoSolicitudBase,total:0,monto:e.monto,solicitud:e.id};o.totalViveresSolicitados.productos.push(a)}}),o.solicitadoTotalFinalBs=0;if(o.totalViveresSolicitados.productos.map(function(e){e.totalMostrar=0,o.solicitud.solicitudesProductos.map(function(i){i.detallesIngredientesProducto.map(function(i){e.id_producto_base==i.id_producto_base&&(e.cantidad_ideal+=i.cantidad_ideal,e.cantidad_real+=i.cantidad_real,e.totalMostrar+=i.total,e.total+=i.total,e.totalSumar=i.total,e.totalbs=e.totalSumar*i.productoSolicitudBase.precio_unitario,o.solicitadoTotalFinalBs+=e.totalbs)}),e.id_producto_base==i.id_producto&&(e.cantidad_ideal=1,e.cantidad_real=i.cantidad,e.totalMostrar=i.cantidad,e.totalSumar=i.cantidad,e.total=i.cantidad,e.totalbs=e.totalSumar*i.productoSolicitado.precio_unitario,o.solicitadoTotalFinalBs+=e.totalbs)})}),o.alreadyCalculated=!0,void 0!==i)return o.totalViveresSolicitados;void 0!==e?o.abrirDialogTotalIngredientes():o.solicitud=void 0},o.clasificarGrupo=function(i){o.productosProcesados=e("filter")(o.productos,i),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},o.verFormulacion=function(e){if(void 0!==o.productoSeleccionado&&e.productoSolicitado.id!=o.productoSeleccionado.productoSolicitado.id){var i=o.solicitud.solicitudesProductos.indexOf(e);o.solicitud.solicitudesProductos[i].verFormulacion=void 0,o.productoSeleccionado.verFormulacion=void 0}void 0===e.verFormulacion?e.verFormulacion=!0:e.verFormulacion=void 0,o.productoSeleccionado=e},o.eliminarDetalleVenta=function(e,i){void 0===e.id?o.solicitud.solicitudesProductos.splice(o.solicitud.solicitudesProductos.indexOf(e),1):(e.eliminado=!0,e.cantidad=0,e.detallesIngredientesProducto.map(function(o){o.eliminado=!0}))},o.eliminarIngrediente=function(e){if(void 0===e.id?o.productoSeleccionado.detallesIngredientesProducto.splice(o.productoSeleccionado.detallesIngredientesProducto.indexOf(e),1):e.eliminado=!0,0==o.productoSeleccionado.detallesIngredientesProducto.length)o.eliminarDetalleVenta(o.productoSeleccionado,!0);else{var i=0;o.productoSeleccionado.detallesIngredientesProducto.map(function(o){i+=!0===o.eliminado?1:0}),i==o.productoSeleccionado.detallesIngredientesProducto.length&&o.eliminarDetalleVenta(o.productoSeleccionado)}},o.disminuirDetalleVenta=function(e){1==e.cantidad?o.eliminarDetalleVenta(e,!0):(e.cantidad=e.cantidad-1,e.detallesIngredientesProducto.map(function(o){o.total=e.cantidad*o.cantidad_ideal}))},o.actualizarTotalReal=function(o){o.detallesIngredientesProducto.map(function(e){e.total=o.cantidad*e.cantidad_ideal})},o.obtenerConfiguracionVentaVista=function(){n.start(),c(o.usuarioSesion.id_empresa).then(function(e){o.configuracionVentaVista=e,n.stop()})},o.guardarConfiguracionVentaVista=function(){ConfiguracionVentaVista.update({id_empresa:o.usuarioSesion.id_empresa},o.configuracionVentaVista,function(o){})},o.enfocar=function(o){C(function(){$("#"+o).focus()},0)},o.interceptarTecla=function(e,i,a){13===e.which&&(a?o.enfocar(i):C(function(){$("#"+i).trigger("click")},0))},o.getFecha=function(){return void 0!==o.solicitud?new Date(o.solicitud.fecha):new Date},o.guardarOperacionPanel=function(e,i){n.start();var a=0;if(e){var t=o.calcularTotalViveres(i,!0);i.listaProductosSolicitados=t,i.solicitudesProductos.map(function(o){var e=0;void 0!==o.detallesIngredientesProducto?o.detallesIngredientesProducto.length<1?void 0!==o.eliminado&&!1!==o.eliminado||(e+=o.productoSolicitado.precio_unitario*o.cantidad):void 0!==o.eliminado&&!1!==o.eliminado||o.detallesIngredientesProducto.map(function(o){void 0!==o.eliminado&&!1!==o.eliminado||(e+=o.total*o.productoSolicitudBase.precio_unitario)}):void 0===o.eliminado&&(e+=o.productoSolicitado.precio_unitario*o.cantida),a+=e}),i.monto=a;var r=new Date,d=i.fecha.split("/").reverse();i.fecha=new Date(d[0],d[1]-1,d[2],r.getHours(),r.getMinutes()),i.id_usuario=o.usuarioSesion.id,i.activo=!0,k(i,o.usuarioSesion.id_empresa,i.modificar).then(function(e){e.hasErr?(o.mostrarMensaje(e.mensaje),i.fecha=new Date(i.fecha).toLocaleDateString()):(o.mostrarMensaje(e.mensaje),o.recargarItemsTabla()),n.stop()}).catch(function(e){var a=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";o.mostrarMensaje(a),i.fecha=new Date(i.fecha).toLocaleDateString(),n.stop()})}else o.mostrarMensaje("Complete los campos requeridos"),n.stop()},o.obtenerInventariosProdSolicitud=function(){o.solicitud.solicitudesProductos.map(function(e){b(e.productoSolicitado.id,o.solicitud.almacen.id).then(function(o){e.inventarios=o})})},o.obtenerInventarioTotal=function(e){var i=0;if(b(e.id,o.solicitud.almacen.id).then(function(o){e.inventarios=o;for(var i=0;i<e.inventarios.length;i++)e.inventarios[i].fecha_vencimiento=e.inventarios[i].fecha_vencimiento?new Date(e.inventarios[i].fecha_vencimiento):null,e.inventarios[i].fechaVencimientoTexto=e.inventarios[i].fecha_vencimiento?e.inventarios[i].fecha_vencimiento.getDate()+"/"+(e.inventarios[i].fecha_vencimiento.getMonth()+1)+"/"+e.inventarios[i].fecha_vencimiento.getFullYear():"",e.inventarios[i].detallesMovimiento[0].movimiento.fecha=new Date(e.inventarios[i].detallesMovimiento[0].movimiento.fecha),e.inventarios[i].detallesMovimiento[0].movimiento.fechaTexto=e.inventarios[i].detallesMovimiento[0].movimiento.fecha.getDate()+"/"+(e.inventarios[i].detallesMovimiento[0].movimiento.fecha.getMonth()+1)+"/"+e.inventarios[i].detallesMovimiento[0].movimiento.fecha.getFullYear()}).catch(function(e){var i=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";return o.mostrarMensaje(i),0}),e.activar_inventario){for(var a=0;a<e.inventarios.length;a++)i+=e.inventarios[a].cantidad;if(void 0!==o.solicitud.solicitudesProductos&&o.solicitud.copia)for(var t=0;t<o.solicitud.solicitudesProductos.length;t++)o.solicitud.solicitudesProductos[t].productoSolicitado.id==e.id&&(i-=o.solicitud.solicitudesProductos[t].cantidad)}else i=5e5;return i},o.cargarProductos=function(){p(o.usuarioSesion.id_empresa,o.solicitud.almacen.id,o.usuarioSesion.id).then(function(e){if(e.length>0){for(var i=0;i<e.length;i++)e[i].activar_inventario&&(e[i].inventario_disponible=o.obtenerInventarioTotal(e[i]));o.productos=e}else o.productos=[];if(angular.isDefined(s.productosProcesados)){o.productosProcesados=e;for(i=0;i<s.productosProcesados.length;i++)for(var a=0;a<o.productosProcesados.length;a++)s.productosProcesados[i].id==o.productosProcesados[a].id&&(o.productosProcesados[a].rankin=s.productosProcesados[i].rankin)}else o.productosProcesados=e;setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},o.agregarDetalleVentaPanel=function(e){o.cantidadInventario=0;var i={productoSolicitado:e,precio_unitario:e.precio_unitario,inventario_disponible:o.cantidadInventario,inventarios:e.inventarios,cantidad:1,detallesIngredientesProducto:[]};if(e.activar_inventario){o.cantidadInventario=e.inventario_disponible;var a=0,t=!1;if(void 0===o.solicitud.solicitudesProductos&&(o.solicitud.solicitudesProductos=[]),1<=o.cantidadInventario){for(;a<o.solicitud.solicitudesProductos.length&&!t;)void 0===o.solicitud.solicitudesProductos[a].eliminado&&o.solicitud.solicitudesProductos[a].productoSolicitado.id==e.id&&(o.solicitud.solicitudesProductos[a].cantidad=o.solicitud.solicitudesProductos[a].cantidad+1,o.solicitud.solicitudesProductos[a].eliminado=void 0,o.solicitud.solicitudesProductos[a].detallesIngredientesProducto.map(function(e){e.total=e.cantidad_ideal*o.solicitud.solicitudesProductos[a].cantidad}),t=!0,i=o.solicitud.solicitudesProductos[a]),a++;if(t)e.eliminado=void 0;else{var r=[];f(e.id).then(function(o){o.productosBase&&o.productosBase.forEach(function(o){ingrediente={cantidad_ideal:parseFloat(o.formulacion),cantidad_real:parseFloat(o.formulacion),total:parseFloat(o.formulacion),id_producto_base:o.productoBase.id,productoSolicitudBase:o.productoBase},r.push(ingrediente)})}),e.activar_inventario?1<=o.cantidadInventario?(i={productoSolicitado:e,precio_unitario:e.precio_unitario,inventario_disponible:o.cantidadInventario,inventarios:e.inventarios,cantidad:1,detallesIngredientesProducto:r},o.solicitud.solicitudesProductos.push(i)):o.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+o.cantidadInventario+"!"):(i={productoSolicitado:e,precio_unitario:e.precio_unitario,inventario_disponible:o.cantidadInventario,inventarios:e.inventarios,cantidad:1,detallesIngredientesProducto:r},o.solicitud.solicitudesProductos.push(i))}}else o.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+o.cantidadInventario+"!")}else{a=0,t=!1;if(o.solicitud.solicitudesProductos)for(;a<o.solicitud.solicitudesProductos.length&&!t;)void 0===o.solicitud.solicitudesProductos[a].eliminado&&o.solicitud.solicitudesProductos[a].productoSolicitado.id==e.id&&(o.solicitud.solicitudesProductos[a].cantidad=o.solicitud.solicitudesProductos[a].cantidad+1,o.solicitud.solicitudesProductos[a].eliminado=void 0,o.solicitud.solicitudesProductos[a].detallesIngredientesProducto.map(function(e){e.total=e.cantidad_ideal*o.solicitud.solicitudesProductos[a].cantidad}),t=!0,i=o.solicitud.solicitudesProductos[a]),a++;else o.solicitud.solicitudesProductos=[];if(t)e.eliminado=void 0;else{r=[];f(e.id).then(function(a){a.productosBase&&a.productosBase.forEach(function(o){ingrediente={cantidad_ideal:parseFloat(o.formulacion),cantidad_real:parseFloat(o.formulacion),total:parseFloat(o.formulacion),id_producto_base:o.productoBase?o.productoBase.id:null,productoSolicitudBase:o.productoBase},r.push(ingrediente)}),i={productoSolicitado:e,precio_unitario:e.precio_unitario,inventario_disponible:o.cantidadInventario,inventarios:e.inventarios,cantidad:1,detallesIngredientesProducto:r},o.solicitud.solicitudesProductos.push(i)})}}e.rankin+=1;var d=o.productosProcesados.indexOf(e);o.productosProcesados[d]=e,s.productosProcesados=o.productosProcesados},o.filtrarProductos=function(i){o.productosProcesados=e("filter")(o.productos,i),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},o.confirmarEntrega=function(e){o.solicitudCerrar=e,o.abrirDialogConfirmacionCierre()},o.cerrarSolicitud=function(e){n.start();var i=o.calcularTotalViveres(e,!0);e.listaProductosSolicitados=i,x(e,o.usuarioSesion.id_empresa).then(function(i){i.hasErr?o.mostrarMensaje(i.mensaje):(o.mostrarMensaje(i.mensaje),o.solicitudCerrar=void 0,e.activo=!1,o.solicitud=void 0,o.cerrarDialogConfirmacionCierre()),n.stop()}).catch(function(e){var i=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:null!==e.data&&void 0!==e.data?e.data:"Se perdió la conexión.";o.mostrarMensaje(i),n.stop()})},o.editar=function(e){o.solicitud=e,o.solicitud.fechaTexto=o.fechaATexto(o.solicitud.fecha),o.solicitud.modificar=!0,o.abrirDialogPanelOperaciones(),o.solicitud.sucursal=o.solicitud.almacen.sucursal,o.solicitud.almacen=o.solicitud.almacen,o.obtenerAlmacenes(o.solicitud.sucursal.id),o.obtenerInventariosProdSolicitud()},o.generarListaGruposSeleccionados=function(o,e){for(var i=0;i<o.length;i++)for(var a=0;a<e.length;a++)o[i].id==e[a].id&&(o[i].selected=e[a].selected);return o},o.obtenerGruposProductoEmpresa=function(){D(o.usuarioSesion.id_empresa,o.usuario.id).then(function(e){if(o.grupos_productos=e,angular.isDefined(s.grupos_productos))o.grupos_productos=o.generarListaGruposSeleccionados(o.grupos_productos,s.grupos_productos);else for(var i=0;i<e.length;i++)o.grupos_productos[i].selected=!0;o.listChecked=[],o.saveCheckList=function(){o.listChecked.splice(0,o.listChecked.length);for(var e=0;e<o.grupos_productos.length;e++)1==o.grupos_productos[e].selected&&o.listChecked.push(o.grupos_productos[e]);s.grupos_productos=o.grupos_productos},o.saveCheckList(),o.allChecked=!1,o.checkedUnchecked=function(){for(var e=0;e<o.grupos_productos.length;e++)o.grupos_productos[e].selected=o.allChecked;o.saveCheckList()}})},angular.isDefined(s.color)?o.color=s.color:(s.color={style:"red-style",stylebutton:"red-style-button"},o.color={style:"red-style",stylebutton:"red-style-button"}),o.cambiarColor=function(o,e){s.color={style:o,stylebutton:e},$("#dialog-panel-operaciones .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-operaciones .widget-main").addClass(o),$("#dialog-panel-operaciones .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-operaciones .widget-main .button-style").addClass(e)},o.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},o.dragged=!1,o.proformaClick=function(e){o.dragged||o.venderProformaDirecto(e),o.dragged=!1},o.startDragging=function(){o.dragged=!0},o.colorearInventarioDisponible=function(e,i){0==e?(o.porcentaje="100",o.color="red"):e>3*i.inventario_minimo+1?(o.porcentaje="100",o.color="green"):e>2*i.inventario_minimo+1?(o.porcentaje="75",o.color="green"):e>1.5*i.inventario_minimo+1?(o.porcentaje="50",o.color="green"):e==i.inventario_minimo+1?(o.porcentaje="38",o.color="yellow"):e==i.inventario_minimo?(o.porcentaje="25",o.color="red"):e<i.inventario_minimo&&e>0&&(o.porcentaje="12",o.color="red")},o.clasificarColumna=function(e){o.columna==e?"asc"==o.direccion?(o.direccion="desc",$("#"+e+"p").removeClass("fa-caret-up"),$("#"+e+"p").addClass("fa-caret-down")):(o.direccion="asc",$("#"+e+"p").removeClass("fa-caret-down"),$("#"+e+"p").addClass("fa-caret-up")):(o.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+e+"p").addClass("fa-caret-up"),$("#"+e+"p").removeClass("fa-sort")),o.columna=e,o.buscarInventarios(o.almacenBusqueda.id,o.paginaActual,o.itemsPorPagina,o.textoBusqueda,o.columna,o.direccion)},o.sinFuncionalidad=function(){o.mostrarMensaje("Sin funcionalidad")},o.filtrarSolicitudesOperaciones=function(e){for(var i in e)void 0===e[i]&&(e[i]=0);o.obtenerSolicitudes()},o.copiar=function(e){e.id=void 0,e.solicitudesProductos=e.solicitudesProductos.map(function(o){return o.id=void 0,o.id_solicitud=void 0,o.detallesIngredientesProducto.length>0&&(o.detallesIngredientesProducto=o.detallesIngredientesProducto.map(function(o){return o.id=void 0,o.id_detalle_solicitud_producto=void 0,o})),o}),o.solicitud=e,o.solicitud.copia=!0,o.solicitud.sucursal=o.solicitud.almacen.sucursal,o.obtenerAlmacenes(o.solicitud.sucursal.id),o.solicitud.almacen=o.solicitud.almacen,o.obtenerInventariosProdSolicitud(),o.abrirDialogPanelOperaciones()},o.fechaATexto=function(o){return fech=new Date(o),o=fech.getDate()+"/"+(fech.getMonth()+1)+"/"+fech.getFullYear()},o.abrirDialogPanelOperaciones=function(){void 0!==o.solicitud?void 0===o.solicitud.id?(o.productoSeleccionado=void 0,o.solicitud.fecha=(new Date).toLocaleDateString()):void 0===o.solicitud.copia?(o.solicitud.fecha=new Date(o.solicitud.fecha).toLocaleDateString(),o.solicitud.modificar||(o.solicitud.nueva=!0)):(o.solicitud.id=void 0,o.solicitud.fecha=(new Date).toLocaleDateString(),o.solicitud.activo=!0):(o.solicitud={},o.solicitud.fecha=(new Date).toLocaleDateString(),o.solicitud.activo=!0),o.obtenerGruposProductoEmpresa(),o.abrirPopup(o.idDialogDialogPanelOperaciones)},o.cerrarPopupPanel=function(){void 0!==o.solicitud&&(o.solicitud.copia=void 0,o.solicitud=void 0),o.productoSeleccionado=void 0,o.recargarItemsTabla(),o.productosProcesados=[],o.cerrarPopup(o.idDialogDialogPanelOperaciones)},o.abriridDialogoListadoPedido=function(){o.abrirPopup(o.idDialogoListadoPedido)},o.cerraridDialogoListadoPedido=function(){o.detallesPedido=[],o.pedido={},o.detallePedido={},o.solicitudesPedido=[],o.cerrarPopup(o.idDialogoListadoPedido)},o.verificarPulso=function(e,i){13===e.keyCode&&o.buscarProductos(1)},o.verificarPulsoAsignados=function(e,i){13===e.keyCode&&o.buscarProductosAsignados(1)},o.abrirDialogDatos=function(){o.abrirPopup(o.idDialogDatos)},o.cerrarDialogDatos=function(){o.cerrarPopup(o.idDialogDatos)},o.abrirDialogEntregaViveres=function(){o.abrirPopup(o.idDialogEntregaViveres)},o.cerrarDialogEntregaViveres=function(){o.cerrarPopup(o.idDialogEntregaViveres)},o.abrirDialogConfirmacionCierre=function(){o.abrirPopup(o.idConfirmacionCierre)},o.cerrarDialogConfirmacionCierre=function(){o.cerrarPopup(o.idConfirmacionCierre)},o.abrirDialogTotalIngredientes=function(){o.abrirPopup(o.idDialogTotalIngredientes)},o.cerrarDialogTotalIngredientes=function(){o.alreadyCalculated=!1,o.cerrarPopup(o.idDialogTotalIngredientes)},o.generarPdfSolicitud=function(e){n.start(),o.calcularTotalViveres(e,!0);var i=new PDFDocument({size:[612,792],margin:10,compress:!1}),a=i.pipe(blobStream());(r=(t=new Date).getMinutes())<10&&(r="0"+r),i.font("Helvetica",8);var t,r,d=115,s=0,c=1,u=Math.ceil(o.totalViveresSolicitados.productos.length/29);o.dibujarCabeceraPDFSolicitud(i,c,u);for(var l=0;l<o.totalViveresSolicitados.productos.length&&s<=29;l++)i.font("Helvetica",8),i.text(l+1,65,d),i.text(o.totalViveresSolicitados.productos[l].productoSolicitudBase.codigo,100,d),i.text(o.totalViveresSolicitados.productos[l].productoSolicitudBase.nombre,220,d),i.text(o.totalViveresSolicitados.productos[l].productoSolicitudBase.unidad_medida,400,d),i.text(o.totalViveresSolicitados.productos[l].total.toFixed(2),500,d),d+=20,++s>29&&(i.rect(40,105,540,d-115).stroke(),i.text(c+"/"+u,570,d+15),i.font("Helvetica",6),i.text("RESPONSABLE: "+o.usuarioSesion.nombre_usuario,45,d+10),i.text("SOLICITANTE: "+o.totalViveresSolicitados.usuario.persona.nombre_completo,345,d+10),i.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+r,175,d+10),i.addPage({size:[612,792],margin:10}),d=115,s=0,c+=1,o.dibujarCabeceraPDFSolicitud(i,c,u));i.rect(40,105,540,d-115).stroke(),(r=(t=new Date).getMinutes())<10&&(r="0"+r),i.text(c+"/"+u,570,d+15),i.font("Helvetica",6),i.text("RESPONSABLE: "+o.usuarioSesion.nombre_usuario,45,d+5),i.text("SOLICITANTE: "+o.totalViveresSolicitados.usuario.persona.nombre_completo,345,d+5),i.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+r,175,d+5),i.end(),a.on("finish",function(){var o=a.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),n.stop()},o.dibujarCabeceraPDFSolicitud=function(e,i,a){e.font("Helvetica-Bold",12),e.text("CONSUMOS",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("SUCURSAL : ",-40,50,{align:"center"}),e.font("Helvetica",8),e.text(o.totalViveresSolicitados.sucursal.nombre,60,50,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FECHA : ",40,60,{width:40}),e.font("Helvetica",8),e.text(o.fechaATexto(o.totalViveresSolicitados.fecha),75,60,{width:40}),e.font("Helvetica-Bold",14),e.text("N°",380,40,{align:"center"}),e.text(o.totalViveresSolicitados.identificador,440,40,{align:"center"}),e.rect(40,80,540,25).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",65,90),e.text("Código Ítem",100,90),e.text("Producto",220,90),e.text("Unidad medida",380,90),e.text("Cantidad solicitada",480,90)},o.calcularViveresDesdeFiltro=function(e){var i=[];o.totalViveresSolicitados={},o.solicitudesPedido=[],o.solicitudesOperaciones.forEach(function(a,t){if(a.activo||void 0!==e){if(e&&!a.id_pedido){o.solicitudesPedido.push(a.id);r=o.calcularTotalViveres(a,!0);i.push(r)}}else{var r=o.calcularTotalViveres(a,!0);i.push(r)}});var a=[];if(i.forEach(function(o){o.productos.forEach(function(e){var i={almacen:e.almacen,sucursal:e.almacen.sucursal,cantidad:e.cantidad_real,fecha:o.fecha,hora_fecha:o.fecha,usuario:o.usuario,estado:e.estado,producto:e.productoSolicitudBase,costo:e.productoSolicitudBase.inventarios&&e.productoSolicitudBase.inventarios.length?e.productoSolicitudBase.inventarios[0].costo_unitario:0,grupo:e.productoSolicitudBase.grupo,subgrupo:e.productoSolicitudBase.subgrupo,total:(e.productoSolicitudBase.inventarios&&e.productoSolicitudBase.inventarios.length?e.productoSolicitudBase.inventarios[0].costo_unitario:0)*e.cantidad_real,monto:e.monto,solicitud:e.solicitud};a.push(i)})}),e){for(var t=[];a.length>0;){var r=a.pop();if(0===t.length)t.push(r);else{var d,s=!1;t.forEach(function(o,e){o.producto.id!=r.producto.id||s||(s=!0,d=e)}),s&&void 0!==d?(t[d].cantidad+=r.cantidad,t[d].total=t[d].cantidad*t[d].costo):t.push(r)}}return t}return a},o.reporteExcel=function(e){if(n.start(),o.imprimir.detalle){(r=[]).push(["Nro.","Sucursal","Almacén","Hora-fecha","Usuario","Estado","Detalle","Unidad","Grupo","Subgrupo","Cantidad","Costo","Total"]);for(var i=o.calcularViveresDesdeFiltro(),a=[],t=0;t<i.length;t++)(a=[]).push(t+1),a.push(i[t].almacen.sucursal.nombre),a.push(i[t].almacen.nombre),a.push(new Date(i[t].fecha).toLocaleTimeString()+" "+new Date(i[t].fecha).toLocaleDateString()),a.push(i[t].usuario.nombre_usuario),a.push(i[t].estado?"Abierto":"Cerrado"),a.push(i[t].producto.nombre),a.push(i[t].producto.unidad_medida),a.push(i[t].grupo.nombre),a.push(i[t].subgrupo.nombre),a.push(i[t].cantidad),a.push(i[t].costo),a.push(i[t].total.toFixed(2)),r.push(a);n.stop()}else{var r;(r=[]).push(["Nro.","Sucursal","Hora-fecha","Monto","Usuario","Estado"]);for(a=[],t=0;t<o.solicitudesOperaciones.length;t++)(a=[]).push(t+1),a.push(o.solicitudesOperaciones[t].almacen.sucursal.nombre),a.push(new Date(o.solicitudesOperaciones[t].fecha).toLocaleTimeString()+" "+new Date(o.solicitudesOperaciones[t].fecha).toLocaleDateString()),a.push(o.solicitudesOperaciones[t].monto),a.push(o.solicitudesOperaciones[t].usuario.nombre_usuario),a.push(o.solicitudesOperaciones[t].activo?"Abierto":"Cerrado"),r.push(a);n.stop()}if(e)o.reportePdf(r),n.stop();else{var d="SheetJS",s=new Workbook,c=sheet_from_array_of_arrays(r);c["!cols"]=[{wch:5},{wch:18},{wch:18},{wch:12},{wch:15},{wch:15},{wch:12},{wch:25},{wch:12},{wch:12},{wch:12}],c["!rows"]=[{hpx:28,level:3}],s.SheetNames.push(d),s.Sheets[d]=c;var u=XLSX.write(s,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(u)],{type:"application/octet-stream"}),"REPORTE OPERACIONES.xlsx"),n.stop()}},o.reportePdf=function(e){var i=new PDFDocument({size:"letter",margin:10,compress:!1}),a=i.pipe(blobStream());(r=(t=new Date).getMinutes())<10&&(r="0"+r),o.posXforPdf=[],i.font("Helvetica",8);var t,r,d=65,s=115,c=0,u=1,l=Math.ceil(e.length/29);if(o.dibujarCabeceraReportePdf(i,e),o.imprimir.detalle){d=50;for(var p=0;p<e.length&&c<=29;p++){var v=d;if(i.font("Helvetica",8),p>0){for(var g=0;g<e[p].length;g++)i.text(e[p][g],v,s,{width:40},{align:"center"}),v=o.posXforPdf[g];s+=20,c++}c>29&&(i.rect(40,105,540,s-115).stroke(),i.text(u+"/"+l,570,s+15),i.font("Helvetica",6),i.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+r,175,s+10),i.addPage({size:[612,792],margin:10}),s=115,c=0,u+=1,o.dibujarCabeceraPDFSolicitud(i,u,l))}}else for(p=0;p<e.length&&c<=29;p++){v=d;if(i.font("Helvetica",8),p>0){for(g=0;g<e[p].length;g++)i.text(e[p][g],v,s,{width:40}),v+=0==g?30:60;s+=20,c++}c>29&&(i.rect(40,105,540,s-115).stroke(),i.text(u+"/"+l,570,s+15),i.font("Helvetica",6),i.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+r,175,s+10),i.addPage({size:[612,792],margin:10}),s=115,c=0,u+=1,o.dibujarCabeceraPDFSolicitud(i,u,l))}i.rect(40,105,540,650).stroke(),(r=(t=new Date).getMinutes())<10&&(r="0"+r),i.text(u+"/"+l,570,765),i.font("Helvetica",6),i.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+r,175,765),i.end(),a.on("finish",function(){var o=a.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),n.stop()},o.dibujarCabeceraReportePdf=function(e,i){if(e.font("Helvetica-Bold",12),e.text("REPORTE OPERACIONES",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FECHA : ",40,60,{width:40}),e.font("Helvetica",8),e.text((new Date).toLocaleDateString(),75,60,{width:40}),e.rect(40,80,540,25).stroke(),e.font("Helvetica-Bold",8),o.imprimir.detalle){px=50;for(var a=0;a<i[0].length;a++)e.text(i[0][a],px,90),0==a?(px+=4*i[0][a].length+5,o.posXforPdf.push(px)):(o.imprimir.detalle,px+=4*i[0][a].length+15,o.posXforPdf.push(px))}else{px=65;for(a=0;a<i[0].length;a++)e.text(i[0][a],px,90),0==a?(px+=20,o.posXforPdf.push(px)):o.imprimir.detalle?px+=40:px+=60}e.font("Helvetica",8)},o.obtenerProductos=function(){o.paginatorProductos=h(),o.paginatorProductos.column="nombre",o.paginatorProductos.filter=o.grupo,o.paginatorProductos.callBack=o.buscarProductos,o.paginatorProductos.getSearch("",null,null)},o.modificarListaProductosProveedor=function(e){var i=o.listaProductosProveedor.indexOf(e.id);i>=0&&!e.seleccionado?o.listaProductosProveedor.splice(i,1):-1==i&&e.seleccionado&&o.listaProductosProveedor.push(e.id)},o.seleccionarTodosParaAsignar=function(){o.seleccionProductosProveedor.seleccionar_todos?o.productosAsignacionProveedor.forEach(function(e){e.seleccionado=!0,o.modificarListaProductosProveedor(e)}):o.productosAsignacionProveedor.forEach(function(e){e.seleccionado=!1,o.modificarListaProductosProveedor(e)})},o.actualizarProductosProveedor=function(){V(o.usuarioSesion.id_empresa,o.listaProductosProveedor,o.pedido.proveedor).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.mostrarMensaje(e.mensaje),o.cerrarModalProductosProveedor())}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(i)})},o.buscarProductos=function(e){n.start(),e&&(o.paginatorProductos.currentPage=e),o.paginatorProductos.filter=o.configuracionPorveedor.grupo?o.configuracionPorveedor.grupo:{id:0},o.paginatorProductos.search=o.configuracionPorveedor.textoBusqueda?o.configuracionPorveedor.textoBusqueda:0,j(o.usuarioSesion.id_empresa,o.paginatorProductos,o.usuarioSesion.id).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.paginatorProductos.setPages(e.paginas),o.productosAsignacionProveedor=e.productos,o.pedido&&o.pedido.proveedor&&A(o.usuarioSesion.id_empresa,o.pedido.proveedor).then(function(e){if(e.hasErr)o.mostrarMensaje(e.mensaje),o.listaProductosProveedor=[];else if(e.productos){var i=e.productos.split(",");o.listaProductosProveedor=i.map(function(o){return parseInt(o)}),o.verificarAsignacionProductosProveedor()}else o.listaProductosProveedor=[];n.stop()}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(i)}));n.stop()}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(i)})},o.obtenerProductosAsignados=function(){o.paginatorProductosAsignados=h(),o.paginatorProductosAsignados.column="nombre",o.paginatorProductosAsignados.filter=o.grupo,o.paginatorProductosAsignados.callBack=o.buscarProductosAsignados,o.paginatorProductosAsignados.getSearch("",null,null)},o.buscarProductosAsignados=function(e,i){(n.start(),e&&(o.paginatorProductosAsignados.currentPage=e),void 0===o.pedido)?(o.pedido={},n.stop()):o.pedido.proveedor?(o.paginatorProductosAsignados.filter=o.productosAsignadosPorveedor.grupo?o.productosAsignadosPorveedor.grupo:{id:0},o.paginatorProductosAsignados.search=o.productosAsignadosPorveedor.textoBusqueda?o.productosAsignadosPorveedor.textoBusqueda:0,A(o.usuarioSesion.id_empresa,o.pedido.proveedor).then(function(e){if(e.hasErr)o.mostrarMensaje(e.mensaje),o.listaProductosProveedor=[];else if(e.productos){var i=e.productos.split(",");o.listaProductosProveedor=i.map(function(o){return parseInt(o)}),B(o.usuarioSesion.id_empresa,o.paginatorProductosAsignados,o.usuarioSesion.id,o.listaProductosProveedor).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.paginatorProductosAsignados.setPages(e.paginas),o.productosAsignadosProveedor=e.productos,o.listaProductosProveedorSeleccionados=[],o.verificarSeleccionProductosProveedor()),n.stop()}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(i)})}else o.listaProductosProveedor=[];n.stop()}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(i)})):o.mostrarMensaje("El proveedor no tiene productos asignados.")},o.verificarSeleccionProductosProveedor=function(){o.listaProductosProveedorSeleccionados.length>0&&o.listaProductosProveedorSeleccionados.forEach(function(e){o.productosProveedorSeleccionados.forEach(function(o){o.id===e&&(o.seleccionado=!0)})})},o.filtrarProductosSeleccionadosPorGrupo=function(){if(o.detallesPedido.length>0){var e=[];o.detallesPedido.forEach(function(i){i.id_subgrupo===o.pedido.grupo&&e.push(i)}),e.length>0?o.detallesPedido=e.map(function(o){return o}):o.mostrarMensaje("No existen productos pertenecientes al grupo seleccionado. No se realizaron cambios.")}},o.abrirmodalBusquedaProveedor=function(){o.filtrarProveedores(""),o.abrirPopup(o.idDialogBusquedaProveedor)},o.cerrarModalBusquedaProveedor=function(){o.cerrarPopup(o.idDialogBusquedaProveedor)},o.abrirmodalProductosAsignadosProveedor=function(){void 0===o.pedido&&(o.pedido={por_proveedor:!1}),o.pedido.proveedor?(o.generarPorProveedor(),o.buscarProductosAsignados(),o.abrirPopup(o.idDialogProductosAsigandosProveedor)):o.mostrarMensaje("Seleccione un proveedor.")},o.cerrarModalProductosAsignadosProveedor=function(){o.cerrarPopup(o.idDialogProductosAsigandosProveedor)},o.cerrarModalProductosProveedor=function(){o.productosAsignacionProveedor=[],o.listaProductosProveedor=[],o.cerrarPopup(o.idDialogProductosProveedor)},o.abrirModalNuevoPedido=function(){o.abrirPopup(o.idDialogoNuevoPedido)},o.cerrarModalNuevoPedido=function(){o.detallesPedido=[],o.pedido={},o.detallePedido={},o.solicitudesPedido=[],o.cerrarPopup(o.idDialogoNuevoPedido)},o.eliminarDetallePedido=function(e){e.id?e.eliminar=!0:o.detallesPedido.splice(o.detallesPedido.indexOf(e),1)},o.guardarPedido=function(e,i){if(n.start(),void 0!==e&&o.detallesPedido.length>0){i&&(e.solicitudesIds=o.solicitudesPedido.map(function(o){return o}));var a=new Date,t=e.fecha.split("/").reverse(),r={fecha:new Date(t[0],t[1]-1,t[2],a.getHours(),a.getMinutes()),sucursal:e.sucursal,almacen:e.almacen,proveedor:e.proveedor.id,observacion:e.observacion,grupo:void 0!==e.grupo&&null!==e.grupo?e.grupo:0,detallesPedido:o.detallesPedido,usuario:o.usuarioSesion.id,solicitudesIds:e.generado?o.solicitudesPedido:[]};I(o.usuario.id_empresa,r,o.usuarioSesion.id).then(function(e){n.stop(),e.hasErr?o.mostrarMensaje(e.mensaje):(o.mostrarMensaje(e.mensaje),o.recargarItemsTabla())}).catch(function(e){n.stop();var i=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";o.mostrarMensaje(i)})}else o.detallesPedido.length>0?o.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar!"):o.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar sin lista de productos!"),n.stop()},o.inicio()}]);