angular.module("agil.controladores").controller("ControladorProveedores",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","Proveedor","Proveedores","Empresas","ProveedoresEmpresa","ProveedoresPaginador","EliminarProveedor",function(e,o,a,t,n,i,c,l,s,u,d,v,f){c.start(),e.usuario=JSON.parse(a.usuario),e.inicio=function(){e.obtenerEmpresas(),e.obtenerProveedores(),e.buscarTodosProveedores()},e.$on("$viewContentLoaded",function(){resaltarPestaña(t.path().substring(1)),ejecutarScriptsProveedor("modal-wizard-proveedor","modal-wizard-proveedor-vista","dialog-eliminar-proveedor","modal-wizard-container-proveedor-edicion","modal-wizard-container-proveedor-vista"),e.buscarAplicacion(e.usuario.aplicacionesUsuario,t.path().substring(1)),c.stop()}),e.crearNuevoProveedor=function(){var o=JSON.parse(a.usuario);e.proveedor=new l({id_empresa:o.id_empresa}),e.abrirPopup("modal-wizard-proveedor")},e.verProveedor=function(o){e.proveedor=o,o.fecha1=new Date(o.fecha1),o.fecha2=new Date(o.fecha2),e.proveedor.fechatexto1=o.fecha1.getDate()+"/"+(o.fecha1.getMonth()+1)+"/"+o.fecha1.getFullYear(),e.proveedor.fechatexto2=o.fecha2.getDate()+"/"+(o.fecha2.getMonth()+1)+"/"+o.fecha2.getFullYear(),e.abrirPopup("modal-wizard-proveedor-vista")},e.cerrarPopPupVista=function(){e.cerrarPopup("modal-wizard-proveedor-vista")},e.cerrarPopPupNuevoProveedor=function(){e.cerrarPopup("modal-wizard-proveedor")},e.modificarProveedor=function(o){e.proveedor=o,o.fecha1&&(o.fecha1=new Date(o.fecha1),e.proveedor.fechatexto1=o.fecha1.getDate()+"/"+(o.fecha1.getMonth()+1)+"/"+o.fecha1.getFullYear()),o.fecha2&&(o.fecha2=new Date(o.fecha2),e.proveedor.fechatexto2=o.fecha2.getDate()+"/"+(o.fecha2.getMonth()+1)+"/"+o.fecha2.getFullYear()),e.abrirPopup("modal-wizard-proveedor")},e.mostrarConfirmacionEliminacion=function(o){e.proveedor=new l(o),e.abrirPopup("dialog-eliminar-proveedor")},e.cerrarConfirmacionEliminacion=function(){e.cerrarPopup("dialog-eliminar-proveedor")},e.eliminarProveedor=function(o){c.start(),e.cerrarConfirmacionEliminacion(),f(o.id).then(function(o){e.mostrarMensaje(o.mensaje)}),e.recargarItemsTabla(),c.stop()},e.saveForm=function(o){if("Siguiente"!=$("#siguiente").text().trim()){c.start();var a=[];[document.getElementById("doc-nit").files[0],document.getElementById("doc-funda").files[0],document.getElementById("doc-licencia").files[0],document.getElementById("doc-ci").files[0],document.getElementById("doc-seguro-social").files[0]].forEach(function(t,n,i){t&&a.push(t),n==i.length-1&&(a.length>0?a.forEach(function(a,t,n){r=new FileReader,a?(r.onloadend=function(r){a.nombre=a.name,a.data=r.target.result,t===n.length-1&&(o.fecha1=null,o.fechatexto1&&(o.fecha1=new Date(e.convertirFecha(o.fechatexto1))),o.fecha2=null,o.fechatexto2&&(o.fecha2=new Date(e.convertirFecha(o.fechatexto2))),o.id?l.update({idProveedor:o.id},o,function(o){c.stop(),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Actualizado Exitosamente!"),e.recargarItemsTabla()}):o.$save(function(o){c.stop(),e.proveedor=new l({}),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Guardado Exitosamente!"),e.recargarItemsTabla()},function(o){c.stop(),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()}))},r.readAsBinaryString(a)):t===n.length-1&&(o.fecha1=null,o.fechatexto1&&(o.fecha1=new Date(e.convertirFecha(o.fechatexto1))),o.fecha2=null,o.fechatexto2&&(o.fecha2=new Date(e.convertirFecha(o.fechatexto2))),o.id?l.update({idProveedor:o.id},o,function(o){c.stop(),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Actualizado Exitosamente!"),e.recargarItemsTabla()}):o.$save(function(o){c.stop(),e.proveedor=new l({}),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Guardado Exitosamente!"),e.recargarItemsTabla()},function(o){c.stop(),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()}))}):(o.fecha1=null,o.fechatexto1&&(o.fecha1=new Date(e.convertirFecha(o.fechatexto1))),o.fecha2=null,o.fechatexto2&&(o.fecha2=new Date(e.convertirFecha(o.fechatexto2))),o.id?l.update({idProveedor:o.id},o,function(o){c.stop(),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Actualizado Exitosamente!"),e.recargarItemsTabla()}):o.$save(function(o){c.stop(),e.proveedor=new l({}),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Guardado Exitosamente!"),e.recargarItemsTabla()},function(o){c.stop(),e.cerrarPopPupNuevoProveedor(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})))})}},e.obtenerEmpresas=function(){c.start(),u().then(function(o){e.empresas=o,c.stop()})},e.obtenerProveedores=function(){e.abs=o.Math.abs,e.itemsPorPagina=10,e.buscarProveedores(1,e.itemsPorPagina,"")},e.verificarPulso=function(o,r){13===o.keyCode&&e.buscarProveedores(1,e.itemsPorPagina,r)},e.buscarProveedores=function(o,r,a){c.start(),e.itemsPorPagina=r,""==a||null==a?a=0:e.textoBusqueda=a,e.paginaActual=o,v(e.usuario.id_empresa,o,r,a).then(function(o){e.paginas=[];for(var r=1;r<=o.paginas;r++)e.paginas.push(r);e.proveedores=o.proveedores,c.stop()})},e.buscarTodosProveedores=function(){s(e.usuario.id_empresa).then(function(o){e.TodoProveedores=o}),c.stop()},e.reporteExcel=function(){var o=e.TodoProveedores;c.start();var r=[];r.push(["Codigo","Razón Social","Nit","Direccion","Telefono1","Telefono2","Contacto","Ubicacion Geo.","Rubro","Categoria","Fecha Imp.1","Fecha Imp.2","Texto1","Texto2"]);for(var a=0;a<o.length;a++)columns=[],columns.push(o[a].codigo),columns.push(o[a].razon_social),columns.push(o[a].nit),columns.push(o[a].direccion),columns.push(o[a].telefono1),columns.push(o[a].telefono2),columns.push(o[a].contacto),o[a].ubicacion_geografica?columns.push(o[a].ubicacion_geografica):columns.push(" "),columns.push(o[a].rubro),o[a].categoria?columns.push(o[a].categoria):columns.push(" "),o[a].fecha1?columns.push(new Date(o[a].fecha1)):columns.push(" "),o[a].fecha2?columns.push(new Date(o[a].fecha2)):columns.push(" "),o[a].texto1?columns.push(o[a].texto1):columns.push(" "),o[a].texto2?columns.push(o[a].texto2):columns.push(" "),r.push(columns);var t="SheetJS",n=new Workbook,i=sheet_from_array_of_arrays(r);n.SheetNames.push(t),n.Sheets[t]=i;var l=XLSX.write(n,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),"REPORTE-USUARIOS.xlsx"),c.stop()},e.dibujarCabeceraPDFProveedores=function(e,o,r,a){var t=(new Date).toLocaleDateString();e.fontSize(23).text("REPORTE DE PROVEEDORES",0,80,{align:"center"}),e.rect(133,100,335,0).stroke(),e.font("Helvetica-Bold",10),e.text("Fecha: ",30,140),e.font("Helvetica",10).text(t,63,140),e.font("Helvetica-Bold",10).text("N°",30,160),e.font("Helvetica-Bold",10).text("Código",52,160),e.font("Helvetica-Bold",10).text("Razón Social",100,160),e.font("Helvetica-Bold",10).text("Nit",230,160),e.font("Helvetica-Bold",10).text("Direccion",300,160),e.font("Helvetica-Bold",10).text("Telefono",390,160),e.font("Helvetica-Bold",10).text("Rubro",470,160),e.text("PÁGINA "+o+" DE "+r,0,740,{align:"center"})},e.reportePdf=function(){var o=e.TodoProveedores;c.start();var r=new PDFDocument({size:"letter",margin:10}),a=r.pipe(blobStream()),t=200,n=0,i=1,l=Math.ceil(o.length/15);e.dibujarCabeceraPDFProveedores(r,1,l,o),r.font("Helvetica",8);for(var s=o.length-1,u=0;u<s&&n<=15;u++){var d=u+1;r.font("Helvetica",9).text(d,30,t),o[u].codigo?r.font("Helvetica",9).text(o[u].codigo,52,t):r.font("Helvetica",9).text("null",52,t),o[u].razon_social?r.font("Helvetica",9).text(o[u].razon_social,100,t,{width:130}):r.font("Helvetica",9).text("null",100,t),o[u].nit?r.font("Helvetica",9).text(o[u].nit,230,t):r.font("Helvetica",9).text("null",230,t),o[u].direccion?(r.font("Helvetica",9).text(o[u].direccion,300,t,{width:80}),console.log(o[u].direccion.length)):r.font("Helvetica",9).text("null",300,t),o[u].telefono1?r.font("Helvetica",9).text(o[u].telefono1,390,t):r.font("Helvetica",9).text("null",390,t),o[u].rubro?r.font("Helvetica",9).text(o[u].rubro,470,t):r.font("Helvetica",9).text("null",470,t),t+=33,15==++n&&(r.addPage({margin:0,bufferPages:!0}),t=200,n=0,i+=1,e.dibujarCabeceraPDFProveedores(r,i,l,o),r.font("Helvetica",8))}r.end(),a.on("finish",function(){var e=a.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),c.stop()},e.subirExcelProveedores=function(o){var r,a,t=o.target.files;for(a=t[r=0];r!=t.length;++r){var n=new FileReader;a.name;n.onload=function(o){c.start();var r=o.target.result,a=XLSX.read(r,{type:"binary"}),t=a.SheetNames[0],n=2,i=a.Sheets[t],l=[];do{var s={};s.codigo=void 0!=i["A"+n]&&""!=i["A"+n]?i["A"+n].v.toString():null,s.razon_social=void 0!=i["B"+n]&&""!=i["B"+n]?i["B"+n].v.toString():null,s.nit=void 0!=i["C"+n]&&""!=i["C"+n]?i["C"+n].v.toString():null,s.direccion=void 0!=i["D"+n]&&""!=i["D"+n]?i["D"+n].v.toString():null,s.telefono1=void 0!=i["E"+n]&&""!=i["E"+n]?i["E"+n].v.toString():null,s.telefono2=void 0!=i["F"+n]&&""!=i["F"+n]?i["F"+n].v.toString():null,s.telefono3=void 0!=i["G"+n]&&""!=i["G"+n]?i["G"+n].v.toString():null,s.contacto=void 0!=i["H"+n]&&""!=i["H"+n]?i["H"+n].v.toString():null,s.ubicacion_geografica=void 0!=i["I"+n]&&""!=i["I"+n]?i["I"+n].v.toString():null,s.rubro=void 0!=i["J"+n]&&""!=i["J"+n]?i["J"+n].v.toString():null,s.categoria=void 0!=i["K"+n]&&""!=i["K"+n]?i["K"+n].v.toString():null,s.fecha1=void 0!=i["L"+n]&&""!=i["L"+n]?new Date(e.convertirFecha(i["L"+n].v.toString())):null,s.fecha2=void 0!=i["M"+n]&&""!=i["M"+n]?new Date(e.convertirFecha(i["M"+n].v.toString())):null,s.texto1=void 0!=i["N"+n]&&""!=i["N"+n]?i["N"+n].v.toString():null,s.texto2=void 0!=i["O"+n]&&""!=i["O"+n]?i["O"+n].v.toString():null,l.push(s),n++,0}while(void 0!=i["A"+n]);e.guardarProveedores(l),c.stop()},n.readAsBinaryString(a)}},e.guardarProveedores=function(o){new d({proveedores:o,id_empresa:e.usuario.id_empresa}).$save(function(o){c.stop(),e.mostrarMensaje("Guardado Exitosamente!"),e.recargarItemsTabla()},function(o){c.stop(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})},e.$on("$routeChangeStart",function(o,r){e.eliminarPopup("modal-wizard-proveedor"),e.eliminarPopup("modal-wizard-proveedor-vista"),e.eliminarPopup("dialog-eliminar-proveedor")}),e.inicio()}]);