angular.module("agil.controladores").controller("ControladorPedidos",["$scope","$filter","$rootScope","$route","$templateCache","$location","$window","$localStorage","blockUI","ClasesTipo","socket","Paginator","PedidosFiltro","ListaGruposProductoUsuario","ProveedoresNit","ListaProductosEmpresaUsuario","GuardarPedido","ListaProveedores","InventarioPaginador","ProductosPaginador","ListaProductosProveedores","ActualizarProductosProveedor","ListaSubGruposProductoEmpresa","ProductosPaginadorSubgrupos","ProductosPaginadorAsignados",function(o,e,r,a,t,i,s,d,n,c,u,l,p,P,v,g,f,m,h,S,b,x,A,E,M){o.usuarioSesion=JSON.parse(d.usuario),o.idDialogNuevoPedido="modal-nuevo-pedido",o.idDialogProductosProveedor="dialog-productos-proveedor-configuracion",o.idDialogBusquedaProveedor="dialog-Busqueda-proveedor",o.idDialogProductosAsigandosProveedor="dialog-productos-proveedor-asignados",o.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),ejecutarScriptsPedidos(o.idDialogNuevoPedido,o.idDialogProductosProveedor,o.idDialogBusquedaProveedor,o.idDialogProductosAsigandosProveedor),o.buscarAplicacion(o.usuarioSesion.aplicacionesUsuario,i.path().substring(1))}),o.$on("$routeChangeStart",function(e,r){o.eliminarPopup(o.idDialogListadoPedido),o.eliminarPopup(o.idDialogProductosProveedor),o.eliminarPopup(o.idDialogNuevoPedido),o.eliminarPopup(o.idDialogBusquedaProveedor),o.eliminarPopup(o.idDialogProductosAsigandosProveedor)}),o.inicio=function(){o.imprimir={detalle:!1},o.listaProductosProveedor=[],o.seleccionProductosProveedor={seleccionar_todos:!1},o.seleccionProductosProveedorAsignados={seleccionar_todos:!1},o.productosAsignadosPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},o.configuracionPorveedor={itemsPorPagina:10,textoBusqueda:"",paginaActual:1,paginas:[1]},o.detallesPedido=[],o.mostarBusquedaProducto=!1,o.ordenProductos=!0,o.esContado=!0,o.alreadyCalculated=!1,o.sucursalesUsuario="";for(var e=0;e<o.usuarioSesion.sucursalesUsuario.length;e++)o.sucursalesUsuario=o.sucursalesUsuario+o.usuarioSesion.sucursalesUsuario[e].sucursal.id,e+1!=o.usuarioSesion.sucursalesUsuario.length&&(o.sucursalesUsuario=o.sucursalesUsuario+",");o.obtenerProveedores(),o.obtenerProductos(),o.obtenerProductosAsignados(),o.filtro={desde:0,hasta:0,tipo:0,proveedor:0,nit:"",sucursal:0,estado:0,id_usuario:""},o.obtenerPaginador(),o.sucursales=o.obtenerSucursales(),o.obtenerSubGruposProductosEmpresaUsuario()},o.obtenerSubGruposProductosEmpresaUsuario=function(){n.start(),A(o.usuarioSesion.id_empresa,o.usuarioSesion.id).then(function(e){n.stop(),e.length>0?o.subGruposProducto=e:(o.subGruposProducto=[],o.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){o.subGruposProducto=[];var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";o.mostrarMensaje(r),n.stop()})},o.obtenerProveedores=function(){m(o.usuarioSesion.id_empresa).then(function(e){o.proveedores=e.proveedores,o.proveedoresProcesado=e.proveedores}).catch(function(e){o.proveedores=[];var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data&&""!==e.data?e.data:"Error: Se perdio la conexión.";o.mostrarMensaje(r)})},o.filtrarProveedores=function(r){void 0!==o.proveedores?o.proveedoresProcesado=e("filter")(o.proveedores,r):o.proveedoresProcesado=[]},o.establecerProveedor=function(e,r){void 0===o.pedido&&(o.pedido={}),o.pedido.proveedor=e,o.productosAsignadosProveedor=[],o.paginatorProductosAsignados.setPages(1),void 0!==r&&o.cerrarModalBusquedaProveedor(),o.pedido.por_proveedor&&o.generarPorProveedor()},o.checkProveedor=function(e){return!!o.pedido&&!!o.pedido.proveedor},o.buscarProveedor=function(e){if(""!=e&&void 0!=e)return v(o.usuario.id_empresa,e)},o.establecerProducto=function(e,r){o.detallePedido={},e.tipoProducto=null==e.tipoProducto?{id:e["tipoProducto.id"],nombre:e["tipoProducto.nombre"],nombre_corto:e["tipoProducto.nombre_corto"]}:e.tipoProducto;var a=0;e.inventarios.length>0&&e.inventarios.forEach(function(o){a+=o.cantidad}),o.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,inventario_disponible:a}},o.guardarPedido=function(e){if(n.start(),void 0!==e&&o.detallesPedido.length>0){var r=new Date,a=e.fecha.split("/").reverse(),t={fecha:new Date(a[0],a[1]-1,a[2],r.getHours(),r.getMinutes()),sucursal:e.sucursal,almacen:e.almacen,proveedor:e.proveedor.id,observacion:e.observacion,grupo:void 0!==e.grupo&&null!==e.grupo?e.grupo:0,detallesPedido:o.detallesPedido,usuario:o.usuarioSesion.id};f(o.usuario.id_empresa,t,o.usuarioSesion.id).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.mostrarMensaje(e.mensaje),o.recargarItemsTabla()),n.stop()}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";o.mostrarMensaje(r)})}else o.detallesPedido.length>0?o.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar!"):o.mostrarMensaje("Existe un problema con los datos del pedido, no se puede generar sin lista de productos!"),n.stop()},o.mostrarBusqueda=function(){o.mostarBusquedaProducto?o.mostarBusquedaProducto=!1:o.mostarBusquedaProducto=!0},o.agregardetallePedido=function(e){void 0!==e&&null!==e?(o.detallesPedido.some(function(o){return o.producto.id===e.producto.id})?o.detallesPedido.forEach(function(o){o.producto.id===e.producto.id&&(o.cantidad+=e.cantidad)}):o.detallesPedido.push(e),o.detallePedido=void 0):o.mostrarMensaje("Ocurrió un problema, no se puede agregar un valor no definido o nulo.")},o.interceptarTecla=function(e,r,a){13===e.which&&(a?o.enfocar(r):$timeout(function(){$("#"+r).trigger("click")},0))},o.filtrarFiltro=function(e,r,a){if(void 0!==a)for(var t in e)0==e[t]&&(e[t]="");else for(var t in e)""!==e[t]&&null!==e[t]&&void 0!==e[t]||(e[t]=0);if(void 0!==r&&r)return e;o.obtenerPedidos()},o.obtenerPaginador=function(){n.start(),o.paginator=l(),o.paginator.column="fecha",o.paginator.direccion="asc",o.paginator.itemPerPage=10,o.paginator.page=1,o.filtro={desde:0,hasta:0,tipo:0,proveedor:0,nit:"",sucursal:0,estado:0,usuario:""},o.paginator.callBack=o.obtenerPedidos,o.paginator.getSearch(""),n.stop()},o.obtenerPedidos=function(){n.start(),o.filtro=o.filtrarFiltro(o.filtro,!0),o.paginator.filter=o.filtro,p(o.usuarioSesion.id_empresa,o.paginator).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.listaPedidos=e.pedidos,o.paginator.setPages(e.paginas)),o.filtro=o.filtrarFiltro(o.filtro,!0,!0),n.stop()}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.data&&null!==e.data?e.data:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";o.mostrarMensaje(r)})},o.obtenerSucursales=function(){for(var e=[],r=0;r<o.usuarioSesion.sucursalesUsuario.length;r++)e.push(o.usuarioSesion.sucursalesUsuario[r].sucursal);return e},o.obtenerAlmacenes=function(e){if(void 0===e&&(o.filtro.sucursal=void 0,o.almacenes=[]),void 0!==e){o.almacenes=[];var r=$.grep(o.sucursales,function(o){return o.id==e})[0];o.almacenes=r?r.almacenes:[]}},o.eliminar=function(e){o.solicitud=e,o.solicitud.solicitudesProductos.map(function(r){ListaInventariosProducto(r.productoSolicitado.id,o.solicitud.almacen.id).then(function(a){r.inventarios=a,r.inventario_disponible_utilizado=r.cantidad,o.solicitud.solicitudesProductos.indexOf(r)==o.solicitud.solicitudesProductos.length-1&&EliminarSolicitudReposicion.save({id_solicitud:e.id},e,function(e){o.mostrarMensaje(e.mensaje),o.recargarItemsTabla(),o.solicitud=void 0,n.stop()},function(e){o.solicitud=void 0,o.mostrarMensaje(err.stack?err.stack:err.message),n.stop()})})}),o.cerrarConfirmacionEliminacion()},o.ver=function(o){},o.interceptarTecla=function(e,r,a){13===e.which&&(a?o.enfocar(r):$timeout(function(){$("#"+r).trigger("click")},0))},o.editar=function(o){},o.sinFuncionalidad=function(){o.mostrarMensaje("Sin funcionalidad")},o.generarPdfSolicitud=function(e){n.start(),o.calcularTotalViveres(e);var r=new PDFDocument({size:[612,792],margin:10,compress:!1}),a=r.pipe(blobStream());(i=(t=new Date).getMinutes())<10&&(i="0"+i),r.font("Helvetica",8);var t,i,s=115,d=0,c=1,u=Math.ceil(o.totalViveresSolicitados.length/29);o.dibujarCabeceraPDFSolicitud(r,c,u);for(var l=0;l<o.totalViveresSolicitados.length&&d<=29;l++)r.font("Helvetica",8),r.text(l+1,65,s),r.text(o.totalViveresSolicitados[l].productoSolicitudBase.codigo,100,s),r.text(o.totalViveresSolicitados[l].productoSolicitudBase.nombre,220,s),r.text(o.totalViveresSolicitados[l].productoSolicitudBase.unidad_medida,400,s),r.text(o.totalViveresSolicitados[l].totalMostrar.toFixed(2),500,s),s+=20,++d>29&&(r.rect(40,105,540,s-115).stroke(),r.text(c+"/"+u,570,s+15),r.font("Helvetica",6),r.text("RESPONSABLE: "+o.usuarioSesion.nombre_usuario,45,s+10),r.text("SOLICITANTE: "+o.totalViveresSolicitados.usuario.persona.nombre_completo,345,s+10),r.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+i,175,s+10),r.addPage({size:[612,792],margin:10}),s=115,d=0,c+=1,o.dibujarCabeceraPDFSolicitud(r,c,u));r.rect(40,105,540,s-115).stroke(),(i=(t=new Date).getMinutes())<10&&(i="0"+i),r.text(c+"/"+u,570,s+15),r.font("Helvetica",6),r.text("RESPONSABLE: "+o.usuarioSesion.nombre_usuario,45,s+5),r.text("SOLICITANTE: "+o.totalViveresSolicitados.usuario.persona.nombre_completo,345,s+5),r.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+i,175,s+5),r.end(),a.on("finish",function(){var o=a.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),n.stop()},o.dibujarCabeceraPDFSolicitud=function(e,r,a){e.font("Helvetica-Bold",12),e.text("CONSUMOS",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("SUCURSAL : ",-40,50,{align:"center"}),e.font("Helvetica",8),e.text(o.totalViveresSolicitados.sucursal.nombre,60,50,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FECHA : ",40,60,{width:40}),e.font("Helvetica",8),e.text(o.fechaATexto(o.totalViveresSolicitados.fecha),75,60,{width:40}),e.font("Helvetica-Bold",14),e.text("N°",380,40,{align:"center"}),e.text(o.totalViveresSolicitados.identificador,440,40,{align:"center"}),e.rect(40,80,540,25).stroke(),e.font("Helvetica-Bold",8),e.text("Nº",65,90),e.text("Código Ítem",100,90),e.text("Producto",220,90),e.text("Unidad medida",380,90),e.text("Cantidad solicitada",480,90)},o.calcularViveresDesdeFiltro=function(e){var r=[];o.totalViveresSolicitados={},o.solicitudesPedido=[],o.solicitudesOperaciones.forEach(function(a,t){if(a.activo||void 0!==e){if(e&&!a.id_pedido){o.solicitudesPedido.push(a.id);i=o.calcularTotalViveres(a,!0);r.push(i)}}else{var i=o.calcularTotalViveres(a,!0);r.push(i)}});var a=[];if(r.forEach(function(o){o.productos.forEach(function(e){var r={almacen:e.almacen,sucursal:e.almacen.sucursal,cantidad:e.cantidad_real,fecha:o.fecha,hora_fecha:o.fecha,usuario:o.usuario,estado:e.estado,producto:e.productoSolicitudBase,costo:e.productoSolicitudBase.inventarios&&e.productoSolicitudBase.inventarios.length?e.productoSolicitudBase.inventarios[0].costo_unitario:0,grupo:e.productoSolicitudBase.grupo,subgrupo:e.productoSolicitudBase.subgrupo,total:(e.productoSolicitudBase.inventarios&&e.productoSolicitudBase.inventarios.length?e.productoSolicitudBase.inventarios[0].costo_unitario:0)*e.cantidad_real,monto:e.monto};a.push(r)})}),e){for(var t=[];a.length>0;){var i=a.pop();if(0===t.length)t.push(i);else{var s,d=!1;t.forEach(function(o,e){o.producto.id!=i.producto.id||d||(d=!0,s=e)}),d&&void 0!==s?(t[s].cantidad+=i.cantidad,t[s].total=t[s].cantidad*t[s].costo):t.push(i)}}return t}return a},o.reporteExcel=function(e){if(n.start(),o.imprimir.detalle){(i=[]).push(["Nro.","Sucursal","Almacén","Hora-fecha","Usuario","Estado","Detalle","Unidad","Grupo","Subgrupo","Cantidad","Costo","Total"]);for(var r=o.calcularViveresDesdeFiltro(),a=[],t=0;t<r.length;t++)(a=[]).push(t+1),a.push(r[t].almacen.sucursal.nombre),a.push(r[t].almacen.nombre),a.push(new Date(r[t].fecha).toLocaleTimeString()+" "+new Date(r[t].fecha).toLocaleDateString()),a.push(r[t].usuario.nombre_usuario),a.push(r[t].estado?"Abierto":"Cerrado"),a.push(r[t].producto.nombre),a.push(r[t].producto.unidad_medida),a.push(r[t].grupo.nombre),a.push(r[t].subgrupo.nombre),a.push(r[t].cantidad),a.push(r[t].costo),a.push(r[t].total.toFixed(2)),i.push(a);n.stop()}else{var i;(i=[]).push(["Nro.","Sucursal","proveedor","Hora-fecha","Estado"]);for(a=[],t=0;t<o.listaPedidos.length;t++)(a=[]).push(t+1),a.push(o.listaPedidos[t].sucursal.nombre),a.push(o.listaPedidos[t].proveedor.razon_social),a.push(new Date(o.listaPedidos[t].fecha).toLocaleTimeString()+" "+new Date(o.listaPedidos[t].fecha).toLocaleDateString()),a.push(o.listaPedidos[t].recibido?"Completado":"En espera"),i.push(a);n.stop()}if(e)o.reportePdf(i),n.stop();else{var s="SheetJS",d=new Workbook,c=sheet_from_array_of_arrays(i);c["!cols"]=[{wch:5},{wch:18},{wch:18},{wch:12},{wch:15},{wch:15},{wch:12},{wch:25},{wch:12},{wch:12},{wch:12}],c["!rows"]=[{hpx:28,level:3}],d.SheetNames.push(s),d.Sheets[s]=c;var u=XLSX.write(d,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(u)],{type:"application/octet-stream"}),"REPORTE OPERACIONES.xlsx"),n.stop()}},o.reportePdf=function(e){var r=new PDFDocument({size:"letter",margin:10,compress:!1}),a=r.pipe(blobStream());(i=(t=new Date).getMinutes())<10&&(i="0"+i),o.posXforPdf=[],r.font("Helvetica",8);var t,i,s=65,d=115,c=0,u=1,l=Math.ceil(e.length/29);if(o.dibujarCabeceraReportePdf(r,e),o.imprimir.detalle){s=50;for(var p=0;p<e.length&&c<=29;p++){var P=s;if(r.font("Helvetica",8),p>0){for(var v=0;v<e[p].length;v++)r.text(e[p][v],P,d,{width:40},{align:"center"}),P=o.posXforPdf[v];d+=20,c++}c>29&&(r.rect(40,105,540,d-115).stroke(),r.text(u+"/"+l,570,d+15),r.font("Helvetica",6),r.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+i,175,d+10),r.addPage({size:[612,792],margin:10}),d=115,c=0,u+=1,o.dibujarCabeceraPDFSolicitud(r,u,l))}}else for(p=0;p<e.length&&c<=29;p++){P=s;if(r.font("Helvetica",8),p>0){for(v=0;v<e[p].length;v++)r.text(e[p][v],P,d,{width:40}),P+=0==v?30:60;d+=20,c++}c>29&&(r.rect(40,105,540,d-115).stroke(),r.text(u+"/"+l,570,d+15),r.font("Helvetica",6),r.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+i,175,d+10),r.addPage({size:[612,792],margin:10}),d=115,c=0,u+=1,o.dibujarCabeceraPDFSolicitud(r,u,l))}r.rect(40,105,540,650).stroke(),(i=(t=new Date).getMinutes())<10&&(i="0"+i),r.text(u+"/"+l,570,765),r.font("Helvetica",6),r.text("IMPRESION : "+t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" Hr. "+t.getHours()+":"+i,175,765),r.end(),a.on("finish",function(){var o=a.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),n.stop()},o.dibujarCabeceraReportePdf=function(e,r){if(e.font("Helvetica-Bold",12),e.text("REPORTE OPERACIONES",0,25,{align:"center"}),e.font("Helvetica-Bold",8),e.text("FECHA : ",40,60,{width:40}),e.font("Helvetica",8),e.text((new Date).toLocaleDateString(),75,60,{width:40}),e.rect(40,80,540,25).stroke(),e.font("Helvetica-Bold",8),o.imprimir.detalle){px=50;for(var a=0;a<r[0].length;a++)e.text(r[0][a],px,90),0==a?(px+=4*r[0][a].length+5,o.posXforPdf.push(px)):(o.imprimir.detalle,px+=4*r[0][a].length+15,o.posXforPdf.push(px))}else{px=65;for(a=0;a<r[0].length;a++)e.text(r[0][a],px,90),0==a?(px+=20,o.posXforPdf.push(px)):o.imprimir.detalle?px+=40:px+=60}e.font("Helvetica",8)},o.abrirModalProductosProveedor=function(e){o.checkProveedor(e)?(o.buscarProductos(null,o.pedido),o.abrirPopup(o.idDialogProductosProveedor)):o.mostrarMensaje("Seleccione un proveedor para ver su asignación de productos..")},o.seleccionarProductoAsignado=function(e){if(e.seleccionado)o.productosProveedorSeleccionados.some(function(o){return o===e.id})||o.productosProveedorSeleccionados.push(e);else{var r=o.productosProveedorSeleccionados.indexOf(e);r>=0&&!e.seleccionado?o.productosProveedorSeleccionados.splice(r,1):-1==r&&e.seleccionado&&o.productosProveedorSeleccionados.push(e.id)}},o.agregarProductosSeleccionados=function(){o.productosProveedorSeleccionados.length>0?o.productosProveedorSeleccionados.forEach(function(e,r,a){o.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,id_grupo:e.id_grupo,id_subgrupo:e.id_subgrupo},o.agregardetallePedido(o.detallePedido),r===a.length&&o.cerrarModalProductosAsignadosProveedor()}):o.mostrarMensaje("No se seleccionó ningún producto para ser agregado.")},o.eliminarDetallePedido=function(e){o.detallesPedido.splice(o.detallesPedido.indexOf(e),1)},o.generarPorProveedor=function(){if(o.pedido.proveedor)if(o.pedido.por_proveedor)if(o.pedido.proveedor.productos.length>0){o.paginatorProductosAsignados.filter=o.productosAsignadosPorveedor.grupo?o.productosAsignadosPorveedor.grupo:{id:0};b(o.usuarioSesion.id_empresa,o.pedido.proveedor).then(function(e){if(e.hasErr)o.mostrarMensaje(e.mensaje),o.listaProductosProveedor=[];else if(e.productos){var r=e.productos.split(",");o.listaProductosProveedor=r.map(function(o){return parseInt(o)}),M(o.usuarioSesion.id_empresa,o.paginatorProductosAsignados,o.usuarioSesion.id,o.listaProductosProveedor,!0).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.paginatorProductosAsignados.setPages(e.paginas),o.productosAsignadosProveedor=e.productos,o.productosAsignadosProveedor.forEach(function(e){o.listaProductosProveedor.some(function(o){return o===e.id})&&(o.detallePedido={producto:e,precio_unitario:e.precio_unitario,cantidad:1,id_grupo:e.id_grupo,id_subgrupo:e.id_subgrupo},o.agregardetallePedido(o.detallePedido))})),n.stop()}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(r)})}else o.mostrarMensaje("El proveedor no tiene productos asignados."),o.listaProductosProveedor=[];n.stop()}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(r)})}else o.mostrarMensaje("El proveedor no tiene productos asignados.");else o.detallePedido={},o.detallesPedido=[];else o.mostrarMensaje("Seleccione un proveedor.")},o.verificarAsignacionProductosProveedor=function(){o.listaProductosProveedor.length>0&&o.listaProductosProveedor.forEach(function(e){o.productosAsignacionProveedor.forEach(function(o){o.id===e&&(o.seleccionado=!0)})})},o.verificarSeleccionProductosProveedor=function(){o.listaProductosProveedorSeleccionados.length>0&&o.listaProductosProveedorSeleccionados.forEach(function(e){o.productosProveedorSeleccionados.forEach(function(o){o.id===e&&(o.seleccionado=!0)})})},o.obtenerProductos=function(){o.paginatorProductos=l(),o.paginatorProductos.column="nombre",o.paginatorProductos.filter=o.grupo,o.paginatorProductos.callBack=o.buscarProductos,o.paginatorProductos.getSearch("",null,null)},o.buscarProducto=function(e,r){if(void 0!==o.pedido)return""!=e&&void 0!=e&&void 0==r&&o.pedido.almacen?g(o.usuarioSesion.id_empresa,e,o.usuarioSesion.id,o.pedido.almacen):""!=e&&void 0!=e&&r&&o.pedido.almacen?g(o.usuarioSesion.id_empresa,e,o.usuarioSesion.id,o.pedido.almacen):void o.mostrarMensaje("Seleccione un almacen.");o.mostrarMensaje("Seleccione un almacen.")},o.filtrarProductosSeleccionadosPorGrupo=function(){if(o.detallesPedido.length>0){var e=[];o.detallesPedido.forEach(function(r){r.id_subgrupo===o.pedido.grupo&&e.push(r)}),e.length>0?o.detallesPedido=e.map(function(o){return o}):o.mostrarMensaje("No existen productos pertenecientes al grupo seleccionado. No se realizaron cambios.")}},o.modificarListaProductosProveedor=function(e){var r=o.listaProductosProveedor.indexOf(e.id);r>=0&&!e.seleccionado?o.listaProductosProveedor.splice(r,1):-1==r&&e.seleccionado&&o.listaProductosProveedor.push(e.id)},o.modificarListaProductosProveedorSeleccionados=function(e){var r=o.listaProductosProveedorSeleccionados.indexOf(e.id);r>=0&&!e.seleccionado?o.listaProductosProveedorSeleccionados.splice(r,1):-1==r&&e.seleccionado&&o.listaProductosProveedorSeleccionados.push(e.id)},o.seleccionarTodosParaAsignar=function(){o.seleccionProductosProveedor.seleccionar_todos?o.productosAsignacionProveedor.forEach(function(e){e.seleccionado=!0,o.modificarListaProductosProveedor(e)}):(o.productosAsignacionProveedor.forEach(function(o){o.seleccionado=!1}),o.modificarListaProductosProveedor(producto))},o.seleccionarTodosAsignados=function(){o.listaProductosProveedorSeleccionados=[],o.seleccionProductosProveedorAsignados.seleccionar_todos?o.productosAsignadosProveedor.forEach(function(e){e.seleccionado=!0,o.productosProveedorSeleccionados.push(e),o.modificarListaProductosProveedorSeleccionados(e)}):o.productosAsignadosProveedor.forEach(function(e){e.seleccionado=!1,o.productosProveedorSeleccionados.push(e),o.modificarListaProductosProveedorSeleccionados(e)})},o.actualizarProductosProveedor=function(){x(o.usuarioSesion.id_empresa,o.listaProductosProveedor,o.pedido.proveedor).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.mostrarMensaje(e.mensaje),o.cerrarModalProductosProveedor())}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(r)})},o.verificarPulso=function(e,r){13===e.keyCode&&o.buscarProductos(1)},o.verificarPulsoAsignados=function(e,r){13===e.keyCode&&o.buscarProductosAsignados(1)},o.buscarProductos=function(e,r){n.start(),e&&(o.paginatorProductos.currentPage=e),o.paginatorProductos.filter=o.configuracionPorveedor.grupo?o.configuracionPorveedor.grupo:{id:0},o.paginatorProductos.search=o.configuracionPorveedor.textoBusqueda?o.configuracionPorveedor.textoBusqueda:0,E(o.usuarioSesion.id_empresa,o.paginatorProductos,o.usuarioSesion.id).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.paginatorProductos.setPages(e.paginas),o.productosAsignacionProveedor=e.productos,o.pedido&&o.pedido.proveedor&&b(o.usuarioSesion.id_empresa,o.pedido.proveedor).then(function(e){if(e.hasErr)o.mostrarMensaje(e.mensaje),o.listaProductosProveedor=[];else if(e.productos){var r=e.productos.split(",");o.listaProductosProveedor=r.map(function(o){return parseInt(o)}),o.verificarAsignacionProductosProveedor()}else o.listaProductosProveedor=[];n.stop()}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(r)}));n.stop()}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(r)})},o.obtenerProductosAsignados=function(){o.paginatorProductosAsignados=l(),o.paginatorProductosAsignados.column="nombre",o.paginatorProductosAsignados.filter=o.grupo,o.paginatorProductosAsignados.callBack=o.buscarProductosAsignados,o.paginatorProductosAsignados.getSearch("",null,null)},o.buscarProductosAsignados=function(e,r){(n.start(),e&&(o.paginatorProductosAsignados.currentPage=e),void 0===o.pedido)?(o.pedido={},n.stop()):o.pedido.proveedor?(o.paginatorProductosAsignados.filter=o.productosAsignadosPorveedor.grupo?o.productosAsignadosPorveedor.grupo:{id:0},o.paginatorProductosAsignados.search=o.productosAsignadosPorveedor.textoBusqueda?o.productosAsignadosPorveedor.textoBusqueda:0,b(o.usuarioSesion.id_empresa,o.pedido.proveedor).then(function(e){if(e.hasErr)o.mostrarMensaje(e.mensaje),o.listaProductosProveedor=[];else if(e.productos){var r=e.productos.split(",");o.listaProductosProveedor=r.map(function(o){return parseInt(o)}),M(o.usuarioSesion.id_empresa,o.paginatorProductosAsignados,o.usuarioSesion.id,o.listaProductosProveedor).then(function(e){e.hasErr?o.mostrarMensaje(e.mensaje):(o.paginatorProductosAsignados.setPages(e.paginas),o.productosAsignadosProveedor=e.productos,o.listaProductosProveedorSeleccionados=[],o.verificarSeleccionProductosProveedor()),n.stop()}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(r)})}else o.listaProductosProveedor=[];n.stop()}).catch(function(e){n.stop();var r=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(r)})):o.mostrarMensaje("El proveedor no tiene productos asignados.")},o.cerrarModalProductosProveedor=function(){o.productosAsignacionProveedor=[],o.listaProductosProveedor=[],o.cerrarPopup(o.idDialogProductosProveedor)},o.abrirModalNuevoPedido=function(){o.abrirPopup(o.idDialogNuevoPedido)},o.cerrarModalNuevoPedido=function(){o.pedido={},o.detallesPedido={},o.cerrarPopup(o.idDialogNuevoPedido)},o.abrirmodalBusquedaProveedor=function(){o.filtrarProveedores(""),o.abrirPopup(o.idDialogBusquedaProveedor)},o.cerrarModalBusquedaProveedor=function(){o.cerrarPopup(o.idDialogBusquedaProveedor)},o.abrirmodalProductosAsignadosProveedor=function(){void 0===o.pedido&&(o.pedido={por_proveedor:!1}),void 0!==o.productosProveedorSeleccionados&&null!==o.productosProveedorSeleccionados||(o.productosProveedorSeleccionados=[]),o.pedido.proveedor?(o.buscarProductosAsignados(),o.abrirPopup(o.idDialogProductosAsigandosProveedor)):o.mostrarMensaje("Seleccione un proveedor.")},o.cerrarModalProductosAsignadosProveedor=function(e){e&&(o.productosProveedorSeleccionados=[],o.seleccionProductosProveedorAsignados.seleccionar_todos=!1),o.cerrarPopup(o.idDialogProductosAsigandosProveedor)},o.inicio()}]);