angular.module("agil.controladores").controller("controladorPolifuncionalidad",["$scope","$location","$localStorage","$templateCache","$route","blockUI","Paginator","FieldViewer","$timeout","$filter","ClasesTipo","ObtenerTodoPersonal","ObtenerEvaluaciones","GuardarEvaluacionPersonal","ObtenerReportePorMeses","ObtenerReportePorAnio","ObtenerReporteGeneralPorAnio","GuardarConfiguracionCalificacion","ObtenerConfiguracionCalificacion","GuardarConfiguracionDesempenio","ObtenerConfiguracionDesempenio","ActualizarEvaluacionPersonal",function(e,o,a,n,i,r,t,s,l,c,d,p,u,m,f,h,g,v,b,P,_,C){e.usuarioSesion=JSON.parse(a.usuario),e.idModalWizardPolifuncionalEdicion="modal-wizard-polifuncional-edicion",e.idModalContenedorPolifuncionalEdicion="modal-wizard-container-polifuncional-edicion",e.idModalWizardConceptoEdicion2="modal-wizard-polifuncional-ac-edicion",e.idModalContenedorConceptoEdicion2="modal-wizard-container-polifuncional-ac-edicion",e.modalBusquedaPersonal="dialog-Busqueda-personal-polifuncional",e.modalBusquedaCentroCosto="dialog-Busqueda-centro-costo-polifuncional",e.idModalReportes="dialog-reportes-polifuncional",e.reporteGraficoPolifuncional="reporte-grafico-polifuncional",e.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptsPolifuncionalidad(e.idModalWizardPolifuncionalEdicion,e.idModalContenedorPolifuncionalEdicion,e.modalBusquedaPersonal,e.idModalWizardConceptoEdicion2,e.idModalContenedorConceptoEdicion2,e.idModalReportes,e.reporteGraficoPolifuncional,e.modalBusquedaCentroCosto),e.buscarAplicacion(e.usuarioSesion.aplicacionesUsuario,o.path().substring(1)),e.obtenerColumnasAplicacion(),r.stop()}),e.$on("$routeChangeStart",function(o,a){e.eliminarPopup(e.idModalWizardPolifuncionalEdicion),e.eliminarPopup(e.idModalWizardConceptoEdicion2),e.eliminarPopup(e.idModalReportes),e.eliminarPopup(e.modalBusquedaPersonal),e.eliminarPopup(e.reporteGraficoPolifuncional),e.eliminarPopup(e.modalBusquedaCentroCosto)}),e.inicio=function(){e.obtenerCargos(),e.obtenerCentroCosto(),e.actualizarListaDesempenio(),e.obtenerConfiguracionnotas(),e.filtrarPersonal("");e.usuarioSesion.empresa.id;e.obtenerPaginador()},e.eliminar=function(o){o.eliminado=!0,o.eliminar=!0,m(e.usuarioSesion.empresa.id,o).then(function(o){o.hasErr?e.mostrarMensaje("Hubo un error no se pudo eliminar: "+o.mensaje):(e.mostrarMensaje(o.mensaje),e.recargarItemsTabla())},function(o){e.mostrarMensaje("No hay respuesta del servidor, se perdió la conexión: "+res.mensaje)})},e.obtenerConfiguracionnotas=function(){b(e.usuarioSesion.empresa.id).then(function(o){for(var a in o.configuracion)o.configuracion[a].encargados?e.encargados=o.configuracion[a]:e.empleados=o.configuracion[a];_(e.usuarioSesion.empresa.id).then(function(o){for(e.parametros=o.parametros;o.parametros.length>0;){var a=o.parametros.pop();e.listaDesempenio.map(function(e){e.nombre==a.nombre&&(e.desde=a.desde,e.hasta=a.hasta)})}})}).catch(function(o){e.mostrarMensaje(o.stack?o.stack:o.message)})},e.editar=function(o,a,n,i){if(e.abrirNuevoEvaluacionPolifuncional(),i&&(e.evaluacion={encargado:o.encargado,anio:{id:o.anio},mes:{id:o.mes},asistencia_capacitacion:o.asistencia_capacitacion,asistencia_reunion:o.asistencia_reunion,documentos_actualizados:o.documentos_actualizados,funciones_puntualidad:o.funciones_puntualidad,higiene_personal:o.higiene_personal,ingreso_campo:o.ingreso_campo,llenado_formularios:o.llenado_formularios,trabajo_equipo:o.trabajo_equipo,nota_total:o.nota_total,id:o.id,id_desempenio:o.id_desempenio,id_empleado:o.id_empleado,personal:{id:o.empleado.id,persona:{nombre_completo:o.empleado.persona.nombre_completo}}},e.evaluacion.ver=!0),a&&(e.evaluacion={encargado:o.encargado,anio:{id:o.anio},mes:{id:o.mes},asistencia_capacitacion:o.asistencia_capacitacion,asistencia_reunion:o.asistencia_reunion,documentos_actualizados:o.documentos_actualizados,funciones_puntualidad:o.funciones_puntualidad,higiene_personal:o.higiene_personal,ingreso_campo:o.ingreso_campo,llenado_formularios:o.llenado_formularios,trabajo_equipo:o.trabajo_equipo,nota_total:o.nota_total,id:o.id,id_desempenio:o.id_desempenio,id_empleado:o.id_empleado,personal:{id:o.empleado.id,persona:{nombre_completo:o.empleado.persona.nombre_completo}}},e.evaluacion.editar=!0),n){e.evaluacion.encargado=o.encargado,e.evaluacion.id_desempenio=o.id_desempenio,e.evaluacion.id_empleado=o.id_empleado,e.evaluacion.personal={id:o.empleado.id,persona:{nombre_completo:o.empleado.persona.nombre_completo}},e.evaluacion.nuevo=!0;$("#siguiente").trigger("click")}},e.obtenerPaginador=function(){r.start(),e.paginator=t(),e.paginator.column="anio",e.paginator.direccion="asc",e.filtro={id_empresa:e.usuarioSesion.empresa.id,mes:0,anio:0,desempenio:0,mas_campo:0,campo:0,cargo:0,estado:0,codigo:0,nombre:0,apellido:0,pagina:1,items_pagina:10},e.paginator.filter=e.filtro,e.paginator.callBack=e.obtenerEvaluaciones,e.paginator.getSearch("",e.filtro,null),e.resetFiltro(),r.stop()};var w="ERROR",S="bg-red";e.listaDesempenio=[{nombre:"Deficiente",desde:0,hasta:25,color:"bg-red"},{nombre:"Insatisfactorio",desde:26,hasta:50,color:"bg-yellow"},{nombre:"Satisfactorio",desde:51,hasta:75,color:"bg-orange-green"},{nombre:"Competente",desde:76,hasta:100,color:"bg-blue"}],e.actualizarListaDesempenio=function(o){if(null==o||void 0==o)_(e.usuarioSesion.empresa.id).then(function(o){for(;o.parametros.length>0;){var a=o.parametros.pop();e.listaDesempenio.map(function(e){e.nombre==a.nombre&&(e.desde=a.desde,e.hasta=a.hasta,e.id=a.id,e.activo=a.activo)})}}).catch(function(o){e.mostrarMensaje(o.stack?o.stack:o.message)});else for(var a=o.map(function(e){return e});a.length>0;){var n=a.pop();e.listaDesempenio.map(function(e){e.nombre==n.nombre&&(e.desde=n.desde,e.hasta=n.hasta)})}},e.listaEstados=[{id:1,nombre:"Activo"},{id:2,nombre:"Inactivo"}],e.determinarEstado=function(o){return 1==o?e.listaEstados[1].nombre:e.listaEstados[0].nombre},e.determinarDesempenio=function(o){var a=NaN;if(null==o||void 0==o)return"bg-red";e.listaDesempenio.map(function(e,n){e.id==o&&(a=n)});return NaN!==a?e.listaDesempenio[a].nombre:w},e.determinarColor=function(o){var a=NaN;if(null==o||void 0==o)return"bg-red";e.listaDesempenio.map(function(e,n){e.id==o&&(a=n)});return NaN!==a?e.listaDesempenio[a].color:S};var E=["asistencia_capacitacion","documentos_actualizados","trabajo_equipo","funciones_puntualidad","higiene_personal","asistencia_reunion","ingreso_campo","llenado_formularios"];e.calcularTotalEvaluacion=function(o){var a=0;E.map(function(n){null!==o[n]&&void 0!==o[n]&&o[n]>=0?(e.opcion[n]?a+=o[n]:o.encargado?(a+=e.encargados[n],o[n]=e.encargados[n]):(a+=e.empleados[n],o[n]=e.empleados[n]),o.nota_total=a):e.opcion[n]?a+=o[n]:o.encargado?(a+=encargados[n],o[n]=e.encargados[n]):(a+=empleados[n],o[n]=e.empleados[n])})},e.filtrarPolifuncionalidad=function(o,a){for(var n in o)""!==o[n]&&null!==o[n]||(o[n]=0);if(void 0!==a)return o;e.obtenerProformas()},e.calcularNotaTotalConfiguracion=function(e,o){var a=0,n=0;e&&(e.nota_total=0),o&&(o.nota_total=0);for(var i in e)"createdAt"!==i&&"updatedAt"!==i&&"id_empresa"!==i&&"id"!==i&&"activo"!==i&&"encargados"!==i&&(a+=e[i]);for(var i in o)"createdAt"!==i&&"updatedAt"!==i&&"id_empresa"!==i&&"id"!==i&&"activo"!==i&&"encargados"!==i&&(n+=o[i]);e.nota_total=a,o.nota_total=n};var x=!1,M=0,D=!1;e.validarDatosEvaluacion=function(e){if(D){var o=0;for(var a in e)e.hasOwnProperty(a)&&(o+=1);return o==E.length||4==o||7==o&&e.nuevo?x?!(M<1)||(M+=1,!1):(x=!0,!1):o<E.length+4}return void 0===e||null===e||(void 0===e.personal||null==e.personal||(D=!0,M+=1,!1))},e.guardarEvaluacion=function(o){if("Siguiente"!=$("#siguiente").text().trim())if(r.start(),e.listaDesempenio.map(function(e){o.nota_total>=e.desde&&o.nota_total<=e.hasta&&(o.id_desempenio=e.id)}),o.ver)e.cerrarPopPupNuevoPolifuncional(),r.stop();else{if(o.fecha=new Date(o.anio.id,o.mes.id,15,12,0,0),o.editar)var a=C(e.usuarioSesion.empresa.id,o);else a=m(e.usuarioSesion.empresa.id,o);a.then(function(o){e.mostrarMensaje(o.mensaje),e.cerrarPopPupNuevoPolifuncional(),e.recargarItemsTabla(),r.stop()},function(a){var n=void 0!==a.stack?a.stack:a.message;o.editar=void 0,e.mostrarMensaje("Se perdió la conexión."+n),r.stop()})}},e.reportePorMesGrafico=function(o,a){e.abriridModalReportesGrafico();var n=[];o.forEach(function(e,o){if(0!=o){var i=[];e.forEach(function(o,n){if(n>5&&n<=e.length-2){var r={y:"-"!==o?o:0,label:e.length-2!=n?a[n-6]:"TOTAL"};i.push(r),10}});var r={type:"column",interval:0,showInLegend:!0,legendText:(e[1]+" "+e[2]+" "+e[3]+" "+e[4]+" "+e[5]).toUpperCase(),dataPoints:i};n.push(r)}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte polifuncional desde "+a[0]+" hasta "+a[a.length-1]).toUpperCase(),fontSize:32},legend:{horizontalAlign:"center",verticalAlign:"top",fontSize:15},animationEnabled:!0,exportEnabled:!0,width:1100,height:600,axisX:{labelFontSize:18},data:n}).render(),r.stop()},e.reportePorMeses=function(o,a,n,i,t,s){if(r.start(),void 0===o||void 0===a||void 0===n||void 0===i||null===o||null===a||null===n||null===i)return e.mostrarMensaje("Ingrese desde que Mes/Año hasta que Mes/Año desea el reporte."),void r.stop();var l=["N°","Campo","Empleado","C.I.","Estado","Cargo"],c=[];if(void 0===t)var d=[{wch:4},{wch:12},{wch:20},{wch:9},{wch:8},{wch:9}];var p=[];f(o,a,n,i,e.usuarioSesion.empresa.id).then(function(u){if(0==u.reporte.length)return e.mostrarMensaje("No existen datos"),void r.stop();if(u.hasErr)e.mostrarMensaje(u.mensaje);else{u.mesesReporte.map(function(e){l.push(e)}),mesesReporte=u.mesesReporte;for(var m=0;m<u.reporte.length;m++){var f=[];f.push(m+1),f.push(u.reporte[m].campo.nombre),f.push(u.reporte[m].persona.nombre_completo),f.push(u.reporte[m].persona.ci),f.push(e.determinarEstado(u.reporte[m].eliminado)),f.push(u.reporte[m].empleadosFichas[u.reporte[m].empleadosFichas.length-1].cargos.length>0?u.reporte[m].empleadosFichas[u.reporte[m].empleadosFichas.length-1].cargos[0].cargo.nombre:"Sin cargo");var h=0,g=0;mesesReporte.map(function(o){o==(h<=u.reporte[m].evaluaciones.length-1?e.meses[u.reporte[m].evaluaciones[h].mes].nombre.substring(0,3)+"-"+u.reporte[m].evaluaciones[h].anio.toString().substring(4,2):"0")?(f.push(u.reporte[m].evaluaciones[h].nota_total),g+=u.reporte[m].evaluaciones[h].nota_total,h+=1):f.push("-"),0==m&&void 0===t&&d.push({wch:6})}),g/=u.reporte[m].evaluaciones.length,f.push(Math.round(g)),e.listaDesempenio.map(function(o){Math.round(g)>=o.desde&&Math.round(g)<=o.hasta&&f.push(e.determinarDesempenio(o.id))}),0==m&&void 0===t&&d.push({wch:10}),m==u.reporte.length-1&&(l.push("Promedio"),l.push("Desempeño"),void 0===t&&d.push({wch:12})),p.push(f)}if(c.push(l),p.map(function(e){c.push(e)}),t)s?e.reportePorMesGrafico(c,mesesReporte):(r.stop(),e.reportePorMesesPdf(c,o,a,n,i));else{var v="SheetJS",b=new Workbook,P=sheet_from_array_of_arrays(c);P["!cols"]=d,b.SheetNames.push(v),b.Sheets[v]=P;var _=XLSX.write(b,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});e.meses[o.id].nombre.substring(0,3),a.id.toString().substring(4,2),e.meses[n.id].nombre.substring(0,3),i.id.toString().substring(4,2);saveAs(new Blob([s2ab(_)],{type:"application/octet-stream"}),"REPORTE POLIFUNCIONAL POR MESES "+mesesReporte[0]+" : "+mesesReporte[mesesReporte.length-1]+".xlsx"),r.stop()}}}).catch(function(o){var a=void 0!==o.data&&null!==o.data?o.data:o.message;e.mostrarMensaje("Se produjo un error! "+a),r.stop()})},e.reportePorMesesPdf=function(o,a,n,i,r){var t=40,s=120;convertUrlToBase64Image(e.usuario.empresa.imagen,function(l){var c=l,d=o[0].length-8;12==d&&(t=30);var p=new PDFDocument({size:[612,792],margin:10,compress:!1}),u=p.pipe(blobStream());p.image(c,40,30,{fit:[85,85]});for(var m=0;m<=o.length-1;m++){if(o[m].length<=14){0==m&&(p.font("Helvetica-Bold",12),p.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),p.text("DESDE "+a.nombre.toUpperCase()+"-"+n.id+" HASTA "+i.nombre.toUpperCase()+"-"+r.id,50,45,{align:"center"}),p.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"}));for(var f=0;f<o[m].length;f++)m>0?p.font("Helvetica",8):p.font("Helvetica-Bold",8),0==f&&(p.text(o[m][f],t,s,{width:50}),t-=30),f>0&&f<5&&((2==f||1==f||5==f)&&m>=1&&p.font("Helvetica",5),p.text(o[m][f],t,s,{width:50,align:"center"})),f>4&&f<o[m].length-3&&(5==f?p.text(o[m][f].toLowerCase(),t,s,{width:50,align:"center"}):p.text(o[m][f],t,s,{width:50,align:"center"}),t-=10),f>=o[m].length-3&&p.text(o[m][f],t,s,{width:50,align:"center"}),t+=45}if(o[m].length>=15&&o[m].length<=23){0==m&&(p.font("Helvetica-Bold",12),p.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),p.text("DESDE "+a.nombre+"-"+n.id+" HASTA "+i.nombre+"-"+r.id,50,45,{align:"center"}),p.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"}));for(f=0;f<o[m].length;f++)m>0?p.font("Helvetica",6):p.font("Helvetica-Bold",6),0==f&&(p.text(o[m][f],t,s,{width:50}),t-=40),f>0&&f<5&&((2==f||1==f)&&m>=1&&p.font("Helvetica",5),p.text(o[m][f],t,s,{width:45,align:"center"}),t-=5),f>4&&f<o[m].length-3&&(p.text(o[m][f],t,s,{width:45,align:"center"}),t-=15),f>=o[m].length-3&&p.text(o[m][f],t,s,{width:45,align:"center"}),t+=40}if(d>12&&(t=20),12==d&&(t=30),d<12&&d>10&&(t=35),d<=10&&(t=40),(s+=25)>700){p.addPage({size:"letter",margin:10}),p.font("Helvetica-Bold",12),p.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,30,{align:"center"}),p.text("DESDE "+a.nombre+"-"+n.id+" HASTA "+i.nombre+"-"+r.id,50,45,{align:"center"}),p.text(" TODOS LOS CAMPOS  TODOS LOS EMPLEADOS",50,60,{align:"center"});for(var h=0;h<o[0].length;h++)p.font("Helvetica-Bold",8),p.text(o[0][h],t,s-625,{width:50}),0==h&&(t-=20),2==h&&(t+=10),h>4&&h<o[m].length-3&&(t-=10),t+=45;d>12&&(t=20),12==d&&(t=30),d<12&&d>10&&(t=35),d<=10&&(t=40),s=120}}d>12&&setTimeout(function(){e.$apply(function(){e.mostrarMensaje("ADVERTENCIA: El rango de fechas excede el tamaño máximo de impresion.")})},1e3),p.end(),u.on("finish",function(){var e=u.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},e.reportePromediosGeneralGrafico=function(o,a,n,i){e.abriridModalReportesGrafico();e.graficoType="column",i&&(e.graficoType=i);var t=[];o.map(function(e,o){if(0!=o){var a={y:e[9],label:e[0]};t.push(a),10}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte promedio general campo "+n+" gestión "+a.id).toUpperCase(),fontSize:32},animationEnabled:!0,exportEnabled:!0,width:1100,axisX:{title:"Promedio total mensual"},data:[{type:"column",dataPoints:t}]}).render(),r.stop()},e.reportePromediosGeneralExcel=function(o,a,n,i){if(r.start(),null===o||void 0===o||void 0===a||null===a)return e.mostrarMensaje("Ingrese el Campo y el Año del cual desea el reporte."),void r.stop();var t=[];t.push(["","Asistencia Capacitación","Documentos Actualizados","Trabajo en equipo","Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo","Higiene personal","Puntualidad a la asistencia de reunión de 5 minutos en campo","Cumplimiento de ingreso a campo","Aplicación y llenado correcto de los formularios del SIG","TOTAL","DESEMPEÑO"]),g(o.id,a,e.usuarioSesion.empresa.id).then(function(s){if(0==s.reporte.length)return e.mostrarMensaje("No existen datos"),void r.stop();for(var l=0;l<s.reporte.length;l++){var c=[];c.push(e.meses[s.reporte[l].mes].nombre),c.push(s.reporte[l].asistencia_capacitacion),c.push(s.reporte[l].documentos_actualizados),c.push(s.reporte[l].trabajo_equipo),c.push(s.reporte[l].funciones_puntualidad),c.push(s.reporte[l].higiene_personal),c.push(s.reporte[l].asistencia_reunion),c.push(s.reporte[l].ingreso_campo),c.push(s.reporte[l].llenado_formularios),c.push(s.reporte[l].total),e.listaDesempenio.map(function(o){s.reporte[l].total>=o.desde&&s.reporte[l].total<=o.hasta&&c.push(e.determinarDesempenio(o.id))}),t.push(c)}if(n)i?(r.stop(),e.reportePromediosGeneralGrafico(t,o,a.nombre)):(r.stop(),e.reportePromediosGeneralPdf(t,o,a.nombre));else{var d="SheetJS",p=new Workbook,u=sheet_from_array_of_arrays(t);u["!cols"]=[{wch:12},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],u["!rows"]=[{hpx:28,level:3}],p.SheetNames.push(d),p.Sheets[d]=u;var m=XLSX.write(p,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(m)],{type:"application/octet-stream"}),"REPORTE POLIFUNCIONAL CAMPO "+a.nombre+" : "+anio.id+".xlsx"),r.stop()}}).catch(function(o){var a=void 0!==o.data&&null!==o.data?o.data:null!==o.message&&void 0!==o.message?o.message:void 0!==o.stack&&null!==o.stack?o.stack:"Se perdió la conexión al servidor.";e.mostrarMensaje("Se produjo un error! "+a),r.stop()})},e.reportePromediosGeneralPdf=function(o,a,n){var i=15,r=180,t=20;convertUrlToBase64Image(e.usuario.empresa.imagen,function(e){var s=e,l=(o[0].length,new PDFDocument({size:[792,612],margin:10,compress:!1})),c=l.pipe(blobStream());l.image(s,40,40,{fit:[85,85]});for(var d=0;d<=o.length-1;d++){0==d&&(l.font("Helvetica-Bold",12),l.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),l.text("GESTIÓN "+a.id,50,55,{align:"center"}),l.text(" "+n.toUpperCase()+" ",50,70,{align:"center"}));for(var p=0;p<o[d].length;p++)p>0?0==d?(l.font("Helvetica-Bold",7),p>=o[d].length-2?(l.text(o[d][p],i-t,r-40,{width:70,align:"center"}),t+=20):l.text(o[d][p],i,r-40,{width:70,align:"center"})):(l.font("Helvetica",8),p>=o[d].length-2?(p==o[d].length-1?l.text(o[d][p],i-t,r,{width:70,align:"center"}):l.text(o[d][p].toFixed(2),i-t,r,{width:70,align:"center"}),t+=20):(l.text(o[d][p].toFixed(2),i,r,{width:70,align:"center"}),t=20)):(l.font("Helvetica-Bold",8),l.text(o[d][p],i,r,{width:70,align:"center"})),i+=70;i=25,(r+=25)>700&&(l.addPage({size:"letter",margin:10}),r=120)}l.end(),c.on("finish",function(){var e=c.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},e.reportePromediosCampoGrafico=function(o,a){e.abriridModalReportesGrafico();var n=[];o.map(function(e,a){if(0!=a){var i=10,r=[];e.map(function(e,a){if(0!=a&&a<=9){var n={x:i,y:e,label:o[0][a]};r.push(n),i+=10}});var t={type:"column",showInLegend:!0,legendText:e[0].toUpperCase(),dataPoints:r};n.push(t)}}),new CanvasJS.Chart("chartContainer",{title:{text:("Reporte anual por campos gestión "+a.id).toUpperCase(),fontSize:32},legend:{horizontalAlign:"center",verticalAlign:"top",fontSize:15},animationEnabled:!0,exportEnabled:!0,width:1100,height:600,axisX:{labelFontSize:18},data:n}).render(),r.stop()},e.reportePromediosCampoExcel=function(o,a,n){if(r.start(),null===o||void 0===o)return r.stop(),void e.mostrarMensaje("Ingrese el Año del cual desea el reporte.");var i=[];i.push([" ","Asistencia Capacitación","Documentos Actualizados","Trabajo en equipo","Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo","Higiene personal","Puntualidad a la asistencia de reunión de 5 minutos en campo","Cumplimiento de ingreso a campo","Aplicación y llenado correcto de los formularios del SIG","TOTAL","DESEMPEÑO"]),h(o.id,e.usuarioSesion.empresa.id).then(function(t){for(var s=[],l=0;l<t.reporte.length;l++)(s=[]).push(null!==t.reporte[l].campo&&void 0!=t.reporte[l].campo?t.reporte[l].campo.nombre:""),s.push(t.reporte[l].asistencia_capacitacion),s.push(t.reporte[l].documentos_actualizados),s.push(t.reporte[l].trabajo_equipo),s.push(t.reporte[l].funciones_puntualidad),s.push(t.reporte[l].higiene_personal),s.push(t.reporte[l].asistencia_reunion),s.push(t.reporte[l].ingreso_campo),s.push(t.reporte[l].llenado_formularios),s.push(t.reporte[l].total),e.listaDesempenio.map(function(o){t.reporte[l].total>=o.desde&&t.reporte[l].total<=o.hasta&&s.push(e.determinarDesempenio(o.id))}),i.push(s);if(a)n?(r.stop(),e.reportePromediosCampoGrafico(i,o)):(r.stop(),e.reportePromediosCampoPdf(i,o));else{var c="SheetJS",d=new Workbook,p=sheet_from_array_of_arrays(i);p["!cols"]=[{wch:12},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],p["!rows"]=[{hpx:28,level:3}],d.SheetNames.push(c),d.Sheets[c]=p;var u=XLSX.write(d,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([s2ab(u)],{type:"application/octet-stream"}),"REPORTE ANUAL POLIFUNCIONAL POR CAMPOS "+o.id+".xlsx"),r.stop()}})},e.reportePromediosCampoPdf=function(o,a){var n=20,i=180,r=20;convertUrlToBase64Image(e.usuario.empresa.imagen,function(e){var t=e,s=(o[0].length,1),l=new PDFDocument({size:[792,612],margin:10,compress:!1}),c=l.pipe(blobStream());l.image(t,40,40,{fit:[85,85]});for(var d=0;d<=o.length-1;d++){0==d&&(l.font("Helvetica-Bold",12),l.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),l.text("GESTIÓN "+a.id,50,55,{align:"center"}),l.font("Helvetica",12),l.text(s,730,585,{width:70,align:"center"}));for(var p=0;p<o[d].length;p++)p>0?0==d?(l.font("Helvetica-Bold",7),p>=o[d].length-2?(l.text(o[d][p],n-r,i-40,{width:70,align:"center"}),r+=20):l.text(o[d][p],n,i-40,{width:70,align:"center"})):(l.font("Helvetica",8),p>=o[d].length-2?(p==o[d].length-2?l.text(o[d][p].toFixed(2),n-r,i,{width:70,align:"center"}):p==o[d].length-1?l.text(o[d][p],n-r,i,{width:70,align:"center"}):l.text(o[d][p].toFixed(2),n-r,i,{width:70,align:"center"}),r+=20):(l.text(o[d][p].toFixed(2),n,i,{width:70,align:"center"}),r=20)):(l.font("Helvetica-Bold",8),l.text(o[d][p],n,i,{width:70,align:"center"})),n+=70;if(n=25,1,(i+=15)>580){l.addPage({size:[792,612],margin:10}),s+=1,l.font("Helvetica",12),l.text(s,730,i,{width:70,align:"center"}),l.font("Helvetica-Bold",12),l.text("MATRIZ POLIFUNCIONALIDAD Y DESEMPEÑO",50,40,{align:"center"}),l.text("GESTIÓN "+a.id,50,55,{align:"center"}),r=20,i=120,l.font("Helvetica-Bold",7);for(var u=0;u<o[0].length;u++)u>=o[0].length-2?(l.text(o[0][u],n-r,i-40,{width:70,align:"center"}),r+=20):l.text(o[0][u],n,i-40,{width:70,align:"center"}),n+=70;n=25}}l.end(),c.on("finish",function(){var e=c.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})})},e.obtenerEvaluaciones=function(){r.start(),e.filtro=e.filtrarFiltroPolifuncionalidad(e.filtro,!0),e.paginator.filter=e.filtro,u(e.paginator).then(function(o){e.evaluaciones=o.evaluaciones.rows,e.paginator.setPages(o.paginas),void 0!==o.mensaje&&e.mostrarMensaje(o.mensaje),r.stop()}).catch(function(o){l(function(){e.$apply(function(){e.mostrarMensaje(o.data)})},500),r.stop()})},e.resetFiltro=function(){e.filtro={id_empresa:e.usuarioSesion.empresa.id,mes:"",anio:"",desempenio:"",mas_campo:"",campo:"",cargo:"",estado:"",codigo:"",nombre:"",apellido:"",pagina:1,items_pagina:10}},e.filtrarFiltroPolifuncionalidad=function(o,a){if(void 0!==a){for(var n in o)null===o[n]||void 0===o[n]?o[n]=0:0!=o[n]&&"0"!=o[n]||"codigo"!=n&&"nombre"!=n&&"apellido"!=n||(o[n]="");return o}e.obtenerEvaluaciones()},e.obtenerColumnasAplicacion=function(){r.start(),e.fieldViewer=s({crear:!0,id_empresa:e.usuarioSesion.empresa.id,configuracion:{anio:{value:"Año",show:!0},mes:{value:"Mes",show:!0},estado:{value:"Estado",show:!0},codigo:{value:"Código",show:!0},nombre:{value:"Nombre completo",show:!0},campo:{value:"Campo",show:!0},cargo:{value:"Cargo",show:!0},asis_capacitacion:{value:"Asistencia Capacitación",show:!0},doc_actualizados:{value:"Documentos Actualizados",show:!0},trab_equipo:{value:"Trabajo en equipo",show:!0},funciones_puntualidad:{value:"Cumplimiento de las funciones asignadas y puntualidad en el horario de trabajo",show:!0},higiene:{value:"Higiene personal",show:!0},puntualidad_asistencia_campo:{value:"Puntualidad a la asistencia de reunión de 5 minutos en campo",show:!0},ingreso_campo:{value:"Cumplimiento de ingreso a campo",show:!0},llenado_correcto_sig:{value:"Aplicación y llenado correcto de los formularios del SIG",show:!0},nota_total:{value:"Nota total",show:!0}}},e.aplicacion.aplicacion.id),e.fieldViewer.updateObject(),r.stop()},e.obtenerCargos=function(){r.start(),d("RRHH_CARGO").then(function(o){e.cargos=o.clases,r.stop()},function(o){e.mostrarMensaje("Se perdió la conexión."),r.stop()})},e.obtenerCentroCosto=function(){r.start(),d("CENCOS").then(function(o){e.centrosCostos=o.clases,r.stop()},function(o){e.mostrarMensaje("Se perdió la conexión."),r.stop()})},e.buscarPersonal=function(o){if(""!=o&&void 0!=o)return c("filter")(e.todoPersonal,o)},e.filtrarPersonal=function(o){void 0!==e.todoPersonal?e.personalProcesado=c("filter")(e.todoPersonal,o):p(e.usuarioSesion.empresa.id).then(function(o){e.todoPersonal=o.personal,e.personalProcesado=o.personal,void 0!==o.mensaje&&e.mostrarMensaje(o.mensaje)},function(o){e.mostrarMensaje("Se perdió la conexión.")})},e.filtrarCentroCosto=function(o){void 0!==e.centrosDeCostosProcesado?e.centrosDeCostosProcesado=c("filter")(e.centrosDeCostos,o):e.centrosDeCostosProcesado=e.centrosDeCostos},e.establecerPersonal=function(o,a){void 0===e.evaluacion&&(e.evaluacion={});var n={id:o.id,persona:{nombre_completo:o.persona.nombre_completo}};e.evaluacion.personal=n,void 0!==a&&e.cerrarmodalBusquedaPersonal()},e.establecercentroCosto=function(o,a){void 0===e.reporte&&(e.reporte={}),e.reporte.campoXanio=o,void 0!==a&&e.cerrarmodalBusquedaCentroCosto()},e.abriridModalReportes=function(){e.abrirPopup(e.idModalReportes)},e.cerraridModalReportes=function(){e.cerrarPopup(e.idModalReportes)},e.abriridModalReportesGrafico=function(){e.abrirPopup(e.reporteGraficoPolifuncional)},e.cerraridModalReportesGrafico=function(){e.cerrarPopup(e.reporteGraficoPolifuncional)},e.abrirNuevoEvaluacionPolifuncional=function(){void 0==e.evaluacion&&(e.evaluacion={},e.evaluacion.mes={id:(new Date).getMonth()},e.evaluacion.anio={id:(new Date).getFullYear()},e.evaluacion.encargado=!1,void 0==e.opcion&&(e.opcion={},E.forEach(function(o){e.opcion[o]=!0})),E.forEach(function(o){e.evaluacion[o]=0}),e.evaluacion.nota_total=0),e.abrirPopup(e.idModalWizardPolifuncionalEdicion)},e.cerrarPopPupNuevoPolifuncional=function(){e.evaluacion={},e.evaluacion=void 0,e.recargarItemsTabla(),e.cerrarPopup(e.idModalWizardPolifuncionalEdicion)},e.abrirmodalParametrosPolifuncionalidad=function(){e.abrirPopup(e.idModalWizardConceptoEdicion2)},e.cerrarmodalParametrosPolifuncionalidad=function(){e.cerrarPopup(e.idModalWizardConceptoEdicion2)},e.abrirmodalBusquedaPersonal=function(){e.filtrarPersonal(""),e.abrirPopup(e.modalBusquedaPersonal)},e.cerrarmodalBusquedaPersonal=function(){e.cerrarPopup(e.modalBusquedaPersonal)},e.abrirmodalBusquedaCentroCosto=function(){e.filtrarCentroCosto(""),e.abrirPopup(e.modalBusquedaCentroCosto)},e.cerrarmodalBusquedaCentroCosto=function(){e.cerrarPopup(e.modalBusquedaCentroCosto)},e.comprobarConfiguracion=function(){if(e.empleados){var o=0;for(var a in e.empleados)e.empleados.hasOwnProperty(a)&&(o+=1)}if(e.encargados){var n=0;for(var a in e.encargados)e.encargados.hasOwnProperty(a)&&(n+=1)}return!(o>7&&n>7)},e.guardarConfiguracionEvaluacion=function(o,a,n){if("Siguiente"!=$("#siguiente-conf").text().trim()){r.start(),n.encargados=!1,a.encargados=!0;var i=[n,a];v(e.usuarioSesion.empresa.id,i).then(function(o){if(o.hasErr){o.mensaje;e.mostrarMensaje("Hubo un error. "+o.mensaje)}},function(o){e.mostrarMensaje("No hubo respuesta del servidor, se perdió la conexión.")}),P(e.usuarioSesion.empresa.id,e.listaDesempenio).then(function(o){o.hasErr?e.mostrarMensaje("Hubo uno o mas errores. "+rrores+" "+o.mensaje):e.mostrarMensaje(o.mensaje),r.stop(),e.recargarItemsTabla()}),e.cerrarmodalParametrosPolifuncionalidad()}},e.inicio()}]);