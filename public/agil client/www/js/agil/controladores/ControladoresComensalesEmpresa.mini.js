angular.module("agil.controladores").controller("controladorComensalesEmpresa",["ObtenerImagen","$scope","$timeout","$localStorage","$filter","$location","blockUI","Clientes","ClientesNit","GuardarAlias","ObtenerAlias","GuardarGerencias","ObtenerGerencias","GuardarComensales","ObtenerComensales","GuardarComidas","ObtenerComidas","GuardarPrecioComidas","ObtenerPrecioComidas","GuardarHistorialExcel","GuardarComensalesExcel","ObtenerHistorial","GuardarEmpresasExcel","GuardarGerenciasExcel","GuardarComidasExcel","GuardarPreciosExcel","Paginator","BusquedaComensales","ObtenerReporteComedor","ObtenerCambioMoneda","ObtenerReporteEmpresa","ObtenerReporteComensal","ObtenerAlertasMarcacion","EditarAlertasMarcacion","ObtenerHistorialDocumentos","ObtenerDocumento",function(e,a,r,o,t,i,s,n,l,c,m,d,p,u,f,C,g,h,E,b,v,k,M,x,S,w,j,A,_,P,D,y,O,z,R,L){a.usuario=JSON.parse(o.usuario),a.modalEdicionAlias="modalAliasEmpresasCliente",a.modalEdicionGerencias="modalGerenciaEmpresasCliente",a.modalEdicionComensales="modalComensalesEmpresasCliente",a.modalEdicionComidas="modalComidasEmpresasCliente",a.modalEdicionPrecios="modalPreciosComidasEmpresasCliente",a.dialogClienteEmpresa="dialog-cliente-empresa",a.busquedaComensalesEmpresa="dialog-comensales-empresa",a.dialogAlertasMarcaciones="dialog-alerta-marcaciones",a.dialogHistorialDocumentos="dialog-historial-documentos",a.imagenEmpresa,e(a.usuario.empresa.imagen).then(function(e){a.imagenEmpresa=e}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}),a.$on("$viewContentLoaded",function(){ejecutarScriptsComensales(a.modalEdicionAlias,a.modalEdicionGerencias,a.modalEdicionComensales,a.modalEdicionComidas,a.modalEdicionPrecios,a.dialogClienteEmpresa,a.busquedaComensalesEmpresa,a.dialogAlertasMarcaciones,a.dialogHistorialDocumentos)}),a.$on("$routeChangeStart",function(e,r){a.eliminarPopup(a.modalEdicionAlias),a.eliminarPopup(a.modalEdicionGerencias),a.eliminarPopup(a.modalEdicionComensales),a.eliminarPopup(a.modalEdicionComidas),a.eliminarPopup(a.modalEdicionPrecios),a.eliminarPopup(a.dialogClienteEmpresa),a.eliminarPopup(a.busquedaComensalesEmpresa),a.eliminarPopup(a.dialogAlertasMarcaciones),a.eliminarPopup(a.dialogHistorialDocumentos)}),a.odenarColumnasComensales=function(e){a.paginator.direccion="asc"==a.paginator.direccion?"desc":"asc",a.paginator.sortColumn(e)},a.ordenarColumnasMarcaciones=function(e){a.filtroMarcaciones.direccion="asc"==a.paginator.direccion?"desc":"asc",a.filtroMarcaciones.columna=e,a.obtenerAlertas()},a.inicio=function(){if(a.activeModal=0,a.obtenerClientes(),a.empresaExternaSeleccionada){var e=Object.assign({},a.empresaExternaSeleccionada);a.filtroComensales={desde:"",hasta:"",empresaCliente:e,id_usuario:"",id_cliente:"",mes:"",anio:"",gerencia:"",comida:"",comensal:""},a.reportes=[{id:1,nombre:"Reporte Comedor"},{id:2,nombre:"Empresa"},{id:3,nombre:"Por comensal"}],a.obtenerPaginador(),a.listaAliasclientesEmpresa=[],a.listaComensalesclienteEmpresa=[],a.listaGerenciasClienteEmpresa=[],a.listaComidasclienteEmpresa=[],a.listaPrecioComidasclienteEmpresa=[],a.alertaMarcaciones=[],a.historialesDocumentos=[],a.obtenerComidas(),a.obtenerGerencias(),a.obtenerHistoriales(),a.obtenerComensales(),a.filtroMarcaciones={desde:"",hasta:"",columna:"fecha",direccion:"asc"},setTimeout(function(){aplicarDatePickers()},200)}s.stop()},a.PopoverConfiguracionComensales={templateUrl:"PopoverConfiguracionComensales.html",title:"Menu",isOpen:!1},a.buscarCliente=function(e){if(""!=e&&void 0!=e)return l(a.usuario.id_empresa,e)},a.buscarComensales=function(e){if(""!=e&&void 0!=e)return A(a.usuario.id_empresa,a.usuario.id,a.empresaExternaSeleccionada.id,e)},a.filtrarClientes=function(e){a.clientesProcesados=t("filter")(a.clientes,e)},a.filtrarComensales=function(e){a.comensalesProcesados=t("filter")(a.comensalesBusqueda,e)},a.obtenerHistorialDocumentos=function(){s.start(),a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0),a.paginator.filter=a.filtroComensales,R(a.usuario.id_empresa,a.usuario.id,a.empresaExternaSeleccionada.id,a.paginator).then(function(e){a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0,!0),e.hasErr?a.mostrarMensaje(e.mensaje):a.historialesDocumentos=e.documentos,s.stop()}).catch(function(e){s.stop();var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r)})},a.obtenerClientes=function(){s.start(),n(a.usuario.id_empresa).then(function(e){a.clientes=e,a.clientesProcesados=e,s.stop()}).catch(function(e){s.stop();var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r)})},a.establecerCliente=function(e){switch(a.activeModal){case 0:a.filtroComensales||(a.filtroComensales={}),a.empresaExternaSeleccionada||(a.empresaExternaSeleccionada=Object.assign({},e),a.inicio()),a.filtroComensales.empresaCliente=Object.assign({},e);break;case 1:a.clienteEmpresaAsignacionAlias||(a.clienteEmpresaAsignacionAlias={}),a.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},e);break;case 2:a.clienteEmpresaEdicionGerencias||(a.clienteEmpresaEdicionGerencias={}),a.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},e),a.obtenerGerencias(!0);break;case 3:a.clienteEmpresaEdicionComensales||(a.clienteEmpresaEdicionComensales={}),a.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},e),a.obtenerComensales(!0);break;case 4:a.clienteEmpresaComidas||(a.clienteEmpresaComidas={}),a.clienteEmpresaComidas.empresaCliente=Object.assign({},e),a.clienteEmpresaComidas.verTodos,a.obtenerComidas(!0);break;case 5:a.clienteEmpresaPreciosComidas||(a.clienteEmpresaPreciosComidas={}),a.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},e),a.obtenerPrecioComidas(!0);break;default:a.mostrarMensaje("Ocurrio un error al asignar")}},a.establecerComensal=function(e,r){a.filtroComensales.comensal=Object.assign({},e),r&&a.cerrardialogBusquedaComensales()},a.seleccionarcliente=function(e){switch(a.activeModal){case 0:a.filtroComensales||(a.filtroComensales={}),a.empresaExternaSeleccionada||(a.empresaExternaSeleccionada=Object.assign({},e),a.inicio()),a.filtroComensales.empresaCliente=Object.assign({},e);break;case 1:a.clienteEmpresaAsignacionAlias||(a.clienteEmpresaAsignacionAlias={}),a.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},e);break;case 2:a.clienteEmpresaEdicionGerencias||(a.clienteEmpresaEdicionGerencias={}),a.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},e),a.obtenerGerencias(!0);break;case 3:a.clienteEmpresaEdicionComensales||(a.clienteEmpresaEdicionComensales={}),a.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},e),a.obtenerComensales(!0);break;case 4:a.clienteEmpresaComidas||(a.clienteEmpresaComidas={}),a.clienteEmpresaComidas.empresaCliente=Object.assign({},e),a.clienteEmpresaComidas.verTodos=!1,a.obtenerComidas(!0);break;case 5:a.clienteEmpresaPreciosComidas||(a.clienteEmpresaPreciosComidas={}),a.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},e),a.obtenerPrecioComidas(!0);break;default:a.mostrarMensaje("Ocurrio un error al asignar")}a.cerrardialogClientesComensales()},a.obtenerAliasEmpresa=function(){s.start(),m(a.usuario.id_empresa,a.usuario.id).then(function(e){e.hasErr?a.mostrarMensaje(e.mensaje):a.listaAliasclientesEmpresa=e.lista,s.stop()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.obtenerGerencias=function(e){s.start(),p(a.usuario.id_empresa,a.usuario.id,e?a.clienteEmpresaEdicionGerencias.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(e){e.hasErr?a.mostrarMensaje(e.mensaje):a.listaGerenciasClienteEmpresa=e.lista,s.stop()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.obtenerComensales=function(e){s.start(),f(a.usuario.id_empresa,a.usuario.id,e?a.clienteEmpresaEdicionComensales.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(e){e.hasErr?a.mostrarMensaje(e.mensaje):(a.listaComensalesclienteEmpresa=e.lista,a.comensalesBusqueda=e.lista,a.comensalesProcesados=e.lista),s.stop()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.verTodasLasComidas=function(){a.clienteEmpresaComidas?a.clienteEmpresaComidas.verTodos?a.clienteEmpresaComidas.verTodos=!1:a.clienteEmpresaComidas.verTodos=!0:(a.clienteEmpresaComidas={},a.clienteEmpresaComidas.verTodos=!1),a.obtenerComidas()},a.obtenerComidas=function(e){s.start(),a.clienteEmpresaComidas||(a.clienteEmpresaComidas={},a.clienteEmpresaComidas.verTodos=!1),(e?g(a.usuario.id_empresa,a.usuario.id,a.clienteEmpresaComidas.empresaCliente.id):a.clienteEmpresaComidas.verTodos?g(a.usuario.id_empresa,a.usuario.id,0):g(a.usuario.id_empresa,a.usuario.id,a.empresaExternaSeleccionada.id)).then(function(e){e.hasErr?a.mostrarMensaje(e.mensaje):a.listaComidasclienteEmpresa=e.lista,s.stop()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.obtenerPrecioComidas=function(e){s.start(),E(a.usuario.id_empresa,a.usuario.id,e?a.clienteEmpresaPreciosComidas.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(e){e.hasErr?a.mostrarMensaje(e.mensaje):a.listaPrecioComidasclienteEmpresa=e.lista,s.stop()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.obtenerHistoriales=function(e){s.start(),a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0),a.paginator.filter=a.filtroComensales,k(a.usuario.id_empresa,a.usuario.id,a.empresaExternaSeleccionada.id,a.paginator).then(function(e){a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0,!0),e.hasErr?a.mostrarMensaje(e.mensaje):(a.historialesComedor=e.historial.map(function(e){return e.fecha_texto=e.fecha.split("T")[0].split("-").reverse().join("/")+" "+e.fecha.split("T")[1].split(".")[0],e.fecha=new Date(e.fecha),e}),a.paginator.setPages(e.paginas)),s.stop()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.obtenerAlertas=function(e){s.start(),a.filtroMarcaciones=a.filtrarHistorial(a.filtroMarcaciones,!0),O(a.usuario.id_empresa,a.usuario.id,a.empresaExternaSeleccionada.id,a.filtroMarcaciones).then(function(e){if(e.hasErr)e.mostrarMensaje(e.mensaje);else{a.alertaMarcaciones=e.alertas,a.Marcaciones=e.alertas;for(var r=0;r<a.alertaMarcaciones.length;r++){a.alertaMarcaciones[r].marcacionesFaltantes=[];for(var o=0;o<a.alertaMarcaciones[r].marcaciones.length;o++){var t=-1;if(a.alertaMarcaciones[r].marcacionesFaltantes.some(function(e){return t+=1,e.fecha.split("T")[0]===a.alertaMarcaciones[r].marcaciones[o].fecha.split("T")[0].split("-").reverse().join("/")})){if(a.alertaMarcaciones[r].marcacionesFaltantes[t].id_comida)(i=a.listaComidasclienteEmpresa.find(function(e){return e.id===a.alertaMarcaciones[r].marcaciones[o].id_comida}))?("desayuno"===i.nombre.toLowerCase()&&(a.alertaMarcaciones[r].marcacionesFaltantes[t].desayuno.cantidad+=1),"almuerzo"===i.nombre.toLowerCase()&&(a.alertaMarcaciones[r].marcacionesFaltantes[t].almuerzo.cantidad+=1),"cena"===i.nombre.toLowerCase()&&(a.alertaMarcaciones[r].marcacionesFaltantes[t].cena.cantidad+=1)):a.alertaMarcaciones[r].marcacionesFaltantes[t].fuera_horario+=1;else a.alertaMarcaciones[r].marcacionesFaltantes[t].fuera_horario+=1}else{var i,n={cantidad:0,id_comida:a.alertaMarcaciones[r].marcaciones[o].id_comida},l={id_comida:a.alertaMarcaciones[r].marcaciones[o].id_comida,fecha:a.alertaMarcaciones[r].marcaciones[o].fecha.split("T")[0].split("-").reverse().join("/"),desayuno:Object.assign({},n),almuerzo:Object.assign({},n),cena:Object.assign({},n),fuera_horario:0,gerencia:{id:a.alertaMarcaciones[r].marcaciones[o].id_gerencia}};(i=a.listaComidasclienteEmpresa.find(function(e){return e.id===a.alertaMarcaciones[r].marcaciones[o].id_comida}))?("desayuno"===i.nombre.toLowerCase()&&(l.desayuno.cantidad+=1),"almuerzo"===i.nombre.toLowerCase()&&(l.almuerzo.cantidad+=1),"cena"===i.nombre.toLowerCase()&&(l.cena.cantidad+=1)):l.fuera_horario+=1,a.alertaMarcaciones[r].marcacionesFaltantes.push(l)}}}var c=[];for(r=0;r<a.alertaMarcaciones.length;r++)for(o=0;o<a.alertaMarcaciones[r].marcacionesFaltantes.length;o++){var m=a.listaComidasclienteEmpresa.find(function(e){return"desayuno"===e.nombre.toLowerCase()}),d=a.listaComidasclienteEmpresa.find(function(e){return"almuerzo"===e.nombre.toLowerCase()}),p=a.listaComidasclienteEmpresa.find(function(e){return"cena"===e.nombre.toLowerCase()});if(0===a.alertaMarcaciones[r].marcacionesFaltantes[o].desayuno.cantidad){var u={comida:m,fecha:a.alertaMarcaciones[r].marcacionesFaltantes[o].fecha,gerencia:a.alertaMarcaciones[r].marcacionesFaltantes[o].gerencia,comensal:{id:a.alertaMarcaciones[r].id,nombre:a.alertaMarcaciones[r].nombre,id_cliente:a.alertaMarcaciones[r].id_cliente,id_empresa:a.alertaMarcaciones[r].id_empresa,tarjeta:a.alertaMarcaciones[r].tarjeta,tipo:a.alertaMarcaciones[r].tipo}};c.push(u)}if(0===a.alertaMarcaciones[r].marcacionesFaltantes[o].almuerzo.cantidad){u={comida:d,fecha:a.alertaMarcaciones[r].marcacionesFaltantes[o].fecha,gerencia:a.alertaMarcaciones[r].marcacionesFaltantes[o].gerencia,comensal:{id:a.alertaMarcaciones[r].id,nombre:a.alertaMarcaciones[r].nombre,id_cliente:a.alertaMarcaciones[r].id_cliente,id_empresa:a.alertaMarcaciones[r].id_empresa,tarjeta:a.alertaMarcaciones[r].tarjeta,tipo:a.alertaMarcaciones[r].tipo}};c.push(u)}if(0===a.alertaMarcaciones[r].marcacionesFaltantes[o].cena.cantidad){u={comida:p,fecha:a.alertaMarcaciones[r].marcacionesFaltantes[o].fecha,gerencia:a.alertaMarcaciones[r].marcacionesFaltantes[o].gerencia,comensal:{id:a.alertaMarcaciones[r].id,nombre:a.alertaMarcaciones[r].nombre,id_cliente:a.alertaMarcaciones[r].id_cliente,id_empresa:a.alertaMarcaciones[r].id_empresa,tarjeta:a.alertaMarcaciones[r].tarjeta,tipo:a.alertaMarcaciones[r].tipo}};c.push(u)}}a.alertaMarcaciones=c,s.stop()}s.stop()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.obtenerPaginador=function(){a.paginator=j(),a.paginator.column="fecha",a.paginator.direccion="asc",a.paginator.callBack=a.obtenerHistoriales},a.filtrarHistorial=function(e,r,o){if(void 0!==o)for(var t in e)0==e[t]&&(e[t]="");else for(var t in e)""!==e[t]&&null!==e[t]||(e[t]=0);if(void 0!==r&&r)return e;a.obtenerHistoriales(!0)},a.subirExcelHistorial=function(e){var r,o,t=e.target.files;if(t)for(o=t[r=0];r!=t.length;++r){var i=new FileReader,n=o.name;i.onload=function(e){var r=e.target.result,o=XLSX.read(r,{type:"binary"}),t=o.SheetNames[0],i=2,s=o.Sheets[t],l=[];do{var c={};c.tarjeta=void 0!=s["A"+i]&&""!=s["A"+i]?s["A"+i].v.toString():null,c.nombre=void 0!=s["B"+i]&&""!=s["B"+i]?s["B"+i].v.toString():null,c.fecha_hora=void 0!=s["C"+i]&&""!=s["C"+i]?s["C"+i].v.toString():null,c.lectora=void 0!=s["D"+i]&&""!=s["D"+i]?s["D"+i].v.toString():null,c.alias=void 0!=s["E"+i]&&""!=s["E"+i]?s["E"+i].v.toString():null,c.documento=n,l.push(c),i++,0}while(void 0!=s["A"+i]);angular.element($("fileUpload-Historial").val(null)).triggerHandler("change"),a.guardarHistorialExcel(l)},i.readAsBinaryString(o)}else s.stop()},a.subirExcelComensales=function(e){var r,o,t=e.target.files;for(o=t[r=0];r!=t.length;++r){var i=new FileReader;o.name;i.onload=function(e){s.start();var r=e.target.result,o=XLSX.read(r,{type:"binary"}),t=o.SheetNames[0],i=2,n=o.Sheets[t],l=[];do{var c={};c.codigo=void 0!=n["A"+i]&&""!=n["A"+i]?n["A"+i].v.toString():null,c.tarjeta=void 0!=n["B"+i]&&""!=n["B"+i]?n["B"+i].v.toString():null,c.nombre=void 0!=n["C"+i]&&""!=n["C"+i]?n["C"+i].v.toString():null,c.empresaCliente=void 0!=n["D"+i]&&""!=n["D"+i]?n["D"+i].v.toString():null,c.gerencia=void 0!=n["E"+i]&&""!=n["E"+i]?n["E"+i].v.toString():null,c.tipo=void 0!=n["F"+i]&&""!=n["F"+i]?n["F"+i].v.toString():null,l.push(c),i++,0}while(void 0!=n["A"+i]);s.stop(),angular.element($("fileUploadComensales").val(null)).triggerHandler("change"),a.guardarComensalesExcel(l)},i.readAsBinaryString(o)}},a.subirExcelEmpresas=function(e){var r,o,t=e.target.files;for(o=t[r=0];r!=t.length;++r){var i=new FileReader;o.name;i.onload=function(e){s.start();var r=e.target.result,o=XLSX.read(r,{type:"binary"}),t=o.SheetNames[0],i=2,n=o.Sheets[t],l=[];do{var c={};c.codigo=void 0!=n["A"+i]&&""!=n["A"+i]?n["A"+i].v.toString():null,c.empresaCliente=void 0!=n["B"+i]&&""!=n["B"+i]?n["B"+i].v.toString():null,c.nombre=void 0!=n["C"+i]&&""!=n["C"+i]?n["C"+i].v.toString():null,l.push(c),i++,0}while(void 0!=n["A"+i]);s.stop(),angular.element($("fileUpload-Empresas").val(null)).triggerHandler("change"),a.guardarEmpresasExcel(l)},i.readAsBinaryString(o)}},a.subirExcelGerencias=function(e){var r,o,t=e.target.files;for(o=t[r=0];r!=t.length;++r){var i=new FileReader;o.name;i.onload=function(e){s.start();var r=e.target.result,o=XLSX.read(r,{type:"binary"}),t=o.SheetNames[0],i=2,n=o.Sheets[t],l=[];do{var c={};c.codigo=void 0!=n["A"+i]&&""!=n["A"+i]?n["A"+i].v.toString():null,c.empresaCliente=void 0!=n["B"+i]&&""!=n["B"+i]?n["B"+i].v.toString():null,c.nombre=void 0!=n["C"+i]&&""!=n["C"+i]?n["C"+i].v.toString():null,c.lectora=void 0!=n["D"+i]&&""!=n["D"+i]?n["D"+i].v.toString():null,l.push(c),i++,0}while(void 0!=n["A"+i]);s.stop(),angular.element($("fileUpload-Gerencias").val(null)).triggerHandler("change"),a.guardarGerenciasExcel(l)},i.readAsBinaryString(o)}},a.subirExcelComidas=function(e){var r,o,t=e.target.files;for(o=t[r=0];r!=t.length;++r){var i=new FileReader;o.name;i.onload=function(e){s.start();var r=e.target.result,o=XLSX.read(r,{type:"binary"}),t=o.SheetNames[0],i=2,n=o.Sheets[t],l=[];do{var c={};c.codigo=void 0!=n["A"+i]&&""!=n["A"+i]?n["A"+i].v.toString():null,c.nombre=void 0!=n["B"+i]&&""!=n["B"+i]?n["B"+i].v.toString():null,c.inicio=void 0!=n["C"+i]&&""!=n["C"+i]?n["C"+i].w.toString():null,c.final=void 0!=n["D"+i]&&""!=n["D"+i]?n["D"+i].w.toString():null,c.empresaCliente=void 0!=n["E"+i]&&""!=n["E"+i]?n["E"+i].v.toString():null,l.push(c),i++,0}while(void 0!=n["A"+i]);s.stop(),angular.element($("fileUpload-Comidas").val("")).triggerHandler("change"),a.guardarComidasExcel(l)},i.readAsBinaryString(o)}},a.subirExcelPrecios=function(e){var r,o,t=e.target.files;for(o=t[r=0];r!=t.length;++r){var i=new FileReader;o.name;i.onload=function(e){s.start();var r=e.target.result,o=XLSX.read(r,{type:"binary"}),t=o.SheetNames[0],i=2,n=o.Sheets[t],l=[];do{var c={};c.codigo=void 0!=n["A"+i]&&""!=n["A"+i]?n["A"+i].v.toString():null,c.nombre=void 0!=n["B"+i]&&""!=n["B"+i]?n["B"+i].v.toString():null,c.empresaCliente=void 0!=n["C"+i]&&""!=n["C"+i]?n["C"+i].v.toString():null,c.precio=void 0!=n["D"+i]&&""!=n["D"+i]?n["D"+i].v.toString():null,l.push(c),i++,0}while(void 0!=n["A"+i]);s.stop(),angular.element($("fileUpload-Precios").val("")).triggerHandler("change"),a.guardarPreciosExcel(l)},i.readAsBinaryString(o)}},a.extraerFechaExcel=function(e){var a=e.split(" ")[e.split(" ").length-1],r=e.split(" ")[0].split("/").reverse();a.indexOf("AM")>0?a=a.split("A")[0].split(":"):a.indexOf("PM")>0&&(a=a.split("P")[0].split(":"),parseInt(a[0])<12&&(a[0]=parseInt(a[0])+12+""));var o=r[0]+"-"+(2==r[2].length?r[2]:"0"+r[2])+"-"+(2==r[1].length?r[1]:"0"+r[1])+"T"+(2==a[0].length?a[0]:"0"+a[0])+":"+(2==a[1].length?a[1]:"0"+a[1])+":"+(2==a[2].length?a[2]:"0"+a[2])+".000Z";new Date(r[0],r[2]-1,r[1],2==a[0].length?a[0]:"0"+a[0],2==a[1].length?a[1]:"0"+a[1],2==a[2].length?a[2]:"0"+a[2]);return o},a.guardarComensalesExcel=function(e){e.length>0?v(a.usuario.id_empresa,e,a.usuario.id).then(function(e){a.obtenerComensales(),e.hasErr?a.mostrarMensaje(e.mensajes):e.mensajes?a.mostrarMensaje(e.mensaje+e.mensajes):a.mostrarMensaje(e.mensaje)}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.guardarPreciosExcel=function(e){e.length>0?w(a.usuario.id_empresa,e,a.usuario.id).then(function(e){a.obtenerPrecioComidas(),e.hasErr?a.mostrarMensaje(e.mensajes):e.mensajes?a.mostrarMensaje(e.mensaje+e.mensajes):a.mostrarMensaje(e.mensaje)}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.guardarHistorialExcel=function(e){var r=[];(e.length>0&&e.forEach(function(e){if(!r.some(function(r){var o=a.extraerFechaExcel(r.fecha_hora),t=a.extraerFechaExcel(e.fecha_hora);r.fecha=a.extraerFechaExcel(r.fecha_hora),r.fecha||console.log(r);var i=(new Date(t)-new Date(o))/1e3;return i<0&&(i*=-1),r.tarjeta===e.tarjeta&&r.nombre===e.nombre&&i<1800})){if(0===r.length)e.fecha=a.extraerFechaExcel(e.fecha_hora);r.push(e)}}),r.length>0)?b(a.usuario.id_empresa,r,a.usuario.id).then(function(e){a.obtenerHistoriales(),e.hasErr?a.mostrarMensaje(e.mensajes):(a.obtenerAliasEmpresa(),e.mensajes?a.mostrarMensaje(e.mensaje+e.mensajes):a.mostrarMensaje(e.mensaje))}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.guardarGerenciasExcel=function(e){e.length>0?x(a.usuario.id_empresa,e,a.usuario.id).then(function(e){a.obtenerGerencias(),e.hasErr?a.mostrarMensaje(e.mensajes):e.mensajes?a.mostrarMensaje(e.mensaje+e.mensajes):a.mostrarMensaje(e.mensaje)}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.guardarEmpresasExcel=function(e){e.length>0?M(a.usuario.id_empresa,e,a.usuario.id).then(function(e){a.obtenerAliasEmpresa(),e.hasErr?a.mostrarMensaje(e.mensajes):e.mensajes?a.mostrarMensaje(e.mensaje+e.mensajes):a.mostrarMensaje(e.mensaje)}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.guardarComidasExcel=function(e){e.length>0?S(a.usuario.id_empresa,e,a.usuario.id).then(function(e){a.obtenerComidas(),e.hasErr?a.mostrarMensaje(e.mensajes):e.mensajes?a.mostrarMensaje(e.mensaje+e.mensajes):a.mostrarMensaje(e.mensaje)}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.guardarAliasClienteEmpresa=function(){var e=[];(a.listaAliasclientesEmpresa.length>0&&a.listaAliasclientesEmpresa.forEach(function(a){(a.nuevo||a.eliminado||a.editado)&&e.push(a)}),e.length>0)?c(a.usuario.id_empresa,e,a.usuario.id).then(function(e){a.mostrarMensaje(e.mensaje),e.hasErr||a.obtenerAliasEmpresa()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.agregarAliasClienteEmpresa=function(e){var r="";if(a.listaAliasclientesEmpresa.some(function(a){return a.codigo?a.codigo===e.codigo?(r+="Código: "+a.codigo+" ya fué asigando. No se puede duplicar.",!0):a.empresaCliente?a.empresaCliente.id===e.empresaCliente.id?(r+="Empresa: "+a.empresaCliente.razon_social+" ya fué asigando. No se puede duplicar.",!0):a.nombre?a.nombre===e.nombre?(r+="Alias: "+a.nombre+" ya fué asigando. No se puede duplicar.",!0):void 0:(r+="Alias: Vacio",!0):(r+="Empresa: Vacio",!0):(r+="Código: Vacio",!0)}))a.mostrarMensaje(r);else{var o=Object.assign({},e);o.nuevo=!0,a.listaAliasclientesEmpresa.push(o)}},a.guardarGerenciasClienteEmpresa=function(e){var r=[];(a.listaGerenciasClienteEmpresa.length>0&&a.listaGerenciasClienteEmpresa.forEach(function(e){(e.nuevo||e.eliminado||e.editado)&&r.push(e)}),r.length>0)?d(a.usuario.id_empresa,r,a.usuario.id).then(function(e){a.mostrarMensaje(e.mensaje),e.hasErr||a.obtenerGerencias()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.agregarGerenciaClienteEmpresa=function(e){var r="";if(a.listaGerenciasClienteEmpresa.some(function(a){return(a.codigo==e.codigo&&a.empresaCliente.id==e.empresaCliente.id&&a.nombre===e.nombre||a.codigo==e.codigo&&a.empresaCliente.id==e.empresaCliente.id||a.empresaCliente.id==e.empresaCliente.id&&a.nombre===e.nombre)&&(r+="Código y/o nombre",!0)}))a.mostrarMensaje(r+" ya fué asigando. No se puede duplicar.");else{var o=Object.assign({},e);o.nuevo=!0,a.listaGerenciasClienteEmpresa.push(o)}},a.guardarComensalesClienteEmpresa=function(){var e=[];(a.listaComensalesclienteEmpresa.length>0&&a.listaComensalesclienteEmpresa.forEach(function(a){(a.nuevo||a.eliminado||a.editado)&&e.push(a)}),e.length>0)?u(a.usuario.id_empresa,e,a.usuario.id).then(function(e){a.mostrarMensaje(e.mensaje),e.hasErr||a.obtenerComensales()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.agregarComensalClienteEmpresa=function(e){var r="";if(a.listaComensalesclienteEmpresa.some(function(a){return a.codigo?a.codigo===e.codigo?(r+="Código: "+a.codigo+" ya fué asigando. No se puede duplicar.",!0):a.empresaCliente?(null!==a.empresaCliente.id&&a.empresaCliente.id,a.nombre?a.nombre===e.nombre&&a.tarjeta===e.tarjeta&&(r+="comensal y tarjeta"+a.nombre+" ya fué asigando. No se puede duplicar.",!0):(r+="comensal: Vacio",!0)):(r+="Empresa: Vacio",!0):(r+="Código: Vacio",!0)}))a.mostrarMensaje(r);else{var o=Object.assign({},e);o.nuevo=!0,a.listaComensalesclienteEmpresa.push(o)}},a.guardarComidasEmpresasCliente=function(){var e=[];(a.listaComidasclienteEmpresa.length>0&&a.listaComidasclienteEmpresa.forEach(function(a){(a.nuevo||a.eliminado||a.editado)&&(a.inicio=new Date(0,0,0,a.inicio.getHours(),a.inicio.getMinutes(),0).toLocaleTimeString("es-ES"),a.final=new Date(0,0,0,a.final.getHours(),a.final.getMinutes(),0).toLocaleTimeString("es-ES"),e.push(a))}),e.length>0)?C(a.usuario.id_empresa,e,a.usuario.id,0).then(function(e){a.mostrarMensaje(e.mensaje),e.hasErr||a.obtenerComidas()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.agregarComidaClienteEmpresa=function(e){var r="";if(a.listaComidasclienteEmpresa.some(function(a){return(a.codigo==e.codigo&&a.empresaCliente.id==e.empresaCliente.id&&a.nombre===e.nombre||a.codigo==e.codigo&&a.empresaCliente.id==e.empresaCliente.id||a.empresaCliente.id==e.empresaCliente.id&&a.nombre===e.nombre)&&(r+="Código y/o nombre",!0)}))a.mostrarMensaje(r+" ya fué asigando. No se puede duplicar.");else{var o=Object.assign({},e);o.nuevo=!0,a.listaComidasclienteEmpresa.push(o)}},a.guardarPreciosComidasEmpresasCliente=function(){var e=[];(a.listaPrecioComidasclienteEmpresa.length>0&&a.listaPrecioComidasclienteEmpresa.forEach(function(a){(a.nuevo||a.eliminado||a.editado)&&e.push(a)}),e.length>0)?h(a.usuario.id_empresa,e,a.usuario.id,0).then(function(e){a.mostrarMensaje(e.mensaje),e.hasErr||a.obtenerPrecioComidas()}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.mostrarMensaje("Sin cambios.")},a.agregarPrecioComida=function(e){var r="";if(a.listaPrecioComidasclienteEmpresa.some(function(a){return(a.codigo==e.codigo&&a.empresaCliente.id==e.empresaCliente.id&&a.comida.id===e.comida.id||a.codigo==e.codigo&&a.empresaCliente.id==e.empresaCliente.id)&&(r+="Código y/o nombre",!0)}))a.mostrarMensaje(r+" ya fué asigando. No se puede duplicar.");else{var o=Object.assign({},e);o.nuevo=!0,o.id_comida=o.comida.id,a.listaPrecioComidasclienteEmpresa.push(o)}},a.agregarMarcacion=function(e,r){1===r?e.habilitado=!0:2===r&&(e.habilitado=!1),z(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id,e).then(function(r){a.mostrarMensaje(r.mensaje),r.hasErr||(e.id=r.marcacion.id,e.fecha=r.marcacion.fecha.split("T")[0].split("-").reverse().join("/"))}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.eliminarAsignacionaliasClienteEmpresa=function(e){a.listaAliasclientesEmpresa[a.listaAliasclientesEmpresa.indexOf(e)].eliminado=!0},a.eliminarAsignaciongerenciaClienteEmpresa=function(e){a.listaGerenciasClienteEmpresa[a.listaGerenciasClienteEmpresa.indexOf(e)].eliminado=!0},a.eliminarAsignacioncomensalClienteEmpresa=function(e){a.listaComensalesclienteEmpresa[a.listaComensalesclienteEmpresa.indexOf(e)].eliminado=!0},a.eliminarAsignacioncomidaClienteEmpresa=function(e){a.listaComidasclienteEmpresa[a.listaComidasclienteEmpresa.indexOf(e)].eliminado=!0},a.eliminarAsignacionprecioComidaClienteEmpresa=function(e){a.listaPrecioComidasclienteEmpresa[a.listaPrecioComidasclienteEmpresa.indexOf(e)].eliminado=!0},a.generarHistorialPDF=function(e){L(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id,e).then(function(r){var o=new PDFDocument({size:"letter",margin:10,compress:!1}),t=o.pipe(blobStream()),i=190,s=0;Math.ceil(.05);a.imagenEmpresa&&o.image(a.imagenEmpresa,40,30,{fit:[100,100]}),o.font("Helvetica-Bold",10),o.text("DOCUMENTO : ",249,97,{width:200}),o.text(e.documento,249,117,{width:200}),o.text("Fecha : "+e.fecha.split("-").reverse().join("/"),249,137,{width:200}),o.font("Helvetica-Bold",8),o.font("Helvetica",8).fill("black"),o.text("Tarjeta",73,177),o.text("Nombre",135,177),o.text("Fecha Hora",299,177),o.text("Lectora",399,177),o.text("Name",494,177),o.rect(70,173,50,20).stroke(),o.rect(70,173,215,20).stroke(),o.rect(285,173,95,20).stroke(),o.rect(380,173,90,20).stroke(),o.rect(470,173,100,20).stroke();for(var n=0;n<r.documento.length;n++)o.font("Helvetica",8),o.font("Helvetica",8).fill("black"),o.text(r.documento[n].tarjeta,73,i+7),o.text(r.documento[n].comensal.nombre,125,i+7),o.text(r.documento[n].fecha.split("T")[0].split("-").reverse().join("/")+" "+r.documento[n].fecha.split("T")[1].split(".")[0],294,i+7),o.font("Helvetica",6),o.text(r.documento[n].identificador_equipo,382,i+7,{width:85}),o.font("Helvetica",7),o.text(r.documento[n].empresaCliente.alias[0].nombre,474,i+7),o.font("Helvetica",8),o.rect(70,i+3,50,20).stroke(),o.rect(70,i+3,215,20).stroke(),o.rect(285,i+3,95,20).stroke(),o.rect(380,i+3,90,20).stroke(),o.rect(470,i+3,100,20).stroke(),i+=20,(++s>20||i>700)&&(o.addPage({size:[612,792],margin:10}),i=190,s=0,1,a.imagenEmpresa&&o.image(a.imagenEmpresa,40,30,{fit:[100,100]}),o.font("Helvetica-Bold",10),o.text(e.documento+" "+e.fecha,249,117,{width:200}),o.font("Helvetica-Bold",8),o.font("Helvetica",8).fill("black"),o.text("Tarjeta",73,177),o.text("Nombre",135,177),o.text("Fecha Hora",299,177),o.text("Lectora",399,177),o.text("Name",494,177),o.rect(70,173,50,20).stroke(),o.rect(70,173,215,20).stroke(),o.rect(285,173,95,20).stroke(),o.rect(380,173,90,20).stroke(),o.rect(470,173,100,20).stroke());i+=20,o.end(),t.on("finish",function(){var e=t.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.generarHistorialExcel=function(e){L(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id,e).then(function(e){if(e.hasErr)a.mostrarMensaje(e.mensaje);else{for(var r=[["TARJETA","EMPLEADO","FECHA / HORA","lectora","NAME"]],o=0;o<e.documento.length;o++){var t=[];t.push(e.documento[o].tarjeta),t.push(e.documento[o].comensal.nombre),t.push(e.documento[o].fecha.split("T")[0].split("-").reverse().join("/")+" "+e.documento[o].fecha.split("T")[1].split(".")[0]),t.push(e.documento[o].identificador_equipo),t.push(e.documento[o].empresaCliente.alias[0].nombre),r.push(t)}var i="SheetJS",s=new Workbook,n=sheet_from_array_of_arrays(r);n["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],n["!rows"]=[{hpx:28,level:3}],s.SheetNames.push(i),s.Sheets[i]=n;var l=XLSX.write(s,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(l)],{type:"application/octet-stream"}),e.documento[0].documento)}}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.generarReportePDF=function(){a.filtroComensales.generar?1===a.filtroComensales.generar?a.reportePDFComedor():2===a.filtroComensales.generar?a.reportePDFEmpresa():3===a.filtroComensales.generar?a.reportePDFComensal():a.mostrarMensaje("Existe un problema con la identificación del reporte."):a.mostrarMensaje("Seleccione un tipo de reporte.")},a.generarReporteEXCEL=function(){a.filtroComensales.generar?1===a.filtroComensales.generar?a.reportePDFComedor(!0):2===a.filtroComensales.generar?a.reportePDFEmpresa(!0):3===a.filtroComensales.generar?a.reportePDFComensal(!0):a.mostrarMensaje("Existe un problema con la identificación del reporte."):a.mostrarMensaje("Seleccione un tipo de reporte.")},a.reportePDFComedor=function(e){var r=0;P(new Date).then(function(o){r=o.monedaCambio.dolar,a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0),a.paginator.filter=a.filtroComensales,p(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(o){a.listaGerenciasClienteEmpresa=o.lista,g(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(o){var t=o.lista,i=[];0!==t.length?(t.forEach(function(e){i.push(e.nombre.toUpperCase())}),i.unshift("fecha".toUpperCase()),i.push("observación".toUpperCase()),_(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id,a.paginator).then(function(o){if(a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0,!0),o.hasErr)a.mostrarMensaje(o.mensaje);else{for(var n=[],l=0;l<o.reporte.length;l++){var c=[];if(o.reporte[l].historial.length>0)for(var m=0;m<o.reporte[l].historial.length;m++){var d=-1;if(c.some(function(e){return d+=1,e.gerencia.nombre===o.reporte[l].nombre&&e.fecha.split("T")[0]===o.reporte[l].historial[m].fecha.split("T")[0]}))o.reporte[l].historial[m].comida?("desayuno"===o.reporte[l].historial[m].comida.nombre.toLowerCase()&&(c[d].desayuno.cantidad+=1,c[d].desayuno.total+=o.reporte[l].historial[m].precio),"almuerzo"===o.reporte[l].historial[m].comida.nombre.toLowerCase()&&(c[d].almuerzo.cantidad+=1,c[d].almuerzo.total+=o.reporte[l].historial[m].precio),"cena"===o.reporte[l].historial[m].comida.nombre.toLowerCase()&&(c[d].cena.cantidad+=1,c[d].cena.total+=o.reporte[l].historial[m].precio)):c[d].fuera_horario+=1;else{var p={cantidad:0,total:0},u={empresaCliente:o.reporte[l].historial[m].empresaCliente,gerencia:{id:o.reporte[l].id,nombre:o.reporte[l].nombre,codigo:o.reporte[l].codigo,id_cliente:o.reporte[l].id_cliente,id_empresa:o.reporte[l].id_empresa},fecha:o.reporte[l].historial[m].fecha.split("T")[0],desayuno:Object.assign({},p),almuerzo:Object.assign({},p),cena:Object.assign({},p),fuera_horario:0};o.reporte[l].historial[m].comida?("desayuno"===o.reporte[l].historial[m].comida.nombre.toLowerCase()&&(u.desayuno.cantidad+=1,u.desayuno.total+=o.reporte[l].historial[m].precio),"almuerzo"===o.reporte[l].historial[m].comida.nombre.toLowerCase()&&(u.almuerzo.cantidad+=1,u.almuerzo.total+=o.reporte[l].historial[m].precio),"cena"===o.reporte[l].historial[m].comida.nombre.toLowerCase()&&(u.cena.cantidad+=1,u.cena.total+=o.reporte[l].historial[m].precio)):u.observacion="Fuera de horario, no se puede contabilizar.",c.push(u)}m===o.reporte[l].historial.length-1&&n.push(c)}}if(e)for(m=0;m<n.length;m++){var f=n[m];a.imprimirReporteComedorExcel(f,f[0].gerencia,i,t,r,o.periodo)}else for(m=0;m<n.length;m++)a.imprimirReporteComedor(n[m],n[m][0].gerencia,i,t,r,o.periodo);s.stop()}})):a.mostrarMensaje("El listado de comidas para esta empresa esta vacio, no se puede generar el reporte")})})}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.reportePDFEmpresa=function(e){var r=0;P(new Date).then(function(o){r=o.monedaCambio.dolar,a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0),a.paginator.filter=a.filtroComensales,p(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(o){a.listaGerenciasClienteEmpresa=o.lista,g(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(o){var t=o.lista,i=[];t.forEach(function(e){i.push(e.nombre.toUpperCase())}),i.unshift("Empleado".toUpperCase()),i.push("Total general".toUpperCase()),D(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id,a.paginator).then(function(o){if(a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0,!0),o.hasErr)a.mostrarMensaje(o.mensaje);else{o.reporte.forEach(function(e){e.desayuno={cantidad:0,total:0},e.almuerzo={cantidad:0,total:0},e.cena={cantidad:0,total:0},e.fueraHorario=0,e.historial.forEach(function(a){a.comida?("desayuno"===a.comida.nombre.toLowerCase()&&(e.desayuno.cantidad+=1),"almuerzo"===a.comida.nombre.toLowerCase()&&(e.almuerzo.cantidad+=1),"cena"===a.comida.nombre.toLowerCase()&&(e.cena.cantidad+=1)):e.fueraHorario+=1})}),e?a.imprimirReporteEmpresaEXCEL(o.reporte,o.gerencia,i,t,r,o.periodo):a.imprimirReporteEmpresa(o.reporte,o.gerencia,i,t,r,o.periodo),s.stop()}})})})}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.reportePDFAlertasMarcaciones=function(e,r){r?g(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(r){var o=r.lista,t=[];if(o.forEach(function(e){t.push(e.nombre.toUpperCase())}),t.unshift("empleado".toUpperCase()),t.unshift("empresa".toUpperCase()),t.push("Total general".toUpperCase()),a.alertaMarcaciones.length>0){a.alertaMarcaciones.reverse();for(var i=[],s=[];a.alertaMarcaciones.length>0;){var n=-1,l=a.alertaMarcaciones.pop();if(s.some(function(e){return n+=1,e.fecha===l.fecha}))s[n].alertas.push(l),i.push(l);else{i.push(l);var c={fecha:l.fecha,alertas:[l]};s.push(c)}1}a.alertaMarcaciones=i,e?a.imprimirAlertaMarcacionesMatriz(s,null,t,o):a.imprimirAlertaMarcaciones(s,null,t,o)}}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.stack&&null!==e.stack?e.stack:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()}):a.alertaMarcaciones.length>0&&(e?a.imprimirAlertaMarcacionesMatriz(a.alertaMarcaciones):a.imprimirAlertaMarcacionesLista(a.alertaMarcaciones))},a.reportePDFComensal=function(e){var r=0;P(new Date).then(function(o){r=o.monedaCambio.dolar,a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0),a.paginator.filter=a.filtroComensales,p(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(o){a.listaGerenciasClienteEmpresa=o.lista,g(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id).then(function(o){var t=o.lista,i=[];t.forEach(function(e){i.push(e.nombre.toUpperCase())}),i.unshift("FECHA".toUpperCase()),i.push("Total general".toUpperCase()),y(a.usuario.id_empresa,a.usuario.id,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.id?a.filtroComensales.empresaCliente.id:a.empresaExternaSeleccionada.id,a.paginator).then(function(o){if(a.filtroComensales=a.filtrarHistorial(a.filtroComensales,!0,!0),o.hasErr)a.mostrarMensaje(o.mensaje);else{for(var n=0;n<o.reporte.length;n++){for(var l=[],c=0;c<o.reporte[n].historial.length;c++){var m=-1;if(l.some(function(e){return m+=1,e.fecha.split("T")[0]===o.reporte[n].historial[c].fecha.split("T")[0]}))o.reporte[n].historial[c].comida?("desayuno"===o.reporte[n].historial[c].comida.nombre.toLowerCase()&&(l[m].desayuno+=1),"almuerzo"===o.reporte[n].historial[c].comida.nombre.toLowerCase()&&(l[m].almuerzo+=1),"cena"===o.reporte[n].historial[c].comida.nombre.toLowerCase()&&(l[m].cena+=1)):l[m].fueraHorario+=1;else{var d={fecha:o.reporte[n].historial[c].fecha,desayuno:0,almuerzo:0,cena:0,fueraHorario:0,empresaCliente:o.reporte[n].historial[c].empresaCliente};o.reporte[n].historial[c].comida?("desayuno"===o.reporte[n].historial[c].comida.nombre.toLowerCase()&&(d.desayuno+=1),"almuerzo"===o.reporte[n].historial[c].comida.nombre.toLowerCase()&&(d.almuerzo+=1),"cena"===o.reporte[n].historial[c].comida.nombre.toLowerCase()&&(d.cena+=1)):d.observacion="Fuera de horario, no se puede contabilizar.",l.push(d)}}o.reporte[n].reporte=l}for(c=0;c<o.reporte.length;c++)e?a.imprimirReporteComensalEXCEL(o.reporte[c],null,i,t,r,o.periodo):a.imprimirReporteComensal(o.reporte[c],null,i,t,r,o.periodo);s.stop()}})})})}).catch(function(e){var r=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";a.mostrarMensaje(r),s.stop()})},a.imprimirAlertaMarcacionesLista=function(e){var r=new PDFDocument({size:"letter",margin:10,compress:!1}),o=r.pipe(blobStream()),t=135,i=0,s=1,n=e[0].fecha+" al "+e[e.length-1].fecha,l=Math.ceil(e.length/10);a.cabeceraReporteAlertasMarcacionesLista(r,a.usuario.empresa.razon_social,n,s,l);for(var c=0;c<e.length;c++)r.text(c+1,70,t+5),r.text(e[c].comensal.nombre,120,t+5),r.text(e[c].fecha,320,t+5),r.text(e[c].comida.nombre,400,t+5),r.text(!0===e[c].habilitado?"Marcado":!1===e[c].habilitado?"Descartado":"Pendiente",500,t+5),r.rect(60,t,500,20).stroke(),t+=20,(i>10||t>700)&&(r.addPage({size:[612,792],margin:10}),t=195,i=0,s+=1,a.cabeceraReporteAlertasMarcacionesMatriz(r,a.usuario.empresa.razon_social,n,s,l));t+=20,r.end(),o.on("finish",function(){var e=o.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},a.imprimirAlertaMarcacionesMatriz=function(e,r,o,t){if(e.length>0){var i=new PDFDocument({size:"letter",margin:10,compress:!1}),s=i.pipe(blobStream()),n=150,l=0,c=1,m=Math.ceil(.1);a.Marcaciones.length,a.cabeceraReporteAlertasMarcacionesMatriz(i,c,m,o,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.razon_social?a.filtroComensales.empresaCliente.razon_social:a.empresaExternaSeleccionada.razon_social,r?r.nombre.toUpperCase():"Sin asignación.".toUpperCase());for(var d=0;d<e.length;d++)for(var p=0;p<e[d].alertas.length;p++)i.font("Helvetica",8),i.font("Helvetica",6).fill("black"),i.text(e[d].alertas[p].comida.empresaCliente.razon_social,50,n+7),i.text(e[d].alertas[p].comensal.nombre,90,n+7),"desayuno"===e[d].alertas[p].comida.nombre.toLowerCase()&&(i.font("Helvetica",8).fill("red"),i.text(e[d].alertas[p].comida.nombre,239,n+7).fill("black"),i.rect(380,n+3,80,20).stroke("red")),"almuerzo"===e[d].alertas[p].comida.nombre.toLowerCase()&&(i.font("Helvetica",8).fill("black"),i.text("Falta2",334,n+7).fill("black"),i.rect(300,n+3,80,20).stroke("black")),"cena"===e[d].alertas[p].comida.nombre.toLowerCase()&&(i.font("Helvetica",8).fill("black"),i.text("Falta3",414,n+7).fill("black")),i.text(e[d].alertas[p].comida.nombre,419,n+7),i.rect(50,n+3,170,20).stroke(),i.rect(220,n+3,80,20).stroke(),i.rect(300,n+3,80,20).stroke(),i.rect(380,n+3,80,20).stroke(),i.rect(460,n+3,110,20).stroke(),i.rect(50,n+3,80,20).stroke(),i.rect(130,n+3,90,20).stroke(),n+=20,(++l>10||n>700)&&(i.addPage({size:[612,792],margin:10}),n=195,l=0,c+=1,a.cabeceraReporteAlertasMarcacionesMatriz(i,c,m,o,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.razon_social?a.filtroComensales.empresaCliente.razon_social:a.empresaExternaSeleccionada.razon_social,r?r.nombre.toUpperCase():"Sin asignación.".toUpperCase()));i.text("Total general",56,n+7),i.rect(50,n+3,170,20).stroke(),i.rect(220,n+3,80,20).stroke(),i.rect(300,n+3,80,20).stroke(),i.rect(380,n+3,80,20).stroke(),i.rect(460,n+3,110,20).stroke(),n+=20,i.end(),s.on("finish",function(){var e=s.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})}else a.mostrarMensaje("No hay datos.")},a.imprimirReporteComedorExcel=function(e,a,r,o,t,i){e=e,r=r,t=t;for(var n=[[""],[""],["REPORTES DE COMEDOR "+(a=a).nombre.toUpperCase()+" "+e[0].empresaCliente.razon_social.toUpperCase()],[""],r],l=0,c=0,m=0,d=0;d<e.length;d++){(p=[]).push(e[d].fecha),e[d].desayuno.cantidad>0?(p.push(e[d].desayuno.cantidad),l+=e[d].desayuno.cantidad):p.push(""),e[d].almuerzo.cantidad>0?(p.push(e[d].almuerzo.cantidad),c+=e[d].almuerzo.cantidad):p.push(""),e[d].cena.cantidad>0?(p.push(e[d].cena.cantidad),m+=e[d].cena.cantidad):p.push(""),e[d].observacion&&p.push(e[d].observacion),n.push(p)}n.push([""]);var p=["TOTAL ==>",l,c,m];n.push(p),p=["TOTAL $us. ==>",l*t,c*t,m*t],n.push(p),p=["TOTAL General $us. ==>","",l*t+c*t+m*t],n.push(p);var u="SheetJS",f=new Workbook,C=sheet_from_array_of_arrays(n);C["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],C["!rows"]=[{hpx:28,level:3}],C["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+n.length,c:0},e:{r:3+n.length,c:1}}],f.SheetNames.push(u),f.Sheets[u]=C;var g=XLSX.write(f,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(g)],{type:"application/octet-stream"}),"REPORTE GERENCIA "+a.nombre.toUpperCase()+".xlsx"),s.stop()},a.imprimirReporteEmpresaEXCEL=function(e,a,r,o,t){r=r;for(var i=[["Reporte EMPRESA VS PERIODO"],["EMPRESA",(e=e)[0].historial[0].empresaCliente.razon_social],["GERENCIA",""],["PERIODO",e.fecha],r],n=0,l=0,c=0,m=0;m<e.length;m++){var d;n+=e[m].desayuno.cantidad,l+=e[m].almuerzo.cantidad,c+=e[m].cena.cantidad,d=e[m].desayuno.cantidad+e[m].almuerzo.cantidad+e[m].cena.cantidad,e[m].desayuno.cantidad,e[m].almuerzo.cantidad,e[m].cena.cantidad,(p=[]).push(e[m].nombre),p.push(e[m].desayuno.cantidad),p.push(e[m].almuerzo.cantidad),p.push(e[m].cena.cantidad),d,p.push(d),i.push(p)}var p=["TOTAL General",n,l,c,n+l+c];i.push(p);var u="SheetJS",f=new Workbook,C=sheet_from_array_of_arrays(i);C["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],C["!rows"]=[{hpx:28,level:3}],C["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+i.length,c:0},e:{r:3+i.length,c:1}}],f.SheetNames.push(u),f.Sheets[u]=C;var g=XLSX.write(f,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(g)],{type:"application/octet-stream"}),"REPORTE EMPRESA "+e[0].historial[0].empresaCliente.razon_social.toUpperCase()+".xlsx"),s.stop()},a.imprimirReporteComensalEXCEL=function(e,a,r,o,t,i){r=r;for(var n=[["REPORTE POR PERSONA"],["EMPLEADO",(e=e).nombre],["EMPRESA",e.reporte[0].empresaCliente.razon_social],["GERENCIA",""],["PERIODO",e.fecha],r],l=0,c=0,m=0,d=0;d<e.reporte.length;d++){var p;l+=e.reporte[d].desayuno,c+=e.reporte[d].almuerzo,m+=e.reporte[d].cena,p=e.reporte[d].desayuno+e.reporte[d].almuerzo+e.reporte[d].cena,e.reporte[d].desayuno,e.reporte[d].almuerzo,e.reporte[d].cena,(u=[]).push(e.reporte[d].fecha.split("T")[0]),u.push(e.reporte[d].desayuno),u.push(e.reporte[d].almuerzo),u.push(e.reporte[d].cena),u.push(p),n.push(u)}var u=["TOTAL General",l,c,m,l+c+m];n.push(u);var f="SheetJS",C=new Workbook,g=sheet_from_array_of_arrays(n);g["!cols"]=[{wch:20},{wch:19},{wch:20},{wch:16},{wch:25},{wch:15},{wch:25},{wch:25},{wch:25},{wch:8},{wch:12}],g["!rows"]=[{hpx:28,level:3}],g["!merges"]=[{s:{r:0,c:0},e:{r:0,c:4}},{s:{r:1,c:4},e:{r:1,c:4}},{s:{r:3,c:4},e:{r:3,c:4}},{s:{r:3+n.length,c:0},e:{r:3+n.length,c:1}}],C.SheetNames.push(f),C.Sheets[f]=g;var h=XLSX.write(C,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(h)],{type:"application/octet-stream"}),"REPORTE COMENSAL "+e.nombre.toUpperCase()+".xlsx"),s.stop()},a.imprimirReporteComedor=function(e,r,o,t,i,s){var n,l,c=new PDFDocument({size:"letter",margin:10,compress:!1}),m=c.pipe(blobStream()),d=170;s[0]&&(n=s[0].split("T")[0]),s[1]&&(l=s[1].split("T")[0]);var p=0,u=0,f=1,C=100,g=Math.ceil(.05);a.cabeceraReporteComedor(e,c,f,g,o,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.razon_social?a.filtroComensales.empresaCliente.razon_social:a.empresaExternaSeleccionada.razon_social,r?r.nombre.toUpperCase():"Sin asignación.".toUpperCase(),n,l);for(var h=0,E=0,b=0,v=0;v<e.length;v++)o.forEach(function(e){c.rect(C+u,d,80,20).stroke(),u+=80}),u=0,c.font("Helvetica",8),e[v].desayuno.cantidad>0&&(c.text(e[v].fecha,109,d+7),c.text(e[v].desayuno.cantidad,204,d+7),h+=e[v].desayuno.cantidad),e[v].almuerzo.cantidad>0&&(c.text(e[v].fecha,109,d+7),c.text(e[v].almuerzo.cantidad,284,d+7),E+=e[v].almuerzo.cantidad),e[v].cena.cantidad>0&&(c.text(e[v].fecha,109,d+7),c.text(e[v].cena.cantidad,364,d+7),b+=e[v].cena.cantidad),e[v].observacion&&(c.text(e[v].fecha,109,d+7),c.text(e[v].observacion,421,d+3,{width:80})),d+=20,(++p>20||d>700)&&(c.addPage({size:[612,792],margin:10}),d=170,p=0,f+=1,a.cabeceraReporteComedor(e,c,f,g,o,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.razon_social?a.filtroComensales.empresaCliente.razon_social:a.empresaExternaSeleccionada.razon_social,e[v].gerencia?e[v].gerencia.nombre.toUpperCase():"Sin asignación.".toUpperCase(),n,l));c.rect(C,d,80,20).stroke(),c.rect(180,d,80,20).stroke(),c.rect(260,d,80,20).stroke(),c.rect(340,d,80,20).stroke(),c.rect(420,d,80,20).stroke(),d+=20;var k=h*("desayuno"===t[0].nombre.toLowerCase()?t[0].precio[0].precio:"desayuno"===t[1].nombre.toLowerCase()?t[1].precio[0].precio:"desayuno"===t[2].nombre.toLowerCase()?t[2].precio[0].precio:"ERROR"),M=E*("almuerzo"===t[0].nombre.toLowerCase()?t[0].precio[0].precio:"almuerzo"===t[1].nombre.toLowerCase()?t[1].precio[0].precio:"almuerzo"===t[2].nombre.toLowerCase()?t[2].precio[0].precio:"ERROR"),x=b*("cena"===t[0].nombre.toLowerCase()?t[0].precio[0].precio:"cena"===t[1].nombre.toLowerCase()?t[1].precio[0].precio:"cena"===t[2].nombre.toLowerCase()?t[2].precio[0].precio:"ERROR");c.text("Total.-",124,d+7),c.text("Total $us.-",124,d+7+20),c.text("Total General $us.-",124,d+7+40),c.rect(180,d,80,20).stroke(),c.text(h,204,d+7),c.rect(260,d,80,20).stroke(),c.text(E,284,d+7),c.rect(340,d,80,20).stroke(),c.text(b,364,d+7),c.rect(180,d+20,80,20).stroke(),c.rect(260,d+20,80,20).stroke(),c.rect(340,d+20,80,20).stroke(),c.rect(260,d+40,80,20).stroke(),c.text(a.number_format(k,2),204,d+7+20),c.text(a.number_format(M,2),284,d+7+20),c.text(a.number_format(x,2),364,d+7+20),c.text(a.number_format(k+M+x,2),284,d+7+40),c.rect(C,d+70,80,20).fill("yellow"),c.rect(C,d+90,80,20).fill("yellow"),c.rect(C,d+110,80,20).fill("yellow"),c.rect(180,d+70,80,20).fill("yellow"),c.rect(180,d+90,80,20).fill("yellow"),c.rect(180,d+110,80,20).fill("yellow"),c.rect(340,d+90,160,20).fill("yellow"),c.rect(C,d+70,80,20).stroke(),c.rect(C,d+90,80,20).stroke(),c.rect(C,d+110,80,20).stroke(),c.rect(180,d+70,80,20).stroke(),c.rect(180,d+90,80,20).stroke(),c.rect(180,d+110,80,20).stroke().fill("black"),c.text("Desayuno.-",124,d+7+70),c.text("almuerzo.-",124,d+7+90),c.text("Cena.-",124,d+7+110),c.rect(340,d+90,160,20).stroke(),c.text("T.C. "+i+"       Bs "+a.number_format((k+M+x)*i,2),364,d+7+90),c.text("desayuno"===t[0].nombre.toLowerCase()?a.number_format(t[0].precio[0].precio,2):"desayuno"===t[1].nombre.toLowerCase()?a.number_format(t[1].precio[0].precio,2):"desayuno"===t[2].nombre.toLowerCase()?a.number_format(t[2].precio[0].precio,2):"ERROR",204,d+7+70),c.text("almuerzo"===t[0].nombre.toLowerCase()?a.number_format(t[0].precio[0].precio,2):"almuerzo"===t[1].nombre.toLowerCase()?a.number_format(t[1].precio[0].precio,2):"almuerzo"===t[2].nombre.toLowerCase()?a.number_format(t[2].precio[0].precio,2):"ERROR",204,d+7+90),c.text("cena"===t[0].nombre.toLowerCase()?a.number_format(t[0].precio[0].precio,2):"cena"===t[1].nombre.toLowerCase()?a.number_format(t[1].precio[0].precio,2):"cena"===t[2].nombre.toLowerCase()?a.number_format(t[2].precio[0].precio,2):"ERROR",204,d+7+110);var S=ConvertirALiteral((k+M+x).toFixed(2));S=S.split("BOLIVIANOS")[0],c.text("Son: "+S+" Dólares Americanos",124,d+7+130),c.end(),m.on("finish",function(){var e=m.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},a.imprimirReporteEmpresa=function(e,r,o,t,i,s){var n,l,c=new PDFDocument({size:"letter",margin:10,compress:!1}),m=c.pipe(blobStream()),d=190,p=0;s[0]&&(n=s[0].split("T")[0]),s[1]&&(l=s[1].split("T")[0]);var u=1,f=Math.ceil(.05);a.cabeceraReporteEmpresa(e,c,u,f,o,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.razon_social?a.filtroComensales.empresaCliente.razon_social:a.empresaExternaSeleccionada.razon_social,r?r.nombre.toUpperCase():"Sin asignación.".toUpperCase(),n,l);for(var C=0,g=0,h=0,E=0,b=0;b<e.length;b++){var v;c.font("Helvetica",8),C+=e[b].desayuno.cantidad,g+=e[b].almuerzo.cantidad,h+=e[b].cena.cantidad,v=e[b].desayuno.cantidad+e[b].almuerzo.cantidad+e[b].cena.cantidad,e[b].desayuno.cantidad,e[b].almuerzo.cantidad,e[b].cena.cantidad,0,c.font("Helvetica",8).fill("black"),c.text(e[b].nombre,73,d+7),c.text(e[b].desayuno.cantidad,254,d+7),c.text(e[b].almuerzo.cantidad,334,d+7),c.text(e[b].cena.cantidad,414,d+7),c.text(v,494,d+7),E+=e[b].fueraHorario,c.rect(70,d+3,150,20).stroke(),c.rect(220,d+3,80,20).stroke(),c.rect(300,d+3,80,20).stroke(),c.rect(380,d+3,80,20).stroke(),c.rect(460,d+3,110,20).stroke(),d+=20,(++p>20||d>700)&&(c.addPage({size:[612,792],margin:10}),d=190,p=0,u+=1,a.cabeceraReporteEmpresa(e,c,u,f,o,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.razon_social?a.filtroComensales.empresaCliente.razon_social:a.empresaExternaSeleccionada.razon_social,r?r.nombre.toUpperCase():"Sin asignación.".toUpperCase(),n,l))}c.text("Total general",76,d+7),c.text(C,254,d+7),c.text(g,334,d+7),c.text(h,414,d+7),c.text(C+g+h,494,d+7),c.rect(70,d+3,150,20).stroke(),c.rect(220,d+3,80,20).stroke(),c.rect(300,d+3,80,20).stroke(),c.rect(380,d+3,80,20).stroke(),c.rect(460,d+3,110,20).stroke(),E>0&&(c.text("No contabilizados (fuera de horario):",470,d+7+20),c.text("Cant.: "+E,497,d+7+40)),d+=20,c.end(),m.on("finish",function(){var e=m.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},a.formatoFechaPDF=function(e){var a=new Date(e);return a.setDate(a.getDate()),("0"+a.getDate()).slice(-2)+"/"+("0"+(a.getMonth()+1)).slice(-2)+"/"+a.getFullYear()},a.imprimirReporteComensal=function(e,r,o,t,i,s){var n,l,c=new PDFDocument({size:"letter",margin:10,compress:!1}),m=c.pipe(blobStream()),d=190,p=0,u=1;s[0]&&(n=s[0].split("T")[0]),s[1]&&(l=s[1].split("T")[0]);var f=Math.ceil(.1);a.cabeceraReporteComensal(e.reporte,c,u,f,e,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.razon_social?a.filtroComensales.empresaCliente.razon_social:a.empresaExternaSeleccionada.razon_social,r?r.nombre.toUpperCase():"Sin asignación.".toUpperCase(),n,l);for(var C=0,g=0,h=0,E=0;E<e.reporte.length;E++){e.reporte[E].cena>0&&(c.font("Helvetica",8).fill("black"),c.text(e.reporte[E].cena,254,d+7).fill("black"),c.rect(380,d+3,80,20).stroke("black")),e.reporte[E].almuerzo>0&&(c.font("Helvetica",8).fill("black"),c.text(e.reporte[E].almuerzo,334,d+7).fill("black"),c.rect(300,d+3,80,20).stroke("black")),e.reporte[E].desayuno>0&&(c.font("Helvetica",8).fill("black"),c.text(e.reporte[E].desayuno,414,d+7).fill("black"),c.rect(220,d+3,80,20).stroke("black"));var b;c.font("Helvetica",8).fill("black"),C+=e.reporte[E].desayuno,g+=e.reporte[E].almuerzo,h+=e.reporte[E].cena,b=e.reporte[E].desayuno+e.reporte[E].almuerzo+e.reporte[E].cena,e.reporte[E].desayuno,e.reporte[E].almuerzo,e.reporte[E].cena,0,c.font("Helvetica",8).fill("black"),c.rect(70,d+3,150,20).stroke("black"),c.rect(460,d+3,110,20).stroke("black"),c.text(a.formatoFechaPDF(e.reporte[E].fecha),78,d+7).fill("black"),c.text(b,494,d+7).fill("black"),0===e.reporte[E].cena&&(c.font("Helvetica",8).fill("red"),c.text("Falta",254,d+7).fill("red"),c.rect(380,d+3,80,20).stroke("red")),0===e.reporte[E].almuerzo&&(c.font("Helvetica",8).fill("red"),c.text("Falta",334,d+7).fill("red"),c.rect(300,d+3,80,20).stroke("red")),0===e.reporte[E].desayuno&&(c.font("Helvetica",8).fill("red"),c.text("Falta",414,d+7).fill("red"),c.rect(220,d+3,80,20).stroke("red")),d+=20,(++p>10||d>700)&&(c.addPage({size:[612,792],margin:10}),d=190,p=0,u+=1,a.cabeceraReporteComensal(e.reporte,c,u,f,e,a.filtroComensales.empresaCliente&&a.filtroComensales.empresaCliente.razon_social?a.filtroComensales.empresaCliente.razon_social:a.empresaExternaSeleccionada.razon_social,r?r.nombre.toUpperCase():"Sin asignación.".toUpperCase(),n,l))}c.font("Helvetica",8).fill("black"),c.text("Total general".toLocaleUpperCase(),76,d+7).fill("black"),c.text(C,254,d+7).fill("black"),c.text(g,334,d+7).fill("black"),c.text(h,414,d+7).fill("black"),c.text(C+g+h,494,d+7).fill("black"),c.rect(70,d+3,150,20).stroke("black"),c.rect(220,d+3,80,20).stroke("black"),c.rect(300,d+3,80,20).stroke("black"),c.rect(380,d+3,80,20).stroke("black"),c.rect(460,d+3,110,20).stroke("black"),d+=20,c.end(),m.on("finish",function(){var e=m.toBlobURL("application/pdf");window.open(e,"_blank","location=no")})},a.cabeceraReporteComedor=function(e,r,o,t,i,s,n,l,c){var m=0,d=((new Date).getDate(),(new Date).getMonth(),(new Date).getFullYear(),new Date(l)),p=new Date(c),u=Math.floor(Math.abs(p-d)/36e5),f=(new Date,new Date(e[0].fecha)),C=new Date(e[e.length-1].fecha);r.font("Helvetica-Bold",12).fill("black"),r.text("REPORTES DE COMEDOR "+n.toUpperCase()+" "+s.toUpperCase(),150,80,{width:300,align:"center"}),l&&c?r.text("PERIODO "+(u<745?a.meses[d.getMonth()+1].nombre.toUpperCase()+"/"+d.getFullYear():a.meses[d.getMonth()+1].nombre.toUpperCase()+"/"+d.getFullYear()+" A "+a.meses[p.getMonth()].nombre.toUpperCase()+"/"+p.getFullYear()),150,120,{width:300,align:"center"}):!l&&c?r.text("PERIODO "+a.meses[f.getMonth()].nombre.toUpperCase()+"/"+p.getFullYear(),150,120,{width:300,align:"center"}):r.text("PERIODO "+a.meses[f.getMonth()].nombre.toUpperCase()+"/"+f.getFullYear()+" A "+a.meses[C.getMonth()].nombre.toUpperCase()+"/"+C.getFullYear(),150,120,{width:300,align:"center"}),r.font("Helvetica-Bold",8),i.forEach(function(e){r.rect(100+m,150,80,20).stroke(),r.text(e,100+m+9,157),m+=80}),r.rect(230,650,130,0).stroke(),r.text("Encargado",272,660),r.font("Helvetica",8),a.imagenEmpresa&&r.image(a.imagenEmpresa,40,30,{fit:[100,100]})},a.cabeceraReporteAlertasMarcacionesLista=function(e,r,o,t,i){e.font("Helvetica",6).fill("black"),e.text("Pag. "+t+" de "+i,560,40),e.font("Helvetica-Bold",12).fill("black"),e.text(r.toLocaleUpperCase(),260,60),e.font("Helvetica-Bold",8),e.text("Cochambamba - Bolivia",255,80),e.font("Helvetica-Bold",8),e.text("Del "+o,255,100),e.text("Nro.",70,120),e.text("comensal",120,120),e.text("fecha",320,120),e.text("Comida",400,120),e.text("Estado",500,120),e.rect(60,115,500,20).stroke(),a.imagenEmpresa&&e.image(a.imagenEmpresa,40,30,{fit:[100,100]})},a.cabeceraReporteAlertasMarcacionesMatriz=function(e,r,o,t,r,i){e.font("Helvetica-Bold",12).fill("black"),e.font("Helvetica-Bold",8),e.text("Alerta no Marcaciones".toLocaleUpperCase(),260,80),e.text("Fecha",60,120),e.text("Empresa",60,140),e.text("Empleado",134,140),e.text("DESAYUNO",240,140),e.text("ALMUERZO",320,140),e.text("CENA",400,140),e.text("TOTAL GENERAL",480,140),e.rect(50,113,170,20).stroke(),e.rect(220,113,350,20).stroke(),e.rect(50,133,80,20).stroke(),e.rect(130,133,90,20).stroke(),e.rect(220,133,80,20).stroke(),e.rect(300,133,80,20).stroke(),e.rect(380,133,80,20).stroke(),e.rect(460,133,110,20).stroke(),e.font("Helvetica",8),a.imagenEmpresa&&e.image(a.imagenEmpresa,40,30,{fit:[100,100]})},a.cabeceraReporteEmpresa=function(e,r,o,t,i,s,n,l,c){r.font("Helvetica-Bold",12).fill("black"),r.font("Helvetica-Bold",8),r.text("Empresa",124,120),r.text(s,300,120),r.text("Gerencia",124,140);(new Date).getDate(),(new Date).getMonth(),(new Date).getFullYear();var m=new Date(l),d=new Date(c),p=Math.floor(Math.abs(d-m)/36e5),u=(new Date,new Date(e[0].historial[0].fecha)),f=new Date(e[0].historial[e[0].historial.length-1].fecha);n?r.text("SIN ASIGNACIÓN."===n.toUpperCase()?"TODAS":n.toUpperCase(),300,140):r.text("TODAS",300,120),l&&c?r.text(p<745?a.meses[m.getMonth()+1].nombre.toUpperCase()+"/"+m.getFullYear():a.meses[m.getMonth()+1].nombre.toUpperCase()+"/"+m.getFullYear()+" A "+a.meses[d.getMonth()].nombre.toUpperCase()+"/"+d.getFullYear(),200,160,{width:300,align:"center"}):!l&&c?r.text(a.meses[u.getMonth()].nombre.toUpperCase()+"/"+d.getFullYear(),200,160,{width:300,align:"center"}):r.text(a.meses[u.getMonth()].nombre.toUpperCase()+"/"+u.getFullYear()+" A "+a.meses[f.getMonth()].nombre.toUpperCase()+"/"+f.getFullYear(),200,160,{width:300,align:"center"}),r.text("Periodo",124,160),r.text("Empleado",124,180),r.text("DESAYUNO",240,180),r.text("ALMUERZO",320,180),r.text("CENA",400,180),r.text("TOTAL GENERAL",480,180),r.rect(70,113,150,20).stroke(),r.rect(70,133,150,20).stroke(),r.rect(70,153,150,20).stroke(),r.rect(70,173,150,20).stroke(),r.rect(220,113,350,20).stroke(),r.rect(220,133,350,20).stroke(),r.rect(220,153,350,20).stroke(),r.rect(220,173,80,20).stroke(),r.rect(300,173,80,20).stroke(),r.rect(380,173,80,20).stroke(),r.rect(460,173,110,20).stroke(),r.font("Helvetica",8),a.imagenEmpresa&&r.image(a.imagenEmpresa,40,30,{fit:[100,100]})},a.cabeceraReporteComensal=function(e,r,o,t,e,i,s,n,l){(new Date).getDate(),(new Date).getMonth(),(new Date).getFullYear();var c=new Date(n),m=new Date(l),d=Math.floor(Math.abs(m-c)/36e5);new Date;r.font("Helvetica-Bold",8).fill("black");var p=new Date(e.reporte[0].fecha),u=new Date(e.reporte[e.reporte.length-1].fecha);n&&l?r.text(d<745?a.meses[c.getMonth()+1].nombre.toUpperCase()+"/"+c.getFullYear():a.meses[c.getMonth()+1].nombre.toUpperCase()+"/"+c.getFullYear()+" A "+a.meses[m.getMonth()].nombre.toUpperCase()+"/"+m.getFullYear(),200,160,{width:300,align:"center"}):!n&&l?r.text(a.meses[p.getMonth()].nombre.toUpperCase()+"/"+m.getFullYear(),200,160,{width:300,align:"center"}):r.text(a.meses[p.getMonth()].nombre.toUpperCase()+"/"+p.getFullYear()+" A "+a.meses[u.getMonth()].nombre.toUpperCase()+"/"+u.getFullYear(),200,160,{width:300,align:"center"}),r.font("Helvetica-Bold",8),r.text("Empleado",124,120),r.text(e.nombre.toUpperCase(),300,120),r.text(i,300,140),r.text("Empresa",124,140),r.text("Periodo",124,160),r.text("Empleado",124,180),r.text("DESAYUNO",240,180),r.text("ALMUERZO",320,180),r.text("CENA",410,180),r.text("TOTAL GENERAL",490,180),r.rect(70,113,150,20).stroke(),r.rect(70,133,150,20).stroke(),r.rect(70,153,150,20).stroke(),r.rect(70,173,150,20).stroke(),r.rect(220,113,350,20).stroke(),r.rect(220,133,350,20).stroke(),r.rect(220,153,350,20).stroke(),r.rect(220,173,80,20).stroke(),r.rect(300,173,80,20).stroke(),r.rect(380,173,80,20).stroke(),r.rect(460,173,110,20).stroke(),r.font("Helvetica",8),a.imagenEmpresa&&r.image(a.imagenEmpresa,40,30,{fit:[100,100]})},a.abrirModalEdicionAlias=function(){a.clienteEmpresaAsignacionAlias={},a.clienteEmpresaAsignacionAlias.empresaCliente=Object.assign({},a.empresaExternaSeleccionada),a.clienteEmpresaEdicionGerencias,a.obtenerAliasEmpresa(),a.activeModal=1,a.abrirPopup(a.modalEdicionAlias)},a.cerrarModalEdicionAlias=function(){a.activeModal=0,a.clienteEmpresaAsignacionAlias={},a.cerrarPopup(a.modalEdicionAlias)},a.abrirModalEdicionGerencias=function(){a.activeModal=2,a.clienteEmpresaEdicionGerencias={},a.clienteEmpresaEdicionGerencias.empresaCliente=Object.assign({},a.empresaExternaSeleccionada),a.obtenerGerencias(),a.abrirPopup(a.modalEdicionGerencias)},a.cerrarModalEdicionGerencias=function(){a.activeModal=0,a.clienteEmpresaEdicionGerencias={},a.cerrarPopup(a.modalEdicionGerencias)},a.abrirModalEdicionComensales=function(){a.activeModal=3,a.clienteEmpresaEdicionComensales={},a.clienteEmpresaEdicionComensales.empresaCliente=Object.assign({},a.empresaExternaSeleccionada),a.obtenerGerencias(),a.obtenerComensales(),a.abrirPopup(a.modalEdicionComensales)},a.cerrarModalEdicionComensales=function(){a.activeModal=0,a.clienteEmpresaEdicionComensales={},a.cerrarPopup(a.modalEdicionComensales)},a.abrirModalEdicionComidas=function(){a.clienteEmpresaComidas={},a.clienteEmpresaComidas.empresaCliente=Object.assign({},a.empresaExternaSeleccionada),a.clienteEmpresaComidas.verTodos=!1,a.obtenerComidas(),a.activeModal=4,a.abrirPopup(a.modalEdicionComidas)},a.cerrarModalEdicionComidas=function(){a.clienteEmpresaComidas={},a.activeModal=0,a.cerrarPopup(a.modalEdicionComidas)},a.abrirModalEdicionPrecios=function(){a.clienteEmpresaPreciosComidas={},a.clienteEmpresaPreciosComidas.empresaCliente=Object.assign({},a.empresaExternaSeleccionada),a.activeModal=5,a.obtenerPrecioComidas(),a.abrirPopup(a.modalEdicionPrecios)},a.cerrarModalEdicionPrecios=function(){a.activeModal=0,a.clienteEmpresaPreciosComidas={},a.cerrarPopup(a.modalEdicionPrecios)},a.buscarCliente=function(e){if(""!=e&&void 0!=e)return l(a.usuario.id_empresa,e)},a.abrirdialogClientesComensales=function(){a.abrirPopup(a.dialogClienteEmpresa)},a.cerrardialogClientesComensales=function(){a.cerrarPopup(a.dialogClienteEmpresa)},a.abrirdialogBusquedaComensales=function(){a.activeModal=0,a.abrirPopup(a.busquedaComensalesEmpresa)},a.cerrardialogBusquedaComensales=function(){a.activeModal=0,a.cerrarPopup(a.busquedaComensalesEmpresa)},a.abrirdialogAlertaMarcaciones=function(){a.activeModal=0,a.obtenerAlertas(),a.abrirPopup(a.dialogAlertasMarcaciones)},a.cerrardialogAlertaMarcaciones=function(){a.activeModal=0,a.alertaMarcaciones=[],a.cerrarPopup(a.dialogAlertasMarcaciones)},a.abrirdialogHistorialDocumentos=function(){a.activeModal=0,a.obtenerHistorialDocumentos(),a.abrirPopup(a.dialogHistorialDocumentos)},a.cerrardialogHistorialDocumentos=function(){a.activeModal=0,a.historialesDocumentos=[],a.cerrarPopup(a.dialogHistorialDocumentos)},a.inicio()}]);