angular.module("agil.controladores").controller("ControladorInventarios",["$scope","$timeout","$filter","$window","$localStorage","$location","$templateCache","$route","blockUI","ListaInventariosProducto","Inventario","InventarioPaginador","Productos","ActualizacionInventario","ListaProductosEmpresa","IngresosPorInventario","ActualizarDetalleMovimiento","ListaGruposProductoUsuario","ProductosUsuario","IngPorInventario","InventarioInicial","ClasesTipo",function(e,a,o,n,t,i,r,s,c,u,d,l,v,p,m,g,f,I,h,P,b,_){function M(a,o){return"asc"==e.direccion?a.cantidad_total-o.cantidad_total:o.cantidad_total-a.cantidad_total}c.start(),e.usuario=JSON.parse(t.usuario),e.idModalActualizacionInventario="dialog-actualizacion-inventario",e.idModalIngresosPorInventario="dialog-ingreso-por-inventario",e.idModalCreacionInventario="dialog-creacion-inventario-inicial",e.inicio=function(){e.seleccionGrupo={},e.obtenerSucursales(),e.obtenerInventarios(),e.compraIngresosPorInventario(),e.obtenerGruposProductosEmpresaUsuario(),e.obtenerFormatoFactura()},e.obtenerFormatoFactura=function(){c.start(),_("FORM_IMP_FAC").then(function(a){e.formatosFactura=a.clases,c.stop()})},e.establecerCantidad=function(a){e.cantidadInventario=a},e.obtenerSucursales=function(){for(var a=[],o=0;o<e.usuario.sucursalesUsuario.length;o++)a.push(e.usuario.sucursalesUsuario[o].sucursal);e.sucursales=a},e.obtenerAlmacenes=function(a){e.almacenes=[];var o=$.grep(e.sucursales,function(e){return e.id==a})[0];e.almacenes=o.almacenes},e.establecerAlmacen=function(a){e.id_almacen=a},e.establecerAlmacenBusqueda=function(a){console.log(a.id),e.almacenBusqueda=a},e.obtenerInventarios=function(){e.abs=n.Math.abs,e.itemsPorPagina=10,e.paginaActual=1,e.columna="nombre",e.direccion="asc",e.textoBusqueda="",e.cantidadInventario="0",1==e.sucursales.length&&(e.sucursalBusqueda=e.sucursales[0],e.almacenes=e.sucursalBusqueda.almacenes,1==e.almacenes.length&&(e.almacenBusqueda=e.sucursalBusqueda.almacenes[0],e.buscarInventarios(e.almacenBusqueda.id,e.paginaActual,e.itemsPorPagina,e.textoBusqueda,e.columna,e.direccion,0)))},e.obtenerGruposProductosEmpresaUsuario=function(){c.start(),I(e.usuario.id_empresa,e.usuario.id).then(function(a){c.stop(),a.length>0?e.gruposProducto=a:(e.gruposProducto=[],e.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(a){c.stop(),e.gruposProducto=[];var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.data&&null!==a.data&&""!==a.data?a.data:"Error: Se perdio la conexión.";e.mostrarMensaje(o)})},e.verificarPulso=function(a,o){13===a.keyCode&&(e.textoBusqueda=o,e.almacenBusqueda&&e.buscarInventarios(e.almacenBusqueda.id,1,e.itemsPorPagina,e.textoBusqueda,e.columna,e.direccion,e.cantidadInventario))},e.verDetalleInventario=function(a){u(a.id,e.almacenBusqueda.id).then(function(e){a.inventarios=e}),"none"==$("#"+a.id).css("display")?$("#"+a.id).css("display",""):$("#"+a.id).css("display","none")},e.clasificarColumna=function(a){"cantidad"==a?("asc"==e.direccion?e.direccion="desc":e.direccion="asc",e.productos.sort(M)):(e.columna==a?"asc"==e.direccion?(e.direccion="desc",$("#"+a).removeClass("fa-caret-up"),$("#"+a).addClass("fa-caret-down")):(e.direccion="asc",$("#"+a).removeClass("fa-caret-down"),$("#"+a).addClass("fa-caret-up")):(e.direccion="asc",$(".sort").removeClass("fa-caret-up"),$(".sort").removeClass("fa-caret-down"),$(".sort").addClass("fa-sort"),$("#"+a).addClass("fa-caret-up"),$("#"+a).removeClass("fa-sort")),e.columna=a,e.buscarInventarios(e.almacenBusqueda.id,e.paginaActual,e.itemsPorPagina,e.textoBusqueda,e.columna,e.direccion,e.cantidadInventario,e.seleccionGrupo.id))},e.buscarInventarios=function(a,o,n,t,i,r,s,u){c.start(),e.itemsPorPagina=n,""==t||null==t?t=0:e.textoBusqueda=t,e.paginaActual=o,l(e.usuario.id_empresa,a,o,n,t,i,r,s,u,e.usuario.id).then(function(a){for(var o=a.productos,n=[],t=0;t<o.length;t++){e.colorearInventarioDisponible(o[t].cantidad,o[t]),n.push({id:o[t].id,nombre:o[t].nombre,descripcion:o[t].descripcion,codigo:o[t].codigo,grupo:o[t].grupo,subgrupo:o[t].subgrupo,inventarios:[],cantidad_total:o[t].cantidad,fecha_vencimiento:new Date(o[t].fecha_vencimiento),precio_unitario:o[t].precio_unitario,porcentaje:e.porcentaje,color:e.color,unidad_medida:o[t].unidad_medida})}e.paginas=[];for(t=1;t<=a.paginas;t++)e.paginas.push(t);e.productos=n,c.stop()}).catch(function(a){c.stop(),e.Productos=[];var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.data&&null!==a.data&&""!==a.data?a.data:"Error: Se perdio la conexión.";e.mostrarMensaje(o)})},e.colorearInventarioDisponible=function(a,o){0==a?(e.porcentaje="100",e.color="red"):a>3*o.inventario_minimo+1?(e.porcentaje="100",e.color="green"):a>2*o.inventario_minimo+1?(e.porcentaje="75",e.color="green"):a>1.5*o.inventario_minimo+1?(e.porcentaje="50",e.color="green"):a==o.inventario_minimo+1?(e.porcentaje="38",e.color="yellow"):a==o.inventario_minimo?(e.porcentaje="25",e.color="red"):a<o.inventario_minimo&&a>0&&(e.porcentaje="12",e.color="red")},e.abrirPopupActualizacionInventario=function(a){e.inventario=a,e.abrirPopup(e.idModalActualizacionInventario)},e.modificarCantidadInventario=function(a){p.update({id:a.id},a,function(a){e.cerrarPopupActualizacionInventario(),e.mostrarMensaje(a.message),e.obtenerInventarios()},function(a){e.cerrarPopupActualizacionInventario(),e.mostrarMensaje(a)})},e.editing=!1,e.editDesalleMovimiento=function(a){(console.log(e.editing),console.log(e.editing),e.display)?e.editing?e.editing=!1:e.editing=!0:(e.editing?e.editing=!1:e.editing=!0,"none"==$("#"+a.id).css("display")?$("#"+a.id).css("display",""):(e.display=!1,$("#"+a.id).css("display","none")))},e.verDetalleMovimiento=function(a){console.log(a),e.editing=!1,"none"==$("#"+a.id).css("display")?($("#"+a.id).css("display",""),e.display=!0):(e.display=!1,e.editing=!1,$("#"+a.id).css("display","none"))},e.generarPdfIngresosPorInventario=function(a){c.start();var o=new PDFDocument({size:"letter",margin:10}),n=o.pipe(blobStream()),t=205,i=0,r=1,s=Math.ceil(a.detallesMovimiento.length/17);e.dibujarCabeceraPDFIngresosPorInventario(o,a,1,s),o.font("Helvetica",8);for(var u=0;u<a.detallesMovimiento.length&&i<=17;u++){if(o.rect(50,t,540,30).stroke(),e.usuario.empresa.usar_vencimientos){o.text(a.detallesMovimiento[u].producto.codigo,60,t+10,{width:50}),o.text(a.detallesMovimiento[u].cantidad,120,t+10),o.text(a.detallesMovimiento[u].producto.unidad_medida,150,t+10,{width:50}),o.text(a.detallesMovimiento[u].producto.nombre,190,t+10,{width:180}),o.text(a.detallesMovimiento[u].inventario.lote,380,t+10);var d=new Date(a.detallesMovimiento[u].inventario.fecha_vencimiento);o.text(d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear(),420,t+10)}else o.text(a.detallesMovimiento[u].producto.codigo,70,t+10),o.text(a.detallesMovimiento[u].cantidad,145,t+10),o.text(a.detallesMovimiento[u].producto.unidad_medida,200,t+10,{width:50}),o.text(a.detallesMovimiento[u].producto.nombre,270,t+10,{width:200});o.text(a.detallesMovimiento[u].producto.precio_unitario,470,t+10),o.text(a.detallesMovimiento[u].total,530,t+10),t+=30,17==++i&&(o.addPage({margin:0,bufferPages:!0}),t=205,i=0,r+=1,e.dibujarCabeceraPDFIngresosPorInventario(o,a,r,s),o.font("Helvetica",8))}o.end(),n.on("finish",function(){var e=n.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),c.stop()},e.dibujarCabeceraPDFIngresosPorInventario=function(a,o,n,t){e.usuario.empresa.imagen.length>100&&a.image(e.usuario.empresa.imagen,60,50,{width:50,height:50}),a.font("Helvetica-Bold",8),a.text(e.usuario.empresa.razon_social.toUpperCase(),60,105),a.font("Helvetica",7),a.text(o.almacen.sucursal.nombre.toUpperCase(),60,113),a.text(o.almacen.sucursal.direccion.toUpperCase(),60,121);var i=(null!=o.almacen.sucursal.telefono1?o.almacen.sucursal.telefono1:"")+(null!=o.almacen.sucursal.telefono2?"-"+o.almacen.sucursal.telefono2:"")+(null!=o.almacen.sucursal.telefono3?"-"+o.almacen.sucursal.telefono3:"");a.text("TELF.: "+i,60,129),a.text("COCHABAMBA - BOLIVIA",60,137),a.font("Helvetica-Bold",16),a.text("NOTA DE INGRESO",150,50),a.font("Helvetica-Bold",8),a.rect(380,50,190,50).stroke(),a.text("NIT : ",390,60),a.text(e.usuario.empresa.nit,500,60),a.rect(50,150,540,30).stroke(),a.text("FECHA : ",60,165),a.font("Helvetica-Bold",14),a.text("Inventario Inicial",360,165),a.font("Helvetica-Bold",8),a.rect(50,180,540,25).stroke(),a.rect(50,205,540,510).stroke(),e.usuario.empresa.usar_vencimientos?(a.text("CODIGO",60,195),a.text("CANT.",115,195),a.text("UNID.",150,195),a.text("DETALLE",185,195),a.text("Lote",380,195),a.text("Venc.",420,195)):(a.text("CODIGO",70,195),a.text("CANT.",140,195),a.text("UNID.",200,195),a.text("DETALLE",270,195)),a.text("P. UNIT.",470,195),a.text("TOTAL",530,195);var r=new Date,s=r.getMinutes();s<10&&(s="0"+s),a.font("Helvetica",7),a.text("USUARIO: "+e.usuario.nombre_usuario,55,740),a.text("EMISIÓN : "+r.getDate()+"/"+(r.getMonth()+1)+"/"+r.getFullYear()+" Hr. "+r.getHours()+":"+s,490,740),a.font("Helvetica-Bold",8),a.text("PÁGINA "+n+" DE "+t,0,740,{align:"center"})},e.compraIngresosPorInventario=function(){P(e.usuario.id_empresa).then(function(a){a.hasErr?(e.mostrarMensaje(a.mensaje),e.ingPorInventario=[]):e.ingPorInventario=a})},e.excelIngPorInventario=function(){for(var a=[["Compra","Fecha","Sucursal","Código","Cantidad","Unidad","Detalle","Lote","Vencimiento","Costo Unitario","Total"]],o=0;o<e.ingPorInventario.length;o++)for(var n=0;n<e.ingPorInventario[o].detallesMovimiento.length;n++){var t=[];t.push(e.ingPorInventario[o].id),t.push(e.ingPorInventario[o].fecha.split("T")[0].split("-").reverse().join("/")),t.push(e.ingPorInventario[o].almacen.sucursal.nombre),t.push(e.ingPorInventario[o].detallesMovimiento[n].producto.codigo),t.push(e.ingPorInventario[o].detallesMovimiento[n].cantidad),t.push(e.ingPorInventario[o].detallesMovimiento[n].producto.unidad_medida),t.push(e.ingPorInventario[o].detallesMovimiento[n].producto.nombre),t.push(e.ingPorInventario[o].detallesMovimiento[n].inventario.lote),t.push(e.ingPorInventario[o].detallesMovimiento[n].inventario.fecha_vencimientoTexto?e.ingPorInventario[o].detallesMovimiento[n].inventario.fecha_vencimientoTexto:""),t.push(e.ingPorInventario[o].detallesMovimiento[n].costo_unitario),t.push(e.ingPorInventario[o].detallesMovimiento[n].total),a.push(t)}var i="SheetJS",r=new Workbook,s=sheet_from_array_of_arrays(a);r.SheetNames.push(i),r.Sheets[i]=s;var c=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"INGRESOS POR INVENTARIO.xlsx")},e.cerrarPopupActualizacionInventario=function(){e.cerrarPopup(e.idModalActualizacionInventario)},e.abrirPopupIngresosPorInventario=function(a){e.inventario=a,e.abrirPopup(e.idModalIngresosPorInventario)},e.cerrarPopupIngresosPorInventario=function(){e.cerrarPopup(e.idModalIngresosPorInventario)},e.crearNuevoInventario=function(){e.abrirPopup(e.idModalCreacionInventario)},e.buscarProducto=function(a){if(""!=a&&void 0!=a)return m(e.usuario.id_empresa,a)},e.cerrarPopupInvInicial=function(){e.cerrarPopup(e.idModalCreacionInventario)},e.sumarCantidadAlmacen=function(e,a,n){e=o("filter")(e,a),e=o("filter")(e,n);for(var t=0,i=0;i<e.length;i++)t+=e[i].cantidad;return t},e.sumarCostoTotalAlmacen=function(e,a,n){e=o("filter")(e,a),e=o("filter")(e,n);for(var t=0,i=0;i<e.length;i++)t+=e[i].costo_total;return t},e.sumarCantidadSucursal=function(e,a){e=o("filter")(e,a);for(var n=0,t=0;t<e.length;t++)n+=e[t].cantidad;return n},e.sumarCostoTotalSucursal=function(e,a){e=o("filter")(e,a);for(var n=0,t=0;t<e.length;t++)n+=e[t].costo_total;return n},e.bajarExcelInventarios=function(){h(e.usuario.id_empresa,e.usuario.id).then(function(e){for(var a=[["Codigo","Nombre o Descripción","Unidad de medida","Costo Unitario","Cantidad a ingresar","Fecha de vencimiento (dia/mes/año)","Lote"]],o=0;o<e.length;o++){var n=[];n.push(e[o].codigo),n.push(e[o].nombre),n.push(e[o].unidad_medida),a.push(n)}var t="INVENTARIO",i=new Workbook,r=sheet_from_array_of_arrays(a);i.SheetNames.push(t),i.Sheets[t]=r;var s=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"EJEMPLO-DATOS-INVENTARIOS.xlsx"),c.stop()})},e.guardarInventarioInicial=function(a,o){a.fechaVencimientoTexto&&(a.fecha_vencimiento=new Date(e.convertirFecha(a.fechaVencimientoTexto)));var n=[];n.push(a);new d({productos:n,id_empresa:e.usuario.id_empresa,id_almacen:e.id_almacen});var t={productos:n,id_empresa:e.usuario.id_empresa,id_almacen:e.id_almacen};b(t).then(function(a){a.hasErr?e.mostrarMensaje(a.message):(e.mostrarMensaje(a.message),e.cerrarPopupInvInicial(),e.recargarItemsTabla())}).catch(function(a){var o=void 0!==a.stack&&null!==a.stack?a.stack:void 0!==a.data&&null!==a.data&&""!==a.data?a.data:"Error: Se perdio la conexión.";e.mostrarMensaje(o),c.stop()})},e.subirExcelInventarios=function(a,o){var n,t,i=a.target.files;for(t=i[n=0];n!=i.length;++n){var r=new FileReader;t.name;r.onload=function(a){c.start();var n=a.target.result,t=XLSX.read(n,{type:"binary"}),i=t.SheetNames[0],r=2,s=t.Sheets[i],u=[];do{var d={};d.codigo=void 0!=s["A"+r]&&""!=s["A"+r]?s["A"+r].v.toString():null,d.nombre=void 0!=s["B"+r]&&""!=s["B"+r]?s["B"+r].v.toString():null,d.unidad_medida=void 0!=s["C"+r]&&""!=s["C"+r]?s["C"+r].v.toString():null,d.costo_unitario=void 0!=s["D"+r]&&""!=s["D"+r]?parseFloat(s["D"+r].v.toString()):null,d.cantidad=void 0!=s["E"+r]&&""!=s["E"+r]?parseFloat(s["E"+r].v.toString()):null;var l=null;void 0!=s["F"+r]&&""!=s["F"+r]&&("number"==typeof s["F"+r].v?s["F"+r].v%1==0&&(l=new Date(86400*(s["F"+r].v-25568)*1e3)):l=new Date(e.convertirFecha(s["F"+r].v))),d.fecha_vencimiento=l,d.lote=void 0!=s["G"+r]&&""!=s["G"+r]?s["G"+r].v.toString():null,u.push(d),r++,0}while(void 0!=s["A"+r]);e.guardarInventario(u,o),c.stop()},r.readAsBinaryString(t)}},e.guardarInventario=function(a,o){new d({productos:a,id_empresa:e.usuario.id_empresa,id_almacen:e.id_almacen}).$save(function(a){c.stop(),e.mostrarMensaje(a.message),e.recargarItemsTabla()},function(a){c.stop(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})},e.animate=!1,e.editMovientoDetalle=function(o){o.inventario.fecha_vencimiento=new Date(e.convertirFecha(o.inventario.fecha_vencimientoTexto)),o.total=o.cantidad*o.costo_unitario-o.descuento+o.recargo-o.ice-o.excento,console.log(o),f.update({id:o.id},o,function(o){a(function(){e.animate=!0,a(function(){e.animate=!1},1e3)},1e3)},function(a){e.mostrarMensaje(a)})},e.editItem=function(e){e.editing=!0},e.doneEditing=function(e){e.editing=!1},e.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),e.buscarAplicacion(e.usuario.aplicacionesUsuario,i.path().substring(1)),ejecutarScriptsInventario(e.idModalActualizacionInventario,e.idModalCreacionInventario,e.idModalIngresosPorInventario),c.stop()}),e.$on("$routeChangeStart",function(a,o){e.eliminarPopup(e.idModalActualizacionInventario),e.eliminarPopup(e.idModalCreacionInventario),e.eliminarPopup(e.idModalIngresosPorInventario)}),e.inicio()}]);