angular.module("agil.controladores").controller("ControladorMesa",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ListaSalas","ListaGruposProductoEmpresa","ProductosPanel","Sala","Mesa","ClasesTipo","MesaPedidoRestaurante","PedidoRestaurante","PedidoRestauranteActualizacion","MesaActualizacion","$timeout","Venta","ImprimirSalida","ListaInventariosProducto","InactivarPedido","ClientesNit","ActualizarGarzon","CrearGarzon","Garzon","ListaGarzones","EliminacionMesaPedidoRestaurante",function(e,a,o,t,n,i,r,s,d,u,c,l,p,m,g,f,P,v,M,R,z,b,h,_,E,w,G){i.start(),e.usuario=JSON.parse(a.usuario),e.idModalPanelPedido="dialog-panel-ventas",e.idModalSalaEdicion="modal-wizard-sala-edicion",e.idModalContenedorSalaEdicion="modal-wizard-container-sala-edicion",e.idModalMesaEdicion="modal-wizard-mesa-edicion",e.idModalContenedorMesaEdicion="modal-wizard-container-mesa-edicion",e.idModalGarzonEdicion="modal-wizard-garzon-edicion",e.idModalContenedorGarzonEdicion="modal-wizard-container-garzon-edicion",e.idModalFacturacion="modal-wizard-facturacion",e.idModalContenedorFacturacion="modal-wizard-container-facturacion",e.idModalReserva="modal-wizard-reserva",e.idModalContenedorReserva="modal-wizard-container-reserva",e.idModalCambioMesa="modal-wizard-cambio-mesa",e.idModalContenedorCambioMesa="modal-wizard-container-cambio-mesa",e.idModalUnionMesas="modal-wizard-union-mesas",e.idModalContenedorUnionMesas="modal-wizard-container-union-mesas",e.idModalAsignacionGarzon="modal-wizard-asignacion-garzon",e.idModalContenedorAsignacionGarzon="modal-wizard-container-asignacion-garzon",e.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),ejecutarScriptsMesas(e.idModalPanelPedido,e.idModalSalaEdicion,e.idModalContenedorSalaEdicion,e.idModalMesaEdicion,e.idModalContenedorMesaEdicion,e.idModalGarzonEdicion,e.idModalContenedorGarzonEdicion,e.idModalFacturacion,e.idModalContenedorFacturacion,e.idModalReserva,e.idModalContenedorReserva,e.idModalCambioMesa,e.idModalContenedorCambioMesa,e.idModalUnionMesas,e.idModalContenedorUnionMesas,e.idModalAsignacionGarzon,e.idModalContenedorAsignacionGarzon),e.buscarAplicacion(e.usuario.aplicacionesUsuario,o.path().substring(1)),i.stop()}),e.inicio=function(){i.start(),l("EM").then(function(a){e.estadosMesa=a.clases,i.stop()}),e.sucursales=e.obtenerSucursales(),e.obtenerMovimientosEgreso(),e.obtenerTiposDePago(),e.obtenerGarzones()},e.obtenerMovimientosEgreso=function(){i.start(),l("MOVEGR").then(function(a){e.movimientosEgreso=a.clases,i.stop()})},e.obtenerTiposDePago=function(){i.start(),l("TIPA").then(function(a){e.tiposPago=a.clases,i.stop()})},e.obtenerSalas=function(a){i.start(),e.obtenerAlmacenes(a),r(a).then(function(a){e.salas=a,e.mesas=[],i.stop()})},e.obtenerSucursales=function(){for(var a=[],o=0;o<e.usuario.sucursalesUsuario.length;o++)a.push(e.usuario.sucursalesUsuario[o].sucursal);return a},e.obtenerAlmacenes=function(a){e.almacenes=[];var o=$.grep(e.sucursales,function(e){return e.id==a})[0];e.almacenes=o.almacenes,e.filtro.almacen=1==e.almacenes.length?e.almacenes[0]:null},e.obtenerGarzones=function(){i.start(),w(e.usuario.empresa.id).then(function(a){e.garzones=a,e.llenarGarzonesOpciones(),i.stop()})},e.cargarProductosPanel=function(){d(e.usuario.id_empresa,e.filtro.almacen.id).then(function(a){for(var o=0;o<a.length;o++)a[o].activar_inventario&&(a[o].inventario_disponible=e.obtenerInventarioTotal(a[o]));e.productos=a,e.productosProcesados=a})},e.obtenerInventarioTotal=function(e){var a=0;if(e.activar_inventario)for(var o=0;o<e.inventarios.length;o++)a+=e.inventarios[o].cantidad;else a=5e5;return a},e.verSala=function(a){e.salaVista=a,e.mesas=a.mesas,e.llenarMesasOpciones()},e.llenarMesasOpciones=function(){e.mesas_unidas=[];for(var a=0;a<e.mesas.length;a++){var o={name:e.mesas[a].numero+"",numero:e.mesas[a].numero,maker:"",ticked:!1,id:e.mesas[a].id};e.mesas_unidas.push(o)}},e.llenarGarzonesOpciones=function(){e.garzonesOpciones=[];for(var a=0;a<e.garzones.length;a++){var o={name:e.garzones[a].persona.nombre_completo,maker:"",ticked:!1,id:e.garzones[a].id,persona:{imagen:e.garzones[a].persona.imagen}};e.garzonesOpciones.push(o)}},e.verGarzon=function(a){e.garzon=a,e.garzonVista=a,e.abrirPopup(e.idModalGarzonEdicion),null!=e.garzon&&(e.garzon.persona.imagen="img/icon-user-default.png")},e.obtenerGruposProductoEmpresa=function(){s(e.usuario.id_empresa).then(function(a){e.grupos_productos=a})},e.verPedido=function(a){e.cargarProductosPanel(),p(a.id,e.filtro.almacen.id).then(function(o){if(o.pedidosRestaurante){e.pedidoRestaurante=o.pedidosRestaurante[0].pedidoRestaurante;for(var t=0;t<e.pedidoRestaurante.detallesPedidoRestaurante.length;t++)e.pedidoRestaurante.detallesPedidoRestaurante[t].producto.activar_inventario?e.pedidoRestaurante.detallesPedidoRestaurante[t].costos=e.pedidoRestaurante.detallesPedidoRestaurante[t].producto.inventarios:e.pedidoRestaurante.detallesPedidoRestaurante[t].costos=[]}else e.pedidoRestaurante=new m({detallesPedidoRestaurante:[],mesas:[],pedido_activo:!0,garzones:[]}),e.pedidoRestaurante.mesas.push(a);e.obtenerGruposProductoEmpresa(),e.abrirPopup(e.idModalPanelPedido),e.sumarTotal(),e.sumarTotalImporte(),setTimeout(function(){aplicarSwiper(4,3,!0,2)},1e3)})},e.liberarMesa=function(a){p(a.id,e.filtro.almacen.id).then(function(o){o.pedidosRestaurante?e.mostrarMensaje("La mesa no puede ser liberada porque aun existe un pedido pendiente!"):(a.estado=$.grep(e.estadosMesa,function(a){return a.nombre_corto==e.diccionario.ESTADO_MESA_DISPONIBLE})[0],f.update({id_mesa:a.id},a,function(a){i.stop(),e.mostrarMensaje("Mesa liberada exitosamente!")}))})},e.reservarMesa=function(a){e.mesa=a,e.abrirPopup(e.idModalReserva)},e.crearReserva=function(){e.abrirPopup(e.idModalReserva)},e.guardarPedidoRestaurante=function(a,o){if(a)if(o.id)g.update({id_pedido_restaurante:o.id},o,function(a){i.stop(),e.cerrarPedido(),e.mostrarMensaje("Pedido actualizado Exitosamente!")});else{var t=o.mesas;o.$save(function(a){for(var o=0;o<t.length;o++)t[o].estado=a;i.stop(),e.cerrarPedido(),e.mostrarMensaje("Pedido guardado Exitosamente!")},function(a){i.stop(),e.cerrarPedido(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},e.abrirPopupDatosFacturacion=function(){e.venta=new v({cliente:{},pagado:0}),e.abrirPopup(e.idModalFacturacion)},e.buscarNit=function(a,o){13===a.which&&b(e.usuario.id_empresa,o).then(function(o){1==o.length||o.length>1?(e.establecerCliente(o[0]),e.interceptarTecla(a,"razon_social",!0)):(e.venta.cliente.razon_social=null,e.interceptarTecla(a,"razon_social",!0))})},e.interceptarTecla=function(a,o,t){13===a.which&&(t?e.enfocar(o):P(function(){$("#"+o).trigger("click")},0))},e.cerrarPopupFacturacion=function(){e.cerrarPopup(e.idModalFacturacion)},e.cerrarPopupReserva=function(){e.cerrarPopup(e.idModalReserva)},e.enfocar=function(e){P(function(){$("#"+e).focus()},0)},e.establecerCliente=function(a){e.venta.cliente=a,e.enfocar("razon_social")},e.calcularCambio=function(){e.venta.cambio=Math.round(100*(e.venta.pagado-e.pedidoRestaurante.total))/100,e.pagoMinimo=e.pedidoRestaurante.total},e.facturarPedidoRestaurante=function(){if("Siguiente"!=$("#siguienteFacturacion").text().trim()){i.start(),e.venta.total=e.pedidoRestaurante.total,e.venta.importe=e.pedidoRestaurante.importe,e.venta.id_usuario=e.usuario.id,e.venta.id_empresa=e.usuario.empresa.id,e.venta.detallesVentaNoConsolidadas=[],e.venta.fecha=new Date,e.venta.fechaTexto=e.venta.fecha.getDate()+"/"+(e.venta.fecha.getMonth()+1)+"/"+e.venta.fecha.getFullYear(),e.venta.almacen=e.filtro.almacen,e.venta.sucursal=e.filtro.sucursal,e.venta.actividad=e.filtro.sucursal.actividadesDosificaciones[0].actividad,e.venta.detallesVenta=e.pedidoRestaurante.detallesPedidoRestaurante,e.venta.movimiento=$.grep(e.movimientosEgreso,function(a){return a.nombre_corto==e.diccionario.EGRE_FACTURACION})[0],e.venta.tipoPago=$.grep(e.tiposPago,function(a){return a.nombre==e.diccionario.TIPO_PAGO_CONTADO})[0];var a=e.venta.movimiento.nombre_corto;e.venta.$save(function(o){if(e.pedidoRestaurante.id)z.update({id:e.pedidoRestaurante.id},e.pedidoRestaurante,function(a){for(var o=0;o<e.pedidoRestaurante.mesasPedidoRestaurante.length;o++){var t=$.grep(e.mesas,function(a){return a.id==e.pedidoRestaurante.mesasPedidoRestaurante[o].mesa.id})[0];e.liberarMesa(t)}i.stop()});else{console.log(e.pedidoRestaurante),e.pedidoRestaurante.pedido_activo=!1;var t=Object.create(e.pedidoRestaurante);e.guardarPedidoRestaurante(!0,e.pedidoRestaurante);for(var n=0;n<t.mesas.length;n++){var r=$.grep(e.mesas,function(e){return e.id==t.mesas[n].id})[0];e.liberarMesa(r)}}M(a,o,!0,e.usuario),e.cerrarPopup(e.idModalFacturacion),e.cerrarPedido(),e.mostrarMensaje("Venta registrada exitosamente!"),i.stop()},function(a){i.stop(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},e.eliminarDetallePedidoRestaurante=function(a){a.eliminado=!0,e.sumarTotal(),e.sumarTotalImporte()},e.disminuirDetallePedidoRestaurante=function(a){1==a.cantidad?e.eliminarDetallePedidoRestaurante(a):(a.cantidad=a.cantidad-1,e.calcularImporteDetallePedido(a),e.sumarTotal(),e.sumarTotalImporte())},e.agregarDetallePedido=function(a){var o;if(e.cantidadInventario=0,a.activar_inventario)for(var t=0;t<a.inventarios.length;t++)e.cantidadInventario=e.cantidadInventario+a.inventarios[t].cantidad;for(var n=0,i=!1;n<e.pedidoRestaurante.detallesPedidoRestaurante.length&&!i;)e.pedidoRestaurante.detallesPedidoRestaurante[n].eliminado||e.pedidoRestaurante.detallesPedidoRestaurante[n].producto.id!=a.id||(a.activar_inventario?e.pedidoRestaurante.detallesPedidoRestaurante[n].cantidad+1<=e.cantidadInventario?e.pedidoRestaurante.detallesPedidoRestaurante[n].cantidad=e.pedidoRestaurante.detallesPedidoRestaurante[n].cantidad+1:e.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+e.cantidadInventario+"!"):e.pedidoRestaurante.detallesPedidoRestaurante[n].cantidad=e.pedidoRestaurante.detallesPedidoRestaurante[n].cantidad+1,i=!0,o=e.pedidoRestaurante.detallesPedidoRestaurante[n]),n++;i?e.calcularImporteDetallePedido(o):a.activar_inventario?1<=e.cantidadInventario?(o={producto:a,precio_unitario:a.precio_unitario,inventario_disponible:e.cantidadInventario,costos:a.inventarios,cantidad:1,descuento:a.descuento,tipo_descuento:a.descuento>0,recargo:0,ice:0,excento:0,tipo_recargo:!1},e.pedidoRestaurante.detallesPedidoRestaurante.push(o),e.calcularImporteDetallePedido(o)):e.mostrarMensaje("¡Cantidad de inventario insuficiente, inventario disponible: "+e.cantidadInventario+"!"):(o={producto:a,precio_unitario:a.precio_unitario,inventario_disponible:e.cantidadInventario,costos:[],cantidad:1,descuento:a.descuento,tipo_descuento:a.descuento>0,recargo:0,ice:0,excento:0,tipo_recargo:!1},e.pedidoRestaurante.detallesPedidoRestaurante.push(o),e.calcularImporteDetallePedido(o)),e.sumarTotal(),e.sumarTotalImporte()},e.sumarTotalImporte=function(){for(var a=0,o=0;o<e.pedidoRestaurante.detallesPedidoRestaurante.length;o++)e.pedidoRestaurante.detallesPedidoRestaurante[o].eliminado||(a+=e.pedidoRestaurante.detallesPedidoRestaurante[o].importe);e.pedidoRestaurante.importe=Math.round(1e3*a)/1e3},e.sumarTotal=function(){for(var a=0,o=0;o<e.pedidoRestaurante.detallesPedidoRestaurante.length;o++)e.pedidoRestaurante.detallesPedidoRestaurante[o].eliminado||(a+=e.pedidoRestaurante.detallesPedidoRestaurante[o].total);e.pedidoRestaurante.total=Math.round(1e3*a)/1e3},e.calcularImporteDetallePedido=function(e){var a,o;e.importe=Math.round(e.cantidad*e.precio_unitario*1e3)/1e3,a=e.tipo_descuento?e.importe*(e.descuento/100):e.descuento,o=e.tipo_recargo?e.importe*(e.recargo/100):e.recargo,e.total=e.importe-a+o-e.ice-e.excento},e.cerrarPedido=function(){e.cerrarPopup(e.idModalPanelPedido)},e.clasificarGrupo=function(a){e.productosProcesados=$filter("filter")(e.productos,a),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},e.ordenarProductos=function(a){console.log(a),e.productosProcesados=$filter("orderBy")(e.productos,["nombre"],a),e.ordenProductos=!a,setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},e.filtrarProductos=function(a){e.productosProcesados=$filter("filter")(e.productos,a),setTimeout(function(){aplicarSwiper(4,3,!0,2)},5)},e.cambiarColor=function(e,a){$("#dialog-panel-ventas .widget-main").removeClass("red-style green-style skyblue-style brown-style"),$("#dialog-panel-ventas .widget-main").addClass(e),$("#dialog-panel-ventas .widget-main .button-style").removeClass("red-style-button green-style-button skyblue-style-button brown-style-button"),$("#dialog-panel-ventas .widget-main .button-style").addClass(a)},e.showHideFirstRow=function(){"none"==$(".first-row").css("display")?$(".first-row").show("slow"):$(".first-row").hide(1e3)},e.crearSala=function(a){e.sala=new u({id_sucursal:a}),e.abrirPopup(e.idModalSalaEdicion),$("#sala_step_1").trigger("click")},e.crearMesa=function(a){e.mesa=new c({id_sala:a,imagen:"img/table.png"}),e.mesa.estado=$.grep(e.estadosMesa,function(a){return a.nombre_corto==e.diccionario.ESTADO_MESA_DISPONIBLE})[0],e.abrirPopup(e.idModalMesaEdicion),$("#mesa_step_1").trigger("click")},e.crearGarzon=function(a){e.garzon=new _({id_empresa:e.usuario.id_empresa,persona:{imagen:"img/icon-user-default.png"}}),e.abrirPopup(e.idModalGarzonEdicion),$("#garzon_step_1").trigger("click")},e.cerrarPopPupEdicionSala=function(){e.cerrarPopup(e.idModalSalaEdicion)},e.cerrarPopPupEdicionMesa=function(){e.cerrarPopup(e.idModalMesaEdicion)},e.cerrarPopPupEdicionGarzon=function(){e.cerrarPopup(e.idModalGarzonEdicion)},e.guardarSala=function(a){"Siguiente"!=$("#siguiente").text().trim()&&(i.start(),a.id?u.update({id_sala:a.id},a,function(a){i.stop(),e.cerrarPopPupEdicionSala(),e.mostrarMensaje("Sala actualizada Exitosamente!")}):a.$save(function(o){i.stop(),e.cerrarPopPupEdicionSala(),e.obtenerSalas(a.id_sucursal),e.mostrarMensaje("Sala guardada Exitosamente!")},function(a){i.stop(),e.cerrarPopPupEdicionSala(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!")}))},e.guardarMesa=function(a){if("Siguiente"!=$("#siguienteMesa").text().trim()){i.start();var o=a.estado;a.id?c.update({id_mesa:a.id},a,function(a){i.stop(),e.cerrarPopPupEdicionMesa(),e.mostrarMensaje("Mesa actualizada Exitosamente!")}):a.$save(function(a){a.estado=o,e.salaVista.mesas.push(a),i.stop(),e.cerrarPopPupEdicionMesa(),e.mostrarMensaje("Mesa guardada Exitosamente!")},function(a){i.stop(),e.cerrarPopPupEdicionMesa(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},e.guardarGarzon=function(a){if(e.garzon=a,"Siguiente"!=$("#siguienteGarzon").text().trim()){i.start();var o=a.persona.imagen;a.id?h.update({id_garzon:a.id},e.garzon,function(a){if(null==a.signedRequest)e.obtenerGarzones(),i.stop(),e.cerrarPopPupEdicionGarzon(),e.mostrarMensaje("Garzon actualizado Exitosamente!");else{var t=new XMLHttpRequest;t.open("PUT",a.signedRequest),t.onreadystatechange=function(){4===t.readyState&&(200===t.status?(e.obtenerGarzones(),i.stop(),e.cerrarPopPupEdicionGarzon(),e.mostrarMensaje("Garzon actualizado Exitosamente!")):alert("Could not upload file."))};for(var n=atob(o.split(",")[1]),r=[],s=0;s<n.length;s++)r.push(n.charCodeAt(s));var d=new Blob([new Uint8Array(r)],{type:"image/jpeg"}),u=new File([d],a.image_name,{type:"image/jpeg"});console.log(u),t.send(u)}}):a.$save(function(a){if(null==a.signedRequest)e.verGarzon(),e.obtenerGarzones(),i.stop(),e.cerrarPopPupEdicionGarzon(),e.mostrarMensaje("Garzon guardado Exitosamente!");else{var t=new XMLHttpRequest;t.open("PUT",a.signedRequest),t.onreadystatechange=function(){4===t.readyState&&(200===t.status?(e.verGarzon(),e.obtenerGarzones(),i.stop(),e.cerrarPopPupEdicionGarzon(),e.mostrarMensaje("Garzon guardado Exitosamente!")):alert("Could not upload file."))};for(var n=atob(o.split(",")[1]),r=[],s=0;s<n.length;s++)r.push(n.charCodeAt(s));var d=new Blob([new Uint8Array(r)],{type:"image/jpeg"}),u=new File([d],a.image_name,{type:"image/jpeg"});t.send(u)}},function(a){i.stop(),e.cerrarPopPupEdicionGarzon(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!")})}},e.abrirPopupAsignacionGarzon=function(){if(e.llenarGarzonesOpciones(),e.pedidoRestaurante.garzones)for(var a=0;a<e.garzonesOpciones.length;a++)for(var o=0;o<e.pedidoRestaurante.garzones.length;o++)e.garzonesOpciones[a].id==e.pedidoRestaurante.garzones[o].id&&(e.garzonesOpciones[a].ticked=!0);else for(a=0;a<e.garzonesOpciones.length;a++)for(o=0;o<e.pedidoRestaurante.garzonesPedidoRestaurante.length;o++)e.garzonesOpciones[a].id==e.pedidoRestaurante.garzonesPedidoRestaurante[o].garzon.id&&(e.garzonesOpciones[a].ticked=!0);e.abrirPopup(e.idModalAsignacionGarzon)},e.abrirPopupUnionMesas=function(){if(e.llenarMesasOpciones(),e.pedidoRestaurante.mesas)for(var a=0;a<e.mesas_unidas.length;a++)for(var o=0;o<e.pedidoRestaurante.mesas.length;o++)e.mesas_unidas[a].id==e.pedidoRestaurante.mesas[o].id&&(e.mesas_unidas[a].ticked=!0);else for(a=0;a<e.mesas_unidas.length;a++)for(o=0;o<e.pedidoRestaurante.mesasPedidoRestaurante.length;o++)e.mesas_unidas[a].id==e.pedidoRestaurante.mesasPedidoRestaurante[o].mesa.id&&(e.mesas_unidas[a].ticked=!0);e.abrirPopup(e.idModalUnionMesas)},e.abrirPopupCambioMesa=function(){e.mesaAcambiar=null,e.abrirPopup(e.idModalCambioMesa)},e.cerrarPopupCambioMesa=function(){e.cerrarPopup(e.idModalCambioMesa)},e.cerrarPopupUnionMesas=function(){e.cerrarPopup(e.idModalUnionMesas)},e.cerrarPopupAsignacionGarzones=function(){e.cerrarPopup(e.idModalAsignacionGarzon)},e.cambiarMesa=function(a){e.pedidoRestaurante.mesas||z.update({id:e.pedidoRestaurante.id},e.pedidoRestaurante,function(a){for(var o=0;o<e.pedidoRestaurante.mesasPedidoRestaurante.length;o++){var t=$.grep(e.mesas,function(a){return a.id==e.pedidoRestaurante.mesasPedidoRestaurante[o].mesa.id})[0];e.liberarMesa(t)}e.guardarPedidoRestaurante(!0,e.pedidoRestaurante)}),e.pedidoRestaurante.mesas=[],e.pedidoRestaurante.mesas.push(a),$.grep(e.mesas,function(e){return e.id==a.id})[0].estado=$.grep(e.estadosMesa,function(a){return a.nombre_corto==e.diccionario.ESTADO_MESA_OCUPADO})[0],e.cerrarPopupCambioMesa()},e.estaMesaUnida=function(a){for(var o=!1,t=0,n=e.pedidoRestaurante.mesas?e.pedidoRestaurante.mesas:e.pedidoRestaurante.mesasPedidoRestaurante;t<n.length&&!o;){(n[t].mesa?n[t].mesa:n[t]).id==a.id&&(o=!0),t++}return o},e.unirMesas=function(a){for(var o=[],t=0;t<a.length;t++){if(!e.estaMesaUnida(a[t]))o.push(a[t]),p(a[t].id,e.filtro.almacen.id).then(function(a){if(a.pedidosRestaurante)for(var o=a.pedidosRestaurante[0].pedidoRestaurante,t=0;t<o.detallesPedidoRestaurante.length;t++){o.detallesPedidoRestaurante[t].producto.activar_inventario?o.detallesPedidoRestaurante[t].costos=o.detallesPedidoRestaurante[t].producto.inventarios:o.detallesPedidoRestaurante[t].costos=[];for(var n=0;n<o.detallesPedidoRestaurante[t].cantidad;n++)e.agregarDetallePedido(o.detallesPedidoRestaurante[t].producto)}e.sumarTotal(),e.sumarTotalImporte()})}if(o.length>0){for(var n="",r=0;r<o.length;r++)n=r==o.length-1?n+""+o[r].id:o[r].id+","+n;new G({id:n}).$delete(function(){e.pedidoRestaurante.mesas=a,g.update({id_pedido_restaurante:e.pedidoRestaurante.id},e.pedidoRestaurante,function(a){i.stop(),e.cerrarPopupUnionMesas(),e.mostrarMensaje("Mesas Unidas satisfactoriamente!")})})}e.cerrarPopupUnionMesas(),e.mostrarMensaje("Mesas Unidas satisfactoriamente!")},e.estaGarzon=function(a){for(var o=!1,t=0,n=e.pedidoRestaurante.garzones?e.pedidoRestaurante.garzones:e.pedidoRestaurante.garzonesPedidoRestaurante;t<n.length&&!o;){(n[t].garzon?n[t].mesa:n[t]).id==a.id&&(o=!0),t++}return o},e.asignarGarzones=function(a){e.pedidoRestaurante.garzones=a,e.pedidoRestaurante.id?g.update({id_pedido_restaurante:e.pedidoRestaurante.id},e.pedidoRestaurante,function(o){e.pedidoRestaurante.garzones=a,i.stop(),e.cerrarPopupAsignacionGarzones(),e.mostrarMensaje("Garzones asignados satisfactoriamente!")}):(e.cerrarPopupAsignacionGarzones(),e.mostrarMensaje("Garzones asignados satisfactoriamente!"))},e.generarCuenta=function(e){var a=new PDFDocument({size:[227,350],margins:{top:10,bottom:10,left:20,right:20}});stream=a.pipe(blobStream()),a.font("Helvetica-Bold",14),a.moveDown(.8);var o="";if(e.mesas)for(var t=0;t<e.mesas.length;t++)o=o+" "+e.mesas[t].numero+",";else for(t=0;t<e.mesasPedidoRestaurante.length;t++)o=o+" "+e.mesasPedidoRestaurante[t].mesa.numero+",";a.text("MESAS: "+o,{align:"center"}),a.font("Helvetica",10),a.moveDown(.4),a.text("Cant.  Consumo                P/U           total",{align:"left"}),a.moveDown(.4);var n=a.y;for(t=0;t<e.detallesPedidoRestaurante.length;t++)a.font("Helvetica",9),a.text(e.detallesPedidoRestaurante[t].cantidad,20,n),a.text(e.detallesPedidoRestaurante[t].producto.nombre,30,n,{width:100}),a.text(e.detallesPedidoRestaurante[t].producto.precio_unitario.toFixed(2),140,n),a.text(e.detallesPedidoRestaurante[t].producto.precio_unitario*e.detallesPedidoRestaurante[t].cantidad,180,n),n+=20;a.x=20,a.font("Helvetica",10),a.moveDown(.4),a.text("Total Transacción:                         "+e.total.toFixed(2),{align:"left"}),a.moveDown(2),a.text("Por favor llene sus datos para la emision de factura:",{align:"left"}),a.moveDown(.4),a.text("Razon social:.........................................",{align:"left"}),a.moveDown(.4),a.text("...............................................................",{align:"left"}),a.moveDown(.4),a.text("Nit:.........................................................",{align:"left"}),a.moveDown(2);var i=new Date,r=i.getMinutes();r<10&&(r="0"+r),a.text(" Fecha : "+i.getDate()+"/"+(i.getMonth()+1)+"/"+i.getFullYear()+"  "+i.getHours()+":"+r+"  ",{align:"center"}),a.end(),stream.on("finish",function(){var e=stream.toBlobURL("application/pdf"),a=window.open(e,"_blank","location=no");P(function(){a.print()},500)})},e.obtenerMesasLibres=function(){if(e.mesas){for(var a=[],o=0;o<e.mesas.length;o++)e.mesas[o].estado.nombre_corto==e.diccionario.ESTADO_MESA_DISPONIBLE&&a.push(e.mesas[o]);return a}},e.$on("$routeChangeStart",function(a,o){e.eliminarPopup(e.idModalPanelPedido),e.eliminarPopup(e.idModalSalaEdicion),e.eliminarPopup(e.idModalMesaEdicion),e.eliminarPopup(e.idModalGarzonEdicion),e.eliminarPopup(e.idModalFacturacion),e.eliminarPopup(e.idModalReserva),e.eliminarPopup(e.idModalCambioMesa),e.eliminarPopup(e.idModalUnionMesas),e.eliminarPopup(e.idModalAsignacionGarzon)}),e.inicio()}]);