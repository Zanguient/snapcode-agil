angular.module("agil.controladores").controller("ControladorRutas",["$scope","$localStorage","$location","$templateCache","$route","blockUI","$timeout","Clases","Clientes","Rutas","Ruta","uiGmapGoogleMapApi","$cordovaGeolocation","ClasesTipo","ClientesEmpresa",function(t,a,e,o,r,n,i,s,l,u,c,p,d,g,m){n.start(),t.usuario=JSON.parse(a.usuario),t.inicio=function(){t.obtenerDias(),t.obtenerClientes(),t.obtenerDepartamentos(),t.obtenerMunicipios(),setTimeout(function(){ejecutarScriptsTabla("tabla-rutas",10)},2e3)},t.obtenerClientes=function(){n.start(),l(t.usuario.id_empresa).then(function(a){t.clientes=a,n.stop()})},t.obtenerRutas=function(){n.start(),u(t.usuario.id_empresa).then(function(a){for(var e=0;e<a.length;e++){a[e].segmentos=JSON.parse(a[e].segmentos);for(var o=0;o<a[e].dias.length;o++)a[e].dias[o]=a[e].dias[o].id_dia;for(var r=0;r<a[e].clientes.length;r++)a[e].clientes[r]=a[e].clientes[r].id_cliente}t.rutas=a,n.stop()})},t.obtenerDepartamentos=function(){n.start(),g("DEP").then(function(a){t.departamentos=a.clases,n.stop()})},t.obtenerMunicipios=function(){n.start(),g("MUN").then(function(a){t.municipios=a.clases,n.stop()})},t.buscarMunicipios=function(a){s(a.nombre_corto+"M").then(function(a){t.municipios=a})},t.obtenerDias=function(){n.start(),g("DIAS").then(function(a){t.dias=a.clases,t.obtenerRutas(),n.stop()})},t.$on("$viewContentLoaded",function(){resaltarPestaña(e.path().substring(1)),ejecutarScriptsRuta("modal-wizard-ruta","modal-wizard-ruta-vista","dialog-eliminar-ruta","modal-wizard-container-ruta-edicion","modal-wizard-container-ruta-vista"),t.buscarAplicacion(t.usuario.aplicacionesUsuario,e.path().substring(1)),n.stop()}),t.abrirPopupRuta=function(a){t.formas=[],t.mostrarMap=!1,t.ruta=a,p.then(function(e){t.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},t.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},t.generarMarcadores(t.ruta),t.dibujarRuta(a)}),t.abrirPopup("modal-wizard-ruta")},t.eliminarLineas=function(){t.polylines=[],t.ruta.segmentos=[];for(var a=0;a<t.formas.length;a++)t.formas[a].setMap(null)},t.dibujarRuta=function(a){if(t.polylines=[],a.segmentos.length>0)for(var e=0;e<a.segmentos.length;e++){for(var o=[],r=0;r<a.segmentos[e].length;r++)o.push({latitude:a.segmentos[e][r].lat,longitude:a.segmentos[e][r].lng});t.polylines.push({id:e+1,path:o,stroke:{color:"#69AA46",weight:3},editable:!0,draggable:!0,geodesic:!0,visible:!0})}t.drawingManagerOptions={drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.POLYLINE]},polylineOptions:{strokeColor:"#69AA46",strokeWeight:5}},t.markersAndCircleFlag=!0,t.drawingManagerControl={},t.drawingManagerEvents={polylinecomplete:function(a,e,o,r){for(var n=r[0],i=n.getPath(),s=[],l=0;l<i.getArray().length;l++)s.push(i.getArray()[l].toJSON());t.ruta.segmentos.push(s),t.formas.push(n)}}},t.seleccionarMarcador=function(a,e,o){"blue"==o.options.icon.strokeColor?(o.options.icon={path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"red",scale:3},t.ruta.clientes.splice(t.ruta.clientes.indexOf(o.id),1)):(o.options.icon={path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:"blue",scale:3},t.ruta.clientes.push(o.id))},t.generarMarcadores=function(a){var e=function(t,a,e,o,r,n,i){null==e&&(e="id");var s={latitude:o,longitude:r,title:"m"+t,options:n};return s[e]=i,s};t.markers=[];for(var o,r=[],n=0;n<t.clientes.length;n++){var i=$.grep(a.clientes,function(a){return a==t.clientes[n].id}).length>0?"blue":"red";o={labelContent:t.clientes[n].razon_social,labelAnchor:"8 35",labelClass:"marker-label",icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:i,scale:3}},r.push(e(n+1,t.map.bounds,null,t.clientes[n].latitud,t.clientes[n].longitud,o,t.clientes[n].id))}t.markers=r},t.mostrarMapa=function(){t.mostrarMap=!0,i(function(){t.$apply(function(){google.maps.event.trigger(t.map,"resize")})},2e3)},t.crearNuevaRuta=function(){var e=JSON.parse(a.usuario),o=new c({id_empresa:e.id_empresa,clientes:[],segmentos:[]});t.abrirPopupRuta(o)},t.verRuta=function(a){t.formas=[],t.mostrarMap=!1,t.ruta=a,p.then(function(e){t.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}}},t.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},t.generarMarcadores(t.ruta),t.dibujarRuta(a)}),t.abrirPopup("modal-wizard-ruta-vista")},t.cerrarPopPupVista=function(){t.cerrarPopup("modal-wizard-ruta-vista")},t.cerrarPopPupNuevaRuta=function(){t.cerrarPopup("modal-wizard-ruta")},t.modificarRuta=function(a){t.abrirPopupRuta(a)},t.mostrarConfirmacionEliminacion=function(a){t.ruta=new c(a),t.abrirPopup("dialog-eliminar-ruta")},t.cerrarConfirmacionEliminacion=function(){t.cerrarPopup("dialog-eliminar-ruta")},t.eliminarRuta=function(a){n.start(),t.cerrarConfirmacionEliminacion(),a.$delete(),t.mostrarMensaje("Eliminado exitosamente!"),t.recargarItemsTabla(),n.stop()},t.saveForm=function(a){"Siguiente"!=$("#siguiente").text().trim()&&(n.start(),a.segmentos=JSON.stringify(a.segmentos),a.id?c.update({idRuta:a.id},a,function(a){n.stop(),t.cerrarPopPupNuevaRuta(),t.mostrarMensaje(a.mensaje),t.recargarItemsTabla()}):a.$save(function(a){n.stop(),t.ruta=new c({}),t.cerrarPopPupNuevaRuta(),t.mostrarMensaje("¡Ruta creada con código "+a.id+"!"),t.recargarItemsTabla()},function(a){n.stop(),t.cerrarPopPupNuevaRuta(),t.mostrarMensaje("Ocurrio un problema al momento de guardar!"),t.recargarItemsTabla()}))},t.subirExcelRutas=function(a){var e,o,r=a.target.files;for(o=r[e=0];e!=r.length;++e){var i=new FileReader;o.name;i.onload=function(a){n.start();var e=a.target.result,o=XLSX.read(e,{type:"binary"}),r=o.SheetNames[0],i=2,s=o.Sheets[r],l=[];do{var u={};u.codigo=void 0!=s["A"+i]&&""!=s["A"+i]?s["A"+i].v.toString():null,u.razon_social=void 0!=s["B"+i]&&""!=s["B"+i]?s["B"+i].v.toString():null,u.nit=void 0!=s["C"+i]&&""!=s["C"+i]?s["C"+i].v.toString():null,u.direccion=void 0!=s["D"+i]&&""!=s["D"+i]?s["D"+i].v.toString():null,u.telefono1=void 0!=s["E"+i]&&""!=s["E"+i]?s["E"+i].v.toString():null,u.telefono2=void 0!=s["F"+i]&&""!=s["F"+i]?s["F"+i].v.toString():null,u.telefono3=void 0!=s["G"+i]&&""!=s["G"+i]?s["G"+i].v.toString():null,u.contacto=void 0!=s["H"+i]&&""!=s["H"+i]?s["H"+i].v.toString():null,u.ubicacion_geografica=void 0!=s["I"+i]&&""!=s["I"+i]?s["I"+i].v.toString():null,u.rubro=void 0!=s["J"+i]&&""!=s["J"+i]?s["J"+i].v.toString():null,u.categoria=void 0!=s["K"+i]&&""!=s["K"+i]?s["K"+i].v.toString():null,u.fecha1=void 0!=s["L"+i]&&""!=s["L"+i]?new Date(t.convertirFecha(s["L"+i].v.toString())):null,u.fecha2=void 0!=s["M"+i]&&""!=s["M"+i]?new Date(t.convertirFecha(s["M"+i].v.toString())):null,u.texto1=void 0!=s["N"+i]&&""!=s["N"+i]?s["N"+i].v.toString():null,u.texto2=void 0!=s["O"+i]&&""!=s["O"+i]?s["O"+i].v.toString():null,u.ruta1=void 0!=s["P"+i]&&""!=s["P"+i]?s["P"+i].v.toString():null,u.ruta2=void 0!=s["Q"+i]&&""!=s["Q"+i]?s["Q"+i].v.toString():null,u.ruta3=void 0!=s["R"+i]&&""!=s["R"+i]?s["R"+i].v.toString():null,l.push(u),i++,0}while(void 0!=s["A"+i]);t.guardarClientes(l),n.stop()},i.readAsBinaryString(o)}},t.guardarClientes=function(a){new m({clientes:a,id_empresa:t.usuario.id_empresa}).$save(function(a){n.stop(),t.mostrarMensaje(a.mensaje),t.recargarItemsTabla()},function(a){n.stop(),t.mostrarMensaje("Ocurrio un problema al momento de guardar!"),t.recargarItemsTabla()})},t.$on("$routeChangeStart",function(a,e){t.eliminarPopup("modal-wizard-ruta"),t.eliminarPopup("modal-wizard-ruta-vista"),t.eliminarPopup("dialog-eliminar-ruta")}),t.inicio()}]);