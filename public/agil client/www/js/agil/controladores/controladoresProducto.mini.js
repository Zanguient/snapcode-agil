angular.module("agil.controladores").controller("ControladorProductos",["$scope","$timeout","$filter","$window","$localStorage","$location","$templateCache","$route","blockUI","Producto","Productos","ProductosPaginador","ProductosEmpresa","ClasesTipo","Clases","ProductoKardex","ProductosEmpresaCreacion","DatoCodigoSiguienteProductoEmpresa","ListaProductosEmpresa","Paginator","ListaCuentasComprobanteContabilidad","DatosProducto","CatalogoProductos","ListaGruposProductoEmpresa","Tipos","ClasesTipoEmpresa","FieldViewer","ListaSubGruposProductoEmpresa","ListaGruposProductoUsuario","ReporteProductosKardex","GuardarProductosFormulacion","PreciosProductosEmpresa",function(o,e,t,i,a,n,l,r,d,s,c,u,m,v,p,M,g,h,f,P,b,_,x,w,S,E,F,C,V,B,I,D){d.start(),o.idModalWizardProductoKardex="modal-wizard-producto-kardex",o.idModalWizardProductoEdicion="modal-wizard-producto-edicion",o.idModalWizardProductoVista="modal-wizard-producto-vista",o.idModalEliminarProducto="dialog-eliminar-producto",o.idModalContenedorProductoEdicion="modal-wizard-container-producto-edicion",o.idModalContenedorProductoVista="modal-wizard-container-producto-vista",o.idModalContenedorProductoKardex="modal-wizard-container-producto-kardex",o.idImagenProducto="imagen-producto",o.idModalReporteProductosKardex="dialog-reporte-productos-kardex",o.idModalConceptoEdicion="dialog-conceptos",o.usuario=JSON.parse(a.usuario),o.inicio=function(){o.obtenerTipoProducto(),o.obtenerProductos(),o.obtenerSucursales(),o.obtenerGruposProductosEmpresaUsuario(),o.obtenerSubGruposProductosEmpresa(),o.obtenerTiposPrecio(),o.usarValuado=!0},o.obtenerColumnasAplicacion=function(){o.fieldViewer=F({crear:!0,id_empresa:o.usuario.id_empresa,configuracion:{publicado_panel:{value:"¿Publicado Panel?",show:!0},inventario_activado:{value:"¿Inventario Activado?",show:!0},codigo:{value:"Código",show:!0},nombre:{value:"Nombre",show:!0},imagen:{value:"Imagen",show:!0},unidad_medida:{value:"Unidad de Medida",show:!0},precio_unitario:{value:"Precio Unitario",show:!0},inventario_minimo:{value:"Inventario Mínimo",show:!0},descripcion_uno:{value:"Descripcion",show:!0},carac_esp_uno:{value:"Carac. Esp. 1",show:!0},carac_esp_dos:{value:"Carac. Esp. 2",show:!0},grupo:{value:"Grupo",show:!0},subgrupo:{value:"Subgrupo",show:!0},tipo_producto:{value:"Tipo Producto",show:!0}}},o.aplicacion.aplicacion.id),o.fieldViewer.updateObject()},o.obtenerGruposProductosEmpresaUsuario=function(){d.start(),V(o.usuario.id_empresa,o.usuario.id).then(function(e){d.stop(),e.length>0?o.gruposProducto=e:(o.gruposProducto=[],o.mostrarMensaje("Parece que el usuario actual no cuenta con grupos de productos."))}).catch(function(e){o.gruposProducto=[]})},o.reporteProductosKardex=function(e){d.start(),void 0==e.grupo&&(e.grupo=0),B(o.usuario.id_empresa,e).then(function(e){if(0==e.length)o.mostrarMensaje("No existen datos"),d.stop();else for(var t=0;t<e.length;t++)if(e[t]=o.generarKardexProductoReporte(e[t]),t===e.length-1){var i=[];i.push(["Código","Nombre","Unidad Medida","Saldo Fisico","Saldo Valuado"]);for(t=0;t<e.length;t++){var a=[];a.push(e[t].codigo),a.push(e[t].nombre),a.push(e[t].unidad_medida),a.push(e[t].detallesMovimiento[e[t].detallesMovimiento.length-1].saldoFisico),a.push(e[t].detallesMovimiento[e[t].detallesMovimiento.length-1].saldoV),i.push(a)}var n="SheetJS",l=new Workbook,r=sheet_from_array_of_arrays(i);r["!cols"]=[{wch:15},{wch:20},{wch:15},{wch:15}],l.SheetNames.push(n),l.Sheets[n]=r;var s=XLSX.write(l,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});saveAs(new Blob([s2ab(s)],{type:"application/octet-stream"}),"Catálogo productos.xlsx"),d.stop()}})},o.generarKardexProductoReporte=function(e){var t=e;o.Math=Math,t.detallesMovimiento.sort(function(o,e){return o.id-e.id});for(var i=0;i<t.detallesMovimiento.length;i++)t.detallesMovimiento[i].costo_unitario=Math.round(.87*t.detallesMovimiento[i].costo_unitario*100)/100,0==i&&"SALDO ANTERIOR"==t.detallesMovimiento[i].tipo?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].saldoFisico,t.detallesMovimiento[i].saldoValuado=t.detallesMovimiento[i].saldoValuado,t.detallesMovimiento[i].costo_unitario=Math.round(100*t.detallesMovimiento[i].costo_unitario/87*100)/100):0==i&&t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING&&t.detallesMovimiento[i].movimiento.clase.nombre_corto==o.diccionario.ING_INV_INICIAL?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].saldoFisico*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):0==i&&t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].saldoFisico*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):0==i&&t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_EGR?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].saldoFisico*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico+t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado+t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):t.detallesMovimiento[i].movimiento.venta?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico-t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado-t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre+" Nro. "+t.detallesMovimiento[i].movimiento.venta.factura):(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico-t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado-t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre),t.detallesMovimiento[i].saldoV=t.detallesMovimiento[i].saldoValuado.toFixed(2);return t},o.obtenerSubGruposProductosEmpresa=function(){C(o.usuario.id_empresa).then(function(e){o.subgruposProducto=e})},o.activoFijoAplicarDatePicker=function(){o.producto.activo_fijo&&e(function(){aplicarDatePickers()},400)},o.$on("$viewContentLoaded",function(){resaltarPestaña(n.path().substring(1)),ejecutarScriptsProducto(o.idModalWizardProductoEdicion,o.idModalWizardProductoVista,o.idModalWizardProductoKardex,o.idModalEliminarProducto,o.idModalContenedorProductoEdicion,o.idModalContenedorProductoVista,o.idModalContenedorProductoKardex,o.idImagenProducto,o.idModalReporteProductosKardex,o.idModalConceptoEdicion),o.buscarAplicacion(o.usuario.aplicacionesUsuario,n.path().substring(1)),o.obtenerColumnasAplicacion(),d.stop()}),o.crearNuevoProducto=function(){o.tipoDePrecio={eliminado:!1},o.steps=[{cabeza:"cabeza-datos-producto",cuerpo:"cuerpo-datos-producto"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"},{cabeza:"cabeza-tipo-producto",cuerpo:"cuerpo-tipo-producto"}],h(o.usuario.id_empresa).then(function(e){o.ultimo_codigo="FC"+e.ultimo_codigo,o.producto=new s({tiposPrecio:[],productosBase:[],id_empresa:o.usuario.id_empresa,imagen:"./img/icon-producto-default.png"}),o.usuario.empresa.usar_consumos||(o.producto.tipoProducto=$.grep(o.tipoProductos,function(e){return e.nombre_corto==o.diccionario.TIPO_PRODUCTO_BASE})[0]),o.producto.codigo="FC"+(e.ultimo_codigo+1),o.productoBaseSeleccion={},o.abrirPopup(o.idModalWizardProductoEdicion)})},o.verProducto=function(e){_(e.id).then(function(e){o.producto=e,o.producto.publicar_panel=1==o.producto.publicar_panel,o.producto.activar_inventario=1==o.producto.activar_inventario,o.producto.totalBase=0;for(var t=0;t<o.producto.productosBase.length;t++)o.producto.totalBase=o.producto.totalBase+o.producto.productosBase[t].productoBase.precio_unitario*o.producto.productosBase[t].formulacion;o.productoBaseSeleccion={},o.producto.almacenErp&&(o.producto.sucursal_erp=o.producto.almacenErp.sucursal,o.obtenerAlmacenes(o.producto.sucursal_erp.id)),o.abrirPopup(o.idModalWizardProductoVista)})},o.cerrarPopPupVista=function(){o.cerrarPopup(o.idModalWizardProductoVista)},o.cerrarPopPupEdicion=function(){o.cerrarPopup(o.idModalWizardProductoEdicion)},o.cerrarPopPupKardex=function(){o.obtenerProductos(),o.cerrarPopup(o.idModalWizardProductoKardex),o.search.inventario.lote=""},o.abrirModalReporteProductosKardex=function(){o.imp={},o.abrirPopup(o.idModalReporteProductosKardex)},o.cerrarModalReporteProductosKardex=function(){o.imp={},o.cerrarPopup(o.idModalReporteProductosKardex)},o.kardexProducto=function(e){o.producto=e,o.kardexproduto=null,o.filtro={},o.imp={},o.imp.sucursal=1==o.sucursales.length?o.sucursales[0]:null,o.imp.sucursal&&(o.obtenerAlmacenes(o.imp.sucursal.id),o.imp.almacen=1==o.almacenes.length?o.almacenes[0]:null),$("#modal-wizard-producto-kardex").dialog({closeOnEscape:!1}),o.abrirPopup(o.idModalWizardProductoKardex)},o.obtenerDetallesEmpresa=function(e,t,i,a,n){o.paginator=P(),o.paginator.column="razon_social",o.paginator.direccion="asc",o.filtroDetallesProducto={id_producto:e,id_almacen:t,fecha_inicio:i,fecha_fin:a,lote:n},o.paginator.callBack=o.filtroProductoKardex,o.paginator.getSearch("",o.filtroDetallesProducto,null)},o.buscarKardexProducto=function(e,t,i){d.start();var a=""==i.fechaInicioTexto||void 0==i.fechaInicioTexto?0:new Date(o.convertirFecha(i.fechaInicioTexto)),n=""==i.fechaFinTexto||void 0==i.fechaFinTexto?0:new Date(o.convertirFecha(i.fechaFinTexto)),l=""==i.lote||void 0==i.lote?0:i.lote;if(o.idProducto=e,o.idAlmacen=t.id,o.kardexproduto=null,0!=a){var r=M(e,t.id,0,a,l);r.then(function(e){var t=o.obtenerSaldo(e);(r=M(o.idProducto,o.idAlmacen,a,n,l)).then(function(e){0!=t&&e.unshift(t),o.generarKardexProducto(e),d.stop()})})}else o.obtenerDetallesEmpresa(o.idProducto,o.idAlmacen,a,n,l)},o.filtroProductoKardex=function(){M(o.paginator).then(function(e){o.generarKardexProducto(e.kardex),o.paginator.setPages(e.paginas),d.stop()})},o.generarKardexProducto=function(e){var t=o.producto;t.detallesMovimiento=e,o.Math=Math;for(var i=0;i<t.detallesMovimiento.length;i++)t.detallesMovimiento[i].movimiento?("III"!=t.detallesMovimiento[i].movimiento.clase.nombre_corto&&(t.detallesMovimiento[i].costo_unitario=Math.round(.87*t.detallesMovimiento[i].costo_unitario*100)/100),0==i&&"SALDO ANTERIOR"==t.detallesMovimiento[i].tipo?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].saldoFisico,t.detallesMovimiento[i].saldoValuado=t.detallesMovimiento[i].saldoValuado,t.detallesMovimiento[i].costo_unitario=Math.round(100*t.detallesMovimiento[i].costo_unitario/87*100)/100):0==i&&t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING&&t.detallesMovimiento[i].movimiento.clase.nombre_corto==o.diccionario.ING_INV_INICIAL?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].saldoFisico*t.detallesMovimiento[i].costo_unitario*100)/100,null!=t.detallesMovimiento[i].movimiento.compra?(t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre+" Nro. "+t.detallesMovimiento[i].movimiento.compra.factura,null!=t.detallesMovimiento[i].inventario?t.detallesMovimiento[i].lote=t.detallesMovimiento[i].inventario.lote:t.detallesMovimiento[i].lote=""):(t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre,null!=t.detallesMovimiento[i].inventario?t.detallesMovimiento[i].lote=t.detallesMovimiento[i].inventario.lote:t.detallesMovimiento[i].lote="")):0==i&&t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].saldoFisico*t.detallesMovimiento[i].costo_unitario*100)/100,null!=t.detallesMovimiento[i].movimiento.compra?(t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre+" Nro. "+t.detallesMovimiento[i].movimiento.compra.factura,null!=t.detallesMovimiento[i].inventario?t.detallesMovimiento[i].lote=t.detallesMovimiento[i].inventario.lote:t.detallesMovimiento[i].lote=""):(t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre,null!=t.detallesMovimiento[i].inventario?t.detallesMovimiento[i].lote=t.detallesMovimiento[i].inventario.lote:t.detallesMovimiento[i].lote="")):t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING?i>0?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico+t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado+t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre,null!=t.detallesMovimiento[i].inventario?t.detallesMovimiento[i].lote=t.detallesMovimiento[i].inventario.lote:t.detallesMovimiento[i].lote=""):(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre,null!=t.detallesMovimiento[i].inventario?t.detallesMovimiento[i].lote=t.detallesMovimiento[i].inventario.lote:t.detallesMovimiento[i].lote=""):t.detallesMovimiento[i].movimiento.venta?i>0?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico-t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado-t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre+" Nro. "+t.detallesMovimiento[i].movimiento.venta.factura):(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre+" Nro. "+t.detallesMovimiento[i].movimiento.venta.factura):i>0?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico-t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado-t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre),t.detallesMovimiento[i].saldoV=t.detallesMovimiento[i].saldoValuado.toFixed(2)):console.log(t.detallesMovimiento[i]);o.kardexproduto=t},o.verificarLote=function(e,t){""==e.lote&&o.buscarKardexProducto(o.producto.id,t,e)},o.obtenerSaldo=function(e){var t={};t.detallesMovimiento=e;for(var i=0;i<t.detallesMovimiento.length;i++)t.detallesMovimiento[i].costo_unitario=Math.round(.87*t.detallesMovimiento[i].costo_unitario*100)/100,0==i&&t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING&&t.detallesMovimiento[i].movimiento.clase.nombre_corto==o.diccionario.ING_INV_INICIAL?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].saldoFisico*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):0==i&&t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].saldoFisico*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):t.detallesMovimiento[i].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING?i>0?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico+t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado+t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):t.detallesMovimiento[i].movimiento.venta?i>0?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico-t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado-t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre+" Nro. "+t.detallesMovimiento[i].movimiento.venta.factura):(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre+" Nro. "+t.detallesMovimiento[i].movimiento.venta.factura):i>0?(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i-1].saldoFisico-t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(100*(t.detallesMovimiento[i-1].saldoValuado-t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario))/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre):(t.detallesMovimiento[i].saldoFisico=t.detallesMovimiento[i].cantidad,t.detallesMovimiento[i].saldoValuado=Math.round(t.detallesMovimiento[i].cantidad*t.detallesMovimiento[i].costo_unitario*100)/100,t.detallesMovimiento[i].tipo=t.detallesMovimiento[i].movimiento.clase.nombre),t.detallesMovimiento[i].saldoV=t.detallesMovimiento[i].saldoValuado.toFixed(2);return t.detallesMovimiento.length>0?(t.detallesMovimiento[t.detallesMovimiento.length-1].tipo="SALDO ANTERIOR",t.detallesMovimiento[t.detallesMovimiento.length-1].movimiento.compra=null,t.detallesMovimiento[t.detallesMovimiento.length-1].movimiento.venta=null,t.detallesMovimiento[t.detallesMovimiento.length-1]):0},o.generarPdfKardexProducto=function(e,t){d.start();var i=e.detallesMovimiento,a=new PDFDocument({size:"letter",margin:10}),n=a.pipe(blobStream()),l=0,r=0,s=200,c=0,u=1,m=Math.ceil(i.length/17);o.dibujarCabeceraPDFKardexProducto(a,1,m,e,t);for(var v=0;v<i.length&&c<=17;v++)a.rect(30,s-10,555,30).stroke(),i[v].movimiento.fecha=new Date(i[v].movimiento.fecha),a.text(i[v].movimiento.fecha.getDate()+"/"+(i[v].movimiento.fecha.getMonth()+1)+"/"+i[v].movimiento.fecha.getFullYear(),40,s-2),0==v?(a.text(i[v].tipo,90,s-2),a.text(i[v].costo_unitario,210,s-2,{width:50,align:"right"}),a.text(i[v].cantidad,265,s-2,{width:50,align:"right"}),l+=i[v].cantidad,a.text(i[v].saldoFisico,360,s-2,{width:50,align:"right"}),t&&(a.text(Math.round(i[v].cantidad*i[v].costo_unitario*100)/100,420,s-2,{width:50,align:"right"}),dsaldoValuado=r+l*i[v].costo_unitario,a.text(i[v].saldoV,510,s-2,{width:50,align:"right"}))):(a.text(i[v].tipo,90,s-6),i[v].movimiento.tipo.nombre_corto==o.diccionario.MOV_ING?(i[v].movimiento.compra&&a.text(i[v].movimiento.compra.proveedor.razon_social,90,s+2,{width:150}),a.text(i[v].costo_unitario,210,s-2,{width:50,align:"right"}),a.text(i[v].cantidad,265,s-2,{width:50,align:"right"}),l+=i[v].cantidad,a.text(i[v].saldoFisico,360,s-2,{width:50,align:"right"}),t&&(a.text(Math.round(i[v].cantidad*i[v].costo_unitario*100)/100,420,s-2,{width:50,align:"right"}),r+=l*i[v].costo_unitario,a.text(i[v].saldoV,510,s-2,{width:50,align:"right"}))):(i[v].movimiento.venta.cliente&&a.text(i[v].movimiento.venta.cliente.razon_social,90,s+2,{width:150}),a.text(i[v].costo_unitario,210,s-2,{width:50,align:"right"}),a.text(i[v].cantidad,310,s-2,{width:50,align:"right"}),l-=i[v].cantidad,a.text(i[v].saldoFisico,360,s-2,{width:50,align:"right"}),t&&(a.text(i[v].total,460,s-2,{width:50,align:"right"}),r=Math.round(100*(r+l*i[v].costo_unitario))/100,a.text(i[v].saldoV,510,s-2,{width:50,align:"right"})))),s+=30,17==++c&&(a.addPage({margin:0,bufferPages:!0}),s=200,c=0,u+=1,o.dibujarCabeceraPDFKardexProducto(a,u,m,e,t),a.font("Helvetica",8));a.end(),n.on("finish",function(){var o=n.toBlobURL("application/pdf");window.open(o,"_blank","location=no")}),d.stop()},o.usarValuadoKardex=function(){o.usarValuado=!o.usarValuado},o.dibujarCabeceraPDFKardexProducto=function(e,t,i,a,n){e.font("Helvetica-Bold",8),e.text(o.usuario.empresa.razon_social,30,15);var l=new Date,r=l.getMinutes();r<10&&(r="0"+r),1==n?(e.font("Helvetica-Bold",10),e.text(a.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,30,25,{align:"left"}),e.text("KARDEX PRODUCTO",0,65,{align:"center"}),e.font("Helvetica",10),e.text(a.detallesMovimiento[0].movimiento.almacen.sucursal.direccion,30,35,{align:"left"}),e.text("TELF.: "+a.detallesMovimiento[0].movimiento.almacen.sucursal.telefono1+"-"+a.detallesMovimiento[0].movimiento.almacen.sucursal.telefono2+"-"+a.detallesMovimiento[0].movimiento.almacen.sucursal.telefono3,30,45,{align:"left"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+t+" DE "+i,0,740,{align:"center"}),e.rect(30,90,555,70).stroke(),e.font("Helvetica-Bold",8),e.text("Producto : ",45,100),e.text("Descripcion : ",45,120),e.text("Unidad de Medida : ",45,140),e.font("Helvetica",7),e.text("Sucursal : "+a.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,475,100),e.text("Almacen : "+a.detallesMovimiento[0].movimiento.almacen.nombre,475,110),e.font("Helvetica-Bold",11).fillColor("red"),e.text("Codigo : "+a.codigo,475,120),e.font("Helvetica",8).fillColor("black"),e.text(a.nombre,120,100),e.text(a.descripcion,120,120),e.text(a.unidad_medida,120,140),e.rect(30,160,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,170),e.text("Detalle",100,170,{width:50}),e.text("c/u",250,170,{width:60}),e.rect(275,160,150,30).stroke(),e.text("Fisico",340,165,{width:50}),e.text("Valuado",485,165,{width:50}),e.rect(275,160,150,15).stroke(),e.text("Ingreso",290,180,{width:50}),e.text("Salida",340,180,{width:50}),e.text("Saldo",390,180,{width:50}),e.rect(425,160,160,15).stroke(),e.text("Ingreso",440,180,{width:50}),e.text("salida",490,180,{width:50}),e.text("Saldo",540,180,{width:50})):(e.font("Helvetica-Bold",10),e.text(a.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,30,25,{align:"left"}),e.text("KARDEX PRODUCTO",0,65,{align:"center"}),e.font("Helvetica",10),e.text(a.detallesMovimiento[0].movimiento.almacen.sucursal.direccion,30,35,{align:"left"}),e.text("TELF.: "+a.detallesMovimiento[0].movimiento.almacen.sucursal.telefono1+"-"+a.detallesMovimiento[0].movimiento.almacen.sucursal.telefono2+"-"+a.detallesMovimiento[0].movimiento.almacen.sucursal.telefono3,30,45,{align:"left"}),e.font("Helvetica-Bold",8),e.text("PÁGINA "+t+" DE "+i,0,740,{align:"center"}),e.rect(30,90,555,70).stroke(),e.font("Helvetica-Bold",8),e.text("Producto : ",45,100),e.text("Descripcion : ",45,120),e.text("Unidad de Medida : ",45,140),e.font("Helvetica",7),e.text("Sucursal : "+a.detallesMovimiento[0].movimiento.almacen.sucursal.nombre,475,100),e.text("Almacen : "+a.detallesMovimiento[0].movimiento.almacen.nombre,475,110),e.font("Helvetica-Bold",11).fillColor("red"),e.text("Codigo : "+a.codigo,475,120),e.font("Helvetica",8).fillColor("black"),e.text(a.nombre,120,100),e.text(a.descripcion,120,120),e.text(a.unidad_medida,120,140),e.rect(30,160,555,30).stroke(),e.font("Helvetica-Bold",8),e.text("Fecha",45,170),e.text("Detalle",100,170,{width:50}),e.text("c/u",250,170,{width:60}),e.rect(275,160,150,30).stroke(),e.text("Fisico",340,165,{width:50}),e.rect(275,160,150,15).stroke(),e.text("Ingreso",290,180,{width:50}),e.text("Salida",340,180,{width:50}),e.text("Saldo",390,180,{width:50})),e.font("Helvetica",7),e.text("usuario : "+o.usuario.nombre_usuario,475,740),e.text("fecha : "+l.getDate()+"/"+(l.getMonth()+1)+"/"+l.getFullYear()+"  "+l.getHours()+":"+r,475,750)},o.generarExcelKardexProducto=function(o,e){o.detallesMovimiento;d.start();var t=[];t.push(["Codigo","Producto","Fecha","Detalle","Ingreso","Salida","Lote","Fecha Vencimiento"]);for(var i=0;i<o.detallesMovimiento.length;i++){var a=[];if(a.push(o.codigo),a.push(o.nombre),o.detallesMovimiento[i].movimiento.fecha){var n=new Date(o.detallesMovimiento[i].movimiento.fecha);a.push(n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear())}else a.push(" ");o.detallesMovimiento[i].movimiento.venta?o.detallesMovimiento[i].movimiento.venta.cliente?a.push(o.detallesMovimiento[i].tipo+" "+o.detallesMovimiento[i].movimiento.venta.cliente.razon_social):a.push(o.detallesMovimiento[i].tipo):o.detallesMovimiento[i].movimiento.venta?a.push(" "):a.push(o.detallesMovimiento[i].tipo),7!=o.detallesMovimiento[i].movimiento.id_tipo&&o.detallesMovimiento[i].cantidad?a.push(o.detallesMovimiento[i].cantidad):a.push(" "),6!=o.detallesMovimiento[i].movimiento.id_tipo&&o.detallesMovimiento[i].cantidad?a.push(o.detallesMovimiento[i].cantidad):a.push(" "),null!=o.detallesMovimiento[i].inventario?(a.push(o.detallesMovimiento[i].inventario.lote),a.push(o.detallesMovimiento[i].inventario.fecha_vencimiento)):(a.push(o.detallesMovimiento[i].lote),a.push(" ")),t.push(a)}var l="SheetJS",r=new Workbook,s=sheet_from_array_of_arrays(t);r.SheetNames.push(l),r.Sheets[l]=s;var c=XLSX.write(r,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"REPORTE-USUARIOS.xlsx"),d.stop()},o.modificarProducto=function(e){o.tipoDePrecio={eliminado:!1},o.steps=[{cabeza:"cabeza-datos-producto",cuerpo:"cuerpo-datos-producto"},{cabeza:"cabeza-datos-adicionales",cuerpo:"cuerpo-datos-adicionales"},{cabeza:"cabeza-tipo-producto",cuerpo:"cuerpo-tipo-producto"}],_(e.id).then(function(e){o.producto=e,o.producto.publicar_panel=1==o.producto.publicar_panel,o.producto.activar_inventario=1==o.producto.activar_inventario,o.producto.totalBase=0;for(var t=0;t<o.producto.productosBase.length;t++)o.producto.totalBase=o.producto.totalBase+o.producto.productosBase[t].productoBase.precio_unitario*o.producto.productosBase[t].formulacion;o.productoBaseSeleccion={},o.producto.almacenErp&&(o.producto.sucursal_erp=o.producto.almacenErp.sucursal,o.obtenerAlmacenes(o.producto.sucursal_erp.id)),o.abrirPopup(o.idModalWizardProductoEdicion)})},o.mostrarConfirmacionEliminacion=function(e){o.producto=new s(e),o.abrirPopup(o.idModalEliminarProducto),console.log(e)},o.cerrarConfirmacionEliminacion=function(){o.cerrarPopup(o.idModalEliminarProducto)},o.eliminarProducto=function(e){d.start(),o.cerrarConfirmacionEliminacion(),e.$delete().then(function(e){console.log(e),o.mostrarMensaje(e.message)}),o.recargarItemsTabla(),d.stop()},o.obtenerSucursales=function(){for(var e=[],t=0;t<o.usuario.sucursalesUsuario.length;t++)e.push(o.usuario.sucursalesUsuario[t].sucursal);o.sucursales=e},o.obtenerAlmacenes=function(e){o.almacenes=[];var t=$.grep(o.sucursales,function(o){return o.id==e})[0];o.almacenes=t.almacenes},o.establecerAlmacen=function(e){o.id_almacen=e},o.saveForm=function(e,t){e&&("Siguiente"!=$("#siguiente").text().trim()&&o.guardarProducto(t,!0))},o.establecerProductoBase=function(e){o.productoBase={id:e.id,nombre:e.nombre,formulacion:0,unidad_medida:e.unidad_medida}},o.actualizarProducto=function(e){_(e.id).then(function(t){t.publicar_panel=e.publicar_panel,t.activar_inventario=e.activar_inventario,o.guardarProducto(t,!1)})},o.guardarProducto=function(e,t){d.start();var i=e.imagen;e.usuario=o.usuario.id,e.id?s.update({idProducto:e.id},e,function(e){if(null==e.signedRequest)d.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje("Actualizado Exitosamente!"),t&&o.recargarItemsTabla();else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(d.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje("Actualizado Exitosamente!"),t&&o.recargarItemsTabla()):alert("Could not upload file."))};for(var n=atob(i.split(",")[1]),l=[],r=0;r<n.length;r++)l.push(n.charCodeAt(r));var s=new Blob([new Uint8Array(l)],{type:"image/jpeg"}),c=new File([s],e.image_name,{type:"image/jpeg"});console.log(c),a.send(c)}}):e.$save(function(e){if(null==e.signedRequest)d.stop(),o.producto=new s({}),o.cerrarPopPupEdicion(),o.mostrarMensaje("Guardado Exitosamente!"),t&&o.recargarItemsTabla();else{var a=new XMLHttpRequest;a.open("PUT",e.signedRequest),a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(d.stop(),o.producto=new s({}),o.cerrarPopPupEdicion(),o.mostrarMensaje("Guardado Exitosamente!"),t&&o.recargarItemsTabla()):alert("Could not upload file."))};for(var n=atob(i.split(",")[1]),l=[],r=0;r<n.length;r++)l.push(n.charCodeAt(r));var c=new Blob([new Uint8Array(l)],{type:"image/jpeg"}),u=new File([c],e.image_name,{type:"image/jpeg"});a.send(u)}},function(e){d.stop(),o.cerrarPopPupEdicion(),o.mostrarMensaje("Ocurrio un problema al momento de guardar!"),t&&o.recargarItemsTabla()})},o.obtenerTipoProducto=function(){d.start(),v("TPS").then(function(e){o.tipoProductos=e.clases,d.stop()})},o.eliminarDetalleProductosBase=function(e){e.eliminado=!0,o.producto.totalBase=o.producto.totalBase-e.productoBase.precio_unitario*e.formulacion},o.agregarDetalleProductosBase=function(e,t){t.formulacion=e.formulacion,console.log(t),o.producto.productosBase.push({productoBase:t,formulacion:e.formulacion}),o.productoBase={},o.productoBaseSeleccion={},o.producto.totalBase=0;for(var i=0;i<o.producto.productosBase.length;i++)o.producto.totalBase=o.producto.totalBase+o.producto.productosBase[i].productoBase.precio_unitario*o.producto.productosBase[i].formulacion,console.log(o.producto.totalBase);console.log(o.producto.productosBase)},o.obtenerProductos=function(){o.paginator=P(),o.paginator.column="nombre",o.paginator.filter=o.grupo,o.paginator.callBack=o.buscarProductos,o.paginator.getSearch("",null,null)},o.buscarProducto=function(e){if(""!=e&&void 0!=e)return f(o.usuario.id_empresa,e)},o.buscarProductos=function(){d.start(),o.paginator.filter=void 0!==o.grupo?o.grupo:{id:0},u(o.usuario.id_empresa,o.paginator,o.usuario.id).then(function(e){if(e.hasErr)o.mostrarMensaje(e.mensaje);else{o.paginator.setPages(e.paginas),o.productos=e.productos;for(var t=0;t<o.productos.length;t++)o.productos[t].publicar_panel=1==o.productos[t].publicar_panel,o.productos[t].activar_inventario=1==o.productos[t].activar_inventario}d.stop()}).catch(function(e){var t=void 0!==e.stack&&null!==e.stack&&""!==e.stack?e.stack:null!==e.data&&void 0!==e.data&""!==e.data?e.data:"Error: se perdio la conexión con el servidor.";o.mostrarMensaje(t),d.stop()})},o.descargarCatalogo=function(e){if(d.start(),e)var t=["N°","Campo","Empleado","C.I.","Estado","Cargo"],i=[];else{t=["Código","Nombre","Unidad Medida","Precio Unitario","Descripcion","Inventario Mínimo","Grupo","Sub-grupo","Caracteristica Especial-1","Caracteristica Especial-2","Código de Fabrica","Comisión (%)","Alerta","Descuento","Descuento Elección"];var a=[{wch:10},{wch:20},{wch:15},{wch:15},{wch:25},{wch:15},{wch:7},{wch:9},{wch:20},{wch:20},{wch:15},{wch:10},{wch:8},{wch:10},{wch:15}];i=[]}var n=[];x(o.usuario.id_empresa,void 0!==o.grupo?o.grupo:{id:0},o.usuario.id).then(function(l){if(0==l.catalogo.length)return o.mostrarMensaje("No existen datos"),void d.stop();if(l.hasErr)o.mostrarMensaje(l.mensaje);else{for(var r=0;r<l.catalogo.length;r++){if(e)var s=[];else s=[];s.push(l.catalogo[r].codigo),s.push(l.catalogo[r].nombre),s.push(l.catalogo[r].unidad_medida),s.push(l.catalogo[r].precio_unitario),s.push(l.catalogo[r].descripcion),s.push(l.catalogo[r].inventario_minimo),s.push(null!==l.catalogo[r].grupo&&void 0!==l.catalogo[r].grupo?l.catalogo[r].grupo.nombre:"Sin grupo"),s.push(null!==l.catalogo[r].subgrupo&&void 0!==l.catalogo[r].subgrupo?l.catalogo[r].subgrupo.nombre:"Sin subgrupo"),s.push(l.catalogo[r].caracteristica_especial1),s.push(l.catalogo[r].caracteristica_especial2),s.push(l.catalogo[r].codigo_fabrica),s.push(l.catalogo[r].comision),s.push(l.catalogo[r].alerta),s.push(l.catalogo[r].descuento),s.push(l.catalogo[r].descuento_fijo),n.push(s)}if(i.push(t),n.map(function(o){i.push(o)}),e)grafico?o.reportePorMesGrafico(i,mesesReporte):(d.stop(),o.reportePorMesesPdf(i,fromMonth,fromYear,untilMonth,untilYear));else{var c="SheetJS",u=new Workbook,m=sheet_from_array_of_arrays(i);m["!cols"]=a,u.SheetNames.push(c),u.Sheets[c]=m;var v=XLSX.write(u,{bookType:"xlsx",bookSST:!0,type:"binary",cellStyles:!0});saveAs(new Blob([s2ab(v)],{type:"application/octet-stream"}),"Catálogo productos.xlsx"),d.stop()}}}).catch(function(e){var t=void 0!==e.data&&null!==e.data?e.data+(void 0!==e.stack&&null!==e.stack?" "+e.stack:""):void 0!==e.message&&null!==e.message?e.message:"ERROR";o.mostrarMensaje("Se produjo un error! "+t),d.stop()})},o.subirExcelProductos=function(e){var t,i,a=e.target.files;for(i=a[t=0];t!=a.length;++t){var n=new FileReader;i.name;n.onload=function(e){d.start();var t=e.target.result,i=XLSX.read(t,{type:"binary"}),a=i.SheetNames[0],n=2,l=i.Sheets[a],r=[];do{var s={};s.codigo=void 0!=l["A"+n]&&""!=l["A"+n]?l["A"+n].v.toString():null,s.nombre=void 0!=l["B"+n]&&""!=l["B"+n]?l["B"+n].v.toString():null,s.unidad_medida=void 0!=l["C"+n]&&""!=l["C"+n]?l["C"+n].v.toString():null,s.precio_unitario=void 0!=l["D"+n]&&""!=l["D"+n]?parseFloat(l["D"+n].v.toString()):null,s.descripcion=void 0!=l["E"+n]&&""!=l["E"+n]?l["E"+n].v.toString():null,s.inventario_minimo=void 0!=l["F"+n]&&""!=l["F"+n]?parseInt(l["F"+n].v.toString()):null,s.grupo=void 0!=l["G"+n]&&""!=l["G"+n]?l["G"+n].v.toString():null,s.subgrupo=void 0!=l["H"+n]&&""!=l["H"+n]?l["H"+n].v.toString():null,s.caracteristica_especial1=void 0!=l["I"+n]&&""!=l["I"+n]?l["I"+n].v.toString():null,s.caracteristica_especial2=void 0!=l["J"+n]&&""!=l["J"+n]?l["J"+n].v.toString():null,s.codigo_fabrica=void 0!=l["K"+n]&&""!=l["K"+n]?l["K"+n].v.toString():null,s.comision=void 0!=l["L"+n]&&""!=l["L"+n]?parseFloat(l["L"+n].v.toString()):null,s.alerta=void 0!=l["M"+n]&&""!=l["M"+n]?parseFloat(l["M"+n].v.toString()):null,s.descuento=void 0!=l["N"+n]&&""!=l["N"+n]?parseFloat(l["N"+n].v.toString()):null,s.descuento_fijo=void 0!=l["O"+n]&&""!=l["N"+n]?1==parseInt(l["O"+n].v.toString()):null,s.marca=void 0!=l["P"+n]&&""!=l["P"+n]?l["P"+n].v.toString():null,s.tipo_producto=void 0!=l["Q"+n]&&""!=l["Q"+n]?l["Q"+n].v.toString():null,r.push(s),n++,0}while(void 0!=l["A"+n]);o.guardarProductos(r),d.stop()},n.readAsBinaryString(i)}},o.guardarProductos=function(e){new g({productos:e,id_empresa:o.usuario.id_empresa}).$save(function(e){d.stop(),o.mostrarMensaje("Guardado Exitosamente!"),o.recargarItemsTabla()},function(e){d.stop(),o.mostrarMensaje("Ocurrio un problema al momento de guardar!"),o.recargarItemsTabla()})},o.subirExcelProductosPrecio=function(e){var t,i,a=e.target.files;for(i=a[t=0];t!=a.length;++t){var n=new FileReader;i.name;n.onload=function(e){d.start();var t=e.target.result,i=XLSX.read(t,{type:"binary"}),a=i.SheetNames[0],n=2,l=i.Sheets[a],r=[];do{var s={};s.codigo=void 0!=l["A"+n]&&""!=l["A"+n]?l["A"+n].v.toString():null,s.tipoPrecio=void 0!=l["B"+n]&&""!=l["B"+n]?l["B"+n].v.toString():null,s.tipoPrecio=o.tiposPrecios.clases.find(function(o){return s.tipoPrecio.toUpperCase()==o.nombre.toUpperCase()}),s.precio_unitario=void 0!=l["C"+n]&&""!=l["C"+n]?parseFloat(l["C"+n].v.toString()):null,s.rango_positivo=void 0!=l["D"+n]&&""!=l["D"+n]?parseFloat(l["D"+n].v.toString()):null,s.rango_negativo=void 0!=l["E"+n]&&""!=l["E"+n]?parseFloat(l["E"+n].v.toString()):null,r.push(s),n++,0}while(void 0!=l["A"+n]);o.guardarPreciosProductos(r),d.stop()},n.readAsBinaryString(i)}},o.guardarPreciosProductos=function(e){new D(e,o.usuario.id_empresa).then(function(e){d.stop(),o.mostrarMensaje("Guardado Exitosamente!"),o.recargarItemsTabla()})},o.subirExcelFormulacionProductos=function(e){var t,i,a=e.target.files;for(i=a[t=0];t!=a.length;++t){var n=new FileReader;i.name;n.onload=function(e){d.start();var t=e.target.result,i=XLSX.read(t,{type:"binary"}),a=i.SheetNames[0],n=2,l=i.Sheets[a],r=[];do{var s={};s.codigo_final=void 0!=l["A"+n]&&""!=l["A"+n]?l["A"+n].v.toString():null,s.nombre_final=void 0!=l["B"+n]&&""!=l["B"+n]?l["B"+n].v.toString():null,s.nombre_base=void 0!=l["C"+n]&&""!=l["C"+n]?l["C"+n].v.toString():null,s.codigo_base=void 0!=l["D"+n]&&""!=l["D"+n]?l["D"+n].v.toString():null,s.formulacion=void 0!=l["E"+n]&&""!=l["E"+n]?l["E"+n].v.toString():null,r.push(s),n++,0}while(void 0!=l["A"+n]);o.guardarFormulacionProductos(r),d.stop()},n.readAsBinaryString(i)}},o.guardarFormulacionProductos=function(e){I(o.usuario.id_empresa,e).then(function(e){e.hasErr?o.mostrarMensaje(e.mensajes):e.mensajes?o.mostrarMensaje(e.mensaje+e.mensajes):o.mostrarMensaje(e.mensaje),d.stop()}).catch(function(e){var t=void 0!==e.stack&&null!==e.stack?e.stack:void 0!==e.message&&null!==e.message?e.message:"Se perdió la conexión.";o.mostrarMensaje(t),d.stop()})},o.buscarCuenta=function(e){if(""!=e&&void 0!=e)return b(o.usuario.id_empresa,e)},o.abrirDialogConceptoEdicion=function(e){o.tipo_edicion=e,o.clase={},o.abrirPopup(o.idModalConceptoEdicion)},o.cerrarDialogConceptoEdicion=function(){o.cerrarPopup(o.idModalConceptoEdicion)},o.agregarConceptoEdicion=function(e){e.nombre&&e.nombre_corto&&(-1==o.tipo_edicion.clases.indexOf(e)&&o.tipo_edicion.clases.push(e),o.clase={})},o.modificarConceptoEdicion=function(e){o.clase=e},o.removerConceptoEdicion=function(o){o.eliminado=!0},o.guardarConceptoEdicion=function(e){d.start(),S.update({id_tipo:e.id},e,function(t){v(e.nombre_corto).then(function(t){e=t,d.stop(),o.cerrarDialogConceptoEdicion(),o.mostrarMensaje("Guardado Exitosamente!")})})},o.obtenerTiposPrecio=function(){d.start(),E("T_PAGO_PRODUCTO",o.usuario.id_empresa).then(function(e){o.tiposPrecios=e,d.stop()})},o.agregarTipoPrecio=function(e,t){e.tipoPrecio&&e.precio_unitario?(t.tipoprecio.$invalid=!1,t.PrecioProductoTipo.$invalid=!1,e.edit?o.tipoDePrecio={eliminado:!1}:(o.producto.tiposPrecio.push(e),o.tipoDePrecio={eliminado:!1})):(t.tipoprecio.$invalid=!0,t.PrecioProductoTipo.$invalid=!0)},o.editarTipoPrecioProducto=function(e){o.tipoDePrecio=e,o.tipoDePrecio.edit=!0},o.eliminarTipoPrecioProducto=function(e,t){e.id?e.eliminado=!0:o.producto.tiposPrecio.splice(t,1)},o.$on("$routeChangeStart",function(e,t){o.eliminarPopup(o.idModalWizardProductoEdicion),o.eliminarPopup(o.idModalWizardProductoVista),o.eliminarPopup(o.idModalEliminarProducto),o.eliminarPopup(o.idModalWizardProductoKardex),o.eliminarPopup(o.idModalReporteProductosKardex),o.eliminarPopup(o.idModalConceptoEdicion)}),o.inicio()}]);