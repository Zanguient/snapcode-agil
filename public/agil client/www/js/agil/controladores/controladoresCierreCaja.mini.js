angular.module("agil.controladores").controller("ControladorCierresCaja",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipo","Clases","CierreCaja","ListaCierresCaja","CierreCajaDatos","VentasContado","VentasCredito","PagosVenta","ConfiguracionImpresionEmpresaDato","ListaBancos","PagosCompra","ComprasContado","ComprasCredito","CierresCajaPendiente","Paginator","CierreCajaDatosItem",function(e,a,t,r,o,i,n,s,l,c,u,d,p,C,g,m,f,v,h,x,_,P){i.start(),e.idModalWizardCierreEdicion="modal-wizard-cierre",e.idModalDeposito="modal-deposito",e.idModalWizardCierreVista="modal-wizard-cierre-vista",e.idModalEliminarCierre="dialog-eliminar-cierre",e.idModalContenedorCierreEdicion="modal-wizard-container-cierre-edicion",e.idModalContenedorCierreVista="modal-wizard-container-cierre-vista",e.idModalDatosAdicionalesReporte="dialog-datos-adicionales-reporte-cierre",e.usuario=JSON.parse(a.usuario),e.inicio=function(){e.obtenerCierres(e.usuario.id_empresa),e.obtenerBancos(e.usuario.id_empresa),e.sucursalesUsuario="";for(var a=0;a<e.usuario.sucursalesUsuario.length;a++)e.sucursalesUsuario=e.sucursalesUsuario+e.usuario.sucursalesUsuario[a].sucursal.id,a+1!=e.usuario.sucursalesUsuario.length&&(e.sucursalesUsuario=e.sucursalesUsuario+",");n("DC").then(function(a){e.destinos=a.clases,i.stop()})},e.$on("$viewContentLoaded",function(){resaltarPestaÃ±a(t.path().substring(1)),ejecutarScriptsCierre(e.idModalWizardCierreEdicion,e.idModalContenedorCierreEdicion,e.idModalWizardCierreVista,e.idModalContenedorCierreVista,e.idModalEliminarCierre,e.idModalDeposito,e.idModalDatosAdicionalesReporte),e.buscarAplicacion(e.usuario.aplicacionesUsuario,t.path().substring(1))}),e.seleccionarCierresPendientes=function(a){for(var t=0;t<e.sucursales.length;t++)for(var r=0;r<sucursalesUsuario.length;r++)e.sucursales[t].id==sucursalesUsuario[r].id&&(e.sucursales[t].ticked=!0)},e.llenarCierresPendientes=function(e,a){e.cierresPendientesOpciones=[];for(var t=0;t<a.length;t++){var r={name:a[t].cierreCaja.usuario.nombre_usuario+" - "+a[t].cierreCaja.importe,maker:"",ticked:!1,id:a[t].id,importe:a[t].cierreCaja.importe,usuario:a[t].cierreCaja.usuario.nombre_usuario};e.cierresPendientesOpciones.push(r)}},e.cambiarCierrePendiente=function(e){console.log(e)},e.crearNuevoCierre=function(){var a=new Date,t=new Date,r=d(e.sucursalesUsuario,a,t,e.usuario.id,0);r.then(function(o){(r=p(e.sucursalesUsuario,a,t,e.usuario.id,0)).then(function(n){(r=C(e.sucursalesUsuario,a,t,e.usuario.id,0)).then(function(s){(r=f(e.sucursalesUsuario,a,t,e.usuario.id,0)).then(function(c){(r=v(e.sucursalesUsuario,a,t,e.usuario.id,0)).then(function(u){(r=h(e.sucursalesUsuario,a,t,e.usuario.id,0)).then(function(a){(r=x(e.sucursalesUsuario)).then(function(t){var r=!1;e.nuevosCierresCaja=[];for(var d=0;d<e.usuario.sucursalesUsuario.length;d++)e.cierreCaja=new l({fecha:new Date,id_empresa:e.usuario.id_empresa,id_usuario:e.usuario.id,saldo_inicial:0,gastos:0}),e.cierreCaja.ventasContado=$.grep(o,function(a){return a.almacen.id_sucursal==e.usuario.sucursalesUsuario[d].sucursal.id}),e.cierreCaja.ventasCredito=$.grep(n,function(a){return a.almacen.id_sucursal==e.usuario.sucursalesUsuario[d].sucursal.id}),e.cierreCaja.pagosVenta=$.grep(s,function(a){return a.venta.almacen.id_sucursal==e.usuario.sucursalesUsuario[d].sucursal.id}),e.cierreCaja.pagosCompra=$.grep(c,function(a){return a.compra.almacen.id_sucursal==e.usuario.sucursalesUsuario[d].sucursal.id}),e.cierreCaja.comprasContado=$.grep(u,function(a){return a.almacen.id_sucursal==e.usuario.sucursalesUsuario[d].sucursal.id}),e.cierreCaja.comprasCredito=$.grep(a,function(a){return a.almacen.id_sucursal==e.usuario.sucursalesUsuario[d].sucursal.id}),e.cierreCaja.cierresPendientesLeidos=$.grep(t,function(a){return a.id_sucursal==e.usuario.sucursalesUsuario[d].sucursal.id}),e.cierreCaja.sucursal=e.usuario.sucursalesUsuario[d].sucursal,e.cierreCaja.id_sucursal=e.usuario.sucursalesUsuario[d].sucursal.id,(e.cierreCaja.ventasContado.length>0||e.cierreCaja.ventasCredito.length>0||e.cierreCaja.pagosVenta.length>0||e.cierreCaja.pagosCompra.length>0||e.cierreCaja.comprasContado.length>0||e.cierreCaja.comprasCredito.length>0||e.cierreCaja.cierresPendientesLeidos.length>0)&&(r=!0,e.cierreCaja.cierresPendientes=[],e.cierreCaja.cierresPendientesLeidos.length>0&&e.llenarCierresPendientes(e.cierreCaja,e.cierreCaja.cierresPendientesLeidos),e.nuevosCierresCaja.push(e.cierreCaja));i.stop(),r?e.abrirPopup(e.idModalWizardCierreEdicion):(e.cerrarPopPupEdicion(),e.mostrarMensaje("No existen Movimientos!"))})})})})})})})},e.calcularImporteCierre=function(a){for(var t=0,r=0;r<a.cierresPendientes.length;r++)t+=a.cierresPendientes[r].importe;return a.importe=Math.round(100*(t+a.saldo_inicial+e.sumarVentasContado(a.ventasContado)+e.sumarVentasCredito(a.ventasCredito)-e.sumarComprasContado(a.comprasContado)-e.sumarComprasCredito(a.comprasCredito)+e.sumarPagosVenta(a.pagosVenta)-e.sumarPagosCompra(a.pagosCompra)-a.gastos))/100,a.importe},e.cerrarPopPupNuevoCierre=function(){e.cerrarPopup(e.idModalWizardCierreEdicion)},e.cerrarPopPupDeposito=function(){e.cerrarPopup(e.idModalDeposito)},e.verCierreCaja=function(a){e.cierreCaja=a,e.abrirPopup(e.idModalWizardCierreVista)},e.cerrarPopPupVista=function(){e.cerrarPopup(e.idModalWizardCierreVista)},e.cerrarPopPupEdicion=function(){e.cerrarPopup(e.idModalWizardCierreEdicion)},e.modificarCierre=function(a){e.cierreCaja=a,e.abrirPopup(e.idModalWizardCierreEdicion)},e.mostrarConfirmacionEliminacion=function(a){e.cierreCaja=new l(a),e.abrirPopup(e.idModalEliminarCierre)},e.cerrarConfirmacionEliminacion=function(){e.cerrarPopup(e.idModalEliminarCierre)},e.eliminarCierre=function(a){i.start(),e.cerrarConfirmacionEliminacion(),banco.$delete(),e.mostrarMensaje("Eliminado exitosamente!"),e.recargarItemsTabla(),i.stop()},e.cerrarCaja=function(a){var t=$("#siguiente").text().trim();if(console.log(t),"Siguiente"!=t){i.start();for(var r=0;r<a.length;r++)e.guardarCierreCaja(a[r]),e.generarReporteCierreCaja(a[r].sucursal,a[r],a[r].ventasContado,a[r].ventasCredito,a[r].pagosVenta,a[r].pagosCompra,a[r].comprasContado,a[r].comprasCredito,a[r].cierresPendientes);e.cerrarPopPupNuevoCierre(),e.recargarItemsTabla(),e.mostrarMensaje("Guardado Exitosamente!")}},e.mostrarDatosAdicionalesReporte=function(a){e.cierreCajaImpresion=a,e.abrirPopup(e.idModalDatosAdicionalesReporte)},e.cerrarPopupDatosAdicionalesReporte=function(){e.cerrarPopup(e.idModalDatosAdicionalesReporte)},e.imprimirCierreCaja=function(a){var t=P(a.id);t.then(function(r){a=r,e.cerrarPopup(e.idModalDatosAdicionalesReporte);var o=new Date,i=new Date;(t=d(e.sucursalesUsuario,o,i,a.id_usuario,a.id)).then(function(r){(t=p(e.sucursalesUsuario,o,i,a.id_usuario,a.id)).then(function(n){(t=C(e.sucursalesUsuario,o,i,a.id_usuario,a.id)).then(function(s){(t=f(e.sucursalesUsuario,o,i,a.id_usuario,a.id)).then(function(l){(t=v(e.sucursalesUsuario,o,i,a.id_usuario,a.id)).then(function(c){(t=h(e.sucursalesUsuario,o,i,a.id_usuario,a.id)).then(function(t){e.generarReporteCierreCaja(a.sucursal,a,r,n,s,l,c,t,a.cajasSiguienteTurnoCerradas)})})})})})})})},e.generarReporteCierreCaja=function(a,t,r,o,i,n,s,l,c){var u=g(e.usuario.id_empresa,0);console.log(t),u.then(function(u){var d=[612,792];if(u.usar){if(u.tamanoPapelCierreCaja.nombre_corto==e.diccionario.FACT_PAPEL_OFICIO)d=[612,936],e.imprimirReporteCierreCajaCartaOficio(a,d,t,r,o,i,n,s,l,c);else if(u.tamanoPapelCierreCaja.nombre_corto==e.diccionario.FACT_PAPEL_CARTA)d=[612,792],e.imprimirReporteCierreCajaCartaOficio(a,d,t,r,o,i,n,s,l,c);else if(u.tamanoPapelCierreCaja.nombre_corto==e.diccionario.FACT_PAPEL_MEDIOOFICIO)d=[612,468],e.imprimirReporteCierreCajaCartaOficio(a,d,t,r,o,i,n,s,l,c);else if(u.tamanoPapelCierreCaja.nombre_corto==e.diccionario.FACT_PAPEL_ROLLO){var p=r.length+o.length+i.length+n.length+s.length+l.length+c.length;if(t.conMovimientoProductos){for(var C=0;C<r.length;C++)p+=r[C].detallesVenta.length;for(C=0;C<o.length;C++)p+=o[C].detallesVenta.length;for(C=0;C<s.length;C++)p+=s[C].detallesCompra.length;for(C=0;C<l.length;C++)p+=l[C].detallesCompra.length}if(t.conSaldoProductos){for(C=0;C<r.length;C++)p+=r[C].detallesVenta.length;for(C=0;C<o.length;C++)p+=o[C].detallesVenta.length;for(C=0;C<s.length;C++)p+=s[C].detallesCompra.length;for(C=0;C<l.length;C++)p+=l[C].detallesCompra.length}g=p<=2?470:470+20*(p-2),console.log(p),d=[227,g],e.imprimirReporteCierreCajaRollo(a,d,t,r,o,i,n,s,l,c)}}else{var g;p=r.length+o.length+i.length+n.length+s.length+l.length+c.length;if(t.conMovimientoProductos){for(C=0;C<r.length;C++)p+=r[C].detallesVenta.length;for(C=0;C<o.length;C++)p+=o[C].detallesVenta.length;for(C=0;C<s.length;C++)p+=s[C].detallesCompra.length;for(C=0;C<l.length;C++)p+=l[C].detallesCompra.length}if(t.conSaldoProductos){for(C=0;C<r.length;C++)p+=r[C].detallesVenta.length;for(C=0;C<o.length;C++)p+=o[C].detallesVenta.length;for(C=0;C<s.length;C++)p+=s[C].detallesCompra.length;for(C=0;C<l.length;C++)p+=l[C].detallesCompra.length}g=p<=2?470:470+20*(p-2),console.log(p),d=[227,g],e.imprimirReporteCierreCajaRollo(a,d,t,r,o,i,n,s,l,c)}})},e.imprimirReporteCierreCajaCartaOficio=function(e,a,t,r,o,n,s,l,c,u){var d=new PDFDocument({size:a,margin:0}),p=d.pipe(blobStream());d.font("Helvetica-Bold",15),d.text("CIERRE DE CAJA",55,50),d.text("SUCURSAL: "+e.nombre,200,50),d.font("Helvetica-Bold",8),d.text("SALDO INICIAL: ",55,80),d.text(t.saldo_inicial,350,80),d.font("Helvetica-Bold",8),d.text("VENTAS AL CONTADO: ",55,100),d.font("Helvetica",8);for(var C=100,g=0,m=0,f=0,v=0;v<r.length;v++)d.text("No. "+r[v].factura,55,C+20),d.text(r[v].cliente.razon_social,100,C+20),d.text(r[v].total,300,C+20),g+=r[v].total,C+=20;d.font("Helvetica-Bold",8),d.text(g,350,100),d.font("Helvetica-Bold",8),d.text("VENTAS AL CREDITO: ",55,C+20),d.font("Helvetica",8);var h=C+20;C+=20;var x=0;for(v=0;v<o.length;v++)o[v].pagosVenta.length>0?o[v].pagosVenta[0].a_cuenta_anterior>0&&(d.text("No. "+o[v].factura,55,C+20),d.text(o[v].cliente.razon_social,100,C+20),d.text(o[v].pagosVenta[0].a_cuenta_anterior,300,C+20),x+=o[v].pagosVenta[0].a_cuenta_anterior,C+=20):o[v].a_cuenta&&(d.text("No. "+o[v].factura,55,C+20),d.text(o[v].cliente.razon_social,100,C+20),d.text(o[v].a_cuenta,300,C+20),x+=o[v].a_cuenta,C+=20);d.font("Helvetica-Bold",8),d.text(x,350,h),d.font("Helvetica-Bold",8),d.text("COMPRAS AL CONTADO: ",55,C+20),d.font("Helvetica",8);var _=C+20;C+=20;var P=0;for(v=0;v<l.length;v++)d.text("No. "+l[v].factura,55,C+20),d.text(l[v].proveedor.razon_social,100,C+20),d.text(l[v].total,300,C+20),P+=l[v].total,C+=20;d.font("Helvetica-Bold",8),d.text(P,350,_),d.text("COMPRAS AL CREDITO: ",55,C+20),d.font("Helvetica",8);var D=C+20;C+=20;var A=0;for(v=0;v<c.length;v++)c[v].pagosCompra.length>0?c[v].pagosCompra[0].a_cuenta_anterior>0&&(d.text("No. "+c[v].factura,55,C+20),d.text(c[v].proveedor.razon_social,100,C+20),d.text(c[v].pagosCompra[0].a_cuenta_anterior,300,C+20),A+=c[v].pagosCompra[0].a_cuenta_anterior,C+=20):c[v].a_cuenta&&(d.text("No. "+c[v].factura,55,C+20),d.text(c[v].proveedor.razon_social,100,C+20),d.text(c[v].a_cuenta,300,C+20),A+=c[v].a_cuenta,C+=20);d.font("Helvetica-Bold",8),d.text(A,350,D);var E=C+20;d.text("COBROS REALIZADOS: ",55,C+20),d.font("Helvetica",8),C+=20;for(v=0;v<n.length;v++)d.text("No. "+n[v].venta.factura,55,C+20),d.text(n[v].venta.cliente.razon_social,100,C+20),d.text(n[v].monto_pagado,300,C+20),m+=n[v].monto_pagado,C+=20;d.text(m,350,E),d.font("Helvetica-Bold",8);var O=C+20;d.text("PAGOS REALIZADOS: ",55,C+20),d.font("Helvetica",8),C+=20;for(v=0;v<s.length;v++)d.text("No. "+s[v].compra.factura,55,C+20),d.text(s[v].compra.proveedor.razon_social,100,C+20),d.text(s[v].monto_pagado,300,C+20),f+=s[v].monto_pagado,C+=20;d.text(f,350,O),d.font("Helvetica-Bold",8),d.text("GASTOS: ",55,C+40),d.text(t.gastos,350,C+40),d.text("SALDO FINAL CAJA: ",55,C+60),d.text(t.importe,350,C+60),d.text("---------------------------------------------                       ---------------------------------------------",0,C+100,{align:"center"}),d.text("ENTREGUE CONFORME                                     RECIBI CONFORME",0,C+130,{align:"center"}),d.end(),p.on("finish",function(){var e=p.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),i.stop()},e.imprimirReporteCierreCajaRollo=function(a,t,r,o,n,s,l,c,u,d){var p=new PDFDocument({size:t,margins:{top:10,bottom:10,left:10,right:20}}),C=p.pipe(blobStream());if(r.fecha=new Date(r.fecha),p.moveDown(2),p.font("Helvetica-Bold",8),p.text("CIERRE DE CAJA",{align:"center"}),p.text("SUCURSAL: "+a.nombre,{align:"center"}),p.text("DEL: "+r.fecha.getDate()+"/"+(r.fecha.getMonth()+1)+"/"+r.fecha.getFullYear(),{align:"center"}),d.length>0){p.moveDown(.4);var g=p.y;p.text("SALDO ANTERIORES TURNOS: ",{align:"left"}),p.font("Helvetica",8),p.moveDown(.4);for(var m=p.y,f=0,v=0;v<d.length;v++)p.text(d[v].cierreCaja?d[v].cierreCaja.usuario.nombre_usuario:d[v].usuario,60,m,{width:90}),p.text(d[v].cierreCaja?d[v].cierreCaja.importe:d[v].importe,150,m),f+=d[v].cierreCaja?d[v].cierreCaja.importe:d[v].importe,m+=20;p.font("Helvetica-Bold",8),p.text(f,0,g,{align:"right"}),p.y=m,p.moveDown(.4),p.x=10}p.moveDown(.4),p.font("Helvetica-Bold",8);var h=p.y;p.text("SALDO INICIAL: ",{align:"left",width:100}),p.text(r.saldo_inicial,0,h,{align:"right"}),p.x=10,p.moveDown(.8),p.font("Helvetica-Bold",8);var x=p.y;p.text("VENTAS AL CONTADO: ",{align:"left"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y,suma=0,sumaPago=0,sumaCobro=0;for(v=0;v<o.length;v++)p.text("No. "+o[v].factura,20,m),p.text(o[v].cliente.razon_social,60,m,{width:90}),p.text(o[v].total,150,m),suma+=o[v].total,m+=20;p.font("Helvetica-Bold",8),p.text(suma,0,x,{align:"right"}),p.y=m,p.moveDown(.4),p.x=10,p.font("Helvetica-Bold",8);var _=p.y;p.text("VENTAS AL CREDITO: ",{align:"left"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y;var P=0;for(v=0;v<n.length;v++)n[v].pagosVenta.length>0?n[v].pagosVenta[0].a_cuenta_anterior>0&&(p.text("No. "+n[v].factura,20,m),p.text(n[v].cliente.razon_social,60,m,{width:90}),p.text(n[v].pagosVenta[0].a_cuenta_anterior,150,m),P+=n[v].pagosVenta[0].a_cuenta_anterior,m+=20):(p.text("No. "+n[v].factura,20,m),p.text(n[v].cliente.razon_social,60,m,{width:90}),p.text(n[v].a_cuenta,150,m),P+=n[v].a_cuenta,m+=20);p.font("Helvetica-Bold",8),p.text(P,0,_,{align:"right"}),p.y=m,p.moveDown(.4),p.x=10,p.font("Helvetica-Bold",8);var D=p.y;p.text("COMPRAS AL CONTADO: ",{align:"left"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y;var A=0;for(v=0;v<c.length;v++)p.text("No. "+c[v].factura,20,m),p.text(c[v].proveedor.razon_social,60,m,{width:90}),p.text(c[v].total,150,m),A+=c[v].total,m+=20;p.font("Helvetica-Bold",8),p.text(A,0,D,{align:"right"}),p.y=m,p.moveDown(.4),p.x=10;var E=p.y;p.text("COMPRAS AL CREDITO: ",{align:"left"}),p.font("Helvetica",8),m=p.y;var O=0;for(v=0;v<u.length;v++)u[v].pagosCompra.length>0?u[v].pagosCompra[0].a_cuenta_anterior>0&&(p.text("No. "+u[v].factura,20,m),p.text(u[v].proveedor.razon_social,60,m),p.text(u[v].pagosCompra[0].a_cuenta_anterior,150,m),O+=u[v].pagosCompra[0].a_cuenta_anterior,m+=20):u[v].a_cuenta&&(p.text("No. "+u[v].factura,20,m),p.text(u[v].proveedor.razon_social,60,m),p.text(u[v].a_cuenta,150,m),O+=u[v].a_cuenta,m+=20);p.font("Helvetica-Bold",8),p.text(O,0,E,{align:"right"}),p.y=m,p.moveDown(.4),p.x=10;var j=p.y;p.text("COBROS REALIZADOS: ",{align:"left"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y;for(v=0;v<s.length;v++)p.text("No. "+s[v].venta.factura,20,m),p.text(s[v].venta.cliente.razon_social,60,m,{width:90}),p.text(s[v].monto_pagado,150,m),sumaPago+=s[v].monto_pagado,m+=20;p.font("Helvetica-Bold",8),p.text(sumaPago,0,j,{align:"right"}),p.y=m,p.moveDown(.4),p.x=10;var R=p.y;p.text("PAGOS REALIZADOS: ",{align:"left"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y;for(v=0;v<l.length;v++)p.text("No. "+l[v].compra.factura,20,m),p.text(l[v].compra.proveedor.razon_social,60,m,{width:90}),p.text(l[v].monto_pagado,150,m),sumaCobro+=l[v].monto_pagado,m+=20;if(p.font("Helvetica-Bold",8),p.text(sumaCobro,0,R,{align:"right"}),p.y=m,p.moveDown(.4),p.x=10,p.font("Helvetica-Bold",8),h=p.y,p.text("GASTOS: ",{align:"left"}),p.text(r.gastos,0,h,{align:"right"}),p.x=10,p.moveDown(.4),h=p.y,p.text("SALDO FINAL CAJA: ",{align:"left"}),p.text(r.importe,0,h,{align:"right"}),p.moveDown(1.6),p.x=10,r.conMovimientoProductos){p.font("Helvetica-Bold",8),p.text("RESUMEN MOVIMIENTOS VENTA PRODUCTOS: ",{align:"center"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y;for(v=0;v<o.length;v++)for(var V=0;V<o[v].detallesVenta.length;V++)p.text(o[v].detallesVenta[V].cantidad,20,m),p.text(o[v].detallesVenta[V].producto.nombre,50,m,{width:100}),p.text(o[v].detallesVenta[V].total,160,m),m+=20;for(v=0;v<n.length;v++)for(V=0;V<n[v].detallesVenta.length;V++)p.text(n[v].detallesVenta[V].cantidad,20,m),p.text(n[v].detallesVenta[V].producto.nombre,50,m,{width:100}),p.text(n[v].detallesVenta[V].total,160,m),m+=20;p.y=m,p.moveDown(.4),p.x=10,p.font("Helvetica-Bold",8),p.text("RESUMEN MOVIMIENTOS COMPRA PRODUCTOS: ",{align:"center"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y;for(v=0;v<c.length;v++)for(V=0;V<c[v].detallesCompra.length;V++)p.text(c[v].detallesCompra[V].cantidad,20,m),p.text(c[v].detallesCompra[V].producto.nombre,50,m,{width:100}),p.text(c[v].detallesCompra[V].total,160,m),m+=20;for(v=0;v<u.length;v++)for(V=0;V<u[v].detallesCompra.length;V++)p.text(u[v].detallesCompra[V].cantidad,20,m),p.text(u[v].detallesCompra[V].producto.nombre,50,m,{width:100}),p.text(u[v].detallesCompra[V].total,160,m),m+=20;p.y=m,p.moveDown(.4),p.x=10}if(r.conSaldoProductos){p.font("Helvetica-Bold",8),p.text("RESUMEN SALDOS DE VENTA PRODUCTOS: ",{align:"center"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y;for(v=0;v<o.length;v++)for(V=0;V<o[v].detallesVenta.length;V++){p.text(o[v].detallesVenta[V].producto.nombre,50,m,{width:100});for(var w=0,M=0;M<o[v].detallesVenta[V].producto.inventarios.length;M++)o[v].detallesVenta[V].producto.inventarios[M].almacen.id_sucursal==a.id&&(w+=o[v].detallesVenta[V].producto.inventarios[M].cantidad);p.text(w+" Und.",160,m),m+=20}for(v=0;v<n.length;v++)for(V=0;V<n[v].detallesVenta.length;V++){p.text(n[v].detallesVenta[V].producto.nombre,50,m,{width:100});for(w=0,M=0;M<n[v].detallesVenta[V].producto.inventarios.length;M++)n[v].detallesVenta[V].producto.inventarios[M].almacen.id_sucursal==a.id&&(w+=n[v].detallesVenta[V].producto.inventarios[M].cantidad);p.text(w+" Und.",160,m),m+=20}p.y=m,p.moveDown(.4),p.x=10,p.font("Helvetica-Bold",8),p.text("RESUMEN SALDOS DE COMPRA PRODUCTOS: ",{align:"center"}),p.font("Helvetica",8),p.moveDown(.4),m=p.y;for(v=0;v<c.length;v++)for(V=0;V<c[v].detallesCompra.length;V++){p.text(c[v].detallesCompra[V].producto.nombre,50,m,{width:100});for(w=0,M=0;M<c[v].detallesCompra[V].producto.inventarios.length;M++)c[v].detallesCompra[V].producto.inventarios[M].almacen.id_sucursal==a.id&&(w+=c[v].detallesCompra[V].producto.inventarios[M].cantidad);p.text(w+" Und.",160,m),m+=20}for(v=0;v<u.length;v++)for(V=0;V<u[v].detallesCompra.length;V++){p.text(u[v].detallesCompra[V].producto.nombre,50,m,{width:100});for(w=0,M=0;M<u[v].detallesCompra[V].producto.inventarios.length;M++)u[v].detallesCompra[V].producto.inventarios[M].almacen.id_sucursal==a.id&&(w+=u[v].detallesCompra[V].producto.inventarios[M].cantidad);p.text(w+" Und.",160,m),m+=20}p.y=m,p.moveDown(.4),p.x=10}p.font("Helvetica-Bold",8),p.x=10,p.text("-----------------------------      -----------------------------",0,m+100,{align:"center"}),p.text("ENTREGUE CONFORME   RECIBI CONFORME",{align:"center"}),p.moveDown(.4),p.font("Helvetica",8);var S=new Date;p.text("Usuario: "+e.usuario.nombre_usuario+" "+S.getDate()+"/"+(S.getMonth()+1)+"/"+S.getFullYear()+" "+S.getHours()+":"+S.getMinutes(),{align:"center"}),p.end(),C.on("finish",function(){var e=C.toBlobURL("application/pdf");window.open(e,"_blank","location=no")}),i.stop()},e.sumarVentasContado=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].total;return a},e.sumarVentasCredito=function(e){for(var a=0,t=0;t<e.length;t++)e[t].pagosVenta.length>0?e[t].pagosVenta[0].a_cuenta_anterior>0&&(a+=e[t].pagosVenta[0].a_cuenta_anterior):a+=e[t].a_cuenta;return a},e.sumarComprasContado=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].total;return a},e.sumarComprasCredito=function(e){for(var a=0,t=0;t<e.length;t++)e[t].pagosCompra.length>0?e[t].pagosCompra[0].a_cuenta_anterior>0&&(a+=e[t].pagosCompra[0].a_cuenta_anterior):e[t].a_cuenta&&(a+=e[t].a_cuenta);return a},e.sumarPagosVenta=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].monto_pagado;return a},e.sumarPagosCompra=function(e){for(var a=0,t=0;t<e.length;t++)a+=e[t].monto_pagado;return a},e.guardarCierreCaja=function(a){i.start(),a.$save(function(e){i.stop()},function(a){i.stop(),e.cerrarPopPupNuevoCierre(),e.mostrarMensaje("Ocurrio un problema al momento de guardar!"),e.recargarItemsTabla()})},e.guardarDeposito=function(a){i.start(),a.fecha_entrega=new Date(e.convertirFecha(a.fechaEntregaTexto)),u.update({id_cierre_caja:a.id},a,function(a){i.stop(),e.cerrarPopPupDeposito(),e.mostrarMensaje("Guardado Exitosamente!"),e.recargarItemsTabla()})},e.obtenerCierres=function(a){e.paginator=_(),e.paginator.column="fecha",e.paginator.direction="desc",e.paginator.callBack=e.obtenerLista;var t=$.grep(e.usuario.rolesUsuario,function(a){return a.rol.nombre==e.diccionario.ROL_ADMINISTRADOR}).length>0?0:e.usuario.id;e.filtro={empresa:e.usuario.id_empresa,usuario:t},e.paginator.getSearch("",e.filtro,null)},e.obtenerLista=function(){i.start(),c(e.paginator).then(function(a){e.paginator.setPages(a.paginas),e.cierresCaja=a.cierresCaja,i.stop()})},e.abrirPopupDeposito=function(a){e.cierreCaja=a,e.abrirPopup(e.idModalDeposito)},e.obtenerBancos=function(a){i.start(),m(a).then(function(a){e.bancos=a,i.stop()})},e.$on("$routeChangeStart",function(a,t){e.eliminarPopup(e.idModalWizardCierreEdicion),e.eliminarPopup(e.idModalWizardCierreVista),e.eliminarPopup(e.idModalEliminarCierre),e.eliminarPopup(e.idModalDeposito),e.eliminarPopup(e.idModalDatosAdicionalesReporte)}),e.inicio()}]);