angular.module("agil.controladores").controller("ControladorCajaChica",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipoEmpresa","ClasesTipo","GuardarSolicitudCajaChica","GuardarConceptoMovimientoCajaChica","ObtenerConceptoMovimientoCajaChica","SolicitudesCajaPaginador","SolicitudesCajaChicaPaginador","ObtenerTodoPersonal","$filter","Paginator","VerificarUsuarioEmpresa","NuevoComprobante","ConfiguracionCompraVista","ConfiguracionesCuentasEmpresa","ConfiguracionCompraVistaDatos","ProveedoresNit","GuardarCajaChica","ListaProductosEmpresaUsuario","VerificarUsuarioEmpresaCaja","IngresosCajaPaginador","ObtenerDatosCierreCaja","CierreCajaCPaginador","FieldViewer","ObtenerImagen",function(a,o,i,e,c,t,r,n,s,l,u,d,p,C,m,h,j,f,g,_,v,b,M,P,S,E,I,O,A,D){a.usuario=JSON.parse(o.usuario),a.idModalSolicitudCajaChica="dialog-solicitud",a.idModalConceptosMovimiento="dialog-conceptos-movimiento",a.idModalEliminarSolicitud="dialog-eliminar-solicitud",a.idModalVerificarAutorizacion="modal-verificar-autorizacion",a.idModalRegistroCajaChica="dialog-registro-caja-chica",a.idModalKardexCajaChica="dialog-kardex-caja-chica",a.idModalIngresosCajaChica="dialog-kardex-ingresos",a.idModalRegistroIngresoCajaChica="dialog-registro-ingreso-caja-chica",a.idModalHistorialCierreCajaChica="dialog-kardex-cierre-caja-chica",a.idModalRegistroDesembolsoCajaChica="dialog-registro-desembolso-caja-chica",a.idModalServicios="dialog-servicios",a.idModalRegistroAnticipoCajaChica="dialog-registro-anticipo-caja-chica",a.inicio=function(){a.sucursales=a.obtenerSucursales(),a.sucursalPrincipal=a.usuario.sucursalesUsuario[0].sucursal,a.obtenerTiposMovimiento(),a.obtenerConceptosMovimiento(),a.obtenerTiposEstados(),a.obtenerListaSolicitudes(),a.obtenerMovimientosIngreso(),a.obtenerTiposDePago(),a.obtenerCentrosDeCosto(),a.obtenerConfiguracionCompraVista(),a.obtenerconfiuracionCuentas(),a.obtenerServicios(),a.ConceptosMovimiento=[],a.tipoFiltro="TODOS",a.verificacionDatos=!0},a.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),ejecutarScriptsCajaChicas(a.idModalSolicitudCajaChica,a.idModalConceptosMovimiento,a.idModalEliminarSolicitud,a.idModalVerificarAutorizacion,a.idModalRegistroCajaChica,a.idModalKardexCajaChica,a.idModalIngresosCajaChica,a.idModalRegistroIngresoCajaChica,a.idModalHistorialCierreCajaChica,a.idModalRegistroDesembolsoCajaChica,a.idModalServicios,a.idModalRegistroAnticipoCajaChica),a.buscarAplicacion(a.usuario.aplicacionesUsuario,i.path().substring(1)),a.obtenerColumnasAplicacion(),t.stop()}),a.obtenerColumnasAplicacion=function(){a.fieldViewer=A({crear:!0,id_empresa:a.usuario.id_empresa,configuracion:{usuario_solicitante:{value:"usuario_solicitante",show:!0},fecha:{value:"fecha",show:!0},beneficiario:{value:"Beneficiario",show:!0},autorizador:{value:"Autorizador",show:!0},verificador:{value:"Verificador",show:!0},movimiento:{value:"Movimiento",show:!0},concepto:{value:"Concepto",show:!0},detalle:{value:"Detalle",show:!0},estado:{value:"Estado",show:!0},monto:{value:"Monto",show:!0}}},a.aplicacion.aplicacion.id),a.fieldViewer.updateObject()},a.abrirModalConceptosMovimiento=function(){a.clase={edit:!1},a.abrirPopup(a.idModalConceptosMovimiento)},a.cerrarModalConceptosMovimiento=function(){a.cerrarPopup(a.idModalConceptosMovimiento)},a.abrirModalKardexCajaChica=function(o){a.solicitud=o,a.abrirPopup(a.idModalKardexCajaChica)},a.cerrarModalKardexCajaChica=function(){a.cerrarPopup(a.idModalKardexCajaChica)},a.abrirModalIngresosCajaChica=function(){a.obtenerListaIngresos(),a.abrirPopup(a.idModalIngresosCajaChica)},a.cerrarModalIngresosCajaChica=function(){a.cerrarPopup(a.idModalIngresosCajaChica)},a.abrirModalHistorialCierreCajaChica=function(){a.obtenerListaCierresCajaChica(),a.abrirPopup(a.idModalHistorialCierreCajaChica)},a.cerrarModalHistorialCierreCajaChica=function(){a.cerrarPopup(a.idModalHistorialCierreCajaChica)},a.abrirModalEliminarSolicitud=function(o){a.solicitud=o,a.abrirPopup(a.idModalEliminarSolicitud)},a.cerrarModalEliminarSolicitud=function(){a.cerrarPopup(a.idModalEliminarSolicitud)},a.abrirModalRegistroCajaChica=function(o,i,e,c){if(o){if(a.solicitud=o,i)c?(a.cajaChica=Object.assign({},c),a.cajaChica.compra=Object.assign({},c.compra),a.cajaChica.solicitud=Object.assign({},o),a.cajaChica.solicitud.cajasChicas[0].saldo+=a.cajaChica.compra.total,a.cajaChica.verDatosCompra=!0,a.cajaChica.descuentoGasolina=!1,a.cajaChica.fecha.length>10&&(a.cajaChica.fecha=a.fechaATexto(a.cajaChica.fecha)),a.cajaChica.compra.fechaTexto=a.fechaATexto(c.compra.fecha)):(a.cajaChica=Object.assign({},o.cajasChicas[0]),a.cajaChica.compra=Object.assign({},o.cajasChicas[0].compra),a.cajaChica.solicitud=Object.assign({},o),a.cajaChica.solicitud.cajasChicas[0].saldo+=a.cajaChica.compra.total,a.cajaChica.verDatosCompra=!0,a.cajaChica.descuentoGasolina=!1,a.cajaChica.fecha.length>10&&(a.cajaChica.fecha=a.fechaATexto(a.cajaChica.fecha)),a.cajaChica.compra.fechaTexto=a.fechaATexto(o.cajasChicas[0].compra.fecha)),void 0==a.cajaChica.compra.movimiento&&(a.cajaChica.compra.movimiento={clase:{}},a.cajaChica.compra.movimiento.clase=a.cajaChica.compra.tipoMovimiento),a.cajaChica.compra.movimiento.clase.nombre==a.diccionario.MOVING_POR_RETENCION_BIENES||a.cajaChica.compra.movimiento.clase.nombre==a.diccionario.MOVING_POR_RETENCION_SERVICIOS?(a.configuracionCompraVista.mostrar_it_retencion=!0,a.configuracionCompraVista.mostrar_iue=!0,a.configuracionCompraVista.mostrar_pagado=!0):(a.configuracionCompraVista.mostrar_it_retencion=!1,a.configuracionCompraVista.mostrar_iue=!1,a.configuracionCompraVista.mostrar_pagado=!1);else{if(o.cajasChicas.length>0)var t=0;else t=0;a.cajaChica={fecha:a.fechaATexto(new Date),concepto:o.concepto,detalle:o.detalle,compra:{sucursal:a.sucursalPrincipal,fecha:a.fechaATexto(new Date),generado_por_pedido:!1,usar_producto:!0,movimiento:{clase:{}},tipo_retencion:!0,total:t,id_empresa:a.usuario.id_empresa,id_usuario:a.usuario.id,proveedor:{},id_tipo_pago:a.tiposPago[0].id,tipoPago:a.tiposPago[0],detallesCompra:[],descuento_general:!1,tipo_descuento:!1,codigo_control:0,autorizacion:0,tipo_recargo:!1,descuento:0,recargo:0,ice:0,excento:0},solicitud:o,verDatosCompra:!1,descuentoGasolina:!1}}e?(a.cajaChica.ver=!0,a.cajaChica.verDatosCompra=!0):a.cajaChica.ver=!1}else c?(a.cajaChica=Object.assign({},c),a.cajaChica.compra=Object.assign({},c.compra),a.cajaChica.solicitud=null,a.cajaChica.verDatosCompra=!0,a.cajaChica.descuentoGasolina=!1,a.cajaChica.fecha.length>10&&(a.cajaChica.fecha=a.fechaATexto(a.cajaChica.fecha)),a.cajaChica.compra.fechaTexto=a.fechaATexto(c.compra.fecha)):a.cajaChica={fecha:a.fechaATexto(new Date),compra:{fecha:a.fechaATexto(new Date),generado_por_pedido:!1,usar_producto:!0,movimiento:{clase:{}},tipo_retencion:!0,total:"",id_empresa:a.usuario.id_empresa,id_usuario:a.usuario.id,proveedor:{},id_tipo_pago:a.tiposPago[0].id,tipoPago:a.tiposPago[0],detallesCompra:[],descuento_general:!1,tipo_descuento:!1,codigo_control:0,autorizacion:0,tipo_recargo:!1,descuento:0,recargo:0,ice:0,excento:0},solicitud:null,verDatosCompra:!1,descuentoGasolina:!1},e?(a.cajaChica.ver=!0,a.cajaChica.verDatosCompra=!0):a.cajaChica.ver=!1;a.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},a.cargarCentroCosto(a.detalleCompra),a.abrirPopup(a.idModalRegistroCajaChica)},a.cargarCentroCosto=function(o){a.centrosCosto.forEach(function(i,e,c){i.nombre==a.cajaChica.concepto.nombre?o.centroCosto=i:o.centroCosto.nombre=a.cajaChica.concepto.nombre})},a.abrirModalRegistroIngresoCajaChica=function(o,i){o?(a.cajaChica=o,a.cajaChica.fecha=a.fechaATexto(new Date(o.fecha)),a.cajaChica.total=o.monto,a.cajaChica.sucursal=a.sucursalPrincipal):a.cajaChica={fecha:a.fechaATexto(new Date),solicitud:null,verDatosCompra:!1,descuentoGasolina:!1,sucursal:a.sucursalPrincipal},i&&(a.cajaChica.ver=!0),a.abrirPopup(a.idModalRegistroIngresoCajaChica)},a.abrirModalRegistroAnticipoCajaChica=function(o,i){o?(a.cajaChica={},a.cajaChica.solicitud=o,a.cajaChica.concepto=o.concepto,a.cajaChica.detalle=o.detalle,a.cajaChica.fecha=a.fechaATexto(new Date(o.fecha)),a.cajaChica.total=o.monto,a.cajaChica.sucursal=a.sucursalPrincipal):a.cajaChica={fecha:a.fechaATexto(new Date),solicitud:null,verDatosCompra:!1,descuentoGasolina:!1,sucursal:a.sucursalPrincipal},i&&(a.cajaChica.ver=!0),a.cajaChica.Desembolso=!0,a.cajaChica.Anticipo=!0,a.abrirPopup(a.idModalRegistroAnticipoCajaChica)},a.cerrarModalRegistroAnticipoCajaChica=function(){a.cerrarPopup(a.idModalRegistroAnticipoCajaChica)},a.cerrarModalRegistroIngresoCajaChica=function(){a.cerrarPopup(a.idModalRegistroIngresoCajaChica)},a.abrirModalRegistroDesembolsoCajaChica=function(o,i,e){e?(a.cajaChica=Object.assign({},o.cajasChicas[0]),a.cajaChica.solicitud=Object.assign({},o),a.cajaChica.fecha=a.fechaATexto(new Date(a.cajaChica.fecha)),a.cajaChica.total=o.cajasChicas[0].monto,a.cajaChica.Desembolso=!0,a.cajaChica.sucursal=a.sucursalPrincipal):(a.cajaChica={solicitud:o,sucursal:a.sucursalPrincipal},a.cajaChica.fecha=a.fechaATexto(new Date(o.fecha)),a.cajaChica.total=o.monto,a.cajaChica.detalle=o.detalle,a.cajaChica.concepto=o.concepto,a.cajaChica.Desembolso=!0),i&&(a.cajaChica.ver=!0),a.abrirPopup(a.idModalRegistroDesembolsoCajaChica)},a.cerrarModalRegistroDesembolsoCajaChica=function(){a.cerrarPopup(a.idModalRegistroDesembolsoCajaChica)},a.obtenerTiposDePago=function(){t.start(),n("TIPA").then(function(o){a.tiposPago=o.clases,t.stop()})},a.cerrarModalRegistroCajaChica=function(){a.cerrarPopup(a.idModalRegistroCajaChica)},a.abrirModalVerificarAutorizacion=function(o){a.solicitud=o,a.tipoDatosPermiso="autorizacion",a.abrirPopup(a.idModalVerificarAutorizacion)},a.cerrarModalVerificarAutorizacion=function(){a.cerrarPopup(a.idModalVerificarAutorizacion)},a.obtenerTiposMovimiento=function(){n("CM_CCH").then(function(o){a.tiposMovimientos=o})},a.obtenerTiposEstados=function(){n("ES_CCH").then(function(o){a.tiposEstados=o.clases})},a.obtenerConceptosMovimiento=function(){u(a.usuario.id_empresa).then(function(o){a.ConceptosMovimiento=o,a.cerrarModalConceptosMovimiento()})},a.AgregarConceptosMovimientoCajaChica=function(o){o.habilitado=!0,o.edit?a.clase={edit:!1}:a.ConceptosMovimiento.push(o)},a.editarConceptoMovimientoCajaChica=function(o){o.edit=!0,a.clase=o},a.cancelarEdicionConcepotMovimientoCajaChica=function(o){a.clase={edit:!1}},a.guardarConceptoMovimientoCajaChica=function(){l(a.usuario.id_empresa,a.ConceptosMovimiento).then(function(o){a.obtenerConceptosMovimiento(),a.mostrarMensaje(o.mensaje)})},a.obtenerListaSolicitudes=function(o){a.paginator=h(),a.paginator.column="id",a.paginator.direccion="asc",a.paginator.itemsPerPage=10,o?(a.filtro=o,a.filtro.id_sucursal=a.sucursalPrincipal.id):a.filtro={empresa:a.usuario.id_empresa,inicio:"",fin:"",solicitante:"",usuario:"",estado:"",concepto:"",movimiento:"",id_usuario_no_autorizado:a.usuario.encargado_caja_chica?"":a.usuario.encargado_rendicion_caja_chica?"":a.usuario.id,id_sucursal:a.sucursalPrincipal.id,rendiciones:a.usuario.encargado_rendicion_caja_chica?1:""},a.paginator.callBack=a.listaSolicitudesCajaChica,a.paginator.getSearch("",a.filtro,null)},a.listaSolicitudesCajaChica=function(){t.start(),p(a.paginator).then(function(o){t.stop(),a.totalRlCaja=o.totalRlCaja,a.totalCaja=o.total,a.paginator.setPages(o.paginas),a.solicitudesCajaChica=o.solicitudes})},a.obtenerListaIngresos=function(){a.paginator=h(),a.paginator.column="id",a.paginator.direccion="asc",a.paginator.itemsPerPage=10,a.filtro2={empresa:a.usuario.id_empresa,inicio:"",fin:"",id_sucursal:a.sucursalPrincipal.id},a.paginator.callBack=a.listaIngresosCajaChica,a.paginator.getSearch("",a.filtro2,null)},a.listaIngresosCajaChica=function(){t.start(),E(a.paginator).then(function(o){t.stop(),a.paginator.setPages(o.paginas),a.IngresosCajaChica=o.ingresos})},a.obtenerListaCierresCajaChica=function(){a.paginator=h(),a.paginator.column="id",a.paginator.direccion="asc",a.paginator.itemsPerPage=10,a.filtro2={empresa:a.usuario.id_empresa,inicio:"",fin:"",id_sucursal:a.sucursalPrincipal.id},a.paginator.callBack=a.listaCierresCajaChica,a.paginator.getSearch("",a.filtro2,null)},a.listaCierresCajaChica=function(){t.start(),O(a.paginator).then(function(o){t.stop(),a.paginator.setPages(o.paginas),o.cierreCaja.forEach(function(i,e,c){i.saldo_final=i.saldo_inicial,i.detalleCierreCaja.forEach(function(a){"INGRESO"==a.concepto.concepto.nombre?i.saldo_final+=a.monto:i.saldo_final-=a.monto}),e==c.length-1&&(a.cierresCajaChica=o.cierreCaja)})})},a.eliminarSolicitud=function(){a.tiposEstados.forEach(function(o,i,e){(o.nombre===a.diccionario.CC_ESTADO_ANULADO&&(a.solicitud.estado=o),i===e.length-1)&&(a.solicitud.eliminado=!0,a.solicitud.autorizador=a.usuario.id,s(a.solicitud).then(function(o){a.obtenerListaSolicitudes(),a.cerrarModalEliminarSolicitud(),a.mostrarMensaje(o.mensaje)}))})},a.verificarPerimisoAutorizacion=function(o){o.nombre_usuario=a.usuario.nombre_usuario,S(a.usuario.id_empresa,o).then(function(o){o.type?(a.mostrarMensaje(o.message),"autorizacion"==a.tipoDatosPermiso&&a.tiposEstados.forEach(function(o,i,e){(o.nombre===a.diccionario.CC_ESTADO_AUTORIZADO&&(a.solicitud.estado=o),i===e.length-1)&&(a.solicitud.autorizador=a.usuario.id,s(a.solicitud).then(function(o){a.obtenerListaSolicitudes(),a.cerrarModalVerificarAutorizacion(),a.mostrarMensaje(o.mensaje)}))})):(a.cerrarModalVerificarAutorizacion(),a.mostrarMensaje(o.message))})},a.verDatosCompra=function(){a.cajaChica.compra.fechaTexto=a.fechaATexto(new Date),a.cajaChica.verDatosCompra=!a.cajaChica.verDatosCompra},a.obtenerMovimientosIngreso=function(o){t.start(),n("MOVING").then(function(o){a.movimientosIngreso=o.clases;var i=[];a.movimientosIngreso.forEach(function(o,e,c){o.nombre!==a.diccionario.MOVING_INVENTARIO_INICIAL&&o.nombre!==a.diccionario.MOVING_POR_TRASPASO&&o.nombre!==a.diccionario.MOVING_POR_DEVOLUCION&&o.nombre!==a.diccionario.MOVING_POR_AJUSTE||i.push(e)}),i.reverse().forEach(function(o){a.movimientosIngreso.splice(o,1)}),t.stop()})},a.buscarCuentasCajaChica=function(o){return f(a.mostrarMensaje,null,null,a.usuario,null,null,null,null,null,null,o)},a.buscarProveedor=function(o){if(""!=o&&void 0!=o)return b(a.usuario.id_empresa,o)},a.establecerProveedor=function(o){a.cajaChica.compra.proveedor=o},a.interceptarTecla=function(o,i,e){13===o.which&&(e?a.enfocar(i):$timeout(function(){$("#"+i).trigger("click")},0))},a.obtenerSucursales=function(){for(var o=[],i=0;i<a.usuario.sucursalesUsuario.length;i++)o.push(a.usuario.sucursalesUsuario[i].sucursal);return o},a.obtenerAlmacenes=function(o){a.almacenes=[];var i=$.grep(a.sucursales,function(a){return a.id==o})[0];a.almacenes=i.almacenes,void 0==a.cajaChica.compra.id&&(a.cajaChica.compra.almacen=1==a.almacenes.length?a.almacenes[0]:null)},a.verificarMomivmiento=function(o){o.movimiento.clase.nombre==a.diccionario.MOVING_POR_RETENCION_SERVICIOS?o.usar_producto=!1:o.movimiento.clase.nombre==a.diccionario.MOVING_POR_RETENCION_BIENES?o.usar_producto=!0:o.movimiento.clase.nombre==a.diccionario.MOVING_POR_IMPORTACION&&(o.factura=0,o.autorizacion=3,o.codigo_control=0,o.descuento_general=!1,o.usar_producto=!0)},a.generarDescuentoGasolina=function(){a.cajaChica.descuentoGasolina=!a.cajaChica.descuentoGasolina,a.cajaChica.descuentoGasolina?(a.cajaChica.compra.descuento_general=!0,a.cajaChica.compra.descuento=0,a.cajaChica.compra.recargo=0,a.cajaChica.compra.ice=0,a.cajaChica.compra.excento=30*a.cajaChica.solicitud.monto/100):(a.cajaChica.compra.descuento_general=!1,a.cajaChica.compra.descuento=0,a.cajaChica.compra.recargo=0,a.cajaChica.compra.ice=0,a.cajaChica.compra.excento=0)},a.guardarCajaChica=function(){if(t.start(),a.cajaChica.solicitud)if(a.cajaChica.Desembolso){a.cajaChica.fecha=new Date(a.convertirFecha(a.cajaChica.fecha));var o=new Date;a.cajaChica.fecha.setHours(o.getHours()),a.cajaChica.fecha.setMinutes(o.getMinutes()),a.cajaChica.fecha.setSeconds(o.getSeconds()),a.tiposEstados.forEach(function(o,i,e){(a.cajaChica.Anticipo?o.nombre===a.diccionario.CC_ESTADO_PROCESADO&&(a.cajaChica.solicitud.estado=o):o.nombre===a.diccionario.CC_ESTADO_DESEMBOLSADO&&(a.cajaChica.solicitud.estado=o),i===e.length-1)&&M(a.cajaChica,a.usuario.id_empresa).then(function(o){t.stop(),a.generarPdfBoletaCajaChica(a.cajaChica.solicitud,o.cajaChica),a.obtenerListaSolicitudes(),a.mostrarMensaje(o.mensaje),a.cajaChica.Anticipo?a.cerrarModalRegistroAnticipoCajaChica():a.cerrarModalRegistroDesembolsoCajaChica()})})}else{a.cajaChica.fecha=new Date(a.convertirFecha(a.cajaChica.fecha)),a.cajaChica.compra.fecha=new Date(a.convertirFecha(a.cajaChica.compra.fechaTexto));o=new Date;if(a.cajaChica.compra.fecha.setHours(o.getHours()),a.cajaChica.compra.fecha.setMinutes(o.getMinutes()),a.cajaChica.compra.fecha.setSeconds(o.getSeconds()),a.cajaChica.fecha.setHours(o.getHours()),a.cajaChica.fecha.setMinutes(o.getMinutes()),a.cajaChica.fecha.setSeconds(o.getSeconds()),null!=a.cajaChica.solicitud)if("KARDEX"==a.cajaChica.solicitud.concepto.concepto.nombre){if(a.cajaChica.solicitud.cajasChicas.length>0)var i=a.cajaChica.solicitud.cajasChicas[0].saldo;else i=-1;if(a.cajaChica.compra.total==i)a.tiposEstados.forEach(function(o,i,e){(o.nombre===a.diccionario.CC_ESTADO_PROCESADO&&(a.cajaChica.solicitud.estado=o),i===e.length-1)&&M(a.cajaChica,a.usuario.id_empresa).then(function(o){t.stop(),a.obtenerListaSolicitudes(),a.generarPdfBoletaCajaChica(a.cajaChica.solicitud,o.cajaChica,!0),a.mostrarMensaje(o.mensaje),a.cerrarModalRegistroCajaChica()})});else M(a.cajaChica,a.usuario.id_empresa).then(function(o){t.stop(),a.obtenerListaSolicitudes(),a.mostrarMensaje(o.mensaje),a.generarPdfBoletaCajaChica(a.cajaChica.solicitud,o.cajaChica,!0),a.cerrarModalRegistroCajaChica()})}else a.tiposEstados.forEach(function(o,i,e){(o.nombre===a.diccionario.CC_ESTADO_PROCESADO&&(a.cajaChica.solicitud.estado=o),i===e.length-1)&&M(a.cajaChica,a.usuario.id_empresa).then(function(o){t.stop(),a.generarPdfBoletaCajaChica(a.cajaChica.solicitud,o.cajaChica),a.obtenerListaSolicitudes(),a.mostrarMensaje(o.mensaje),a.cerrarModalRegistroCajaChica()})});else M(a.cajaChica,a.usuario.id_empresa).then(function(o){t.stop(),a.obtenerListaSolicitudes(),a.generarPdfBoletaCajaChica(a.cajaChica.solicitud,o.cajaChica),a.mostrarMensaje(o.mensaje),a.cerrarModalRegistroCajaChica()})}else{a.cajaChica.fecha=new Date(a.convertirFecha(a.cajaChica.fecha));o=new Date;a.cajaChica.fecha.setHours(o.getHours()),a.cajaChica.fecha.setMinutes(o.getMinutes()),a.cajaChica.fecha.setSeconds(o.getSeconds()),M(a.cajaChica,a.usuario.id_empresa).then(function(o){t.stop(),a.generarPdfBoletaCajaChica(a.cajaChica.solicitud,o.cajaChica),a.obtenerListaIngresos(),a.obtenerListaSolicitudes(),a.mostrarMensaje(o.mensaje),a.cerrarModalRegistroIngresoCajaChica()})}},a.filterPorTipo=function(o,i){a.tipoFiltro=o,"TODOS"==o?(i.movimiento=0,a.paginator.getSearch(a.paginator.search,i,null)):a.tiposMovimientos.clases.forEach(function(e,c,t){e.nombre==o&&(i.movimiento=e.id),c===t.length-1&&a.paginator.getSearch(a.paginator.search,i,null)})},a.obtenerDatosCierreCaja=function(){t.start();var o=new Date;I(a.usuario.id_empresa,o,a.totalRlCaja,a.sucursalPrincipal.id).then(function(o){t.stop();var i=o.cierreCaja;a.generarPdfCajaChica(i)})},a.generarPdfCajaChica=function(o){t.start();var i=new PDFDocument({size:"letter",margin:10}),e=i.pipe(blobStream()),c=120,r=0,n=1,s=Math.ceil(o.detalleCierreCaja.length/19);a.dibujarCabeceraPDFCajaChica(i,1,s,o),i.font("Helvetica",8);for(var l=o.saldo_inicial,u=0;u<o.detalleCierreCaja.length&&r<=19;u++){var d=o.detalleCierreCaja[u];i.rect(30,c-10,555,30).stroke(),i.text(d.id,45,c),i.text(a.fechaATexto(new Date(d.fecha)),85,c),d.solicitud&&i.text(d.solicitud.solicitante.persona.nombre_completo,150,c,{width:120}),i.text(d.concepto.nombre,270,c,{width:150}),d.compra&&i.text(d.compra.factura,430,c),"INGRESO"==d.concepto.concepto.nombre?(i.text(number_format(d.monto,2)+".-",490,c),l+=d.monto):(i.text("("+number_format(d.monto,2)+".-)",490,c),l-=d.monto),i.text(l.toFixed(2)+".-",540,c),c+=30,19==++r&&(i.addPage({margin:0,bufferPages:!0}),c=120,r=0,n+=1,a.dibujarCabeceraPDFCajaChica(i,n,s,o),i.font("Helvetica",8))}i.rect(350,c+25,200,0).dash(1,{space:5}).stroke(),i.text("Encargado Caja Chica",350,c+30,{width:200,align:"center"}),i.text(a.usuario.persona.nombre_completo,350,c+40,{width:200,align:"center"}),i.end(),e.on("finish",function(){var a=e.toBlobURL("application/pdf");window.open(a,"_blank","location=no")}),t.stop()},a.dibujarCabeceraPDFCajaChica=function(o,i,e,c){o.font("Helvetica-Bold",12),o.text("CIERRE CAJA CHICA",0,25,{align:"center"}),o.font("Helvetica",8),o.text("DEL "+a.fechaATexto(c.inicio)+" AL "+a.fechaATexto(c.fin),0,35,{align:"center"}),o.font("Helvetica-Bold",8),o.text("PÁGINA "+i+" DE "+e,0,740,{align:"center"}),o.font("Helvetica-Bold",8),o.text("Saldo Inicial : bs. "+number_format(c.saldo_inicial,2)+".-",45,60),o.font("Helvetica",8),o.rect(30,80,555,30).stroke(),o.font("Helvetica-Bold",8),o.text("N°",45,90),o.text("Fecha",85,90,{width:50}),o.text("Nombre",150,90,{width:60}),o.text("Gasto",270,90,{width:50}),o.text("N° factura",430,90,{width:50}),o.text("Monto",490,90,{width:50}),o.text("Saldo",540,90,{width:50}),o.font("Helvetica",8)},a.generarPdfBoletaCajaChica=function(o,i,e){D(a.usuario.empresa.imagen).then(function(c){var t=new PDFDocument({size:"letter",margin:10}),r=t.pipe(blobStream()),n=45;a.dibujarPDFBoletaCajaChica(t,o,i,n,c,e),n+=370,t.rect(0,n-35,650,0).dash(2,{space:5}).stroke(),a.dibujarPDFBoletaCajaChica(t,o,i,n,c,e),t.end(),r.on("finish",function(){var a=r.toBlobURL("application/pdf");window.open(a,"_blank","location=no")})}).catch(function(o){t.stop();var i=void 0!==o.stack&&null!==o.stack?o.stack:void 0!==o.message&&null!==o.message?o.message:"Se perdió la conexión.";a.mostrarMensaje(i)})},a.dibujarPDFBoletaCajaChica=function(o,i,e,c,t,r){if(o.font("Helvetica-Bold",12),o.image(t,30,c-20,{fit:[80,80]}),"INGRESO"!=e.concepto.concepto.nombre?r?o.text("RENDICIÓN FONDOS CAJA CHICA",0,c+20,{align:"center"}):o.text("SALIDA CAJA CHICA",0,c+20,{align:"center"}):o.text("INGRESO CAJA CHICA",0,c+20,{align:"center"}),o.font("Helvetica-Bold",8),o.text(e.sucursal.nombre,0,c+30,{align:"center"}),o.text("Nro. "+e.numero_correlativo,0,c+40,{align:"center"}),o.rect(465,c,90,20).dash(0,{space:0}).stroke(),o.rect(435,c,30,20).dash(0,{space:0}).stroke(),o.rect(465,c+20,90,20).dash(0,{space:0}).stroke(),o.rect(435,c+20,30,20).dash(0,{space:0}).stroke(),o.text("Bs.",445,c+10),e.id_padre?o.text(e.pagado.toFixed(2),485,c+10):o.text(e.monto.toFixed(2),485,c+10),o.text("$us.",445,c+30),o.font("Helvetica",8),o.text("Fecha en texto",45,c+65),i)var n=i.solicitante.persona.nombre_completo;else n=a.usuario.empresa.razon_social;o.text("Recibí de .: "+n,45,c+80),e.id_padre?o.text("La suma de .: "+ConvertirALiteral(e.pagado.toFixed(2)),45,c+95):o.text("La suma de .: "+ConvertirALiteral(e.monto.toFixed(2)),45,c+95),"INGRESO"!=e.concepto.concepto.nombre&&(o.text("Bajo el concepto de: "+e.concepto.nombre,45,c+110),c+=15),o.text("Por concepto de:",45,c+110),o.font("Helvetica-Bold",8),o.text("DETALLE",200,c+125),o.text(e.detalle,55,c+155,{width:410}),o.text("IMPORTE",485,c+125),o.font("Helvetica",8),e.id_padre?o.text(e.pagado.toFixed(2),485,c+155):o.text(e.monto.toFixed(2),485,c+155),o.font("Helvetica",8),o.rect(45,c+120,420,20).dash(0,{space:0}).stroke().stroke(),o.rect(45,c+140,420,60).dash(0,{space:0}).stroke().stroke(),o.rect(465,c+120,90,20).dash(0,{space:0}).stroke().stroke(),o.rect(465,c+140,90,60).dash(0,{space:0}).stroke().stroke(),o.font("Helvetica",6),o.rect(70,c+275,100,0).dash(2,{space:5}).stroke(),"INGRESO"==e.concepto.concepto.nombre?(o.text("Autorizado",45,c+295,{width:150,align:"center"}),o.rect(250,c+275,100,0).dash(2,{space:5}).stroke(),o.text("Entregue Conforme",225,c+295,{width:150,align:"center"}),o.rect(450,c+275,100,0).dash(2,{space:5}).stroke(),o.text(a.usuario.persona.nombre_completo,425,c+285,{width:150,align:"center"}),o.text("Recibí Conforme",425,c+295,{width:150,align:"center"})):(o.text(i.usuario.persona.nombre_completo,45,c+285,{width:150,align:"center"}),o.text("Autorizado",45,c+295,{width:150,align:"center"}),o.rect(250,c+275,100,0).dash(2,{space:5}).stroke(),o.text(i.solicitante.persona.nombre_completo,225,c+285,{width:150,align:"center"}),o.text("Recibí Conforme",225,c+295,{width:150,align:"center"}),o.rect(450,c+275,100,0).dash(2,{space:5}).stroke(),o.text(a.usuario.persona.nombre_completo,425,c+285,{width:150,align:"center"}),o.text("Entregue Conforme",425,c+295,{width:150,align:"center"}));var s=new Date;o.text("Usuario.: "+a.usuario.nombre_usuario+" Hora.: "+s.getHours()+":"+s.getMinutes()+" imp.: "+a.fechaATexto(s),425,c+310,{width:150,align:"center"})},a.dibujarCuerpoPDFBoletaCajaChica=function(a,o,i,e){},a.verificarProducto=function(o){void 0!=a.cajaChica.compra.movimiento.clase&&a.cajaChica.compra.movimiento.clase.nombre==a.diccionario.MOVING_POR_RETENCION_BIENES?(o.descuento=0,o.ice=0,o.recargo=0,o.excento=0,a.configuracionCompraVista.mostrar_it_retencion=!0,a.configuracionCompraVista.mostrar_iue=!0,a.configuracionCompraVista.mostrar_pagado=!0,a.agregarDetalleCompra(o)):a.agregarDetalleCompra(o)},a.verificarServicio=function(o){o.servicio.id?(void 0!=a.cajaChica.compra.movimiento.clase&&a.cajaChica.compra.movimiento.clase.nombre==a.diccionario.MOVING_POR_RETENCION_SERVICIOS?(o.descuento=0,o.ice=0,o.recargo=0,o.excento=0,a.configuracionCompraVista.mostrar_it_retencion=!0,a.configuracionCompraVista.mostrar_iue=!0,a.configuracionCompraVista.mostrar_pagado=!0,a.agregarDetalleCompraServicio(o)):a.agregarDetalleCompraServicio(o),a.verificarCamposDetalleCompra(o,!0)):a.mostrarMensaje("El producto no se encuentra en el catalogo")},a.agregarDetalleCompra=function(o){if(o.producto.nombre.id&&(o.producto=o.producto.nombre),o.centroCosto.nombre.id)o.centroCosto=o.centroCosto.nombre;else if(o.centroCosto.nombre==a.diccionario.CENTRO_COSTO_ALMACEN){var i=$.grep(a.centrosCosto,function(o){return o.nombre==a.diccionario.CENTRO_COSTO_ALMACEN})[0];o.centroCosto=i}o.fechaVencimientoTexto&&(o.fecha_vencimiento=new Date(a.convertirFecha(o.fechaVencimientoTexto))),a.cajaChica.compra.descuento_general&&(o.descuento=a.cajaChica.compra.descuento,o.ice=a.cajaChica.compra.ice,o.recargo=a.cajaChica.compra.recargo,o.excento=a.cajaChica.compra.excento),a.cajaChica.compra.detallesCompra.push(o),a.sumarTotal(),a.sumarTotalImporte(),a.cajaChica.compra.descuento_general&&a.calcularImporteGeneral(),a.cajaChica.compra.tipoPago.nombre==a.diccionario.TIPO_PAGO_CREDITO&&a.calcularSaldo(),a.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},a.cargarCentroCosto(a.detalleCompra)},a.agregarDetalleCompraServicio=function(o){a.cajaChica.compra.detallesCompra.push(o),a.sumarTotal(),a.sumarTotalImporte(),a.cajaChica.compra.descuento_general&&a.calcularImporteGeneral(),a.cajaChica.compra.tipoPago.nombre==a.diccionario.TIPO_PAGO_CREDITO&&a.calcularSaldo(),a.detalleCompra={producto:{},servicio:{},centroCosto:{},cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},a.cargarCentroCosto(a.detalleCompra)},a.obtenerConfiguracionCompraVista=function(){t.start(),v(a.usuario.id_empresa).then(function(o){a.configuracionCompraVista=o,t.stop()})},a.guardarConfiguracionCompraVista=function(){g.update({id_empresa:a.usuario.id_empresa},a.configuracionCompraVista,function(a){})},a.eliminarDetalleCompra=function(o){a.cajaChica.compra.id?o.eliminado=!0:a.cajaChica.compra.detallesCompra.splice(a.cajaChica.compra.detallesCompra.indexOf(o),1),a.sumarTotal(),a.sumarTotalImporte(),a.cajaChica.compra.descuento_general&&a.calcularImporteGeneral(),a.cajaChica.compra.tipoPago.nombre==a.diccionario.TIPO_PAGO_CREDITO&&a.calcularSaldo()},a.sumarTotalImporte=function(){for(var o=0,i=0;i<a.cajaChica.compra.detallesCompra.length;i++)a.cajaChica.compra.detallesCompra[i].eliminado||(o+=a.cajaChica.compra.detallesCompra[i].importe);a.cajaChica.compra.importe=Math.round(1e3*o)/1e3},a.sumarTotal=function(){for(var o=0,i=0;i<a.cajaChica.compra.detallesCompra.length;i++)a.cajaChica.compra.detallesCompra[i].eliminado||(o+=a.cajaChica.compra.detallesCompra[i].total);a.cajaChica.compra.total=Math.round(1e3*o)/1e3},a.calcularSaldo=function(){a.cajaChica.compra.saldo=a.cajaChica.compra.total-a.cajaChica.compra.a_cuenta},a.calcularImporteGeneral=function(){var o,i;o=a.cajaChica.compra.tipo_descuento?a.cajaChica.compra.importe*(a.cajaChica.compra.descuento/100):a.cajaChica.compra.descuento,i=a.cajaChica.compra.tipo_recargo?a.cajaChica.compra.importe*(a.cajaChica.compra.recargo/100):a.cajaChica.compra.recargo,a.cajaChica.compra.total=Math.round(1e3*(a.cajaChica.compra.importe-o+i-a.cajaChica.compra.ice-a.cajaChica.compra.excento))/1e3},a.eliminarDetalleCompra=function(o){a.cajaChica.compra.id?o.eliminado=!0:a.cajaChica.compra.detallesCompra.splice(a.cajaChica.compra.detallesCompra.indexOf(o),1),a.sumarTotal(),a.sumarTotalImporte(),a.cajaChica.compra.descuento_general&&a.calcularImporteGeneral(),a.cajaChica.compra.tipoPago.nombre==a.diccionario.TIPO_PAGO_CREDITO&&a.calcularSaldo()},a.cambiarTipoPago=function(o){o=$.grep(a.tiposPago,function(a){return a.id==o.id})[0];a.esContado="CONT"==o.nombre_corto,a.cajaChica.compra.id_tipo_pago=o.id,a.esContado||a.calcularSaldo()},a.buscarProducto=function(o){if(""!=o&&void 0!=o&&a.busquedaProductoHabilidato)return P(a.usuario.id_empresa,o,a.usuario.id,a.compra.almacen.id)},a.establecerProducto=function(o){o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto;var i=a.detalleCompra.centroCosto;a.precio_inventario,o.inventarios.length>0?a.precio_inventario=o.inventarios.pop().costo_unitario+" Bs":a.precio_inventario="Sin histórico",a.detalleCompra={centroCosto:i,producto:o,precio_unitario:o.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:o.descuento>0,tipo_recargo:!1},a.cerrarPopup(a.idModalInventario),a.enfocar("cantidad")},a.calcularImporte=function(){var o,i;a.detalleCompra.importe=Math.round(a.detalleCompra.cantidad*a.detalleCompra.costo_unitario*1e3)/1e3,a.cajaChica.compra.movimiento.clase.nombre==a.diccionario.MOVING_POR_RETENCION_BIENES?a.cajaChica.compra.tipo_retencion?(a.detalleCompra.total=a.detalleCompra.importe,a.detalleCompra.importe=a.detalleCompra.total*(a.plantilla.retencionBienesGasto.it.porsentaje+a.plantilla.retencionBienesGasto.iue.porsentaje)/(100-(a.plantilla.retencionBienesGasto.it.porsentaje+a.plantilla.retencionBienesGasto.iue.porsentaje))+a.detalleCompra.total,a.detalleCompra.it=a.detalleCompra.importe*a.plantilla.retencionBienesGasto.it.porsentaje/100,a.detalleCompra.iue=a.detalleCompra.importe*a.plantilla.retencionBienesGasto.iue.porsentaje/100):(a.detalleCompra.it=a.detalleCompra.importe*a.plantilla.retencionBienesGasto.it.porsentaje/100,a.detalleCompra.iue=a.detalleCompra.importe*a.plantilla.retencionBienesGasto.iue.porsentaje/100,a.detalleCompra.total=a.detalleCompra.importe*a.plantilla.retencionBienesGasto.gasto.porsentaje/100):a.cajaChica.compra.movimiento.clase.nombre==a.diccionario.MOVING_POR_IMPORTACION?a.detalleCompra.total=a.detalleCompra.importe:a.cajaChica.compra.movimiento.clase.nombre==a.diccionario.MOVING_POR_RETENCION_SERVICIOS?a.cajaChica.compra.tipo_retencion?(a.detalleCompra.total=a.detalleCompra.importe,a.detalleCompra.importe=a.detalleCompra.total*(a.plantilla.retencionServicios.it.porsentaje+a.plantilla.retencionServicios.iue.porsentaje)/(100-(a.plantilla.retencionServicios.it.porsentaje+a.plantilla.retencionServicios.iue.porsentaje))+a.detalleCompra.total,a.detalleCompra.it=a.detalleCompra.importe*a.plantilla.retencionServicios.it.porsentaje/100,a.detalleCompra.iue=a.detalleCompra.importe*a.plantilla.retencionServicios.iue.porsentaje/100):(a.detalleCompra.it=a.detalleCompra.importe*a.plantilla.retencionServicios.it.porsentaje/100,a.detalleCompra.iue=a.detalleCompra.importe*a.plantilla.retencionServicios.iue.porsentaje/100,a.detalleCompra.total=a.detalleCompra.importe*a.plantilla.retencionServicios.servicio.porsentaje/100):a.cajaChica.compra.descuento_general?(o=a.cajaChica.compra.tipo_descuento?a.detalleCompra.importe*(a.cajaChica.compra.descuento/100):a.cajaChica.compra.descuento,i=a.cajaChica.compra.tipo_recargo?a.detalleCompra.importe*(a.cajaChica.compra.recargo/100):a.cajaChica.compra.recargo,a.detalleCompra.total=a.detalleCompra.importe-o+i-a.cajaChica.compra.ice-a.cajaChica.compra.excento):(o=a.detalleCompra.tipo_descuento?a.detalleCompra.importe*(a.detalleCompra.descuento/100):a.detalleCompra.descuento,i=a.detalleCompra.tipo_recargo?a.detalleCompra.importe*(a.detalleCompra.recargo/100):a.detalleCompra.recargo,a.detalleCompra.total=a.detalleCompra.importe-o+i-a.detalleCompra.ice-a.detalleCompra.excento),importe=a.cajaChica.compra.importe?a.cajaChica.compra.importe:0,a.totalRestante=a.cajaChica.solicitud.monto-importe,a.cajaChica.solicitud&&(a.detalleCompra.importe>a.totalRestante?(a.detalleCompra.importe=NaN,a.ErrorImporte=!0):a.ErrorImporte=!1)},a.calcularImporteDetalleEdicion=function(o){var i,e;o.importe=Math.round(o.cantidad*o.costo_unitario*1e3)/1e3,i=o.tipo_descuento?o.importe*(o.descuento/100):o.descuento,e=o.tipo_recargo?o.importe*(o.recargo/100):o.recargo,o.total=o.importe-i+e-o.ice-o.excento,a.sumarTotal(),a.sumarTotalImporte(),a.cajaChica.compra.descuento_general&&a.calcularImporteGeneral(),a.cajaChica.compra.tipoPago.nombre==a.diccionario.TIPO_PAGO_CREDITO&&a.calcularSaldo()},a.sumarMonto=function(a){for(var o=0,i=0;i<a.length;i++)o+=a[i].total;return Math.round(100*o)/100},a.obtenerCentrosDeCosto=function(){t.start(),n("CCO").then(function(o){if(a.centrosCosto=o.clases,a.usuario.empresa.usar_funciones_erp){var i=[];a.centrosCosto.forEach(function(a,o,e){"ALM"==a.nombre_corto||"VR"==a.nombre_corto||i.push(o)}),i.reverse().forEach(function(o,i,e){a.centrosCosto.splice(o,1)})}t.stop()})},a.obtenerconfiuracionCuentas=function(){var o=_(a.usuario.id_empresa);a.plantilla={retencionServicios:{it:{},iue:{},servicio:{}},retencionBienesGasto:{it:{},iue:{},gasto:{}},retencionBienes:{it:{},iue:{},almacen:{}},egreso:{ivacf:{},cajaBanco:{}},ingreso:{ivadf:{},it:{},itPorPagar:{},cajaBanco:{}}},o.then(function(o){o.lista.forEach(function(o){a.diccionario.IVA_DF==o.nombre&&(a.plantilla.ingreso.ivadf={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IT==o.nombre&&(a.plantilla.ingreso.it={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IT_POR_PAGAR==o.nombre&&(a.plantilla.ingreso.itPorPagar={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.CAJA_BANCOS==o.nombre&&(a.plantilla.ingreso.cajaBanco={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IVA_CF==o.nombre&&(a.plantilla.egreso.ivacf={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.CAJA_BANCOS==o.nombre&&(a.plantilla.egreso.cajaBanco={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IT_RETENCION_BIEN==o.nombre&&(a.plantilla.retencionBienes.it={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IUE_RETENCION_BIEN==o.nombre&&(a.plantilla.retencionBienes.iue={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.CUENTA_ALMACEN_RETENCION_BIEN==o.nombre&&(a.plantilla.retencionBienes.almacen={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IT_RETENCION_BIEN_GASTO==o.nombre&&(a.plantilla.retencionBienesGasto.it={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IUE_RETENCION_BIEN_GASTO==o.nombre&&(a.plantilla.retencionBienesGasto.iue={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.CUENTA_GASTO_RETENCION_BIEN==o.nombre&&(a.plantilla.retencionBienesGasto.gasto={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IT_RETENCION_SERVICIO==o.nombre&&(a.plantilla.retencionServicios.it={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.IUE_RETENCION_SERVICIO==o.nombre&&(a.plantilla.retencionServicios.iue={porsentaje:parseFloat(o.valor),cuenta:o.cuenta}),a.diccionario.CUENTA_RETENCION_SERVICIO==o.nombre&&(a.plantilla.retencionServicios.servicio={porsentaje:parseFloat(o.valor),cuenta:o.cuenta})},this)})},a.obtenerServicios=function(){t.start(),r("SERVICIOS_COMPRA",a.usuario.id_empresa).then(function(o){a.datosServicios=o,t.stop()})},a.abrirDialogServicios=function(o){a.tipo_edicion=o,a.clase={},a.abrirPopup(a.idModalServicios)},a.cerrarDialogServicios=function(){a.cerrarPopup(a.idModalServicios)},a.agregarConceptoEdicion=function(o){o.nombre&&o.nombre_corto&&(-1==a.tipo_edicion.clases.indexOf(o)&&a.tipo_edicion.clases.push(o),a.clase={})},a.modificarConceptoEdicion=function(o){a.clase=o},a.removerConceptoEdicion=function(a){a.eliminado=!0},a.guardarConceptoEdicion=function(o){t.start(),Tipos.update({id_tipo:o.id},o,function(i){n(o.nombre_corto).then(function(i){o=i,t.stop(),a.cerrarDialogServicios(),a.mostrarMensaje("Guardado Exitosamente!")})})},a.establecerServicioSeleccionado=function(o){a.establecerServicio(o),a.cerrarDialogServicios()},a.establecerServicio=function(o){o.tipoProducto=null==o.tipoProducto?{id:o["tipoProducto.id"],nombre:o["tipoProducto.nombre"],nombre_corto:o["tipoProducto.nombre_corto"]}:o.tipoProducto;a.detalleCompra.centroCosto;a.detalleCompra={centroCosto:null,servicio:o,precio_unitario:o.precio_unitario,cantidad:1,descuento:0,recargo:0,ice:0,excento:0,tipo_descuento:!1,tipo_recargo:!1},a.cerrarPopup(a.idModalInventario),a.enfocar("cantidad")},a.verificarCamposDetalleCompra=function(o,i){i?(a.verificacionDatos=!1,a.verificacionDatos=!o.servicio.nombre,0==a.verificacionDatos&&(a.verificacionDatos=!(o.cantidad>=1),0==a.verificacionDatos&&(a.verificacionDatos=!(o.costo_unitario>=1e-4)))):(a.verificacionDatos=!1,a.verificacionDatos=!o.producto.nombre,0==a.verificacionDatos&&(a.verificacionDatos=!(o.cantidad>=1),0==a.verificacionDatos&&(a.verificacionDatos=!(o.costo_unitario>=1e-4))))},a.$on("$routeChangeStart",function(o,i){a.eliminarPopup(a.idModalSolicitudCajaChica),a.eliminarPopup(a.idModalConceptosMovimiento),a.eliminarPopup(a.idModalEliminarSolicitud),a.eliminarPopup(a.idModalVerificarAutorizacion),a.eliminarPopup(a.idModalRegistroCajaChica),a.eliminarPopup(a.idModalKardexCajaChica),a.eliminarPopup(a.idModalIngresosCajaChica),a.eliminarPopup(a.idModalHistorialCierreCajaChica),a.eliminarPopup(a.idModalRegistroIngresoCajaChica),a.eliminarPopup(a.idModalRegistroDesembolsoCajaChica),a.eliminarPopup(a.idModalServicios),a.eliminarPopup(a.idModalRegistroAnticipoCajaChica)}),a.inicio()}]).controller("ControladorSolicitudCajaChica",["$scope","$localStorage","$location","$templateCache","$route","blockUI","ClasesTipoEmpresa","ClasesTipo","GuardarSolicitudCajaChica","GuardarConceptoMovimientoCajaChica","ObtenerConceptoMovimientoCajaChica","VerificarUsuarioEmpresaCaja","SolicitudesCajaPaginador","ObtenerTodoPersonal","$filter","Paginator","VerificarUsuarioEmpresa",function(a,o,i,e,c,t,r,n,s,l,u,d,p,C,m,h,j){a.usuario=JSON.parse(o.usuario),a.idModalSolicitudCajaChica="dialog-solicitud",a.idModalConceptosMovimiento="dialog-conceptos-movimiento",a.idModalEliminarSolicitud="dialog-eliminar-solicitud",a.idModalVerificarAutorizacion="modal-verificar-autorizacion",a.inicio=function(){a.obtenerTiposMovimiento(),a.obtenerConceptosMovimiento(),a.obtenerTiposEstados(),a.obtenerListaSolicitudes(),a.ConceptosMovimiento=[]},a.$on("$viewContentLoaded",function(){resaltarPestaña(i.path().substring(1)),ejecutarScriptsSolicitudCajaChicas(a.idModalSolicitudCajaChica,a.idModalConceptosMovimiento,a.idModalEliminarSolicitud,a.idModalVerificarAutorizacion),a.buscarAplicacion(a.usuario.aplicacionesUsuario,i.path().substring(1)),t.stop()}),a.abrirModalSolicitudCajaChica=function(o){void 0==o&&(a.solicitud={fecha:new Date}),a.filtrarPersonal(),a.abrirPopup(a.idModalSolicitudCajaChica)},a.cerrarModalSolicitudCajaChica=function(){a.cerrarPopup(a.idModalSolicitudCajaChica)},a.abrirModalConceptosMovimiento=function(){a.clase={edit:!1},a.abrirPopup(a.idModalConceptosMovimiento)},a.cerrarModalConceptosMovimiento=function(){a.cerrarPopup(a.idModalConceptosMovimiento)},a.abrirModalEliminarSolicitud=function(o){a.solicitud=o,a.abrirPopup(a.idModalEliminarSolicitud)},a.cerrarModalEliminarSolicitud=function(){a.cerrarPopup(a.idModalEliminarSolicitud)},a.abrirModalVerificarAutorizacion=function(o){a.solicitud=o,a.tipoDatosPermiso="autorizacion",a.abrirPopup(a.idModalVerificarAutorizacion)},a.cerrarModalVerificarAutorizacion=function(){a.cerrarPopup(a.idModalVerificarAutorizacion)},a.obtenerTiposMovimiento=function(){n("CM_CCH").then(function(o){a.tiposMovimientos=o})},a.obtenerTiposEstados=function(){n("ES_CCH").then(function(o){a.tiposEstados=o.clases})},a.obtenerConceptosMovimiento=function(){u(a.usuario.id_empresa).then(function(o){a.ConceptosMovimiento=o,a.cerrarModalConceptosMovimiento()})},a.AgregarConceptosMovimientoCajaChica=function(o){o.habilitado=!0,o.edit?a.clase={edit:!1}:a.ConceptosMovimiento.push(o)},a.editarConceptoMovimientoCajaChica=function(o){o.edit=!0,a.clase=o},a.cancelarEdicionConcepotMovimientoCajaChica=function(o){a.clase={edit:!1}},a.guardarConceptoMovimientoCajaChica=function(){l(a.usuario.id_empresa,a.ConceptosMovimiento).then(function(o){a.obtenerConceptosMovimiento(),a.mostrarMensaje(o.mensaje)})},a.guardarSolicitudCajaChica=function(){a.solicitud.usuario=a.usuario,a.tiposEstados.forEach(function(o,i,e){(a.usuario.autorizacion_caja_chica?(a.solicitud.autorizador=a.usuario.id,o.nombre===a.diccionario.CC_ESTADO_AUTORIZADO&&(a.solicitud.estado=o)):o.nombre===a.diccionario.CC_ESTADO_PENDIENTE&&(a.solicitud.estado=o),i===e.length-1)&&s(a.solicitud).then(function(o){a.obtenerListaSolicitudes(),a.cerrarModalSolicitudCajaChica(),a.mostrarMensaje(o.mensaje)})})},a.buscarPersonal=function(o){if(""!=o&&void 0!=o)return m("filter")(a.todoPersonal,o)},a.filtrarPersonal=function(o){void 0!==a.todoPersonal?a.personalProcesado=m("filter")(a.todoPersonal,o):C(a.usuario.empresa.id).then(function(o){a.todoPersonal=o.personal,a.personalProcesado=o.personal,void 0!==o.mensaje&&a.mostrarMensaje(o.mensaje)},function(o){a.mostrarMensaje("Se perdió la conexión.")})},a.establecerPersonal=function(a){a.id,a.persona.nombre_completo},a.obtenerListaSolicitudes=function(){a.paginator=h(),a.paginator.column="id",a.paginator.direccion="asc",a.paginator.itemsPerPage=10,a.filtro={empresa:a.usuario.id_empresa,inicio:"",fin:"",solicitante:"",usuario:"",estado:"",concepto:"",movimiento:"",id_usuario_no_autorizado:a.usuario.autorizacion_caja_chica?"":a.usuario.id},a.paginator.callBack=a.listaSolicitudesCajaChica,a.paginator.getSearch("",a.filtro,null)},a.listaSolicitudesCajaChica=function(){t.start(),p(a.paginator).then(function(o){t.stop(),a.paginator.setPages(o.paginas),a.solicitudesCajaChica=o.solicitudes})},a.verSolicitudCajaChica=function(o){a.solicitud=o,a.solicitud.ver=!0,a.abrirModalSolicitudCajaChica(!0)},a.editarSolicitudCajaChica=function(o){a.usuario.persona.id==o.usuario.persona.id&&(a.solicitud=o,a.abrirModalSolicitudCajaChica(!0))},a.eliminarSolicitud=function(){a.tiposEstados.forEach(function(o,i,e){(o.nombre===a.diccionario.CC_ESTADO_ANULADO&&(a.solicitud.estado=o),i===e.length-1)&&(a.solicitud.eliminado=!0,s(a.solicitud).then(function(o){a.obtenerListaSolicitudes(),a.cerrarModalEliminarSolicitud(),a.mostrarMensaje(o.mensaje)}))})},a.verificarPerimisoAutorizacion=function(o){o.nombre_usuario=a.usuario.nombre_usuario,d(a.usuario.id_empresa,o).then(function(o){o.type?(a.mostrarMensaje(o.message),"autorizacion"==a.tipoDatosPermiso&&a.tiposEstados.forEach(function(o,i,e){(o.nombre===a.diccionario.CC_ESTADO_AUTORIZADO&&(a.solicitud.estado=o),i===e.length-1)&&(a.solicitud.autorizador=a.usuario.id,s(a.solicitud).then(function(o){a.cerrarModalVerificarAutorizacion(),a.mostrarMensaje(o.mensaje)}))})):(a.cerrarModalVerificarAutorizacion(),a.mostrarMensaje(o.message))})},a.$on("$routeChangeStart",function(o,i){a.eliminarPopup(a.idModalSolicitudCajaChica),a.eliminarPopup(a.idModalConceptosMovimiento),a.eliminarPopup(a.idModalEliminarSolicitud),a.eliminarPopup(a.idModalVerificarAutorizacion)}),a.inicio()}]);