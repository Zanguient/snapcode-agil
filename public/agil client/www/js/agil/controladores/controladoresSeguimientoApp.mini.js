angular.module("agil.controladores").controller("ControladorSeguimientoApp",["$scope","$window","$localStorage","$location","$templateCache","$route","blockUI","UsuariosRutasLista","Rutas","uiGmapGoogleMapApi","UsuarioRutasSeguimiento","UsuarioRutaReporteDatos","UsuarioRutaGraficoDatos","UsuariosComisionesReporte","CierreCajaRutaUsuarioDatos",function(t,e,a,o,n,i,r,s,l,c,u,d,h,p,g){r.start(),t.usuario=JSON.parse(a.usuario),t.idModalSeguimientoVentas="dialog-seguimiento-ventas",t.idModalFiltroExcel="dialog-filtro-excel",t.idModalFiltroGraficos="dialog-filtro-graficos",t.idModalUsuarioComision="dialog-usuario-comision",t.inicio=function(){t.obtenerUsuariosRutas(),t.obtenerRutas()},t.$on("$viewContentLoaded",function(){resaltarPestaña(o.path().substring(1)),setTimeout(function(){ejecutarScriptsSeguimiento(t.idModalSeguimientoVentas,t.idModalFiltroExcel,t.idModalFiltroGraficos,t.idModalUsuarioComision)},1e3),t.buscarAplicacion(t.usuario.aplicacionesUsuario,o.path().substring(1)),r.stop()}),t.obtenerUsuariosRutas=function(){var e=new Date,a=e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear();t.filtrarRutasUsuarios(a,a,0,0)},t.obtenerRutas=function(){r.start(),l(t.usuario.id_empresa).then(function(e){t.rutas=e,r.stop()})},t.filtrarRutasUsuarios=function(e,a,o,n){r.start(),o=null==o||void 0==o?0:o,n=""==n||void 0==n?0:n;e=new Date(t.convertirFecha(e)),a=new Date(t.convertirFecha(a));s(t.usuario.id_empresa,e,a,n,o).then(function(e){t.usuariosRutas=e,r.stop()})},t.abrirSeguimientoVentas=function(e,a){r.start();var o=t.obtenerDiaActual();$.grep(a.dias,function(t){return t.dia.nombre_corto==o}).length>0?u(e,o).then(function(e){t.mostrarMap=!0,c.then(function(a){t.map={center:{latitude:-17.403800007775388,longitude:-66.11349012184144},zoom:17,bounds:{northeast:{latitude:-17.403800007775388,longitude:-66.11349012184144}},window:{marker:{},show:!1,closeClick:function(){this.show=!1},options:{}},markersEvents:{click:function(e,a,o,arguments){t.map.window.model=o,t.map.window.show=!0}}},t.options={scrollwheel:!1,mapTypeId:google.maps.MapTypeId.TERRAIN},t.generarMarcadores(e[0].ruta.clientes),e[0].ruta.segmentos=JSON.parse(e[0].ruta.segmentos),t.dibujarRuta(e[0].ruta)}),t.abrirPopup(t.idModalSeguimientoVentas),r.stop()}):(t.mostrarMensaje("¡No existe ventas en el dia para esta Ruta y Usuario!"),r.stop())},t.generarMarcadores=function(e){var a=function(t,e,a,o,n,i,r,s,l,c,u){null==a&&(a="id");var d={latitude:o,longitude:n,title:u,options:i,razonSocial:s,ventas:l,detallesVentaNoConsolidadas:c,show:!1};return d[a]=r,d};t.markers=[];for(var o,n=[],i=0;i<e.length;i++){var r,s="",l="";e[i].cliente.ventas.length>0?(s=t.renderizarHtmlVentas(e[i].cliente.ventas[0]),e[i].cliente.ventas[0].detallesVentaNoConsolidadas.length>0?(l=t.renderizarHtmlVentasNoConsolidadas(e[i].cliente.ventas[0].detallesVentaNoConsolidadas),r="yellow"):r="green"):e[i].cliente.detallesVentaNoConsolidadas.length>0?(l=t.renderizarHtmlVentasNoConsolidadas(e[i].cliente.detallesVentaNoConsolidadas),r="red"):(s="¡Aún no se visito!",r="black"),o={labelContent:e[i].cliente.razon_social,labelAnchor:"8 35",labelClass:"marker-label",icon:{path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,strokeColor:r,scale:3}};var c=s+l;n.push(a(0,t.map.bounds,null,e[i].cliente.latitud,e[i].cliente.longitud,o,e[i].cliente.id,e[i].cliente.razon_social,e[i].cliente.ventas,e[i].cliente.detallesVentaNoConsolidadas,c))}t.markers=n},t.renderizarHtmlVentas=function(t){for(var e="",a=0;a<t.detallesVenta.length;a++)e=e+"<tr><td>"+(a+1)+"</td>\t\t\t\t\t<td>"+t.detallesVenta[a].cantidad+"</td>\t\t\t\t\t<td>"+t.detallesVenta[a].producto.nombre+"</td>\t\t\t\t\t<td>"+t.detallesVenta[a].total+"</td></tr>";return'<h3>Venta</h3><table class="table table-striped table-bordered table-hover" ng-if="modelo.detallesVenta.length>0"> \t\t\t<thead>\t\t\t\t<tr>\t\t\t\t\t<th>\t\t\t\t\t\t<label>#</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Cantidad</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Producto</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Precio (Bs)</label>\t\t\t\t\t</th>\t\t\t\t</tr>\t\t\t</thead>\t\t\t<tbody>'+e+("</tr>\t\t\t\t<tr>\t\t\t\t\t<td>\t\t\t\t\t</td>\t\t\t\t\t<td>\t\t\t\t\t</td>\t\t\t\t\t<td>\t\t\t\t\t\t<b>TOTALES</b>\t\t\t\t\t</td>\t\t\t\t\t<td>"+t.total+"</td>\t\t\t\t</tr>\t\t\t</tbody>\t\t</table>")},t.renderizarHtmlVentasNoConsolidadas=function(t){for(var e="",a=0;a<t.length;a++)e=e+"<tr><td>"+(a+1)+"</td>\t\t\t\t\t<td>"+t[a].cantidad+"</td>\t\t\t\t\t<td>"+t[a].producto.nombre+"</td>\t\t\t\t\t<td>"+t[a].total+"</td></tr>";return'<h3>Venta No Consolidada</h3>\t\t<table class="table table-striped table-bordered table-hover">\t\t\t<thead>\t\t\t\t<tr>\t\t\t\t\t<th>\t\t\t\t\t\t<label>#</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Cantidad</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Producto</label>\t\t\t\t\t</th>\t\t\t\t\t<th>\t\t\t\t\t\t<label>Precio (Bs)</label>\t\t\t\t\t</th>\t\t\t\t</tr>\t\t\t</thead>\t\t\t<tbody>'+e+"</tr>\t\t\t</tbody>\t\t</table>"},t.dibujarRuta=function(e){if(t.polylines=[],e.segmentos.length>0)for(var a=0;a<e.segmentos.length;a++){for(var o=[],n=0;n<e.segmentos[a].length;n++)o.push({latitude:e.segmentos[a][n].lat,longitude:e.segmentos[a][n].lng});t.polylines.push({id:a+1,path:o,stroke:{color:"#69AA46",weight:3},editable:!0,draggable:!0,geodesic:!0,visible:!0})}t.drawingManagerOptions={drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:[google.maps.drawing.OverlayType.POLYLINE]},polylineOptions:{strokeColor:"#69AA46",strokeWeight:5}},t.markersAndCircleFlag=!0,t.drawingManagerControl={},t.drawingManagerEvents={polylinecomplete:function(e,a,o,n){for(var i=n[0],r=i.getPath(),s=[],l=0;l<r.getArray().length;l++)s.push(r.getArray()[l].toJSON());t.ruta.segmentos.push(s),t.formas.push(i)}}},t.seleccionarMarcador=function(t,e,a){a.show=!a.show},t.cerrarSeguimientoVenta=function(){t.mostrarMap=!1,t.cerrarPopup(t.idModalSeguimientoVentas)},t.abrirPopupFiltroExcel=function(e,a){var o=new Date;t.reporte={bandera:3,id_usuario:e.id,usuario:e,ruta:a,id_ruta:a.id,mes:"1",gestion:"2017"},t.reporte.fechaTextoInicio=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),t.reporte.fechaTextoFin=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),t.abrirPopup(t.idModalFiltroExcel)},t.cerrarPopupFiltroExcel=function(){t.cerrarPopup(t.idModalFiltroExcel)},t.buscarDetallesVenta=function(e){if(r.start(),e.tipo){var a=new Date;a.setDate(1),a.setMonth(parseInt(e.mes)-1),a.setFullYear(parseInt(e.gestion)),e.inicio=a;var o=new Date;o.setDate(new Date(parseInt(e.gestion),parseInt(e.mes),0).getDate()),o.setMonth(parseInt(e.mes)-1),o.setFullYear(parseInt(e.gestion)),e.fin=o}else e.inicio=new Date(t.convertirFecha(e.fechaTextoInicio)),e.fin=new Date(t.convertirFecha(e.fechaTextoFin));d(e.id_usuario,e.inicio,e.fin,e.bandera,e.id_ruta).then(function(t){for(var a=[["","","REPORTE VENDEDOR RUTA"],["Vendedor : ",e.usuario.persona.nombres,"Ruta : ",e.ruta.nombre],["Nro.","Fecha","Cliente","Producto","Cantidad","P. U.","Total","Comision","Total Comision","Tipo de Venta","Dias"]],o=0;o<t.length;o++){var n=[];n.push((o+1).toString()),1==e.bandera?(t[o].fecha=new Date(t[o].fecha),n.push(t[o].fecha.getDate()+"/"+(t[o].fecha.getMonth()+1)+"/"+t[o].fecha.getFullYear()),n.push(t[o].cliente.razon_social),n.push("ROJO"),n.push("ROJO"),n.push("ROJO"),n.push("ROJO"),n.push("ROJO"),n.push("ROJO"),n.push("ROJO"),n.push("ROJO")):(t[o].venta.fecha=new Date(t[o].venta.fecha),n.push(t[o].venta.fecha.getDate()+"/"+(t[o].venta.fecha.getMonth()+1)+"/"+t[o].venta.fecha.getFullYear()),n.push(t[o].venta.cliente.razon_social),n.push(t[o].producto.nombre),n.push(t[o].cantidad),n.push(t[o].precio_unitario),n.push(t[o].total),n.push(t[o].producto.comision),n.push(t[o].cantidad*t[o].producto.comision),n.push(t[o].venta.tipoPago.nombre),t[o].venta.dias_credito&&n.push(t[o].venta.dias_credito)),a.push(n)}var i="SheetJS",s=new Workbook,l=sheet_from_array_of_arrays(a);s.SheetNames.push(i),s.Sheets[i]=l;var c=XLSX.write(s,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([s2ab(c)],{type:"application/octet-stream"}),"REPORTE-RUTA-USUARIO.xlsx"),r.stop()})},t.abrirPopupFiltroGraficos=function(e,a){var o=new Date;t.reporte={bandera:3,id_usuario:e.id,usuario:e,ruta:a,id_ruta:a.id,mes:"1",gestion:"2017"},t.reporte.fechaTextoInicio=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),t.reporte.fechaTextoFin=o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear(),t.abrirPopup(t.idModalFiltroGraficos)},t.buscarGraficos=function(e){if(r.start(),e.tipo){var a=new Date;a.setDate(1),a.setMonth(parseInt(e.mes)-1),a.setFullYear(parseInt(e.gestion)),e.inicio=a;var o=new Date;o.setDate(new Date(parseInt(e.gestion),parseInt(e.mes),0).getDate()),o.setMonth(parseInt(e.mes)-1),o.setFullYear(parseInt(e.gestion)),e.fin=o}else e.inicio=new Date(t.convertirFecha(e.fechaTextoInicio)),e.fin=new Date(t.convertirFecha(e.fechaTextoFin));h(e.id_usuario,e.inicio,e.fin,e.id_ruta).then(function(a){if(e.tipo){t.labels=[],t.data=[];for(var o=0,n=0;n<a.length;n++){a[n].fecha=new Date(a[n].fecha);var i=$.grep(a,function(t){return t.fecha=new Date(t.fecha),t.fecha.getDate()==a[n].fecha.getDate()&&t.fecha.getMonth()==a[n].fecha.getMonth()&&t.fecha.getFullYear()==a[n].fecha.getFullYear()});a=$.grep(a,function(t){return t.fecha=new Date(t.fecha),!(t.fecha.getDate()==a[n].fecha.getDate()&&t.fecha.getMonth()==a[n].fecha.getMonth()&&t.fecha.getFullYear()==a[n].fecha.getFullYear())}),n=-1,o=0;for(var s=0;s<i.length;s++)o+=i[s].total;t.labels.push(i[0].fecha.getDate()+"/"+(i[0].fecha.getMonth()+1)+"/"+i[0].fecha.getFullYear()),t.data.push(o)}t.series=["Series A"]}else{t.labels=[],t.data=[];for(o=0,n=0;n<a.length;n++){a[n].fecha=new Date(a[n].fecha);i=$.grep(a,function(t){return t.fecha=new Date(t.fecha),t.fecha.getMonth()==a[n].fecha.getMonth()&&t.fecha.getFullYear()==a[n].fecha.getFullYear()});a=$.grep(a,function(t){return t.fecha=new Date(t.fecha),!(t.fecha.getMonth()==a[n].fecha.getMonth()&&t.fecha.getFullYear()==a[n].fecha.getFullYear())}),n=-1,o=0;for(s=0;s<i.length;s++)o+=i[s].total;t.labels.push(i[0].fecha.getMonth()+1),t.data.push(o)}t.series=["Series A"]}r.stop()})},t.cerrarPopupFiltroGraficos=function(){t.cerrarPopup(t.idModalFiltroGraficos)},t.cerrarPopupUsuarioComision=function(){t.cerrarPopup(t.idModalUsuarioComision)},t.verComisionesVendedores=function(e,a){r.start(),t.abrirPopup(t.idModalUsuarioComision),e=new Date(t.convertirFecha(e)),a=new Date(t.convertirFecha(a)),p(t.usuario.id_empresa,e,a).then(function(e){t.labels=[],t.data=[];for(var a=0;a<e.length;a++){t.labels.push(e[a].persona.nombre_completo);for(var o=0,n=0;n<e[a].ventas.length;n++)for(var i=0;i<e[a].ventas[n].detallesVenta.length;i++)e[a].comision_activa?o+=e[a].comision_general:o+=e[a].ventas[n].detallesVenta[i].producto.comisionesVendedores[0].comision;t.data.push(o)}t.series=["Series A"],r.stop()})},t.cerrarCajaUsuarioRuta=function(e,a){r.start();var o=t.obtenerDiaActual(),n=100,i=1;if($.grep(a.dias,function(t){return t.dia.nombre_corto==o}).length>0){var s=new PDFDocument({size:[612,792],margin:0}),l=s.pipe(blobStream());s.font("Helvetica-Bold",15),s.text("CIERRE DE CAJA",55,50),s.font("Helvetica-Bold",8),g(e.id,o).then(function(a){s.text("VENTAS",75,80),s.text("No.",100,100),s.text("Fecha",150,100),s.text("Cliente",200,100),s.text("Total",350,100),s.text("Comision",400,100),s.text("T. Comision",450,100),s.text("Tipo Venta",500,100),s.font("Helvetica",8);for(var o=0,c=0,u=0,d=0;d<a[0].ruta.clientes.length;d++)for(var h=0;h<a[0].ruta.clientes[d].cliente.ventas.length;h++){a[0].ruta.clientes[d].cliente.ventas[h].fecha=new Date(a[0].ruta.clientes[d].cliente.ventas[h].fecha),s.text("No. "+i,100,n+20),s.text(a[0].ruta.clientes[d].cliente.ventas[h].fecha.getDate()+"/"+(a[0].ruta.clientes[d].cliente.ventas[h].fecha.getMonth()+1)+"/"+a[0].ruta.clientes[d].cliente.ventas[h].fecha.getFullYear(),150,n+20),s.text(a[0].ruta.clientes[d].cliente.razon_social,200,n+20);var p=a[0].ruta.clientes[d].cliente.ventas[h].tipoPago.nombre==t.diccionario.TIPO_PAGO_CREDITO?a[0].ruta.clientes[d].cliente.ventas[h].a_cuenta:a[0].ruta.clientes[d].cliente.ventas[h].total;s.text(p,350,n+20),o+=p,e.comision_activa&&(s.text(e.comision_general+"%",400,n+20),s.text(a[0].ruta.clientes[d].cliente.ventas[h].total*e.comision_general/100,450,n+20),c+=a[0].ruta.clientes[d].cliente.ventas[h].total*e.comision_general/100),s.text(a[0].ruta.clientes[d].cliente.ventas[h].tipoPago.nombre,500,n+20),n+=20,i++}s.font("Helvetica-Bold",8),s.text("Totales",200,n+20),s.text(o,350,n+20),s.text(c,450,n+20),n+=20,s.text("COBROS",75,n+20),n+=20,s.text("No.",100,n+20),s.text("Fecha",150,n+20),s.text("Cliente",200,n+20),s.text("Total",350,n+20),s.text("Pago",400,n+20),s.font("Helvetica",8),n+=20,i=1;for(d=0;d<a[0].usuario.pagos.length;d++){a[0].usuario.pagos[d].createdAt=new Date(a[0].usuario.pagos[d].createdAt),s.text("No. "+i,100,n+20),s.text(a[0].usuario.pagos[d].createdAt.getDate()+"/"+(a[0].usuario.pagos[d].createdAt.getMonth()+1)+"/"+a[0].usuario.pagos[d].createdAt.getFullYear(),150,n+20),s.text(a[0].usuario.pagos[d].venta.cliente.razon_social,200,n+20),s.text(a[0].usuario.pagos[d].monto_pagado,350,n+20),u+=a[0].usuario.pagos[d].monto_pagado;var g=a[0].usuario.pagos[d].saldo_anterior==a[0].usuario.pagos[d].monto_pagado?"Total":"A/C";s.text(g,400,n+20),n+=20,i++}s.font("Helvetica-Bold",8),s.text("Totales",200,n+20),s.text(u,350,n+20),s.text("RESUMEN",200,n+40),s.text("Ventas",200,n+50),s.text("Cobros",200,n+60),s.text(o,280,n+50),s.text(u,280,n+60),s.text("Total a entregar",200,n+70),s.text(o+u,280,n+70),n+=40,s.text("---------------------------------------------                       ---------------------------------------------                       ---------------------------------------------",0,n+100,{align:"center"}),s.text("ENTREGUE CONFORME                                               RECIBI CONFORME                                               VoBo                         ",0,n+130,{align:"center"}),s.text("NOMBRE                                                        NOMBRE                                                       NOMBRE                         ",0,n+145,{align:"center"}),s.text("CI                                                              CI                                                              CI                           ",0,n+160,{align:"center"}),r.stop(),s.end(),l.on("finish",function(){var t=l.toBlobURL("application/pdf");window.open(t,"_blank","location=no")})})}else t.mostrarMensaje("¡No existe ventas en el dia para esta Ruta y Usuario!"),r.stop()},t.$on("$routeChangeStart",function(e,a){t.eliminarPopup(t.idModalSeguimientoVentas),t.eliminarPopup(t.idModalFiltroExcel),t.eliminarPopup(t.idModalFiltroGraficos),t.eliminarPopup(t.idModalUsuarioComision)}),t.inicio()}]);